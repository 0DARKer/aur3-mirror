# Maintainer: SJ_UnderWater
# Based on netatalk package :
# Maintainer: Dominik Dingel <mail at wodar dot de>
# Contributor: William Udovich <nerdzrule7 at earthlink dot net>
# Contributor: Farhan Yousaf <farhany at xaviya dot com>

pkgname=netatalk
pkgver=2.2.2
pkgrel=0
pkgdesc='A kernel level implementation of the AppleTalk Protocol Suite'
provides=('netatalk')
conflicts=('netatalk-git')
arch=('i686' 'x86_64')
url='http://netatalk.sourceforge.net'
options=('!libtool')
license=('GPL')
backup=('etc/netatalk/afpd.conf'
        'etc/netatalk/netatalk.conf'
        'etc/netatalk/AppleVolumes.default'
        'etc/netatalk/AppleVolumes.system')
depends=('avahi>=0.6' 'openssl' 'pam' 'coreutils>=7.1-2' 'db>=4.6.0' 'libgcrypt>=1.2.3')
optdepends=('openslp' 'libcups' 'tcp_wrappers' 'pam-krb5')
makedepends=('git')
source=(a2boot afpd atalkd cnid_metad netatalk papd timelord)
md5sums=('df2efb24c6827fca6049fe3dbcbdda9c'
		 '5e2bbd15867c368f760db002ae436ac3'
		 '52eebbbb666dfcd0402243b4fd1c87ae'
         'bf8558c68704e4bad98da92cd0fd37ff'
		 'b85723d3b3ecb9f199ea65454764e32c'
		 '77cae8def001be0609ff1c2d1d694fcb'
		 '7587f13717e5adbc30be49433ad581e7')
_gitroot='git://netatalk.git.sourceforge.net/gitroot/netatalk/netatalk'
_gitname='netatalk-2-2-2'
_gitopt='--disable-ddp --disable-srvloc --disable-timelord --disable-cups --disable-a2boot'

build() {
  cd "${srcdir}"
  msg 'Connecting to GIT server....'

  if [ -d "${_gitname}" ] ; then
    cd "${_gitname}" && git checkout master && git pull origin
    git checkout "${_gitname}"
    msg 'The local files are updated.'
    msg 'Running make distclean'
    make distclean || :
  else
    git clone "${_gitroot}" "${_gitname}"
    cd "${_gitname}"
    git checkout "${_gitname}"
  fi

  cd ${srcdir}/${_gitname}
  msg 'Bootstrapping netatalk...'
  ./bootstrap

  msg 'Configuring netatalk...'
  read -p 'Support OS X < 10.4 (requires OpenSLP and CUPS)? [no] ' _gitddp
  if [ -n "$_gitddp" ];then _gitopt=`echo $_gitopt | sed s/disable/enable/g`;fi
  ./configure --prefix=/usr --localstatedir=/var --with-cracklib --with-cnid-cdb-backend --enable-fhs $_gitopt
  read -p 'Make?'
  make || return 1
  make DESTDIR=$startdir/pkg install

  rm -r $startdir/pkg/usr/include $startdir/pkg/usr/share/aclocal
  if [ -z "$_gitddp" ]; then rm $startdir/pkg/usr/share/man/man8/timelord.8
  rmdir $startdir/pkg/usr/share/man/man3 $startdir/pkg/usr/share/man/man4;fi
  
  install -d $startdir/pkg/etc/rc.d
  install -m755 ../{afpd,cnid_metad,netatalk} $startdir/pkg/etc/rc.d
  if [ -n "$_gitddp" ]; then install -m755 ../{a2boot,atalkd,papd,timelord} $startdir/pkg/etc/rc.d;fi
}
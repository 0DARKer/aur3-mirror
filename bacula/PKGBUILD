## PKGBUILD [plain_text]
# Maintainer: Steven Haigh <netwiz@crc.id.au>
# bacula-fd.service by Christian Hesse <arch@eworm.de>

pkgbase=('bacula')
pkgname='bacula'
true && pkgname=('bacula-bat' 'bacula-client' 'bacula-common' 'bacula-console' 'bacula-dir' 'bacula-dir-mysql' 'bacula-dir-postgresql' 'bacula-dir-sqlite3' 'bacula-sd')
pkgver=7.0.2
pkgrel=1
arch=(i686 x86_64)
pkgdesc='Bacula - A Network Backup Tool'
url="http://www.bacula.org"
license=('AGPL3')
makedepends=( mariadb postgresql qt4 sqlite3 )
source=("http://downloads.sourceforge.net/sourceforge/bacula/bacula-${pkgver}.tar.gz"
        '00-qmake4.patch'
        'bacula-fd.service'
        'bacula-sd.service'
        'bacula-dir.service')

sha1sums=('a9b4a6a0664f2e98e5c487714686c263ce050e56'
          '58a60e8af9b4735c564c7223c2bf0c25803927f3'
          '151c6d8b06d8be029a9a50be4d6e64954c88f48c'
          'a682cd35bf2a85fd7274f4241a91483c53c43f37'
          '35a151cc990ace78165a2e7c3f816b739c01b4cf')

prepare() {
    cd "${srcdir}/bacula-${pkgver}"
    export _instdir="${srcdir}/install"
    patch -Np3 -i ${srcdir}/00-qmake4.patch
}

build() {
    cd "${srcdir}/bacula-${pkgver}"
    ./configure                              \
    --enable-bat                             \
    --enable-smartalloc                      \
    --prefix=/usr                            \
    --sbindir=/usr/bin                       \
    --sysconfdir=/etc/bacula                 \
    --with-mysql                             \
    --with-openssl                           \
    --with-postgresql                        \
    --with-sqlite3                           \
    --with-pid-dir=/run                      \
    --with-scriptdir=/etc/bacula/scripts     \
    --with-systemd=/usr/lib/systemd/system/  \
    --with-working-dir=/opt/bacula/working   \
    --with-logdir=/var/log                   \
    --with-x                                 \
    --with-dir-password="XXX_REPLACE_WITH_DIRECTOR_PASSWORD_XXX" \
    --with-fd-password="XXX_REPLACE_WITH_CLIENT_PASSWORD_XXX" \
    --with-sd-password="XXX_REPLACE_WITH_STORAGE_PASSWORD_XXX" \
    --with-mon-dir-password="XXX_REPLACE_WITH_DIRECTOR_MONITOR_PASSWORD_XXX" \
    --with-mon-fd-password="XXX_REPLACE_WITH_CLIENT_MONITOR_PASSWORD_XXX" \
    --with-mon-sd-password="XXX_REPLACE_WITH_STORAGE_MONITOR_PASSWORD_XXX" \
    --with-basename="XXX_REPLACE_WITH_LOCAL_HOSTNAME_XXX"
    
    make DESTDIR="$_instdir" install

    ## Correct some config files that the compile process 'helpfully' configures for us.
    for conf in bacula-sd.conf bacula-dir.conf bacula-fd.conf bconsole.conf bat.conf; do
      if [ -e ${pkgdir}/etc/bacula/${conf} ] ; then
        sed -i'' "s#XXX_REPLACE_WITH_LOCAL_HOSTNAME_XXX-dir#XXX_REPLACE_WITH_DIRECTOR_HOSTNAME_XXX-dir#g" ${pkgdir}/etc/bacula/${conf}
      fi
    done
}

package_bacula-bat() {
  pkgdesc='Bacula - A Network Backup Tool (management GUI)'
  backup=('etc/bacula/bat.conf')
  depends=(bacula-common qt4)
  pushd "${_instdir}"

  install -Dm755 ${_instdir}/usr/bin/bat ${pkgdir}/usr/bin/bat
  install -Dm644 ${_instdir}/etc/bacula/bat.conf ${pkgdir}/etc/bacula/bat.conf
  install -Dm644 ${_instdir}/usr/share/man/man1/bat.1.gz ${pkgdir}/usr/share/man/man1/bat.1.gz

  install -Dm644 ${srcdir}/${pkgbase}-${pkgver}/scripts/bat.desktop ${pkgdir}/usr/share/applications/bat.desktop
  install -Dm644 ${srcdir}/${pkgbase}-${pkgver}/src/qt-console/images/bat_icon.png ${pkgdir}/usr/share/pixmaps/bat_icon.png
}

package_bacula-client() {
  pkgdesc='Bacula - A Network Backup Tool (client)'
  depends=('bacula-common')
  backup=('etc/bacula/bacula-fd.conf')
  pushd "${_instdir}"

  install -Dm644 ${_instdir}/etc/bacula/bacula-fd.conf ${pkgdir}/etc/bacula/bacula-fd.conf
  install -Dm755 ${_instdir}/usr/bin/bacula-fd ${pkgdir}/usr/bin/bacula-fd
  install -Dm755 ${_instdir}/usr/lib/bpipe-fd.so ${pkgdir}/usr/lib/bpipe-fd.so
  install -Dm644 ${_instdir}/usr/share/man/man8/bacula-fd.8.gz ${pkgdir}/usr/share/man/man8/bacula-fd.8.gz
  install -Dm644 ${srcdir}/bacula-fd.service ${pkgdir}/usr/lib/systemd/system/bacula-fd.service
}

package_bacula-common() {
  pkgdesc='Bacula - A Network Backup Tool (common files)'
  pushd "${_instdir}"
  
  install -Dm755 ${_instdir}/etc/bacula/scripts/bacula_config ${pkgdir}/etc/bacula/scripts/bacula_config
  install -Dm644 ${_instdir}/etc/bacula/scripts/btraceback.gdb ${pkgdir}/etc/bacula/scripts/btraceback.gdb
  install -Dm644 ${_instdir}/etc/bacula/scripts/btraceback.dbx ${pkgdir}/etc/bacula/scripts/btraceback.dbx
  install -Dm644 ${_instdir}/etc/bacula/scripts/btraceback.mdb ${pkgdir}/etc/bacula/scripts/btraceback.mdb
  install -Dm755 ${_instdir}/usr/bin/btraceback ${pkgdir}/usr/btraceback
  install -Dm755 ${_instdir}/usr/lib/libbac-${pkgver}.so ${pkgdir}/usr/lib/libbac-${pkgver}.so
  install -Dm755 ${_instdir}/usr/lib/libbaccfg-${pkgver}.so ${pkgdir}/usr/lib/libbaccfg-${pkgver}.so
  install -Dm755 ${_instdir}/usr/lib/libbacfind-${pkgver}.so ${pkgdir}/usr/lib/libbacfind-${pkgver}.so
  install -Dm644 ${_instdir}/usr/share/man/man8/btraceback.8.gz ${pkgdir}/usr/share/man/man8/btraceback.8.gz
}

package_bacula-console() {
  pkgdesc='Bacula - A Network Backup Tool (management CLI)'
  backup=('etc/bacula/bconsole.conf')
  depends=('bacula-common')
  pushd "${_instdir}"

  install -Dm755 ${_instdir}/usr/bin/bconsole ${pkgdir}/usr/bin/bconsole
  install -Dm644 ${_instdir}/etc/bacula/bconsole.conf ${pkgdir}/etc/bacula/bconsole.conf
  install -Dm644 ${_instdir}/usr/share/man/man8/bconsole.8.gz ${pkgdir}/usr/share/man8/bconsole.8.gz
}

package_bacula-dir() {
  pkgdesc='Bacula - A Network Backup Tool (director daemon)'
  depends=('bacula-common')
  optdepends=(
    'bacula-dir-sqlite3: SQLite support'
    'bacula-dir-mysql: mariadb support'
    'bacula-dir-postgresql: PostgreSQL support')
  backup=('etc/bacula/bacula-dir.conf')
  pushd "${_instdir}"

  install -Dm644 ${_instdir}/etc/bacula/bacula-dir.conf ${pkgdir}/etc/bacula/bacula-dir.conf
  install -Dm644 ${_instdir}/etc/bacula/scripts/query.sql ${pkgdir}/etc/bacula/scripts/query.sql
  install -Dm750 ${_instdir}/etc/bacula/scripts/create_bacula_database ${pkgdir}/etc/bacula/scripts/create_bacula_database
  install -Dm750 ${_instdir}/etc/bacula/scripts/delete_catalog_backup ${pkgdir}/etc/bacula/scripts/delete_catalog_backup
  install -Dm750 ${_instdir}/etc/bacula/scripts/drop_bacula_database ${pkgdir}/etc/bacula/scripts/drop_bacula_database
  install -Dm750 ${_instdir}/etc/bacula/scripts/drop_bacula_tables ${pkgdir}/etc/bacula/scripts/drop_bacula_tables
  install -Dm750 ${_instdir}/etc/bacula/scripts/grant_bacula_privileges ${pkgdir}/etc/bacula/scripts/grant_bacula_privileges
  install -Dm750 ${_instdir}/etc/bacula/scripts/make_bacula_tables ${pkgdir}/etc/bacula/scripts/make_bacula_tables
  install -Dm750 ${_instdir}/etc/bacula/scripts/make_catalog_backup.pl ${pkgdir}/etc/bacula/scripts/make_catalog_backup.pl
  install -Dm750 ${_instdir}/etc/bacula/scripts/update_bacula_tables ${pkgdir}/etc/bacula/scripts/update_bacula_tables
  install -Dm755 ${_instdir}/usr/bin/bacula-dir ${pkgdir}/usr/bin/bacula-dir
  install -Dm755 ${_instdir}/usr/bin/bregex ${pkgdir}/usr/bin/bregex
  install -Dm755 ${_instdir}/usr/bin/bsmtp ${pkgdir}/usr/bin/bsmtp
  install -Dm755 ${_instdir}/usr/bin/bwild ${pkgdir}/usr/bin/bwild
  install -Dm755 ${_instdir}/usr/bin/dbcheck ${pkgdir}/usr/bin/dbcheck
  install -Dm644 ${_instdir}/usr/share/man/man1/bsmtp.1.gz ${pkgdir}/usr/share/man/man1/bsmtp.1.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bacula-dir.8.gz ${pkgdir}/usr/share/man/man8/bacula-dir.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bregex.8.gz ${pkgdir}/usr/share/man/man8/bregex.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bwild.8.gz ${pkgdir}/usr/share/man/man8/bwild.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/dbcheck.8.gz ${pkgdir}/usr/share/man/man8/dbcheck.8.gz
  install -Dm755 ${_instdir}/usr/lib/libbacsql-${pkgver}.so ${pkgdir}/usr/lib/libbacsql-${pkgver}.so
  install -Dm644 ${srcdir}/bacula-dir.service ${pkgdir}/usr/lib/systemd/system/bacula-dir.service

  ## Logwatch Support
  install -Dm755 ${srcdir}/bacula-${pkgver}/scripts/logwatch/bacula ${pkgdir}/etc/logwatch/scripts/services/bacula
  install -Dm644 ${srcdir}/bacula-${pkgver}/scripts/logwatch/applybaculadate ${pkgdir}/etc/logwatch/scripts/shared/applybaculadate
  install -Dm644 ${srcdir}/bacula-${pkgver}/scripts/logwatch/logfile.bacula.conf ${pkgdir}/etc/logwatch/conf/logfiles/bacula.conf
  install -Dm644 ${srcdir}/bacula-${pkgver}/scripts/logwatch/services.bacula.conf ${pkgdir}/etc/logwatch/conf/services/bacula.conf

  ## Logrotate Support
  install -Dm644 ${srcdir}/bacula-${pkgver}/scripts/logrotate ${pkgdir}/etc/logrotate.d/bacula
}

package_bacula-dir-mysql() {
  pkgdesc='Bacula - A Network Backup Tool (director daemon - mysql support)'
  depends=('bacula-dir' 'mariadb')
  pushd "${_instdir}"
  
  install -Dm755 ${_instdir}/usr/lib/libbaccats-mysql-${pkgver}.so ${pkgdir}/usr/lib/libbaccats-mysql-${pkgver}.so
  install -Dm755 ${_instdir}/usr/lib/libbaccats-mysql.so ${pkgdir}/usr/lib/libbaccats-mysql.so
  for file in "${_instdir}"/etc/bacula/scripts/*mysql*; do
    install -Dm750 "$file" "${pkgdir}/etc/bacula/scripts/$file"
  done
}

package_bacula-dir-postgresql() {
  pkgdesc='Bacula - A Network Backup Tool (director daemon - postgresql support)'
  depends=('bacula-dir' 'postgresql')
  pushd "${_instdir}"

  install -Dm755 ${_instdir}/usr/lib/libbaccats-postgresql-${pkgver}.so ${pkgdir}/usr/lib/libbaccats-postgresql-${pkgver}.so
  install -Dm755 ${_instdir}/usr/lib/libbaccats-postgresql.so ${pkgdir}/usr/lib/libbaccats-postgresql.so
  for file in "${_instdir}"/etc/bacula/scripts/*postgresql*; do
    install -Dm750 "$file" "${pkgdir}/etc/bacula/scripts/$file"
  done
}

package_bacula-dir-sqlite3() {
  pkgdesc='Bacula - A Network Backup Tool (director daemon - sqlite3 support)'
  depends=('bacula-dir' 'sqlite3')
  pushd "${_instdir}"

  install -Dm755 ${_instdir}/usr/lib/libbaccats-sqlite3-${pkgver}.so ${pkgdir}/usr/lib/libbaccats-sqlite3-${pkgver}.so
  install -Dm755 ${_instdir}/usr/lib/libbaccats-sqlite3.so ${pkgdir}/usr/lib/libbaccats-sqlite3.so
  for file in "${_instdir}"/etc/bacula/scripts/*sqlite3*; do
    install -Dm750 "$file" "${pkgdir}/etc/bacula/scripts/$file"
  done
}

package_bacula-sd() {
  pkgdesc='Bacula - A Network Backup Tool (storage daemon)'
  backup=('etc/bacula/bacula-sd.conf')
  depends=('bacula-common')
  pushd "${_instdir}"

  install -Dm644 ${_instdir}/etc/bacula/bacula-sd.conf ${pkgdir}/etc/bacula/bacula-sd.conf
  install -Dm755 ${_instdir}/usr/bin/bacula-sd ${pkgdir}/usr/bin/bacula-sd
  install -Dm755 ${_instdir}/usr/bin/bextract ${pkgdir}/usr/bin/bextract
  install -Dm755 ${_instdir}/usr/bin/bls ${pkgdir}/usr/bin/bls
  install -Dm755 ${_instdir}/usr/bin/bcopy ${pkgdir}/usr/bin/bcopy
  install -Dm755 ${_instdir}/usr/bin/bscan ${pkgdir}/usr/bin/bscan
  install -Dm755 ${_instdir}/usr/bin/btape ${pkgdir}/usr/bin/btape
  install -Dm644 ${_instdir}/usr/share/man/man8/bacula-sd.8.gz ${pkgdir}/usr/share/man/man8/bacula-sd.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bextract.8.gz ${pkgdir}/usr/share/man/man8/bextract.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bls.8.gz ${pkgdir}/usr/share/man/man8/bls.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bcopy.8.gz ${pkgdir}/usr/share/man/man8/bcopy.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/bscan.8.gz ${pkgdir}/usr/share/man/man8/bscan.8.gz
  install -Dm644 ${_instdir}/usr/share/man/man8/btape.8.gz ${pkgdir}/usr/share/man/man8/btape.8.gz
  install -Dm644 ${srcdir}/bacula-sd.service ${pkgdir}/usr/lib/systemd/system/bacula-sd.service
}
# vim:set ts=2 sw=2 et:

# Maintainer: Andrea Repetto <darkraziel at libero dot it>

pkgname=upsmon
pkgver=5.1.0
pkgrel=1
pkgdesc="Powershield 3 UPS Monitor for Riello UPS series"
arch=('i686' 'x86_64')
url="http://www.riello-ups.com/?en/downloads/1/powershield3-free"
license=('custom')
depends=('sh' 'bash')
optdepends=('java-runtime: to execute the graphical utilities')
source=(upsmon.d ups-run-as-root
        xupsetup.desktop xupsview.desktop xwizsetup.desktop)
md5sums=('e27cf56a3019669d198759ce464d3d20'
         '4948b07103213041b911bf8571706911'
         'a9db7ed077c02d14f3b2bf08a053ff76'
         '55d6adbd80341faf59ff7ad0eb5765dd'
         '7b0aeda87f3c5b02d6358be2802b5c70')
if [ "$CARCH" = "i686" ]; then
	_arch='intel'
	_pkg="$pkgname-$pkgver-linux-2.6-$_arch"
	source+=("http://www.riello-ups.com/areaftp/Linux-RedHat-i386/$_pkg.rpm")
	md5sums+=('0e32179283180315597aefc13f7b5895')
elif [ "$CARCH" = "x86_64" ]; then
	_arch='x86_64'
	_pkg="$pkgname-$pkgver-linux-2.6-$_arch"
	source+=("http://www.riello-ups.com/areaftp/Linux-RedHat-x86_64/$_pkg.rpm")
	md5sums+=('d38b3bde8b5d4457874d774934ae2756')

fi
install=upsmon.install
backup=('opt/upsmon/upsmon.ini')

build() {
	
  cd $srcdir
  
  # Unpack the rpm package
  bsdtar -xf $_pkg.rpm
  
  # Install license
  install -D -m644 $srcdir/opt/$pkgname/License.txt \
  "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  
  # Copy files in /etc
  install -d $pkgdir/etc/rc.d/
  install -D -m755 $srcdir/upsmon.d $pkgdir/etc/rc.d/upsmon
  
  # Copy files in /opt
  install -d $pkgdir/opt/$pkgname
  cp -r $srcdir/opt/$pkgname/* $pkgdir/opt/$pkgname
  
  # Replace rc.upsmon with upsmon in the start/stop/restart scripts
  cd $pkgdir/opt/$pkgname
  replace rc.upsmon upsmon -- upsstart upsstop upsrestart
  
  # Copy files in /usr/bin
  install -D -m755 $srcdir/ups-run-as-root $pkgdir/usr/bin/ups-run-as-root
   
  # Create scripts for running applications
  install -d $pkgdir/usr/bin
  
  local _apps=(upsetup upsview xupsetup xupsview xwizsetup)
  for _app in ${_apps[@]}; do
    cat > $pkgdir/usr/bin/$_app <<EOF
#!/bin/bash

cd "/opt/upsmon"
./$_app
EOF
    chmod 755 $pkgdir/usr/bin/$_app
  done
  
  # Create symlinks for GUI applications
  #ln -sf wizsetup.scr xwizsetup
  #ln -sf upsetup.scr xupsetup
  #ln -sf upsview.scr xupsview
  
  # Fix permissions for directories
  chmod a+x $pkgdir/opt/upsmon/images
  chmod a+x $pkgdir/opt/upsmon/html
  
  # Add desktop entries
  install -d $pkgdir/usr/share/applications
  install -D -m644 $srcdir/xupsetup.desktop $pkgdir/usr/share/applications/
  install -D -m644 $srcdir/xupsview.desktop $pkgdir/usr/share/applications/
  install -D -m644 $srcdir/xwizsetup.desktop $pkgdir/usr/share/applications/
}

# vim:set ts=2 sw=2 et:

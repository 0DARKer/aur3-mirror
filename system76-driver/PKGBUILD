# Maintainer: ava1ar <mail(at)ava1ar(dot)info>

pkgname=system76-driver
pkgver=14.04.5
pkgrel=1
pkgdesc="System76 Driver provides drivers, restore, and regression support for System76 computers"
arch=('any')
url="https://launchpad.net/system76-driver"
license=('GPL')
install="${pkgname}.install"
depends=('python>=3.4' 'python-gobject' 'python-dbus' 'dmidecode' 'pm-utils')
makepdepends=('patch')
optdepends=('pulseaudio: To apply microphone fix'
	    'colord: To use ICC color profile for display'
            'grub: To apply brigtness button fix')
source=("https://launchpad.net/~system76-dev/+archive/stable/+files/${pkgname}_${pkgver}.tar.gz"
	'system76.service'
	'galu1.patch'
	'grub.patch')
sha1sums=('2ac15470ab9f5de556005f0ab8e815bd51f33255'
	  'cf763432441c3da0563eee041145a02109f2bb3a'
	  'd9940b3f8ad537d5dd9a11936437dee4db9d5f09'
	  '48478ce259f15a29129be61af44ae3fab96b837b')

package() {
	cd ${srcdir}/${pkgname}-${pkgver}
	
	# installing system76-daemon/system76-driver-pkexec/systemd service/python module
	install -m644 -D system76-daemon ${pkgdir}/usr/lib/${pkgname}/system76-daemon
	install -m755 -D system76-driver-pkexec ${pkgdir}/usr/bin/system76-driver-pkexec
	install -m644 -D ${startdir}/system76.service ${pkgdir}/usr/lib/systemd/system/system76.service
	python setup.py install --prefix=/usr --root=${pkgdir} --optimize=1
	
	# patching
	cd ${pkgdir}
	# galu1 model-specific patch
	patch --no-backup-if-mismatch -Np1 -i ${srcdir}/galu1.patch 
	# making grub optional - do not fail if no /etc/default/grub file found
	patch --no-backup-if-mismatch -Np1 -i ${srcdir}/grub.patch 
	
	# removing tests
	rm -rf ${pkgdir}/usr/lib/python3.4/site-packages/system76driver/tests/
} 

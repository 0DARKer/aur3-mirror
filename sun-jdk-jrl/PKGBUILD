# $Id: $
# Maintainer: Paulo Matias <matiasΘarchlinux-br·org>
# Contributor: Kessia 'even' Pinheiro <kessia at archlinux-br.org>

# Based in FreeBSD and NetBSD packages
pkgname="sun-jdk-jrl"
pkgver="6u3"
pkgrel=2
pkgdesc="Sun JDK JRL backported from BSD"
arch=('i686' 'x86_64')
url="http://java.sun.com"
depends=('glibc')
makedepends=('unzip' 'less' 'sed' 'gawk' 'openmotif' 'alsa-lib' 'cups' 'jdk')
optdepends=('alsa-lib: For ALSA sound'
            'cups: For printing'
            'libx11: For GUI programs')

#
# Places to download stuff:
#
# * bsd-jdk16-patches-4.tar.bz2
#   http://www.eyesbeyond.com/freebsddom/java/JDK16JRLConfirm.html
#   "Patchset 4"
#
# * jdk-6u3-fcs-bin-b05-jrl-24_sep_2007.jar
#   http://download.java.net/jdk6/6u3/
#   "JDK Binaries for Source Build 6u3"
#
# * jdk-6u3-fcs-src-b05-jrl-24_sep_2007.jar
#   http://download.java.net/jdk6/6u3/
#   "JDK 6u3 Source under the JRL license"
#
# * jdk-6u3-fcs-mozilla_headers-b05-unix-24_sep_2007.jar
#   http://download.java.net/jdk6/6u3/
#   "Mozilla Binaries for Source Build 6u3 (Unix)"
#

source=('bsd-jdk16-patches-4.tar.bz2' 
	    'jdk-6u3-fcs-bin-b05-jrl-24_sep_2007.jar' 
	    'jdk-6u3-fcs-src-b05-jrl-24_sep_2007.jar' 
	    'jdk-6u3-fcs-mozilla_headers-b05-unix-24_sep_2007.jar' 
	    'x_x2zip.c' 
	    'archlinux-jdk16-patches.diff' 
	    "${pkgname}.profile")
noextract=${source[@]}
md5sums=('632065b603a428a60383db7f0cb04cdf'
         '8b6f1b8d8dec051c18385539111141ec'
         '83390379fb9f3193e93a9d5eed5b31d9'
         '6dcaf7af16211617adff5d672a8b79f4'
         '0e644738fb304cf03630b302d99900e8'
         '80b2bb0e40233dd86be94c8b97aea162'
         '58224c3eb0d3daabce2cd5be360f52c9')
conflicts=('java-environment' 'j2sdk' 'jdk' 'jre')
provides=('java-environment' 'j2sdk' 'jdk' 'jre')
license=('custom')

build() {
    cd "${srcdir}"

    #
    # License Extract
    #
    gcc -o x_x2zip x_x2zip.c || return 1
    msg ""
    msg "You will now be shown the licenses. If you accept the terms"
    msg "of each license agreement, type 'yes' followed by ENTER to"
    msg "continue. Press ENTER now to continue or CTRL-C at any time"
    msg "to abort."
    read _ans
    for _f in ${source[@]}; do
        if [ "${_f}" != "${_f#jdk-}" ]; then
            unzip -p "${_f}" LICENSE | less
            echo -n "==> Do you accept the terms of the license agreement? "
            read _ans; if [ "$_ans" != "yes" ]; then return 1; fi
        fi
    done
    for _f in ${source[@]}; do
        if [ "${_f}" != "${_f#jdk-}" ]; then
            msg "Extracting '${_f}'..."
            unzip -q "${_f}" X_X || return 1
            ./x_x2zip 'YES I ACCEPT THE CLICK THROUGH LICENSE.  ' X_X && unzip -q X_X.zip || return 1
            rm -f X_X
        fi
    done

    #
    # Post Extract
    #
    mv share/plugin deploy/src/plugin/share || return 1
    rmdir share

    #
    # Patch
    #
    for _f in ${source[@]}; do
        if [ "${_f}" != "${_f#bsd-}" ]; then
            bsdtar -x -f "${_f}" || return 1
        fi
    done
    msg "Applying BSD patches..."
    patch -p0 -E -s < 'jdk16.patches' || return 1
    
    msg "Applying Arch Linux patches..."
    patch -p0 -s -b < 'archlinux-jdk16-patches.diff' || return 1

    #
    # Build
    #
    cd "${srcdir}"
    cd control/make || return 1

    LANG="C" \
    LC_ALL="C" \
    LD_PRELOAD="" \
    ALT_BOOTDIR="/opt/java" \
    ALT_MOTIF_DIR="/usr" \
    ALT_DEVTOOLS_PATH="/usr" \
    JAVA_HOME="" \
    CLASSPATH="" \
    LD_LIBRARY_PATH="" \
    MAKEFLAGS="" \
    SKIP_COMPARE_IMAGES="true" \
    SKIP_FASTDEBUG_BUILD="true" \
    ALT_CUPS_HEADERS_PATH="/usr/include" \
    ALT_HOTSPOT_IMPORT_PATH="/opt/java" \
    STATIC_MOTIF="true" \
    ALT_GCC29_COMPILER_PATH="/usr" \
    USER="pacman" \
    MILESTONE="archlinux" \
        make NAWK="/bin/gawk" \
             CUT="/bin/cut" \
             SH="/bin/bash" \
             TR="/bin/tr" \
	     MOTIF_LIB="/usr/lib"



    #
    # Install
    #
    msg "Installing files..."
    cd "${srcdir}/control/build"/* || return 1 # i586 or amd64

    install -dm755 "${pkgdir}/opt" || return 1
    cp -PR 'j2sdk-image' "${pkgdir}/opt/java" || return 1
    cp -PR 'jre1.6.0' "${pkgdir}/opt/java/jre" || return 1

    install -dm755 "${pkgdir}/usr/lib/mozilla/plugins" || return 1
    # Note that this is not really gcc29, as pointed the build system to gcc4.
    # However, the other ns7 directory strangely gets a plugin with an unknown
    # unresolved symbol from somewhere I really don't know how.
    if [ "${CARCH}" = "x86_64" ]; then
	ln -s "/opt/java/jre/plugin/amd64/ns7-gcc29/libjavaplugin_oji.so" "${pkgdir}/usr/lib/mozilla/plugins" || return 1
    else
	ln -s "/opt/java/jre/plugin/i386/ns7-gcc29/libjavaplugin_oji.so" "${pkgdir}/usr/lib/mozilla/plugins" || return 1
    fi
    install -Dm644 'j2sdk-image/LICENSE' "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE" || return 1
    install -Dm755 "${srcdir}/${pkgname}.profile" "${pkgdir}/etc/profile.d/${pkgname}.sh"
}


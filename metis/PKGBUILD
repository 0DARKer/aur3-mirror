# Maintainer: tzervo <tzervo@gmail.com>
# Contributor: mickele <mimocciola __AT__ yahoo __DOT__ com>
# Contributor: gborzi
# Contributor: abenson
pkgname=metis
pkgver=4.0.1
pkgrel=6
pkgdesc="A set of serial programs for partitioning graphs, partitioning finite element meshes, and producing fill reducing orderings for sparse matrices."
url="http://glaros.dtc.umn.edu/gkhome/metis/metis/overview"
license=('custom')
depends=()
makedepends=('make' 'gcc' 'patch' 'sed' 'coreutils')
provides=()
conflicts=()
replaces=()
backup=()
install=${pkgname}.install
arch=('i686' 'x86_64')
options=('docs')
source=(http://glaros.dtc.umn.edu/gkhome/fetch/sw/metis/${pkgname}-4.0.tar.gz patch_Shared-Makefile LICENSE)


build() {
  local _installdir=/usr
  local _pkgvershort=${pkgver%.*}

  cd ${srcdir}/${pkgname}-${_pkgvershort}

  for i in `grep -rl log2 *`; do 
      sed -i -e 's/log2/log2int/g' $i; 
  done

  sed -e "s|OPTFLAGS = -O2|OPTFLAGS =  ${CFLAGS}|" \
      -e "s|COPTIONS =|COPTIONS = -fPIC|" \
      -i Makefile.in

  sed -e "s|__log2|__ilog2|" -i Lib/rename.h

  # Patch necessary to create shared library
  patch -Np1 -i ${srcdir}/patch_Shared-Makefile
  
  make || return 1
  
  # Install binaries and libraries
  install -m755 -d ${pkgdir}${_installdir}/bin/
  install -m755 ${srcdir}/${pkgname}-${_pkgvershort}/{graphchk,kmetis,mesh2dual,mesh2nodal,oemetis,onmetis,partdmesh,partnmesh,pmetis}  ${pkgdir}${_installdir}/bin/
  install -m755 -D ${srcdir}/${pkgname}-${_pkgvershort}/libmetis.so  ${pkgdir}${_installdir}/lib/libmetis.so.${pkgver} 
  ln -sf libmetis.so.${pkgver} ${pkgdir}${_installdir}/lib/libmetis.so.${pkgver:0:1}
  install -m644 ${srcdir}/${pkgname}-${_pkgvershort}/libmetis.a ${pkgdir}${_installdir}/lib/
  install -m755 -d ${pkgdir}${_installdir}/include/metis
  install -m644 ${srcdir}/${pkgname}-${_pkgvershort}/Lib/*.h  ${pkgdir}${_installdir}/include/metis
  for _HEADER in defs.h struct.h macros.h rename.h proto.h
  do
	sed -e "s|<${_HEADER}>|<metis/${_HEADER}>|" \
	    -i ${pkgdir}${_installdir}/include/metis/metis.h
  done

  # Install doc and license
  install -m644 -D ${srcdir}/${pkgname}-${_pkgvershort}/Doc/manual.ps ${pkgdir}/usr/share/doc/$pkgname/manual.ps
  install -m644 -D ${srcdir}/LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE || return 1
}
md5sums=('0aa546419ff7ef50bd86ce1ec7f727c7'
         '80e6a6cc82bc9ebd9de1c7de6b4b71e5'
         'a8f1258212bd36633a2a62c2af73b542')

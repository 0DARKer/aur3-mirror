# Contributor: Kun Wang <ifreedom.dot.cn.at.gmail.dot.com>

pkgname=muduo
pkgver=0.2.2
pkgsubver=alpha
pkgrel=1
pkgdesc="A reactor-based light weight C++ network library"
arch=('i686' 'x86_64')
# groups=('')
url="http://code.google.com/p/muduo"
license=('New BSD License')
depends=('boost' 'linux-api-headers>2.6.28')
makedepends=('cmake' 'make')
# conflicts=('')
# provides=('')
# replaces=('')
# options=('!libtool')
source=("http://muduo.googlecode.com/files/muduo-$pkgver-$pkgsubver.tar.gz"
        "build.patch")
md5sums=('4034f1eaf6dec0d4847f7e16fe5ef702'
         '9fc3f6f5333edee612c77a79301aa56d')

_name="$pkgname"

build() {
  cd "$srcdir/"

  rm -rf "$srcdir/$_name-build"
  cp -r "$srcdir/$_name" "$srcdir/$_name-build"
  cd "$srcdir/$_name-build"

  patch -p1 <../build.patch

  mkdir -p doc
  sed -e 's/..\/build/.\/doc/' Doxyfile >Doxyfile.1
  mv -f Doxyfile.1 Doxyfile
  doxygen

  mkdir -p build
  cd build
  cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr ..
  make
}

install_dir() {
  	ls $1 | while read f; do
		local file="$1/$f"
  		if [ -f $file ]; then
  			install -Dm644 $file $2
  		elif [ -d $file ]; then
			local dir="$2/`basename $f`"
  			mkdir -p $dir
  			install_dir $file $dir
  		fi
	done
}

package(){
  cd "$srcdir/$_name-build"

# install doc files
  mkdir -p $pkgdir/usr/share/doc/$_name
  install_dir $srcdir/$_name-build/doc/html $pkgdir/usr/share/doc/$_name

# install license files
  mkdir -p $pkgdir/usr/share/licenses/$_name
  install -Dm644 $srcdir/$_name-build/License \
  	$pkgdir/usr/share/licenses/$_name/License

  cd build
  make DESTDIR=$pkgdir install || return 1

  rm -rf "$srcdir/$_name-build"
}

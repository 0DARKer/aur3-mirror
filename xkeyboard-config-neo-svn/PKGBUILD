# Maintainer: Jan RÃ¼egg <rggjan@gmail.com>
_xkeyboardver=1.8
pkgname=xkeyboard-config-neo-svn
pkgver=2148
pkgrel=1
pkgdesc="xkeyboard-config with the ergonomic German keyboard layout Neo"
arch=(any)
license=('custom')
url="http://www.neo-layout.org"
depends=('xorg-xkb-utils' 'numlockx')
makedepends=('intltool' 'subversion' 'pkgconfig')
provides=("xkeyboard-config=${_xkeyboardver}" "xkbdata")
replaces=('neo-layout-svn' "xkbdata")
conflicts=("xkeyboard-config" "xkbdata" "neo-layout-svn")
source=(http://xlibs.freedesktop.org/xkbdesc/xkeyboard-config-${_xkeyboardver}.tar.bz2)
md5sums=('37ae41628cd2ce35d202d30b1820c8ba')
install=$pkgname.install

_svntrunk=https://svn.neo-layout.org
_svnmod=neo

build() {
  # build xkeyboard-config
  cd "${srcdir}/xkeyboard-config-${_xkeyboardver}"
  ./configure --prefix=/usr \
      --with-xkb-base=/usr/share/X11/xkb \
      --with-xkb-rules-symlink=xorg \
      --enable-compat-rules=yes || return 1
  make || return 1
  make DESTDIR="${pkgdir}" install || return 1
  rm -f "${pkgdir}/usr/share/X11/xkb/compiled" || return 1
  install -m755 -d "${pkgdir}/var/lib/xkb"
  install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
  install -m644 COPYING "${pkgdir}/usr/share/licenses/${pkgname}/" || return 1
  
  # include new layout 
  cd ${srcdir}

  svn co -r $pkgver $_svntrunk/linux/bin $_svnmod/linux/bin
  svn co -r $pkgver $_svntrunk/linux/X $_svnmod/linux/X
  svn co -r $pkgver $_svntrunk/linux/console $_svnmod/linux/console
  svn co -r $pkgver $_svntrunk/linux/etc $_svnmod/linux/etc
  svn co -r $pkgver $_svntrunk/A-REFERENZ-A $_svnmod/A-REFERENZ-A
 
  msg "SVN checkout done or server timeout"
  msg "Starting installation..."
  
  cd $_svnmod/linux
  
  # X.org layout
  install -D -m644 X/compat/* ${startdir}/pkg/usr/share/X11/xkb/compat
  install -D -m644 X/rules/* ${startdir}/pkg/usr/share/X11/xkb/rules
  install -D -m644 X/symbols/* ${startdir}/pkg/usr/share/X11/xkb/symbols
  install -D -m644 X/types/* ${startdir}/pkg/usr/share/X11/xkb/types

  # console layout (not part of xkeyboard-config, but belongs solely to Neo)
  cd console
  gzip -f neo.map
  install -d ${startdir}/pkg/usr/share/kbd/keymaps/i386/neo
  install -D -m644 neo.map.gz ${startdir}/pkg/usr/share/kbd/keymaps/i386/neo/

  # bins
  cd ../bin
  install -d ${startdir}/pkg/usr/bin
  install -D -m755 ./* ${startdir}/pkg/usr/bin/

  #configuration
  cd ../etc
  sed -i 's/\$HOME/\/usr\/share\/doc/' neo.conf
  install -d ${startdir}/pkg/etc/
  install -D -m644 neo.conf ${startdir}/pkg/etc/

  # docs
  cd ../../A-REFERENZ-A
  install -d ${startdir}/pkg/usr/share/doc/neo/
  install -D -m644 neo20.txt ${startdir}/pkg/usr/share/doc/neo/
}

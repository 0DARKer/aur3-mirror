# Maintainer: Filip Brcic <brcha@gna.org>
# OldMaintainer: Sven-Hendrik Haase <sh@lutzhaase.com>
# Contributor: napa3um <napa3um@gmail.com>

pkgname=mingw-w64-sqlite3
_amalgamationver=3071600
pkgver=3.7.16.1
pkgrel=1
pkgdesc="A C library that implements an SQL database engine (mingw-w64)"
arch=('any')
license=('custom')
groups=('mingw-w64')
url="http://www.sqlite.org/"
depends=('mingw-w64-crt' 'mingw-w64-pdcurses' 'mingw-w64-readline' 'mingw-w64-termcap')
makedepends=('mingw-w64-headers' 'mingw-w64-gcc' 'tcl')
source=("http://www.sqlite.org/sqlite-src-$_amalgamationver.zip"
        'mingw32-sqlite-3.7.9-no-undefined.patch')
md5sums=('f24e1de071062eda96cd47b7418f0243'
         'a764826c4478672aaaf3e750f6ed5811')
options=(!buildflags !strip !libtool)

_architectures="i686-w64-mingw32 x86_64-w64-mingw32"

build() {
  cd ${srcdir}/sqlite-src-${_amalgamationver}

  patch -Np1 -i ${srcdir}/mingw32-sqlite-3.7.9-no-undefined.patch

  for _arch in ${_architectures}; do
    mkdir -p build-${_arch} && pushd build-${_arch}

    unset LDFLAGS
    export config_TARGET_EXEEXT=.exe
    export CFLAGS="-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions --param=ssp-buffer-size=4 -DSQLITE_ENABLE_COLUMN_METADATA=1 -DSQLITE_DISABLE_DIRSYNC=1 -DSQLITE_ENABLE_FTS3=3 -DSQLITE_ENABLE_RTREE=1 -fno-strict-aliasing -pthread"

    ../configure --prefix=/usr/${_arch} --host=${_arch} --disable-tcl --enable-threadsafe --enable-threads-override-locks --enable-load-extension
    sed -e s,build_libtool_need_lc=yes,build_libtool_need_lc=no, < libtool > libtool.x
    mv libtool.x libtool
    chmod a+x libtool

    make
    make DESTDIR=${pkgdir} install
    rm -Rf ${pkgdir}/usr/${_arch}/share
    chmod 0644 ${pkgdir}/usr/${_arch}/lib/libsqlite3.dll.a
    popd
  done
}


#Extremely based on the original PKGBUILD made by Corrado Primier <bardo@aur.archlinux.org> and William Rea <sillywilly@gmail.com>
#Contributor: Lorenzo Nizzi Grifi Gargiolli <lorenzo.nizzi.grifi@gmail.com>

pkgname=pulseaudio-git
pkgver=20091020
pkgrel=1
pkgdesc="A networked sound server - Development version"
arch=('i686' 'x86_64')
url="http://pulseaudio.org/"
license=('GPL' 'LGPL')
depends=('consolekit' 'gdbm' 'hal' 'libasyncns' 'libcap' 'liboil' 'libsamplerate'
         'libtool' 'policykit' 'speex')
makedepends=('autoconf' 'avahi' 'bluez' 'gconf' 'intltool' 'jack-audio-connection-kit'
             'libatomic_ops' 'lirc-utils' 'pkgconfig' 'tcp_wrappers')
optdepends=('alsa-plugins: ALSA support'
            'avahi: network support'
            'bluez: bluetooth support'
            'glib'
            'jack-audio-connection-kit: jack support'
            'lirc-utils'
            'tcp_wrappers')
provides=('polypaudio' 'pulseaudio=0.9.15')
conflicts=('polypauio' 'pulseaudio')
replaces=('polypaudio' 'pulseaudio')
options=('emptydirs' '!libtool' '!makeflags')
backup=('etc/pulse/client.conf' 'etc/pulse/daemon.conf' 'etc/pulse/default.pa')
install=pulseaudio.install
source=(pulseaudio.conf pulseaudio.rc)
md5sums=('d4a7d4ad51b406588ba7ac7931c5dd88' 'c5aa09c1d3e2217dc3bb23138e2a5a1d')


_gitroot="http://git.0pointer.de/repos/pulseaudio.git/"
_gitname="pulseaudio"

build() {
  cd ${srcdir}
  msg "Connecting to freedesktop GIT server...."

  if [ -d ${srcdir}/$_gitname ] ; then
  cd $_gitname && git pull origin
  msg "The local files are updated."
  else
  git clone $_gitroot
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  git clone $_gitname $_gitname-build
  cd ${srcdir}/$_gitname-build

 ./autogen.sh --host=${CHOST} \
              --libexecdir=/usr/lib \
              --localstatedir=/var \
              --prefix=/usr \
              --sysconfdir=/etc
  export LDFLAGS="${LDFLAGS//Wl, --as-needed}"
  make || return 1
  make DESTDIR=${pkgdir} install

  install -Dm755 ${srcdir}/pulseaudio.rc ${pkgdir}/etc/rc.d/pulseaudio || return 1
  install -Dm644 ${srcdir}/pulseaudio.conf ${pkgdir}/etc/conf.d/pulseaudio || return 1
  install -dm755 ${pkgdir}/var/run/pulse || return 1

  # Ugly fix for pulseaudio system users
  install -dm755 ${pkgdir}/var/pulse || return 1
  echo -e '\n### Automatically restore volumes\nload-module module-volume-restore table="/var/pulse/volume-restore.table"' \
    >> ${pkgdir}/etc/pulse/system.pa || return 1
}



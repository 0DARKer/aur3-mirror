# Maintainer : Rob McCathie <archaur at rmcc dot com dot au>
# Contributor: Giovanni Scafora <giovanni@archlinux.org>
# Contributor: Sarah Hay <sarahhay@mb.sympatico.ca>
# Contributor: Martin Sandsmark <martin.sandsmark@kde.org>
# Contributor: heaven <aheaven87 at gmail dot com>
# Contributor: graysky <graysky at archlinux dot us>
# Contributor: Arkham <arkham at archlinux dot us>
# Contributor: MacWolf <macwolf at archlinux dot de>

## This PKGBUILD is a bit of a mess, it'll get neatened as i get to the bottom of some issues.

pkgname='vlc-git'
pkgver=2.2.r57675.gd2ff191
pkgrel=1
pkgdesc='A multi-platform MPEG, VCD/DVD, and DivX player. Development GIT Version.'
arch=('i686' 'x86_64')
url='http://www.videolan.org/vlc/'
license=('LGPL2.1' 'GPL2')

## Arch VLC package
#depends=('a52dec' 'libdvbpsi' 'libxpm' 'libdca' 'qt4' 'libproxy'
#         'sdl_image' 'libdvdnav' 'libtiger' 'lua' 'libmatroska'
#         'zvbi' 'taglib' 'libmpcdec' 'ffmpeg' 'faad2' 'libupnp'
#         'libshout' 'libmad' 'libmpeg2' 'xcb-util-keysyms' 'libtar'
#         'libxinerama')
#makedepends=('live-media' 'libnotify' 'libbluray' 'flac' 'kdelibs'
#             'libdc1394' 'libavc1394' 'lirc-utils' 'libcaca'
#             'librsvg' 'portaudio' 'libgme' 'xosd' 'projectm'
#             'twolame' 'aalib' 'libmtp' 'libdvdcss' 'gnome-vfs'
#             'libgoom2' 'vcdimager' 'opus' 'libssh2' 'mesa')

## I'll be testing and re-enabling features soon. Post on AUR comments stuff you want that's currently disabled.

depends=('a52dec' 'libdvbpsi' 'libxpm' 'qt4'
         'sdl_image' 'libdvdnav' 'lua' 'libmatroska'
         'libmpcdec' 'ffmpeg' 'faad2'
         'libmad' 'libmpeg2' 'xcb-util-keysyms'
         'libxinerama'
         'x264' 'fluidsynth')
makedepends=('live-media' 'libbluray' 'flac' 'kdelibs'
             'libavc1394' 'lirc-utils'
             'librsvg'
             'twolame' 'aalib' 'libdvdcss'
             'vcdimager' 'opus' 'mesa'
             'git')

## I'll deal with this later
#optdepends=('avahi: for service discovery using bonjour protocol'
#            'libnotify: for notification plugin'
#            'ncurses: for ncurses interface support'
#            'libdvdcss: for decoding encrypted DVDs'
#            'lirc-utils: for lirc plugin'
#            'libavc1394: for devices using the 1394ta AV/C'
#            'libdc1394: for IEEE 1394 plugin'
#            'kdelibs: KDE Solid hardware integration'
#            'libva-vdpau-driver: vdpau back-end for nvidia'
#            'libva-intel-driver: back-end for intel cards'
#            'libbluray: for Blu-Ray support'
#            'flac: for Free Lossless Audio Codec plugin'
#            'portaudio: for portaudio support'
#            'twolame: for TwoLAME mpeg2 encoder plugin'
#            'projectm: for ProjectM visualisation plugin'
#            'libcaca: for colored ASCII art video output'
#            'libgme: for libgme plugin'
#            'librsvg: for SVG plugin'
#            'gnome-vfs: for GNOME Virtual File System support'
#            'libgoom2: for libgoom plugin'
#            'vcdimager: navigate VCD with libvcdinfo'
#            'aalib: for ASCII art plugin'
#            'libmtp: for MTP devices support'
#            'smbclient: for SMB access plugin'
#            'libcdio: for audio CD playback support'
#            'ttf-freefont: for subtitle font '
#            'ttf-dejavu: for subtitle font'
#            'opus: for opus support'
#            'libssh2: for sftp support'
#            'lua-socket: for http interface')

conflicts=('vlc' 'vlc-stable-git' 'vlc-dev' 'vlc-plugin')
provides=('vlc')
backup=('usr/share/vlc/lua/http/.hosts'
        'usr/share/vlc/lua/http/dialogs/.hosts')
options=('!emptydirs')
install='vlc-git.install'
source=('git://git.videolan.org/vlc.git')
sha1sums=('SKIP')

_gitroot='vlc'

pkgver() {
  cd "${srcdir}/${_gitroot}"
  echo "2.2.r$(git rev-list --count master).g$(git log -1 --format="%h")"
}

prepare() {
  cd "${srcdir}/${_gitroot}"

  sed -i -e 's:truetype/freefont:TTF:g' modules/text_renderer/freetype.c
  sed -i -e 's:truetype/ttf-dejavu:TTF:g' modules/visualization/projectm.cpp
}

build() {
  cd "${srcdir}/${_gitroot}"

  msg 'Generating necessary files...'

  ./bootstrap

  msg 'Done. Configuring VLC...'

  CFLAGS+=" -I/usr/include/samba-4.0" CPPFLAGS+=" -I/usr/include/samba-4.0" \

## Arch VLC package
#  ./configure --prefix=/usr \
#              --sysconfdir=/etc \
#              --disable-rpath \
#              --enable-faad \
#              --enable-nls \
#              --enable-lirc \
#              --enable-ncurses \
#              --enable-realrtsp \
#              --enable-aa \
#              --enable-vcdx \
#              --enable-upnp \
#              --enable-opus \
#              --enable-sftp \
#              LUAC=/usr/bin/luac  LUA_LIBS="`pkg-config --libs lua`" \
#              RCC=/usr/bin/rcc-qt4

## From FredBezies's comment on AUR, builds but can't generate plugin cache, segfaults
#  ./configure --prefix=/usr \
#              --sysconfdir=/etc \
#              --disable-rpath \
#              --enable-faad \
#              --enable-nls \
#              --enable-lirc \
#              --enable-ncurses \
#              --enable-realrtsp \
#              --enable-aa \
#              --enable-vcdx \
#              --enable-upnp \
#              --enable-opus \
#              --enable-sftp \
#              --disable-lua \
#              --enable-vcdx \
#              --enable-wma-fixed \
#              --enable-merge-ffmpeg \
#              --disable-rpath \
#              --disable-werror \
#              RCC=/usr/bin/rcc-qt4

  ./configure --prefix=/usr \
              --enable-{alsa,avcodec,avformat,a52,dvdnav,dvdread,fontconfig,freetype,glx} \
              --enable-{libxml2,libmpeg2,loader,mad,ncurses} \
              --enable-{optimize-memory,optimizations,qt4,sout} \
              --enable-{vlc,vlm,xvideo,xcb,x264} \
              --enable-{mkv,ogg,mux_ogg,vorbis,wma-fixed,faad,flac,theora,twolame,mpc} \
              --enable-{aa,bluray,png,real,realrtsp,sdl,sdl-image,svg,speex,swscale,vcd,vcdx,v4l2,lua,httpd,libass,screen,lirc,fluidsynth} \
              --disable-{atmo,bonjour,caca,coverage,cprof} \
              --disable-{dbus,dbus-control,dca,dc1394,debug,decklink,dirac,directfb,directx,dshow,dv,fbosd,fribidi} \
              --disable-{gme,gnomevfs,gnutls,goom,gprof,growl,jack,kate} \
              --disable-{libcddb,libgcrypt,libproxy,libtar,linsys,live555,loader} \
              --disable-{macosx,macosx-audio,mod,mtp,nls,notify,opencv,oss} \
              --disable-{portaudio,postproc,projectm,pulse,pvr,quicktime,rpath,run-as-root} \
              --disable-{schroedinger,sftp,shine,shout,sid,skins2,smb,sqlite,switcher} \
              --disable-{taglib,telepathy,telx,tiger,tremor} \
              --disable-{udev,upnp,update-check,visual} \
              --disable-{waveout,wingdi,xosd,zvbi} \
              LUAC=/usr/bin/luac  LUA_LIBS="`pkg-config --libs lua`" \
              RCC=/usr/bin/rcc-qt4

  msg 'Done. Starting make...'

  make
}

package() {
  cd "${srcdir}/${_gitroot}"
  
  make DESTDIR="${pkgdir}" install
}

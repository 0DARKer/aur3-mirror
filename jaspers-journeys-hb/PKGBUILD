# Contributor: Denis Moiseev <imdens@gmail.com>
# Maintainer:  Fabian Schoelzel <fabian.schoelzel@googlemail.com>

pkgname=jaspers-journeys-hb
pkgver=2.14
pkgrel=1
pkgdesc="[Humble Bundle] A fantasy retro platform game."
arch=('i686' 'x86_64')
url="http://www.lexaloffle.com/jasper.php"
license=('custom: "commercial"')
groups=('humblevoxatronbundle' 'humblebundles')
depends=('sdl' 'libgl' 'libpulse')
makedepends=()
options=(!strip)
source=(jaspers-journeys.desktop
	jaspers-journeys.png
	jaspers-journeys)
md5sums=('770a5e38228d6573bf8bff8424185274'
         'ec61dbb54054f72b6453fbef6d61e3ca'
         'eb14714fec36a3d2a8e8675e9bba75ed')

_gamepkgname="jaspers-journeys"
_gamepkg="${_gamepkgname}_${pkgver}-${pkgrel}_i386.tar.gz"

build() {
  cd "${srcdir}"
  msg "You need a full copy of this game in order to install it"
  msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
  if [[ -f "../${_gamepkg}" ]]; then
    msg "Found game package, installing..."
    ln -fs "../${_gamepkg}" .
  elif [ -n "${_humblevoxatronkey}" ]; then
    msg "Game package not found, trying to download..."
    rm -f index.html\?key\=${_humblevoxatronkey}*
    wget http://www.humblebundle.com/?key=${_humblevoxatronkey}
    wget $(cat index.html\?key\=${_humblevoxatronkey} | grep "${_gamepkg}" | cut -d "'" -f 10)
    mv ${_gamepkg}* ${_gamepkg}
  else
    msg "Game package not found and download failed."
    msg "You can add \'export _humblevoxatronkey\=\<Your key here\>\' to \.bashrc if you want automated download ability."
    error "Please type absolute path to ${_gamepkg} (/home/joe):"
    read pkgpath
    if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
      msg "Found game package, installing..."
      ln -fs "${pkgpath}/${_gamepkg}" .
    else
      error "Unable to find game package."
      return 1
    fi
  fi
  tar zxvf ${_gamepkg}
  install -d "${pkgdir}/opt/${_gamepkgname}"
#  Not needed for Jaspers Journeys. It uses system's SDL by default,
#  and has a switch to use the bundled version
#  rm "${srcdir}/${pkgname}/libSDL-1.2.so.0"
  cp -R "${srcdir}"/jasper/* "${pkgdir}/opt/${_gamepkgname}/"
}

package() {
  cd "${srcdir}"
  install -d ${pkgdir}/usr/share/jaspers-journeys
  install -d ${pkgdir}/usr/bin
  install -D -m644 ./jasper/license.txt ${pkgdir}/usr/share/licenses/${_gamepkgname}/COPYING
  install -D -m644 $srcdir/jaspers-journeys.desktop $pkgdir/usr/share/applications/jaspers-journeys.desktop
  install -D -m644 $srcdir/jaspers-journeys.png $pkgdir/usr/share/icons/jaspers-journeys.png
  install -D -m755 $srcdir/jaspers-journeys $pkgdir/usr/bin/jaspers-journeys
}

# Contributor: robb_force <robb_force@holybuffalo.net>
# Contributor: Anton Shestakov <engored*ya.ru>
# Maintainer: Eric Anderson <ejona86@gmail.com>

pkgname=sdlmess
_patch=3
_basever=0148
pkgver=0.148u${_patch}
pkgrel=1
pkgdesc='Multiple Emulator Super System, computer and game console emulator'
url='http://www.mess.org/'
license=('custom:MAME License')
arch=('i686' 'x86_64')
depends=('sdl>=1.2.11' 'sdl_ttf' 'libxinerama' 'gconf' 'zlib' 'expat' 'gtk2' 'alsa-lib')
makedepends=('mesa')
[ "$CARCH" = 'i686' ] && makedepends+=('nasm')
optdepends=('ttf-liberation: recommended UI font')
source=("${pkgname}.sh"
        "mame${_basever}s.zip::http://mamedev.org/downloader.php?file=releases/mame${_basever}s.zip"
        "http://mamedev.org/updates/${_basever}u1_diff.zip"
        "http://mamedev.org/updates/${_basever}u2_diff.zip"
        "http://mamedev.org/updates/${_basever}u3_diff.zip"
        )
md5sums=('141069e7019da5e33414dc8d4c421150'
         '38f7727c2961cd31e2ab6aa1814a23ba'
         '01edd53824784f52448f4128f6d52aac'
         '6970189e5cd593dea59aa87579bb4dca'
         '406dff01777ba08a35489b3081d5f644'
         )
install="${pkgname}.install"
noextract=("mame${_basever}s.zip")
PKGEXT='.pkg.tar.gz'

build() {
  mkdir "${srcdir}/${pkgname}-${pkgver}"
  cd "${srcdir}/${pkgname}-${pkgver}"

  msg "Extracting mame${_basever}s.zip"
  bsdtar -xOf "${srcdir}/mame${_basever}s.zip" | bsdtar -xf -

  for (( i=1; i <= ${_patch}; i++ )); do
    msg "Applying patch ${i}"
    patch -p0 -E --binary --quiet < "${srcdir}/${_basever}u${i}.diff"
  done

  msg "Building"
  make TARGET=mess SUFFIX64='' NOWERROR=1 BUILD_ZLIB=0 BUILD_EXPAT=0 \
      ARCHOPTS="$CFLAGS" PYTHON=python2
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  # Installing the wrapper script
  install -Dm755 "$srcdir/${pkgname}.sh" "$pkgdir/usr/bin/$pkgname"

  # Installing binaries
  install -Dm755 mess "$pkgdir/usr/share/$pkgname/$pkgname"

  # Installing extra bits
  install -d "$pkgdir/usr/share/$pkgname/"{artwork,hash}

  install -m644 artwork/* "$pkgdir/usr/share/$pkgname/artwork/"
  install -m644 hash/* "$pkgdir/usr/share/$pkgname/hash/"

  # The license
  install -Dm644 docs/license.txt "$pkgdir/usr/share/licenses/custom/$pkgname/license.txt"
}

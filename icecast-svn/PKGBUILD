pkgname=icecast-svn
_pkgname=icecast
pkgver=17299
pkgrel=1
pkgdesc="Streaming OGG and MP3 server, IPv6 compatible"
arch=(i686 x86_64)
url="http://www.icecast.org/"
license=('GPL2')
depends=('libxslt' 'libvorbis' 'curl>=7.19.2' 'speex' 'libtheora' 'flac')
makedepends=('subversion' 'autoconf' 'automake')
provides=('icecast')
conflicts=('icecast')
backup=('etc/icecast/icecast.xml')
install=icecast.install
source=(icecast.xml.chroot.patch
	rc-icecast
	icecast.logrotate)
md5sums=('83c20253cd9052987cfde792dbdbe342'
	'66415b295278a87c94ddc45ffe8f0789'
	'8fad3bf3283fa2bd651b71fdf505eae9')

_svn0=http://svn.xiph.org/icecast/trunk/$_pkgname/
_svn0mod=$_pkgname
_svn0rv=$pkgver

build() {
  cd $srcdir

  [ -d $_svn0mod/.svn ] &&
    (cd $_svn0mod && svn up -r $_svn0rv) ||
    svn co $_svn0 -r $_svn0rv $_svn0mod

# temporary build directories
  cp -r $_svn0mod $_svn0mod-build

  cd $_svn0mod-build/

  ./autogen.sh
  make distclean
  ./configure --prefix=/usr --sysconfdir=/etc/icecast --localstatedir=/var || return 1

# build program
  make || return 1
  make DESTDIR=$pkgdir install || return 1

# install man-page
  sed -i -e 's/icecast2/icecast/g' debian/icecast2.1
  install -D -m 644 debian/icecast2.1 $pkgdir/usr/share/man/man1/icecast.1

# install license
  install -D -m644 $srcdir/$_svn0mod/COPYING $pkgdir/usr/share/licenses/$_pkgname/COPYING

# patch default config to enable chroot
  cd $pkgdir/etc/icecast
  patch -Np0 -i $srcdir/icecast.xml.chroot.patch

# rc.d script
  install -D -m755 $srcdir/rc-icecast $pkgdir/etc/rc.d/icecast

# stuff for chroot
  mkdir -p $pkgdir/var/icecast/
  cp -R $pkgdir/usr/share/icecast/{admin,web} $pkgdir/var/icecast/

# cleaning
  rm -rf $pkgdir/usr/etc/icecast.xml
  rm -rf $pkgdir/usr/share
  rm -rf $srcdir/*-build
}

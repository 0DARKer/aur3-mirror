# Contributors:
#	henning mueller <henning@orgizm.net>

pkgbase="kernel26"
pkgname=kernel26-pax
_kernelname=${pkgname#kernel26}
_basekernel=2.6.39
_paxver=test6
pkgver=${_basekernel}
pkgrel=4
_patchname="patch-${pkgver}-1-ARCH"
arch=(i686 x86_64)
license=('GPL2')
url="http://www.kernel.org"
options=(!strip)
optdepends=(
	'pax-utils: ELF related utils with PaX flags support.'
	'paxctl: Manages PaX related program header flags.'
	'paxtest: PaX regression test suite.'
)
source=(
	ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$_basekernel.tar.bz2
	ftp://ftp.archlinux.org/other/kernel26/${_patchname}.bz2
	config
	config.x86_64
	kernel26.preset
	http://grsecurity.net/test/pax-linux-$_basekernel-$_paxver.patch
	README
)
md5sums=(
	1aab7a741abe08d42e8eccf20de61e05
	25bb870bed3865d3771b5e40d6dbfd50
	41d41bb09ea779065520577e84ab7652
	9b4a3c84956373ca89233837e4cfd6c1
	d9d245db16afb537cb39d49b490b2398
	9c58cab4098b632b39ed120df39e75cf
	e4531df249803ca0d5f342dc44e45875
)

build() {
	cd ${srcdir}/linux-$_basekernel

	# Add -ARCH patches
	# See http://projects.archlinux.org/linux-2.6-ARCH.git/
	patch -Np1 -i ${srcdir}/${_patchname}

	# Add PaX patches
	patch -Np1 -i $srcdir/pax-linux-$_basekernel-$_paxver.patch

	if [ "$CARCH" = "x86_64" ]; then
		cat ../config.x86_64 >./.config
	else
		cat ../config >./.config
	fi

	if [ "${_kernelname}" != "" ]; then
		sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./.config
	fi

	make prepare

	#make menuconfig # CLI menu for configuration
	#make nconfig # new CLI menu for configuration
	#make xconfig # X-based configuration
	#make oldconfig # using old config from previous kernel version

	#msg "Stopping build"
	#return 1

	yes "" | make config

	make ${MAKEFLAGS} bzImage modules
}

package_kernel26-pax() {
	pkgdesc="The Linux Kernel and modules with PaX patches"
	groups=('base')
	backup=(etc/mkinitcpio.d/${pkgname}.preset)
	depends=('coreutils' 'linux-firmware' 'module-init-tools>=3.12-2' 'mkinitcpio>=0.6.8-2')
	# pwc, ieee80211 and hostap-driver26 modules are included in kernel26 now
	# nforce package support was abandoned by nvidia, kernel modules should cover everything now.
	# kernel24 support is dropped since glibc24
	replaces=('kernel24' 'kernel24-scsi' 'kernel26-scsi'
			'alsa-driver' 'ieee80211' 'hostap-driver26'
			'pwc' 'nforce' 'squashfs' 'unionfs' 'ivtv'
			'zd1211' 'kvm-modules' 'iwlwifi' 'rt2x00-cvs'
			'gspcav1' 'atl2' 'wlan-ng26' 'rt2500' 'nouveau-drm')
	install=kernel26.install
	optdepends=('crda: to set the correct wireless channels of your country')

	KARCH=x86
	cd ${srcdir}/linux-$_basekernel
	# get kernel version
	_kernver="$(make kernelrelease)"
	mkdir -p ${pkgdir}/{lib/modules,lib/firmware,boot}
	make INSTALL_MOD_PATH=${pkgdir} modules_install
	cp System.map ${pkgdir}/boot/System.map26${_kernelname}
	cp arch/$KARCH/boot/bzImage ${pkgdir}/boot/vmlinuz26${_kernelname}
	# add vmlinux
	install -m644 -D vmlinux ${pkgdir}/usr/src/linux-${_kernver}/vmlinux

	# install fallback mkinitcpio.conf file and preset file for kernel
	install -m644 -D ${srcdir}/kernel26.preset ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset
	# set correct depmod command for install
	sed \
		-e "s/KERNEL_NAME=.*/KERNEL_NAME=${_kernelname}/g" \
		-e "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" \
		-i $startdir/kernel26.install
	sed \
		-e "s|source .*|source /etc/mkinitcpio.d/kernel26${_kernelname}.kver|g" \
		-e "s|default_image=.*|default_image=\"/boot/${pkgname}.img\"|g" \
		-e "s|fallback_image=.*|fallback_image=\"/boot/${pkgname}-fallback.img\"|g" \
		-i ${pkgdir}/etc/mkinitcpio.d/${pkgname}.preset

	echo -e "# DO NOT EDIT THIS FILE\nALL_kver='${_kernver}'" > ${pkgdir}/etc/mkinitcpio.d/${pkgname}.kver
	# remove build and source links
	rm -f ${pkgdir}/lib/modules/${_kernver}/{source,build}
	# remove the firmware
	rm -rf ${pkgdir}/lib/firmware
	# gzip -9 all modules to safe 100MB of space
	find "$pkgdir" -name '*.ko' -exec gzip -9 {} \;
}

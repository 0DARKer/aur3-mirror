# Maintainer: Elovsky Valentin (evvsoft@gmail.com)
# Contributor: Shalygin Konstantin (kostya@opentech.ru)

pkgname='ivideon-server-headless'
pkgver='3.5.1'
pkgrel='162'
pkgdesc='Ivideon Server'
arch=('i686' 'x86_64')
url=('http://ivideon.com/')
license=('freeware')
depends=('portaudio' 'gstreamer0.10' 'gstreamer0.10-base-plugins' 'gstreamer0.10-good-plugins')
conflicts=('ivideon-video-server-nogui')
source=('videoserverd.service' 'videoserverd.config.sample')
sha256sums=('5f14f1fd02aaedd33714e93113f3a65c8f3c927bd0a6b3efe8627b87eeb824a0' '5c61a4769b3837b960a0b053c6bbe950072762192fe86b4f8eefdeb03938b2f0')
backup=('root/.IvideonServer/videoserverd.config')

if [[ "$CARCH" == 'i686' ]]; then
  source+=("http://packages.ivideon.com/ubuntu/pool/non-free/i/${pkgname}/${pkgname}_3.5.1-162~7fc009a7433e_i386.deb")
  sha256sums+=('3e728bf47e76ac5fa5a90dae7f7db84400c4bcae51b44fafcbadd112cfb659d1')
fi

if [[ "$CARCH" == 'x86_64' ]]; then
  source+=("http://packages.ivideon.com/ubuntu/pool/non-free/i/${pkgname}/${pkgname}_3.5.1-162~7fc009a7433e_amd64.deb")
  sha256sums+=('5ba86cb16f4e043e196b20c67a4d559196eb9d8bdb2c1df40a8af2700fa6b70a')
fi

build() {
  cd "$srcdir"
  bsdtar xf "$srcdir/data.tar.gz"
  mkdir -p "$srcdir/usr/lib/systemd/system"
  mkdir -p "$srcdir/root/.IvideonServer"
  chmod 750 "$srcdir/root"
  chmod 755 "$srcdir/root/.IvideonServer"
  cp "videoserverd.service" "$srcdir/usr/lib/systemd/system"
  cp "videoserverd.config.sample" "$srcdir/root/.IvideonServer"
  rm "$srcdir/opt/ivideon/ivideon-server/init_ctl.sh"
  rm "$srcdir/opt/ivideon/ivideon-server/initd.sh"
  rm "$srcdir/opt/ivideon/ivideon-server/serverctl.sh"
  rm -r "$srcdir/etc"
}

package() {
  cp -dpr --no-preserve=ownership "$srcdir/opt" "$pkgdir"
  cp -dpr --no-preserve=ownership "$srcdir/usr" "$pkgdir"
  cp -dpr --no-preserve=ownership "$srcdir/root" "$pkgdir"
}

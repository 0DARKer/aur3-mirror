# Maintainer: Marti Raudsepp <marti@juffo.org>
# Contributor: Jakub Schmidtke <sjakub@gmail.com>

pkgname=firefox-testing-src
pkgver=3.6.3plugin1
pkgrel=1
_mozver=1.9.2
pkgdesc="Source-based testing version of the popular web browser"
arch=(i686 x86_64)
license=('MPL' 'GPL' 'LGPL')
#depends=("xulrunner=${_xulver}" 'desktop-file-utils')
depends=('desktop-file-utils' 'gnome-vfs' 'alsa-lib' 'startup-notification' 'libxt' 'libnotify' 'nss')
makedepends=('zip' 'pkgconfig' 'diffutils' 'libgnomeui>=2.24.1' 'python')
install=firefox.install
url="http://www.mozilla.org/projects/firefox"
#source=(http://releases.mozilla.org/pub/mozilla.org/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.bz2
source=(http://3347-mozilla.voxcdn.com/pub/mozilla.org/firefox/releases/$pkgver/source/firefox-$pkgver.source.tar.bz2
        mozconfig
        $pkgname.desktop
        $pkgname-safe.desktop
        xulrunner-png14.patch
        enable-x86_64-tracemonkey.patch)
md5sums=('67c739f764865ebee07acbb96c37991c'
         'f41b894dcf6dcca77e040a1558a9c216'
         'f6c6cd40dcb8eeabbcec9d85a9f89e77'
         '5f3a7e7531762802b1e567ffd875267c'
         '3bd0566180ad2daa32743b3ce58b2095'
         'cbd938cd1fb8210cd8a2c41833489af9')

build() {
  cd $srcdir/firefox-lorentz
  cp $srcdir/mozconfig .mozconfig

  patch -p0 < $srcdir/xulrunner-png14.patch
  patch -p0 < enable-x86_64-tracemonkey.patch

  export LDFLAGS="-Wl,-rpath,/usr/lib/$pkgname-3.6"

  make -f client.mk build MOZ_MAKE_FLAGS="${MAKEFLAGS}" || return 1
  make DESTDIR="${pkgdir}" install || return 1

  mv $pkgdir/usr/bin/firefox $pkgdir/usr/bin/firefox-testing-src

  install -m755 -d $pkgdir/usr/share/applications
  install -m755 -d $pkgdir/usr/share/pixmaps

  install -m644 browser/branding/unofficial/default48.png $pkgdir/usr/share/pixmaps/$pkgname-icon.png || return 1
  install -m644 $srcdir/$pkgname.desktop $pkgdir/usr/share/applications/ || return 1
  install -m644 $srcdir/$pkgname-safe.desktop $pkgdir/usr/share/applications/ || return 1
}

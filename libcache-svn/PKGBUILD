#Maintainer:

pkgname=libcache-svn
pkgver=10
pkgrel=1
pkgdesc="Commandline GCF extractor/tool"
arch=('i686' 'x86_64')
url="http://singul4rity.com"
license=('GPL')
depends=('protobuf' 'boost-libs' 'crypto++')
makedepends=('svn' 'cmake')
provides=('libcache')
conflicts=('libcache')
source=('readme')
md5sums=('fad67c4887a0ba404e3e47a33d8883a2')

_svntrunk="https://subversion.assembla.com/svn/libcache/trunk"
_svnmod="libcache"
_svnlibnonametrunk="https://subversion.assembla.com/svn/libnoname/trunk"
_svnlibnonamemod="libnoname"

build() {
  cd "${srcdir}"

  msg "Connecting to libcache SVN server...."

  if [ -d "${_svnmod}" ] ; then
    cd "${_svnmod}" && svn update
  else
    svn co "${_svntrunk}" "${_svnmod}"
  fi

  cd "${srcdir}"
  msg "SVN checkout done or server timeout"
  msg "Connecting to libnoname SVN server...."

  if [ -d "${_svnlibnonamemod}" ] ; then
    cd "${_svnlibnonamemod}" && svn update
  else
    svn co "${_svnlibnonametrunk}" "${_svnlibnonamemod}"
  fi

  msg "SVN checkout done or server timeout"
  msg "Starting make libnoname..."

  rm -fr "${srcdir}/${_svnlibnonamemod}-build"
  cp -R "${srcdir}/${_svnlibnonamemod}" "${srcdir}/${_svnlibnonamemod}-build"
  cd "${srcdir}/${_svnlibnonamemod}-build"

  qmake
  make

  msg "Starting make libcache..."
  rm -fr "${srcdir}/${_svnmod}-build"
  cp -R "${srcdir}/${_svnmod}" "${srcdir}/${_svnmod}-build"
  cd "${srcdir}/${_svnmod}-build"

  mkdir libnoname
  ln -s "${srcdir}/${_svnlibnonamemod}-build/noname" libnoname/
  ln -s "${srcdir}/${_svnlibnonamemod}-build/libnoname.a" .

  echo "LIBS += -lpthread -lz -lboost_system" >> libcache.pro
  qmake
  make
}

package() {
  cd "${srcdir}/${_svnmod}-build"
  install -Dm755 libcache "${pkgdir}/usr/bin/libcache"
  install -Dm644 "${srcdir}/readme" "${pkgdir}/usr/share/doc/libcache/README"
}
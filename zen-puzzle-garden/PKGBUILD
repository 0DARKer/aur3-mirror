# Maintainer: Zachary A. Jones <JazzplayerL9@gmail.com>

pkgname=zen-puzzle-garden
pkgver=1.3
pkgrel=1
pkgdesc="Zen Puzzle Garden gently tests your ability to rake out an uninterrupted stone garden pattern.  You must purchase the game."
url="http://www.lexaloffle.com/zen.htm"
license=('custom: "commercial"')
groups=('humblevoxatronbundle' 'humblebundles')
arch=('i686' 'x86_64')
[ "${CARCH}" = "x86_64" ] && depends=('lib32-libgl' 'lib32-sdl' 'lib32-libpulse')
[ "${CARCH}" = "i686" ] && depends=('libgl' 'sdl' 'libpulse')
options=(!strip)
source=("zpg.desktop" "zen-exec" "zpg.png")
md5sums=('b8079d429b4c0abc4240b532fa2c8ec6'
	 '0808a805715b490f7712e1d820e39e56'
	 'ffdde200aed5f09a423a93958c800733')

_gamepkg="${pkgname}_${pkgver}_i386.tar.gz"
build() {
   cd "${srcdir}"
   msg "You need a full copy of this game in order to install it"
   msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
   if [[ -f "../${_gamepkg}" ]]; then
       msg "Found game package, installing..."
       ln -fs "../${_gamepkg}" .
   elif [ -n "${_humblevoxatronkey}" ]; then
	   msg "Game package not found, trying to download..."
	   rm -f downloads\?key\=${_humblevoxatronkey}*
	   wget http://www.humblebundle.com/downloads?key=${_humblevoxatronkey}
	   wget $(cat downloads\?key\=${_humblevoxatronkey} | grep "${_gamepkg}" | cut -d "'" -f 10)
	   mv ${_gamepkg}* ${_gamepkg}
   else
	   msg "Game package not found and download failed."
	   msg "You can add \'export _humblevoxatronkey\=\<Your key here\>\' to \.bashrc if you want automated download ability."
       error "Please type absolute path to ${_gamepkg} (/home/joe):"
       read pkgpath
       if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
           msg "Found game package, installing..."
		   ln -fs "${pkgpath}/${_gamepkg}" .
	   else
	       error "Unable to find game package."
	       return 1
       fi
   fi
   tar zxvf ${_gamepkg}
   install -d "${pkgdir}/opt/${pkgname}"
#   rm "${srcdir}/${_pkgname}/libSDL-1.2.so.0"
   cp -R "${srcdir}"/${pkgname}/* "${pkgdir}/opt/${pkgname}/"
}

package(){
  cd "${srcdir}"
  # create Launcher
  install -d "${pkgdir}/usr/bin/"
  install -D -m755 "${srcdir}/zen-exec" "${pkgdir}/usr/bin/${pkgname}"
  # Install Desktop File and Icon
  install -D -m644 "${srcdir}/zpg.desktop" \
        "${pkgdir}/usr/share/applications/${pkgname}.desktop"
  install -D -m644 "${srcdir}/zpg.png" \
		"${pkgdir}/usr/share/icons/${pkgname}-icon.png"
  # Install license
  install -Dm 644 "${pkgdir}"/opt/${pkgname}/license.txt "${pkgdir}"/usr/share/licenses/${pkgname}/license
}

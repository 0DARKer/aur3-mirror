--- scanfile.c	2010-02-17 03:22:35.000000000 +0100
+++ scanfile.c.new	2012-02-06 13:28:53.472797629 +0100
@@ -52,6 +52,8 @@
 
 #define	STATUS_SAVE_CANCELED	( -1 )
 
+#define Z_BEST_SPEED 1
+
 static CNMSInt32 Change_RAW_to_PNG( CNMSInt32 width, CNMSInt32 height, CNMSInt32 bpp, CNMSInt32 outRes, LPCNMS_ROOT root, CNMSFd dstFd );
 static CNMSInt32 Change_RAW_to_PNM( CNMSInt32 width, CNMSInt32 height, CNMSInt32 bpp, LPCNMS_ROOT root, CNMSFd dstFd );
 static CNMSInt32 Change_RAW_to_PDF( CNMSInt32 width, CNMSInt32 height, CNMSInt32 bpp, CNMSInt32 outRes, LPCNMS_ROOT root, CNMSFd dstFd );
@@ -386,7 +388,8 @@
 
 void write_data_for_png( png_structp png_ptr, png_bytep data, png_size_t length )
 {
-	FileControlWriteFile( *( (int *)png_ptr->io_ptr ), (CNMSLPSTR)data, length );
+	//FileControlWriteFile( *( (int *)png_ptr->io_ptr ), (CNMSLPSTR)data, length );
++	FileControlWriteFile( *( (int *)png_get_io_ptr(png_ptr) ), (CNMSLPSTR)data, length );
 
 	return;
 }

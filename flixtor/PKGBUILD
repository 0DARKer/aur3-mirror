# Maintainer: M0Rf30

pkgname=flixtor
pkgver=2.2.3
pkgrel=1
if [[ "$CARCH" == 'x86_64' ]] ; then
   _platform="linux-x64"
else
   _platform="linux-ia32"
fi
pkgdesc="Flixtor streams movies, series, videos and animes from Torrents."
arch=('x86_64' 'i686')
url="http://www.flixtor.me/"
license=('GPL3')
makedepends=('nodejs' 'nodejs-grunt-cli' 'ruby-compass')
options=('!strip')
install="flixtor.install"
_gitname="FlixtorMe"
source=("https://github.com/FlixtorMe/FlixtorMe/archive/v${pkgver}.tar.gz"
        "https://raw.githubusercontent.com/FlixtorMe/FlixtorMe/v${pkgver}/images/flixtor-ico.png"
        "http://dl.nwjs.io/v0.9.2/node-webkit-v0.9.2-${_platform}.tar.gz"
        "flixtor.install"
        "flixtor.desktop")
_DEST="/usr/share/flixtor"
provides=("flixtor")

build() {
  cd "${srcdir}/${_gitname}-${pkgver}"
  # Get dependencies
  msg2 "Getting dependencies"
  npm install 

  # Build
  msg2 "Prepare for ${_platform}"
  msg2 "Building"
  mkdir src
  cp -r fonts frames images js locales node_modules styles package.json src/
  cd "${srcdir}/node-webkit-v0.9.2-${_platform}/" 
  cp * "${srcdir}/${_gitname}-${pkgver}/src/"  
  

  # Thanks to Revelation60 for pointing it out
  # https://github.com/rogerwang/node-webkit/wiki/The-solution-of-lacking-libudev.so.0
  msg2 "Patching program to fix libudev.so.0 problem"
  cd "${srcdir}/${_gitname}-${pkgver}/src/"
  mv nw Flixtor
  sed -i 's/\x75\x64\x65\x76\x2E\x73\x6F\x2E\x30/\x75\x64\x65\x76\x2E\x73\x6F\x2E\x31/g' Flixtor
}

package() {
  test ${arch} == "i686" && _platform="linux32" || _platform="linux64"
  msg2 "Prepare for ${_platform}"

  # Program
  mkdir -p "${pkgdir}/usr/share/data"
  cp -r "${srcdir}/${_gitname}-${pkgver}/src/" "${pkgdir}${_DEST}"


  # Link to program
  msg2 "Symlink /usr/bin/${provides[0]} -> ${_DEST}/"
  install -dm755 "${pkgdir}/usr/bin"
  ln -s "${_DEST}/Flixtor" "${pkgdir}/usr/bin/${provides[0]}"
  

  # Desktop file
  install -Dm644 "${srcdir}/flixtor.desktop" "${pkgdir}/usr/share/applications/flixtor.desktop"

  # Icon
  install -Dm644 "${srcdir}/flixtor-ico.png" "${pkgdir}/usr/share/pixmaps/flixtor.png"
}

if [[ "$CARCH" == 'i686' ]] ; then
md5sums=('1dbd75385663c638f112beabdca72dd7'
         '3b2c42be51b39aff65dc2c67bb94dc27'
         '98ea333ddeeb3dd703bdb063f98b1da7'
         '4aaa38bac8fbe04fe517a1cf93ca3da4'
         '2716817a9ce83bb89c75aa82d7f4dcf8')
elif [[ "$CARCH" == 'x86_64' ]] ; then
md5sums=('1dbd75385663c638f112beabdca72dd7'
         '3b2c42be51b39aff65dc2c67bb94dc27'
         'fc50b16fce425c1041a26b1b6a8727ce'
         '4aaa38bac8fbe04fe517a1cf93ca3da4'
         '2716817a9ce83bb89c75aa82d7f4dcf8')
fi


# Contributor: Luiz Paulo M. Pires <luizpaulo@myrealbox.com>

pkgname=freeswitch
pkgver=1.0.6
pkgrel=1
pkgdesc="An open source telephony platform"
arch=('i686' 'x86_64')
url="http://www.freeswitch.org"
license=('MPL')
makedepends=('python')
depends=('glibc' 'wget' 'ncurses' 'curl' 'dahdi' 'unixodbc' 'perl')
optdepends=('psqlodbc' 'myodbc' 'python')
install=$pkgname.install
source=(http://files.freeswitch.org/$pkgname-$pkgver.tar.gz freeswitch)
md5sums=('388effee587887a81fe7f411b7350590' '35d7a0873f28ff0ee3f5647381dad192')

build() {
  cd $srcdir/$pkgname-$pkgver
  mv scripts/contrib/dschreiber/mod_nibblebill src/mod/applications/ #the billing module isn't in the default tree (yet)
  echo '../../libs/openzap/mod_openzap' >> modules.conf #compiles the openzap module
  echo 'applications/mod_nibblebill' >> modules.conf #compiles the billing module
  echo 'applications/mod_fax' >> modules.conf #compiles the fax module
  echo 'languages/mod_perl' >> modules.conf #compiles the perl module
  echo 'languages/mod_python' >> modules.conf #compiles the python module
  echo 'languages/mod_spidermonkey_odbc' >> modules.conf #compiles the javascript odbc module
  echo 'xml_int/mod_xml_curl' >> modules.conf #compiles the xml curl module (allows freeswitch to get it's xml config files from a http server)
  ./configure --enable-core-odbc-support --prefix=/usr/freeswitch #compiles with odbc support
  make || return 1
  make DESTDIR=$pkgdir install
  make DESTDIR=$pkgdir cd-sounds-install
  make DESTDIR=$pkgdir cd-moh-install
  make DESTDIR=$pkgdir uhd-sounds-install
  make DESTDIR=$pkgdir uhd-moh-install
  make DESTDIR=$pkgdir hd-sounds-install
  make DESTDIR=$pkgdir hd-moh-install
  make DESTDIR=$pkgdir sounds-install
  make DESTDIR=$pkgdir moh-install
  install -D -m644 src/mod/applications/mod_nibblebill/nibblebill.conf.xml $pkgdir/usr/freeswitch/conf/autoload_configs/nibblebill.conf.xml
  install -D -m755 $startdir/src/freeswitch $pkgdir/etc/rc.d/freeswitch
  mv $pkgdir/usr/freeswitch/conf $pkgdir/usr/freeswitch/conf.sample
}

# Mantainer: M0Rf39
# Contributor: Charles Lindsay <charles@chaoslizard.org>

pkgname=vhba-module-all
pkgver=20110416
pkgrel=1
pkgdesc="Kernel module that emulates SCSI devices (builded for all kernels)"
arch=('i686' 'x86_64')
url="http://cdemu.sourceforge.net/"
license=('GPL2')
depends=('linux')
makedepends=('kernel26-headers' 'git')
provides=('vhba-module')
conflicts=('vhba-module')
install=vhba-module.install
source=(http://downloads.sourceforge.net/cdemu/vhba-module-$pkgver.tar.gz
		vhba-kernel2.6.37.patch)
md5sums=('1d2f06ae33c5d15b7c29e467e4658aa2'
	 'f0499fc54f6ef9b8d6ca0b9e940c5906')


### Enable using of version numbers from pacman. This should only be used if you have kernels with
### long version numbers (for example if compiled with git-suffixes). This will not work with kernels
### compiled outside pacman's management, and takes much longer than the canonical method, due to 
### needing to search the local repository. Set to '1' to enable.
USE_PACMAN_VERSION=0

build() {
  cd "$srcdir/vhba-module-$pkgver"
  if [ "$USE_PACMAN_VERSION" = "0" ]; then
    _KERNELS=`file /boot/* | grep 'Linux kernel.*boot executable' | sed 's/.*version \([^ ]\+\).*/\1/'`
  else
    _PACKAGES=`pacman -Qsq linux`
    _KERNELS=`pacman -Ql $PACKAGES | grep /modules.alias.bin | sed 's/linux.*\/lib\/modules\/\(.*\)\/modules.alias.bin/\1/g'`
  fi

  # Loop through all detected kernels
  for _kernver in $_KERNELS;
  do  
    cd ${srcdir}/vhba-module-${pkgver}
    echo Building module for $_kernver
    make -j1 KDIR=/usr/src/linux-${_kernver} || return 1
    install -D vhba.ko "$pkgdir/lib/modules/${_kernver}/extra/vhba.ko" || return 1
    sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" "$startdir/vhba-module.install"
  done


#  git apply -p2 ../vhba-kernel2.6.37.patch
  make -j1 KDIR=/usr/src/linux-${_kernver} || return 1
  install -D vhba.ko "$pkgdir/lib/modules/${_kernver}/extra/vhba.ko" || return 1
  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" "$startdir/vhba-module.install"
}
md5sums=('2f91dd4ee8648da92d625221d4275b60'
         'f0499fc54f6ef9b8d6ca0b9e940c5906')

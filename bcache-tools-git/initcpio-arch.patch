From a072ea249b72dddef4c1f1eefac61c654134a723 Mon Sep 17 00:00:00 2001
From: bobpaul <bobpaul on archlinux forums>
Date: Sun, 10 Mar 2013 10:56:47 -0500
Subject: [PATCH 1/2] Removed upstream initramfs hook

---
 initramfs/hook   | 20 --------------------
 initramfs/script | 32 --------------------------------
 2 files changed, 52 deletions(-)
 delete mode 100755 initramfs/hook
 delete mode 100755 initramfs/script

diff --git a/initramfs/hook b/initramfs/hook
deleted file mode 100755
index 3c429d0..0000000
--- a/initramfs/hook
+++ /dev/null
@@ -1,20 +0,0 @@
-#!/bin/sh
-
-PREREQ="udev"
-
-prereqs()
-{
-	echo "$PREREQ"
-}
-
-case $1 in
-prereqs)
-	prereqs
-	exit 0
-	;;
-esac
-
-. /usr/share/initramfs-tools/hook-functions
-
-copy_exec /bin/mknod
-manual_add_modules bcache
diff --git a/initramfs/script b/initramfs/script
deleted file mode 100755
index 926d5d3..0000000
--- a/initramfs/script
+++ /dev/null
@@ -1,32 +0,0 @@
-#!/bin/sh
-
-mountroot_fail()
-{
-	for i in `ls /dev/sd*`; do
-		echo	$i > /sys/fs/bcache/register_quiet
-	done
-
-#	for i in `ls /sys/dev/block/`; do
-#		DEV=/bcache_dev
-#
-#		mknod	$DEV b `echo $i|sed -e 's/:/ /'`
-#		echo	$DEV > /sys/fs/bcache/register_quiet
-#		rm	$DEV
-#	done
-}
-
-case $1 in
-prereqs)
-	exit 0
-	;;
-mountfail)
-	mountroot_fail
-	exit 0
-	;;
-esac
-
-. /scripts/functions
-
-add_mountroot_fail_hook "30-bcache"
-
-exit 0
-- 
1.8.1.5


From fd227218cefbc916ac7fe73d7ecb8de8df051dbb Mon Sep 17 00:00:00 2001
From: bobpaul <bobpaul on archlinux forums>
Date: Sun, 10 Mar 2013 11:00:52 -0500
Subject: [PATCH 2/2] Added archlinux bcache hook and updated Makefile

---
 Makefile               |  4 ++--
 initramfs/hook         |  9 +++++++++
 initramfs/hook-install | 14 ++++++++++++++
 3 files changed, 25 insertions(+), 2 deletions(-)
 create mode 100644 initramfs/hook
 create mode 100755 initramfs/hook-install

diff --git a/Makefile b/Makefile
index d15525b..b30bde8 100644
--- a/Makefile
+++ b/Makefile
@@ -8,8 +8,8 @@ install: make-bcache probe-bcache
 	install -m0755 make-bcache	$(DESTDIR)${PREFIX}/sbin/
 	install -m0755 probe-bcache	$(DESTDIR)/sbin/
 	install -m0644 61-bcache.rules	$(DESTDIR)/lib/udev/rules.d/
-	-install -m0755 initramfs/script $(DESTDIR)/etc/initramfs-tools/scripts/init-premount/bcache
-	-install -m0755 initramfs/hook	$(DESTDIR)/etc/initramfs-tools/hooks/bcache
+	-install -m0755 initramfs/hook-install $(DESTDIR)/usr/lib/initcpio/install/bcache
+	-install -m0755 initramfs/hook	$(DESTDIR)/usr/lib/initcpio/hooks/bcache
 	install -m0644 *.8 $(DESTDIR)${PREFIX}/share/man/man8
 #	install -m0755 bcache-test $(DESTDIR)${PREFIX}/sbin/
 
diff --git a/initramfs/hook b/initramfs/hook
new file mode 100644
index 0000000..2d65aa7
--- /dev/null
+++ b/initramfs/hook
@@ -0,0 +1,9 @@
+#!/usr/bin/ash
+
+
+run_hook() {
+  for i in /dev/sd*; do
+    echo "Attempting to register $i with bcache"
+    echo $i > /sys/fs/bcache/register
+  done
+}
diff --git a/initramfs/hook-install b/initramfs/hook-install
new file mode 100755
index 0000000..b7fb742
--- /dev/null
+++ b/initramfs/hook-install
@@ -0,0 +1,14 @@
+#!/bin/bash
+
+build() {
+    add_runscript
+}
+
+help() {
+    cat <<HELPEOF
+This hook supports early, automatic registration of bcache devices. This is necessary
+if your root filesystem is on a /dev/bcacheX device
+HELPEOF
+}
+
+# vim: set ft=sh ts=4 sw=4 et:
-- 
1.8.1.5


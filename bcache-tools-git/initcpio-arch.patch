From 229a83d4375680a25bc67c8380e98879582bd031 Mon Sep 17 00:00:00 2001
From: bobpaul <bobpaul on archlinux forums>
Date: Sun, 10 Mar 2013 10:56:47 -0500
Subject: [PATCH 1/2] Removed upstream initramfs hook

---
 initramfs/hook | 22 ----------------------
 1 file changed, 22 deletions(-)
 delete mode 100755 initramfs/hook

diff --git a/initramfs/hook b/initramfs/hook
deleted file mode 100755
index ce328f3..0000000
--- a/initramfs/hook
+++ /dev/null
@@ -1,22 +0,0 @@
-#!/bin/sh
-
-PREREQ="udev"
-
-prereqs()
-{
-	echo "$PREREQ"
-}
-
-case $1 in
-prereqs)
-	prereqs
-	exit 0
-	;;
-esac
-
-. /usr/share/initramfs-tools/hook-functions
-
-cp -pt "${DESTDIR}/lib/udev/rules.d" /lib/udev/rules.d/61-bcache.rules
-copy_exec /lib/udev/bcache-register
-copy_exec /sbin/probe-bcache
-manual_add_modules bcache
-- 
1.8.2.1


From 09478167806d92fe577d4055d8273d427cbfd226 Mon Sep 17 00:00:00 2001
From: bobpaul <bobpaul on archlinux forums>
Date: Sun, 10 Mar 2013 11:00:52 -0500
Subject: [PATCH 2/2] Added archlinux bcache hook and updated Makefile

---
 Makefile               |  3 ++-
 initramfs/hook         |  9 +++++++++
 initramfs/hook-install | 14 ++++++++++++++
 3 files changed, 25 insertions(+), 1 deletion(-)
 create mode 100644 initramfs/hook
 create mode 100755 initramfs/hook-install

diff --git a/Makefile b/Makefile
index 10ec79c..cd50eaa 100644
--- a/Makefile
+++ b/Makefile
@@ -9,7 +9,8 @@ install: make-bcache probe-bcache bcache-super-show
 	install -m0755 probe-bcache	$(DESTDIR)/sbin/
 	install -m0644 61-bcache.rules	$(DESTDIR)/lib/udev/rules.d/
 	install -m0755 bcache-register	$(DESTDIR)/lib/udev/
-	-install -m0755 initramfs/hook	$(DESTDIR)/etc/initramfs-tools/hooks/bcache
+	-install -m0755 initramfs/hook-install $(DESTDIR)/usr/lib/initcpio/install/bcache
+	-install -m0755 initramfs/hook	$(DESTDIR)/usr/lib/initcpio/hooks/bcache
 	install -m0644 -- *.8 $(DESTDIR)${PREFIX}/share/man/man8
 #	install -m0755 bcache-test $(DESTDIR)${PREFIX}/sbin/
 
diff --git a/initramfs/hook b/initramfs/hook
new file mode 100644
index 0000000..2d65aa7
--- /dev/null
+++ b/initramfs/hook
@@ -0,0 +1,9 @@
+#!/usr/bin/ash
+
+
+run_hook() {
+  for i in /dev/sd*; do
+    echo "Attempting to register $i with bcache"
+    echo $i > /sys/fs/bcache/register
+  done
+}
diff --git a/initramfs/hook-install b/initramfs/hook-install
new file mode 100755
index 0000000..b7fb742
--- /dev/null
+++ b/initramfs/hook-install
@@ -0,0 +1,14 @@
+#!/bin/bash
+
+build() {
+    add_runscript
+}
+
+help() {
+    cat <<HELPEOF
+This hook supports early, automatic registration of bcache devices. This is necessary
+if your root filesystem is on a /dev/bcacheX device
+HELPEOF
+}
+
+# vim: set ft=sh ts=4 sw=4 et:
-- 
1.8.2.1


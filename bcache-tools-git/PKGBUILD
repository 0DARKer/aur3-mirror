# Maintainer: bobpaul (bobpaul on archlinux forumsBoohbah <boohbah at gmail.com>)

pkgname=bcache-tools-git
pkgver=20130419
pkgrel=1
pkgdesc="Userspace tools for bcache until bcache merges with either dm or md"
changelog=bcache-tools.changelog
arch=('i686' 'x86_64')
url="http://bcache.evilpiepirate.org/"
license=('GPL')
makedepends=('git')
conflicts=()
source=('initcpio-arch.patch')
md5sums=('36fcc24e6763c3e1078f61f78c69e009')
sha256sums=('fb9d2a6d0d139f0799908cdce62135830f3a33baf8f05a10c780a20a45088139')
_gitroot="http://evilpiepirate.org/git/bcache-tools.git"
_gitname=bcache-tools

# set _gitrev to a git revision (man gitrevisions) like a tag, a commit sha1
# hash or a branch name to build from this tree instead of master

# _gitrev=""
#_gitrev="94755cc7572"   #Known Good rev (patches were built against this rev)

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
	# [optionally] reset to specified git revision
  [[ -n $_gitrev ]] && git reset --hard "$_gitrev"

  patch -Np1 -i "${srcdir}/../initcpio-arch.patch"
  make
}

package() {
  cd "$srcdir/$_gitname-build"
  #TODO: do I really need to mkdir? or am I missing something?
  mkdir ${pkgdir}/sbin
  mkdir -p ${pkgdir}/usr/sbin
  mkdir -p ${pkgdir}/lib/udev/rules.d
  mkdir -p ${pkgdir}/usr/share/man/man8
  mkdir -p ${pkgdir}/usr/lib/initcpio/{hooks,install}

  make DESTDIR="${pkgdir}" install
}

# vim:set ts=2 sw=2 et:

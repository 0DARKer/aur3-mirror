# Contributor: Jaroslav Lichtblau <dragonlord@aur.archlinux.org>
# Contributor: Aaron Fellin <adfellin@cs.pdx.edu>

pkgname=mangband
pkgver=751
pkgrel=1
pkgdesc="A Multiplayer version of Angband."
arch=('i686')
url="http://www.mangband.org"
license=('custom')
depends=('ncurses' 'sdl')
makedepends=('subversion')
install=$pkgname.install

source=(license.txt)
md5sums=('2243476658f7b23255b77f20f26ad36b')

_svntrunk=http://mangband.org/svn/mangband/branches/version-1_1_0
_svnmod=src
_svnlib=lib

build() {
  cd "${srcdir}"

  for trunk in $_svnmod $_svnlib ; do
    msg2 "$trunk"
    if [ -d $trunk/.svn ]; then
      (cd $trunk && svn up -r $pkgver)   #>/dev/null
    else
      svn co $_svntrunk/$trunk --config-dir ./ -r $pkgver $trunk   #>/dev/null
    fi
  done

  msg "SVN checkout done or server timeout"
  msg "Starting make..."

  install -d "${pkgdir}/usr/bin" "${pkgdir}/usr/lib"

  cp -r "$srcdir/$_svnmod" "$srcdir/$_svnmod-build"
  cd "${srcdir}/$_svnmod-build"

#configuring package
  CFLAGS="$CFLAGS -DUSG"
  export CFLAGS
  ./configure --prefix=/usr --libdir=/usr/lib/mangband

  cp "config.h" "config.h.bak" || return 1
  sed -e 's@# define DEFAULT_PATH "./lib/"@# define DEFAULT_PATH "/usr/lib/mangband/"@' config.h.bak > config.h || return 1

  make || return 1
  make PREFIX="${pkgdir}/usr/bin" install

#copy data files
  cp -r "${srcdir}/$_svnlib" "${pkgdir}/usr/lib" || return 1
  mv "${pkgdir}/usr/lib/lib" "${pkgdir}/usr/lib/$pkgname" || return 1
  find "${pkgdir}/usr/lib/$pkgname" -type d -exec chmod 775 "{}" \; || return 1
  chown -R root:users "${pkgdir}/usr/lib/$pkgname" || return 1

#license file
  install -D -m644 "${srcdir}/license.txt" "${pkgdir}/usr/share/licenses/$pkgname/LICENSE" || return 1

#remove unneeded files
  find "${pkgdir}" -iname delete.me -delete || return 1
  rm -rf `find "${pkgdir}" -type d -name .svn` || return 1

#remove build directory
  rm -r "${srcdir}/$_svnmod-build"
}

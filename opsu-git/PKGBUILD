# Maintainer: Lucki <Lucki at holarse-linuxgaming dot de>

pkgname=opsu-git
pkgver=0.5.0.r31.g5480630
pkgrel=1
pkgdesc="An open source osu!-client written in Java."
arch=('any')
url="https://osu-game.com/"
license=('GPL3')
depends=('java-runtime' 'bash')
makedepends=('java-environment' 'java-web-start' 'maven' 'gendesk')
provides=('opsu-git')
conflicts=('opsu-git')
source=( ${pkgname}::git://github.com/itdelatrisu/opsu.git
         pom.patch
         opsu-git.sh )
sha512sums=('SKIP'
            '87d56412e513fabadf525e83deb575a4d966b6892563f9b5c2a5b0622e5bd7a3fdb5871195f8d7b152aa0bba1300b52012069bd43b6bec881101042a49822d0e'
            '4c8b89b4f273a076620c98058623a0e8c0ab875f191cb65f126e9a0134e0b072ed27ac8a03928225db1b5b9e832935b4efca0db1d7a02b0c8b96ec87748398f3')

prepare(){
  gendesk -n -f --pkgname ${pkgname} --pkgdesc "$pkgdesc" --name "opsu!-git" --exec "${pkgname}" --categories "Game"
}

pkgver() {
  cd ${srcdir}/${pkgname}
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

build() {
  cd ${srcdir}/${pkgname}

  if [ ! -f /usr/bin/javaws ]; then
    msg "OpenJDK not found, trying OracleJDK"

    # cut part for OpenJDK
    sed -e '4q' ${srcdir}/pom.patch > ${srcdir}/pom.patch
  else
    msg "OpenJDK found, using systempath"
  fi

  # patch pom.xml
  patch pom.xml ${srcdir}/pom.patch

  mvn install -Djar
}

package() {
  # cut pkgver
  _pkgver=${pkgver%.*}
  _pkgver=${_pkgver%.*}
  _pkgname=opsu

  install -Dm644 ${srcdir}/${pkgname}/target/${_pkgname}-${_pkgver}-runnable.jar ${pkgdir}/usr/share/java/${pkgname}/${pkgname}.jar
  install -Dm644 ${srcdir}/${pkgname}/res/logo.png ${pkgdir}/usr/share/pixmaps/${pkgname}.png
  install -Dm644 ${pkgname}.desktop ${pkgdir}/usr/share/applications/${pkgname}.desktop
  install -Dm755 ${pkgname}.sh ${pkgdir}/usr/bin/${pkgname}
}

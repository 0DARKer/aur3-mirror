# Contributor: grimi <grimi at poczta dot fm>

pkgname=omnibook-git
pkgver=20110911
pkgrel=9
pkgdesc="Kernel module for HP OmniBook,Pavilion,Toshiba and Compal ACL00 laptops"
arch=('i686' 'x86_64')
url="http://omnibook.sourceforge.net"
license=('GPL')
depends=('linux')
makedepends=('git' 'linux-headers')
conflicts=('omnibook')
provides=('omnibook')
source=("$pkgname::git://omnibook.git.sourceforge.net/gitroot/omnibook/omnibook"
        "use-new-procfs-api.patch" "fix-build-on-3.14.patch" "support-ich9-lpc.patch"
        "unlock-mutex-in-fail-path.patch")
md5sums=('SKIP'
         '945b1abaa1989f21bfae751cb7d3bc76'
         '6e374a11f6754b31ec1ee7ec4758692b'
         '713202670be72c009004e68afad13f14'
         '42be2e88e4a1f1c4e23d5210e068e88f')
install=$pkgname.install



pkgver() {
   cd "$srcdir/$pkgname"
   git log -1 --format="%cd" --date="short"|sed 's|-||g'
}

prepare() {
  cd "$srcdir/$pkgname"
  patch -Np1 -i "$srcdir"/use-new-procfs-api.patch
  patch -Np1 -i "$srcdir"/fix-build-on-3.14.patch
  patch -Np1 -i "$srcdir"/support-ich9-lpc.patch
  patch -Np1 -i "$srcdir"/unlock-mutex-in-fail-path.patch
}

build() {
  cd "$srcdir/$pkgname"
  make
  gzip omnibook.ko
}

package() {
  cd "$srcdir/$pkgname"
  install -Dm644 omnibook.ko.gz \
     "$pkgdir"/usr/lib/modules/extramodules-$(uname -r|sed 's/\(.*\)\..*-.*-/\1-/')/omnibook.ko.gz
}



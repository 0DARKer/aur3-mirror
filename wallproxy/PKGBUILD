# Maintainer: Toshio Xiang <snachx at gmail dot com>
# Contributor: 謝致邦 <Yeking@Red54.com>

pkgname=wallproxy
pkgver=2.1.19
pkgrel=2
pkgdesc="A http and socks proxy based on Google App Engine."
arch=("any")
url="https://code.google.com/p/wallproxy"
license=("MPL")
depends=('python2' 'python2-pyopenssl')
makedepends=('git')
optdepends=('python2-gevent>=1.0: for better performance')
conflicts=('python2-gevent<1.0')
backup=('etc/wallproxy')
install=$pkgname.install
source=("git+https://github.com/wallproxy/wallproxy.git#tag=v$pkgver"
        $pkgname.service)
md5sums=('SKIP'
         '6585482b4a969054224b2532b5fa6a10')

package() {
  cd $srcdir/$pkgname
  
  install -Dm644 local/proxy.ini $pkgdir/etc/wallproxy
  install -Dm755 local/startup.py $pkgdir/usr/share/$pkgname/local/startup.py
  install -Dm644 local/pac $pkgdir/usr/share/$pkgname/local/pac
  ln -sf /etc/wallproxy $pkgdir/usr/share/$pkgname/local/proxy.ini
  cp -r local/cert $pkgdir/usr/share/$pkgname/local
  cp -r local/misc $pkgdir/usr/share/$pkgname/local
  cp -r local/src.zip $pkgdir/usr/share/$pkgname/local
  
  cp -r server $pkgdir/usr/share/$pkgname
  chmod +x $pkgdir/usr/share/$pkgname/server/uploader.py
  rm $pkgdir/usr/share/$pkgname/server/uploader.bat

  install -Dm644 $srcdir/wallproxy.service $pkgdir/usr/lib/systemd/system/wallproxy.service
}

# Contributor: Anton Bazhenov <anton.bazhenov at gmail>
# Contributor: LTSmash <lord.ltsmash@gmail.com>
# Maintainer: Zauber Exonar <zauberexonar at gmail>

pkgname=opensimulator
pkgver=0.6.8
pkgrel=3
pkgdesc="A 3D application server used to create a virtual environment or world"
arch=('i686' 'x86_64')
url="http://opensimulator.org/wiki/Main_Page"
license=('BSD')
depends=('mono' 'sqlite3' 'mysql')
optdepends=('mono-old')
makedepends=('nant')
install=$pkgname.install
source=(http://dist.opensimulator.org/${pkgname/ulator/}-$pkgver-release.tar.gz \
  $pkgname.sh OpenSim.ini.example.$pkgver)
md5sums=('9eaf42d2ba029cd93c63b47af56b6bd6'
         '58270c537e91b85c1121aacc2ccb194e'
         '5c592ed63c763c848a61aa37cce31d7e')

build() {
  cd "$srcdir"/${pkgname/ulator/}-$pkgver-release
  # we need Mono
  export MONO_SHARED_DIR="$srcdir"/.wabi
  mkdir -p $MONO_SHARED_DIR
  # nant
  ./runprebuild.sh || return 1
  nant || return 1
  # delete unneeded and create log/ini files
  [[ `uname -m` = "i686" ]] && find bin -name "*x86_64.so" -delete
  touch bin/OpenSim.log
  cp $startdir/OpenSim.ini.example.$pkgver bin/OpenSim.ini || return 1
  #cp bin/OpenSim.ini{.example,}
  #copying Mono.Posix.dll so that OpenSimulator can use sockets, and by extension MySQL
  cp /usr/lib/mono/1.0/Mono.Posix.dll bin/Mono.Posix.dll || return 1
  # install
  install -d "$pkgdir"/opt/$pkgname/bin
  cp -r bin/* "$pkgdir"/opt/$pkgname/bin/
  install -Dm644 {CONTRIBUTORS,README}.txt "$pkgdir"/opt/$pkgname
  # set permissions
  find "$pkgdir"/opt/$pkgname/bin -type d -exec chmod 755 {} +
  find "$pkgdir"/opt/$pkgname/bin -type f -exec chmod 644 {} +
  find "$pkgdir"/opt/$pkgname/bin -name "*.exe" -exec chmod 755 {} +
  find "$pkgdir"/opt/$pkgname/bin -name "*.ini" -exec chmod 666 {} +
  find "$pkgdir"/opt/$pkgname/bin -name "*.xml" -exec chmod 666 {} +
  chmod 777 "$pkgdir"/opt/$pkgname/bin/{,*/}
  chmod 755 "$pkgdir"/opt/$pkgname/bin/opensim-ode.sh
  chmod 666 "$pkgdir"/opt/$pkgname/bin/OpenSim.log
  # install script and license files
  install -m755 -D ../$pkgname.sh "$pkgdir"/usr/bin/$pkgname
  install -m644 -D LICENSE.txt "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

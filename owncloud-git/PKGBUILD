# Contributor: Alexander Ovsyannikov <ovsinc at ya.ru>
pkgname=owncloud-git
pkgver=20121029
pkgrel=1
pkgdesc="ownCloud is part of the Social Desktop, a project connecting you with your peers in the community"
arch=('i686' 'x86_64')
url="http://owncloud.org/index.php/Main_Page"
license=('GPL')
depends=('php-apache' 'mysql' 'php-gd')
optdepends=('phpmyadmin: A PHP and hence web-based tool to administrate MySQL over the WWW'
	    'php-curl: for using curl module for PHP')
install=owncloud.install
makedepends=()
provides=()
source=(owncloud.conf)
backup=('etc/httpd/conf/extra/owncloud.conf')
_gitroot="https://github.com/owncloud/core"
_git3rd="https://github.com/owncloud/3rdparty"
_apps="https://github.com/owncloud/apps"
_gitname="owncloud"
options=('!strip')

build() {
cd "$srcdir"
msg "Connecting to GIT server...."
if [ -d $_gitname ] ; then
    rm -rf $_gitname
fi
git clone --depth=1 $_gitroot $_gitname
git clone --depth=1 $_git3rd $_gitname/3rdparty
git clone --depth=1 $_apps $_gitname/apps1
mv -f $_gitname/apps1/* $_gitname/apps
rm -rf $_gitname/apps1

msg "GIT checkout done or server timeout"

msg "Building and installing..." 
 
# install README file 
  install -d ${pkgdir}/usr/share/doc/$pkgname
  mv ${srcdir}/${_gitname}/README  ${pkgdir}/usr/share/doc/$pkgname

  # clean tests
  rm -rf ${srcdir}/${_gitname}/tests
  rm -f ${srcdir}/${_gitname}/autotest.sh
  # rm .git
  rm -rf $srcdir/${_gitname}/.git
  rm -rf $srcdir/${_gitname}/*/.git
  find $srcdir/${_gitname} -type f -name .gitignore -exec rm -f '{}' \;

 
# install project  
  install -d  ${pkgdir}/usr/share/webapps/ || return 1
  cp -a ${srcdir}/${_gitname}  ${pkgdir}/usr/share/webapps/ || return 1
  # 33 - is GID 'http' group and UID 'http' user 
  chown -R 33:33 ${pkgdir}/usr/share/webapps/owncloud || return 1 
 
# install apache .conf file 
  install -d ${pkgdir}/etc/httpd/conf/extra || return 1
  install -m 644 ${srcdir}/owncloud.conf  ${pkgdir}/etc/httpd/conf/extra/ || return 1

}
md5sums=('c0112de94a7d9bdb7b5d1705a344db81')

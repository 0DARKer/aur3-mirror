Description: Some magic for determining which WM to use.
Author: ?

Index: gnome-session-2.30.0/data/gnome-wm
===================================================================
--- gnome-session-2.30.0.orig/data/gnome-wm	2010-06-04 14:02:14.564234318 +1000
+++ gnome-session-2.30.0/data/gnome-wm	2010-06-04 14:02:23.934232671 +1000
@@ -1,7 +1,8 @@
 #!/bin/sh
 
 # The user can specify his prefered WM by setting the WINDOW_MANAGER
-# environment variable.
+# environment variable or setting the
+# /desktop/gnome/applications/window_manager/default gconf key.
 #
 # If this is not set, we search a list of known windowmanagers and use
 # the first one that is found in the users's PATH
@@ -53,30 +54,71 @@
   fi
 fi
 
+# Get previously set window manager in gconf
+if [ ! "$DEFWM" ]; then
+  DEFWM=`gconftool-2 -g /desktop/gnome/applications/window_manager/default 2>/dev/null`
+fi
+
+# special case handling for dapper upgrades (this runs only once after the upgrade)
+if [ -z "$DEFWM" ] && [ -f /var/lib/gnome-session/dapper-upgrade ]; then
+    gconftool-2 -s /desktop/gnome/applications/window_manager/default /usr/bin/metacity --type string
+    DEFWM=/usr/bin/metacity
+fi
+
+# If not exist, set to compiz (if available) 
+if [ ! -x "$DEFWM" ]; then
+    if [ -x "/usr/bin/compiz" ]; then
+	gconftool-2 -s /desktop/gnome/applications/window_manager/default /usr/bin/compiz --type string
+	DEFWM=/usr/bin/compiz
+    elif [ -x "/usr/bin/metacity" ]; then
+	gconftool-2 -s /desktop/gnome/applications/window_manager/default /usr/bin/metacity --type string
+	DEFWM=/usr/bin/metacity
+    else
+	unset DEFWM
+    fi
+fi
+
+# WINDOW_MANAGER overrides all
+if [ -z "$WINDOW_MANAGER" ] ; then
+    WINDOW_MANAGER=`gconftool-2 --get /desktop/gnome/session/required_components/windowmanager 2> /dev/null`
+fi
+
 # Avoid looping if the session configuration tells us to use gnome-wm or if
 # the user forces gnome-wm via WINDOW_MANAGER
 if [ "x$WINDOW_MANAGER" = "xgnome-wm" ]; then
   WINDOW_MANAGER=""
 fi
 
-# If compiz-gtk is installed, we always use it; it will fall back to 
-# metacity if it cannot find decent hardware.
-
-if [ -z "$WINDOW_MANAGER" ] && [ -x /usr/bin/gtk-window-decorator ] ; then
-  WINDOW_MANAGER=compiz
-fi
+if [ -z "$WINDOW_MANAGER" ] ; then
+  # Create a list of window manager we can handle, trying to only use the
+  # compositing ones when it makes sense
 
-# If compiz is not installed (which is the default), use metacity instead.
+  xdpyinfo 2> /dev/null | grep -q "^ *Composite$" 2> /dev/null
+  IS_X_COMPOSITED=$?
 
-if [ -z "$WINDOW_MANAGER" ]; then
-  KNOWN_WM="metacity sawfish mutter"
+  KNOWN_WM="sawfish sawmill enlightenment icewm wmaker fvwm2 qvwm fvwm twm kwm"
+  if [ $IS_X_COMPOSITED -eq 0 ] ; then
+    KNOWN_WM="compiz beryl $KNOWN_WM"
+  fi
+  # metacity is still the default wm in GNOME
+  KNOWN_WM="metacity $KNOWN_WM"
 
-  for wm in $KNOWN_WM; do
-    if [ -x /usr/bin/"$wm" ]; then
-      WINDOW_MANAGER=/usr/bin/"$wm"
-      break
-    fi
-  done
+  OLDIFS=$IFS
+  if [ -z "$DEFWM" -o "x$DEFWM" = "xgnome-wm" ]; then
+    for wm in $KNOWN_WM ; do
+      IFS=":"
+      for dir in $PATH ; do
+	if [ -x "$dir/$wm" ] ; then
+	  WINDOW_MANAGER="$dir/$wm"
+    	  break 2
+	fi
+      done
+      IFS=$OLDIFS
+    done
+  else
+    WINDOW_MANAGER=$DEFWM
+  fi
+  IFS=$OLDIFS
 fi
 
 # Look for the default window manager on the system
@@ -125,7 +167,7 @@
 
 case `basename $WINDOW_MANAGER` in
   compiz)
-    gtk-window-decorator &
+    #gtk-window-decorator &
     #OPT3=glib
     #OPT4=gconf
     ;;
@@ -134,6 +176,9 @@
     ;;
 esac
 
+# Store the selected WM with gconf
+gconftool-2 -t string -s /desktop/gnome/applications/window_manager/current "$WINDOW_MANAGER"
+
 exec "$WINDOW_MANAGER" $OPT1 $OPT2 $OPT3 $OPT4
 
 echo "ERROR: No window manager could run!"

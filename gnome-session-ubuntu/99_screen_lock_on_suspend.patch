Description: Use the same logic as gnome-power-manager for deciding the "screen lock on suspend" policy. This restores the Jaunty behaviour rather than just using the screensaver settings, which is surprising for users
Bug: https://bugzilla.gnome.org/show_bug.cgi?id=598118
Bug-Ubuntu: https://bugs.launchpad.net/ubuntu/karmic/+source/gnome-session/+bug/446191

Index: gnome-session-2.30.0/gnome-session/gsm-manager.c
===================================================================
--- gnome-session-2.30.0.orig/gnome-session/gsm-manager.c	2010-06-04 14:40:19.206732252 +1000
+++ gnome-session-2.30.0/gnome-session/gsm-manager.c	2010-06-04 14:40:23.474233424 +1000
@@ -87,6 +87,9 @@
 #define KEY_AUTOSAVE              KEY_GNOME_SESSION_DIR "/auto_save_session"
 
 #define KEY_SLEEP_LOCK            "/apps/gnome-screensaver/lock_enabled"
+#define KEY_SLEEP_LOCK_USE_SCREENSAVER "/apps/gnome-power-manager/lock/use_screensaver_settings"
+#define GPM_CONF_LOCK_ON_SUSPEND   "/apps/gnome-power-manager/lock/suspend"
+#define GPM_CONF_LOCK_ON_HIBERNATE "/apps/gnome-power-manager/lock/hibernate"
 
 #define IS_STRING_EMPTY(x) ((x)==NULL||(x)[0]=='\0')
 
@@ -981,18 +984,33 @@
 }
 
 static gboolean
-sleep_lock_is_enabled (GsmManager *manager)
+sleep_lock_is_enabled (GsmManager  *manager,
+                       const gchar *policy)
 {
-        GError   *error;
-        gboolean  enable_lock;
+        GError      *error;
+        gboolean     enable_lock;
+        gboolean     use_ss_setting;
+        const gchar *real_policy;
 
         error = NULL;
+        use_ss_setting = gconf_client_get_bool (manager->priv->gconf_client, 
+                                                KEY_SLEEP_LOCK_USE_SCREENSAVER, &error);
+        if (error) {
+                g_warning ("Error retrieving configuration key '%s': %s",
+                           KEY_SLEEP_LOCK_USE_SCREENSAVER, error->message);
+                g_error_free (error);
+
+                use_ss_setting = FALSE;
+        }
+
+        real_policy = (use_ss_setting ? KEY_SLEEP_LOCK : policy);
+
         enable_lock = gconf_client_get_bool (manager->priv->gconf_client,
-                                             KEY_SLEEP_LOCK, &error);
+                                             real_policy, &error);
 
         if (error) {
                 g_warning ("Error retrieving configuration key '%s': %s",
-                           KEY_SLEEP_LOCK, error->message);
+                           real_policy, error->message);
                 g_error_free (error);
 
                 /* If we fail to query gconf key, just enable locking */
@@ -1003,13 +1021,14 @@
 }
 
 static void
-manager_perhaps_lock (GsmManager *manager)
+manager_perhaps_lock (GsmManager  *manager,
+                      const gchar *policy)
 {
         GError   *error;
         gboolean  ret;
 
         /* only lock if gnome-screensaver is set to lock */
-        if (!sleep_lock_is_enabled (manager)) {
+        if (!sleep_lock_is_enabled (manager, policy)) {
                 return;
         }
 
@@ -1047,7 +1066,7 @@
         if (can_hibernate) {
 
                 /* lock the screen before we suspend */
-                manager_perhaps_lock (manager);
+                manager_perhaps_lock (manager, GPM_CONF_LOCK_ON_HIBERNATE);
 
                 error = NULL;
                 ret = dkp_client_hibernate (manager->priv->dkp_client, &error);
@@ -1078,7 +1097,7 @@
         if (can_suspend) {
 
                 /* lock the screen before we suspend */
-                manager_perhaps_lock (manager);
+                manager_perhaps_lock (manager, GPM_CONF_LOCK_ON_SUSPEND);
 
                 error = NULL;
                 ret = dkp_client_suspend (manager->priv->dkp_client, &error);

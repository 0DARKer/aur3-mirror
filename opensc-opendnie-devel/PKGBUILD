# Contributor: Gustavo Alvarez <sl1pkn07@gmail.com>

pkgname=opensc-opendnie-devel
pkgver=4854
pkgrel=1
pkgdesc="Access smart cards that support cryptographic operations. with Open DNIe driver (Spanish electronic ID card). Devel Version. ONLY use for TEST"
arch=('i686' 'x86_64')
url="http://www.opensc-project.org/opensc"
license=("custom")
options=('!libtool')
backup=(etc/opensc.conf)
depends=('zlib' 'openssl' 'pcsclite')
makedepends=('autoconf' 'automake' 'nasm' 'subversion' 'libassuan')
provides=('opensc')
conflicts=('opensc')
source=()
md5sums=()

_svntrunk=http://www.opensc-project.org/svn/opensc/trunk/
_svnmod=opensc
_svntrunk2=https://svn.forge.morfeo-project.org/opendnie/
_svnmod2=opendnie


build() {
  cd $startdir/src

  msg "Updating SVN entries for $_svnmod..."
  svn co $_svntrunk $_svnmod
  svn co $_svntrunk2 $_svnmod2
  msg "SVN checkout done or server timeout"
  msg "Patch $_svnmod with $_svnmod2 code"
  cp -r opendnie/dgp-devel/src/libopensc/dnie opensc/src/libopensc
  cd opensc
  patch -d . -p0 < ../opendnie/dgp-devel/opensc-0.12.x-dnie.patch
  cd ..
  cp -r $_svnmod $_svnmod-build
  cd $_svnmod-build

  msg "Starting make..."

  ./bootstrap
  ./configure --prefix=/usr --sysconfdir=/etc
  make || return 1
  make DESTDIR=${pkgdir} install || return 1
  mkdir -p ${pkgdir}/usr/include/libopensc || return 1
  install -Dm644 ${srcdir}/$_svnmod-build/src/libopensc/*.h ${pkgdir}/usr/include/libopensc || return 1
  mkdir -p ${pkgdir}/usr/include/scconf || return 1
  install -Dm644 ${srcdir}/$_svnmod-build/src/scconf/*.h ${pkgdir}/usr/include/scconf || return 1
  mkdir -p ${pkgdir}/usr/include/common || return 1
  install -Dm644 ${srcdir}/$_svnmod-build/src/common/*.h ${pkgdir}/usr/include/common || return 1
}

# Original Contributor: aquavitae <aquavitae69: gmail>
# Current Maintainer: Andrew Fischer <andrew_at_ltengsoft.com>

pkgname=openfoam

# The distributors package name
_distpkgname=OpenFOAM

pkgver=1.7.1
pkgrel=3
pkgdesc="The open source CFD toolbox"
arch=('i686' 'x86_64')
url="http://www.openfoam.com"
license=('GPL')
groups=()
depends=()
makedepends=(gcc make)
optdepends=('paraview: to view OpenFOAM casefile results')
provides=()
conflicts=()
replaces=()
backup=()
options=()
source=(http://downloads.sourceforge.net/foam/$_distpkgname-$pkgver.gtgz)
noextract=()
install=openfoam.install

md5sums=('2454728d946ee773c963fac15be9ca84')

build() {
  # Setup the build environment
  export FOAM_INST_DIR=$srcdir 
  foamDotFile=$srcdir/$_distpkgname-$pkgver/etc/bashrc
  [ -f $foamDotFile ] && . $foamDotFile || return 1

  # Build and clean up OpenFOAM
  cd "$srcdir/$_distpkgname-$pkgver" || return 1
  ./Allwmake || return 1
  wclean all || return 1
  cd "$startdir"
 
  # Create destination directories
  mkdir -p "$pkgdir/opt/$_distpkgname" "$pkgdir/etc/profile.d" || return 1

  # Move package to pkgdir
  mv "$srcdir/$_distpkgname-$pkgver" "$pkgdir/opt/$_distpkgname/$_distpkgname-$pkgver" || return 1

  # Add source file
  cp "$startdir/openfoam.sh" "$pkgdir/etc/profile.d/openfoam.sh" || return 1

  # Add stub thirdparty directory to keep openfoam happy
  mkdir -p "$pkgdir/opt/$_distpkgname/ThirdParty-$pkgver"

  # Permission fixes - for system-wide install and use
  chmod -R go+r "$pkgdir/opt"

  # Specifically look for and fix binaries that are executable only by the user and not by all
  find "$pkgdir/opt/" -perm -u+x ! -perm -o+x | xargs -n1 chmod 755 || return 1
}

# vim:set ts=2 sw=2 et:



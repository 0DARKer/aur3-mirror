# $Id: PKGBUILD 80964 2010-05-24 06:39:23Z allan $
# Maintainer: Aaron Griffin <aaron@archlinux.org>
# Contributor: judd <jvinet@zeroflux.org>
# Contributor: benetnash <benetnash@mail.icpnet.pl>

# Contributor: Thomas Haider <t.haider@vcnc.org>

pkgname=openssh-hpn
_pkgname=openssh
pkgver=5.8p1
pkgrel=1
pkgdesc='A Secure SHell server/client with High Performance patch'
arch=('i686' 'x86_64')
license=('custom:BSD')
url="http://www.psc.edu/networking/projects/hpn-ssh/"
backup=('etc/ssh/ssh_config' 'etc/ssh/sshd_config' 'etc/pam.d/sshd' 'etc/conf.d/sshd')
depends=('libedit' 'tcp_wrappers' 'heimdal')
provides=('openssh')
conflicts=('openssh')

_hpn_ver='hpn13v11.diff'
_hpn_patch="${_pkgname}-${pkgver}-${_hpn_ver}"
source=("ftp://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/${_pkgname}-${pkgver}.tar.gz"
        'sshd' 'sshd.confd' 'sshd.pam'
		http://www.psc.edu/networking/projects/hpn-ssh/${_hpn_patch}.gz)

build() {
  cd ${srcdir}/${_pkgname}-${pkgver}
  patch -p1 < ../${_hpn_patch}

  #NOTE we disable-strip so that makepkg can decide whether to strip or not
  ./configure --prefix=/usr --libexecdir=/usr/lib/ssh \
    --sysconfdir=/etc/ssh --with-tcp-wrappers --with-privsep-user=nobody \
    --with-md5-passwords --with-pam --with-mantype=man --mandir=/usr/share/man \
    --with-xauth=/usr/bin/xauth --with-kerberos5=/usr --with-ssl-engine \
    --with-libedit=/usr/lib --disable-strip
  make 
}

package() {
  cd "${srcdir}/${_pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install

  install -Dm755 ../sshd "${pkgdir}"/etc/rc.d/sshd
  install -Dm644 ../sshd.pam "${pkgdir}"/etc/pam.d/sshd
  install -Dm644 ../sshd.confd "${pkgdir}"/etc/conf.d/sshd
  install -Dm644 LICENCE "${pkgdir}/usr/share/licenses/${pkgname}/LICENCE"

  rm "${pkgdir}/usr/share/man/man1/slogin.1"
  ln -sf ssh.1.gz "${pkgdir}"/usr/share/man/man1/slogin.1.gz

  #additional contrib scripts that we like
  install -Dm755 contrib/findssl.sh "${pkgdir}"/usr/bin/findssl.sh
  install -Dm755 contrib/ssh-copy-id "${pkgdir}"/usr/bin/ssh-copy-id
  install -Dm644 contrib/ssh-copy-id.1  "${pkgdir}"/usr/share/man/man1/ssh-copy-id.1

  # sshd_config
  sed -i -e '/^#ChallengeResponseAuthentication yes$/c ChallengeResponseAuthentication no' \
    -e '/^#UsePAM no$/c UsePAM yes' \
    "${pkgdir}"/etc/ssh/sshd_config
}
sha256sums=('e1c77a8f3562a5e779c59d64ab14a336c160a56db924eaf82b124ac0b6b1323b'
            '36f6104a4f1ef8a45a1c13cc8132f86f2038c18405e9fe425e198d81ea3ed469'
            '4eab4e844567c5bd3b6102658f2a2592164c783f9657cdd689f48e546f6b17f1'
            '0bcad257c8679074f746d392cdb9573dd75bc40b6edc7d2d2cefd64531c71e6a'
            '62b500d29d8889ce76c8b596eb65731d8ac3469d89d9c6eb29fec2a845159df7')

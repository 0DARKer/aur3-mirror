#Maintainer: Daniel Wallace < danielwallace at gtmanfred dot com
pkgname=bastion
pkgver=4
_pkgver=2012-06-13
pkgrel=3

pkgdesc="An original action role-playing game set in a lush imaginative world, in which players must create and fight for civilizationâ€™s last refuge as a mysterious narrator marks their every move."
url="http://supergiantgames.com/?page_id=242"
license=('custom')
arch=('i686' 'x86_64')
groups=("humble-indie-bundleV" "games")
depends=('libxft')
makedepends=('curl')
source=("Bastion-HIB-${_pkgver}.sh" "$pkgname.desktop" "mesa$pkgname" "$pkgname.install")
install=$pkgname.install
md5sums=('00000000000000000000000000000000'
         '0facce79c6d93c5914a58e096eca8c92'
         'a42e39c5f52abf19b6975cb79f732907'
         '234862600b3d8792b95eedeae28577b7')
PKGEXT=".pkg.tar"
case $CARCH in
    i686) _arch=x86 ;;
    x86_64) _arch=x86_64;;
esac

_humblebundle() {
    if [[ -n "${_humblebundleVkey}" ]];then
        _archive="$(curl -s http://www.humblebundle.com/downloads\?key\="${_humblebundleVkey}" | grep "Bastion-HIB-")"
        _archive="${_archive##*data-web\=\'}"
        _archive="${_archive#*bundle\.com\/}"
        _archive="${_archive%%\?key\=*}"
        _md5="$(curl -s http://www.humblebundle.com/downloads\?key\="${_humblebundleVkey}" | grep "Bastion-HIB-" -A 4|grep md5 )"
        _md5="${_md5#*href\=\'#}"
        _md5="${_md5%%\'*}"
        _pkgver="${_archive##*HIB-}"
        _pkgver="${_pkgver%\.sh}"
        md5sums[0]="$_md5"
        source[0]="$_archive"
    else
        _archive="$(find . -type f -iname "Bastion-HIB-*")"
        _archive="${_archive#\.\/}"
        _pkgver="${_archive##*HIB-}"
        _pkgver="${_pkgver%\.sh}"
        source[0]="$_archive"
        md5sums[0]="7dc4710c244fbfdbd0c35ff703655c4b"
    fi
    while [[ ! -f "$startdir"/"${_archive}" ]];do
		if [[ -n "${_humblebundleVkey}" ]]; then
			_uri="$(curl -s http://www.humblebundle.com/downloads\?key\="${_humblebundleVkey}" | grep "Bastion-HIB-")"
            _uri="${_uri##*data-web\=\'}"
            _uri="${_uri%%\'*}" 
            curl "${_uri}" -o "${_archive}"
		else
			warning "Please export _humblebundleVkey for downloading"
			echo "Alternatively, place the download into ${startdir} and retry"
            exit 1
		fi
	done
	if [[ -z "${_humblebundleVkey}" && ! -f "${startdir}"/"${_archive}" ]]; then
		error "Failed to download \"${_archive}\"."
		exit 1
	fi
	unset _archive _key _uri 
}

package() {
    cd "$srcdir"
    [[ -d "$srcdir"/"$pkgname-$_pkgver" ]] && rm -r "$srcdir"/"$pkgname-$_pkgver"
    sh "${source[0]%%:*}" -u --packager pacman --target "$srcdir"/"$pkgname-$_pkgver" --bindir "$pkgdir"/opt/games/Bastion --datadir "$pkgdir"/opt/games

	find "${pkgdir}" -type f -exec chmod 644 "{}" +
	install -Dm644 "${pkgname}".desktop "${pkgdir}"/usr/share/applications/"${pkgname}".desktop
	install -Dm755 "mesa${pkgname}" "${pkgdir}"/usr/bin/"${pkgname}"mesa
	install -Dm644 "${pkgdir}"/opt/games/Bastion/Bastion.png "${pkgdir}"/usr/share/icons/"${pkgname}".png

	chmod 755 "${pkgdir}"/opt/games/Bastion/Bastion.bin."$_arch"
	ln -s "/opt/games/Bastion/Bastion.bin.$_arch" "${pkgdir}"/usr/bin/"${pkgname}"
}

_humblebundle


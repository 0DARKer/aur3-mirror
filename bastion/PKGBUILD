# Maintainer: Daniel Wallace <danielwallace at gtmanfred dot com>

pkgname=bastion
pkgver=2
_pkgver=2012-06-01-1
pkgrel=1
pkgdesc="an original action role-playing game set in a lush imaginative world, in which players must create and fight for civilizationâ€™s last refuge as a mysterious narrator marks their every move."
arch=('i686' 'x86_64')
url="http://supergiantgames.com/?page_id=242"
license=('custom')
makedepends=('xz')
depends=('libxft')
options=(!ccache)
_sh=Bastion-HIB-$_pkgver.sh
source=($_sh
        $pkgname.desktop)

build() {
  # Extract installer.
  if [ ! -d $srcdir/$pkgname-$pkgver ]; then
    mkdir -p $srcdir/$pkgname-$pkgver
  fi
  msg "Extracting archive..."
  sh $_sh --tar xf -C $srcdir/$pkgname-$pkgver 
  cd $srcdir/$pkgname-$pkgver
  if test "$CARCH" == x86_64; then
      _arch=x86_64 
      _sfix=x86_64
  else
      _arch=x86
  fi
  lzcat subarch | tar xvf -
  tar --lzma -xf instarchive_all
  tar --lzma -xf instarchive_linux_$_arch

  # Create pkgdir folders.
}
package() {
  PKGEXT='.pkg.tar'
  mkdir -p $pkgdir/usr/bin
  mkdir -p $pkgdir/usr/share/{applications,games/$pkgname,icons}
  mkdir -p $pkgdir/usr/share/licenses/$pkgname
  case $CARCH in
    i686) _arch=x86 ; _sfix=x86;;
    x86_64) _arch=x86_64 ; _sfix=x86_64 ;;
  esac
  
  # Install files.
  msg "Copying files..."

cat <<EOF > $srcdir/intelbastion
#!/usr/bin/env bash
export force_s3tc_enable=true
/usr/bin/bastion
EOF
  install -Dm755 $srcdir/intelbastion $pkgdir/usr/bin/intelbastion

  cd $srcdir/$pkgname-$pkgver

  # Move all libraries.
  #mv libs$_sfix/all/* libu$_sfix/
  #rmdir libs$_sfix/all

  # Copy the game folder.
  case $CARCH in
    i686) [[ -d bin/linux/x86_64 ]] && rm -r bin/linux/x86_64;;
    x86_64) [[ -d bin/linux/x86 ]] && rm -r bin/linux/x86;;
  esac
  cp -dpr --no-preserve=ownership * $pkgdir/usr/share/games/$pkgname
  #cp -r * $pkgdir/usr/share/games/$pkgname
  
  # Make executable links.
  ln -s /usr/share/games/$pkgname/Bastion.bin.$_sfix $pkgdir/usr/bin/$pkgname

  # Install icons and .desktop files.
  install -m644 Bastion.png $pkgdir/usr/share/icons/$pkgname.png
  install -D -m644 $srcdir/$pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
}
md5sums=('30ba3e0a4993c3cb08f57496c400547f'
         '6bfaf5f637a1b54aef066506f6cd6e55')

# Maintainer: Ryan Davies <ryan@ryandavies.co.nz>

pkgname=plymouth-lite
pkgver=0.6.0
pkgrel=2
pkgdesc="Boot splash screen based on Fedora's Plymouth code"
arch=('i686' 'x86_64')
url="https://github.com/nemomobile/plymouth-lite"
depends=('libpng12')
conflicts=('plymouth')
makedepends=('git')
license=('GPL')
source=(
  "$pkgname"::'git://github.com/nemomobile/plymouth-lite#branch=master'
  "plymouth-lite-halt.service"
  "plymouth-lite-poweroff.service"
  "plymouth-lite-reboot.service"
  "plymouth-lite-start.service"
  "plymouth-lite-0.6.0-01-fix-build.patch"
  "plymouth-lite-0.6.0-21-16bpp.patch"
)
md5sums=('SKIP'
         '91a8fa90ac0d025dc0b68f70b42e3cfd'
         '08db947a057e61d17edab08dc5131f10'
         '0d2cec44332ba4a3aaf4826a1e2d33a6'
         '989ad739314544a900b1eb711b735864'
         '18561abca5072725729c071ccee895fb'
         'db30b2b2e831d46f1eb4ba5a951828b0')
build(){
  cd "${srcdir}/plymouth-lite"
  ./configure

  patch -p1 < "${srcdir}/plymouth-lite-0.6.0-01-fix-build.patch"
  patch -p1 < "${srcdir}/plymouth-lite-0.6.0-21-16bpp.patch"

  nice -n 10 make -j $(cat /proc/cpuinfo | grep vendor |wc -l)
}

package() {
  cd "${srcdir}/plymouth-lite"
  make DESTDIR="${pkgdir}" install
  
  mkdir -p "${pkgdir}/usr/lib/systemd/system"
  install -D -m 0644 -T "${srcdir}/plymouth-lite-halt.service" "${pkgdir}/usr/lib/systemd/system/plymouth-lite-halt.service"
  install -D -m 0644 -T "${srcdir}/plymouth-lite-poweroff.service" "${pkgdir}/usr/lib/systemd/system/plymouth-lite-poweroff.service"
  install -D -m 0644 -T "${srcdir}/plymouth-lite-reboot.service" "${pkgdir}/usr/lib/systemd/system/plymouth-lite-reboot.service"
  install -D -m 0644 -T "${srcdir}/plymouth-lite-start.service" "${pkgdir}/usr/lib/systemd/system/plymouth-lite-start.service"

  mkdir -p "${pkgdir}/usr/share/plymouth/"
  install -D -m 0644 -T "${srcdir}/plymouth-lite/splash.png" "${pkgdir}/usr/share/plymouth/splash.png"

  mkdir -p ${pkgdir}/usr/lib/systemd/system/sysinit.target.wants
  cd ${pkgdir}/usr/lib/systemd/system/sysinit.target.wants
  ln -s ../plymouth-lite-start.service

  mkdir -p ${pkgdir}/usr/lib/systemd/system/halt.target.wants
  cd ${pkgdir}/usr/lib/systemd/system/halt.target.wants
  ln -s ../plymouth-lite-halt.service

  mkdir -p ${pkgdir}/usr/lib/systemd/system/poweroff.target.wants
  cd ${pkgdir}/usr/lib/systemd/system/poweroff.target.wants
  ln -s ../plymouth-lite-poweroff.service

  mkdir -p ${pkgdir}/usr/lib/systemd/system/reboot.target.wants
  cd ${pkgdir}/usr/lib/systemd/system/reboot.target.wants
  ln -s ../plymouth-lite-reboot.service

}

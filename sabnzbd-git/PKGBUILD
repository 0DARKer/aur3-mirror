# Maintainer: dryes <joswiseman@gmail>
pkgname='sabnzbd-git'
pkgver=20110823
pkgrel=1
pkgdesc='A web-interface based binary newsgrabber with NZB file support.'
arch=('any')
url='http://www.sabnzbd.org/'
license=('GPL')
depends=('par2cmdline' 'python2' 'python-cheetah' 'python2-feedparser' 'python2-yenc' 'python2-pyopenssl' 'unrar' 'unzip' 'sqlite3' 'curl')
makedepends=('git')
backup=('etc/conf.d/sabnzbd')
install=('sabnzbd.install')
conflicts=('sabnzbd' 'sabnzbd-bzr')
provides=('sabnzbd')
replaces=('sabnzbd-bzr')
source=('sabnzbd.sh' 'sabnzbd.init' 'sabnzbd.confd')
md5sums=('0e90eab9ea5d80de91e2af41e84eb4cc' '7bd776f2c369026bb47e3d95982a0501' 'bc1723a2dd17d792785e1f6009b35751')

_gitroot="git://github.com/sabnzbd/sabnzbd.git"
_gitname="sabnzbd"

build() {
  cd "${srcdir}"
  msg "Connecting to GIT server...."

  if [ -d ${_gitname} ] ; then
    cd ${_gitname} && git pull origin
    msg "The local files are updated."
  else
    git clone ${_gitroot} ${_gitname}
  fi

  msg "GIT checkout done or server timeout"
}

package() {
  mkdir -p "${pkgdir}/opt/sabnzbd"
  cp -r "${srcdir}/sabnzbd" "${pkgdir}/opt"

  cd "${pkgdir}/opt/sabnzbd"
  _gitfiles=$(find -name ".git*")
  [ -n "${_gitfiles}" ] && rm -rf "${_gitfiles[@]}"
  rm -rf NSIS_Installer.nsi osx PKG-INFO sabnzbd-template.sparseimage.zip Sample-PostProc.cmd setup-osx.py setup.py *.txt win
  chmod +x Sample-PostProc.sh SABnzbd.py

  install -D -m755 "${srcdir}/sabnzbd.sh" "${pkgdir}/usr/bin/sabnzbd"
  install -D -m755 "${srcdir}/sabnzbd.init" "${pkgdir}/etc/rc.d/sabnzbd"
  install -D -m644 "${srcdir}/sabnzbd.confd" "${pkgdir}/etc/conf.d/sabnzbd"
}



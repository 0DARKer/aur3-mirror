# Maintainer: Jens Staal <staal1978@gmail.com>

pkgname=kernel-glendix
pkgver=2.6.31.6
_extraver=.6
pkgrel=2
pkgdesc="The Linux Kernel with glendix patches enabling Plan9 binary compatibility"
arch=('i686')
license=('GPL2')
url="http://www.glendix.org"
depends=('coreutils' 'module-init-tools' 'linux-firmware')
makedepends=('mercurial')
source=('http://www.kernel.org/pub/linux/kernel/v2.6/linux-2.6.31.6.tar.bz2')
provides=('glendix')
md5sums=('485472df88af84becdcf47f45de3ba46')

build() {
# get into the linux source directory and start some magic
cd $srcdir
# Update the repo, else clone a new one
	if [ -d glendix ]; then
		cd glendix
		hg pull -u
		cd $srcdir
	else
		hg clone http://hg.glendix.org/glendix/
	fi

  rm -rf $srcdir/build
  cp -ar $srcdir/linux-$pkgver $srcdir/build

  cd $srcdir/build
  patch -p0 < $srcdir/glendix/patches/glendix_$pkgver.patch

  #automatic generation of extraver.patch
printf "
4c4
< EXTRAVERSION = $_extraver
---
> EXTRAVERSION = $_extraver-glendix

" > $srcdir/extraver.patch

  patch -p0 $srcdir/build/Makefile -i $srcdir/extraver.patch

  make silentoldconfig
  
  #make menuconfig
  make || return 1
}

package() {
  # install our modules
  cd $srcdir/build
  mkdir -p $pkgdir/{lib/modules,boot}
  make INSTALL_MOD_PATH=$pkgdir modules_install || return 1

  # remove the junk symlinks
  cd $srcdir/build
  rm $pkgdir/lib/modules/${pkgver}-glendix/{build,source}
  rm -rf $pgkdir/lib/firmware/kaweth #uncomment this line if you need it. I had conflicts during install

  # install the kernel
  cp System.map $pkgdir/boot/System.map.glendix
  cp arch/x86/boot/bzImage $pkgdir/boot/vmlinuz-glendix
  # install a helper file for all install scripts
  mkdir -p $pkgdir/usr/share/kernel-glendix/
  echo "KERNEL_VERSION='${pkgver}-glendix'" > $pkgdir/usr/share/kernel-glendix/currver
}


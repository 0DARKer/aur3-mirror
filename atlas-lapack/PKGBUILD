# Maintainer: Giuseppe Borzi <gborzi___AT___ieee___DOT___org>
# Contributor: mickele <mimocciola___AT___yahoo___DOT___ com>
# Contributor: iztok pizorn <pizorn___AT___gmail___DOT___com>
# Contributor: olivier medoc <o_medoc___AT___yahoo___DOT___fr>
pkgname=atlas-lapack
pkgver=3.10.0
_lapackver=3.4.1
pkgrel=2
pkgdesc="Complete LAPACK and BLAS implementation using optimised ATLAS routines"
url="http://math-atlas.sourceforge.net/"
depends=('gcc-libs')
makedepends=('binutils' 'sed' 'gcc-fortran')
arch=('i686' 'x86_64')
conflicts=('blas' 'lapack' 'cblas')
provides=("blas" "lapack=$_lapackver" 'cblas')
license=('custom:blas' 'custom:lapack' 'custom:atlas')
options=(!makeflags)
install=$pkgname.install
source=(http://www.netlib.org/lapack/lapack-$_lapackver.tgz http://downloads.sourceforge.net/math-atlas/atlas${pkgver}.tar.bz2 blas-license.txt atlas-license.txt makefile.shared.mt makefile.shared.st fix_sse1.patch)
noextract=(lapack-$_lapackver.tgz)
md5sums=('44c3869c38c8335c2b9c2a8bb276eb55'
         '2030aa079b8d040b93de7018eae90e2b'
         '38b6acb8ed5691d25863319d30a8b365'
         '4903eb06072dfbf94710691ccb6660bf'
         '471f0ecdc36ef5e1118309847d142eea'
         '6e307b98236ff319ac1c03166ad9164c'
         'c87295d6c279badbd8ba18a87d264054')

build() {

   NCPU=`grep "^processor" /proc/cpuinfo | wc -l`
   #USE_ARCH_DEFAULTS="yes"
   [ -x /usr/bin/cpufreq-info ] && [ $(cpufreq-info -d) != '' ] && {
       ICPU=0
       while [ $ICPU -lt $NCPU ]; do
          STATUS=`cpufreq-info -c $ICPU -p | cut -d' ' -f3`
          [ "$STATUS" != "performance" ] && {
             msg 'Before building this package, as root you must run'
             msg '"cpufreq-set -g performance -c <CPU nr>" for each CPU (<CPU'
             msg 'nr> is 0, 1, 2 up to the number of your CPUS.'
             return 1
          }
          let ICPU=ICPU+1
       done
   }
   # fix SSE1 only bug, see https://sourceforge.net/tracker/?func=detail&aid=3554109&group_id=23725&atid=379482
   patch -Np0 -i "$srcdir/fix_sse1.patch"
   if [ "$CARCH" = "x86_64" ]; then
      ARCHITECTURE_BUILD_OPTS="-b 64" # for x86_64
   else
      ARCHITECTURE_BUILD_OPTS="-b 32" # for i686
   fi

   mkdir -p "$srcdir/ATLAS/build"
   cd "$srcdir/ATLAS/build"

   msg 'Build ATLAS'
   unset MAKE
   cd "$srcdir/ATLAS/build"
   rm -rf *
   ../configure --prefix=/usr/ $ARCHITECTURE_BUILD_OPTS -Fa alg -fPIC \
      --with-netlib-lapack-tarfile="$srcdir/lapack-$_lapackver.tgz"
   make build
   msg 'Build shared libraries'
   cd lib
   if [ 1 -lt $NCPU ]; then
      cp "$srcdir/makefile.shared.mt" makefile
   else
      cp "$srcdir/makefile.shared.st" makefile
   fi
   make -f makefile
}

check() {

   cd "$srcdir/ATLAS/build"

   msg 'Check...'
   unset MAKE
   make check
   make ptcheck
   make time
}

package() {

   cd "$srcdir/ATLAS/build"
   make DESTDIR="$pkgdir/usr" install
   cp -d lib/*.so* "$pkgdir/usr/lib"
   [ -e lib/libptlapack.a] && cp lib/libptlapack.a "$pkgdir/usr/lib"
   cd "$pkgdir/usr/lib"
   ln -s libblas.so libblas.so.3
   ln -s liblapack.so.3 liblapack.so

   install -Dm644 "${srcdir}/blas-license.txt" \
      "${pkgdir}/usr/share/licenses/$pkgname/blas-license.txt"
   install -Dm644 "${srcdir}/ATLAS/build/src/lapack/reference/LICENSE" \
      "${pkgdir}/usr/share/licenses/$pkgname/lapack-license.txt"
   install -Dm644 "${srcdir}/atlas-license.txt" \
      "${pkgdir}/usr/share/licenses/$pkgname/atlas-license.txt"
}


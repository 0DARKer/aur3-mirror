# Maintainer: Gustavo Alvarez <sl1pkn07@gmail.com>

## OPTIONS: 0=off 1=on ##

_use_sdlmame=0
_use_sdlmess=0
_use_sdlume=0

#########################

[ "${_use_sdlmame}" = "1" -o "${_use_sdlmess}" = "1" -o "${_use_sdlume}" = "1" ] &&  _use+="qmc2-core-svn "
[ "${_use_sdlmame}" = "1" ] && _use+="qmc2-sdlmame-svn "
[ "${_use_sdlmess}" = "1" ] && _use+="qmc2-sdlmess-svn "
[ "${_use_sdlume}" = "1" ] && _use+="qmc2-sdlume-svn "

if [ "${_use_sdlmame}" = "1" -o "${_use_sdlmess}" = "1" -o "${_use_sdlume}" = "1" ]; then
  source=("qmc2::svn://svn.code.sf.net/p/qmc2/code/trunk")
  md5sums=('SKIP')
  makedepends=('rsync' 'mesa' 'subversion' 'qtwebkit' 'phonon' 'sdl' 'libxmu')
  _svnmod="qmc2"
else
  warning "Need choice, at least, one Option, Please edit OPTIONS in the PKGBUILD before build, if not build a EMPTY package"
fi

pkgbase=qmc2-svn
pkgname=qmc2-svn

true && pkgname=('qmc2-svn' $_use)
pkgver=4858
pkgrel=1
pkgdesc="Qt 4 based UNIX MAME frontend supporting SDLMAME, SDLMESS or SDLUME. (SVN version) [SPLIT PKGBUILD]"
url="http://qmc2.arcadehits.net/wordpress/"
license=("GPL")
arch=('i686' 'x86_64')

pkgver() {
  if [ "${_use_sdlmame}" = "1" -o "${_use_sdlmess}" = "1" -o "${_use_sdlume}" = "1" ]; then
    cd "${SRCDEST}/${_svnmod}"
    svnversion
  else
    echo "EMPTY"
  fi
}

prepare() {
  cd "${srcdir}"
  rm -fr "${srcdir}/${_svnmod}/runonce/"runonce{,.o}
  rm -fr "${_svnmod}_sdlmame-build"
  rm -fr "${_svnmod}_sdlmess-build"
  rm -fr "${_svnmod}_sdlume-build"
  [ "${_use_sdlmame}" = "1" ] && cp -R "${_svnmod}" "${_svnmod}_sdlmame-build"
  [ "${_use_sdlmess}" = "1" ] && cp -R "${_svnmod}" "${_svnmod}_sdlmess-build"
  [ "${_use_sdlume}" = "1" ] && cp -R "${_svnmod}" "${_svnmod}_sdlume-build"
  true
}

build() {
  if [ "${_use_sdlmame}" = "1" -o "${_use_sdlmess}" = "1" -o "${_use_sdlume}" = "1" ]; then
    cd "${srcdir}/${_svnmod}/runonce/"
    qmake-qt4
    make -f Makefile.qmake
    if [ "${_use_sdlmame}" = "1" ]; then
      msg2 "Build QMC2 with SDLMAME compat"
      make -C "${srcdir}/${_svnmod}_sdlmame-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLMAME
    fi
    if [ "${_use_sdlmess}" = "1" ]; then
      msg2 "Build QMC2 with SDLMESS compat"
      make -C "${srcdir}/${_svnmod}_sdlmess-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLMESS
    fi
    if [ "${_use_sdlume}" = "1" ]; then
      msg2 "Build QMC2 with SDLUME compat"
      make -C "${srcdir}/${_svnmod}_sdlume-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLUME
    fi
  fi
}

package_qmc2-svn() {
  packagedec=('Qt 4 based UNIX MAME frontend supporting SDLMAME, SDLMESS and SDLUME. (SVN version)')
  arch=('any')
}

package_qmc2-core-svn() {
  packagedec=('Qt 4 based UNIX MAME frontend. Core. (SVN version)')
  arch=('i686' 'x86_64')
  depends=('libxmu')
  conflicts=('qmc2')
  provides=("qmc2-core-svn=${pkgver}")
  optdepends=('qmc2-sdlmame-svn: Frontend for SDLMAME'
              'qmc2-sdlmess-svn: Frontend for SDLMESS'
              'qmc2-sdlume-svn: Frontend for SDLUME')
  install -d "${pkgdir}/usr/share/qmc2"
  install -d "${pkgdir}/etc/qmc2"
  cp -R "${srcdir}/${_svnmod}/data/"* "${pkgdir}/usr/share/qmc2"
  install "${srcdir}/${_svnmod}/inst/qmc2.ini.template" "${pkgdir}/etc/qmc2/qmc2.ini"
  sed 's|DATADIR|/usr/share|' -i "${pkgdir}/etc/qmc2/qmc2.ini"
  install -Dm755 "${srcdir}/${_svnmod}/runonce/runonce" "${pkgdir}/usr/bin/runonce"
}

package_qmc2-sdlmame-svn() {
  packagedec=('Qt 4 based UNIX MAME frontend for SDLMAME. (SVN version)')
  depends=("qmc2-core-svn=${pkgver}" 'qtwebkit' 'phonon' 'sdl' 'sdlmame')
  arch=('i686' 'x86_64')
  make -C "${srcdir}/${_svnmod}_sdlmame-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLMAME DESTDIR="${pkgdir}" install
  rm -fr "${pkgdir}/usr/bin/"{qmc2,runonce}
  rm -fr "${pkgdir}/etc"
  rm -fr "${pkgdir}/usr/share/qmc2"
}

package_qmc2-sdlmess-svn() {
  packagedec=('Qt 4 based UNIX MAME frontend for SDLMESS. (SVN version)')
  depends=("qmc2-core-svn=${pkgver}" 'qtwebkit' 'phonon' 'sdl' 'sdlmess')
  arch=('i686' 'x86_64')
  make -C "${srcdir}/${_svnmod}_sdlmess-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLMESS DESTDIR="${pkgdir}" install
  rm -fr "${pkgdir}/usr/bin/"{qmc2,runonce}
  rm -fr "${pkgdir}/etc"
  rm -fr "${pkgdir}/usr/share/qmc2"
}

package_qmc2-sdlume-svn() {
  packagedec=('Qt 4 based UNIX MAME frontend for SDLUME. (SVN version)')
  depends=("qmc2-core-svn=${pkgver}" 'qtwebkit' 'phonon' 'sdl' 'sdlume')
  arch=('i686' 'x86_64')
  make -C "${srcdir}/${_svnmod}_sdlume-build" PREFIX=/usr CTIME=0 DATADIR=/usr/share SYSCONFDIR=/etc QTDIR=/usr EMULATOR=SDLUME DESTDIR="${pkgdir}" install
  rm -fr "${pkgdir}/usr/bin/"{qmc2,runonce}
  rm -fr "${pkgdir}/etc"
  rm -fr "${pkgdir}/usr/share/qmc2"
}

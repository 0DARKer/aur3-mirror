# Contributors: Gladstone <h2oz7v@gmail.com>
# 		nlight    <alexander.dzhoganov@gmail.com>

pkgname=emergent-svn
pkgver=4184
pkgrel=1
pkgdesc="Neural simulation software, modelling the brain and cognitive process."
arch=('i686' 'x86_64')
url="http://grey.colorado.edu/emergent"
license=('GPL')
depends=('libjpeg' 'libpng' 'qt' 'coin' 'quarter-svn' 'gsl' 'ode' 'libsndfile')
makedepends=('cmake')
source=('configure.patch' 'link.patch')
md5sums=('3db2ba1b92ecaff51e43afbdaff49d38' '98f370791d7e08aa9b2c33cb705df45c')

_svntrunk=http://grey.colorado.edu/svn/emergent/emergent/trunk
_svnmod=emergent
_name=emergent

build()
{
  cd ${startdir}/src
  msg "Connecting to $_svnmod SVN server...."

  if [ -d $_svnmod/.svn ]; then
    (cd $_svnmod && svn up -r $pkgver)
  else
    svn co --username anonymous --password emergent -r $pkgver "$_svntrunk" "$_svnmod"
  fi

  msg "SVN checkout done"
  msg "Starting make..."
  cd emergent
  msg "Patching configure script"
  patch -p0 configure < ${startdir}/src/configure.patch
  ./configure --prefix=/usr
  cd build
  # really crude hack to force cmake to create temp src directory so 
  # we can patch it
  msg "Running make for 5 seconds"
  make &
  `sleep 5`
  msg "Killing make"
  kill -9 `pidof -s make`
  # /hack
  msg "Patching source"
  patch -R -p0 < ${startdir}/src/link.patch
  msg "Running make"
  make || return 1
  make prefix=/usr DESTDIR=$startdir/pkg/ install
}

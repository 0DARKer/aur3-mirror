# Maintainer: Yosef Or Boczko <yosefor3@walla.com>

_pkgname=gimp3
pkgname=$_pkgname-git
pkgver=20130324
pkgrel=1
_realver=2.9.99
pkgdesc="GNU Image Manipulation Program"
arch=('i686' 'x86_64')
url="http://www.gimp.org/"
license=('GPL' 'LGPL')
depends=('babl>=0.1.11' 'gegl>=0.2.1' 'lcms' 'libxpm' 'libwmf' 'libxmu' 'librsvg' 'libmng' 'dbus-glib'
		  'libexif' 'jasper' 'desktop-file-utils' 'hicolor-icon-theme')
makedepends=('intltool' 'libwebkit' 'poppler-glib' 'alsa-lib' 'iso-codes' 'curl' 'ghostscript' 'libxslt' 'gtk-doc')
optdepends=('gutenprint: for sophisticated printing only as gimp has built-in cups print support'
			'libwebkit: for the help browser' 
			'poppler-glib: for pdf support'
			'alsa-lib: for MIDI event controller module'
			'curl: for URI support'
			'xorg-server-xvfb: for xvfb-run'
			'ghostscript: for postscript support')
options=('!libtool' '!makeflags')
conflicts=('gimp-devel' 'gimp')
install=$_pkgname.install
replaces=('gimp')
provides=('gimp' 'gimp=$_realver' 'gimp3=_realver')
conflicts=('gimp')

_gitroot="git://git.gnome.org/gimp"
_gitname="gimp"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $srcdir/$_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot
    cd $_gitname
    git checkout -b gtk3-port origin/gtk3-port
    cd ..
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
  
  git checkout master
  git checkout -b new
  git merge gtk3-port
  
  ./autogen.sh --prefix=/usr --sysconfdir=/etc \
    --enable-mp --enable-gimp-console \
    --disable-python --with-gif-compression=lzw --with-libcurl \
    --without-aa --without-gvfs \
    --enable-gtk-doc
  make
}

package() {
  cd "$srcdir/$_gitname-build"
  make DESTDIR="${pkgdir}" install  
  rm -rf "${srcdir}/${_gitname}-build"
}

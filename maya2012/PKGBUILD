# Maintainer: Mihai Militaru <mihai dot militaru at gmx dot com>

pkgname=maya2012
pkgver=2012.0.258
pkgrel=1
pkgdesc="3D Animation, Visual Effects, and Compositing Software"
arch=('x86_64')
url="http://www.autodesk.com/maya"
license=('proprietary')
depends=('libgl' 'mesa' \
	'libxp' 'libxmu' 'libxpm' 'libxt' 'libxi' 'libxext' 'libx11' 'libxinerama' 'libxau' 'libxcb' \
	'gamin' 'audiofile' 'e2fsprogs' 'glibc' 'zlib' 'libsm' 'libice' 'openssl' \
	'tcsh' 'ttf-liberation')
optdepends=('maya2012-docs: html documentation reference')
makedepends=('rpmextract')
source=(http://images.autodesk.com/adsk/files/autodesk_maya_2012_english_linux_64bit.tgz)
sha1sums=('f3e6aca5da9d29d9bbfd7f4b3b28174e75518469')

build() {
  cd ${pkgdir}
  rpmextract.sh ${srcdir}/adlmapps4-4.0.35-0.x86_64.rpm || return 1
  rpmextract.sh ${srcdir}/adlmflexnetclient-4.0.35-0.x86_64.rpm || return 1
  rpmextract.sh ${srcdir}/Maya2012_0_64-2012.0-258.x86_64.rpm || return 1
  install -Dm644 "$srcdir/EULA/All Other Countries.txt" ${pkgdir}/usr/share/licenses/$pkgname/LICENSE || return 1
}

package() {
  echo "Creating /var/flexlm..."
  # make sure /var/flexlm is world-writable. 
  mkdir -p ${pkgdir}/var/flexlm || return 1
  chmod ugo+w ${pkgdir}/var/flexlm || return 1
  
  echo "Deleting maya directory if it's a link..."
  # need to add links after install since you can't name links in the file list
  if test -L ${pkgdir}/usr/autodesk/maya2012-x64; then
      rm -f ${pkgdir}/usr/autodesk/maya2012-x64 || return 1
  fi
  
  echo "Linking the maya directory..."
  # create the maya softlink if it doesn't exist
  cd ${pkgdir}/usr/autodesk
  ln -sf maya2012-x64 maya || return 1
  
  echo "Creating various binary links..."
  # update various softlinks
  cd ${pkgdir}/usr/autodesk/maya2012-x64/bin
  ln -sf maya2012 maya || return 1
  mkdir -p ${pkgdir}/usr/bin || return 1
  ln -sf /usr/autodesk/maya2012-x64/bin/maya2012 ${pkgdir}/usr/bin/maya || return 1
  ln -sf /usr/autodesk/maya2012-x64/bin/Render ${pkgdir}/usr/bin/Render || return 1
  ln -sf /usr/autodesk/maya2012-x64/bin/fcheck ${pkgdir}/usr/bin/fcheck || return 1
  ln -sf /usr/autodesk/maya2012-x64/bin/imgcvt ${pkgdir}/usr/bin/imgcvt || return 1
  
  # uncomment with 64-bit opa is available.
  #ln -sf opa ${pkgdir}/usr/autodesk/maya2012/bin/apcw
  
  # links for pcw
  
  echo "Linking desktop files..."
  # create softlinks for desktop
  mkdir -p ${pkgdir}/usr/share/applications || return 1
  ln -sf /usr/autodesk/maya2012-x64/desktop/Autodesk-Maya.desktop ${pkgdir}/usr/share/applications/Autodesk-Maya2012-x64.desktop || return 1
  mkdir -p ${pkgdir}/usr/share/desktop-directories || return 1
  ln -sf /usr/autodesk/maya2012-x64/desktop/Autodesk-Maya.directory ${pkgdir}/usr/share/desktop-directories/Autodesk-Maya2012-x64.directory || return 1
  mkdir -p ${pkgdir}/usr/share/icons/hicolor/48x48/apps || return 1
  ln -sf /usr/autodesk/maya2012-x64/desktop/Maya.png ${pkgdir}/usr/share/icons/hicolor/48x48/apps/Maya2012.png || return 1
  
  #cd ${pkgdir}/usr/autodesk/maya2012-x64/lib
  # workaround the ssl dependency problem
  echo "Linking openssl library..."
  if ! [ -a ${pkgdir}/usr/autodesk/maya2012-x64/lib/libssl.so.6 ]
  then
    ln -s /usr/lib/libssl.so ${pkgdir}/usr/autodesk/maya2012-x64/lib/libssl.so.6  || return 1
    ln -s /usr/lib/libcrypto.so ${pkgdir}/usr/autodesk/maya2012-x64/lib/libcrypto.so.6 || return 1
  fi
  
  # update the mental ray configuration files in place
  #RPM_ESCAPED_PREFIX=`echo ${pkgdir}/usr | sed -e '/\//s/\//\\\\\//g'`

  #sed -e "/\[PREFIX\]/s//\/usr/" ${pkgdir}/usr/autodesk/maya2012-x64/mentalray/maya.rayrc > /tmp/maya.rayrc
  #sed -e "/\[PREFIX\]/s//\/usr/" ${pkgdir}/usr/autodesk/maya2012-x64/bin/mayaexport_with_mr > /tmp/mayaexport_with_mr
  #mv /tmp/maya.rayrc ${pkgdir}/usr/autodesk/maya2012-x64/mentalray/maya.rayrc
  #mv /tmp/mayarender_with_mr ${pkgdir}/usr/autodesk/maya2012-x64/bin/mayarender_with_mr
  
  #chmod 755 ${pkgdir}/usr/autodesk/maya2012-x64/bin/mayarender_with_mr > /dev/null 2>&1
  echo "Creating the synergy file..."
  instPath=/usr/autodesk/maya2012-x64/bin/maya
  RPM_INSTALL_PATH=`echo ${instPath} | sed -e '/\//s/\//\\\\\//g'`
  sed -e "/__EXECUTABLE_PATH__/s//${RPM_INSTALL_PATH}.bin\"\n      StartWrapperPath=\"${RPM_INSTALL_PATH}2012/" ${pkgdir}/opt/Autodesk/Synergy/Maya2012.2012.1.64.syncfg > ${pkgdir}/opt/Autodesk/Synergy/maya2012tmp.txt || return 1
  mv ${pkgdir}/opt/Autodesk/Synergy/maya2012tmp.txt ${pkgdir}/opt/Autodesk/Synergy/Maya2012.2012.1.64.syncfg || return 1
  
  echo "Use this command, as root, to install your license: \
\"LD_LIBRARY_PATH=/opt/Autodesk/Adlm/R4/lib64 /usr/autodesk/maya2012-x64/bin/adlmreg <your license information>\""
}
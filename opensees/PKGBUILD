# Maintainer: mickele
pkgname=opensees
pkgver=2.4.4
pkgrel=1
pkgdesc="OpenSees, a software framework for developing applications to simulate the performance of structural and geotechnical systems subjected to earthquakes"
arch=("i686" "x86_64")
url="http://opensees.berkeley.edu/"
depends=('tk>=8.6' 'openssl' 'libpng' 'mesa' 'lapack')
makedepends=('svn')
options=('')
license=("custom")

# This release is available only through svn
# http://opensees.berkeley.edu/OpenSees/changeLog.php
# source=("http://opensees.berkeley.edu/OpenSees/code/OpenSees${pkgver}.tar.gz" "Makefile.def")
source=("Makefile.def")

build() {
  local _svntrunk="svn://opensees.berkeley.edu/usr/local/svn/OpenSees/trunk"
  local _svnrel="5764"
  local _svnmod="OpenSees"

  msg "Starting SVN checkout..."
  cd ${srcdir}
  if [ -d ${_svnmod}/.svn ]; then
      (cd ${_svnmod} && svn up -r ${_svnrel})
    else
      svn co ${_svntrunk} --config-dir ./ -r ${_svnrel} ${_svnmod}
  fi
  msg "SVN checkout done or server timeout"

  cd "${srcdir}/OpenSees" || return 1

  msg "Configuring..."
  cp "${srcdir}/Makefile.def" ./ || return 1

  sed -e "s|\$(INSTALLDIR)|${srcdir}|" \
      -e "s|\$(SRCDIR)|${srcdir}|" \
      -i Makefile.def

  # make error
  sed -e "s|@\$(ECHO) \"CSPAPRSE_LIBRARY not DEFINED\"|#|" \
      -i OTHER/CSPARSE/Makefile
  # Missing header
  sed -e "s|#include <png.h>|#include <png.h>\n#include <zlib.h>|" \
      -i SRC/renderer/OpenGlDevice.cpp

  msg "Building..."
  mkdir -p "${srcdir}/lib" || return 1
  mkdir -p "${srcdir}/bin" || return 1
  make || return 1
}

package(){
  local _installdir="/usr"

  install -d -m755 "${pkgdir}${_installdir}/bin"
  install "${srcdir}/bin/OpenSees" "${pkgdir}${_installdir}/bin"

  msg "Istalling licence..."
  install -D -m644 "${srcdir}/OpenSees/COPYRIGHT" \
	"${pkgdir}/usr/share/licenses/${pkgname}/LICENSE" || return 1
}


md5sums=('c5d79f36f6978d9f6f009eea56617176')

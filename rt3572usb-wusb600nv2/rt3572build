#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions


modprobe -n rt3572sta 2> /dev/null && exit 
stat_busy "Building rt3572sta module"
SRC_DIR='/usr/share/rt3572usb'
TMP_DIR="/tmp/rt3572-$(date +%d%m%y%M%S)"
mkdir $TMP_DIR

tar -xf $SRC_DIR/2011_0427_RT3572_Linux_STA_v2.5.0.0.DPO.bz2 -C $TMP_DIR
cp $SRC_DIR/patch.{config,wusb600nv2} $TMP_DIR

cd $TMP_DIR/2011_0427_RT3572_Linux_STA_v2.5.0.0.DPO
patch -Np1 -s -i ../patch.config
patch -Np1 -s -i ../patch.wusb600nv2
sed -i -e 's#usb_buffer_alloc#usb_alloc_coherent#g' \
       -e 's#usb_buffer_free#usb_free_coherent#g' \
       include/os/rt_linux.h
make &> "$TMP_DIR/build.log" 

gzip os/linux/rt3572sta.ko
install -D -m 644 os/linux/rt3572sta.ko.gz /lib/modules/$(uname -r)/kernel/drivers/net/wireless/rt3572sta.ko.gz

if [ $? -gt 0 ]; then
      stat_fail
      exit 1;		
fi

depmod -a
modprobe rt3572sta
stat_done

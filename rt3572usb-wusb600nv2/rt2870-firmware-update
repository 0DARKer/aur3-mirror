#!/usr/bin/perl
# rt2870-firmware-update v0.1
## Copyright 2011 Simone Sclavi 'Ito'
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
##
use warnings;
use strict;
use feature 'say';
use LWP;
use URI;
use File::Copy;
use Archive::Extract;
use File::Compare;


die ":: root privileges required!\n" unless ($> == 0 or $< == 0) ;

my $ralink_url = URI->new('http://www.ralinktech.com');
$ralink_url->path('/download.php');
$ralink_url->query('t=U0wyRnpjMlYwY3k4eU1ERXdMekF6THpNeEwyUnZkMjVzYjJGa01UWXpPRGs1T0Rnek5pNTZhWEE5UFQxU1ZESTROekJmUm1seWJYZGhjbVZmVmpJeUM=');

my $browser = LWP::UserAgent->new();
$browser->env_proxy( ); # in case  we're behind a firewall
$browser->timeout(30);
my $resp = $browser->get($ralink_url, ':content_file' => '/tmp/rt2870-firmware.zip'); 
die ':: oops, got error |', $resp->status_line, "|, exiting ...\n" unless $resp->is_success;

my $ae = Archive::Extract->new( archive => '/tmp/rt2870-firmware.zip' );
$ae->extract( to => '/tmp') or die ':: ', $ae->error, "\n";

my $new_firmware = $ae->extract_path . '/rt2870.bin';
my $old_firmware = '/lib/firmware/rt2870.bin';
die ":: you already have the latest firmware\n" if (compare($new_firmware, $old_firmware) == 0); 
copy ($new_firmware, $old_firmware) or die ":: copy failed: $!\n";
say ':: firmware updated successfully!';


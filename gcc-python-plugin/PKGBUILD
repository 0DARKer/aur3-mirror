# Maintainer: Allan McRae <allan@archlinux.org>

pkgname=('gcc-python-plugin')
pkgver=20110717
_gccver=4.6.1
pkgrel=1
pkgdesc="Allows the invoking of arbitrary Python scripts from inside the compiler"
arch=('i686' 'x86_64')
url="https://fedorahosted.org/gcc-python-plugin/"
license=('GPL3')
depends=("gcc=${_gccver}")
makedepends=('python' 'python2')
optdepends=('python: '
            'python2: ')


# temporary git build - will switch to released version once one is made...
_gitroot="git://git.fedorahosted.org/gcc-python-plugin.git"
_gitname="gcc-python-plugin"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"

  # build python3 plugin - currently fails
  #make plugin
  #mv python.so python3.so
  #rm -f *.o

  # build python2 plugin
  make PYTHON_CONFIG=python2-config plugin
  mv python.so python2.so
}

package() {
  cd "$srcdir/$_gitname-build"

  _plugindir=$pkgdir/usr/lib/gcc/i686-pc-linux-gnu/${_gccver}/plugin/

  install -dm755 ${_plugindir}
  install -m755 python2.so gccutils.py ${_plugindir}    # add python3.so when it builds

  cd ${_plugindir}
  # make python2 version the default until python3 plugin builds successfully
  ln -s python2.so python.so
}

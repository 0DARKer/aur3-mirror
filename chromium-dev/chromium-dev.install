set_pepperflash() {
        if [ -e  /usr/lib/chromium-dev/PepperFlash/manifest.json ] && [ -e /usr/lib/chromium-dev/PepperFlash/libpepflashplayer.so ]; then
            use_pepperflash=1
            flash_ver="$(cat /usr/lib/chromium-dev/PepperFlash/manifest.json | grep version | sed 's|[a-z,": ]*||g')"
        else
            use_pepperflash=0
        fi
}

update_resources() {
        xdg-icon-resource forceupdate --theme hicolor &> /dev/null
        update-desktop-database -q
}

instructions() {
  /bin/cat << EOF

=> To disable other flash plugins:
   Type chrome://plugins/ in the adress bar and press Enter
   Click on Details button on the top right
   Click on Disable near all the Flash plugins except the first one

EOF
}

post_install() {
        set_pepperflash
        [ "${use_pepperflash}" = "1" ] && sed '/CHROMIUM_FLAGS/s|"$| --ppapi-flash-path=/usr/lib/chromium-dev/PepperFlash/libpepflashplayer.so --ppapi-flash-version='$flash_ver'"|' -i /etc/chromium-dev/default
        instructions
        update_resources
}

post_upgrade() {
        set_pepperflash
        if [ "${use_pepperflash}" = "1" ]; then
            if [[ "$(cat etc/chromium-dev/default)" == *ppapi* ]]; then
                sed "s|ppapi-flash-version=[0-9.]*|ppapi-flash-version=$flash_ver|" -i /etc/chromium-dev/default
            else
                sed '/CHROMIUM_FLAGS/s|"$| --ppapi-flash-path=/usr/lib/chromium-dev/PepperFlash/libpepflashplayer.so --ppapi-flash-version='$flash_ver'"|' -i /etc/chromium-dev/default
            fi
            instructions
        elif [ "${use_pepperflash}" = "0" ]; then
            if [[ "$(cat etc/chromium-dev/default)" == *ppapi* ]]; then
                sed 's|--ppapi-flash-path=/usr/lib/chromium-dev/PepperFlash/libpepflashplayer.so --ppapi-flash-version=[0-9.]*||' -i /etc/chromium-dev/default
            fi
        fi
        update_resources
}

post_remove() {
        [ -e etc/chromium-dev/default ] && sed 's|--ppapi-flash-path=/usr/lib/chromium-dev/PepperFlash/libpepflashplayer.so --ppapi-flash-version=[0-9.]*||' -i /etc/chromium-dev/default
        update_resources
}

# Maintainer: Lone_Wolf <lonewolf at xs4all dot nl>
# Contributor: Tomohiro Takezawa <khabus {at} gmail.com>

pkgbase="cndrvcups-lips4"
pkgname="cndrvcups-lips4"
true && pkgname=('cndrvcups-lips4' 'cndrvcups-lips4-cpca')
pkgver=2.80
pkgrel=1
pkgdesc="Canon LIPS4 driver for some LBP and iR series printer, built from source"
arch=(x86_64)
license=('GPL2' 'custom')
url="http://cweb.canon.jp/drv-upd/lasershot/linux/lipssource.html"
depends=('libcups' "cndrvcups-common-lb")
source=(linux-lips4-sources-v280.tar.gz::'http://pdisp01.c-wss.com/gdl/WWUFORedirectTarget.do?id=MDEwMDAwNDE2MzA2&cmp=ACM&lang=EN')
options=('!emptydirs' '!strip' '!libtool')
sha512sums=('d60bf7d82fedf099425bb848872ac9681b19f5afe44b2bdea8a5b718643dd5ca3b0949aff6ec4d2e587904cc548d34ac3011f4115ae81d2511b2125a054fac77')

# build instructions are adapted from upstream cndrvcups-lips4.spec file

prepare() {
    cd "${srcdir}"/linux-lips4-sources-v280/Sources
    tar xf "${pkgbase}"-"${pkgver}"-1.tar.gz -C "${srcdir}"
}

package_cndrvcups-lips4-cpca() {
    
    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/cpca
    autoreconf -fi
    ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin --libdir=/usr/lib

    make
    mkdir -p "${pkgdir}"/usr/{include,lib}
    make install DESTDIR="${pkgdir}"
    
    install -m755 -d "${pkgdir}"/usr/share/licenses/"${pkgname}"
    install -m644 "${srcdir}"/"${pkgbase}"-"${pkgver}"/LICENSE-lips4-"${pkgver}".txt "${pkgdir}"/usr/share/licenses/"${pkgname}"
}

package_cndrvcups-lips4() {

    depends=('cndrvcups_lips4_cpca')
    
    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/driver
    autoreconf -fi
    ./autogen.sh --prefix=/usr --libdir=/usr/lib

    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/pstolipscpca
    autoreconf -fi
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin

    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/ppd
    autoreconf -fi
    ./autogen.sh --prefix=/usr 

    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/cngplp
    autoreconf -fi
    ./autogen.sh --prefix=/usr libdir=/usr/lib

    cd files
    autoreconf -fi
    ./autogen.sh --prefix=/usr

    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"
    mkdir -p "${pkgdir}"/usr/{bin,include,lib/cups/filter,share/{cngplp,cups/model}}

    for _dir in driver pstolipscpca ppd cngplp 
    do
      echo "compiling modules ${_dir} ..."
      cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/"${_dir}"
      make
    done
   
    for _dir in driver pstolipscpca ppd cngplp 
    do
      echo "Installing modules ${_dir} ..."
      cd "${srcdir}"/"${pkgbase}"-"${pkgver}"/"${_dir}"
      make install DESTDIR="${pkgdir}"
    done

    cd "${srcdir}"/"${pkgbase}"-"${pkgver}"
    install -c -m 4755 libs/cnpkmodulelips "${pkgdir}"/usr/bin
    
    install -m755 -d "${pkgdir}"/usr/share/licenses/"${pkgname}"
    install -m644 LICENSE-lips4-"${pkgver}".txt "${pkgdir}"/usr/share/licenses/"${pkgname}"
    install -m755 -d "${pkgdir}"/usr/share/doc/"${pkgname}"
    install -m644 "${srcdir}"/linux-lips4-sources-v280/Documents/guide-lips4-2.8x.tar.gz "${pkgdir}"/usr/share/doc/"${pkgname}"/guide-lips4-2.8x.tar.gz
}

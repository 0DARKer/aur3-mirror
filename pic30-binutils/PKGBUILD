# Contributor: Karolina Lindqvist <karolina.lindqvist@kramnet.se>

pkgname=pic30-binutils
pkgver=3.23
pkgrel=1
pkgdesc="PIC24/dsPIC30 binutils"
arch=(i686)
url="http://www.microchip.com"
license=('GPL')
makedepends=(hd2u)
source=(http://ww1.microchip.com/downloads/en/DeviceDoc/mplabalc30v${pkgver/./_}.tar.gz
    makefile_in.diff hardcode-device-info-path.diff
    allow-empty-device-info-file.diff macros.h version.diff
    resource.diff
    bfd.coff.diff bfd.elf.diff gas.coff.diff gas.elf.diff ld.elf.diff )

_obf=elf

build() {
  cd $srcdir/acme

  # Change DOS to UNIX
  find . -type f -exec dos2unix -U "{}" ';' || return 1
  find ../c30_resource/src/c30/ -type f -exec dos2unix -U "{}" ';' || return 1
  find ../c30_resource/src/generator/ -type f -exec dos2unix -U "{}" ';' || return 1
  patch -b -p0 < ../hardcode-device-info-path.diff || return 1
  patch -b -p0 < ../allow-empty-device-info-file.diff || return 1
  patch -b -p0 < ../makefile_in.diff || return 1
  patch -b -p0 < ../version.diff || return 1
  patch -b -p0 < ../resource.diff || return 1
  patch -b -p0 < ../gas.${_obf}.diff || return 1
  patch -b -p0 < ../bfd.${_obf}.diff || return 1
  patch -b -p0 < ../ld.${_obf}.diff || return 1
  cd gas
  aclocal -I ..
  autoconf
  cd ..
  echo "#define MCHP_VERSION v$pkgver for Arch Linux" >mchp_version.h
  ./configure -v --prefix=/usr --target=pic30 --mandir=/usr/share/man --includedir=/usr/pic30/include --libdir=/usr/pic30/lib --program-prefix=pic30- || return 1
  make || return 1
  make DESTDIR="$pkgdir/" install || return 1
#  cp $srcdir/c30_resource/src/c30/c30_device.info $pkgdir/usr/bin
  for f in as ld ar; do \
      ln $pkgdir/usr/bin/pic30-$f $pkgdir/usr/bin/pic30-$_obf-$f; \
  done
}
md5sums=('13d9f206aaebf1636cf747cbda6e9f3a'
         'd0441e26c4856efaa1a132e6f9528ef1'
         '6b09ef23f6b0c6a1c712fa93946c839c'
         'a239dcc23f6b172aa6d683856326b5f1'
         '927bf4a065a42b7e9847b44493aea588'
         '510402baaa9ed17fa606d35ebb72429e'
         '24cbdf9c9b173b435f7694b7d5e047dc'
         '9840849019a0589c2d96c688097f1f86'
         '5dc9bc0ab8ec040cd77a2ef0a8fa2733'
         'e98ba8b644a29f9fcc2082afd49ecdfe'
         '452e45a3b434cf9be2bb9f7259796dbe'
         'f4d0d271b4e402494db5713b17661500')

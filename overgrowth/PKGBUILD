# Maintainer: Gerardo Marset <gammer1994@gmail.com>

pkgname=overgrowth
_pkgname2=Overgrowth
pkgver=a180
pkgrel=1
pkgdesc="A 3d action-adventure game featurng anthropomorphic animals."
arch=('i686' 'x86_64')
url="http://www.wolfire.com/overgrowth"
license=('unknown')
makedepends=(xz)
depends=(alsa-lib freealut freeimage gconf gtk2 libjpeg6 libpng12 libtheora
         libvorbis libxss mesa nss sdl)
source=($pkgver-linux.sh GLSLversion120_fix.tar.gz)
md5sums=(3d22652639f1396537cc7a769bc54ecd
         cb0aea8d5ec50f60f5d0c441ac039b7f)
noextract=(GLSLversion120_fix.tar.gz)

_installdir="/usr/local/games/$pkgname"
[ "$CARCH" == "x86_64" ] && _suffix=_64
[ "$CARCH" == "x86_64" ] && _suffix2=64

build() {
    msg "Extracting installer..."
    chmod +x $pkgver-linux.sh
    ./$pkgver-linux.sh --tar -xvf

    msg "Extracting subarchive..."
    lzcat subarch | tar xvf -

    msg "Extracting common files..."
    mkdir -p $pkgdir/$_installdir
    cd $pkgdir/$_installdir
    lzcat $srcdir/instarchive_all | tar xvf -

    msg "Extracting arch-specific files..."
    lzcat $srcdir/instarchive_linux_x86$_suffix | tar xvf -

    msg "Applying GLSL patch..."
    cd Data/GLSL
    tar xzf $srcdir/GLSLversion120_fix.tar.gz
    chmod -x *
    cd ../..

    msg "Extracting awesomium..."
    lzcat $srcdir/deps/Awesomium/Awesomium_files_all | tar xvf -
    lzcat $srcdir/deps/Awesomium/Awesomium_files_linux_x86$_suffix | tar xvf -
    ln -s ../chrome.pak lib$_suffix2
    ln -s ../locales lib$_suffix2

    msg "Creating launcher..."
    mkdir -p $pkgdir/usr/bin
    f=$pkgdir/usr/bin/$pkgname
    echo "#!/bin/sh" > $f
    echo "" >> $f
    echo "cd $_installdir" >> $f
    echo "./overgrowth.bin.x86$_suffix $@" >> $f
    chmod +x $f

    mkdir -p $pkgdir/usr/share/{pixmaps,applications}
    cp overgrowth.png $pkgdir/usr/share/pixmaps/$pkgname.png
    f=$pkgdir/usr/share/applications/$pkgname.desktop
    echo "[Desktop Entry]" > $f
    echo "Categories=Game;ActionGame;" >> $f
    echo "Encoding=UTF-8" >> $f
    echo "Name=$_pkgname2" >> $f
    echo "Exec=$pkgname" >> $f
    echo "Icon=$pkgname" >> $f
    echo "Type=Application" >> $f
}

# Maintainer: Det <nimetonmaili@gmail.com>
# Contributor: speed145a/Jonny James <speed145a@aol.com>
# Contributor: Marius Dransfeld <marius.dransfeld@googlemail.com>

pkgname=songbird-svn
pkgver=19340
pkgrel=1
pkgdesc="An open-source customizable music player - SVN version"
arch=('i686')
url="http://www.songbirdnest.com/"
license=('GPL2')
makedepends=('subversion')
depends=('libxrender' 'libxext' 'libx11' 'libxmu' 'gstreamer0.10' 'gstreamer0.10-base' 'gtk2' 'libxt' 'sqlite3'
	 'nss' 'libidl2' 'gstreamer0.10-good-plugins')
optdepends=('gstreamer0.10-bad-plugins: support for more formats'
	    'gstreamer0.10-ffmpeg: support for more formats'
	    'gstreamer0.10-ugly-plugins: support for more formats')
conflicts=('songbird' 'songbird-auto-beta' 'songbird-auto-nightly' 'songbird-bin' 'songbird-nightly' 'songbird-nightly-bin'
	   'songbird-nightly-latest' 'songbird-stable-bin')
provides=("songbird=`date +%Y%m%d`")
install=songbird.install
source=('songbird-launcher.sh' 'Songbird.desktop')
md5sums=('afc2ad4ad4954e98af3703a1a07cd574'
         '1cc8162b07873920d17eea2033bd1820')

_svntrunk=http://publicsvn.songbirdnest.com/client/trunk
_svnmod=songbird
_svndependencies=http://publicsvn.songbirdnest.com/vendor-binaries/trunk/linux-i686

build() {
  cd ${srcdir}

  if [ -d ${_svnmod}/.svn ]; then
	(cd ${_svnmod} && svn up -r ${pkgver})
  else
	svn co ${_svntrunk} -r ${pkgver} ${_svnmod}
  fi

  msg "SVN checkout done or server timeout"

  msg "Checking out dependencies"

  cd ${srcdir}/${_svnmod}/dependencies/

  if [ -d .svn ]; then
	svn up -r ${pkgver}
  else
	svn co ${_svndependencies} -r ${pkgver}
   fi

  msg "SVN checkout done or server timeout"
  msg "Starting make..."
  cd ${srcdir}/${_svnmod}

  if [ -d clobber ]; then
 	make -f songbird.mk clobber || return 1
  fi
  make -f songbird.mk || return 1
}

package() {
  cd ${srcdir}/compiled/dist

  make DESTDIR="$pkgdir" install || return 1

  mkdir -p ${pkgdir}/opt/songbird/
  cd ${srcdir}/compiled/dist
  cp -r * ${pkgdir}/opt/songbird/

  install -d --group=users ${pkgdir}/opt/songbird
  cp -a ${srcdir}/Songbird_build-${REV}/* ${pkgdir}/opt/songbird || return 1
  chmod 755 ${pkgdir}/opt/songbird/songbird
  chmod 755 ${pkgdir}/opt/songbird/songbird-bin
  chmod 755 ${pkgdir}/opt/songbird/xulrunner/xulrunner
  chmod 755 ${pkgdir}/opt/songbird/xulrunner/xulrunner-bin
  chmod -R a+r ${pkgdir}/opt/songbird
  install -D ${srcdir}/Songbird_build-${REV}/chrome/icons/default/default.xpm \
	     ${pkgdir}/usr/share/pixmaps/Songbird.xpm
  install -D -m644 ${srcdir}/Songbird.desktop \
		   ${pkgdir}/usr/share/applications/Songbird.desktop
  install -d ${pkgdir}/usr/bin

  ## fixing the problem with system-wide installs:
  find ${pkgdir}/opt/songbird -type d -exec chmod 755 {} \;
  install --directory ${pkgdir}/usr/bin
  install ${srcdir}/songbird-launcher.sh ${pkgdir}/usr/bin/songbird
}
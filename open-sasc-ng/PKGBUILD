# Contributor: Juha-Matti "Suolx" Heikkala <jheikkal at gmail dot com>

pkgname=open-sasc-ng
pkgver=560
pkgrel=4
pkgdesc="OPEN-SASC-NG is SoftCAM creating virtual DVB interface"
url="http://85.17.209.13:6100"
arch=('i686' 'x86_64')
license=('GPL')
depends=('kernel26-headers' 'kernel26>=2.6.38' 'kernel26<2.6.39' 'sascng-kernel26-patch')
makedepends=('mercurial')
conflicts=(sasc-ng)
provides=(sasc-ng)
backup=('etc/camdir/cardclient.conf' 'etc/conf.d/sasc-ng')

source=('cardclient.conf' 'sasc-ng.rc' 'sasc-ng.conf' \
	'open-sasc-ng.lr' '2.6.38.patch')

md5sums=('81a4c25c1367f6e559b4495a0d6eb89a'
         '2e3a957978e7698f132254257a60533d'
         'def6a1da6e75757f1faa1d94686afc1b'
         '99be6670bc66d12640c9d82cc9bde3b5'
	 'a405b8ebe1b034656de0c935948f4425')

install='sasc-ng.install'

_hgroot=http://85.17.209.13:6100/
_hgrepo=sc


build() {

   cd ${srcdir}

  cd "$srcdir"
  msg "Connecting to Mercurial server...."
  if [ -d $_hgrepo ]; then
    cd $_hgrepo
    hg pull -u
    msg "The local files are updated."
  else
    hg clone $_hgroot/$_hgrepo $_hgrepo
  fi

  msg "Mercurial clone done or server timeout"
  msg "Starting make..."

   rm -rf "$srcdir/$_hgrepo-build"
   cp -r "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
   cd "$srcdir/$_hgrepo-build"

   msg "Applying patches..."
   
   patch -p1 < ${srcdir}/2.6.38.patch

   cd ${srcdir}
   msg "Starting make..."

   cd "$srcdir/$_hgrepo-build"
	
   chmod a+x $srcdir/$_hgrepo-build/contrib/sasc-ng/configure
   chmod a+x $srcdir/$_hgrepo-build/contrib/sasc-ng/makelinks.sh
   chmod a+x $srcdir/$_hgrepo-build/contrib/sasc-ng/dvbloopback/module/config_dvb.pl
   cd ${srcdir}/$_hgrepo-build/contrib/sasc-ng
   ./configure 
   make module || return 1
   make || return 1

   mkdir -p $startdir/pkg/usr/sbin
   mkdir -p $startdir/pkg/lib/modules/`uname -r`/extra
   mkdir -p $startdir/pkg/etc/{rc.d,conf.d}
   mkdir -p $startdir/pkg/etc/camdir
   mkdir -p $startdir/pkg/etc/logrotate.d/
   install -m0755 sasc-ng $startdir/pkg/usr/sbin/
   install -m0644 dvbloopback.ko $startdir/pkg/lib/modules/`uname -r`/extra
   install -m0755 ${srcdir}/sasc-ng.rc $startdir/pkg/etc/rc.d/sasc-ng
   install -m0644 ${srcdir}/sasc-ng.conf $startdir/pkg/etc/conf.d/sasc-ng
   install -m0644 ${srcdir}/cardclient.conf $startdir/pkg/etc/camdir/cardclient.conf
   install -m0644 ${srcdir}/open-sasc-ng.lr $startdir/pkg/etc/logrotate.d/open-sasc-ng.lr

}

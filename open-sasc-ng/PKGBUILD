# Contributor: Juha-Matti "Suolx" Heikkala <jheikkal at gmail dot com>

# This package is based on Tomasz Kontusz sasc-ng pkg

pkgname=open-sasc-ng
pkgver=560
pkgrel=3
pkgdesc="OPEN-SASC-NG is SoftCAM creating virtual DVB interface"
url="https://opensvn.csie.org/traccgi/opensascng/"
arch=('i686' 'x86_64')
license=('GPL')
depends=('kernel26-headers')
makedepends=('mercurial')
conflicts=(sasc-ng)
provides=(sasc-ng)
backup=('etc/camdir/cardclient.conf' 'etc/conf.d/sasc-ng')

source=('cardclient.conf' 'sasc-ng.rc' 'sasc-ng.conf' \
	'open-sasc-ng.lr' '2.6.34.patch' 'sascng-2.6.36.patch')

md5sums=('81a4c25c1367f6e559b4495a0d6eb89a'
         '2e3a957978e7698f132254257a60533d'
         'def6a1da6e75757f1faa1d94686afc1b'
         '99be6670bc66d12640c9d82cc9bde3b5'
	 'ac0f653302c6934ad1e0eb98aab0ea7b'
	 '946e4df125924eadab795de3820cadd0')

install='sasc-ng.install'

_hgroot=http://85.17.209.13:6100/
_hgrepo=sc


build() {

   cd ${srcdir}

   if [ -d ${_hgrepo} ]; then
       cd ${startdir}/src/${_hgrepo}
       hg pull -u
   else
       hg clone ${_hgroot}${_hgrepo} || return 1
       cd ${startdir}/src/${_hgrepo}
   fi

   msg "Mercurial clone done or server timeout"

   msg "Applying patches..."
   
   cd ${srcdir}
   patch -Np0 < ${startdir}/2.6.34.patch || return 1
   cd ${srcdir}/sc/contrib/sasc-ng/dvbloopback/module/
   patch -Np0 < ${startdir}/sascng-2.6.36.patch || return 1
   cd ${srcdir}
   msg "Starting make..."

   cd ${startdir}/src/${_hgrepo}
	
   chmod a+x ${srcdir}/sc/contrib/sasc-ng/configure
   chmod a+x ${srcdir}/sc/contrib/sasc-ng/makelinks.sh
   chmod a+x ${srcdir}/sc/contrib/sasc-ng/dvbloopback/module/config_dvb.pl
   cd ${srcdir}/sc/contrib/sasc-ng
   ./configure 
   make module || return 1
   make || return 1

   mkdir -p $startdir/pkg/usr/sbin
   mkdir -p $startdir/pkg/lib/modules/`uname -r`/extra
   mkdir -p $startdir/pkg/etc/{rc.d,conf.d}
   mkdir -p $startdir/pkg/etc/camdir
   mkdir -p $startdir/pkg/etc/logrotate.d/
   install -m0755 sasc-ng $startdir/pkg/usr/sbin/
   install -m0644 dvbloopback.ko $startdir/pkg/lib/modules/`uname -r`/extra
   install -m0755 ${srcdir}/sasc-ng.rc $startdir/pkg/etc/rc.d/sasc-ng
   install -m0644 ${srcdir}/sasc-ng.conf $startdir/pkg/etc/conf.d/sasc-ng
   install -m0644 ${srcdir}/cardclient.conf $startdir/pkg/etc/camdir/cardclient.conf
   install -m0644 ${srcdir}/open-sasc-ng.lr $startdir/pkg/etc/logrotate.d/open-sasc-ng.lr

}

# Maintainer:  Wessel Dirksen "p-we" <wdirksen at gmail dot com>
# Contributor: Juha-Matti "Suolx" Heikkala (previous maintainer)
# Contributor: bas-t (providing patch for kernels 3.7 and higher)

pkgname=open-sasc-ng
pkgver=620
pkgrel=4
pkgdesc="OPEN-SASC-NG is a SoftCAM creating virtual DVB interface"
url="http://85.17.209.13:6100"
arch=('i686' 'x86_64')
license=('GPL')
depends=('linux-headers')
makedepends=('mercurial')
conflicts=(sasc-ng)
provides=(sasc-ng)
install='sasc-ng.install'
backup=('etc/camdir/cardclient.conf' 'etc/conf.d/sasc-ng' 'etc/camdir/cardslot.conf')

_hgroot=http://85.17.209.13:6100
_hgrepo=sc
_build=sc-build

source=("$_hgrepo::hg+$_hgroot" \
	'cardclient.conf' 'sasc-ng.rc' 'sasc-ng.conf' \
	'open-sasc-ng.lr' 'sasc-599-or-lower.patch' 'config_dvb.pl.patch' \
        'sasc-ng.install' 'sasc-ng.service' 'kernel-37-or-higher.patch' \
	'cardslot.conf')

md5sums=('SKIP'
	 '3b547abcba9c0dda70b0d0a4b6e7311a'
         'bf4a6ef101aa5c8871381d336235ac0f'
         'c2e83b638cbbe839f11a2daf11b124fe'
         '99be6670bc66d12640c9d82cc9bde3b5'
         '2e7e5239935ab2a283bd3808e90735ae'
         '577e1834bb584e9c3d83dcd832fbb6f9'
         '06e59ccbdb089bba241d185e5cd54d49'
	 'ad0790e3d58fdf7eb29d74d83389681b'
	 '4f31f92c30fc3e8b20c9218001aff469'
	 '90baa862eb4da0c1e579ad003e51f2b0')

build() {
	rm -rf "$srcdir/$_build"
	cd "$srcdir"
		if [ -d "$_hgrepo" ]; then
			cd "$_hgrepo"
			hg pull -u -r "$pkgver"
		else
			hg clone -r "$pkgver $_hgroot/$_hgrepo $_hgrepo"
		fi
	cp -r "$srcdir/$_hgrepo" "$srcdir/$_build"

	cd "$srcdir/$_build"
	msg "Applying patches ..."
		if [ $pkgver -lt 600 ]; then
			patch -p1 < "$srcdir/sasc-599-or-lower.patch"
		fi
	patch -p1 < "$srcdir/config_dvb.pl.patch"
	patch -p1 < "$srcdir/kernel-37-or-higher.patch"   

	cd "$srcdir/$_build"
	chmod a+x "$srcdir/$_build/contrib/sasc-ng/configure"
	chmod a+x "$srcdir/$_build/contrib/sasc-ng/makelinks.sh"
	chmod a+x "$srcdir/$_build/contrib/sasc-ng/dvbloopback/module/config_dvb.pl"

	cd "$srcdir/$_build/contrib/sasc-ng"      
	./configure 
      
	make module || return 1
	make || return 1
}

package() {
	mkdir -p "$pkgdir/usr/sbin"
	mkdir -p "$pkgdir/usr/lib/modules/`uname -r`/extra"
	mkdir -p "$pkgdir/etc/conf.d"
	mkdir -p "$pkgdir/etc/rc.d"
	mkdir -p "$pkgdir/etc/camdir"
	mkdir -p "$pkgdir/etc/logrotate.d/"
	mkdir -p "$pkgdir/usr/lib/systemd/system/"
      
	install -m0755 "$srcdir/$_build/contrib/sasc-ng/sasc-ng" "$pkgdir/usr/sbin/"
	install -m0644 "$srcdir/$_build/contrib/sasc-ng/dvbloopback.ko" "$pkgdir/usr/lib/modules/`uname -r`/extra"
	install -m0755 "$srcdir/sasc-ng.rc" "$pkgdir/etc/rc.d/sasc-ng"
	install -m0644 "$srcdir/sasc-ng.conf" "$pkgdir/etc/conf.d/sasc-ng"
	install -m0644 "$srcdir/cardclient.conf" "$pkgdir/etc/camdir/cardclient.conf"
	install -m0644 "$srcdir/cardslot.conf" "$pkgdir/etc/camdir/cardslot.conf"
	install -m0644 "$srcdir/open-sasc-ng.lr" "$pkgdir/etc/logrotate.d/open-sasc-ng.lr"
	install -m0644 "$srcdir/sasc-ng.service" "$pkgdir/usr/lib/systemd/system/sasc-ng.service"
}

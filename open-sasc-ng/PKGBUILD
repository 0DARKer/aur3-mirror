# Maintainer:  Wessel Dirksen "p-we" <wdirksen at gmail dot com>
# Contributor: Juha-Matti "Suolx" Heikkala (previous maintainer)
# Contributor: bas-t (providing kernels 3.7 patch and GIT repo)
# Contributor: Petr Vacek (input with PKGBUILD and cardslot.conf for serial port SC readers)

# There are 2 choices for pkgver, define as needed:
# stable - based on stable version 570
# latest - most recent version

pkgver=stable

pkgname=open-sasc-ng
pkgrel=1
pkgdesc="A SoftCAM creating virtual DVB interface"
url="https://github.com/bas-t/sasc.git"
arch=('i686' 'x86_64')
license=('GPL')
depends=('linux-headers')
makedepends=('git')
conflicts=(sasc-ng)
provides=(sasc-ng)
backup=('etc/camdir/cardclient.conf' 'etc/conf.d/sasc-ng' 'etc/camdir/cardslot.conf')
install='sasc-ng.install'

  if [ "$pkgver" == "stable" ]; then
  	_gitbranch="3.7-or-higher-kernel"  
  else
  	_gitbranch="rev-620"
  fi

_gitroot="git://github.com/bas-t/sasc.git"
_gitdir="sc"
_gitbuild="sc-build"

source=('cardclient.conf' 'sasc-ng.rc' 'sasc-ng.conf' \
	'open-sasc-ng.lr' 'cardslot.conf' 'sasc-ng.service' \
	'sasc-ng.install' 'kernel-37-or-higher.patch')

md5sums=('3b547abcba9c0dda70b0d0a4b6e7311a'
         'bf4a6ef101aa5c8871381d336235ac0f'
         'c2e83b638cbbe839f11a2daf11b124fe'
         '99be6670bc66d12640c9d82cc9bde3b5'
	 '90baa862eb4da0c1e579ad003e51f2b0'
	 'ad0790e3d58fdf7eb29d74d83389681b'
	 '06e59ccbdb089bba241d185e5cd54d49'
	 'b8f97d097c5a6ffbf698ee87bae7d3c4')

build() {
	rm -rf "$srcdir/$_gitdir"
	rm -rf "$srcdir/$_gitbuild"
	git clone -b "$_gitbranch" "$_gitroot" "$_gitdir"
	cp -r "$srcdir/$_gitdir" "$srcdir/$_gitbuild"
	cd "$srcdir/$_gitbuild"

	  if [ "$_gitbranch" == "rev-620" ]; then
		  patch -p1 < "$srcdir/kernel-37-or-higher.patch"
	  fi

	chmod a+x "$srcdir/$_gitbuild/contrib/sasc-ng/configure"
	chmod a+x "$srcdir/$_gitbuild/contrib/sasc-ng/makelinks.sh"
	chmod a+x "$srcdir/$_gitbuild/contrib/sasc-ng/dvbloopback/module/config_dvb.pl"

	cd "$srcdir/$_gitbuild/contrib/sasc-ng"      
	./configure 
      
	make module || return 1
	make || return 1
}

package() {
	mkdir -p "$pkgdir/usr/sbin"
	mkdir -p "$pkgdir/usr/lib/modules/`uname -r`/extra"
	mkdir -p "$pkgdir/etc/conf.d"
	mkdir -p "$pkgdir/etc/rc.d"
	mkdir -p "$pkgdir/etc/camdir"
	mkdir -p "$pkgdir/etc/logrotate.d/"
	mkdir -p "$pkgdir/usr/lib/systemd/system/"
      
	install -m0755 "$srcdir/$_gitbuild/contrib/sasc-ng/sasc-ng" "$pkgdir/usr/sbin/"
	install -m0644 "$srcdir/$_gitbuild/contrib/sasc-ng/dvbloopback.ko" "$pkgdir/usr/lib/modules/`uname -r`/extra"
	install -m0755 "$srcdir/sasc-ng.rc" "$pkgdir/etc/rc.d/sasc-ng"
	install -m0644 "$srcdir/sasc-ng.conf" "$pkgdir/etc/conf.d/sasc-ng"
	install -m0644 "$srcdir/cardclient.conf" "$pkgdir/etc/camdir/cardclient.conf"
	install -m0644 "$srcdir/cardslot.conf" "$pkgdir/etc/camdir/cardslot.conf"
	install -m0644 "$srcdir/open-sasc-ng.lr" "$pkgdir/etc/logrotate.d/open-sasc-ng.lr"
	install -m0644 "$srcdir/sasc-ng.service" "$pkgdir/usr/lib/systemd/system/sasc-ng.service"
}

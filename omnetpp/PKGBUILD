pkgname="omnetpp"
pkgver=3.4b2
pkgrel=3
pkgdesc="OMNeT++ is a discrete event simulation environment"
url="http://www.omnetpp.org"
license="Academic Public License"
depends=(graphviz giftrans blt)
makedepends=(libxml2)
arch=('i686' 'x86_64')
source=(http://www.omnetpp.org/download/release/${pkgname}-${pkgver}-src.tgz
	'omnetpp-3.4b2.patch')
md5sums=('ea7f427d942f2439494869745423e453'
	 '1db7ec020e3fffb026c0954dc86bc7e7')

build() {
	cd ${startdir}/src/${pkgname}-${pkgver}
	PATH=$PATH:${startdir}/src/${pkgname}-${pkgver}/bin
	LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${startdir}/src/${pkgname}-${pkgver}/lib 
	
	# patches
	cat ${startdir}/src/omnetpp-3.4b2.patch | patch -p 0 || return 1 
	sed "s|#OMNETPP_BITMAP_PATH=\"./bitmaps;\$OMNETPP_ROOT/bitmaps\"|OMNETPP_BITMAP_PATH=\"./bitmaps;/usr/share/omnetpp/bitmaps\"|" -i configure.user
	
	# configure
	./configure --prefix=/usr
	make || return 1
	
	# install binaries
	mkdir -p ${startdir}/pkg/usr/bin
	install -m755 bin/* ${startdir}/pkg/usr/bin

	# change directories in opp_makemake
	sed "s|${startdir}/src/${pkgname}-${pkgver}|/usr|g" -i ${startdir}/pkg/usr/bin/opp_makemake
	sed "s|OMNETPP_INCL_DIR=/usr/include|OMNETPP_INCL_DIR=/usr/include/omnetpp|" -i ${startdir}/pkg/usr/bin/opp_makemake
	
	# install libs
	mkdir -p ${startdir}/pkg/usr/lib
	install lib/* ${startdir}/pkg/usr/lib

	# install includes
	mkdir -p ${startdir}/pkg/usr/include/omnetpp
	mkdir -p ${startdir}/pkg/usr/include/omnetpp/platdep
	install -m644 include/*.h ${startdir}/pkg/usr/include/omnetpp
	install -m644 include/platdep/*.h ${startdir}/pkg/usr/include/omnetpp/platdep
	
	# install demos,doc and bitmaps
	install -d ${startdir}/pkg/usr/share/omnetpp/{bitmaps,doc,samples}
	cp -R bitmaps/* ${startdir}/pkg/usr/share/omnetpp/bitmaps
	cp -R doc/* ${startdir}/pkg/usr/share/omnetpp/doc
	cp -R samples/* ${startdir}/pkg/usr/share/omnetpp/samples
	
}

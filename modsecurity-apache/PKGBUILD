# Contributor: dethwish <richiefrich AT penguinslair DOT org>

pkgname=modsecurity-apache
pkgver=2.5.9
pkgrel=1
pkgdesc="An open source web application firewall that runs as an Apache module."
url="http://www.modsecurity.org"
arch=('i686' 'x86_64')
license=('GPL')
depends=('libxml2' 'lua' 'apache' 'abs')
optdepends=()
backup=('/etc/httpd/conf/mod_security.conf' '/etc/httpd/conf/httpd.conf' '/etc/mlogc.conf')
source=(http://softlayer.dl.sourceforge.net/sourceforge/mod-security/${pkgname}_${pkgver}.tar.gz ftp://penguinslair.org/mod_security.conf)
md5sums=('b7bf44a7e041b49b0da5043495660375'
         '91f22c63d16698c1f6c81d4295d047ec')

build() {

cat << ENDOFMESSAGE

 ==>	Getting Apache Source
 ==>	Then running ./configure for the following
 ==>	
 ==>	{apxs, pcre, apr, apu} to build mod_security in DSO mode
 ==>	
 ==>	Press Enter to Begin

ENDOFMESSAGE

	read

	if [ -d /var/abs/extra/apache ] ; then  continue ; else abs extra ; fi
	cd /var/abs/extra/apache
	rm -fr  /var/abs/extra/apache/src/
	makepkg -o -f --asroot
	cd /var/abs/extra/apache/src/httpd-2.2.11/srclib/apr/ ;./configure
	cd /var/abs/extra/apache/src/httpd-2.2.11/srclib/pcre/ ; ./configure
	cd /var/abs/extra/apache/src/httpd-2.2.11/srclib/apr-util/ ; ./configure --with-apr=../apr

cat << ENDOFMESSAGE

 ==>	Starting download for mod_security
 ==>	Then unpacking and applying the {apxs, pcre, apr, apu} to build mod_security
 ==>	
 ==>	Press Enter to Begin

ENDOFMESSAGE

	read

	cd ${srcdir}/${pkgname}_${pkgver}/apache2

	mkdir -p ${pkgdir}/usr/bin
#	mkdir -p ${pkgdir}/etc/httpd/conf/modsecurity
	mkdir -p ${pkgdir}/usr/lib/httpd/modules

	./configure --prefix=${pkgdir}/usr \
#	--enable-performance-measurement \
	--with-httpd-src=/var/abs/extra/apache/src/httpd-2.2.11/ \
	--with-pcre=/var/abs/extra/apache/src/httpd-2.2.11/srclib/pcre \
	--with-apr=/var/abs/extra/apache/src/httpd-2.2.11/srclib/apr/apr-1-config \
	--with-apu=/var/abs/extra/apache/src/httpd-2.2.11/srclib/apr-util/apu-1-config
	make || return 1
	make test || return 1
	make mlogc || return 1
	make install
	#make clean

	cp /usr/lib/httpd/modules/mod_security2.so ${pkgdir}/usr/lib/httpd/modules/
	rm -f /usr/lib/httpd/modules/mod_security2.so


cat << ENDOFMESSAGE

 ==>	Ready to update your config files.
 ==>	
 ==>	Press Enter to Begin

ENDOFMESSAGE

	read


MODSECCONF=$(find /etc/httpd/conf/ -maxdepth 1 -iname "*security*" -type f -print)
MODSECFILE=$(find /etc/httpd/conf/ -maxdepth 1 -iname "*security*" -type f -print | sed 's/^.*\///')
MODSECDIR=$(find /etc/httpd/ -iname "*security*" -type d -print)


#/etc/httpd/conf.d/modsecurity and /etc/httpd/conf.d/modsecurity/optional
	[ ${pkgdir}/../mod_security.conf != $MODSECFILE ] && mv ${pkgdir}/../mod_security.conf ${pkgdir}/../$MODSECFILE

	[ -f $MODSECCONF ] && mv $MODSECCONF $MODSECCONF.`date +%F`
	[ -f /etc/httpd/conf/httpd.conf ] && cp -v /etc/httpd/conf/httpd.conf ${pkgdir}/etc/httpd/conf/httpd.conf ; mv /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.`date +%F`.conf

	mkdir -p ${pkgdir}$MODSECDIR
	rsync -aP ${srcdir}/${pkgname}_${pkgver}/rules/ ${pkgdir}$MODSECDIR
        cp -v ${pkgdir}/../$MODSECFILE ${pkgdir}$MODSECCONF
	cp -v ${srcdir}/${pkgname}_${pkgver}/apache2/mlogc-src/mlogc ${pkgdir}/usr/bin/
	cp -v ${srcdir}/${pkgname}_${pkgver}/apache2/mlogc-src/mlogc-default.conf ${pkgdir}/etc/mlogc.conf


#	[ -f /etc/httpd/conf/mod_security.conf ] && mv /etc/httpd/conf/mod_security.conf /etc/httpd/conf/mod_security.`date +%Y-%m-%d`.conf
#	[ -f /etc/httpd/conf/httpd.conf ] && cp -v /etc/httpd/conf/httpd.conf ${pkgdir}/etc/httpd/conf/httpd.conf ; mv /etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.`date +%Y-%m-%d`.conf

#	rsync -aP ${srcdir}/${pkgname}_${pkgver}/rules/ ${pkgdir}/etc/httpd/conf/modsecurity
#       cp -v ${pkgdir}/../mod_security.conf ${pkgdir}/etc/httpd/conf/mod_security.conf
#	cp -v ${srcdir}/${pkgname}_${pkgver}/apache2/mlogc-src/mlogc ${pkgdir}/usr/bin/
#	cp -v ${srcdir}/${pkgname}_${pkgver}/apache2/mlogc-src/mlogc-default.conf ${pkgdir}/etc/mlogc.conf

	

sed -i 's/Inc.*security.*conf//' ${pkgdir}/etc/httpd/conf/httpd.conf
echo Include $MODSECCONF >> ${pkgdir}/etc/httpd/conf/httpd.conf


#cat >> ${pkgdir}/etc/httpd/conf/httpd.conf << "EOF"

## Added via mod_security 2.5.7 install
#Include /etc/httpd/conf/mod_security.conf

#EOF


cat << ENDOFMESSAGE

 ==> Your /etc/httpd/conf/httpd.conf file has been modified.
 ==> The following basic modsecurity config has been included as
 ==> /etc/httpd/conf/mod_security.conf.
 ==> 
 ==> Make sure you download the ModSecurity Core Rules from
 ==> the ModSecurity website (http://www.modsecurity.org).

 ==> Your original files were backed up
 ==>
 ==> From:                              To:
 ==>
 ==> /etc/httpd/conf/mod_security.conf  /etc/httpd/conf/mod_security.`date +%F`.conf
 ==> /etc/httpd/conf/httpd.conf         /etc/httpd/conf/httpd.`date +%F`.conf

ENDOFMESSAGE

}

# Maintainer: JÃ¶rg Hansen (joerg dot hansen at ymail dot com)

pkgname=osm2pgsql-git
pkgver=r686.f7ebc1d
pkgrel=1
pkgdesc="Utility program that converts OpenStreetMap (.OSM) data into a format that can be loaded into PostgreSQL."
arch=(i686 x86_64)
url="http://wiki.openstreetmap.org/wiki/Osm2pgsql"
license=('GPL')
depends=('postgis' 'libxml2' 'bzip2' 'zlib' 'protobuf-c')
makedepends=('git' 'libtool')

_gitroot=https://github.com/openstreetmap/osm2pgsql.git
_gitname=osm2pgsql

pkgver() {

    cd "$srcdir/$_gitname-build"
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"

}

build() {

    cd $srcdir

    msg "Connecting to GIT server...."

    if [[ -d "$_gitname" ]]; then
        cd "$_gitname"
        git pull origin
        msg "The local files are updated."
    else
        git clone "$_gitroot" "$_gitname"
    fi

    msg "GIT checkout done or server timeout"

    if [[ -d $srcdir/$_gitname-build ]]; then
        msg "Removing previous build directory"
        rm -rf $srcdir/$_gitname-build
    fi

    msg "Creating build directory..."
    git clone $srcdir/$_gitname $srcdir/$_gitname-build

    msg "Configuring..."
    cd $srcdir/$_gitname-build
    ./autogen.sh
    LDFLAGS='' ./configure --prefix=/usr

    msg "Compiling..."
    make

}

package() {

    msg "Installing..."
    cd $srcdir/$_gitname-build
    make DESTDIR="$pkgdir" install

    msg "Additional files..."
    mkdir -p ${pkgdir}/usr/share/doc/osm2pgsql
    install -m644 README ${pkgdir}/usr/share/doc/osm2pgsql
    install -m644 900913.sql ${pkgdir}/usr/share/osm2pgsql

    msg "Cleaning up..."
    find $pkgdir -type f -name "*\.la" -exec rm {} \;

}

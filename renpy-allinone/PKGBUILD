# Maintainer: Cravix < dr dot neemous at gmail dot com >
# combination of renpy and python-renpy PKGBUILD written by AlexanderR <rvacheva at nxt dot ru>
# the motivation is simple: i don't want to download the same file twice.
pkgbase=renpy-allinone
pkgname=renpy-allinone
true && pkgname=(renpy-aio python-renpy-aio renpy-allinone)
_pkgname=renpy
pkgver=6.17.3
pkgrel=1
pkgdesc="Visual novel engine Ren'Py along with its platdeps libs (release version)"
arch=('i686 x86_64')
license=('MIT')
url='http://www.renpy.org'
depends=('ttf-dejavu' 'ffmpeg' 'fribidi' 'glew' 'python2-pygame')
makedepends=('cython2')
provides=("python-renpy=$pkgver" 	"renpy=$pkgver")
replaces=('renpy-bin' 'renpy64' 'python-renpy' 'renpy')
conflicts=('renpy-bin' 'renpy64' 'python-renpy' 'renpy')
optdepends=('tk: renpy project directory selection dialog')
replaces=('renpy64')
install=renpy.install
source=("http://www.renpy.org/dl/$pkgver/$_pkgname-$pkgver-source.tar.bz2"
        "${_pkgname}.desktop"
        "${_pkgname}."{sh,csh}
        "${_pkgname}-launcher.sh")

md5sums=('bc8118128c5fd9aaeaa848bc122b0c03'
         'a9beb35fa6c6d8af7ba5d2a764c33158'
         'd206d24b78e207a2c3b603fef14ac47f'
         '8b9922e26e567248a2a5adc1d0cdfdd4'
         'dfa92cdecc15e5c1ddee387fbbbb2d9c')

# a rough fix for the too-new fribidi
# again, we pay the price, watson, for being too up-to-date! yay
export CFLAGS="$CFLAGS $(pkg-config --cflags fribidi)"

build() {
	cd "$srcdir/renpy-$pkgver-source"
	find . -name "*.py" -exec sed -i 's/env python$/env python2/' {} \;
	RENPY_CYTHON=/usr/bin/cython2 python2 module/setup.py build
}

package_renpy-aio(){
	pkgdesc="Ren'Py is a visual novel engine that helps you use words, images, and sounds to tell stories with the computer. Both player and development tools included."
	arch=('any')
	depends=('ttf-dejavu' 'python-renpy')
	provides=("renpy=$pkgver")
	conflicts=('renpy-bin' 'renpy64' 'renpy')
	replaces=('renpy64')

	mkdir -p "$pkgdir/"{usr/share/{${pkgname%-*},doc/${pkgname%-*}},etc/profile.d}

	cd "$srcdir"

	install -m755 ${pkgname%-*}.{sh,csh} "$pkgdir/etc/profile.d"
	install -D -m755 ${pkgname%-*}-launcher.sh "$pkgdir/usr/bin/${pkgname%-*}"
	install -D -m644 ${pkgname%-*}.desktop "$pkgdir/usr/share/applications/${pkgname%-*}.desktop"

	cd ${pkgname%-*}-$pkgver-source

	cp -r launcher renpy renpy.py	templates the_question tutorial "$pkgdir/usr/share/${pkgname%-*}"
	cp -r doc/* "$pkgdir/usr/share/doc/${pkgname%-*}"
	install -D -m644 launcher/game/images/logo.png "$pkgdir/usr/share/pixmaps/${pkgname%-*}.png"
	install -D -m644 'LICENSE.txt' "$pkgdir/usr/share/licenses/${pkgname%-*}/LICENSE"

	chgrp -R games "$pkgdir"/usr/share/renpy/{the_question,tutorial}
	chmod g+w "$pkgdir"/usr/share/renpy/{the_question,tutorial}
}

package_python-renpy-aio() 
{
	pkgdesc="Platform-dependant Ren'Py libraries."
	depends=('ffmpeg' 'fribidi' 'glew' 'python2-pygame')
	provides=("python-renpy=$pkgver")
	conflicts=('renpy64' 'renpy-bin' 'python-renpy')
	install=

	cd "$srcdir"/$_pkgname-${pkgver}-source

	RENPY_CYTHON=/usr/bin/cython2 python2 module/setup.py install --root="$pkgdir/" --prefix=/usr
	install -D -m644 'LICENSE.txt' "$pkgdir/usr/share/licenses/${pkgname%-*}/LICENSE"
}

package_renpy-allinone()
{
	pkgdesc="why i create an empty package? yeah, right, to make it much easier for you to update."
	depends=("renpy>=$pkgver" "python-renpy>=$pkgver")
	provides=()
	conflicts=()
	install=
}

#seems silly, right? no, i just let you can see real deps and mkdeps in aur page.
pkgdesc="Visual novel engine Ren'Py along with its platdeps libs (release version)"
depends=('ttf-dejavu' 'ffmpeg' 'fribidi' 'glew' 'python2-pygame')

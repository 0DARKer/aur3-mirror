# puppet-server: Installer: Arch
# Maintainer: Niels Abspoel <aboe76 (at) Gmail (dot) com>

# RC style, reserved for later use
##pkgname=puppet-server
#_rc=1
#_pkgver=2.0.0
#pkgver=${_pkgver}_rc${_rc}

pkgname=puppetserver
pkgver=0.2.2
pkgrel=3
pkgdesc="Puppet master Server"
arch=("any")
url="http://puppetlabs.com/projects/puppet-server/"
license=("APACHE")
depends=("ruby" "puppet" "jre7-openjdk" )
provides=("puppetserver" "puppet-server")
backup=('etc/puppetserver/conf.d/puppetserver.conf'
        'etc/puppetserver/conf.d/webserver.conf'
        'etc/puppetserver/conf.d/os-settings.conf'
        'etc/puppetserver/conf.d/global.conf')
install="puppetserver.install"
source=("http://downloads.puppetlabs.com/puppet/$pkgname-${pkgver//_/-}.tar.gz"
        "puppetserver.service"
        "puppetserver.sysconfig"
        ".AURINFO")
md5sums=('1c946a9cb4d10fcf991fb46a5ce32d7e'
         'c09a6a57080af3a98d13b2a990cd2f92'
         'f6d35c104af6ef609c0d989c7146e5d9'
         SKIP) 
package () {
  cd "${srcdir}/${pkgname}-${pkgver//_/-}"

  #params for build and configure:
  unset DESTDIR
  unset prefix
  unset puppet_libdir
  export prefix=/usr
  export DESTDIR=${pkgdir}
  puppet_libdir=`ruby -rrbconfig -e 'puts RbConfig::CONFIG["vendorlibdir"]'`

  # install puppet-server 
  make -e install-puppetserver

  # os-settings.conf
  echo "os-settings: {" > "${pkgdir}/etc/${pkgname}/conf.d/os-settings.conf"
  echo "    ruby-load-path: [${puppet_libdir}]" >> "${pkgdir}/etc/${pkgname}/conf.d/os-settings.conf"
  echo "}" >> "${pkgdir}/etc/${pkgname}/conf.d/os-settings.conf"
  
  #create logdir:
  mkdir -p "$pkgdir"/var/log/${pkgname}

  #create jruby-gems
  mkdir -p "$pkgdir"/var/lib/puppet/jruby-gems

  #archlinux specific systemd because of java binary in other place.
  install -D -m644 "${startdir}/puppetserver.service" "${pkgdir}/usr/lib/systemd/system/${pkgname}.service"
  install -D -m644 "${startdir}/puppetserver.sysconfig" "${pkgdir}/etc/sysconfig/${pkgname}"

}
# vim: set ft=sh ts=2 sw=2 et:

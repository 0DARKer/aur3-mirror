#!/bin/sh

######################
# BEGIN PRETTY PRINT #
######################
source `which nvprettyprint`
ppbegin
####################
# END PRETTY PRINT #
####################

##################
# BEGIN PRECHECK #
##################
if [ $(whoami) != root ]; then
	pperror "Failed: "
	ppwarning "you must run ${0} as root\n"
	exit 1
fi
################
# END PRECHECK #
################

#####################
# BEGIN ERROR CHECK #
#####################
function failed() {
	CODE=${1}
	pperror "Failed: "
	case ${CODE} in
		1)
			ppwarning "nVidia graphics card could not be turned off\n"
			;;
		2)
			ppwarning "nvidia kernel module could not be unloaded\n"
			;;
		3)
			ppwarning "bumblebee service could not be stopped\n"
			;;
	esac
	exit 1
}
function succeeded() {
	CODE=${1}
	ppinfo "Success: "
	case ${CODE} in
		1)
			ppwarning "nVidia graphics card turned off\n"
			;;
		2)
			ppwarning "nvidia kernel module unloaded\n"
			;;
		3)
			ppwarning "bumblebee service stopped\n"
			;;
	esac
}
###################
# END ERROR CHECK #
###################

########################
# BEGIN DISABLING CARD #
########################
#Check if bumblebee service is stopped
if rc.d list started | grep -i STARTED.*bumblebee$ >/dev/null; then
	pptitle "Stopping bumblebee service..."
	rc.d stop bumblebee
	if ! rc.d list started | grep -i STARTED.*bumblebee$ >/dev/null; then
		succeeded 3
	else
		failed 3
	fi
fi

#Check if nvidia module is still loaded
if lsmod | grep nvidia >/dev/null; then
	pptitle "Unloading nvidia kernel module..."
	modprobe -r nvidia
	if ! lsmod | grep nvidia >/dev/null; then
		succeeded 2
	else
		failed 2
	fi
fi

#Turn off the nVidia card if it isn't already off
if lspci -vnnn | grep -i vga | grep -i nvidia | grep -i "vga controller" >/dev/null; then
	pptitle "Turning off nVidia graphics card..."
	#If it is on, then turn it off
	nvpwrctl off
	if ! lspci -vnnn | grep -i vga | grep -i nvidia | grep -i "vga controller" >/dev/null; then
		succeeded 1
	else
		failed 1
	fi
fi
######################
# END DISABLING CARD #
######################

#################
# BEGIN CLEANUP #
#################
ppend
###############
# END CLEANUP #
###############

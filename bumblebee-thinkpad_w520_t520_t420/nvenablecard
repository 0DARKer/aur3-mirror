#!/bin/sh

######################
# BEGIN PRETTY PRINT #
######################
source `which nvprettyprint`
ppbegin
####################
# END PRETTY PRINT #
####################

##################
# BEGIN PRECHECK #
##################
if [ $(whoami) != root ]; then
	pperror "Failed: "
	ppwarning "you must run ${0} as root\n"
	exit 1
fi
################
# END PRECHECK #
################

#####################
# BEGIN ERROR CHECK #
#####################
function failed() {
	CODE=${1}
	pperror "Failed: "
	case ${CODE} in
		1)
			ppwarning "nVidia graphics card could not be turned on\n"
			;;
		2)
			ppwarning "nvidia kernel module could not be loaded\n"
			;;
		3)
			ppwarning "bumblebee service could not be started\n"
			;;
	esac
	exit 1
}
function succeeded() {
	CODE=${1}
	ppinfo "Success: "
	case ${CODE} in
		1)
			ppwarning "nVidia graphics card turned on\n"
			;;
		2)
			ppwarning "nvidia kernel module loaded\n"
			;;
		3)
			ppwarning "bumblebee service started\n"
			;;
	esac
}
###################
# END ERROR CHECK #
###################

#######################
# BEGIN ENABLING CARD #
#######################
#Check if nVidia card is already on
if ! lspci -vnnn | grep -i vga | grep -i nvidia | grep -i "vga controller" >/dev/null; then
	pptitle "Turning on nVidia graphics card..."
	#If not, then turn it on
	nvpwrctl on
	if lspci -vnnn | grep -i vga | grep -i nvidia | grep -i "vga controller" >/dev/null; then
		succeeded 1
	else
		failed 1
	fi
fi

#Check if nvidia module is loaded
if ! lsmod | grep nvidia >/dev/null; then
	pptitle "Loading nvidia kernel module..."
	modprobe nvidia
	if lsmod | grep nvidia >/dev/null; then
		succeeded 2
	else
		failed 2
	fi
fi

#Check if bumblebee service is started
if ! ps a | grep /usr/sbin/bumblebee\ \-d | grep -v grep >/dev/null; then
	pptitle "Starting bumblebee service..."
	rc.d start bumblebee
#	New version of bumblebee not listed in "rc.d list started" for some reason
#	if rc.d list started | grep -i STARTED.*bumblebee$ >/dev/null; then
	if ps a | grep /usr/sbin/bumblebee\ \-d | grep -v grep >/dev/null; then
		succeeded 3
	else
		failed 3
	fi
fi
#####################
# END ENABLING CARD #
#####################

#################
# BEGIN CLEANUP #
#################
ppend
###############
# END CLEANUP #
###############

# Maintainer: graysky <graysky AT archlinux DOT us>
# Contributer: Ionut Biru <ibiru@archlinux.org>
pkgname=('virtualbox-guest-modules-ck')
pkgver=4.0.8
pkgrel=1
arch=('i686' 'x86_64')
url='http://virtualbox.org'
license=('GPL' 'custom')
makedepends=('libstdc++5' 'bin86' 'dev86' 'iasl' 'libxslt' 'libxml2' 'libxcursor' 'qt' 'libidl2' 'sdl_ttf' 'alsa-lib' 'libpulse' 'libxtst'
'xalan-c' 'sdl' 'libxmu' 'curl' 'python2' 'kernel26-ck-headers>=2.6.38' 'mesa' 'libxrandr' 'libxinerama' 'libvncserver' 'jdk' 'gsoap' 'vde2'
'xorg-server-devel' 'xf86driproto' 'libxcomposite')
#[[ $CARCH == "x86_64" ]] && makedepends=("${makedepends[@]}" 'gcc-multilib' 'lib32-glibc')
source=(http://download.virtualbox.org/virtualbox/${pkgver}/VirtualBox-${pkgver}.tar.bz2
        virtualbox-4-makeself-check.patch virtualbox-4-mkisofs-check.patch
        10-vboxdrv.rules 60-vboxguest.rules vboxdrv-reference.patch LocalConfig.kmk vboxdrv.sh
        18-system-xorg.patch
        change_default_driver_dir.patch)
_kernver=2.6.39-ck

build() {
    cd "$srcdir/VirtualBox-${pkgver}_OSE"

    patch -Np1 -i "$srcdir/virtualbox-4-makeself-check.patch"
    patch -Np1 -i "$srcdir/virtualbox-4-mkisofs-check.patch"
    patch -Np1 -i "$srcdir/vboxdrv-reference.patch"
    patch -Np1 -i "$srcdir/18-system-xorg.patch"
    patch -Np1 -i "$srcdir/change_default_driver_dir.patch"

    cp "$srcdir/LocalConfig.kmk" .

    ./configure --disable-docs \
        --enable-webservice \
        --enable-vde \
        --with-linux=/usr/src/linux-${_kernver}
    source ./env.sh
    kmk all

    export KERN_DIR=/usr/src/linux-${_kernver}
    make -C "$srcdir/VirtualBox-${pkgver}_OSE/out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions/src"
    make -C "$srcdir/VirtualBox-${pkgver}_OSE/out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions/src/vboxvideo"
    sed -i 's_^#!.*/usr/bin/python_#!/usr/bin/python2_' "out/linux.$BUILD_PLATFORM_ARCH/release/bin/vboxshell.py"
}

package() {
    pkgdesc="VirtualBox kernel modules for Linux guests running kernel26-ck."
    license=('GPL')
    install=virtualbox-guest-modules.install
    depends=('kernel26-ck>=2.6.39' 'kernel26-ck<2.6.40')
    replaces=('virtualbox-ose-additions-modules')
    conflicts=('virtualbox-ose-additions-modules')

    source "$srcdir/VirtualBox-${pkgver}_OSE/env.sh"

    cd "$srcdir/VirtualBox-${pkgver}_OSE/out/linux.$BUILD_PLATFORM_ARCH/release/bin/additions/src"

    cd vboxguest
    install -D -m644 vboxguest.ko \
        "$pkgdir/lib/modules/$_kernver/misc/vboxguest.ko"

    cd ../vboxsf
    install -D -m644 vboxsf.ko \
        "$pkgdir/lib/modules/$_kernver/misc/vboxsf.ko"

    cd ../vboxvideo
    install -D -m644 vboxvideo.ko \
        "$pkgdir/lib/modules/$_kernver/misc/vboxvideo.ko"

    install -D -m 0644 "$srcdir/60-vboxguest.rules" \
        "$pkgdir/lib/udev/rules.d/60-vboxguest.rules"

    sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" "$startdir/virtualbox-guest-modules.install"
}
sha256sums=('48961f0d6fe70c3887cbca5ea987767ac1bafd4b64dd3c4d25445682351e118e'
            '31ddafbeef6d35696d76de06988412f888fd5403854952bb00ceab99f5ed4966'
            '0e72a5ef8d915c550fd92865b40c265153dc2d4621714a599d3a7172726b6fff'
            'eb66ca54f9b3bc09c7c5bfa0212e943dd9ca5bc7f754b24c6d0a6d92528c0de5'
            '033c597e0f5285d2ddb0490868e5b6f945f45c7b1b1152a02a9e6fea438b2c95'
            '76be538774639b6ddf939d8358227802438f0a092aaeecc842840d25e2006e13'
            '9d081016ac89593f10c6f046cd551c3410026fd6a2e035f37726fd755b64bbc3'
            '85637e28829c515ad0538a2d684641d4c92add54262ed9d5a0d32a66ab4969b9'
            'f577e56b69238fc5f415670bc91005942bc9fd298032d562b2c39611cad1e919'
            'dcf5315f415932b5a652ba153b0160a88097295f2822ebe0560875818c55470e')

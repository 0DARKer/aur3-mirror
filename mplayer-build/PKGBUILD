# Maintainer: Iru Dog <mytbk920423@gmail.com>

# NOTE: This package relies on Mplayer's configure script to detect what is
# useful on your system. Build it on the machine you will use it on.
# If some features don't work, install the related optdepends *before*
# building.
# Before reporting any bug, please download a fresh copy of the package from
# the AUR and build the package using makepkg (not Yaourt).
#
# This is a multi-package PKGBUILD for testing. If it's not satisfactory, 
# I'll use the original single-package one instead.

pkgbase=mplayer-build
pkgname=mplayer-build
true && pkgname=("ffmpeg-lite" "mplayer-build")
arch=('i686' 'x86_64')
pkgver=1.1
pkgrel=7
depends=('libxv' 'alsa-lib' 'libass' 'xvidcore' 'libtheora' 'libpng' 'libmad' 'libgl' 'openal' ) 
makedepends=('yasm')

_mplayer_tar='mplayer-export-snapshot.tar.bz2'
_mplayer_source="http://www.mplayerhq.hu/MPlayer/releases/$_mplayer_tar"

#_ffmpeg_tar='ffmpeg-snapshot.tar.bz2'
# because of the problems in snapshot ffmpeg, now use stable
_use_stable=1
_ffmpeg_tar='ffmpeg-1.0.tar.bz2'
_ffmpeg_source="http://ffmpeg.org/releases/$_ffmpeg_tar"
#_proxy_src="http://ffmpeg.org.sixxs.org/releases/$_ffmpeg_tar"
#_ffmpeg_source=$_proxy_src

source=(${_ffmpeg_source})
md5sums=(3ed526cea20c1bffb5a37f7730f710bd)

build() {
	rm -rf $srcdir/mplayer*/
	if [[ -f ${startdir}/${_mplayer_tar} ]];then
		cp ${startdir}/${_mplayer_tar} ./
	else
		wget $_mplayer_source
		cp ${_mplayer_tar} ${startdir}/
	fi

	echo -e "\033[31m decompressing mplayer... \033[0m"
	tar xf ${_mplayer_tar} -C $srcdir
	cd $srcdir
	mv mplayer-*/ mplayer/
	if [[ -n _use_stable ]]; then
		mv $srcdir/ffmpeg-1.0 $srcdir/mplayer/ffmpeg
	else
		wget $_ffmpeg_source
		tar xf _ffmpeg_tar -C $srcdir/mplayer/
	fi

	unset CFLAGS CXXFLAGS LDFLAGS
	if [[ -n $CC ]]; then
		APPEND="--cc=${CC}" #maybe you want to use clang
	fi
	cd mplayer/ffmpeg
	
	./configure \
		--prefix=/usr \
		--enable-gpl \
		--enable-version3 \
		--enable-shared \
		--enable-libxvid \
		--enable-libvorbis \
		--enable-libtheora \
		--enable-postproc \
		--disable-ffserver \
		--disable-outdev=oss,caca \
		--disable-debug \
		--disable-static \
		${APPEND}

	echo -e "\033[31m start building ffmpeg \033[0m"
	make
	make tools/qt-faststart
}

package_ffmpeg-lite() {
	pkgdesc='a complete, cross-platform solution to record, convert and stream audio and video'
	true && pkgver=1.0
	true && pkgrel=1
	url='http://ffmpeg.org/'
	license=('GPL')
	conflicts=('ffmpeg')
	provides=("ffmpeg=$pkgver")
	depends=('sdl' 'zlib' 'libva' 'libvorbis' 'alsa-lib' 'bzip2')

	cd $srcdir/mplayer/ffmpeg/
	make DESTDIR=$pkgdir install
	install -D -m755 tools/qt-faststart "$pkgdir/usr/bin/qt-faststart"
}

package_mplayer-build() {
	pkgdesc='Famous multimedia player,snapshot version, without GUI'
	url='http://www.mplayerhq.hu/'
	license=('GPL')
	conflicts=('mplayer')
	provides=("mplayer")
	backup=('etc/mplayer/codecs.conf' 'etc/mplayer/input.conf')
	cd $srcdir/mplayer/

	./configure \
		--prefix=/usr --confdir=/etc/mplayer --enable-menu \
		--disable-mencoder --disable-mpg123 --disable-x264 \
		--disable-aa --disable-caca --disable-md5sum \
		--disable-ossaudio --disable-arts --disable-cddb --disable-libdv \
		--disable-lirc --disable-lircc --disable-liblzo --disable-libcdio \
		--disable-libgsm --disable-librtmp --disable-libdca --disable-speex \
		--disable-libopencore_amrnb --disable-libopencore_amrwb \
		--disable-pulse --disable-jack --disable-xss \
		--disable-libschroedinger-lavc --disable-faad \
		--disable-faac --disable-vdpau 

	echo -e "\033[31m start building mplayer \033[0m"
	make
	make DESTDIR=$pkgdir install
}


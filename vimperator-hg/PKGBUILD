# Contributor: Michael Witten <mfwitten>
# Inspiration: Gustavo Dutra <mechamo@gustavodutra.com>

# For 3.5<=firefox<=4.0b7pre, update to revision 4361:
#
#    cd src/hg
#    hg up 4361
#    cd -
#    makepkg --holdver -sfi
#
# To build a specific revision, it is probably
# necessary to run `makepkg' with the `--holdver'
# option.
#
# The various phases of the build can be controlled
# with the following variables (use an empty value
# to mean false):

_source=yes
_clean=yes
_config=yes
_compile=yes
_install=yes
#_install=          # do not install

######################################################################

pkgname=vimperator-hg
license=(MIT)
pkgver=4379
pkgrel=1
pkgdesc="Make firefox look and behave like Vim; built from HEAD of branch default"
arch=(i686 x86_64)
url=http://www.vimperator.org/vimperator
depends=('firefox>=4.0b5')
makedepends=(coreutils mercurial sh zip unzip)
provides=(vimperator)

_hgroot=https://vimperator-labs.googlecode.com
_hgrepo=hg

build()
{

  #### Source ####

    cd "$srcdir"

    if [ ! $_source ]; then

      cd "$_hgrepo"

    else

      msg "Connecting to server...."

      if [ -d "$_hgrepo" ] ; then

        cd "$_hgrepo" && hg pull -u
        msg "The local files are updated."

      else

        hg clone "$_hgroot/$_hgrepo"
        cd "$_hgrepo"

      fi

      msg "Checkout done or server timed out"

    fi

    # At this point, the current working directory
    # should be "$srcdir/$_hgrepo"

  #### Clean ####

    if [ $_clean ]; then

      msg "Cleaning ..."
      hg status --unknown | xargs rm -rf
      hg update --clean .

    fi

  #### Configure ####

    cd vimperator

    if [ $_config ]; then
    
      msg "Configuring ..."

      local version_firefox="$(perl -e '`firefox -v` =~ /(\d+\.\d+[^\s.,;:]*)/; print $1')"
      local version_vimperator="`perl -ne '/VERSION\s*=\s*(\S+)/ && print($1) && last' Makefile`"

      # This isn't very safe over time; XML parsing should really be used
      local extension_id=`awk -F'<em:id>|</em:id>' '/<em:id>/ {print $2; exit}' install.rdf`

      local path_xpi="../downloads/vimperator_$version_vimperator.xpi"
      local path_install="$pkgdir/usr/lib/firefox-$version_firefox/extensions/$extension_id"

    fi

    # At this point, the current working directory
    # should be "$srcdir/$_hgroot/vimperator"

  #### Compile ####

    if [ $_compile ]; then
    
      msg "Compiling ..."
      make xpi

    fi

  #### Install  ####

    if [ $_install ]; then
    
      msg "Installing ..."

      install -d "$path_install"
      unzip -od "$path_install" "$path_xpi"

    fi
}

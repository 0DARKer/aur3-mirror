# This is an example PKGBUILD file. Use this as a start to creating your own,
# and remove these comments. For more information, see 'man PKGBUILD'.
# NOTE: Please fill out the license field for your package! If it is unknown,
# then please put 'unknown'.

# See http://wiki.archlinux.org/index.php/VCS_PKGBUILD_Guidelines
# for more information on packaging from SVN sources.

# Maintainer: Stephen Martin <hwkiller@hotmail.com>
pkgname=webcamstudio-svn
_pkgname=webcamstudio
pkgver=152
pkgrel=1
pkgdesc="WebcamStudio helps you create a virtual webcam that can show your desktop, overlays, effects, and more."
arch=('any')
url="http://sourceforge.net/projects/webcamstudio/"
license=('GPL')
depends=('java-runtime')
makedepends=('subversion' 'apache-ant')
provides=('webcamstudio')
install=webcamstudio.install

_svntrunk=http://webcamstudio.googlecode.com/svn/trunk/
_svnmod="$_pkgname"
_kernver=`uname -r`

build() {
  cd "$srcdir"

  if [ -d $_svnmod/.svn ]; then
    (cd $_svnmod && svn up -r $pkgver)
  else
    svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
  fi

  msg "SVN checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_svnmod-build"
  cp -r "$srcdir/$_svnmod" "$srcdir/$_svnmod-build"
  cd "$srcdir/$_svnmod-build/trunk"

  #
  # BUILD
  #
  msg "Building webcamstudio jar..."
/usr/share/java/apache-ant/bin/ant clean jar
msg2 "Building the vloopback module..."
cd vloopback
make
msg2 "Building the webcamstudio shared library"
gcc -c -fPIC libwebcamstudio.c -o libwebcamstudio.o    
gcc -shared -Wl -o libwebcamstudio.so.1.0.1  libwebcamstudio.o
}

package() {
msg2 "Installing vloopback module and webcamstudio shared library"
  cd "$srcdir/$_svnmod-build/trunk/vloopback"
  install -Dm755 webcamstudio.ko "$pkgdir"/lib/modules/"$_kernver"/extra/webcamstudio.ko
  install -Dm755 libwebcamstudio.so.1.0.1 "$pkgdir"/usr/lib/libwebcamstudio.so.1.0.1
  ln -s /usr/lib/libwebcamstudio.so.1.0.1 "$pkgdir"/usr/lib/libwebcamstudio.so
msg2 "Installing all webcamstudio jar files to /usr/share/webcamstudio"
  cd "$srcdir/$_svnmod-build/trunk"
  install -Dm755 dist/WebcamStudio.jar "$pkgdir"/usr/share/"$_pkgname"/WebcamStudio.jar
  cp libraries/* "$pkgdir"/usr/share/"$_pkgname"/
msg2 "Creating /usr/bin/webcamstudio"
  mkdir -p "$pkgdir/usr/bin/"
  echo -e '#!/bin/sh\njava -cp "/usr/share/webcamstudio/*" webcamstudio.Main' > "$pkgdir"/usr/bin/webcamstudio
  chmod 755 "$pkgdir"/usr/bin/webcamstudio
}

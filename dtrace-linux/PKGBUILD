 
# Maintainer: Jens Staal <staal1978@gmail.com>

pkgname=dtrace-linux
pkgver=20110320
pkgrel=1
pkgdesc="Solaris DTrace  ported to linux as a loadable kernel module + userland utilities"
arch=('i686' 'x86_64')
url="http://www.crisp.demon.co.uk/blog/"
#official url: http://hub.opensolaris.org/bin/view/Community+Group+dtrace/WebHome
license=('CCDL' 'custom')
#legal status of this one should be approximately the same as the ZFS port
depends=('util-linux' 'kernel26-headers' 'libdwarf')
makedepends=('bison')
provides=('dtrace')
source=("ftp://crisp.dyndns-server.com/pub/release/website/dtrace/dtrace-$pkgver.tar.bz2" "lex.patch")
md5sums=('1869250c757aa85e1cc7559f200fa2f9' '4416559825ecaa8fc53da27ce1f515a8')
_kernver=2.6.37-ARCH

build() {
 export CC=gcc
 export CXX=g++
 cd $srcdir

 rm -rf $srcdir/build
 cp -ar "$srcdir/dtrace-$pkgver" $srcdir/build

  cd $srcdir/build
  patch -p0 $srcdir/build/libdtrace/dt_impl.h $srcdir/lex.patch
  make -i all
}

package() {

  cd $srcdir/build
  install -d $pkgdir/usr/sbin
  install -d $pkgdir/usr/lib/dtrace/64
  install -d $pkgdir/lib/modules/$_kernver/kernel/drivers
  install -Dm755 $srcdir/build/build/dtrace $pkgdir/usr/sbin/dtrace
  install -Dm755 $srcdir/build/build/drti.o $pkgdir/usr/lib/dtrace/64/drti.o
  install -Dm644 $srcdir/build/build/driver/dtracedrv.ko $pkgdir/lib/modules/$_kernver/kernel/drivers/dtracedrv.ko
  install -Dm644 $srcdir/build/LICENSING.NOTICE $pkgdir/usr/share/licenses/dtrace/LICENSING.NOTICE
  install -Dm644 $srcdir/build/README $pkgdir/usr/share/licenses/dtrace/README
}

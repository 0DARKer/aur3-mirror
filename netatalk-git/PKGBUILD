# Maintainer: carbncl <carbncl at gmail>
# Based on netatalk package :
# Maintainer: Dominik Dingel <mail at wodar dot de>
# Contributor: William Udovich <nerdzrule7 at earthlink dot net>
# Contributor: Farhan Yousaf <farhany at xaviya dot com>

pkgname=netatalk-git
pkgver=20110802
pkgrel=1
pkgdesc="A kernel level implementation of the AppleTalk Protocol Suite"
provides=('netatalk')
conflicts=('netatalk')
arch=('i686' 'x86_64')
url="http://netatalk.sourceforge.net"
options=('!libtool')
license=("GPL")
backup=('etc/netatalk/afpd.conf' 
        'etc/netatalk/netatalk.conf' 
        'etc/netatalk/atalkd.conf' 
        'etc/netatalk/papd.conf' 
        'etc/netatalk/AppleVolumes.default' 
        'etc/netatalk/AppleVolumes.system'
        'etc/avahi/services/afpd.service')
depends=('libcups' 'tcp_wrappers' 'avahi' 'openssl' 'pam' 'coreutils>=7.1-2' 'db' 'libgcrypt')
makedepends=('make' 'patch' 'gcc')
source=(afpd atalkd papd cnid afpd.service)
install=netatalk.install
md5sums=('16ab9fa50ec4abde6de478fc7de57805'
         '2d05de4a16faf7d4af21b5f14e33fa82'
         'b16a687c96dd1ca7ffefd7c995356c0d'
         '84d1961726aaa8df08d63a0925358b1a'
         '9b6b2fee54fe052bba0c69f00d335bdb')
_gitroot="git://netatalk.git.sourceforge.net/gitroot/netatalk/netatalk"
_gitname="netatalk"
_commit=81aedef566a1f007bc16b9a742fa2f1f7944bd56

build() {
  cd "${srcdir}"
  msg "Connecting to GIT server...."

  if [ -d "${_gitname}" ] ; then
    cd "${_gitname}" && git checkout master && git pull origin
    [[ "${_commit}" ]] && git checkout "${_commit}"
    msg "The local files are updated."
    msg "Running make distclean"
    make distclean || :
  else
    git clone "${_gitroot}" "${_gitname}"
    cd "${_gitname}"
    [[ "${_commit}" ]] && git checkout "${_commit}"
  fi

  cd ${srcdir}/${_gitname}
  msg "Bootstrapping netatalk..."
  ./bootstrap

  msg "Configuring netatalk..."
  ./configure --prefix=/usr --with-cnid-cdb-backend --with-ssl-dir=/usr --localstatedir=/var --enable-fhs --enable-zeroconf=/usr --disable-srvloc
  make || return 1
  make DESTDIR=$startdir/pkg install

  mv $startdir/pkg/usr/include/netatalk{,2}

  install -d $startdir/pkg/etc/rc.d
  install -m755 ../{afpd,atalkd,papd,cnid} $startdir/pkg/etc/rc.d

  install -d $startdir/pkg/etc/avahi/services
  install -m755 ../afpd.service $startdir/pkg/etc/avahi/services


  #	rm $startdir/pkg/usr/bin/timeout
  rm -f $startdir/pkg/usr/share/man/man1/timeout.1{,.gz}
}


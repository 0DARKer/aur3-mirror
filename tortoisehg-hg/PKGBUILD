#Contributor: Alexey "Mr.Cat" Bakhirkin <abakhirkin(at)gmail.com>
#Thanks: Andr√© Klitzing <aklitzing () online () de>
#Thanks: Yumi Nanako <yumileroy [at] yahoo.com>
pkgname=tortoisehg-hg
pkgver=5696
pkgrel=1
pkgdesc="GUI frontend for mercurial including hgtk and nautilus plugin"
arch=(i686 x86_64)
url="http://bitbucket.org/tortoisehg/"
license=('GPL2')
makedepends=('mercurial' 'python-sphinx')
depends=('mercurial' 'python-iniparse' 'pygtk')
optdepends=('python-nautilus>=0.5.0-2: required for nautilus plugin' 'gtkspell: spell checker' 'gnome-python-extras: spell checker')
conflicts=('tortoisehg')
install=$pkgname.install
source=("$pkgname.install")
md5sums=('7651f776b659c8c6eb33b359c4a14c17')

_hgroot="http://bitbucket.org/tortoisehg/"
_hgrepo="stable"

build() {
  cd $srcdir

  if [ -d $_hgrepo/.hg ]; then
    (cd $_hgrepo && hg up -r $pkgver)
  else
    hg clone -r $pkgver $_hgroot/$_hgrepo $_hgrepo
  fi

  msg "Mercurial checkout done or server timeout"

  if [ -d $_hgrepo-build ]; then
    msg "Removing old build directory"
    rm -rf $_hgrepo-build
  fi
  
  msg "Copying repository to build directory"
  cp -r $srcdir/$_hgrepo $srcdir/$_hgrepo-build
  
  msg "Starting build"
  cd $srcdir/$_hgrepo-build

  msg "Writing config.py"
  echo 'bin_path     = "/usr/bin"' > tortoisehg/util/config.py
  echo 'license_path = "/usr/share/licenses/$pkgname/Copying.txt.gz"' >> tortoisehg/util/config.py
  echo 'locale_path  = "/usr/share/locale"' >> tortoisehg/util/config.py
  echo 'icon_path    = "/usr/share/pixmaps/tortoisehg/icons"' >> tortoisehg/util/config.py  

  msg "Running setup.py"
  python setup.py build || return 1
  python setup.py install --root=$pkgdir || return 1

  msg "Building html documentation"
  cd $srcdir/$_hgrepo-build/doc
  make html
  
  install -dm 755 $pkgdir/usr/share/doc/tortoisehg
  cp -r $srcdir/$_hgrepo-build/doc/build/html/* $pkgdir/usr/share/doc/tortoisehg
}


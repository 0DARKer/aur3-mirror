# Maintainer: Franco Tortoriello <franco.tortoriello@gmail.com>

pkgname=doomsday-git
pkgver=20110507
pkgrel=1
pkgdesc="Portable game engine for classic FPS such as DOOM, Heretic and Hexen, with launcher included"
arch=('i686')
url="http://dengine.net/"
license=('GPL2')
depends=('libgl' 'libpng' 'sdl_net' 'sdl_mixer' 'openal' 'curl' 'wxpython')
makedepends=('cmake' 'git')
provides=(doomsday)
conflicts=(doomsday)
install=
source=()
md5sums=()

_gitroot="git://deng.git.sourceforge.net/gitroot/deng/deng"
_gitname="doomsday"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server..."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build/doomsday/build"

  # Build
  cmake .. \
    -DSYSTEMARCH=$CARCH \
    -DCMAKE_INSTALL_PREFIX=/usr
    #-DBUILDOPENAL:BOOL=ON
  make
}

package() {
  cd "$srcdir/$_gitname-build/doomsday/build"
  # Write launcher script (this should be automatic...)
  echo -e '#!/bin/sh\ncd /usr/share/doomsday/snowberry/\npython2 snowberry.py' > launch-doomsday
  chmod +x launch-doomsday
  make DESTDIR="$pkgdir" install

  # Remove unnecesary stuff
  rm -R "$pkgdir/etc"
}

# Maintainer: Scott Smith <jcdenton513 gmail com>
pkgname=veracity
pkgver=1.1.0
_verextra=10565
pkgrel=1
pkgdesc="A new open source distributed version control system."
url="http://www.veracity-scm.com"
arch=('x86_64' 'i686')
license=('APACHE')
depends=('curl' 'icu' 'zlib' 'util-linux' 'nspr')
makedepends=('cmake')
install="veracity.install"
source=("http://download.sourcegear.com/Veracity/release/$pkgver.$_verextra/veracity-source-$pkgver.$_verextra.tar.gz"
        "cmake.patch")
sha256sums=('2d129005ec1c62b78307a08899edce3a036e75a4a22be4e0dfed02c3fe17a16b'
            '23d46ec953f3a0dfb4c5aa25c73336f2d11e1dc8556c177755489edd82ee3b0f')

_thisarch=i686
if test "$CARCH" == x86_64; then
  _thisarch=x86_64
fi

options=(!makeflags)
 
build() {
  # Failure in final linking, undefined symbols.
  export LDFLAGS="${LDFLAGS//-Wl,--as-needed}"

  cd ${srcdir}/${pkgname}/thirdparty
  ./build_linux.sh

  cd ${srcdir}/${pkgname}
  # supress -Wunused. causes build to fail
  patch -p1 < ../cmake.patch
  # don't bother with testsuite (it ends up being about 800MB in size)
  sed -i /add_subdirectory\(testsuite\)/d CMakeLists.txt
  cmake -G "Unix Makefiles" \
    -DVVTHIRDPARTY=${srcdir}/veracity/vv-thirdparty/${_thisarch} \
    -DCMAKE_INSTALL_PREFIX=/usr
  make
}
 
package() {
  cd "${srcdir}/${pkgname}"
  make DESTDIR="${pkgdir}" install
  install -Dm644 NOTICE.txt "$pkgdir/usr/share/licenses/$pkgname/NOTICE.txt"
  install -Dm644 TRADEMARKS.txt "$pkgdir/usr/share/licenses/$pkgname/TRADEMARKS.txt"
}
 
# vim:set ts=2 sw=2 et:

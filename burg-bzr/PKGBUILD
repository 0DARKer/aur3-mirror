# Maintainer: cruznick <cruznick@archlinux.us>
# Maintainer: fsckd <fsckdaemon@gmail.com>

pkgname=burg-bzr
pkgver=1844
pkgrel=2
pkgdesc="A brand-new boot loader based on GRUB."
url="https://launchpad.net/burg"
license="GPL3"
arch=('i686' 'x86_64')
depends=('ruby' 'python2' 'gettext' 'freetype2' 'sdl' 'ncurses')
optdepends=('os-prober' 'memtest86+')
makedepends=('bzr')
conflicts=(burg-bzr-fixed)
replaces=(burg-bzr-fixed)
changelog=burg.changelog
provides=(burg-bzr)
backup=('etc/default/burg' 'etc/burg.d/40_custom')
sha256sums=('e94ee55a1fa9cadb5d752c40df6060c0b5c6b42f6f69440d24642b483255b05a'  # burg.default
            '674c4167ebdfab33158b5ac41a6bb9e58cf02711296da97bae6efd8a89bfa6b4'  # folding patch
            '31edd8578c337be2f02dae8a292b5c53d34b107ab255634698794f999a293506'  # memtest
            '646d55a233706329ecc9b4b6d0eb0460e6d37b84ebbe3e15c3176cbd23bf075b') # update-burg
source=('burg.default' 'arch-burg-detection-folding.patch' '20_memtest86+' 'update-burg')
install='burg.install'


_bzrmod=burg
_bzrtrunk=lp:${_bzrmod}

build() {
cd $srcdir/

msg "Connecting to the server...."
if [ ! -d ./${_bzrmod} ]; then
bzr branch ${_bzrtrunk} -r ${pkgver}
else
cd ${_bzrmod} && bzr pull -r ${pkgver}
fi
msg "BZR checkout done or server timeout"


  cd "${srcdir}/${_bzrmod}"
  # some random patches to facilitate automatic creation of grub.cfg
  patch -Np1 -i  ${srcdir}/arch-burg-detection-folding.patch
  cd "${srcdir}/${_bzrmod}"
  ## Archlinux changed default /usr/bin/python to 3.1.2, need to use /usr/bin/python2 instead
  sed -i 's|python|python2|' ${srcdir}/${_bzrmod}/autogen.sh
  ./autogen.sh || return 1



rm -rf $srcdir/$_bzrmod-build
msg "Creating build directory..."
mkdir $srcdir/$_bzrmod-build
msg "Starting make..."

cd $srcdir/$_bzrmod-build
$srcdir/$_bzrmod/configure  --prefix=/usr --bindir=/bin \
		--sbindir=/sbin --mandir=/usr/share/man \
		--infodir=/usr/share/info --sysconfdir=/etc \
		--disable-werror || return 1

make || return 1
make install DESTDIR=$pkgdir || return 1

  # install /etc/default/burg(needed config file)
  install -Dm644 ${srcdir}/burg.default ${pkgdir}/etc/default/burg
  # install update-burg script 
  install -Dm755 ${srcdir}/update-burg ${pkgdir}/sbin/update-burg
  # install memtest config detection
  install -Dm755 ${srcdir}/20_memtest86+ ${pkgdir}/etc/burg.d/20_memtest86+

}


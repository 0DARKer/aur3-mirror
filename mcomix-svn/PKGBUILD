# Maintainer: marcinfa <marcinfa@gmail.com>

pkgname=mcomix-svn
pkgver=884
pkgrel=1
pkgdesc="A comic book viewer"
arch=('i686' 'x86_64')
url="http://mcomix.sourceforge.net"
license=('GPL')
provides=('mcomix')
conflicts=('mcomix')
depends=('pygtk' 'python-imaging' 'xdg-utils' 'python2' \
         'desktop-file-utils' 'hicolor-icon-theme' 'python2-distribute')
makedepends=('gettext' 'intltool')
optdepends=('unrar: for rar compressed comics')
install=mcomix.install
_svntrunk=svn://svn.code.sf.net/p/mcomix/code/ 
_svnmod=mcomix-code

pkgver() {
  cd ${srcdir}/$_svnmod
  svnversion
}

build() {
  cd "${srcdir}"
  msg "Connecting to SVN server...."
  if [[ -d "${_svnmod}/.svn" ]]; then
    (cd "${_svnmod}" && svn up -r "${pkgver}")
  else
    svn co "${_svntrunk}" --config-dir ./ -r "${pkgver}" "${_svnmod}"
  fi
  rm -rf "${srcdir}/${_svnmod}-build"
  msg "SVN checkout done or server timeout"
  svn export --quiet "${srcdir}/${_svnmod}" "${srcdir}/${_svnmod}-build"
  cd "${srcdir}/${_svnmod}-build"

    # python2 fix
  for file in $(grep -Rl "/usr/bin/env python" .);
  do
    sed -i 's_#!/usr/bin/env python_#!/usr/bin/env python2_' $file
  done
}

package() {
    cd "${_svnmod}-build"
    mkdir -p ${pkgdir}/usr
    export PYTHONPATH=${pkgdir}/usr/lib/python2.7/site-packages/
    mkdir -p $PYTHONPATH
    python2 setup.py install --prefix=${pkgdir}/usr --optimize=1 \
    --single-version-externally-managed --root=/
    install -Dm644 mime/comicbook.schemas \
    ${pkgdir}/usr/share/gconf/schemas/mcomix.schemas
}

# Maintainer: Jianjun Mao <justmao945_at_gmail.com>

pkgname=libcxx
pkgver=3.2
pkgrel=1
pkgdesc="A new implementation of the C++ standard library targeting C++0X."
arch=('i686' 'x86_64')
url="http://libcxx.llvm.org/"
license=('MIT')
depends=('gcc-libs')
optdepends=('gcc: ABI library libsupc++')
makedepends=('clang' 'cmake' 'git')
install=libcxx.install


# Use __git to keep pkgver
__gitroot="http://llvm.org/git/libcxx.git"
__gitname="libcxx"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."
  if [[ -d "$__gitname" ]]; then
    cd "$__gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone --depth=1 "$__gitroot" "$__gitname"
    cd "$__gitname"
    git checkout -b release_32
  fi
  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  cd ${srcdir}/${__gitname}

  rm -rf build && mkdir build && cd build

  # delete unsupported flags by clang
  CXXFLAGS=`echo $CXXFLAGS|sed 's/\(-D_FORTIFY_SOURCE=2\)\|\(--param=ssp-buffer-size=4\)//g'`

  cmake ..  -DCMAKE_INSTALL_PREFIX="$pkgdir/usr" -DCMAKE_C_COMPILER=clang -DCMAKE_CXX_COMPILER=clang++ && make
}

package() {
  cd "$srcdir/${__gitname}/build"
  make install

  cd "$srcdir/$__gitname"
  install -Dm644 LICENSE.TXT "$pkgdir/usr/share/licenses/${pkgname}/LICENSE"
}


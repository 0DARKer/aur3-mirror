# Contributor: Kyle Keen <keenerd@gmail.com>
pkgname=cyphertite
pkgver=0.4.7
pkgrel=1
pkgdesc="high-security scalable online backups"
arch=('i686' 'x86_64')
url="https://www.cyphertite.com"
license=('GPL')
depends=('openssl' 'libevent' 'expat' 'sqlite3' 'lzo2' 'xz' 'libbsd')
makedepends=('findutils' 'unionfs-fuse')
source=("https://www.cyphertite.com/snapshots/source/$pkgver/$pkgname-full-$pkgver.tar.gz"
    "http://kmkeen.com/tmp/trip-arch")
md5sums=('f8f1720c49ca46a1cf558391fa87972c'
         '11560146ff10c42cbe23fc7f9fa7476f')
#sha256sums=('c120b74fab79be1443e932180d2b9032ac1322daee31a8e446ebd5aa34a4157e')

build() {
  cd "$srcdir/$pkgname-$pkgver"

  # make it build
  grep -r 'usr/local' * 2> /dev/null | cut -d ':' -f 1 | egrep '(akefile|Configure)' | xargs -n 1 sed -i 's|/usr/local|/usr|g'
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' clens/Makefile
  sed -i 's|bsd/|libbsd/bsd/|g' clens/src/arc4random_buf.c
  echo 'CFLAGS+= -I/usr/include/libbsd' >> clens/config/Makefile.linux
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' cyphertite/cyphertite/Makefile
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' cyphertite/Makefile
  echo 'CFLAGS+= -I/usr/include/libbsd' >> cyphertite/config/Makefile.linux

  # contain the build
  msg "Cyphertite has a convoluted build process that requires writing to your /"
  msg "Trip-arch will sandbox the build, using a chroot + unionFS overlay."
  cp ../../trip-arch ./
  bash trip-arch ./ct_install.sh
  cp -R "pkg/usr" "$pkgdir"

  # fix misc
  cd "$pkgdir/usr/share/man/man3"
  mv clog.3 clog-${pkgname}.3
}


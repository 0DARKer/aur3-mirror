# Contributor: Kyle Keen <keenerd@gmail.com>
pkgname=cyphertite
pkgver=0.3.2
pkgrel=1
pkgdesc="high-security scalable online backups"
arch=('i686' 'x86_64')
url="https://www.cyphertite.com"
license=('GPL')
depends=('openssl' 'libevent' 'expat' 'sqlite3' 'lzo2' 'xz' 'libbsd')
makedepends=('findutils' 'unionfs-fuse')
source=("https://www.cyphertite.com/snapshots/source/$pkgver/$pkgname-full-$pkgver.tar.gz"
    "http://kmkeen.com/tmp/trip-arch")
md5sums=('6251e502cdc4d8b0e463858805160079'
         'f487dc4f0dd879ec32b2f6dd90259ea0')
#sha256sums=('8a3d52c61e6944bd80d8b013f4ce881e17a0d842859987828a4a4473d88e1176')

build() {
  cd "$srcdir/$pkgname-$pkgver"

  # make it build
  grep -r 'usr/local' * 2> /dev/null | cut -d ':' -f 1 | egrep '(akefile|Configure)' | xargs -n 1 sed -i 's|/usr/local|/usr|g'
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' clens/Makefile
  sed -i 's|bsd/|libbsd/bsd/|g' clens/src/arc4random_buf.c
  echo 'CFLAGS+= -I/usr/include/libbsd' >> clens/config/Makefile.linux
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' cyphertite/cyphertite/Makefile
  sed -i 's|CFLAGS+= -ggdb3|CFLAGS+= -lbsd -ggdb3|' cyphertite/Makefile
  echo 'CFLAGS+= -I/usr/include/libbsd' >> cyphertite/config/Makefile.linux

  # contain the build
  cp ../../trip-arch ./
  bash trip-arch ./ct_install.sh
  cp -R "pkg/usr" "$pkgdir"

  # fix misc
  cd "$pkgdir/usr/share/man/man3"
  mv clog.3 clog-${pkgname}.3
}


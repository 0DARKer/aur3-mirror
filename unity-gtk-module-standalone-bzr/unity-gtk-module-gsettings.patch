=== modified file 'data/com.canonical.unity-gtk-module.gschema.xml'
--- data/com.canonical.unity-gtk-module.gschema.xml	2013-11-14 18:51:01 +0000
+++ data/com.canonical.unity-gtk-module.gschema.xml	2015-04-02 08:07:32 +0000
@@ -11,5 +11,10 @@
       <description>List of applications where unity-gtk-module should be enabled.</description>
       <default>[]</default>
     </key>
+    <key name="gtk2-shell-shows-menubar" type="b">
+      <summary>Determines GTK2 menus behaviour</summary>
+      <description>This key is ubuntu gtk patch replacement.</description>
+      <default>true</default>
+    </key>
   </schema>
 </schemalist>

=== modified file 'src/main.c'
--- src/main.c	2014-06-09 03:50:16 +0000
+++ src/main.c	2015-04-02 08:51:30 +0000
@@ -43,6 +43,7 @@
 #define UNITY_GTK_MODULE_SCHEMA "com.canonical.unity-gtk-module"
 #define BLACKLIST_KEY           "blacklist"
 #define WHITELIST_KEY           "whitelist"
+#define SHELL_SHOWS_MENUBAR_KEY "gtk2-shell-shows-menubar"
 
 #define _GTK_UNIQUE_BUS_NAME     "_GTK_UNIQUE_BUS_NAME"
 #define _UNITY_OBJECT_PATH       "_UNITY_OBJECT_PATH"
@@ -512,7 +513,7 @@
       menu_shell_data->window = window;
     }
 }
-
+#if GTK_MAJOR_VERSION == 3
 static gboolean
 gtk_widget_shell_shows_menubar (GtkWidget *widget)
 {
@@ -543,6 +544,29 @@
 {
   gtk_widget_queue_resize (user_data);
 }
+#else
+static gboolean
+gtk_widget_shell_shows_menubar (GtkWidget *widget)
+{
+  GSettings *settings;
+
+  g_return_val_if_fail (GTK_IS_WIDGET (widget), FALSE);
+
+  settings = g_settings_new (UNITY_GTK_MODULE_SCHEMA);
+
+  g_return_val_if_fail (G_IS_SETTINGS (settings), FALSE);
+
+  return g_settings_get_boolean (settings,SHELL_SHOWS_MENUBAR_KEY);;
+}
+
+static void
+g_settings_handle_gtk_shell_shows_menubar (GSettings    *settings,
+                                           gchar *key,
+                                           gpointer    user_data)
+{
+  gtk_widget_queue_resize (user_data);
+}
+#endif
 
 static void
 hijacked_window_realize (GtkWidget *widget)
@@ -580,7 +604,6 @@
 
   gtk_window_get_window_data (GTK_WINDOW (widget));
 }
-#endif
 
 static void
 hijacked_menu_bar_realize (GtkWidget *widget)
@@ -601,6 +624,27 @@
   settings = gtk_widget_get_settings (widget);
   g_signal_connect (settings, "notify::gtk-shell-shows-menubar", G_CALLBACK (gtk_settings_handle_gtk_shell_shows_menubar), widget);
 }
+#else
+static void
+hijacked_menu_bar_realize (GtkWidget *widget)
+{
+  GtkWidget *window;
+  GSettings* settings;
+
+  g_return_if_fail (GTK_IS_MENU_BAR (widget));
+
+  if (pre_hijacked_menu_bar_realize != NULL)
+    (* pre_hijacked_menu_bar_realize) (widget);
+
+  window = gtk_widget_get_toplevel (widget);
+
+  if (GTK_IS_WINDOW (window))
+    gtk_window_connect_menu_shell (GTK_WINDOW (window), GTK_MENU_SHELL (widget));
+
+  settings = g_settings_new (UNITY_GTK_MODULE_SCHEMA);
+  g_signal_connect (settings, "changed::"SHELL_SHOWS_MENUBAR_KEY, G_CALLBACK (g_settings_handle_gtk_shell_shows_menubar), widget);
+}
+#endif
 
 static void
 hijacked_menu_bar_unrealize (GtkWidget *widget)


# Maintainer: Anton Shestakov <engored*ya.ru>

pkgname=quodlibet-hg
pkgver=4559
pkgrel=1
pkgdesc="Audio library tagger, manager, and player for GTK+. Mercurial version."
arch=(i686 x86_64)
url="http://code.google.com/p/quodlibet/"
license=('GPL2')
depends=('gstreamer0.10-python>=0.10.13-2' 'gstreamer0.10-base-plugins' 
         'gstreamer0.10-good-plugins' 'gstreamer0.10-ugly-plugins' 
         'mutagen' 'pygtk>=2.13.0-2')
makedepends=('mercurial' 'intltool')
conflicts=('quodlibet' 'quodlibet-svn' 'quodlibet-no-exfalso')
provides=('quodlibet')
source=()
md5sums=()

_hgroot=https://quodlibet.googlecode.com/hg
_hgrepo=quodlibet

build() {
  msg "Connecting to Mercurial server...."

  if [ -d "$_hgrepo" ] ; then
    cd "$_hgrepo"
    hg pull -u || return 1
    msg "The local files are updated."
  else
    hg clone "$_hgroot" "$_hgrepo" || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting make..."
  
  cd $srcdir
  
  rm -rf "$_hgrepo-build"
  hg clone "$_hgrepo" "$_hgrepo-build"
  cd "$_hgrepo-build/quodlibet"

  sed -i -e 's/env python/env python2/' *.py

  ./setup.py build || return 1
}  

package() {
  cd "$_hgrepo-build/quodlibet"

  ./setup.py install --prefix="$pkgdir/usr" || return 1
  
  install -D -m644 quodlibet/images/exfalso.png "$pkgdir/usr/share/pixmaps/exfalso.png" || return 1
  install -D -m644 quodlibet/images/quodlibet.png "$pkgdir/usr/share/pixmaps/quodlibet.png" || return 1
}

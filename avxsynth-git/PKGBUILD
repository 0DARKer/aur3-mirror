# Maintainer: Gustavo Alvarez <sl1pkn07@gmail.com>

pkgname=avxsynth-git
pkgver=20120519
pkgrel=1
pkgdesc="Linux Port of AviSynth. with option to include build with libav/libpostproc/ffmpegsource from GIT/SVN"
arch=('i686' 'x86_64')
url="http://www.avxsynth.org"
license=('GPL2')
depends=('qt' 'mplayer' 'log4cpp')
makedepends=('git')
replace=('avxsynth' 'avxsynth-svn')
provides=('avxsynth')
conflicts=('avxsynth' 'avxsynth-svn')
source=('source-fix.diff')
md5sums=('416dd62a3aaee517292518c3e7093a6d')

# Build with libav/libpostproc/ffmpegsource from GIT/SVN (0 = No | 1 = Yes) ##NOT WORKING FOR THE MOMENT##
buildall=0

if [ "${buildall}" = 1 ]; then
    depends+=('zlib' 'bzip2')
    makedepends+=('yasm' 'subversion')
    locense+=('GPL3' 'MIT')
    _gitavroot="git://git.libav.org/libav.git"
    _gitavname="libav"
    _gitpostprocroot='git://git.videolan.org/libpostproc.git'
    _gitpostprocname='libpostproc'
    _svnffmstrunk="http://ffmpegsource.googlecode.com/svn/trunk/"
    _svnffmsmod="ffmpegsource"
elif [ "${buildall}" = 0 ]; then
    depends+=('ffmpegsource')
fi

_gitroot="git://github.com/avxsynth/avxsynth.git"
_gitname="avxsynth"

build() {
  cd "${srcdir}"
  if [ "${buildall}" = 1 ]; then
      rm -fr build
      msg "Connecting to the libav Git repository..."
      if [ -d "${_gitavname}" ] ; then
          cd "${_gitavname}" && git pull && cd "${srcdir}"
          msg "The local files are updated."
      else
          git clone --depth=1 "${_gitavroot}" && cd "${srcdir}"
      fi
      msg "GIT checkout done or server timeout"
      rm -rf "${_gitavname}"-build
      cp -R "${_gitavname}" "${_gitavname}"-build
      msg "Connecting to libpostproc GIT server..."
      if [ -d "${_gitpostprocname}" ] ; then
          cd "${_gitpostprocname}" && git pull && cd "${srcdir}"
          msg "The local files are updated."
     else
         git clone --depth=1 "${_gitpostprocroot}" && cd "${srcdir}"
     fi
     msg "GIT checkout done or server timeout"
     rm -fr "${_gitpostprocname}"-build
     cp -R "${_gitpostprocname}" "${_gitpostprocname}"-build
     msg "Connecting to ffmpegsource SVN server...."
     if [ -d "${_svnffmsmod}" ] ; then
        cd "${_svnffmsmod}" && svn update && cd "${srcdir}"
        msg "The local files are updated."
     else
        svn co "${_svnffmstrunk}" "${_svnffmsmod}" && cd "${srcdir}"
     fi
     msg "SVN checkout done or server timeout"
     rm -fr "${_svnffmsmod}"-build
     cp -R "${_svnffmsmod}" "${_svnffmsmod}"-build
  fi
  msg "Connecting to avxsynth GIT server..."
  if [ -d "${_gitname}" ] ; then
      cd "${_gitname}" && git pull && cd "${srcdir}"
      msg "The local files are updated."
  else
      git clone --depth=1 "${_gitroot}" && cd "${srcdir}"
  fi
  msg "GIT checkout done or server timeout"
  rm -fr "${_gitname}"-build
  cp -R "${_gitname}" "${_gitname}"-build

  msg "Starting build..."
  if [ "${buildall}" = 1 ]; then
      msg2 "Build libav"
      cd "${srcdir}"/"${_gitavname}"-build/
      ./configure --prefix="${srcdir}"/build --disable-{network,{encod,mux}ers,hwaccels,{in,out}devs,debug,av{conv,play,probe,server},doc,vdpau} --enable-pic
      make
      make install
      msg2 "Build libpostproc"
      cd "${srcdir}"/"${_gitpostprocname}"-build/
      CFLAGS="-fPIC" PKG_CONFIG_LIBDIR=""${srcdir}"/build/lib/pkgconfig" ./configure --prefix="${srcdir}"/build --disable-debug
      make
      make install
      msg2 "Build ffmpegsource"
      cd "${srcdir}"/"${_svnffmsmod}"-build
      PKG_CONFIG_LIBDIR=""${srcdir}"/build/lib/pkgconfig" ./configure --prefix="${srcdir}"/build --enable-shared=no --with-pic=yes
      make
      make install
  fi 
  msg2 "Build avxsynth"
  cd "${srcdir}"/"${_gitname}"-build/

  # Add libdeps into custom pkgconfig dir
  [ "${buildall}" = 1 ] && ln -s /usr/lib/pkgconfig/{glib-2.0,gobject-2.0,gmodule-no-export-2.0,libpcre,cairo,pango,pangocairo,log4cpp,Qt{Core,Gui},pixman-1,fontconfig,freetype2,libpng,x{cb{,-shm},au,proto,dmcp,cb-render,render,11},{kb,render}proto}.pc "${srcdir}"/build/lib/pkgconfig

  # Fix warnings libavxbtinfncs.so in gcc 4.7
  patch --silent -p0 -E -i "${srcdir}"/source-fix.diff

  # Change moc-qt4 to moc
  sed 's|moc-qt4|moc|g' -i apps/AVXEdit/Makefile

  if [ "${buildall}" = 1 ]; then
      PKG_CONFIG_LIBDIR=""${srcdir}"/build/lib/pkgconfig" ./configure --prefix=/usr --enable-strip
  elif [ "${buildall}" = 0 ]; then
      ./configure --prefix=/usr --enable-strip
  fi
  make
  msg2 "Done"
}

package() {
  cd "${srcdir}"/"${_gitname}"-build/
  make DESTDIR="${pkgdir}" install

  # Install examples
  install -d "${pkgdir}"/usr/share/"${_gitname}"
  cp -R scripts/* "${pkgdir}"/usr/share/"${_gitname}"
}
# Contributor: Anton Bazhenov <anton.bazhenov at gmail>
# Contributor: Tom K <tomk@runbox.com>
# Maintainer: Aaron Ali <t0nedef@causal.ca>

pkgname=mpb
pkgver=1.4.2
pkgrel=6
pkgdesc="A program for computing the band structures and electromagnetic modes"
arch=('i686' 'x86_64')
url="http://ab-initio.mit.edu/wiki/index.php/MIT_Photonic_Bands"
license=('GPL')
depends=('lapack' 'hdf5' 'fftw2' 'libctl' 'openmpi')
makedepends=('gcc-fortran')
source=(http://ab-initio.mit.edu/$pkgname/$pkgname-$pkgver.tar.gz)
md5sums=('e1e618b0db343a7a3fc38eabd69d008b')

build() {
	cd "$srcdir"

	cp -r $pkgname-$pkgver $pkgname-$pkgver-inv
	cp -r $pkgname-$pkgver $pkgname-$pkgver-mpi
	cp -r $pkgname-$pkgver $pkgname-$pkgver-inv-mpi

	# configure includes two options for working with GNU Fortran and HDF5 v1.8.x
	cd $pkgname-$pkgver
	./configure \
		F77="gfortran" \
		CPPFLAGS="-DH5_USE_16_API=1" \
		--prefix=/usr \
		--mandir=/usr/share/man
	make

	# configure inversion symmetry binaries (run at least 2x as fast)
	cd ../$pkgname-$pkgver-inv
	./configure \
		F77="gfortran" \
		CPPFLAGS="-DH5_USE_16_API=1" \
		--prefix=/usr \
		--with-inv-symmetry \
		--mandir=/usr/share/man
	make

	# configure parrallel computation
	cd ../$pkgname-$pkgver-mpi
	./configure \
		F77="gfortran" \
		CPPFLAGS="-DH5_USE_16_API=1" \
		--prefix=/usr \
		--with-mpi \
		--mandir=/usr/share/man
	make

	# configure parrallel computation
	cd ../$pkgname-$pkgver-inv-mpi
	./configure \
		F77="gfortran" \
		CPPFLAGS="-DH5_USE_16_API=1" \
		--prefix=/usr \
		--with-inv-symmetry \
		--with-mpi \
		--mandir=/usr/share/man
	make
}

package() { 
	cd "$srcdir"/$pkgname-$pkgver
	make prefix="$pkgdir"/usr mandir="$pkgdir"/usr/share/man install 

	cd "$srcdir"/$pkgname-$pkgver-inv
	make prefix="$pkgdir"/usr mandir="$pkgdir"/usr/share/man install 

	cd "$srcdir"/$pkgname-$pkgver-mpi
	make prefix="$pkgdir"/usr mandir="$pkgdir"/usr/share/man install 

	cd "$srcdir"/$pkgname-$pkgver-inv-mpi
	make prefix="$pkgdir"/usr mandir="$pkgdir"/usr/share/man install 
}


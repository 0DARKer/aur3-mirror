#Contributor: MatToufoutu <mattoufootu[at]gmail[dot]com>
#Contributor: Jan Lieven jan[at]das<minus>labor(dot)org

pkgname=john-mpi
pkgver=1.7.9
pkgrel=3
_patchlevel=jumbo-5
arch=('i686' 'x86_64')
pkgdesc='JohnTheRipper password cracker with Jumbo patch and MPI support'
url='http://openwall.info'
license=('GPL')
provides=('john')
conflicts=('john' 'john-latest')
# For OpenCL support change swap the {make}depends arrays
depends=('mpich2')
makedepends=('mpich2')
# Remember to include one of the following packages into the depends
# array for OpenCL to work:
# amdstream
# opencl-nvidia
# intel-opencl-sdk
#depends=('mpich2'
#         'libopencl'
#         'YOUR_OPENCL_VENDOR_HERE')
#makedepends=('opencl-headers'
#             'libopencl')
backup=(etc/john/john.conf
        etc/john/dumb32.conf
        etc/john/dumb16.conf
        etc/john/dynamic.conf)

source=("http://www.openwall.com/john/g/john-${pkgver}-${_patchlevel}.tar.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.9/john-1.7.9-jumbo-5-opencl-5.diff"
        "http://openwall.info/wiki/_media/john/john-1.7.9/jumbo5/john-1.7.9-jumbo-5-NT-performance-02.diff"
        "http://openwall.info/wiki/_media/john/john-1.7.9/jumbo5/JtR-Jumbo-5-LinkedIn-SHA1.diff"
        "params.h.patch")

build() {
  export PATH=/opt/mpich2/bin:${PATH}

  cd ${srcdir}
  sed -i 's|john-1.7.9-jumbo-5-opencl-5//||g' john-1.7.9-jumbo-5-opencl-5.diff
  sed -i 's|john-1.7.9-jumbo-5//||g' john-1.7.9-jumbo-5-opencl-5.diff
  sed -i 's|a/||g' john-1.7.9-jumbo-5-NT-performance-02.diff
  sed -i 's|b/||g' john-1.7.9-jumbo-5-NT-performance-02.diff
  sed -i 's|z/||g' JtR-Jumbo-5-LinkedIn-SHA1.diff
  sed -i 's|zz/||g' JtR-Jumbo-5-LinkedIn-SHA1.diff

  cd ${srcdir}/john-${pkgver}-${_patchlevel}
  patch -p0 < ../john-1.7.9-jumbo-5-opencl-5.diff
  patch -p0 < ../john-1.7.9-jumbo-5-NT-performance-02.diff
  patch -p0 < ../JtR-Jumbo-5-LinkedIn-SHA1.diff

  cd ${srcdir}/john-${pkgver}-${_patchlevel}/src
  patch -p0 < ${srcdir}/params.h.patch

  sed -i 's|#CC = mpicc|CC = mpicc|g' Makefile                                                                                                                    
  sed -i 's|#MPIOBJ = john-mpi.o|MPIOBJ = john-mpi.o|g' Makefile

  if [ "$CARCH" == "x86_64" ]; then
   sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=x86-64 -DJOHN_SYSTEMWIDE=1|' Makefile
   sed -i 's|^LDFLAGS =\(.*\)|LDFLAGS =\1 -lm|' Makefile
   sed -i -e 's|-m486||g' Makefile
    if [ $(which icc) -eq 0 ]; then
      make linux-x86-64-icc
    else
# For OpenCL replace the make target with linux-x86-64-opencl
      #make linux-x86-64-opencl
      make linux-x86-64
    fi
  else
    sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=native -DJOHN_SYSTEMWIDE=1|' Makefile
# For OpenCL replace the make target with linux-x86-opencl
    #make linux-x86-opencl
    make linux-x86-sse2
  fi
}

package() {
	# config file
	sed -i 's|$JOHN|/usr/share/john|g' ${srcdir}/john-${pkgver}-${_patchlevel}/run/john.conf
  sed -i 's|/usr/share/john/dumb|/etc/john/dumb|g' ${srcdir}/john-${pkgver}-${_patchlevel}/run/john.conf
  sed -i 's|.include <dynamic.conf>|#.include <dynamic.conf>|g' ${srcdir}/john-${pkgver}-${_patchlevel}/run/john.conf
  install -d ${pkgdir}/etc/john
	install -m644 ${srcdir}/john-${pkgver}-${_patchlevel}/run/*.conf ${pkgdir}/etc/john/
	
	# docs
	install -d ${pkgdir}/usr/share/doc/john
	install -m644 ${srcdir}/john-${pkgver}-${_patchlevel}/doc/* ${pkgdir}/usr/share/doc/john/
	install -d ${pkgdir}/usr/share/john/
	install -m644 ${srcdir}/john-${pkgver}-${_patchlevel}/run/*.chr ${pkgdir}/usr/share/john/
	install -m644 ${srcdir}/john-${pkgver}-${_patchlevel}/run/password.lst ${pkgdir}/usr/share/john/
	install -Dm644 ${srcdir}/john-${pkgver}-${_patchlevel}/doc/LICENSE ${pkgdir}/usr/share/licenses/$pkgname/LICENSE

	# install password list and charset files
	install -m644 ${srcdir}/john-${pkgver}-${_patchlevel}/run/{{all,alnum,alpha,digits,lanman}.chr,password.lst} \
          ${pkgdir}/usr/share/john/

	# install binaries
  cd ${srcdir}/john-${pkgver}-${_patchlevel}/run/
  for i in $(find . -type f -perm 755); do
    install -Dm755 ${i} ${pkgdir}/usr/bin/${i}
  done
	cd ${pkgdir}/usr/bin
	ln -s john unafs
	ln -s john unique
	ln -s john unshadow
	ln -s john undrop
}

sha512sums=('463762fc4492a2f6f572cabb3fe2b50d2cc762ad302b322519b51f151dc29faa45db0032eb05e57277d6956cdc5c779b51f37037fbe4a24519b552d98e24d2e7'
            'a1ea483d06a4e4352d4a32b8e2e7e9a874e11ee263f6ae608c9c6d0b3db14667acabc2695a2d5a0359b5e5b56c667160b75953f5897e7046cf0afb1d7fe523ca'
            '1bedce39dd17f492a9897f1d6caed77959022f50c03fe5dc0d4860c7478025e2899fb552de054fb47ed9ff9c2fb2f1fec260766c12e0ce2fde7d49305f4461d3'
            '8a6dc95312ac22758e376831884029acf34bef7d30ba37e3f94e276194bf7290aa1b92435f0ad4401b1b8b38bbecc12b16191f0f7d6b33ae33130ef9d6bc5cf4'
            'b50e0961a75b57c487046ac6aca0a3149b81a733deb305bcb1e34169e0f37ddd8f11f7ef8dcb04a1d2bc5e689b32298f1b47ce87eef29942a958fb438772465d')

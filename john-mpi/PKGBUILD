#Contributor: MatToufoutu <mattoufootu[at]gmail[dot]com>
#Contributor: Jan Lieven jan[at]das<minus>labor(dot)org

pkgname=john-mpi
pkgver=1.7.7
pkgrel=3
arch=('i686' 'x86_64')
pkgdesc='JohnTheRipper password cracker with Jumbo patch and MPI support'
url='http://openwall.info'
license=('GPL')
provides=('john')
conflicts=('john' 'john-latest')
depends=('mpich2')

source=("http://www.openwall.com/john/g/john-${pkgver}.tar.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7/john-1.7.7-jumbo-5-RC6.diff.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7-jumbo-5-RC6-omp_fixes.diff.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7-jumbo-5-RC6-loader_mute_warning.diff.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7/john-1.7.7-jumbo-5-RC6-mssql_SSE2_patch-2.diff.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7-jumbo-5-RC6-various-patches.diff.gz"
        "http://openwall.info/wiki/_media/john/john-1.7.7/john-1.7.7-jumbo-5-RC6-more-mssql_fixes.diff.gz"
        "params.h.patch")

build() {
  export PATH=/opt/mpich2/bin:${PATH}

  cd ${srcdir}/john-${pkgver}/

  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6.diff
  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6-omp_fixes.diff
  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6-loader_mute_warning.diff
  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6-mssql_SSE2_patch-2.diff
  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6-various-patches.diff
  patch -p1 < ${srcdir}/john-${pkgver}-jumbo-5-RC6-more-mssql_fixes.diff

  cd src
  patch -p0 < ${srcdir}/params.h.patch

  sed -i 's|#CC = mpicc|CC = mpicc|g' Makefile                                                                                                                    
  sed -i 's|#MPIOBJ = john-mpi.o|MPIOBJ = john-mpi.o|g' Makefile

  if [ "$CARCH" == "x86_64" ]; then
   sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=x86-64 -DJOHN_SYSTEMWIDE=1|' Makefile
   sed -i 's|^LDFLAGS =\(.*\)|LDFLAGS =\1 -lm|' Makefile
   sed -i -e 's|-m486||g' Makefile
    if [ $(which icc) -eq 0 ]; then
      make linux-x86-64-icc
    else
      make linux-x86-64
    fi
  else
    sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=i686 -DJOHN_SYSTEMWIDE=1|' Makefile
    make linux-x86-sse2
  fi
}

package() {
	# config file
	sed -i 's|$JOHN|/usr/share/john|g' ${srcdir}/john-$pkgver/run/john.conf
	install -Dm644 ${srcdir}/john-$pkgver/run/john.conf ${pkgdir}/etc/john/john.conf
	
	# docs
	install -d ${pkgdir}/usr/share/doc/john
	install -m644 ${srcdir}/john-$pkgver/doc/* ${pkgdir}/usr/share/doc/john/
	install -d ${pkgdir}/usr/share/john/
	install -m644 ${srcdir}/john-$pkgver/run/*.chr ${pkgdir}/usr/share/john/
	install -m644 ${srcdir}/john-$pkgver/run/password.lst ${pkgdir}/usr/share/john/
	install -Dm644 ${srcdir}/john-$pkgver/doc/LICENSE ${pkgdir}/usr/share/licenses/$pkgname/LICENSE

	# install password list and charset files
	install -m644 ${srcdir}/john-${pkgver}/run/{{all,alnum,alpha,digits,lanman}.chr,password.lst} \
          ${pkgdir}/usr/share/john/

	# install binaries
  cd ${srcdir}/john-${pkgver}/run/
  for i in $(find . -type f -perm 755); do
    install -Dm755 ${i} ${pkgdir}/usr/bin/${i}
  done
	cd ${pkgdir}/usr/bin
	ln -s john unafs
	ln -s john unique
	ln -s john unshadow
	ln -s john undrop
}

md5sums=('b9efdefd5b372525bfcc4a8d08328785'
         '22553cf95093703853dd4d609543af1a'
         '2eb762ae8cc052593f39e33221b7504b'
         'a4b808ce132a423f5dd4aeedae270d33'
         '944408e64a283721d9bbd8c918128cfc'
         '8556fe0ebe9891dbfc9c5e526dc9b193'
         'f849f0793d319cfed3db69e4ae5ff4e0'
         'f69ed632eba8fb9e45847a4b4a323787')

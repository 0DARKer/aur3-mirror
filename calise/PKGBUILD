# Maintainer: Nicolo' Barbon <smilzoboboz@gmail.com>
pkgname=calise
pkgver=0.0.5
pkgrel=3
pkgdesc="calculates ambient brightness and suggests (or sets) screen's correct backlight level using a camera"
arch=(any)
url="http://sourceforge.net/projects/calise/"
license=('GPL3')
groups=()
depends=('python-pygame' 'python-imaging' 'python2-numpy' 'hicolor-icon-theme')
makedepends=('python-distutils-extra' 'intltool')
optdepends=('python2-pyqt: useless on non-graphical enviroments, needed elsewhere'
            'wxpython: Graphical User Interface'
            )
provides=('calise')
conflicts=()
replaces=(camsensor)
backup=()
options=()
install=calise.install
changelog=
source=(http://sourceforge.net/projects/$pkgname/files/$pkgname-beta/$pkgver/$pkgname-$pkgver.tar.gz
        129-calibration.patch
        )
noextract=()
sha256sums=('84bd4189304b8e9b608cceca74f7fb5a0fda44e64abffae38b2b3f0283feb974'
            'ee0acc30f93c0ec395616a8b00d5bad6a7aff88c639164ba6ecf3f5eb1174879'
            )

build() {
  cd "$srcdir/$pkgname"
  patch calise/calibration.py < ../129-calibration.patch
  env python2 setup.py build
}

package() {
  cd "$srcdir/$pkgname"
  interface="`udevadm info -a -p /sys/class/backlight/* | 
    grep "KERNEL=" | 
    sed s'/KERNEL==//' | 
    awk -F ['"'] '{print $2}'`"
  if [ ! -e /sys/class/backlight/$interface/brightness ]; then
    echo "Your configuration is currently not supported."
    return 1
  fi
  udevrule="$pkgdir/lib/udev/rules.d/99-backlight-$interface.rules"
  mkdir -p "$pkgdir/lib/udev/rules.d/"
  echo "KERNEL==\"${interface}\", RUN+=\"/bin/chmod 664 /sys/class/backlight/$interface/brightness\"" > $udevrule
  echo "KERNEL==\"${interface}\", RUN+=\"/bin/chgrp video /sys/class/backlight/$interface/brightness\"" >> $udevrule
  env python2 setup.py install --prefix="$pkgdir/usr/"
}
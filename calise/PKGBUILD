# Maintainer: Nicolo' Barbon <smilzoboboz@gmail.com>
pkgname=calise
pkgver=0.2.1
pkgrel=1
pkgdesc="Calculates ambient brightness and sets screen's correct backlight using a webcam."
arch=('i686' 'x86_64')
url="http://calise.sourceforge.net/"
license=('GPL3')
groups=()
depends=('python-pygame' 'python-imaging' 'python2-numpy' 'hicolor-icon-theme' 'pyxdg' 'python2-pyephem')
makedepends=('python2-distutils-extra' 'intltool' 'libx11')
optdepends=('python2-pyqt: gui')
provides=('calise')
conflicts=()
replaces=('camsensor')
backup=()
options=()
install=calise.install
changelog=
source=(http://sourceforge.net/projects/$pkgname/files/$pkgname-beta/$pkgver/$pkgname-$pkgver.tar.gz)
noextract=()
sha1sums=('dc3c7c0aea9d4c97e03c60ff303241f0d0fe856e')

build() {
  cd "$srcdir/$pkgname"
  env python2 setup.py build
}

package() {
  cd "$srcdir/$pkgname"
  if [ ! -e /sys/class/backlight/ ]
  then
    return 1
  fi
  interfaces=""
  for path in /sys/class/backlight/*
  do
    interfaces="`udevadm info -a -p $path | 
      grep "KERNEL=" | 
      sed s'/KERNEL==//' | 
      awk -F ['"'] '{print $2}'` $interfaces"
  done
  if [ -z $interfaces ]
  then
    echo "Your configuration is currently not supported."
    return 2
  fi
  mkdir -p "$pkgdir/usr/lib/udev/rules.d/"
  for interface in $interfaces
  do
    if [ ! -e /sys/class/backlight/$interface/brightness ]
    then
      echo "Your configuration is currently not supported."
      return 3
    fi
    udevrule="$pkgdir/usr/lib/udev/rules.d/99-backlight-$interface.rules"
    echo "KERNEL==\"${interface}\", RUN+=\"/bin/chmod 664 /sys/class/backlight/$interface/brightness\"" > $udevrule
    echo "KERNEL==\"${interface}\", RUN+=\"/bin/chgrp video /sys/class/backlight/$interface/brightness\"" >> $udevrule
  done
  env python2 setup.py install --prefix="$pkgdir/usr/"
  rm "$pkgdir/usr/share/applications/calised.desktop"
}
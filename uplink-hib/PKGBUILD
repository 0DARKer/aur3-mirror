# Maintainer: Zachary A. Jones <jazzplayerl9@gmail.com>
pkgname=uplink-hib
pkgver=1.6
pkgrel=4
pkgdesc="Trust is a weakness - a futuristic computer crime game. Requires uplink from Humble Bundle."
arch=(i686 x86_64)
url="http://www.introversion.co.uk/uplink"
license=(custom)
depends=(mesa libjpeg6 sdl_mixer libtiff freetype2)
conflicts=(uplink)
source=(uplink.desktop)
md5sums=('9fd1da6598ff73ad72431e21ecd11696')

#Game package naming conventions
_gamepkg="uplink_${pkgver}-1_i386.tar.gz"
_archi='x86'
_aarchi='x86'
_libi='lib'
[ "$CARCH" = 'x86_64' ] && _gamepkg="uplink_${pkgver}-1_amd64.tar.gz" && _archi='x64' && _aarchi='x86_64' && _libi='lib64'

build() {

   cd "${srcdir}"
   msg "You need a full copy of this game in order to install it"
   msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
   if [[ -f "../${_gamepkg}" ]]; then
       msg "Found game package, installing..."
       ln -fs "../${_gamepkg}" .
   elif [ -n "${_humbleintbundlekey}" ]; then
	   msg "Game package not found, trying to download..."
	   rm -f index.html\?key\=${_humbleintbundlekey}*
	   wget http://www.humblebundle.com/?key=${_humbleintbundlekey}
	   wget $(cat index.html\?key\=${_humbleintbundlekey} | grep "${_gamepkg}" | cut -d "'" -f 10)
	   mv ${_gamepkg}* ${_gamepkg}
   else
	   msg "Game package not found and download failed."
	   msg "You can add \'export _humbleintbundlekey\=\<Your key here\>\' to \.bashrc if you want automated download ability."
       error "Please type absolute path to ${_gamepkg} (/home/joe):"
       read pkgpath
       if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
           msg "Found game package, installing..."
		   ln -fs "${pkgpath}/${_gamepkg}" .
	   else
	       error "Unable to find game package."
	       return 1
       fi
   fi

  bsdtar -x -f "$srcdir/${_gamepkg}"
  install -d "$pkgdir/opt/uplink"
  mv "$srcdir/uplink-${_archi}" "$srcdir/uplink"
  rm -rf "$srcdir/uplink/${_libi}"
  cp -R "$srcdir/uplink" "$pkgdir/opt/"

  cd "$pkgdir"
  #Fix some permissions
  chmod -R 644 "${pkgdir}/opt/uplink"
  chmod +x "${pkgdir}/opt/uplink"
  chmod +x "${pkgdir}/opt/uplink/uplink.bin.${_aarchi}"
  #Install Desktop File
  install -m 644 -D "$srcdir/uplink.desktop" usr/share/applications/uplink.desktop

  #Install License
  install -d "usr/share/licenses/$pkgname"
  cp opt/uplink/license.txt "usr/share/licenses/$pkgname"
  
  #Link Executable
  install -d usr/bin
  ln -s "/opt/uplink/uplink.bin.${_aarchi}" usr/bin/uplink
}

# Maintainer: Blake Dickie <gentro_silva@shaw.ca>
pkgname=pdfmasher
pkgver=0.7.4
pkgrel=1
pkgdesc="PDF to eBook Conversion Tool"
arch=(any)
url="http://www.hardcoded.net/pdfmasher/"
license=('GPL')
depends=('python' 'pyqt' 'python-cssutils' 'python-lxml' 'python-markdown' 'python-cssselect')
makedepends=('mercurial' 'python-distribute' 'python-pip' 'python-virtualenv')
source=()
md5sums=()


build() {

	cd "$srcdir"
	msg "Connecting to Mercurial server...."
	
	if [[ -d "$pkgname" ]]; then
		cd "$pkgname"
		hg pull -u
		msg "The local files are updated."
	else
		hg clone "https://bitbucket.org/hsoft/pdfmasher" "$pkgname"
		cd "$pkgname"
	fi
	
	msg "Mercurial checkout done or server timeout"
	
	msg "Switching to Production Tag"
	# NOTE: The "-arch" suffix is temporary. Recent fixes have been made upstream to make Arch
	# packaging easier, but there wasn't a release with these changes yet, so I've made a special
	# "arch" tag in the upstream repo. After the next release, we can remove that suffix.
	hg checkout "$pkgver"-arch
	
	if [[ ! -d "env" ]]; then
	msg "Creating virtualenv"
	virtualenv --system-site-packages env
	fi
	
	msg "Installing dependencies"
	source env/bin/activate
	pip install -r requirements-lnx.txt
	
	msg "Starting build..."
	python configure.py
	python build.py --clean
}

package() {
	cd "$srcdir/$pkgname"
	
	mkdir -p "${pkgdir}/usr/share/applications"
	cp debian/pdfmasher.desktop "${pkgdir}/usr/share/applications"
	
	python package.py
	cd "build/pdfmasher-arch"
	
	mkdir -p "$pkgdir/usr/share/pdfmasher"
	cp -a * "$pkgdir/usr/share/pdfmasher/"
	install -dm755 "${pkgdir}/usr/share/pdfmasher"
	chmod a+x "$pkgdir/usr/share/pdfmasher/run.py"
	
	mkdir -p "$pkgdir/usr/bin"
	ln -s ../share/pdfmasher/run.py "$pkgdir/usr/bin/pdfmasher"
}

# vim:set ts=2 sw=2 et: 

pkgname=gnutls2
pkgver=2.12.21
pkgrel=1
arch=('i686' 'x86_64')
pkgdesc="gnutls version 2"
url="http://www.gnu.org/software/gnutls/"
license=('GPL' 'LGPL')
source=("ftp://ftp.gnu.org/gnu/gnutls/gnutls-$pkgver.tar.bz2")
depends=('zlib' 'libtasn1')
makedepends=('pkg-config')

build() {
	cd $srcdir/gnutls-$pkgver

#	sed -i -e '/gets is a security/d' lib/gl/stdio.in.h
#	sed -i -e '/gets is a security/d' gl/stdio.in.h

cat > ./archgnutls.patch <<DELIM
diff -u -r gnutls-2.12.21/gl/stdio.in.h gnutls-pt/gl/stdio.in.h
--- gnutls-2.12.21/gl/stdio.in.h        2012-03-02 00:47:48.000000000 +0900
+++ gnutls-pt/gl/stdio.in.h     2012-12-10 19:45:07.000000000 +0900
@@ -710,12 +710,14 @@
 _GL_CXXALIAS_SYS (gets, char *, (char *s));
 #  undef gets
 # endif
+# if defined gets
 _GL_CXXALIASWARN (gets);
 /* It is very rare that the developer ever has full control of stdin,
    so any use of gets warrants an unconditional warning.  Assume it is
    always declared, since it is required by C89.  */
 _GL_WARN_ON_USE (gets, "gets is a security hole - use fgets instead");
 #endif
+#endif


 #if @GNULIB_OBSTACK_PRINTF@ || @GNULIB_OBSTACK_PRINTF_POSIX@
diff -u -r gnutls-2.12.21/lib/gl/stdio.in.h gnutls-pt/lib/gl/stdio.in.h
--- gnutls-2.12.21/lib/gl/stdio.in.h    2012-03-02 00:53:13.000000000 +0900
+++ gnutls-pt/lib/gl/stdio.in.h 2012-12-10 19:45:57.000000000 +0900
@@ -710,12 +710,14 @@
 _GL_CXXALIAS_SYS (gets, char *, (char *s));
 #  undef gets
 # endif
+# if defined gets
 _GL_CXXALIASWARN (gets);
 /* It is very rare that the developer ever has full control of stdin,
    so any use of gets warrants an unconditional warning.  Assume it is
    always declared, since it is required by C89.  */
 _GL_WARN_ON_USE (gets, "gets is a security hole - use fgets instead");
 #endif
+#endif


 #if @GNULIB_OBSTACK_PRINTF@ || @GNULIB_OBSTACK_PRINTF_POSIX@
DELIM

	patch -p1 < archgnutls.patch

	./configure --prefix=/usr/gnutls2 --with-libtasn1-prefix=/usr --with-libiconv-prefix=/usr --enable-threads=posix
	make
}

package() {
cd $srcdir/gnutls-$pkgver
make DESTDIR="$pkgdir" install
}

md5sums=('93ffac7507dd39a4c6a672ca6976d397')

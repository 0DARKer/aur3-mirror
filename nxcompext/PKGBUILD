# Contributor: Gerhard Brauer <gerbra@archlinux.de>
# Contributor: Richard Murri <admin@richardmurri.com>
pkgname=nxcompext
pkgver=3.4.0_1
pkgrel=2
pkgdesc="X compression extension library"
arch=(i686 x86_64)
url="http://www.nomachine.com"
license=('GPL')
makedepends=(xorg-server xorg-server-devel)
depends=(nxcomp libx11)
groups=('x2go' 'alts')
source=(http://64.34.161.181/download/${pkgver%%_*}/sources/${pkgname}-${pkgver//_/-}.tar.gz
        NXlib-xgetioerror.patch
        makefile.in.patch)
md5sums=('605a8e2a136f89477f0059a0d2af4582'
         'dc301d5db6b80c8a6e4bd157d0654df8'
         'f9018bff87fef1368193cda700bcb313')

build() {
  cd $srcdir/$pkgname

  # XGetIOError patch found here:
  # http://www.felipe-alfaro.org/blog/2007/11/24/installing-freenx-071-on-ubuntu/
  patch -p0 <../NXlib-xgetioerror.patch
  patch -Np0 <../makefile.in.patch

  # rewrite include headers
  find ./ -type f | xargs sed -i 's!#include "\(os\|dix\)\.h"!#include <xorg/\1.h>!g'
  find ./ -type f | xargs sed -i 's!#include "\(Xlib\|Xutil\|Xlibint\)\.h"!#include <X11/\1.h>!g'
  find ./ -type f | xargs sed -i 's!#include "\(NX\|NXpack\|NXproto\|NXvars\|MD5\)\.h"!#include <nxcomp/\1.h>!g'

  ./configure --prefix=/usr
  make || return 1

  install -d $pkgdir/usr/lib
  cp -a libXcompext.so* $pkgdir/usr/lib

  install -d $pkgdir/usr/include/nxcompext
  cp -a *.h $pkgdir/usr/include/nxcompext
}

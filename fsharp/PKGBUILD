# Contributor: Chris Schwaab christopher.schwaab gmail
pkgname=fsharp
pkgver=2.0.0.0
pkgrel=9
pkgdesc="An ML based functional language integrated with the .NET platform including the PowerPack extensions."
arch=('i686' 'x86_64')
url="http://research.microsoft.com/fsharp/fsharp.aspx"
license=('custom')
depends=('mono>=2' 'unzip')
source=("http://www.microsoft.com/downloads/info.aspx?na=46&SrcFamilyId=EFFC5BC4-C3DF-4172-AD1C-BC62935861C5&SrcDisplayLang=en&u=http%3a%2f%2fdownload.microsoft.com%2fdownload%2f4%2f5%2fB%2f45BD9FBC-22BA-4B45-84B7-17D1AD0122A1%2ffsharp.zip"
        "http://download.codeplex.com/Project/Download/FileDownload.aspx?ProjectName=fsharppowerpack&DownloadId=105437&FileTime=129119693633030000&Build=17889")
md5sums=('0e79601a6211191f6a86c31d5c0948f7'
         'fbb488b0b4751ae16e8e23ad7ab93465')
install=fsharp.install

_powerpkgver=1.9.9.9
build() {
	mkdir -p $pkgdir/usr/bin
	mkdir -p $pkgdir/opt/fsharp/bin
	mkdir $pkgdir/opt/fsharp/lib
	mkdir $pkgdir/opt/fsharp/doc

        # FSharp
	cd FSharp-$pkgver
	cat > fsc <<__EOF__
#!/bin/sh
mono /opt/fsharp/bin/fsc.exe \$*
__EOF__
	cat > fsi <<__EOF__
#!/bin/sh
mono /opt/fsharp/bin/fsi.exe --readline+ \$*
__EOF__

	wget --no-check-certificate 'http://github.com/mono/mono/blob/master/mcs/class/mono.snk'
        mv mono.snk $pkgdir/opt/fsharp || return 1

	cp -r bin $pkgdir/opt/fsharp/ || return 1
	cp -r lib $pkgdir/opt/fsharp/ || return 1
	cp -r doc $pkgdir/opt/fsharp/ || return 1

	install -m755 fsc $pkgdir/usr/bin/fsharpc || return 1
	install -m755 fsi $pkgdir/usr/bin/fsharpi || return 1
	install -Dm644 LICENSE-fsharp.txt \
	               $pkgdir/usr/share/licenses/fsharp/license || return 1

        # PowerPack
        cd $srcdir/FSharpPowerPack-1.9.9.9
	chmod a+rx,u+rwx bin/*.dll

	cat > bin/fslex <<__EOF__
#!/bin/sh
mono /opt/fsharp/bin/fslex.exe \$*
__EOF__
	cat > bin/fsyacc <<__EOF__
#!/bin/sh
mono /opt/fsharp/bin/fsyacc.exe \$*
__EOF__
	cat > bin/fshtmldoc <<__EOF__
#!/bin/sh
mono /opt/fsharp/bin/fshtmldoc.exe \$*
__EOF__

	install $srcdir/FSharp-$pkgver/bin/FSharp.Core.dll \
	        $pkgdir/opt/fsharp/bin || return 1

        # pdb2mdb was exploding on the debug files so I just skip them
	install -Dm755 bin/FSharp.Compiler.CodeDom.dll \
	               bin/FSharp.PowerPack.Build.Tasks.dll \
	               bin/FSharp.PowerPack.Compatibility.dll \
	               bin/FSharp.PowerPack.dll \
	               bin/FSharp.PowerPack.Linq.dll \
	               bin/FSharp.PowerPack.Metadata.dll \
	               bin/FSharp.PowerPack.Parallel.Seq.dll \
	               bin/FSharp.PowerPack.targets \
		       $pkgdir/opt/fsharp/lib || return 1

        install -Dm755 bin/fshtmldoc.exe bin/fslex.exe bin/fsyacc.exe \
                       $pkgdir/opt/fsharp/bin/ || return 1

	install -m755 bin/fshtmldoc bin/fsyacc bin/fslex \
	              $pkgdir/usr/bin/ || return 1
	install -Dm644 $srcdir/FSharpPowerPack-$_powerpkgver/License.rtf \
	  $pkgdir/usr/share/licenses/fsharp/powerpack-license || return 1
}

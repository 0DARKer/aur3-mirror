# Maintainer: Jason Melton <jason.melton@gmail.com>
# Contributor: Atilla ÖNTAŞ <tarakbumba@gmail.com>

pkgname=dkms-nvidia
_pkgname=nvidia
pkgver=270.41.03
pkgrel=1
pkgdesc="NVIDIA dynamic kernel module (DKMS) drivers for kernel26."
arch=(i686 x86_64)
url="http://www.nvidia.com/"
license=('custom')
depends=('dkms')
optdepends=("nvidia-utils=${pkgver}")
replaces=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm' 'nvidia-bfs' 
	  'nvidia-zen' 'nvidia-pae' 'nvidia-vs' 'nvidia-rt' 'nvidia-ccs' 'nvidia-lqx' 
	  'nvidia-mainline' 'nvidia-fbcondecor' 'nvidia-lts' 'nvidia-lts-ck' 'nvidia-lts-ccs'
	  'nvidia-bede')
provides=("nvidia")
conflicts=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm' 'nvidia-bfs' 
	  'nvidia-zen' 'nvidia-pae' 'nvidia-vs' 'nvidia-rt' 'nvidia-ccs' 'nvidia-lqx' 
	  'nvidia-mainline' 'nvidia-fbcondecor' 'nvidia-lts' 'nvidia-lts-ck' 'nvidia-lts-ccs'
	  'nvidia-bede')
install=${_pkgname}.install
options=(!strip)

if [ "$CARCH" = "i686" ]; then
	_arch='x86'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run"
		"dkms.conf")
        md5sums=('4e3b54ee55c6cfa4437c12a8bd9a4250')
elif [ "$CARCH" = "x86_64" ]; then
	_arch='x86_64'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}-no-compat32"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run"
		"dkms.conf")
        md5sums=('8fa312dd8aff26299f8df1e721665960')
fi

source[1]="dkms.conf"
md5sums[1]='5583f69b2692a1e5222d4cb3eca285ca'

build() {
	cd $srcdir
	sh ${_pkg}.run --extract-only
}

package() 
{
 	mkdir -p                                ${pkgdir}/usr/src/${_pkgname}-${pkgver}
 	cp -a       ${srcdir}/${_pkg}/kernel/*  ${pkgdir}/usr/src/${_pkgname}-${pkgver}
	cp          ${srcdir}/dkms.conf         ${pkgdir}/usr/src/${_pkgname}-${pkgver}

    install -d -m755 $pkgdir/etc/modprobe.d
    echo "blacklist nouveau" >> $pkgdir/etc/modprobe.d/nouveau_blacklist.conf
}

# Maintainer: Atilla ÖNTAŞ <tarakbumba@gmail.com>


_modname=nvidia
_oldpkgver=260.19.36
pkgname="dkms-nvidia"
pkgver=260.19.44
pkgrel=1
pkgdesc="NVIDIA dynamic kernel module (DKMS) drivers, utilities and libraries for kernel26."
arch=(i686 x86_64)
url="http://www.nvidia.com/"
license=('custom')
depends=('dkms' "nvidia-utils" "kernel26-headers")
replace=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm')
conflicts=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm')
provides=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm')
install="nvidia.install"

if [ "$CARCH" = "i686" ]; then
	_arch='x86'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run")
        md5sums=('c99b0710a43db3aafb4f27408194e910')

elif [ "$CARCH" = "x86_64" ]; then
	_arch='x86_64'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}-no-compat32"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run")
        md5sums=('3dfce350616ad70d626b531a15c8604f')
fi

source[1]="dkms.conf"
md5sums[1]='d0556aea9c84d8cfbe7ea792a468e02f'


build() {
	cd $srcdir
	sh ${_pkg}.run --extract-only
}

package() {
 	mkdir -p $pkgdir/usr/src/$_modname-$pkgver
 	cp -a $srcdir/${_pkg}/kernel/* \
 		$pkgdir/usr/src/$_modname-$pkgver
	install -d -m755 $pkgdir/etc/modprobe.d
        echo "blacklist nouveau" >> $pkgdir/etc/modprobe.d/nouveau_blacklist.conf
 	sed -i -e "s/OLD_PACKAGE_VERSION/${_oldpkgver}/" $startdir/nvidia.install
 	sed -i -e "s/PACKAGE_VERSION/${pkgver}/" $startdir/nvidia.install
	cp $srcdir/dkms.conf $pkgdir/usr/src/$_modname-$pkgver/
 	sed -i -e "s/PACKAGE_VERSION=\".*\"/PACKAGE_VERSION=\"${pkgver}\"/" $pkgdir/usr/src/$_modname-$pkgver/dkms.conf
}
# Maintainer: Atilla ÖNTAŞ <tarakbumba@gmail.com>
# Contributor: None

_modname=nvidia
_oldpkgver=270.30
pkgname=dkms-nvidia
pkgver=270.41.03
pkgrel=1
pkgdesc="NVIDIA dynamic kernel module (DKMS) drivers for kernel26."
arch=(i686 x86_64)
url="http://www.nvidia.com/"
license=('custom')
depends=('dkms')
optdepends=("nvidia-utils=${pkgver}")
replaces=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm' 'nvidia-bfs' 
	  'nvidia-zen' 'nvidia-pae' 'nvidia-vs' 'nvidia-rt' 'nvidia-ccs' 'nvidia-lqx' 
	  'nvidia-mainline' 'nvidia-fbcondecor' 'nvidia-lts' 'nvidia-lts-ck' 'nvidia-lts-ccs'
	  'nvidia-bede')
provides=("nvidia=${pkgver}" "nvidia-ck=${pkgver}" "nvidia-pf=${pkgver}" "nvidia-suspend2=${pkgver}" "nvidia-mm=${pkgver}" "nvidia-bfs=${pkgver}" 
	  "nvidia-zen=${pkgver}" "nvidia-pae=${pkgver}" "nvidia-vs=${pkgver}" "nvidia-rt=${pkgver}" "nvidia-ccs=${pkgver}" "nvidia-lqx=${pkgver}" 
	  "nvidia-mainline=${pkgver}" "nvidia-fbcondecor=${pkgver}" "nvidia-lts=${pkgver}" "nvidia-lts-ck=${pkgver}" "nvidia-lts-ccs=${pkgver}"
	  "nvidia-bede=${pkgver}")
conflicts=('nvidia' 'nvidia-ck' 'nvidia-pf' 'nvidia-suspend2' 'nvidia-mm' 'nvidia-bfs' 
	  'nvidia-zen' 'nvidia-pae' 'nvidia-vs' 'nvidia-rt' 'nvidia-ccs' 'nvidia-lqx' 
	  'nvidia-mainline' 'nvidia-fbcondecor' 'nvidia-lts' 'nvidia-lts-ck' 'nvidia-lts-ccs'
	  'nvidia-bede')
install=dkms-nvidia.install
options=(!strip)

if [ "$CARCH" = "i686" ]; then
	_arch='x86'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run"
		"dkms.conf")
        md5sums=('4e3b54ee55c6cfa4437c12a8bd9a4250')
elif [ "$CARCH" = "x86_64" ]; then
	_arch='x86_64'
	_pkg="NVIDIA-Linux-${_arch}-${pkgver}-no-compat32"
        source=("ftp://download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run"
		"dkms.conf")
        md5sums=('8fa312dd8aff26299f8df1e721665960')
fi

source[1]="dkms.conf"
md5sums[1]='d0556aea9c84d8cfbe7ea792a468e02f'

build() {
	cd $srcdir
	sh ${_pkg}.run --extract-only
}

package() {
 	mkdir -p $pkgdir/usr/src/$_modname-$pkgver
 	cp -a $srcdir/${_pkg}/kernel/* \
 		$pkgdir/usr/src/$_modname-$pkgver
	install -d -m755 $pkgdir/etc/modprobe.d
        echo "blacklist nouveau" >> $pkgdir/etc/modprobe.d/nouveau_blacklist.conf
 #	sed -i -e "s/OLD_PACKAGE_VERSION/${_oldpkgver}/" $startdir/dkms-nvidia.install
# 	sed -i -e "s/PACKAGE_VERSION/${pkgver}/" $startdir/dkms-nvidia.install
	cp $srcdir/dkms.conf $pkgdir/usr/src/$_modname-$pkgver/
 	sed -i -e "s/PACKAGE_VERSION=\".*\"/PACKAGE_VERSION=\"${pkgver}\"/" $pkgdir/usr/src/$_modname-$pkgver/dkms.conf
}

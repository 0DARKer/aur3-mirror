# Maintainer: bluephoenix47 <bluephoenix47@gmail.com>
# Contributor: Pedro Sland
# Contributor: Bart≈Çomiej Piotrowski <nospam@bpiotrowski.pl>
# Contributor: Geoffroy Carrier <geoffroy.carrier@koon.fr>
# Contributor: michalzxc
# Contributor: nbags <neilbags@gmail.com>

pkgname=fail2ban-systemd-journal-git
pkgver=20130314
pkgrel=1
pkgdesc='Bans IPs after too many failed authentification attempts against common daemons'
url='http://www.fail2ban.org/'
license=('GPL')
arch=('any')
makedepends=('git')
depends=('python2' 'iptables' 'python2-pyjournalctl')
# Preparing for systemd 198
# depends=('python2' 'iptables' 'python2-systemd')
conflicts=('fail2ban')
backup=(etc/fail2ban/fail2ban.conf
        etc/fail2ban/jail.conf)
source=(rc.d service tmpfiles.conf)
md5sums=('7fc55ae9afc1dff767190c9a4d687582'
         'b4af226eb2d3029241a70e005ec7b3ac'
         '78b42dea76c6c824b813dad9edc37377')

_gitroot="git://github.com/kwirk/fail2ban.git"
_gitname="fail2ban"

build() {
  cd "$srcdir"
  msg "Connecting to the Git repository..."

  if [[ -d "$srcdir/$_gitname" ]] ; then
    cd "$_gitname"
    git pull origin
    msg "The local files are updated"
  else
    git clone --depth 1 "$_gitroot" -b systemd-journald --single-branch "$srcdir/$_gitname"
    # 06000ef was last commit before systemd 198 stuff
    git checkout 06000ef
  fi
}

package(){
  cd "$srcdir/$_gitname"
  python2 setup.py install --root $pkgdir

  install -Dm755 $srcdir/rc.d $pkgdir/etc/rc.d/$pkgname
  install -Dm644 $srcdir/service $pkgdir/usr/lib/systemd/system/fail2ban.service
  install -Dm644 $srcdir/tmpfiles.conf $pkgdir/usr/lib/tmpfiles.d/fail2ban.conf

  # avoid conflict with filesystem>=2012.06
  rm -r $pkgdir/var/run
}

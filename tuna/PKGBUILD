# Maintainer: Ninez <triplesquarednine@gmail.com>
pkgname=tuna
pkgver=1.11.1
pkgrel=3
pkgdesc="Thread and IRQ affinity setting GUI and cmd line tool"
arch=('any')
url="https://git.fedorahosted.org/git/tuna.git"
license=('GPL')
depends=('python2' 'python2-numpy' 'pygtk' 'libglade' 'gksu' 'python2-matplotlib' 'python2-linux-procfs' 'python2-schedutils' 'python2-ethtool')
options=(!emptydirs)
provides=('tuna')
conflicts=('tuna')
replaces=('tuna')
source=("https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_MRG/1.3/pdf/Tuna_User_Guide/Red_Hat_Enterprise_MRG-1.3-Tuna_User_Guide-en-US.pdf"
        "git://git.fedorahosted.org/git/tuna.git"
        "CLI-fix-ps_show_thread-call-with-bad-args-count.patch"
        "CLI-fix-traceback-where-enter-p-policy-without-prio.patch"
        "git-housekeeping-Add-the-.gitattributes-file.patch"
        "spec-Mark-configuration-files-with-config.patch"
        "spec-Show-where-the-original-source-comes-from-in-co.patch"
        "tuna-modified-sysctl-settings-in-example.conf.patch"
        "tuna_gui_custom_icon.patch"
        "tuna.desktop"
        "tuna.png")
md5sums=('5063ff3dda91f7e69f9e394bbf5bb498'
         'SKIP'
         '75076c239e248c9c208bd03fbd38271a'
         'a689543b7a7111b65007ebb4c890866b'
         '09c5d3f716e5124813596199579ab8e2'
         '1638fa06e18203a61757fbb7d39f581d'
         '2c86e8b5c9720d4431fe5b83bb7503f6'
         '5b698b8f8eeeeea2d8082bb27403c5fe'
         '248abfd1d313441acc9ab535164c30e4'
         'b77564f15e71dd162a864789d6bbdcd7'
         'ef1e0fb8548318b196ce1de705a4d68c')

prepare() {

  cd "$srcdir/tuna"

  # Add downstream patches from CentOS7[/RHEL] 

  patch -Np1 -i "${srcdir}/CLI-fix-ps_show_thread-call-with-bad-args-count.patch"
  patch -Np1 -i "${srcdir}/CLI-fix-traceback-where-enter-p-policy-without-prio.patch"
  patch -Np1 -i "${srcdir}/git-housekeeping-Add-the-.gitattributes-file.patch"
  patch -Np1 -i "${srcdir}/spec-Mark-configuration-files-with-config.patch"
  patch -Np1 -i "${srcdir}/spec-Show-where-the-original-source-comes-from-in-co.patch"
  patch -Np1 -i "${srcdir}/tuna-modified-sysctl-settings-in-example.conf.patch"
  patch -Np1 -i "${srcdir}/tuna_gui_custom_icon.patch"

  # Sed command for python2

  find tuna-cmd.py -type f -exec sed -e 's|^#!.*python|#!/usr/bin/env python2|g' -i {} \;
  find oscilloscope-cmd.py -type f -exec sed -e 's|^#!.*python|#!/usr/bin/env python2|g' -i {} \;

}

package() {

  cd "$srcdir/tuna"

  python2 setup.py install --root="$pkgdir/"

  mkdir -p "$pkgdir/etc"
  mkdir -p "$pkgdir/etc/tuna"
  mkdir -p "$pkgdir/usr/bin"
  mkdir -p "$pkgdir/usr/share/man"
  mkdir -p "$pkgdir/usr/share/man/man8"
  mkdir -p "$pkgdir/usr/share/polkit-1"
  mkdir -p "$pkgdir/usr/share/polkit-1/actions"
  mkdir -p "$pkgdir/usr/share/tuna"
  mkdir -p "$pkgdir/usr/share/tuna/help"
  mkdir -p "$pkgdir/usr/share/tuna/help/kthreads"
  mkdir -p "$pkgdir/usr/share/tuna/docs"
  mkdir -p "$pkgdir/usr/share/tuna/img"
  mkdir -p "$pkgdir/usr/share/applications"

  install -p -m644 $srcdir/tuna/org.tuna.policy $pkgdir/usr/share/polkit-1
  install -p -m775 $srcdir/tuna/oscilloscope-cmd.py $pkgdir/usr/bin/oscilloscope
  install -p -m775 $srcdir/tuna/tuna-cmd.py $pkgdir/usr/bin/tuna
  install -p -m644 $srcdir/tuna/tuna/tuna_gui.glade $pkgdir/usr/share/tuna
  install -p -m644 $srcdir/tuna/help/kthreads/* $pkgdir/usr/share/tuna/help/kthreads
  install -p -m644 $srcdir/tuna/docs/tuna.8 $pkgdir/usr/share/man/man8
  install -p -m644 $srcdir/tuna/etc/tuna/example.conf $pkgdir/etc/tuna
  install -p -m644 $srcdir/tuna/etc/tuna.conf $pkgdir/etc
  install -p -m644 $srcdir/Red_Hat_Enterprise_MRG-1.3-Tuna_User_Guide-en-US.pdf $pkgdir/usr/share/tuna/docs/rhel_Tuna_User_Guide.pdf
  install -p -m644 $srcdir/tuna.png $pkgdir/usr/share/tuna/img
  install -p -m644 $srcdir/tuna.desktop $pkgdir/usr/share/applications

}

# vim:set ts=2 sw=2 et:

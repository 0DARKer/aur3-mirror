From: Julian Taylor <jtaylor.debian@googlemail.com>
Date: Tue, 19 Apr 2011 19:44:11 +0200
Subject: work around quicksearch crash

Bug: http://sourceforge.net/tracker/?func=detail&aid=3286048&group_id=95013&atid=609908
Applied-Upstream: 2.16
---
 KeePass/Forms/MainForm.cs           |    8 +++-----
 KeePass/Forms/MainForm_Functions.cs |   10 +++++++++-
 2 files changed, 12 insertions(+), 6 deletions(-)

diff --git a/KeePass/Forms/MainForm.cs b/KeePass/Forms/MainForm.cs
index ee82a9f..e0e1bcb 100644
--- a/KeePass/Forms/MainForm.cs
+++ b/KeePass/Forms/MainForm.cs
@@ -1021,18 +1021,16 @@ namespace KeePass.Forms
 			}
 
 			// Update the history items in the combobox
-			bool bDoSetText = false;
 			if(nExistsAlready >= 0)
-			{
 				m_tbQuickFind.Items.RemoveAt(nExistsAlready);
-				bDoSetText = true;
-			}
 			else if(m_tbQuickFind.Items.Count >= 8)
 				m_tbQuickFind.Items.RemoveAt(m_tbQuickFind.Items.Count - 1);
 
 			m_tbQuickFind.Items.Insert(0, strSearch);
 
-			if(bDoSetText) m_tbQuickFind.Text = strSearch;
+			// if(bDoSetText) m_tbQuickFind.Text = strSearch;
+			m_tbQuickFind.SelectedIndex = 0;
+			m_tbQuickFind.Select(0, strSearch.Length);
 
 			m_bBlockQuickFind = false;
 		}
diff --git a/KeePass/Forms/MainForm_Functions.cs b/KeePass/Forms/MainForm_Functions.cs
index 708f815..8f21a4f 100644
--- a/KeePass/Forms/MainForm_Functions.cs
+++ b/KeePass/Forms/MainForm_Functions.cs
@@ -1074,7 +1074,15 @@ namespace KeePass.Forms
 				}
 			}
 
-			if(lviFocused != null) m_lvEntries.FocusedItem = lviFocused;
+			if(lviFocused != null)
+			{
+				try { m_lvEntries.FocusedItem = lviFocused; } // .NET
+				catch(Exception)
+				{
+					try { lviFocused.Focused = true; } // Mono
+					catch(Exception) { Debug.Assert(false); }
+				}
+			}
 
 			View view = m_lvEntries.View;
 			if(m_bSimpleTanView)
-- 

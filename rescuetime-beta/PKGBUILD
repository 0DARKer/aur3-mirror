# Maintainer: Samuel Littley (aur <at> toastwaffle <dot> com)

basename=rescuetime
pkgname="$basename-beta"
pkgver=2.6.8.557
pkgrel=1
pkgdesc="RescueTime time tracker software (binary beta) + firefox extension"
url="https://www.rescuetime.com"
arch=('i686' 'x86_64')
license=('GPL2')
depends=('qt4' 'xprintidle')
optdepends=('firefox: site time tracking')

if [ $CARCH = "x86_64" ]
then
  suffix="amd64"
  sha1sums=('1863e0ead5cfd56212d7634b923004a0cfa27e56')
else
  suffix="i386"
  sha1sums=('332ece2d754a19a8da01c4c1f51f69b4ff3508f9')
fi

debname="${basename}_${pkgver}_$suffix.deb"
xpiname="${basename}-firefox-extension.xpi"
source=("$url/installers/$debname" "$url/installers/$xpiname")
sha1sums[${#sha1sums[@]}]='cc33fba7e56e75be741d5b794f9ed08f032d370c'

noextract=(${source[@]##*/})

package() {
  cd "$srcdir" && \
  ar x "$debname" && \
  tar -zxf data.tar.gz && \
  mkdir -p ${pkgdir}/usr/bin && \
  cp usr/bin/rescuetime ${pkgdir}/usr/bin || return 1

  which firefox &>/dev/null || return 0

  ffext_dir="${pkgdir}/usr/lib/firefox/extensions"
  xpi_dir="${ffext_dir}/__tmp__"

  mkdir -p $xpi_dir && \
  unzip -d "$xpi_dir" "$srcdir/$xpiname" || return 1
  extid="$(sed -e 's#.*<em:id>\(.*\)</em:id>#\1#;tq;d;:q;q' "$xpi_dir"/install.rdf)"
  [ $? -eq 0 -a -n "$extid" ] && \
  mv "$xpi_dir" "$ffext_dir/$extid"
}

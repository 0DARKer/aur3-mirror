# Maintainer: Patryk Kowalczyk <patryk at kowalczyk dot ws> 

pkgname=virt-manager-git
_pkgname=virt-manager
pkgver=20130308
pkgrel=1
pkgdesc="A desktop user interface for managing virtual machines."
arch=('any')
url="http://virt-manager.et.redhat.com"
license=('GPL')
depends=('dbus-python' 'libvirt' 'libxml2' 'vte' 'virtinst-git>=20130304' 'gtk-vnc' 'rarian' 'gconf'
         'yajl' 'librsvg' 'python2' 'python2-gconf' 'spice')
makedepends=('gnome-doc-utils' 'intltool>=0.35.0' 'git')
optdepends=('x11-ssh-askpass: for ssh authentication to remote servers'
            'libuser: for virt-manager-tui'
            'python2-ipy: for virt-manager-tui'
            'newt-syrup: for virt-manager-tui')
install=virt-manager.install
conflicts=('virt-manager')
provides=('virt-manager')

_gitroot=git://git.fedorahosted.org/git/virt-manager.git
_gitname=virt-manager

build() {
  cd $srcdir

  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi


  msg "GIT checkout done or server timeout"
  msg "Starting build..."
  rm -rf "$srcdir/$_gitname-build" | return 0 
  cp -rp "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  
  cd $srcdir/$_gitname-build
  export LDFLAGS=-lX11
  ./autogen.sh
  sed -i 's#python#python2#' src/virt-manager.in src/virt-manager-tui.in
  ./configure --prefix=/usr \
	--with-qemu-user \
	--with-tui \
	--with-kvm-packages \
        --sysconfdir=/etc \
	--with-default-graphics=spice \
        --libexec=/usr/lib/$_pkgname \
        --localstatedir=/var
  make
}

package() {
  cd "$srcdir/$_gitname-build"
  make GCONF_DISABLE_MAKEFILE_SCHEMA_INSTALL=1 DESTDIR=$pkgdir install
  # Set-up schema file in correct location
  install -m755 -d $pkgdir/usr/share/gconf/schemas
  gconf-merge-schema \
        $pkgdir/usr/share/gconf/schemas/$_pkgname.schemas \
        $pkgdir/etc/gconf/schemas/*.schemas
  rm -rf $pkgdir/etc/gconf/schemas
  rmdir --ignore-fail-on-non-empty $pkgdir/etc/gconf $pkgdir/etc
}

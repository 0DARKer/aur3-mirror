# Contributor: Philipp 'TamCore' B. <philipp {at} tamcore {dot} eu>

pkgname=etherpad
pkgver=1.1.3
pkgrel=3
pkgdesc="This is the open source release of EtherPad, a web-based realtime collaborative document editor"
url="http://code.google.com/p/etherpad/"
license=('APACHE')
arch=('i686' 'x86_64')
depends=('scala' 'mysql' 'jre')
makedepends=('mercurial' 'jdk' 'javacc')
options=()
source=(http://ftp.gwdg.de/pub/misc/mysql/Downloads/Connector-J/mysql-connector-java-5.1.11.tar.gz etherpad.sh etherpad.install)
install=('etherpad.install')

md5sums=('22630172e67c1a96996c3201d9b30398'
         '5d0397f4fa54bf2d3d585e408ee88451'
         '4eb40bd61722a322f80bfdd1a00da362')

_hgroot="https://etherpad.googlecode.com/hg"
_hgrepo="etherpad"

build() {
	export PATH=/opt/java/bin:$PATH
	mkdir -p $pkgdir{/opt/etherpad,/etc/profile.d}
	install -m644 etherpad.sh $pkgdir/etc/profile.d

	tar xfz mysql-connector-java-5.1.10.tar.gz
	export MYSQL_CONNECTOR_JAR=$srcdir/mysql-connector-java-5.1.10/mysql-connector-java-5.1.10-bin.jar

	msg "Connecting to Mercurial server..."
	if [ -d $_hgrepo ]; then
		cd $_hgrepo
		hg pull -u || return 1
		msg2 "The local files have been updated"
	else
		hg clone $_hgroot $_hgrepo || return 1
		msg2 "Mercurial checkout done"
	fi

	if [ ! -z "`grep 'localbox.info' $srcdir/etherpad/trunk/etherpad/src/etherpad/globals.js`" ]; then
		echo "Under which domain do you want to run etherpad? "
		read domain
		sed -i "s/localbox.info/${domain}/" $srcdir/etherpad/trunk/etherpad/src/etherpad/globals.js
	fi

	if [ ! -z "`grep 'listen = 9000' $srcdir/etherpad/trunk/etherpad/etc/etherpad.localdev-default.properties`" ]; then
		echo "On which port do you want to run etherpad?: "
		read port
		sed -i "s/listen = 9000/listen = ${port}/" $srcdir/etherpad/trunk/etherpad/etc/etherpad.localdev-default.properties
	fi

	if [ ! -z "`grep 'etherpad.adminPass = password' $srcdir/etherpad/trunk/etherpad/etc/etherpad.localdev-default.properties`" ]; then
		echo "Enter an Adminpassword: "
		read adminpass
		sed -i "s/etherpad.adminPass = password/etherpad.adminPass = ${adminpass}/" $srcdir/etherpad/trunk/etherpad/etc/etherpad.localdev-default.properties
	fi

	cd $srcdir/etherpad/trunk/etherpad
	bin/rebuildjar.sh

	cp -a $srcdir/${_hgrepo}/trunk/* $pkgdir/opt/etherpad

	rm -rf `find ${pkgdir} -iname .git*`
}


# Creator: Micael Dias <kam1kaz3@gmail.com>

pkgname=monav-preprocessor-gui-hg
pkgver=471
pkgrel=1
pkgdesc="MoNav is a Desktop / Mobile application that offers state-of-the-art fast and exact routing with OpenStreetMap Data."
arch=('i686' 'x86_64')
url="http://code.google.com/p/monav/"
license=('GPLv3')
depends=('qt' 'mapnik' 'libxml2' 'bzip2' 'protobuf')
makedepends=('subversion' 'gcc' 'protobuf')
conflicts=('monav-preprocessor-gui')
provides=("monav-preprocessor-gui")

_hgroot=https://monav.googlecode.com/hg/
_hgrepo=monav-preprocessor-gui

build()
{
	cd "${srcdir}"

	# get most recent data from mercurial
	if [ -d ${_hgrepo} ]; then
		(cd ${_hgrepo} && hg pull -u) || return 1
	else
		hg clone ${_hgroot} || return 1
	fi

	msg "Mercurial clone done or server timeout"
	msg "Starting qmake..."

	# remove previous build data
	if [ -d ${_hgrepo}-build ];then
		rm -rf ${_hgrepo}-build
	fi

	# copy files to build dir
	cp -r ${_hgrepo} ${_hgrepo}-build
	cd ${_hgrepo}-build

	# regenerate protocol files
        # (unneeded from r510 on, but keeping here just
        # in case protobuf gets updated again)
	#protoc -I="plugins/osmimporter/protobuff definitions" --cpp_out="plugins/osmimporter/protobuff definitions" "plugins/osmimporter/protobuff definitions"/fileformat.proto
	#protoc -I="plugins/osmimporter/protobuff definitions" --cpp_out="plugins/osmimporter/protobuff definitions" "plugins/osmimporter/protobuff definitions"/osmformat.proto

	# generate make files
	qmake CONFIG+=release monavpreprocessor-gui.pro || return 1

	msg "Compiling..."

	# make
	make || return 1
}

package()
{
	#cd "$srcdir"/${_hgrepo}-build
	#make INSTALL_ROOT="${pkgdir}" install || return 1

	# for some reason the "make install" is reporting "nothing to do", so lets do this manually
	install -d "${pkgdir}"/usr/bin
	install -m 0755 "$srcdir"/${_hgrepo}-build/bin/monav-preprocessor-gui "${pkgdir}"/usr/bin
}

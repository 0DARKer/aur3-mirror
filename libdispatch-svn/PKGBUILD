# Maintainer: Jens Staal <staal1978@gmail.com>
# Contributor: Sebastien Binet <binet@farnsworth>

pkgname=libdispatch-svn 
pkgver=197
pkgrel=1
pkgdesc="The libdispatch userspace implementation of the Grand Central Dispatch API, compiled with blocks support"
url="http://libdispatch.macosforge.org/"
arch=('i686' 'x86_64')
license=('Apache')
depends=('libkqueue-svn' 'clang' 'llvm-compiler-rt-svn' 'libbsd-git')
makedepends=('subversion' 'pkgconfig')
conflicts=('libdispatch' 'libdispatch-svn')
provides=('libdispatch')

source=('configure.ac.patch' 'dispatchtestc.patch' 'arc4randomc.patch')
md5sums=('c88be0d426d7129d313580d7b745371c' 'ae16fab83bf82c8fc0b62b0f2e519dc9' '34e343b787537c9996a579e1bf727243')


_svntrunk=http://svn.macosforge.org/repository/libdispatch/trunk
_svnmod=libdispatch-svn

build() {
  cd $srcdir
  rm -rf ${_svnmod}
  msg "fetching sources from SVN..."
  svn co ${_svntrunk} -r ${pkgver} ${_svnmod} || return 1

  msg "making a local include directory"
  rm -rf $srcdir/include
  mkdir "$srcdir/include"
  mkdir "$srcdir/include/bsd"
  cp /usr/include/libbsd/bsd/unistd.h $srcdir/include/
  cp /usr/include/libbsd/bsd/string.h $srcdir/include/
  cp -ar /usr/include/libbsd/bsd/* $srcdir/include/bsd/

  msg "patching sources for Linux"
  cd $srcdir
  patch -p0 < $srcdir/configure.ac.patch || return 1
#patching up to make sure that libbsd is used for certain things
  patch $srcdir/$_svnmod/testing/dispatch_test.c -i $srcdir/dispatchtestc.patch
  patch $srcdir/$_svnmod/testing/shims/arc4random.c -i $srcdir/arc4randomc.patch

  msg "configuring the build environment"
  cd $srcdir/$_svnmod
  export CC=clang
  export CXX=clang++
  export LD=/usr/bin/llvm-ld
  export CFLAGS="-O2 -I/usr/include/kqueue/ -I/usr/include/ -I$srcdir/include/"
  export CXXFLAGS="$CFLAGS"
  export LDLIBS="-lbsd"
  sh ./autogen.sh || return 1
  ./configure --prefix=/usr --with-blocks-runtime=/usr/lib || return 1

  msg "starting make"
  make || return 1
  make DESTDIR=$pkgdir install || return 1

  # remove libtool file
  rm $pkgdir/usr/lib/libdispatch.la
}

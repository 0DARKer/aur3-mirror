# Maintainer: Jens Staal <staal1978@gmail.com>
# Contributor: Sebastien Binet <binet@farnsworth>

pkgname=libdispatch-svn 
pkgver=197
pkgrel=1
pkgdesc="The libdispatch userspace implementation of the Grand Central Dispatch API, compiled with blocks support"
url="http://libdispatch.macosforge.org/"
arch=('i686' 'x86_64')
license=('Apache')
depends=('libkqueue-svn' 'clang' 'llvm-compiler-rt-svn' 'libbsd-git')
makedepends=('subversion' 'pkgconfig')
conflicts=('libdispatch' 'libdispatch-svn')
provides=('libdispatch')

source=('configure.ac.patch' 'dispatchtestc.patch' 'arc4randomc.patch' 'dispatchh.patch' 'dispatchcascadec.patch' \
'dispatchpriorityc.patch' 'privateh.patch' 'internalh.patch' 'dispatchafterc.patch' 'queuefinalizerc.patch')
md5sums=('c88be0d426d7129d313580d7b745371c' 'ae16fab83bf82c8fc0b62b0f2e519dc9' '34e343b787537c9996a579e1bf727243' \
'f16be912cb4bbe273f79335a63ea9b93' '70156292c623b66f7f7c8af6f2b0aeea' '52808c5ea7e0d0ce4b6cbfd911236374' \
'34e343b787537c9996a579e1bf727243' '11bca09f2f37d6786d29cfe6cb3c3ec7' '70156292c623b66f7f7c8af6f2b0aeea' \
'70156292c623b66f7f7c8af6f2b0aeea')


_svntrunk=http://svn.macosforge.org/repository/libdispatch/trunk
_svnmod=libdispatch-svn

build() {
  cd $srcdir
  rm -rf ${_svnmod}
  msg "fetching sources from SVN..."
  svn co ${_svntrunk} -r ${pkgver} ${_svnmod} || return 1

  msg "making a local include directory"
  rm -rf $srcdir/include
  mkdir "$srcdir/include"
  cp /usr/include/libbsd/bsd/unistd.h $srcdir/include/
  cp /usr/include/libbsd/bsd/string.h $srcdir/include/

  msg "patching sources for Linux"
  cd $srcdir
  patch -p0 < $srcdir/configure.ac.patch || return 1
#patching up to make sure that libbsd is used for certain things and avoid evilness of glibc
  patch $srcdir/$_svnmod/dispatch/dispatch.h -i $srcdir/dispatchh.patch
  patch $srcdir/$_svnmod/src/private.h -i $srcdir/privateh.patch
  patch $srcdir/$_svnmod/src/internal.h -i $srcdir/internalh.patch
  patch $srcdir/$_svnmod/testing/dispatch_test.c -i $srcdir/dispatchtestc.patch
  patch $srcdir/$_svnmod/testing/dispatch_cascade.c -i $srcdir/dispatchcascadec.patch
  patch $srcdir/$_svnmod/testing/dispatch_priority.c -i $srcdir/dispatchpriorityc.patch
  patch $srcdir/$_svnmod/testing/dispatch_after.c -i $srcdir/dispatchafterc.patch
  patch $srcdir/$_svnmod/testing/queue_finalizer.c -i $srcdir/queuefinalizerc.patch
  patch $srcdir/$_svnmod/testing/shims/arc4random.c -i $srcdir/arc4randomc.patch


  msg "configuring the build environment"
  cd $srcdir/$_svnmod
  export CC=clang
  export CXX=clang++
  export LD=/usr/bin/llvm-ld
  export CFLAGS="-O2 -I$srcdir/include/ -I/usr/include/kqueue/ -I/usr/include/libbsd/"
  export CXXFLAGS="$CFLAGS"
  export LDLIBS="-lbsd"
  sh ./autogen.sh || return 1
  ./configure --prefix=/usr --with-blocks-runtime=/usr/lib || return 1

  msg "starting make"
  make || return 1
  make DESTDIR=$pkgdir install || return 1

  # remove libtool file
  rm $pkgdir/usr/lib/libdispatch.la
}

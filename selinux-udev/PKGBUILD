# Maintainer: Nicky726 (Nicky726 <at> gmail <dot> com)
# Contributor: Aaron Griffin (aaron <at> archlinux <dot> org)
# Contributor: Tobias Powalowski (tpowa <at> archlinux <dot> org)
# Contributor: Thomas BÃ¤chler (thomas <at> archlinux <dot> org)

pkgname=('selinux-udev')
_origname=('udev')
pkgver=171
pkgrel=2
pkgdesc="The userspace dev tools (udev) with SELinux support"
arch=('i686' 'x86_64')
license=('GPL')
groups=('selinux' 'selinux-system-utilities')
url="http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html"
depends=('glibc' 'selinux-coreutils' 'selinux-util-linux' 'libusb-compat' 'glib2'
         'pciutils' 'module-init-tools>=3.11' 'selinux-usr-libselinux')
makedepends=('kernel26-selinux' 'gperf' 'libxslt' 'gobject-introspection')
conflicts=('pcmcia-cs' 'hotplug' 'initscripts<2009.07' 'udev')
replaces=('devfsd')
provides=("${_origname}=${pkgver}-${pkgrel}")
backup=(etc/udev/udev.conf
        etc/modprobe.d/framebuffer_blacklist.conf)
install=udev.install
options=(!makeflags !libtool)
source=(http://www.kernel.org/pub/linux/utils/kernel/hotplug/${_origname}-${pkgver}.tar.bz2
        81-arch.rules 
        static-audio-nodes-group.patch
        static-nodes-permissions.patch)
sha256sums=('fed1e46074c1a16c828193ebd73b3940b7905cc7dcaeb0b3c720d4615210695e'
            'd73311bb7058606c5024d9338fea1da442f99334c4dfddd362aaffac2dc20570'
            '1bf342a379cd0d44219c1a98bd06d830e65774b121d3184e7542e4ae0c45f82f'
            '4a5bf545b09cb564ccf82c870eb0c72f622697f411cf2928b7e6b5c07298084a')

build() {
  cd "${srcdir}/${_origname}-${pkgver}"
  patch -Np1 -i ../static-audio-nodes-group.patch
  patch -Np1 -i ../static-nodes-permissions.patch
  ./configure 	--sysconfdir=/etc --with-rootlibdir=/lib --libexecdir=/lib/udev\
              	--sbindir=/sbin --with-systemdsystemunitdir=/lib/systemd/system\
                --disable-rule-generator --with-selinux
  make
}

package(){
  cd "${srcdir}/${_origname}-${pkgver}"
  make DESTDIR=${pkgdir} install
  # Install our rule for permissions and symlinks
  install -D -m644 $srcdir/81-arch.rules $pkgdir/lib/udev/rules.d/81-arch.rules

  # create framebuffer blacklist
  mkdir -p $pkgdir/etc/modprobe.d/
  for mod in $(find /lib/modules/*/kernel/drivers/video -name '*fb.ko.gz' -exec basename {} .ko \;); do
      echo "blacklist $mod" 
  done | sort -u > $pkgdir/etc/modprobe.d/framebuffer_blacklist.conf


  # create static devices in /lib/udev/devices/
  mkdir ${pkgdir}/lib/udev/devices/pts
  mkdir ${pkgdir}/lib/udev/devices/shm

  mknod -m 0600 ${pkgdir}/lib/udev/devices/console c 5 1
  mknod -m 0666 ${pkgdir}/lib/udev/devices/null c 1 3
  mknod -m 0660 ${pkgdir}/lib/udev/devices/zero c 1 5
  mknod -m 0666 ${pkgdir}/lib/udev/devices/kmsg c 1 11

  ln -snf /proc/self/fd ${pkgdir}/lib/udev/devices/fd
  ln -snf /proc/self/fd/0 ${pkgdir}/lib/udev/devices/stdin
  ln -snf /proc/self/fd/1 ${pkgdir}/lib/udev/devices/stdout
  ln -snf /proc/self/fd/2 ${pkgdir}/lib/udev/devices/stderr
  ln -snf /proc/kcore ${pkgdir}/lib/udev/devices/core

  # these static devices are created for convenience, to autoload the modules if necessary
  # /dev/loop0
  mknod -m 0660 ${pkgdir}/lib/udev/devices/loop0 b 7 0
  chgrp disk ${pkgdir}/lib/udev/devices/loop0
  # /dev/net/tun
  mkdir ${pkgdir}/lib/udev/devices/net
  mknod -m 0666 ${pkgdir}/lib/udev/devices/net/tun c 10 200
  # /dev/fuse
  mknod -m 0666 ${pkgdir}/lib/udev/devices/fuse c 10 229
  # /dev/ppp
  mknod -m 0600 ${pkgdir}/lib/udev/devices/ppp c 108 0

  # Replace dialout/tape/cdrom group in rules with uucp/storage/optical group
  for i in $pkgdir/lib/udev/rules.d/*.rules; do
    sed -i -e 's#GROUP="dialout"#GROUP="uucp"#g;
               s#GROUP="tape"#GROUP="storage"#g;
               s#GROUP="cdrom"#GROUP="optical"#g' $i
  done
}

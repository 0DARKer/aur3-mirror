# Maintainer: Kniyl <mathias dot ettinger at gmail dot com>

pkgname=xkaapi
pkgver=2.0
pkgrel=1
_fileid=31968
pkgdesc="C++ library that implements work stealing algorithm for multithreaded computation"
url="http://kaapi.gforge.inria.fr/dokuwiki/doku.php"
arch=('i686' 'x86_64')
license=('CeCILL')
depends=('glibc' 'hwloc')
source=("https://gforge.inria.fr/frs/download.php/${_fileid}/$pkgname-$pkgver.tar.gz")
md5sums=('e6b5e4cab59d3bd32d2bdb0fc5fb4f3a')

build() {
  cd "${srcdir}"
  rm -rf ${pkgname}-build
  cp -r ${pkgname}-${pkgver//_/-} ${pkgname}-build

  msg "Applying patches..."
	sed -i 's|  bool work_queue|  inline bool work_queue|g' \
		${pkgname}-build/api/kastl/kastl/kastl_workqueue.h 
  sed -i '61c  return (double)ts.tv_sec + 1e-9*(double)ts.tv_nsec;' ${pkgname}-build/src/misc/kaapi_time_elapse.c 

  cd ${pkgname}-build

  msg "Starting make..."
  ./configure \
    --prefix=/usr \
    --enable-mode=release \
    --disable-api-kaapif \
    --disable-api-kastl \
    --disable-libgomp \
    --enable-api-kaapic \
    --enable-api-kaapixx \
    --disable-api-quark

  make
}

package() {
  cd ${pkgname}-build

  make DESTDIR="${pkgdir}" install
}

pkgname=kettle
pkgver=5.0.1
pkgrel=2
pkgdesc="Pentaho Data Integration Community Edition (Kettle) is an ETL tool"
arch=any
url="http://kettle.pentaho.com/"
depends=(java-environment
         swt
         webkitgtk2)
makedepends=(zip)
license=("LGPLv2.1")
options=(!strip)
source=("http://downloads.sourceforge.net/project/pentaho/Data%20Integration/$pkgver-stable/pdi-ce-${pkgver}-stable.zip"
        "spoon-patch.diff"
        "spoon.desktop"
        "Market.class")
md5sums=('514084104dce3166f0c0f3995477952d'
         'a40451b4f842287127aea9ed4ba3537f'
         'd25747bb2d5b45c3e87b08e4c3102723'
         '8b76139273e059b6c0cdc7718f756b6f')

package() {
  cd "$srcdir/data-integration"
  rm -rf "Data Integration.app"
  rm *.bat
  rm README_{OSX,UNIX_AS400,INFOBRIGHT}.txt
  rm -rf libswt/{aix,aix64,hpux,osx,osx64,solaris,solaris-x86,win32,win64}
  rm -rf libswt/linux/{ppc64,ppc}
  rm libswt/linux/{x86,x86_64}/swt.jar
  ln -s /usr/share/java/swt.jar libswt/linux/x86/swt.jar
  ln -s /usr/share/java/swt.jar libswt/linux/x86_64/swt.jar

  patch -p0 < ../spoon-patch.diff

  cd ..
  F='#!/usr/bin/bash\n\n/usr/share/data-integration/%s.sh "$@"\n'
  printf "$F" kitchen > kitchen.sh
  install -D -m755 kitchen.sh $pkgdir/usr/bin/kitchen.sh
  printf "$F" pan > pan.sh
  install -D -m755 pan.sh     $pkgdir/usr/bin/pan.sh
  printf "$F" carte > carte.sh
  install -D -m755 carte.sh   $pkgdir/usr/bin/carte.sh
  printf "$F" import > import.sh
  install -D -m755 import.sh  $pkgdir/usr/bin/import.sh
  #spoon needs to change directory
  echo -e '#!/usr/bin/bash\n\ncd /usr/share/data-integration\n./spoon.sh "$@"\n' > spoon.sh
  install -D -m755 spoon.sh   $pkgdir/usr/bin/spoon.sh
  install -D -m644 spoon.desktop $pkgdir/usr/share/applications/spoon.desktop

  # patched Market.class for installing plugins in ~/.kettle/plugins

  #diff --git a/plugins/market/src/org/pentaho/di/core/market/Market.java b/plugins/market/src/org/pentaho/di/core/market/Market.java
  #index f0ce688..5aadfe9 100644
  #--- a/plugins/market/src/org/pentaho/di/core/market/Market.java
  #+++ b/plugins/market/src/org/pentaho/di/core/market/Market.java
  #@@ -192,9 +192,8 @@ public class Market implements SpoonPluginInterface {
  #     } else {
  #       String subfolder = getInstallationSubfolder(marketEntry);
  # 
  #-      // Use current directory (should be the Kettle distribution directory) as the root folder to install plugins
  #-      // This is because plugin types are not guaranteed to search the ~/.kettle folder for plugins.
  #-      return "plugins" + (subfolder == null ? "" : Const.FILE_SEPARATOR + subfolder);
  #+      return Const.getKettleDirectory() + Const.FILE_SEPARATOR +
  #+              "plugins" + (subfolder == null ? "" : Const.FILE_SEPARATOR + subfolder);
  #     }
  #   }

  mkdir -p org/pentaho/di/core/market
  cp ../Market.class org/pentaho/di/core/market
  zip data-integration/plugins/market/market-$pkgver-stable.jar \
      org/pentaho/di/core/market/Market.class


  cp -a data-integration "$pkgdir/usr/share/data-integration"
  chown -R root:root $pkgdir/usr/share
}

# vim:set ts=2 sw=2 et:

# Maintainer: Sarkasper <echo a2FzcGVyLm1lbnRlbkBnbXguY29tCg== | base64 -d>
pkgname=cogscrobbler-hg
pkgver=0.3.3
pkgrel=1
pkgdesc="because those vinyls aren't going to scrobble themselves"
arch=('any')
url="http://cogscrobbler.ulfurinn.net/"
license=('GPL')
depends=('qt4' 'ruby')
makedepends=('mercurial' 'boost')
provides=('cogscrobbler')
conflicts=('cog-scrobbler-svn')
replaces=('cog-scrobbler-svn' 'cog-scrobbler' 'cogscrobbler')

_hgroot=http://hg.ulfurinn.net/cog-scrobbler
_hgrepo=cog-scrobbler
_bin=cogscrobbler

pkgver() {
  cd _hgrepo
  echo $(hg identify -n).$(hg identify -i)
}

build() {
  cd "$srcdir"
  msg "Connecting to Mercurial server...."

  if [[ -d "$_hgrepo" ]]; then
    cd "$_hgrepo"
    hg pull -u
    msg "The local files are updated."
  else
    hg clone "$_hgroot" "$_hgrepo"
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_hgrepo-build"
  cp -r "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"

  #
  # BUILD HERE
  #
  #./autogen.sh
  #./configure --prefix=/usr
  qmake-qt4 cogscrobbler.pro INSTALL=/usr
  make

  mkdir -p ${pkgdir}/usr/share/$_hgrepo/
  mkdir -p ${pkgdir}/usr/share/applications/
  mkdir -p ${pkgdir}/usr/bin/
  cp $_bin ${pkgdir}/usr/share/$_hgrepo/
  cp res/extract.png ${pkgdir}/usr/share/$_hgrepo/image.png
  ln -s /usr/share/$_hgrepo/$_bin ${pkgdir}/usr/bin/$_bin
  echo "[Desktop Entry]" > $_hgrepo.desktop
  echo "Version=$pkgver" >> $_hgrepo.desktop
  echo "Encoding=UTF-8" >> $_hgrepo.desktop
  echo "MultipleArgs=false" >> $_hgrepo.desktop
  echo "Terminal=0" >> $_hgrepo.desktop
  echo "Icon=/usr/share/$_hgrepo/image.png" >> $_hgrepo.desktop
  echo "Exec=/usr/share/$_hgrepo/$_bin" >> $_hgrepo.desktop
  echo "Categories=Application;AudioVideo;" >> $_hgrepo.desktop
  echo "Type=Application" >> $_hgrepo.desktop
  echo "Name=CogScrobbler" >> $_hgrepo.desktop
  cp ./$_hgrepo.desktop ${pkgdir}/usr/share/applications/
}

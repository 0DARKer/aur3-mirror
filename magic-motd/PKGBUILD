# Maintainer: Josh VanderLinden <arch@cloudlery.com>
pkgname=magic-motd
pkgver=20130116
pkgrel=5
pkgdesc="Generate MOTDs dynamically at boot time"
arch=('any')
url="http://bitbucket.org/instarch/magic-motd"
license=('BSD')
depends=('filesystem' 'systemd' 'ncurses')
makedepends=('git')
provides=('magic-motd')
backup=(
  'etc/conf.d/magic-motd.conf'
)
source=(
  'magic-motd.conf'
  'magic-motd'
  'magic-motd.service'
  'magic-motd-ip'
  'magic-motd-ip.service'
)
md5sums=('2baa9192c43f60da742e8a5cc00778ed'
         '0255d61d20ac65d75e687a4c5a49d7b5'
         'bb7e7fb0fab05b87d573791e9812f669'
         '99d2541feecebc68f8410515f02d9bcb'
         '27b18dc9e5e02b4e7e32a56997918c1d')

_gitroot=http://bitbucket.org/instarch/magic-motd
_gitname=magic-motd-git

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
}

package() {
  cd "$srcdir/$_gitname-build"

  install -D magic-motd.conf "${pkgdir}/etc/conf.d/magic-motd.conf"
  install -D magic-motd.service "${pkgdir}/usr/lib/systemd/system/magic-motd.service"
  install -D magic-motd-ip.service "${pkgdir}/usr/lib/systemd/system/magic-motd-ip.service"

  install -D -m755 magic-motd "${pkgdir}/usr/bin/magic-motd"
  install -D -m755 magic-motd-ip "${pkgdir}/usr/bin/magic-motd-ip"

  install -d -m700 "${pkgdir}/etc/magic-motd.d"

  cp magic-motd.d/* "${pkgdir}/etc/magic-motd.d/"
}

# vim:set ts=2 sw=2 et:

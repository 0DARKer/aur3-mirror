# Maintainer  : Dan Vratil <vratil@progdansoft.com>
# Contributors: Jeremy Sands <cto@jeremysands.com>
# 		Thomas Baechler <thomas@archlinux.org>
#               James Rayner <iphitus@gmail.com>
#               Erik Hardesty <dalingrin@gmail.com>

pkgname=lib32-nvidia-utils-beta
pkgver=270.26
pkgrel=1
pkgdesc="NVIDIA drivers utilities and libraries."
arch=(x86_64)
url="http://www.nvidia.com/"
license=('custom')
groups=('lib32')
depends=('lib32-libxext')
conflicts=('lib32-libgl' 'lib32-ati-fglrx-utils' 'lib32-nvidia-utils')
provides=('lib32-libgl' "lib32-nvidia-utils=${pkgver}")
license=('custom')
source=(ftp://download.nvidia.com/XFree86/Linux-x86_64/${pkgver}/NVIDIA-Linux-x86_64-${pkgver}.run)

build()
{
  cd "${srcdir}"
  if [ -d NVIDIA-Linux-x86_64-${pkgver} ]; then 
	rm -rf NVIDIA-Linux-x86_64-${pkgver}; 
   fi

  # Extract sources
  sh NVIDIA-Linux-x86_64-${pkgver}.run --extract-only
}

package() {

  cd "${srcdir}/NVIDIA-Linux-x86_64-${pkgver}"

  # Create install dirs
  mkdir -p "${pkgdir}/usr/lib32/tls"
  
  # Install libraries
  install 32/{libGL,libnvidia-compiler,libnvidia-glcore,libcuda,libnvidia-tls,libvdpau_nvidia}.so.${pkgver} "${pkgdir}/usr/lib32"
  install 32/tls/libnvidia-tls.so.${pkgver} "${pkgdir}/usr/lib32/tls"
  install -m755 32/libOpenCL.so.1.0.0 "${pkgdir}/usr/lib32"
  #install {libXvMCNVIDIA.a,libXvMCNVIDIA.so.${pkgver}} "${pkgdir}/usr/lib32"
  
  # Create symlinks
  cd "${pkgdir}/usr/lib32"
  ln -s libOpenCL.so.1.0.0 libOpenCL.so.1
  ln -s libOpenCL.so.1 libOpenCL.so
  ln -s libGL.so.${pkgver} libGL.so.1
  ln -s libGL.so.${pkgver} libGL.so
  ln -s libnvidia-glcore.so.${pkgver} libnvidia-glcore.so.1
  ln -s libnvidia-glcore.so.${pkgver} libnvidia-glcore.so
  ln -s libnvidia-cfg.so.${pkgver} libnvidia-cfg.so.1
  ln -s libnvidia-cfg.so.${pkgver} libnvidia-cfg.so
  ln -s libnvidia-compiler.so.${pkgver} libnvidia-compiler.so.1
  ln -s libnvidia-compiler.so.${pkgver} libnvidia-compiler.so
  ln -s libnvidia-tls.so.${pkgver} libnvidia-tls.so.1
  ln -s libnvidia-tls.so.${pkgver} libnvidia-tls.so
  ln -s libcuda.so.${pkgver} libcuda.so.1
  ln -s libcuda.so.${pkgver} libcuda.so
  #ln -s libXvMCNVIDIA.so.${pkgver} libXvMCNVIDIA_dynamic.so.1
  ln -sf libvdpau_nvidia.so.${pkgver} "${pkgdir}/usr/lib32/libvdpau_nvidia.so.1"

  find "${pkgdir}/usr/" -type d -exec chmod 755 {} \;
  #chmod 644 ${pkgdir}/usr/lib32/libXvMCNVIDIA.a
}
md5sums=('b00380380aab1443a61bc822802c0644')

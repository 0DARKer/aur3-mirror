# Maintainer: Malte Wessel <muunleit AT lavabit DOT com>

pkgname=atomzombiesmasher
pkgver=1.85
pkgrel=2
pkgdesc="RTS, evacuating civilians out of zombie-contaminated cities. (Commercial)"
arch=('any')
url="http://blendogames.com/atomzombiesmasher/"
license=("custom:commercial")
conflicts=("atomzombiesmasherdemo")
source=("http://blendogames.com/files/atomzombiepatch_v${pkgver//./_}_linux.tar")
md5sums=('202611030a6a12ca0416e93dd22cfd6c')

## If you get another file from Blendo Games, please change it here
_gamepkg="${pkgname}_v1_23.tar.gz"
_gamemd5="3286a655fd6a34cf376d69a185b5e53f"
## For "The Humble Indie Bundle #3" please uncomment the next 2 lines and delete both above
#_gamepkg="${pkgname}_v1_85.tar.gz"
#_gamemd5="304a494d4c81296c0d13b6cbe051e04c"


build() {
  # Check if game-archive is in build directory, than validate
  cd $startdir
  if [[ ! -f $_gamepkg ]]; then
    msg "!! AtomZombieSmasher is a commercial game.
    !! You need a full copy of this game in order to install it.
    !! Please copy $_gamepkg to $startdir
    !! or if you have 'The Humble Indie Bundle #3'
    !! please copy ${pkgname}_v1_85.tar.gz there and edit the PKGBUILD" && return 1
  else
    if [[ "$(md5sum $_gamepkg | awk '{print $1}')" == "$_gamemd5" ]]; then
      msg "Check: $_gamepkg is the correct."
    else
      msg "!! Check: $_gamepkg didn't match md5sum. Exiting!" && return 1
    fi
  fi

  # Extract game-archive
  msg "Extracting archive..."
  tar xaf $startdir/$_gamepkg -C $srcdir 

  cd $srcdir/$pkgname
  sed -i "s/\.\/data/\/opt\/$pkgname\/data/g" AtomZombieSmasher

  # Copy from patch to game
  msg "Patching to version $pkgver ..."
  cp -a $srcdir/data        $srcdir/$pkgname/
  cp -a $srcdir/readme.htm  $srcdir/$pkgname/

  # Create startscript
  cat > $srcdir/$pkgname.desktop <<-END 
  [Desktop Entry]
  Name=AtomZombieSmasher
  GenericName=AtomZombieSmasher
  Comment=RTS, evacuating civilians out of zombie-contaminated cities
  Exec=atomzombiesmasher
  Icon=/opt/atomzombiesmasher/data/content/textures/icon.png
  Terminal=false
  Type=Application
  Categories=Game;
	END
}

package() {
  # Create pkgdir folders
  install -d $pkgdir/usr/bin
  install -d $pkgdir/usr/share/doc/$pkgname
  install -d $pkgdir/usr/share/applications
  install -g games -d $pkgdir/opt/$pkgname

  # Copy game
  cp -a $srcdir/$pkgname/*              $pkgdir/opt/$pkgname
  mv $pkgdir/opt/$pkgname/readme.htm    $pkgdir/usr/share/doc/$pkgname
  cp -a $srcdir/$pkgname.desktop        $pkgdir/usr/share/applications/

  # executable link
  ln -s /opt/$pkgname/AtomZombieSmasher $pkgdir/usr/bin/$pkgname
}

# vim:set ts=2 sw=2 et:

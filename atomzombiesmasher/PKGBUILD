# Maintainer: Malte Wessel <muunleit AT lavabit DOT com>

pkgname=atomzombiesmasher
pkgver=1.85
pkgrel=4
pkgdesc="RTS, evacuating civilians out of zombie-contaminated cities. (Commercial)"
arch=('any')
url="http://blendogames.com/atomzombiesmasher/"
license=("custom:commercial")
conflicts=("atomzombiesmasherdemo")
source=("http://blendogames.com/files/atomzombiepatch_v${pkgver//./_}_linux.tar")
md5sums=('202611030a6a12ca0416e93dd22cfd6c')

build() {
  # Check if game-archive is in build directory
  cd $startdir
  if [[ -e ${pkgname}_v1_23.tar.gz ]]; then   # If you get another file from Blendo Games, please change it here
    _gamepkg="${pkgname}_v1_23.tar.gz"
    _gamemd5="3286a655fd6a34cf376d69a185b5e53f"
  elif [[ -e ${pkgname}_v1_85.tar.gz ]]; then
    _gamepkg="${pkgname}_v1_85.tar.gz"
    _gamemd5="304a494d4c81296c0d13b6cbe051e04c"
  else
    msg "!! AtomZombieSmasher is a commercial game.
    !! You need a full copy of this game in order to install it.
    !! Please copy ${pkgname}_v1_23.tar.gz or ${pkgname}_v1_85.tar.gz
    !! to $startdir " && return 1
  fi

  # Validate game-archive
  if [[ "$(md5sum $_gamepkg | awk '{print $1}')" == "$_gamemd5" ]]; then
    msg "Check: $_gamepkg is the correct."
  else
    msg "!! Check: $_gamepkg didn't match md5sum!" && return 1
  fi

  # Extract game-archive
  msg "Extracting archive..."
  tar xaf $startdir/$_gamepkg -C $srcdir 

  cd $srcdir/$pkgname
  sed -i "s/\.\/data/\/opt\/$pkgname\/data/g" AtomZombieSmasher

  # Copy from patch to game
  if ! [[ "$_gamepkg" =~ "${pkgver//./_}" ]]; then
    msg "Patching to version $pkgver ..."
    cp -a $srcdir/data        $srcdir/$pkgname/
    cp -a $srcdir/readme.htm  $srcdir/$pkgname/
  fi

  # Create startscript
	cat > $srcdir/$pkgname.desktop <<- EOF
  [Desktop Entry]
  Name=AtomZombieSmasher
  GenericName=AtomZombieSmasher
  Comment=RTS, evacuating civilians out of zombie-contaminated cities
  Exec=atomzombiesmasher
  Icon=/opt/atomzombiesmasher/data/content/textures/icon.png
  Terminal=false
  Type=Application
  Categories=Game;
	EOF
}

package() {
  # Create pkgdir folders
  install -d $pkgdir/usr/bin
  install -d $pkgdir/usr/share/doc/$pkgname
  install -d $pkgdir/usr/share/applications
  install -g games -d $pkgdir/opt/$pkgname

  # Copy game
  cp -a $srcdir/$pkgname/*              $pkgdir/opt/$pkgname
  mv $pkgdir/opt/$pkgname/readme.htm    $pkgdir/usr/share/doc/$pkgname
  cp -a $srcdir/$pkgname.desktop        $pkgdir/usr/share/applications/

  # executable link
  ln -s /opt/$pkgname/AtomZombieSmasher $pkgdir/usr/bin/$pkgname
}

# vim:set ts=2 sw=2 et:

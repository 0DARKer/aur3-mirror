# Maintainer: Michael Schubert <mschu.dev at gmail>

pkgname=ironpython-git
pkgver=20130530
pkgrel=1
pkgdesc="Python implementation for the .NET framework"
arch=("any")
url="http://ironpython.net"
license=("Apache")
depends=('mono')
makedepends=('git')
source=('site.patch')
options=('!strip' 'emptydirs' 'libtool')
md5sums=('dd484ca6dfe03277d8a13e7b1cfe6662')

_gitroot="git://github.com/IronLanguages/main.git"
_gitname="main"

build() {
  cd "$srcdir"

  msg "Connecting to GIT server...."
  if [ -d "${srcdir}/${_gitname}" ] ; then
    cd ${_gitname}
    git pull --rebase
  else
    git clone ${_gitroot}
    cd ${_gitname}
  fi

  sed -i "/NoWarn/s|444;||" Solutions/Common.proj
  xbuild Solutions/IronPython.sln /p:Mono=true /p:Configuration="Release"
}

package() {
  mkdir -p "$pkgdir/opt/ipy" "$pkgdir/usr/bin"
  cp -r $srcdir/main/bin/Release/* "$pkgdir/opt/ipy"
  for bin in ipy ipy64 ipyw ipyw64; do
    echo -e "#!/bin/sh\nmono /opt/ipy/$bin.exe $*" > "$pkgdir/usr/bin/$bin"
    chmod +x "$pkgdir/usr/bin/$bin"
  done

  cd "$pkgdir/opt/ipy/Lib"
  patch -p0 < "$srcdir/site.patch"
}


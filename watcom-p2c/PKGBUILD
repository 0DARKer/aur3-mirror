# Maintainer: Jens Staal <staal1978@gmail.com>

pkgname=watcom-p2c
pkgdesc="Pascal-to-C translator front-end to Open Watcom (multi-target cross compiler)"
groups=('watcom-linux' 'watcom-win32' 'watcom-win16' 'watcom-dos' 'watcom-os2' 'watcom-netware')
pkgver=1.21alpha2
pkgrel=2
arch=('i686' 'x86_64')
license=('GPL' 'LGPL')
depends=('open_watcom-v2' 'perl')
makedepends=('open_watcom-v2')
url="http://schneider.ncifcrf.gov/p2c/"
source=("http://schneider.ncifcrf.gov/p2c/p2c-1.21alpha2.tar.gz" "ow_p2cc" "pragma.patch")
options=(!strip !buildflags staticlibs emptydirs)
md5sums=('8340429ae80be2e0e82c01f70c0355bb' '08a2b1ee790b53922fd741a3e3349009' 'c11e95a9ffaa3747d5e22b72bffeadd8')

build() {
  cd $srcdir/src
  source /opt/watcom/owsetenv.sh
  sed 's|CC = cc|CC = owcc|g' -i Makefile
  sed 's|OPT = # -O|OPT = -O3|g' -i Makefile
  sed 's|libp2c.a|libp2c.lib|g' -i Makefile
  sed 's|if \[ -f \/usr\/bin\/ranlib|#if \[ -f \/usr\/bin\/ranlib|g' -i Makefile
  sed 's|ar r |wlib -c -q -n -t |g' -i Makefile  
  sed 's|HOMEDIR = ..\/home|HOMEDIR = \/opt\/watcom\/p2c|g' -i Makefile
  
  cp Makefile Makefile.generic
  
  msg "building linux p2c compiler + library"
  mkdir -p $srcdir/linux/{binl,{h,lh}/p2c,p2c,lib386/linux}
  sed 's|DEFS =|DEFS = -blinux|g' -i Makefile
  sed 's|INCDIR = ..\/home\/p2c|INCDIR = \/opt\/watcom\/lh\/p2c|g' -i Makefile
  sed 's|LIBDIR = ..\/home|LIBDIR = \/opt\/watcom\/lib386\/linux|g' -i Makefile
  make -f Makefile all
  #prepend pragma library in header
  patch p2c.h < $srcdir/pragma.patch
  cp p2c.h $srcdir/linux/lh/p2c/
  cp p2c.h $srcdir/linux/h/p2c/
  cp libp2c.lib $srcdir/linux/lib386/linux/
  cp sys.p2crc p2crc
  cp {loc.p2crc,p2crc,string.pas,system.imp,system.m2,turbo.imp} $srcdir/linux/p2c/
  cp p2c $srcdir/linux/binl/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building 16 bit dos p2c library"
  mkdir -p $srcdir/dos/lib286/dos
  export INCLUDE=$WATCOM/h
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bdos|g' -i Makefile
  make -f Makefile all
  cp libp2c.lib $srcdir/dos/lib286/dos/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building 32 bit dos p2c library"
  mkdir -p $srcdir/dos/lib386/dos
  export INCLUDE=$WATCOM/h
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bdos4g|g' -i Makefile
  make -f Makefile all
  cp libp2c.lib $srcdir/dos/lib386/dos/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building win16 p2c library"
  mkdir -p $srcdir/win/lib286/win
  export INCLUDE=$WATCOM/h:$WATCOM/win
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bwindows|g' -i Makefile
  make -f Makefile all
  cp libp2c.lib $srcdir/win/lib286/win/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building win32 p2c library"
  mkdir -p $srcdir/nt/lib386/nt
  export INCLUDE=$WATCOM/h:$WATCOM/nt
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bnt|g' -i Makefile
  make -f Makefile libp2c.lib
  cp libp2c.lib $srcdir/nt/lib386/nt/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building 16 bit OS/2 p2c library"
  mkdir -p $srcdir/os2/lib286/os2
  export INCLUDE=$WATCOM/h:$WATCOM/os21x
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bos2|g' -i Makefile
  make -f Makefile libp2c.lib
  cp libp2c.lib $srcdir/os2/lib286/os2/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "building 32 bit OS/2 p2c library"
  mkdir -p $srcdir/os2/lib386/os2
  export INCLUDE=$WATCOM/h:$WATCOM/os2
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bos2v2|g' -i Makefile
  make -f Makefile libp2c.lib
  cp libp2c.lib $srcdir/os2/lib386/os2/
  make -f Makefile clean
  rm -f *.{o,lib}
  
  msg "buiding 32 bit netware p2c library"
  mkdir -p $srcdir/netware/lib386/netware
  export INCLUDE=$WATCOM/h
  cp Makefile.generic Makefile
  sed 's|DEFS =|DEFS = -bnetware|g' -i Makefile
  make -f Makefile libp2c.lib
  cp libp2c.lib $srcdir/netware/lib386/netware/
  make -f Makefile clean
  rm -f *.{o,lib}
 }

package() {
  cd $srcdir/
  mkdir -p ${pkgdir}${WATCOM}/{binl,lib286/{dos,win,os2},lib386/{dos,nt,os2,linux,netware},h,lh}
  cp -ar {dos,win,nt,linux,os2,netware}/* ${pkgdir}${WATCOM}/
  install -m755 $srcdir/ow_p2cc ${pkgdir}${WATCOM}/binl/p2cc
}


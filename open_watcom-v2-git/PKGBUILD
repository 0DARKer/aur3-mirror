# Mantainer Jens Staal <staal1978@gmail.com>

pkgname=open_watcom-v2-git
pkgver=0.r1981.g1563ea2
pkgrel=1
pkgdesc="The Open Watcom C/C++ compiler, github source fork"
arch=('i686' 'x86_64')
url="http://open-watcom.github.io/open-watcom/"
#url="http://www.openwatcom.org"
license=('custom:OWPL-1')

makedepends=('dosemu-git' 'git')
optdepend=('open_watcom: skip bootstrapping with gcc')
provides=('open_watcom' 'openwatcom-extras-hg')
conflicts=('open_watcom' 'openwatcom-extras-hg')
replaces=('open_watcom' 'openwatcom-extras-hg')

source=('watcom'::'git://github.com/open-watcom/open-watcom-v2.git' 'setvars.sh')
sha256sums=('SKIP' 'bde88fced436006e8d4060b44fcfcbb86264073ec8440732d2068a33784509ed')

options=('!strip' 'staticlibs')

pkgver() {
  cd $srcdir/watcom/

  if GITTAG="$(git describe --abbrev=0 --tags 2>/dev/null)"; then
    echo "$(sed -e "s/^${pkgname%%-git}//" -e 's/^[-_/a-zA-Z]\+//' -e 's/[-_+]/./g' <<< ${GITTAG}).r$(git rev-list --count ${GITTAG}..).g$(git log -1 --format="%h")"
  else
    echo "0.r$(git rev-list --count master).g$(git log -1 --format="%h")"
  fi
}

build() {
  cd $srcdir/watcom
  
  msg "set current source directory and other variables"
  cat $srcdir/setvars.sh | sed "s|CurrentPkgbuildDir|${PWD}|g" > setvars.sh
  
  msg "use OpenWatcom if possible..."
  if [ -d /opt/watcom ]; then
    if [ "${CARCH}" = "i686" ]; then
      sed -i 's/OWUSENATIVETOOLS=1/OWUSENATIVETOOLS=0/g' setvars.sh
    fi
  else
    msg2 "OpenWatcom does not support 64-bit targets (yet), fall back to GCC"
    #still a bit confusing. Bootstrap builds watcom with watcom anyway
    #can we not use a 32-bit build of watcom built with watcom on x86_64?
  fi
  
  chmod +x build.sh
  source setvars.sh
  msg "OWROOT is $OWROOT" #testing variables from setvars.sh
  msg "OWSRCDIR is $OWSRCDIR" #testing variables from cmnvars.sh
  ./build.sh
}

package() {
 install -d "$pkgdir/usr/share/licenses/watcom"
 install -Dm644 "$srcdir/temp/license.txt" "$pkgdir/usr/share/licenses/watcom/license.txt"
 
 msg "installing the Linux stuff..."
 mkdir -p $pkgdir/opt/watcom/{binl,eddat,lh,lib286,lib386}
 install -m755 $srcdir/watcom/rel/bin/* $pkgdir/opt/watcom/binl/
 cp -r $srcdir/temp/bld/hdr/linux/* $pkgdir/opt/watcom/lh/
 chmod -R 644 $pkgdir/opt/watcom/lh/*
 
 msg "adding cross-compilation headers and libraries to package"
 msg2 "Win32..."
 msg2 "DOS..."
 
 msg "adding some fake binaries to make life easier"
 cd $pkgdir/opt/watcom/binl
 ln -s /bin/true ranlib
 ln -s wlib ar
}

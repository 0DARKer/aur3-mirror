# Maintainer: naelstrof <naelstrof@gmail.com>

# This PKGBUILD is modified from Arch's official Boost PKGBUILD to build the Boost.nowide library.

pkgname=boost-nowide
pkgdesc="Boost.Nowide is a library implemented by Artyom Beilis that make cross platform Unicode aware programming easier."
depends=('boost')
pkgver=1.0
_boostbase=boost
_boostver=1_50_0
pkgrel=1
arch=('i686' 'x86_64')
url="http://cppcms.com/files/nowide/html/"
makedepends=('python2' 'bzip2' 'zlib' 'unzip')
source=(http://downloads.sourceforge.net/sourceforge/${_boostbase}/${_boostbase}_${_boostver}.tar.gz
        http://cppcms.com/files/nowide/nowide.zip)
license=('custom')
options=('!ccache')
md5sums=('dbc07ab0254df3dda6300fd737b3f264'
         '05869af83b7f72ef310e690ca2444078')

_stagedir="${srcdir}/stagedir"

build() {
  cp -a ${srcdir}/nowide/boost ${srcdir}/${_boostbase}_${_boostver}
  cp -a ${srcdir}/nowide/libs ${srcdir}/${_boostbase}_${_boostver}

  # set python path for bjam
  cd "${srcdir}/${_boostbase}_${_boostver}/tools"
  echo "using python : 2.7 : /usr/bin/python2 ;" >> build/v2/user-config.jam
  echo "using mpi ;" >> build/v2/user-config.jam

  # build bjam
  cd "${srcdir}/${_boostbase}_${_boostver}/tools/build/v2/engine"
  ./build.sh cc

  _bindir="bin.linuxx86"
  [ "${CARCH}" = "x86_64" ] && _bindir="bin.linuxx86_64"

  install -m755 -d "${_stagedir}"/usr/bin
  install -m755 ${_bindir}/bjam "${_stagedir}"/usr/bin/bjam

  # build bcp
#cd "${srcdir}/${_boostbase}_${_boostver}/tools/bcp"
#../build/v2/engine/${_bindir}/bjam --toolset=gcc
#install -m755 "${srcdir}/${_boostbase}_${_boostver}/dist/bin/bcp" \
#${_stagedir}/usr/bin/bcp

  # build libs
  cd "${srcdir}/${_boostbase}_${_boostver}"

  ./tools/build/v2/engine/${_bindir}/bjam \
      release debug-symbols=off \
      runtime-link=shared link=shared,static \
      cflags=-fno-strict-aliasing \
      --prefix="${_stagedir}" \
      --with-nowide \
      ${MAKEFLAGS} \
      install

  # build pyste
#cd "${srcdir}/${_boostbase}_${_boostver}/libs/python/pyste/install"
#python2 setup.py install --root=${_stagedir}
}

package()
{
    install -dm 755 "${pkgdir}"/usr/include/boost
    install -dm 755 "${pkgdir}"/usr/lib
    # headers/source files
    cp -r "${_stagedir}"/include/boost/nowide "${pkgdir}"/usr/include/boost

    # static libs
    cp -r "${_stagedir}"/lib/*nowide*.a "${pkgdir}"/usr/lib/
    cp -r "${_stagedir}"/lib/*nowide*.so{,.*} "${pkgdir}/usr/lib/"
}

pkgname=d2x-xl-data
pkgver=1.16.34
pkgrel=2
pkgdesc="Required D2X-XL data, extras, and Descent 1 and 2 retail data."
arch=(any)
url="http://www.descent2.de"
license=("custom, Public Domain")
depends=(d2x-xl)
makedepends=(dos2unix innoextract unrar graphicsmagick p7zip)
source=("http://downloads.sourceforge.net/d2x-xl/d2x-xl-data-$pkgver.rar"
"http://downloads.sourceforge.net/d2x-xl/D1-music.7z"
"http://downloads.sourceforge.net/d2x-xl/D2-music.7z"
"http://downloads.sourceforge.net/d2x-xl/loading-screens.7z"
"http://downloads.sourceforge.net/d2x-xl/hires-sounds.7z"
"http://downloads.sourceforge.net/d2x-xl/D1-textures-512x512.7z"
"http://downloads.sourceforge.net/d2x-xl/D2-textures-512x512.7z"
"http://downloads.sourceforge.net/d2x-xl/hires-models.7z")
noextract=("d2x-xl-data-$pkgver.rar")
sha1sums=('9e8461cf915cd0dccb39df3054c133c07733427d'
          'ba7206b1c27bab7ad622c9547026d503a94cbde4'
          '459069c83378d702531c6635265c8d6a397043e5'
          'd7a53161967b086ef29fc3cdc85071b534b7af6c'
          '199c6aacf52091362d43cac9fc94bca31d053ae9'
          '8ed4bdd6fc1f81e0a2e4c599f3ad6915cb45e8c0'
          'c03fece50545336bddb25e9611dd29d0eb418e53'
          '42c081e631fa387841a12dcd1e21a33fab94fc9e')

prepare() {
	cd "$srcdir"
	_gog_md5="94e576d4be579a79be7845729f57ad8a"
	_gog_exe="setup_descent12_2.0.0.7.exe"
	if [[ -f ../$_gog_exe ]]; then
		echo "GOG installer detected; checking md5sum ..."
		if ! echo "$_gog_md5 ../$_gog_exe" | md5sum -c --status; then
			error "Invalid md5sum; verify your download and try again."
			return 1
		else
			ln -s ../$_gog_exe .
			innoextract $_gog_exe
		fi
	else
		error "You must have $_gog_exe present (.exe in main dir)."
		error "Download the game from your GOG shelf and try again."
		return 1
	fi
	mkdir d2x-stuff && mv d2x-xl-data-$pkgver.rar d2x-stuff
	cd d2x-stuff
	unrar x d2x-xl-data-$pkgver.rar
	cd ..
	innoextract setup_descent12_2.0.0.7.exe
	find . -type f -exec dos2unix {} \;
	cd "app/Descent 2"
	gm convert descent2.ico descent2.png
}

package() {
	cd "$srcdir/d2x-stuff"
	folders="config data models profiles sounds textures"
	mkdir -p "$pkgdir/opt/d2x-xl/"
	for f in $folders; do
		cp -r $f "$pkgdir/opt/d2x-xl/"
		chmod -R 644 "$pkgdir/opt/d2x-xl/$f"
	done
	ln -s "$pkgdir/opt/d2x-xl/data/descent.tex.eng" "$pkgdir/opt/d2x-xl/data/descent.tex"
	cd ..
	folders2="models mods music sounds textures"
	for f in $folders2; do
		cp -r $f "$pkgdir/opt/d2x-xl/"
		chmod -R 644 "$pkgdir/opt/d2x-xl/$f"
	done

	cd app/Descent
	d1main="DESCENT.HOG DESCENT.PIG"
	for f in $d1main; do
		install -m644 $f "$pkgdir/opt/d2x-xl/data/$f"
	done
	find . -name 'CHAOS.*' -exec install -Dm644 {} "$pkgdir/opt/d2x-xl/missions/"{} \;
	find . -name '*.DEM' -exec install -Dm644 {} "$pkgdir/opt/d2x-xl/demos/"{} \;

	cd "../Descent 2"
	install -Dm644 descent2.png "$pkgdir/usr/share/icons/descent2.png"
	find . -name '*.CFG' -exec install -m644 {} "$pkgdir/opt/d2x-xl/config/" \;
	find . -name '*.INI' -exec install -m644 {} "$pkgdir/opt/d2x-xl/config/" \;
	find . -name '*.PIG' -exec install -m644 {} "$pkgdir/opt/d2x-xl/data/" \;
	find . -name '*.MVL' -exec install -Dm644 {} "$pkgdir/opt/d2x-xl/movies/"{} \;
	d2main="DESCENT2.HAM DESCENT2.HOG DESCENT2.S11 DESCENT2.S22"
	for f in $d2main; do
		install -m644 $f "$pkgdir/opt/d2x-xl/data/$f"
	done
	install -m644 DEMOS/descent2.dem "$pkgdir/opt/d2x-xl/demos/"
	cd MISSIONS
	find . -type f -exec install -m644 {} "$pkgdir/opt/d2x-xl/missions/" \;
	find "$pkgdir" -name '*.txt' -exec rm {} \;
}
# vim:syntax=sh

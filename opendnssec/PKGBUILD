# Maintainer: Javier Torres <javitonino [at] gmail [dot] com>

pkgname=opendnssec
pkgver=1.3.13
pkgrel=1
pkgdesc="Turn-key solution for DNSSEC (sqlite3)"
arch=('i686' 'x86_64')
url="http://www.opendnssec.org/"
license=('BSD')
groups=()
depends=('libxml2>=2.6.16' 'ldns>=1.6.16' 'sqlite3>=3.3.9')
makedepends=()
optdepends=('softhsm: key storage')
provides=()
conflicts=()
replaces=()
backup=("etc/opendnssec/conf.xml"
        "etc/opendnssec/kasp.xml"
        "etc/opendnssec/zonelist.xml"
        "etc/opendnssec/zonefetch.xml")
options=()
install="opendnssec.install"
changelog=
source=("http://www.opendnssec.org/files/source/${pkgname}-${pkgver}.tar.gz"
        "conf.xml.patch"
        "kasp.xml.patch"
	"pid-path.patch"
        "LICENSE"
        "ods-signer.service"
        "ods-enforcer.service")
noextract=()

md5sums=('8c9f34dbfb59649d636a21da8c105550'
         'fcdc7acc2157226042bfe59dd19260a5'
         'e1c6a76cbcff27bd8033344ed51e606e'
         'a7fd18e574abc0ad2dfe8d67b320bc22'
         '367b9415779d31a737712f17df1f865b'
         'ac06c918d6befd717212dc65519871ba'
         '3c4535a746bf00fa12df1c7a447a7651')
sha1sums=('b71bf152efc07c9373f66498d14abb59ffb229d2'
          '2cbf6ace6f59a5f63c9c02753bfbc7ace950f461'
          '7d0d1bd51fe529f7fcc36c5a49be3ffef87f0f3a'
          'eb2293aa15cf6c19a559fc4892fc7f9cab683df3'
          '209ffa61a99d7af99df809ca269d55c376d40b4d'
          'd49cc9d5d2a966932a2abf9998dff1962c95900d'
          '2ef0e4dc4af1461ed06b4fcbd194429de1102a6c')
sha256sums=('4d587882ffc68bca56d96807592366d1a87147d0b8aa518ccfd85b694c889a3f'
            '6cfdd8ba60b35fde3ef9d51274773cbf13b7c459c4e51b6ef26f270a95b2a0cc'
            'ad4cd2a4ef7247edff09e7a7d06ad9dfed5f62c7f82cc2caab0e368c6b240a0d'
            '1726fc0fcb2b09a1c530862c6b2adb0442b520e5182a1a258eadc39172584fa0'
            '423abcf521b605bffd59f6cf6f5ce86729b1f0de7456afc9f7eb05a2f76a53ef'
            '07fcf0d524e1b706f8404de47e99adcba54ced703c47e169f68879fc24d2e2be'
            '44cb269ce3b44fe75d8829a70e08d8040c85789139aea7f929ea2a5661ace030')
sha384sums=('5a47a3cb0029ddcb2bac8c3cf8c201b6badb8271f349f8a3e7cd98d8b244c43ca850d183e9fc0cde39a11bb852955c7b'
            '36a99e3ea0e4dcf9bdfd2f2ec42c48ac0f3cabc9353588b693a0357272bf4af3842ee3e05340242e78a2c9faaad508db'
            'b909406a5e0f72a2bcd4f7b502c4b342c52bdb3c9f5a09a4f167289f16da907b998add4eddefc9faf44ec92b1b82ab97'
            '9d7ee3db4f0c861bcf833750291320745db98349ac0a8289f5f674e508cf4094f319dbfa3edad92cbf03ae984424ae54'
            '93fd2c603a7374b99b47ea7796794512c359f1bf6b86d08bf2766f9fc68e5c7b9f26efb5cca8b23708be68058b608a5e'
            'fea7f7296d5f8cdc983985812a7ae2fbd1751c4c6c3ebff65be4bec69606e302172e668ee4999e4a1065ce865bc09d03'
            '005e13f4b55155c0769f33495e7754f93fc83bbab21c4590238054e28d6ae658bf8de27a65deec144daf64de9619c7b8')
sha512sums=('ef73c14b252a57f282394224e60903e94d94af573835a5f2a19579edfd0edd956f100d2a3963b9641b02367865a2da4cdb83859e69cb374163ef46fee266fd7b'
            '51f831ffaa9548dc75a82d503fd08caea92264a99f660277f723d157a2af4a8fa66c6d3915c373cfb4321dc1132ccd1ad1e5f9dca71fb6ff282bcce9cb443fc1'
            '0fd0fc4551a5373857d276830424cb6dd9ad6f93697087fc2d2dcb34bbd7db164d1ba152fbd7065a7077afda603098be6afcb96c81be4d3dd7113fa61aa95474'
            'b0e788378fd78b34aeb0d88ad023d0dec3e21965104c7ba7c903fdc19c8e85322671e1d2eac876a39861d49a50660cb0ccc7d298ecb0f8ff55e6263aedede407'
            '9018a66489c501e9c8b99309d5c5bfca333d53a76ceff611ac9243792e07dcd6573b6632d94e0f58a64d6d4f5b9e53162043dc02427e38f087fe617f549f356a'
            '7f1bd01f2612d8b3e37227c98ecbfd0f69a41efeb197dafef3cdd4e70f390d57c9abde1150600993346e8bba3a4eee3a11a0b40b6043af45a8ff9a4292b746fe'
            'e001d387354cbe774d21987fb2193ba985c6b8bbba162926fa1bc01e5245579a294671de779c9f9332093855ec1ea0f77678c23b760291702e97d3043273f3c1')

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  # /var/lib/run -> /var/run
  patch -p0 < "${srcdir}/pid-path.patch"

  aclocal
  autoconf
  automake --add-missing

  ./configure --prefix=/usr --datarootdir=/usr/share --localstatedir=/var/lib --sysconfdir=/etc --with-pkcs11-softhsm=/usr/lib/libsofthsm.so --disable-auditor 

  # Create the correct (/var/run/opendnssec) directory
  sed -i \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run\/opendnssec/#Removed/" \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run/\$(INSTALL) -d \$(DESTDIR)\$(OPENDNSSEC_PID_DIR)/" \
  Makefile

  # Patch configuration (take out auditor)
  patch -p0 < "${srcdir}/conf.xml.patch"
  patch -p0 < "${srcdir}/kasp.xml.patch"

  make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  install -d "${pkgdir}/var/run/opendnssec"

  make DESTDIR="${pkgdir}" install

  install -d "${pkgdir}/etc/rc.d"
  install -Dm0644 "${srcdir}/ods-signer.service" \
        "${pkgdir}/usr/lib/systemd/system/ods-signer.service"
  install -Dm0644 "${srcdir}/ods-enforcer.service" \
        "${pkgdir}/usr/lib/systemd/system/ods-enforcer.service"
  install -Dm0644 "${srcdir}/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  chown 227:227 "${pkgdir}/etc/opendnssec" -R
  chown 227:227 "${pkgdir}/var/lib/opendnssec" -R
  chown 227:227 "${pkgdir}/var/run/opendnssec" -R
}

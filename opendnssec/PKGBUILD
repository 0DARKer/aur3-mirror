# Maintainer: Javier Torres <javitonino [at] gmail [dot] com>

pkgname=opendnssec
pkgver=1.4.0
pkgrel=1
pkgdesc="Turn-key solution for DNSSEC (sqlite3)"
arch=('i686' 'x86_64')
url="http://www.opendnssec.org/"
license=('BSD')
groups=()
depends=('libxml2>=2.6.16' 'ldns>=1.6.16' 'sqlite3>=3.3.9')
makedepends=()
optdepends=('softhsm: key storage')
provides=()
conflicts=()
replaces=()
backup=("etc/opendnssec/conf.xml"
        "etc/opendnssec/kasp.xml"
        "etc/opendnssec/zonelist.xml")
options=()
install="opendnssec.install"
changelog=
source=("http://www.opendnssec.org/files/source/${pkgname}-${pkgver}.tar.gz"
	"pid-path.patch"
        "LICENSE"
        "ods-signer.service"
        "ods-enforcer.service")
noextract=()

md5sums=('96399851f16cf68de53c974c0d07aa5b'
         '5dbef62063ddb08678d1509c660019f0'
         '367b9415779d31a737712f17df1f865b'
         'ac06c918d6befd717212dc65519871ba'
         '3c4535a746bf00fa12df1c7a447a7651')
sha1sums=('111a6de4bb8f13bcedc31880c87588ce07eecc31'
          '8b4d120c5965f1869d2689257245e6905372d1f9'
          '209ffa61a99d7af99df809ca269d55c376d40b4d'
          'd49cc9d5d2a966932a2abf9998dff1962c95900d'
          '2ef0e4dc4af1461ed06b4fcbd194429de1102a6c')
sha256sums=('36d4926dcdf351a527ad7600b151ab6cc56d0a472a7eb8871eecd70afef9e101'
            '487a4c05a07feb97c865ddc4c13d00eea6ce8b2b1e5031983c15484f4991ebed'
            '423abcf521b605bffd59f6cf6f5ce86729b1f0de7456afc9f7eb05a2f76a53ef'
            '07fcf0d524e1b706f8404de47e99adcba54ced703c47e169f68879fc24d2e2be'
            '44cb269ce3b44fe75d8829a70e08d8040c85789139aea7f929ea2a5661ace030')
sha384sums=('d00989c502df3e5a86eb56e3c4b82195144bf4c594ea0e3e34254943c5e7dfb0ec221b5d32f8dce9e91a28d771a984ec'
            'b990c56136f7d3759093e666ea9b3d33aa1861242cd301ab84cd20f6fc6fdb81d56f4cda84d02da3894f3d82cfcfe532'
            '93fd2c603a7374b99b47ea7796794512c359f1bf6b86d08bf2766f9fc68e5c7b9f26efb5cca8b23708be68058b608a5e'
            'fea7f7296d5f8cdc983985812a7ae2fbd1751c4c6c3ebff65be4bec69606e302172e668ee4999e4a1065ce865bc09d03'
            '005e13f4b55155c0769f33495e7754f93fc83bbab21c4590238054e28d6ae658bf8de27a65deec144daf64de9619c7b8')
sha512sums=('694c22e9b87f74db1eae9cdbb1b0a6d4f3a10650c2fdbf77784cffde390988ab639950eae9af8a1bea55c17425c6541c03b94a7ad3142e9003d2cb54d10a1946'
            '74f386ec8db1ff3a1dd4faf8e1d7eaa6e04f1ab0f89d5289f440ed1c2fe7040d8688ce27796d04d8152c235369297ce829f5dec0aa205c3e62263ae759e15d4a'
            '9018a66489c501e9c8b99309d5c5bfca333d53a76ceff611ac9243792e07dcd6573b6632d94e0f58a64d6d4f5b9e53162043dc02427e38f087fe617f549f356a'
            '7f1bd01f2612d8b3e37227c98ecbfd0f69a41efeb197dafef3cdd4e70f390d57c9abde1150600993346e8bba3a4eee3a11a0b40b6043af45a8ff9a4292b746fe'
            'e001d387354cbe774d21987fb2193ba985c6b8bbba162926fa1bc01e5245579a294671de779c9f9332093855ec1ea0f77678c23b760291702e97d3043273f3c1')

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  # /var/lib/run -> /var/run
  patch -p0 < "${srcdir}/pid-path.patch"

  aclocal
  autoconf
  automake --add-missing

  ./configure --prefix=/usr --datarootdir=/usr/share --localstatedir=/var/lib --sysconfdir=/etc --with-pkcs11-softhsm=/usr/lib/libsofthsm.so

  # Create the correct (/var/run/opendnssec) directory
  sed -i \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run\/opendnssec/#Removed/" \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run/\$(INSTALL) -d \$(DESTDIR)\$(OPENDNSSEC_PID_DIR)/" \
  Makefile

  make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  install -d "${pkgdir}/var/run/opendnssec"

  make DESTDIR="${pkgdir}" install

  install -d "${pkgdir}/etc/rc.d"
  install -Dm0644 "${srcdir}/ods-signer.service" \
        "${pkgdir}/usr/lib/systemd/system/ods-signer.service"
  install -Dm0644 "${srcdir}/ods-enforcer.service" \
        "${pkgdir}/usr/lib/systemd/system/ods-enforcer.service"
  install -Dm0644 "${srcdir}/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
  install -Dm0644 "enforcer/utils/migrate_adapters_1.sqlite3" \
        "${pkgdir}/usr/share/opendnssec"

  chown 227:227 "${pkgdir}/etc/opendnssec" -R
  chown 227:227 "${pkgdir}/var/lib/opendnssec" -R
  chown 227:227 "${pkgdir}/var/run/opendnssec" -R
}

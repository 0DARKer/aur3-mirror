# Maintainer: Javier Torres <javitonino [at] gmail [dot] com>

pkgname=opendnssec
pkgver=1.3.11
pkgrel=1
pkgdesc="Turn-key solution for DNSSEC (sqlite3)"
arch=('i686' 'x86_64')
url="http://www.opendnssec.org/"
license=('BSD')
groups=()
depends=('libxml2>=2.6.16' 'ldns>=1.6.16' 'sqlite3>=3.3.9')
makedepends=()
optdepends=('softhsm: key storage')
provides=()
conflicts=()
replaces=()
backup=("etc/opendnssec/conf.xml"
        "etc/opendnssec/kasp.xml"
        "etc/opendnssec/zonelist.xml"
        "etc/opendnssec/zonefetch.xml")
options=()
install="opendnssec.install"
changelog=
source=("http://www.opendnssec.org/files/source/${pkgname}-${pkgver}.tar.gz"
        "conf.xml.patch"
        "kasp.xml.patch"
	"libcompat.patch"
	"pid-path.patch"
        "LICENSE"
        "opendnssec.rcd")
noextract=()

md5sums=('074da6590b227710a4bde64594a7a41e'                                                                                                                 
         'fcdc7acc2157226042bfe59dd19260a5'                                                                                                                 
         'e1c6a76cbcff27bd8033344ed51e606e'                                                                                                                 
         'fe51765a46c3cf7a8e80a61e077184ef'                                                                                                                 
         'a7fd18e574abc0ad2dfe8d67b320bc22'                                                                                                                 
         '367b9415779d31a737712f17df1f865b'                                                                                                                 
         'a124a550163be248a8baf0857c5101f9')                                                                                                                
sha1sums=('ac60a6445807730dd3d4a01a1086db3a92f1b677'
          '2cbf6ace6f59a5f63c9c02753bfbc7ace950f461'
          '7d0d1bd51fe529f7fcc36c5a49be3ffef87f0f3a'
          '6cf0bec4d6c56c895c4dedeea4abadef7a6ab09e'
          'eb2293aa15cf6c19a559fc4892fc7f9cab683df3'
          '209ffa61a99d7af99df809ca269d55c376d40b4d'
          'd40769e1d15fbd16a0f412777bdc90fc72ee32bc')
sha256sums=('a595ccb79a807db713d0364b4ad6f158655353dbf3a3bacfe284daa53d506232'
            '6cfdd8ba60b35fde3ef9d51274773cbf13b7c459c4e51b6ef26f270a95b2a0cc'
            'ad4cd2a4ef7247edff09e7a7d06ad9dfed5f62c7f82cc2caab0e368c6b240a0d'
            'fa75b52e7de56acf5704cbe62c57b7a4bc3b0546b2b2ce20383984e96ee7c071'
            '1726fc0fcb2b09a1c530862c6b2adb0442b520e5182a1a258eadc39172584fa0'
            '423abcf521b605bffd59f6cf6f5ce86729b1f0de7456afc9f7eb05a2f76a53ef'
            'e6a17b197c3f892f0fdc26eb049619df0d40e062f59e747e99e3ee229176fe84')
sha384sums=('b9cf004bbaacdc0e504da805a09dbb0b584c8eec643945a4db8f4d9cd826182afadf066cb9b4058fe09ab5ef70442623'
            '36a99e3ea0e4dcf9bdfd2f2ec42c48ac0f3cabc9353588b693a0357272bf4af3842ee3e05340242e78a2c9faaad508db'
            'b909406a5e0f72a2bcd4f7b502c4b342c52bdb3c9f5a09a4f167289f16da907b998add4eddefc9faf44ec92b1b82ab97'
            'd333d10777ebb03ad2a0ed074a561d43f809f034ca6a8ae6da59ca3c9606940e700d7d4ebad9d5e826b3fa0210905294'
            '9d7ee3db4f0c861bcf833750291320745db98349ac0a8289f5f674e508cf4094f319dbfa3edad92cbf03ae984424ae54'
            '93fd2c603a7374b99b47ea7796794512c359f1bf6b86d08bf2766f9fc68e5c7b9f26efb5cca8b23708be68058b608a5e'
            '8d6f66d1643e3460dbf29ec94b5f67dc9ba3fca2683b15bb558d43bc142abd6728a40bde3f9cdc9dbf51ebcff30feabd')
sha512sums=('0b15579d2155edbd33d384a0140ddde11b08acee845c34f3fa65e6b8e3da540e1091b1f350b267fbc25fce4fab11eb3881e709bb4e04a63f06ac6b6dbbc068ba'
            '51f831ffaa9548dc75a82d503fd08caea92264a99f660277f723d157a2af4a8fa66c6d3915c373cfb4321dc1132ccd1ad1e5f9dca71fb6ff282bcce9cb443fc1'
            '0fd0fc4551a5373857d276830424cb6dd9ad6f93697087fc2d2dcb34bbd7db164d1ba152fbd7065a7077afda603098be6afcb96c81be4d3dd7113fa61aa95474'
            '1915153a943547bcdb707c6475a73c06514f1fff3ae44c01279bf0a0d5567d16675db4108e10f7a8585f01cccfaf9b6b8482a45309f5a4998ef8e51b6ce6e071'
            'b0e788378fd78b34aeb0d88ad023d0dec3e21965104c7ba7c903fdc19c8e85322671e1d2eac876a39861d49a50660cb0ccc7d298ecb0f8ff55e6263aedede407'
            '9018a66489c501e9c8b99309d5c5bfca333d53a76ceff611ac9243792e07dcd6573b6632d94e0f58a64d6d4f5b9e53162043dc02427e38f087fe617f549f356a'
            '9093549c3d90421a7b56b26ace0c321029a85a27bff1f04384b1a0dae0e6fec966e85afcc7c0d8e226916ce29a2a8be6c39e57944aaed5c71d52b4b41614cfbb')

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  # /var/lib/run -> /var/run
  patch -p0 < "${srcdir}/pid-path.patch"

  # Link libcompat.a to libhsm (fixes undefined reference to strlcpy)
  patch -p0 < "${srcdir}/libcompat.patch"
  autoreconf

  ./configure --prefix=/usr --datarootdir=/usr/share --localstatedir=/var/lib --sysconfdir=/etc --with-pkcs11-softhsm=/usr/lib/libsofthsm.so --disable-auditor 

  # Create the correct (/var/run/opendnssec) directory
  sed -i \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run\/opendnssec/#Removed/" \
  -e "s/\$(INSTALL) -d \$(DESTDIR)\$(localstatedir)\/run/\$(INSTALL) -d \$(DESTDIR)\$(OPENDNSSEC_PID_DIR)/" \
  Makefile

  # Patch configuration (take out auditor)
  patch -p0 < "${srcdir}/conf.xml.patch"
  patch -p0 < "${srcdir}/kasp.xml.patch"

  make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  install -d "${pkgdir}/var/run/opendnssec"

  make DESTDIR="${pkgdir}" install

  install -d "${pkgdir}/etc/rc.d"
  install -o root -g root -m 755 "${srcdir}/opendnssec.rcd" \
        "${pkgdir}/etc/rc.d/opendnssec"
  install -D -m644 "${srcdir}/LICENSE" \
        "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  chown 227:227 "${pkgdir}/etc/opendnssec" -R
  chown 227:227 "${pkgdir}/var/lib/opendnssec" -R
  chown 227:227 "${pkgdir}/var/run/opendnssec" -R
}

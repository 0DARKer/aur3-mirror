# Contributor: J.W. Birdsong <jwbirdsongATgmailDOTcom>
# Maintainer: Martin Erik Werner ("arand") <martinerikwerner@mail.com>
# Based on the AUR package for version 1.0 by Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
pkgname=redeclipse-svn
# svn automagic seems to override the $pkgver anyways..
pkgver=3334
pkgrel=1
pkgdesc="A single-player and multi-player first-person ego-shooter, built as a total conversion of Cube Engine 2, "
arch=('i686' 'x86_64')
url="http://redeclipse.net"
license=('custom' 'ZLIB' 'MIT' 'CC-BY-SA')
depends=('sdl_image' 'libgl' 'sdl_mixer')
makedepends=('subversion' 'mesa' 'imagemagick' 'sdl_image' 'libgl' 'sdl_mixer')
source=(adapt-manpages.patch)
md5sums=('358e5329c5e276779a9ff62ed00793d6')

_svntrunk=https://redeclipse.svn.sourceforge.net/svnroot/redeclipse
_svnmod=redeclipse

build() {
	cd "$srcdir"

	# update/checkout svn
	if [ -d "$_svnmod"/.svn ]; then
		msg "Updating existing SVN checkout"
		(cd "$_svnmod" && svn up -r "$pkgver")
	else
		msg "New checkout from SVN"
		svn co "$_svntrunk" --config-dir ./ -r "$pkgver" "$_svnmod"
	fi

	msg "SVN export to clean build directory"

	# export to get rid of .svn metadata
	rm -rf "$srcdir/$pkgname"
	svn export "$srcdir/$_svnmod" "$srcdir/$pkgname"

	msg "Starting make"

	# build in exported directory
	cd "$srcdir/$pkgname/src"
	make
}

package() {
	msg "Starting install phase"
	cd "$srcdir/$pkgname"

	# create directories
	install -d "$pkgdir"/usr/{share/"$pkgname",}/bin
	# this isn't really necessary since we use a custom script anyways
	sed -i "s|RE_DATA=.|RE_DATA=/usr/share/$pkgname|" "redeclipse.sh"

	msg "Installing binaries"
	install -m755 src/re{server,client} "$pkgdir/usr/share/$pkgname/bin/"
	msg "Installing data directory"
	cp -rf  data/ "$pkgdir/usr/share/$pkgname"

	msg "Creating wrapper scripts"
	# wrapper scripts for client and server, these are -svn specific in
	# order to not conflict with standard redeclipse
	cat <<'EOF' > "$pkgdir/usr/bin/$pkgname"
#!/bin/sh
RE_OPTIONS="-h$HOME/.redeclipse-svn"
cd "/usr/share/redeclipse-svn"
exec bin/reclient ${RE_OPTIONS} ${1+"$@"}
EOF

	cat <<'EOF' > "$pkgdir/usr/bin/$pkgname-server"
#!/bin/sh
RE_OPTIONS="-h$HOME/.redeclipse-svn"
cd "/usr/share/redeclipse-svn"
exec bin/reserver ${RE_OPTIONS} ${1+"$@"}
EOF

	chmod 755 "$pkgdir/usr/bin/$pkgname"
	chmod 755 "$pkgdir/usr/bin/$pkgname-server"

	msg "Installing desktop file and icons"
	install -Dm644 src/install/nix/redeclipse.desktop  "$pkgdir/usr/share/applications/$pkgname.desktop"
	# change desktop file to use our scripts, and to refer to SVN instead
	sed -e 's/redeclipse/redeclipse-svn/' \
	-e 's/bin\/reclient\ -r/redeclipse-svn/' \
	-e 's/Eclipse\(.*\)/Eclipse\1\ SVN/' \
	-i "$pkgdir/usr/share/applications/$pkgname.desktop"
	# Extract the image we want from the layered .ico file and convert to
	# png using imagemagick (<3)
	convert -resize 48x48 'src/redeclipse.ico' src/redeclipse.png
	install -D src/redeclipse-2.png "$pkgdir/usr/share/icons/hicolor/48x48/apps/$pkgname.png"
	install -D src/redeclipse-3.png "$pkgdir/usr/share/icons/hicolor/128x128/apps/$pkgname.png"

	msg "Patching and installing manual pages"
	patch -p1 < $srcdir/adapt-manpages.patch
	install -D src/install/nix/redeclipse.6 $pkgdir/usr/share/man/man6/redeclipse-svn.6
	install -D src/install/nix/redeclipse-server.6 $pkgdir/usr/share/man/man6/redeclipse-svn-server.6

	msg "Installing license and trademark info"
	install -Dm644 license.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	install -Dm644 trademark.txt "$pkgdir/usr/share/licenses/$pkgname/TRADEMARK"
}

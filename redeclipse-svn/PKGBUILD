# Contributor: J.W. Birdsong <jwbirdsongATgmailDOTcom>
pkgname=redeclipse-svn
pkgver=1217
pkgrel=1
pkgdesc="A single-player and multi-player first-person ego-shooter, built as a total conversion of Cube Engine 2, "
arch=('i686' 'x86_64')
url="http://redeclipse.net"
license=('custom' 'ZLIB')
depends=('sdl_image'  'libgl' 'sdl_mixer')
makedepends=('subversion' 'mesa')
provides=(redeclipse)
conflicts=(redeclipse)
source=(redeclipse.desktop 'redeclipse.patch')
md5sums=('d905ff937b097fd946e9e5b3113aee3c'
         '26d3e37ba0e2b7e34d04a897337a9554')

_svntrunk=https://redeclipse.svn.sourceforge.net/svnroot/redeclipse
_svnmod=redeclipse

build() {
  cd "$srcdir"

  if [ -d $_svnmod/.svn ]; then
    (cd $_svnmod && svn up -r $pkgver)
  else
    svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
  fi

  msg "SVN checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_svnmod-build"
  cp -r "$srcdir/$_svnmod" "$srcdir/$_svnmod-build"
  cd "$srcdir/$_svnmod-build"

  #
  # BUILD
  #
 cd "$srcdir"/${_svnmod}-build/src
  make
  make DESTDIR="$srcdir/" clean install 

cd ..
install -d "$pkgdir"/usr/{share/$_svnmod/,}bin/
  sed -i "s|RE_DATA=.|RE_DATA=/usr/share/$_svnmod|" $_svnmod.sh
  patch -p1 < ../redeclipse.patch
  install -m755 $_svnmod.sh "$pkgdir/usr/bin/$_svnmod"
  install -m755 bin/re{server,client} "$pkgdir/usr/share/$_svnmod/bin/"
  cp -rf  data/ "$pkgdir/usr/share/$_svnmod"

  #  license and icons
  install -Dm644 "$srcdir/$_svnmod.desktop"  $pkgdir/usr/share/applications/$pkgname.desktop
  install -Dm644 src/redeclipse.ico  "$pkgdir/usr/share/pixmaps/$_svnmod.png"
  install -Dm644 "$srcdir/$_svnmod-build/license.txt" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

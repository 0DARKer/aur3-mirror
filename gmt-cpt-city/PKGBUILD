# Contributor: abenson <adrian.m.benson@gmail.com>

pkgname=gmt-cpt-city
__cptcity=${pkgname/gmt-/}
pkgver=1.65
pkgrel=1
pkgdesc="GMT color palettes (*.cpt) from the cpt-city collection"
arch=('any')
url="http://soliton.vm.bytemark.co.uk/pub/cpt-city"
license=('custom','GPL','APACHE','CCPL')
makedepends=('html2text')
optdepends=('gmt: the Generic Mapping Tools')
source=(http://soliton.vm.bytemark.co.uk/pub/cpt-city/pkg/cpt-city_${pkgver}-${pkgrel}.tar.gz)
md5sums=('7cd52c585d7596b992dd00ea7a1e7aef')
install=($pkgname.install)
build() {
    
    cd "$srcdir"/cpt-city-${pkgver}
    ./configure --prefix="$pkgdir"/usr --mandir="$pkgdir"/usr/share/man
    make install || return 1
    mkdir -p "$pkgdir"/usr/share/licenses/$pkgname
    mv "$pkgdir"/usr/share/doc/cpt-city/copying/* "$pkgdir"/usr/share/licenses/$pkgname
    rm -r "$pkgdir"/usr/share/doc
    
    local _f _license_name _l _sublic_name
    
    ## The following cpt collections are junk for most GMT related purposes
    ## uncomment below to remove from them from the package 
    #rm -rf "$pkgdir"/usr/share/cpt-city/{cw,colo,ds,es,go2,hult,ing,gmt,lb,ma,neota,nd,occ,pd,pj,rc,sd,fg}
    #rm -r "$pkgdir"/usr/share/licenses/$pkgname/{cw,colo,ds,es,go2,hult,ing,gmt,lb,ma,neota,nd,occ,pd,pj,rc,sd,fg}

    
    #make proper license files - the current ones are xml garbage
    for _f in "$pkgdir"/usr/share/licenses/$pkgname/* ; do
        _license_name=${_f##*/}
        if [ -f  $_f/COPYING.xml ]; then 
            html2text -ascii $_f/COPYING.xml |
                sed -e 's|<?xml version="1.0" encoding="UTF-8"?>||' |
                sed -e's/\s\{3,\}/\n/g'  > "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
        else
            rm -f "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
            for _l in `find  $_f -name COPYING.xml` ; do
                _sublic_name=${_l%/*}
                _sublic_name=${_sublic_name##*/}
                echo "==========================" >> "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
                echo "SUBDIR: $_sublic_name"      >> "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
                echo "==========================" >> "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
                html2text -ascii $_l |sed -e 's|<?xml version="1.0" encoding="UTF-8"?>||' |
                sed -e's/\s\{3,\}/\n/g'  >> "$pkgdir"/usr/share/licenses/$pkgname/$_license_name.txt
            done
        fi
        rm -r $_f   
    done
    
    unset _f _l _license_name _sublic_name

    #create symlink in gmt dir
    mkdir -p "$pkgdir"/usr/share/gmt/cpt
    ln -s ../../cpt-city "$pkgdir"/usr/share/gmt/cpt/GMT_cpt-city
    
}

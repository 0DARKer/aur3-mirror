# Maintainer: wido <widowild [ta] myopera [tod] com>

pkgname=frozensynapse
pkgver=1
pkgrel=2
pkgdesc="A single player and multiplayer simultaneous-turn-based tactical game. (The Humble Frozen Synapse Bundle)"
url="http://www.frozensynapse.com/"
license=('custom: "commercial"')
arch=('i686' 'x86_64')
makedepends=('unzip')
source=(${pkgname}.sh ${pkgname}.desktop)
md5sums=('c8c0ca0850f2bc790019c738b4d23712'
         'bcd554f457d4ddd95b7c33922ddd70fc')

depends=('glibc' 'gcc-libs' 'openal' 'sdl')
_depends64=('lib32-glibc' 'lib32-gcc-libs' 'lib32-openal' 'lib32-sdl')

if [[ $CARCH == x86_64 ]]; then
  depends=(${_depends64[@]})
fi

_gamepkg="${pkgname}-${pkgver}-linux-bin"

build() {
  cd ${srcdir}

  msg "You need a full copy of this game in order to install it"
  msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
  if [[ -f "../${_gamepkg}" ]]; then
    msg "Found game package, installing..."
    ln -fs "../${_gamepkg}" .
    unzip -x guis/* meta/* scripts/* -d ${_gamepkg}  || true
else
    error "Game package not found, please type absolute path to ${_gamepkg}:"
    read pkgpath
    if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
      msg "Found game package, installing..."
      ln -fs "${pkgpath}/${_gamepkg}" .
      unzip -o ${_gamepkg} || true
    else
      error "Unable to find game package."
      return 1
    fi
  fi
}

package(){

  # directories
  install -d ${pkgdir}/opt/${pkgname}
  cd ${srcdir}
  cp -r data ${pkgdir}/opt/${pkgname}/

  # Clean librairy
  rm ${pkgdir}/opt/${pkgname}/data/libgcc_s.so.1
  rm ${pkgdir}/opt/${pkgname}/data/libopenal.so
  rm ${pkgdir}/opt/${pkgname}/data/libSDL-1.2.so.0
  rm ${pkgdir}/opt/${pkgname}/data/libstdc++.so.6

  #fix permissions
  find ${pkgdir}/opt/${pkgname} -type d -exec chmod 755 {} \;
  find ${pkgdir}/opt/${pkgname}/data -type f -exec chmod 644 {} \;
  chmod 755 ${pkgdir}/opt/${pkgname}/data/FrozenSynapse


  # startup scripts
  install -Dm755 ${srcdir}/${pkgname}.sh ${pkgdir}/usr/bin/${pkgname}

  # desktop entry
  install -Dm644 ${srcdir}/${pkgname}.desktop ${pkgdir}/usr/share/applications/${pkgname}.desktop
}

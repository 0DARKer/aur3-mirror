#- Contributer: fnord0 <fnord0 AT riseup DOT net>

pkgname=peach
_pkgname=Peach
pkgver=2.3.7
pkgrel=1
pkgdesc="A cross-platform fuzzing framework written in Python"
arch=('i686' 'x86_64')
url="http://peachfuzzer.com/"
license=('MIT')
depends=('python25' 'python25-pyrex' 'gtk2' 'unzip' 'tar')
provides=('python25-cdeepcopy' 'python25-cpeach' 'peach-pypcap' 'python25-pydbgeng' 'python25-vdebug' 'python25-4suite-xml' 'python25-twisted' 'python25-zope-interface' 'python25-pyasn1' 'python25-multiprocessing')
#TODO: fix conflicts with 4suite
conflicts=('4suite')
optdepends=('pygtk: VDB gui support'
	    'pango: VDB gui support')
source="http://downloads.sourceforge.net/project/peachfuzz/${_pkgname}/${pkgver}/${_pkgname}-${pkgver}-src.zip"
options=(!emptydirs)
md5sums=('0bd5a2cdb13cd1759845f10dfb388947')
sha1sums=('0427109d16046905cf662dc4755f62bb853f710c')
install=('peach.install')

build() {

                install -d ${pkgdir}/usr/bin || return 1
                install -d ${pkgdir}/usr/share/${pkgname} || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/docs || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/samples || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/test || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/tools || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/Peach || return 1
                install -d ${pkgdir}/usr/share/licenses/${pkgname} || return 1
																
		# python25-cdeepcopy install
 		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/cDeepCopy
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# python25-cpeach install
 		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/cPeach
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# peach-pypcap install
 		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/peach-pypcap
		sed -i 's|pyrexc|pyrexc2.5|' Makefile
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# peach-pycap post install
		install -d ${pkgdir}/usr/share/peach-pypcap || return 1
               	install -d ${pkgdir}/usr/share/peach-pypcap/doc || return 1
		install -d ${pkgdir}/usr/share/licenses/peach-pypcap || return 1
		install -D -m644 LICENSE ${pkgdir}/usr/share/licenses/peach-pypcap/LICENSE || 1
		## TODO
		##install -D -m755 testsniff.py ${pkgdir}/usr/share/peach-pypcap/testsniff.py || return 1
		##ln -sf /usr/share/peach-pypcap/testsniff.py ${pkgdir}/usr/bin/testsniff.py || return 1
		for pcapdoc in CHANGES README README-Peach.txt; do
  	              install -Dm644 ${pcapdoc} ${pkgdir}/usr/share/peach-pypcap/doc/${pcapdoc} || return 1
                done

		# python25-pydbgeng install
 		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		unzip PyDbgEng-0.14.zip || return 1
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/PyDbgEng-0.14
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# python25-pydbgeng post install
                install -d ${pkgdir}/usr/share/pydbgeng || return 1
                install -d ${pkgdir}/usr/share/pydbgeng/doc || return 1
                install -d ${pkgdir}/usr/share/pydbgeng/Examples || return 1
		install -d ${pkgdir}/usr/share/licenses/pydbgeng || return 1
		install -D -m644 LICENSE.txt ${pkgdir}/usr/share/licenses/pydbgeng/LICENSE.txt || return 1
                for dbgdoc in CHANGELOG.txt README.txt; do
			install -Dm644 ${dbgdoc} ${pkgdir}/usr/share/pydbgeng/doc/${dbgdoc} || return 1
	        done
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/PyDbgEng-0.14/Examples
                for dbgex in *; do
                        install -Dm644 ${dbgex} ${pkgdir}/usr/share/pydbgeng/Examples/${dbgex} || return 1
                done

                # 4suite-xml install
                cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/4Suite-XML-1.0.2
                python2.5 setup.py config || return 1
                install -d ${pkgdir}/usr/share/4suite-xml || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/docs || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/locale || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/etc || return 1
                sed -i "s|/local/|/|" config.cache || return 1
                sed -i "s|/usr/local/doc/|/usr/share/4suite-xml/docs/|" config.cache || return 1
                sed -i "s|\$name|4share-xml|" config.cache || return 1
                sed -i "s|/usr/share/locale|/usr/share/4share-xml/locale|" config.cache || return 1
                sed -i "s|/usr/etc/4share-xml|/usr/share/4share-xml/etc|" config.cache || return 1
                python2.5 setup.py install --root=${pkgdir}/ --optimize=1 --with-docs || return 1
                # 4suite-xml post install
                install -d ${pkgdir}/usr/share/licenses/4suite-xml || return 1
                install -D -m644 COPYRIGHT ${pkgdir}/usr/share/licenses/4suite-xml || return 1
                cp -pR README docs test ${pkgdir}/usr/share/4suite-xml/ || return 1

		# python25-vdebug install
 		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		unzip vdebug-022710.zip	|| return 1
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/vdebug-022710
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# vdebug post install
		####install -d ${pkgdir}/usr/share/vdebug || return 1
		####install -D -m644 README ${pkgdir}/usr/share/vdebug/README || return 1

		# python25-zope-interface install
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		tar xzf zope.interface-3.3.0.tar.gz || return 1
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/zope.interface-3.3.0
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		rm $pkgdir/usr/lib/python2.5/site-packages/zope/interface/README*.txt

		# python25-twisted install
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		tar jxf Twisted-8.2.0.tar.bz2 || return 1
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/Twisted-8.2.0
		# python25-twisted quick fix
		grep -rl "/usr/bin/twistd" * | xargs sed -i 's|/usr/bin/twistd|/usr/local/bin/twistd|g' || return 1
		# continuing with python25-twisted build
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		sed -e 's|#!/usr/bin/env python|#!/usr/bin/env python2.5|' \
		    -i ${pkgdir}/usr/lib/python2.5/site-packages/twisted/trial/test/scripttest.py
		sed -e 's|#!/usr/bin/env python|#!/usr/bin/env python2.5|' \
		    -i ${pkgdir}/usr/lib/python2.5/site-packages/twisted/mail/test/pop3testserver.py
		# *twisted conflict fixes
                install -d ${pkgdir}/usr/local/bin || return 1
		cd ${pkgdir}/usr/bin
		mv cftp ${pkgdir}/usr/local/bin/ || return 1
		mv ckeygen ${pkgdir}/usr/local/bin/ || return 1
		mv conch ${pkgdir}/usr/local/bin/ || return 1
		mv lore ${pkgdir}/usr/local/bin/ || return 1
		mv mailmail ${pkgdir}/usr/local/bin/ || return 1
		mv manhole ${pkgdir}/usr/local/bin/ || return 1
		mv mktap ${pkgdir}/usr/local/bin/ || return 1
		mv pyhtmlizer ${pkgdir}/usr/local/bin/ || return 1
		mv tap2deb ${pkgdir}/usr/local/bin/ || return 1
		mv tap2rpm ${pkgdir}/usr/local/bin/ || return 1
		mv tapconvert ${pkgdir}/usr/local/bin/ || return 1
		mv tkconch ${pkgdir}/usr/local/bin/ || return 1
		mv trial ${pkgdir}/usr/local/bin/ || return 1
		mv twistd ${pkgdir}/usr/local/bin/ || return 1
		#twisted TODO
                ####install -d ${pkgdir}/usr/share/python25-twisted || return 1
		####mv cftp ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv ckeygen ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv conch ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv lore ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv mailmail ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv manhole ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv mktap ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv pyhtmlizer ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv tap2deb ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv tap2rpm ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv tapconvert ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv tkconch ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv trial ${pkgdir}/usr/share/python25-twisted/ || return 1
		####mv twistd ${pkgdir}/usr/share/python25-twisted/ || return 1

                # python25-multiprocessing install
                cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
                tar xzf multiprocessing-2.6.2.1.tar.gz || return 1
                cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/multiprocessing-2.6.2.1
                python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# python25-pyasn1 install
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		tar xzf pyasn1-0.0.9a.tar.gz || return 1
		cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/pyasn1-0.0.9a
		python2.5 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# python25-wxpython install
		#cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src
		#tar jxf wxPython-src-2.8.8.0.tar.bz2 || return 1
		#cd ${srcdir}/${_pkgname}-${pkgver}-src/dependencies/src/wxPython-src-2.8.8.0
  		#./configure --prefix=/usr --libdir=/usr/lib --with-gtk=2 --with-opengl --enable-unicode \
 		#  --enable-graphics_ctx --with-gnomeprint --disable-optimize --enable-mediactrl \
    		#  --with-libpng=builtin --with-libxpm=sys --with-libjpeg=sys --with-libtiff=sys
  		#cd wxPython
  		#python2.5 setup.py WXPORT=gtk2 UNICODE=1 build || return 1
  		#python2.5 setup.py WXPORT=gtk2 UNICODE=1 install --root=${pkgdir}/ || return 1

		# peach install
		cd ${srcdir}/${_pkgname}-${pkgver}-src
                for pfuzzcp in defaults.xml peach.py peach.xsd peachvalidator.pyw repro.xml template.xml docs samples test tools Peach; do
			cp -pR ${pfuzzcp} ${pkgdir}/usr/share/${pkgname}/ || return 1
                done
                for pfuzzdocscp in changelist.txt readme.html; do
			cp -pR ${pfuzzdocscp} ${pkgdir}/usr/share/${pkgname}/docs/ || return 1
                done

  #create startup app
  echo "#!/bin/sh" > ${pkgdir}/usr/bin/${pkgname}
  echo "cd /usr/share/peach" >> ${pkgdir}/usr/bin/${pkgname}
  echo "python2.5 peach.py \"\$@\"" >> ${pkgdir}/usr/bin/${pkgname}
  echo "cd -" >> ${pkgdir}/usr/bin/${pkgname}
  chmod +x ${pkgdir}/usr/bin/${pkgname}
}

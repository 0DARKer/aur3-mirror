# Contributer: fnord0 <fnord0 AT riseup DOT net>

pkgname=peach
_pkgname=Peach
pkgver=2.3.6
pkgrel=2
pkgdesc="A cross-platform fuzzing framework written in Python"
arch=('i686' 'x86_64')
url="http://peachfuzzer.com/"
license=('MIT')
depends=('python' 'zope-interface' 'wxpython' 'pyasn1' 'python-multiprocessing' 'twisted' 'wxwidgets-fixed' 'libpcap' 'pyrex' 'unzip')
provides=('cdeepcopy' 'cpeach' 'peach-pypcap' 'pydbgeng' 'vdebug' '4suite-xml')
conflicts=('4suite')
optdepends=('pygtk: VDB gui support'
	    'gtk: VDB gui support'
	    'pango: VDB gui support')
source="http://downloads.sourceforge.net/project/peachfuzz/${_pkgname}/${pkgver}/${_pkgname}-${pkgver}-src.zip"
options=(!emptydirs)
md5sums=('e8f8bce657a8d8bdc9154ff52d2e847d')
sha1sums=('3e9f571832c4e57f1dc252e0bf812da2e01b7672')
install=('peach.install')

build() {

                install -d ${pkgdir}/usr/bin || return 1
                install -d ${pkgdir}/usr/share/${pkgname} || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/docs || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/samples || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/test || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/tools || return 1
                install -d ${pkgdir}/usr/share/${pkgname}/Peach || return 1
                install -d ${pkgdir}/usr/share/licenses/${pkgname} || return 1
																
		# cdeepcopy install
 		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/cDeepCopy
		python2 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# cpeach install
 		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/cPeach
		python2 setup.py install --root=${pkgdir}/ --optimize=1 || return 1

		# peach-pypcap install
 		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/peach-pypcap
		python2 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# peach-pycap post install
		install -d ${pkgdir}/usr/share/peach-pypcap || return 1
               	install -d ${pkgdir}/usr/share/peach-pypcap/doc || return 1
		install -d ${pkgdir}/usr/share/licenses/peach-pypcap || return 1
		install -D -m644 LICENSE ${pkgdir}/usr/share/licenses/peach-pypcap/LICENSE || 1
		## TODO
		##install -D -m755 testsniff.py ${pkgdir}/usr/share/peach-pypcap/testsniff.py || return 1
		##ln -sf /usr/share/peach-pypcap/testsniff.py ${pkgdir}/usr/bin/testsniff.py || return 1
		for pcapdoc in CHANGES README README-Peach.txt; do
  	              install -Dm644 ${pcapdoc} ${pkgdir}/usr/share/peach-pypcap/doc/${pcapdoc} || return 1
                done

		# pydbgeng install
 		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src
		unzip PyDbgEng-0.13.zip || return 1
		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/PyDbgEng-0.13
		python2 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# pydbgeng post install
                install -d ${pkgdir}/usr/share/pydbgeng || return 1
                install -d ${pkgdir}/usr/share/pydbgeng/doc || return 1
                install -d ${pkgdir}/usr/share/pydbgeng/Examples || return 1
		install -d ${pkgdir}/usr/share/licenses/pydbgeng || return 1
		install -D -m644 LICENSE.txt ${pkgdir}/usr/share/licenses/pydbgeng/LICENSE.txt || return 1
                for dbgdoc in CHANGELOG.txt README.txt; do
			install -Dm644 ${dbgdoc} ${pkgdir}/usr/share/pydbgeng/doc/${dbgdoc} || return 1
	        done
		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/PyDbgEng-0.13/Examples
                for dbgex in *; do
                        install -Dm644 ${dbgex} ${pkgdir}/usr/share/pydbgeng/Examples/${dbgex} || return 1
                done

		# vdebug install
 		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src
		unzip vdebug-022710.zip	|| return 1
		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/vdebug-022710
		python2 setup.py install --root=${pkgdir}/ --optimize=1 || return 1
		# vdebug post install
		install -d ${pkgdir}/usr/share/vdebug || return 1
		install -D -m644 README ${pkgdir}/usr/share/vdebug/README || return 1
		
		# 4suite-xml install
		cd ${srcdir}/${_pkgname}-${pkgver}/dependencies/src/4Suite-XML-1.0.2
		python2 setup.py config || return 1
                install -d ${pkgdir}/usr/share/4suite-xml || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/docs || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/locale || return 1
                install -d ${pkgdir}/usr/share/4suite-xml/etc || return 1
		sed -i "s|/local/|/|" config.cache || return 1
		sed -i "s|/usr/local/doc/|/usr/share/4suite-xml/docs/|" config.cache || return 1
		sed -i "s|\$name|4share-xml|" config.cache || return 1
		sed -i "s|/usr/share/locale|/usr/share/4share-xml/locale|" config.cache || return 1
		sed -i "s|/usr/etc/4share-xml|/usr/share/4share-xml/etc|" config.cache || return 1
		python2 setup.py install --root=${pkgdir}/ --optimize=1 --with-docs || return 1
                # 4suite-xml post install
                install -d ${pkgdir}/usr/share/licenses/4suite-xml || return 1
		install -D -m644 COPYRIGHT ${pkgdir}/usr/share/licenses/4suite-xml || return 1
		cp -pR README docs test ${pkgdir}/usr/share/4suite-xml/ || return 1

		# peach install
		cd ${srcdir}/${_pkgname}-${pkgver}
                for pfuzzcp in defaults.xml peach.py peach.xsd peachvalidator.pyw repro.xml template.xml docs samples test tools Peach; do
			cp -pR ${pfuzzcp} ${pkgdir}/usr/share/${pkgname}/ || return 1
                done
                for pfuzzdocscp in changelist.txt readme.html; do
			cp -pR ${pfuzzdocscp} ${pkgdir}/usr/share/${pkgname}/docs/ || return 1
                done

  #create startup app
  echo "#!/bin/sh" > ${pkgdir}/usr/bin/${pkgname}
  echo "cd /usr/share/peach" >> ${pkgdir}/usr/bin/${pkgname}
  echo "python2 peach.py \"\$\@\"" >> ${pkgdir}/usr/bin/${pkgname}
  echo "cd -" >> ${pkgdir}/usr/bin/${pkgname}
  chmod +x ${pkgdir}/usr/bin/${pkgname}
}

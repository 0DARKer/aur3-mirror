# Contributor: Tom < reztho at archlinux dot us >
# Based on an AUR contribution of: Juraj Misur <juraj.misur@gmail.com>
pkgname=capt-src
pkgver=1.90
pkgrel=1
pkgdesc="Canon CAPT Printer Driver for Linux. Compiled from source code."
arch=('i686' 'x86_64')
url="http://software.canon-europe.com/software/0028622.asp"
license=('custom')
depends=('cups' 'libxml2' 'popt')
[ "${CARCH}" == "x86_64" ] && depends=('cups' 'lib32-libxml2' 'lib32-popt')
optdepends=('gtk2: for gui')
install=capt-src.install
source=('http://files.canon-europe.com/files/soft38979/software/Canon_CAPT_Linux_V1.90_EN.tar.gz'
	'ccpd')
options=(!strip !zipman)

build() {
    unset LDFLAGS
    _endlibdir=/usr/lib
    [ "${CARCH}" == "x86_64" ] && _endlibdir=/usr/lib32

	# Decompressing source and proprietary code packages
	tar xvzf ${srcdir}/CANON_UK/Src/cndrvcups-common-${pkgver}-1.tar.gz
	tar xvzf ${srcdir}/CANON_UK/Src/cndrvcups-capt-${pkgver}-1.tar.gz
	
	# Beginning of the source code compilation
	# Based on the official Debian rules of the driver

	# cndrvcups-common package
	cd ${srcdir}/cndrvcups-common-${pkgver}
	for _dir in buftool cngplp
  	do
        cd ${srcdir}/cndrvcups-common-${pkgver}/$_dir && ./autogen.sh --prefix=/usr || return 1
	done
    
    for _dir in cpca
    do
	    cd ${srcdir}/cndrvcups-common-${pkgver}/$_dir && ./autogen.sh --prefix=/usr --disable-static --enable-shared || return 1
    done
	
    for _dir in buftool cngplp cpca c3plmod_ipc
    do
        cd ${srcdir}/cndrvcups-common-${pkgver}/$_dir && make || return 1
    done

	cd ${srcdir}/cndrvcups-common-${pkgver}
	make DESTDIR=${pkgdir} install || return 1

	cd ${srcdir}/cndrvcups-common-${pkgver}/c3plmod_ipc/
	make install DESTDIR=${pkgdir} LIBDIR=/usr/lib || return 1

	# cndrvcups-capt package
	cd ${srcdir}/cndrvcups-capt-${pkgver}
        for _dir in driver ppd backend pstocapt pstocapt2 pstocapt3 statusui
		do
		  cd ${srcdir}/cndrvcups-capt-${pkgver}/$_dir && LDFLAGS=-L${pkgdir}/usr/lib CPPFLAGS=-I${pkgdir}/usr/include ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin --disable-static && make || return 1
	        done
	cd ${srcdir}/cndrvcups-capt-${pkgver}
	make DESTDIR=${pkgdir} install || return 1
	# End of the source code compilation

	# Beginning of the copying of proprietary source
	# Based on the official Debian rules of the driver
	
	# For the cndrvcups-common package...
	cd ${srcdir}/cndrvcups-common-${pkgver}
    mkdir -p ${pkgdir}/usr/bin
    install -c -m 4755 libs/cnpkmodule ${pkgdir}/usr/bin
    install -c -m 755 libs/c3pldrv ${pkgdir}/usr/bin
    mkdir -p ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libcaiowrap.so.1.0.0 ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libcaiousb.so.1.0.0 ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libc3pl.so.0.0.1 ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libcnaccm.so.1.0 ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libcaepcm.so.1.0 ${pkgdir}${_endlibdir}
    install -c -m 755 libs/libcnlbcm.so.1.0 ${pkgdir}${_endlibdir}
	
	cd ${pkgdir}${_endlibdir}
	ln -s libc3pl.so.0.0.1 libc3pl.so.0
    ln -s libc3pl.so.0.0.1 liblibc3pl.so
    ln -s libcnaccm.so.1.0 libcnaccm.so.1
    ln -s libcnaccm.so.1.0 libcnaccm.so
    ln -s libcaepcm.so.1.0 libcaepcm.so.1
    ln -s libcaepcm.so.1.0 libcaepcm.so
    ln -s libcnlbcm.so.1.0 libcnlbcm.so.1
    ln -s libcnlbcm.so.1.0 libcnlbcm.so
    ln -s libcaiowrap.so.1.0.0 libcaiowrap.so.1
    ln -s libcaiowrap.so.1.0.0 libcaiowrap.so
    ln -s libcaiousb.so.1.0.0 libcaiousb.so.1
    ln -s libcaiousb.so.1.0.0 libcaiousb.so

  	mkdir -p ${pkgdir}/usr/share/caepcm
	cd ${srcdir}/cndrvcups-common-${pkgver}
    install -c -m 644 data/CA*    ${pkgdir}/usr/share/caepcm
    install -c -m 644 data/CNZ0*  ${pkgdir}/usr/share/caepcm
	
	chmod 4755 ${pkgdir}/usr/bin/cnpkmodule
	mkdir -p   ${pkgdir}/etc/cngplp/account
	chmod 777  ${pkgdir}/etc/cngplp/account
	
	# For the cndrvcups-capt package...
	cd ${srcdir}/cndrvcups-capt-${pkgver}
	mkdir -p ${pkgdir}${_endlibdir}
    install -c libs/libcaptfilter.so.1.0.0  ${pkgdir}${_endlibdir}
    install -c libs/libcaiocaptnet.so.1.0.0 ${pkgdir}${_endlibdir}
    install -c libs/libcncaptnpm.so.1.0.7   ${pkgdir}${_endlibdir}
	cd ${pkgdir}${_endlibdir}
	ln -s libcaptfilter.so.1.0.0 libcaptfilter.so.1
    ln -s libcaptfilter.so.1.0.0 libcaptfilter.so
	ln -s libcaiocaptnet.so.1.0.0 libcaiocaptnet.so.1
	ln -s libcaiocaptnet.so.1.0.0 libcaiocaptnet.so
	ln -s libcncaptnpm.so.1.0.7 libcncaptnpm.so.1
	ln -s libcncaptnpm.so.1.0.7 libcncaptnpm.so

	mkdir -p ${pkgdir}/usr/bin
	cd ${srcdir}/cndrvcups-capt-${pkgver}
	install -c libs/captdrv                 ${pkgdir}/usr/bin
	install -c libs/captfilter              ${pkgdir}/usr/bin
	install -c libs/captmon/captmon         ${pkgdir}/usr/bin
	install -c libs/captmon2/captmon2       ${pkgdir}/usr/bin
	install -c libs/captemon/captmon*       ${pkgdir}/usr/bin
    mkdir -p ${pkgdir}/usr/sbin
    install -c libs/ccpd                    ${pkgdir}/usr/sbin
    install -c libs/ccpdadmin               ${pkgdir}/usr/sbin
    mkdir -p ${pkgdir}/etc
	install -c samples/ccpd.conf            ${pkgdir}/etc
    mkdir -p ${pkgdir}/usr/share/ccpd
	install -c libs/ccpddata/CNAB1CL.BIN    ${pkgdir}/usr/share/ccpd
	install -c libs/ccpddata/CNAC4CL.BIN    ${pkgdir}/usr/share/ccpd
	install -c libs/ccpddata/CNAC5CL.BIN    ${pkgdir}/usr/share/ccpd
	install -c libs/ccpddata/CNAC6CL.BIN    ${pkgdir}/usr/share/ccpd
	install -c libs/ccpddata/cnab6cl.bin    ${pkgdir}/usr/share/ccpd
	mkdir -p ${pkgdir}/usr/share/captmon
	install -c libs/captmon/msgtable.xml    ${pkgdir}/usr/share/captmon
    mkdir -p ${pkgdir}/usr/share/captmon2
    install -c libs/captmon2/msgtable2.xml  ${pkgdir}/usr/share/captmon2
    mkdir -p ${pkgdir}/usr/share/captemon
    install -c libs/captemon/msgtablelbp*   ${pkgdir}/usr/share/captemon
    install -c libs/captemon/msgtablecn*    ${pkgdir}/usr/share/captemon
    mkdir -p ${pkgdir}/usr/share/caepcm
    install -c -m 644 data/C*   ${pkgdir}/usr/share/caepcm
    mkdir -p ${pkgdir}/usr/share/doc/cndrvcups-capt
    install *capt*.txt ${pkgdir}/usr/share/doc/cndrvcups-capt
	# End of the copying of proprietary source

	# Installation of the custom Arch Linux init script
	mkdir -p ${pkgdir}/etc/rc.d
	cp ${srcdir}/ccpd ${pkgdir}/etc/rc.d
	chmod 755 ${pkgdir}/etc/rc.d/ccpd
	
	# Fifo files needed for the daemon
	# Based on the official Debian postinst script
	#mkdir -p ${pkgdir}/var/ccpd
	#mkfifo -m 660 ${pkgdir}/var/ccpd/fifo0
    #mkfifo -m 660 ${pkgdir}/var/ccpd/fifo1
    #mkfifo -m 660 ${pkgdir}/var/ccpd/fifo2
    #mkfifo -m 660 ${pkgdir}/var/ccpd/fifo3
	#mkfifo -m 660 ${pkgdir}/var/ccpd/fifo4
	#mkfifo -m 660 ${pkgdir}/var/ccpd/fifo5
	#mkfifo -m 660 ${pkgdir}/var/ccpd/fifo6
	#mkfifo -m 660 ${pkgdir}/var/ccpd/fifo7
    #chown -R root.lp ${pkgdir}/var/ccpd
    #chmod 770 ${pkgdir}/var/ccpd
    #mkdir -p ${pkgdir}/var/captmon/
	#chown -R root.lp ${pkgdir}/var/captmon
    #chmod -R 770 ${pkgdir}/var/captmon
	
	# Custom License
	mkdir -p ${pkgdir}/usr/share/licenses/$pkgname
	cp ${srcdir}/CANON_UK/Doc/LICENSE-captdrv-${pkgver}E.txt ${pkgdir}/usr/share/licenses/$pkgname/

	# Cleaning
	rm -rf ${pkgdir}/etc/cngplp
}

md5sums=('ad69060c380a10a4c025583438dbd17e'
         '26b848932cec7a6a1a11145c10446e4b')

# Maintainer: grimi <grimi at poczta dot fm>

_pkgname=fs-uae
pkgname=fs-uae-devel
pkgver=2.5.29dev
pkgrel=1
pkgdesc="Cross-platform Amiga emulator based on UAE/WinUAE (development version)."
arch=("i686" "x86_64")
url="http://fs-uae.net/download-devel"
license=("GPL2")
depends=("sdl2" "libpng" "openal" "mesa" "glu" "gettext" "freetype2" "hicolor-icon-theme" "xdg-utils")   # 'glib2' provided by 'gettext', and 'zlib' by 'libpng'
makedepends=('zip')
install="${pkgname}.install"
source=("http://fs-uae.net/devel/${pkgver}/${_pkgname}-${pkgver}.tar.gz")
#source=("http://ppa.launchpad.net/fengestad/devel/ubuntu/pool/main/f/${_pkgname}/${_pkgname}_${pkgver}.orig.tar.gz")
provides=("fs-uae")
conflicts=("fs-uae")
md5sums=('fb4148ac61fa019cf4719b8dcd4845dc')


#MAKEFLAGS="-j1"



prepare() {
   if [[ $CARCH == "x86_64" && -n $(gcc -v 2>&1|grep '\-\-enable-multilib') ]]; then
      msg ""
      msg "Available build method for x86_64 with multilib [0-3]."
      msg "0 = 32bit exe only (jit available)"
      msg "1 = dual 32/64 default 32bit exe"
      msg "2 = dual 32/64 default 64bit exe"
      msg "3 = 64bit exe only"
      while [[ $FSUAE3264 != [0-3] ]]; do
         msg2 "Select build method (default 0): "
         read -p "   "  FSUAE3264
         [[ -z $FSUAE3264  ]] && FSUAE3264=0
         [[ $FSUAE3264 != [0-3] ]] && msg2 "Type [0-3] or just hit Enter"
      done
      export FSUAE3264
   fi
}


build() {
   cd ${_pkgname}-${pkgver}
   if [[ $FSUAE3264 != 0 ]]; then
      ./configure --prefix=/usr
      make
   fi

   if [[ $FSUAE3264 == [1-2] ]]; then
      cp fs-uae ../fs-uae-64
      cp fs-uae-device-helper ../
      make clean
   fi

   if [[ $FSUAE3264 == [0-2] ]]; then
      export CC="gcc -m32" CXX="g++ -m32" PKG_CONFIG_PATH="/usr/lib32/pkgconfig"
      export CFLAGS="${CFLAGS/x86-64/i686}" CXXFLAGS="${CXXFLAGS/x86-64/i686}"
      ./configure --prefix=/usr
      make
   fi

   if [[ $FSUAE3264 == [1-2] ]]; then
      let local fua=$FSUAE3264*32
      echo -e "#!/bin/sh\n[[ -z \$FSUAE_EXE ]] && FSUAE_EXE=${fua}\nexec /usr/bin/${_pkgname}-\${FSUAE_EXE} \"\$@\"" > fs-uae.sh
   fi
}



package() {
   cd ${_pkgname}-${pkgver}

   make install DESTDIR="${pkgdir}"

   if [[ $FSUAE3264 == [1-2] ]]; then
      mv "${pkgdir}"/usr/bin/fs-uae{,-32}
      install -m755 ../fs-uae-64 "${pkgdir}"/usr/bin
      install -m755 ../fs-uae-device-helper "${pkgdir}"/usr/bin
      install -m755 fs-uae.sh "${pkgdir}"/usr/bin/fs-uae
   fi

   if [[ $FSUAE3264 == [1-2] ]]; then
      depends+=("lib32-sdl2" "lib32-libpng" "lib32-glib2" "lib32-openal" "lib32-mesa" "lib32-glu" "lib32-gettext" "lib32-freetype2")
      makedepends+=("libtool-multilib")
      pkgdesc="${pkgdesc/\(dev/dual 64 and 32-bit dev}"
   elif [[ $FSUAE3264 == 0 ]]; then
      depends=("lib32-sdl2" "lib32-libpng" "lib32-glib2" "lib32-openal" "lib32-mesa" "lib32-glu" "lib32-gettext" "lib32-freetype2" "xdg-utils" "hicolor-icon-theme")
      makedepends+=("libtool-multilib")
      pkgdesc="${pkgdesc/\(dev/\(32-bit dev}"
   fi
}


# vim:set ts=3 sw=3 sts=3 et:


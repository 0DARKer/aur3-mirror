# Maintainer: Nigel Michki <nigeil@yahoo.com>
pkgname=sonic-pi-git
pkgver=v2.2.0.r70.g8b72ac8
pkgrel=1
pkgdesc="A music-centric programming environment, originally built for the raspberry pi."
arch=('i686' 
      'x86_64')
url="http://sonic-pi.net/"
license=('MIT')
groups=()
depends=('sed'
	 'ruby'
	 'libffi'
	 'lua'
	 'qscintilla-qt5'
	 'jack')
makedepends=('cmake'
	     'git'
	     'supercollider'
	     'qt4')
optdepends=('qjackctl: for graphical jackd spawning/configuration'
	    'jack2: better jackd if you want to use without gui')
source=('sonic-pi::git+https://github.com/samaaron/sonic-pi.git'
	'Qt5scintilla2_archLib.patch'
	'launcher.sh')
md5sums=('SKIP'
         '68932f655fca2779a9e8a001d917ca6d'
         '9c6a820718f549d9c49dfb3d9a8b102e')

prepare() {
msg2 "We have to patch the SonicPi.pro file \
which attempts to link to a wrongly-named \
library (for Arch linux and some other distros) "
  patch -p1 $srcdir/sonic-pi/app/gui/qt/SonicPi.pro $srcdir/Qt5scintilla2_archLib.patch
}

build() {
#Based on instructions from INSTALL.md in sources
#Building
  cd $srcdir/sonic-pi
  cd app/server/bin
  ./compile-extensions.rb
  cd ../../gui/qt
  ./rp-build-app
}

pkgver() {
  cd $srcdir/sonic-pi
  git describe --long --tags | sed -r 's/([^-]*-g)/r\1/;s/-/./g'
}

package() {
  mkdir $pkgdir/opt/
  mkdir $pkgdir/opt/sonic-pi-git
  cp -R $srcdir/sonic-pi $pkgdir/opt/sonic-pi-git/
  mkdir $pkgdir/usr
  mkdir $pkgdir/usr/bin
  cp $srcdir/launcher.sh $pkgdir/usr/bin/sonic-pi
  chmod +x $pkgdir/usr/bin/sonic-pi
}

# Contributor:	Thomas Mudrunka <harvie@@email..cz>
# Maintainer:	Thomas Mudrunka <harvie@@email..cz>
# You can also contact me on http://blog.harvie.cz/
# Maintainer: Max Fierke <max@maxfierke.com>

pkgbase=apparmor
pkgname=apparmor
true && pkgname=(apparmor-parser apparmor-libapparmor apparmor-utils apparmor-profiles apparmor-pam)
pkgver=2.7.0
pkgrel=3
arch=('i686' 'x86_64')
license=('GPL')
url='http://wiki.apparmor.net/index.php/Main_Page'
groups=('apparmor')
makedepends=('swig' 'perl' 'python2' 'ruby' 'perl-locale-gettext' 'perl-rpc-xml' 'wxgtk' 'audit')
#optdepends=('linux-hardened: kernel with AppArmor, SELinux, Grsecurity/PAX, and TOMOYO support')
pacman -Qi apparmor-libapparmor &>/dev/null &&
	true && pkgname=(${pkgname[*]} apparmor-profile-editor apparmor-dbus) &&
	depends=(${depends[*]} apparmor-libapparmor) &&
	msg "Building with libapparmor dependent packages..."

bigver="$(echo ${pkgver} | cut -d . -f -2)"
source=("http://launchpad.net/apparmor/${bigver}/${pkgver}/+download/apparmor-${pkgver}.tar.gz"
	"apparmor")

md5sums=('9cc38779a43004dbc7f09932fa848366'
         '3c56820370318f6f195ea88b723ef628')
sha1sums=('9428e466e242b9381ac152dafb58d488c8a01921'
          '02951f448d7a3d222472304d3135c324f9909923')
sha256sums=('ff8a2f49f902faa78e502590c65d3850fb9a2a3453bef0dc1f99e947c52fc60f'
            '6dc84e8c3cdc6009ae128930a04fd8d3bf36afc2fd8f4283c234f235753fa8ca')
sha384sums=('badb2852546ecf4a9bf2969a6689be3da839bea7f4b06dbc8f5946a0869bbc859b1d70427e0a12318adc98127ca157c1'
            'fa032ddb7d66050f017c4f8297ceb8affbfeaf7b7d447eb6408a23d205f495579b1eec4f127d4611c4d382ef06ae0a49')
sha512sums=('7573d1e99f0214f26add021b2492c19b3fd340a8b5f964ce6759a026a947f4281564264b8daa14ec30cb0817d05473e8b48a9fc24bcd93e5b4c59d9a6b99ba7d'
            '2b4f811f923dfcf424f45d3c91c662193fab45c4a1e3f2f9bb039bd76865e93139c87df838ad57eb9fc618b0f07bcaca917f34eff008bc330d0129b79017825f')


#Configuration
core_perl_dir='/usr/bin/core_perl'
export MAKEFLAGS+=" POD2MAN=${core_perl_dir}/pod2man"
export MAKEFLAGS+=" POD2HTML=${core_perl_dir}/pod2html"
export MAKEFLAGS+=" PROVE=${core_perl_dir}/prove"
export PYTHON='/usr/bin/python2'

build() {
	export srcroot="${srcdir}/${pkgbase}-${pkgver}";
}

package_apparmor-parser() {
	pkgdesc='AppArmor parser - loads AA profiles to kernel module'
	cd "${srcroot}/parser"; msg2 "${PWD##*/}"

  msg2 'Patching...'
  #Patch (maybe we can avoid patching by ./configuring things better)
  patch=Makefile; { rm "$patch"
    sed -e 's/pdflatex/true/g' > "$patch" #just workaround until we'll get pdflatex package
  } < "$patch"
  echo '#!/bin/true' > tst/caching.sh #Can't pass this test with current kernel

	make
	make install DESTDIR=${pkgdir}
}

package_apparmor-libapparmor() {
	pkgdesc='AppArmor library'
	makedepends=(swig perl python2 ruby)
	provides=('apparmor-lib' 'libapparmor' 'apparmor-perl' 'apparmor-python' 'apparmor-ruby')
	( cd "${srcroot}/libraries/libapparmor"; msg2 "${PWD##*/}"
		./autogen.sh
		./configure --prefix=/usr --with-perl --with-python --with-ruby
		make
		make install DESTDIR=${pkgdir}
		#FIXME: this file should install automatically:
		cp swig/perl/LibAppArmor.pm ${pkgdir}/usr/lib/perl5/vendor_perl/
		)
}

package_apparmor-utils() {
	pkgdesc='AppArmor userspace utilities'
	depends=('perl' 'perl-locale-gettext' 'perl-term-readkey' 'perl-file-tail' 'perl-rpc-xml')
	optdepends=('perl: many apparmor utilities' 'perl-rpc-xml: more utilities')
	provides=('apparmor-notify');
	install='apparmor.install'
	( cd "${srcroot}/utils"; msg2 "${PWD##*/}"
		make
		make install DESTDIR=${pkgdir}
	  mkdir -p ${pkgdir}/etc/rc.d
	  cp ../../apparmor ${pkgdir}/etc/rc.d/
		)
}

package_apparmor-profiles() {
	pkgdesc='AppArmor sample pre-made profiles'
	( cd "${srcroot}/profiles"; msg2 "${PWD##*/}"
		make
		make install DESTDIR=${pkgdir}
		)
}

package_apparmor-profile-editor() {
	pkgdesc='AppArmor profile editor using WxWidgets (or WxGTK)'
  depends=('apparmor-libapparmor' 'wxgtk' 'audit')
	( cd "${srcroot}/deprecated/management/profile-editor"; msg2 "${PWD##*/}"
		./macros/autogen.sh
		./configure --prefix=/usr
		make
		make install DESTDIR=${pkgdir}
		)
}

package_apparmor-dbus() {
	pkgdesc='AppArmor DBUS API'
  depends=('apparmor-libapparmor')
	( cd "${srcroot}/deprecated/management/apparmor-dbus"; msg2 "${PWD##*/}"
		./autogen.sh
		./configure --prefix=/usr
		make
		make install DESTDIR=${pkgdir}
		)
}

package_apparmor-applet() {
	pkgdesc='AppArmor Applet for Gnome'
  depends=('apparmor-libapparmor')
	#FIXME: can't build this:
	( cd "${srcroot}/deprecated/management/applets/apparmorapplet-gnome"; msg2 "${PWD##*/}"
		./autogen.sh
		./configure --prefix=/usr
		make
		make install DESTDIR=${pkgdir}
		)
}

package_apparmor-pam() {
	pkgdesc='AppArmor PAM library'
  depends=('apparmor-libapparmor')
	( cd "${srcroot}/changehat/pam_apparmor"; msg2 "${PWD##*/}"
		make
		make install DESTDIR=${pkgdir}
		)
}

#AUR hack:
pkgdesc='Linux application security framework - mandatory access control for programs'

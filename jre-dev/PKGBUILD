# Maintainer: kfgz <kfgz at interia dot pl>
# Previous Maintainer: Army <gmail.com: uli[dot]armbruster>
# Previous Maintainer: Geoffroy Carrier <geoffroy dot carrier at aur dot archlinux dot org>
# Previous Maintainer: Jason Chu <jason at archlinux dot org>
# Contributor: Charles Ghislain <charlyghislain at gmail dot com>
pkgname=jre-dev
_jdkver=7
# in order to update the PKGBUILD usually only the following two lines need to be changed + the md5sums
_jdkbuild=b129
_jdkdate=10_feb_2011

pkgver=${_jdkver}${_jdkbuild}
pkgrel=1
pkgdesc="Sun's Java Runtime Environement, snapshot release"
arch=(i686 x86_64)
  [ "${CARCH}" = "i686" ]   && ARCH=i586
  [ "${CARCH}" = "x86_64" ] && ARCH=x64


###### FOR TESTING PURPOSE ONLY!!! ######
#  [ "${CARCH}" = "i686" ]   && ARCH=x64
#  [ "${CARCH}" = "x86_64" ] && ARCH=i586
#########################################


_filename=jdk-${_jdkver}-ea-bin-${_jdkbuild}-linux-${ARCH}-${_jdkdate}.bin
url="https://jdk7.dev.java.net/"
depends=(libxtst)
source=(http://www.java.net/download/jdk7/archive/${_jdkbuild}/binaries/${_filename}
	https://jdk-distros.dev.java.net/source/browse/*checkout*/jdk-distros/trunk/utils/construct.sh
	jre.profile)
	
if [ "${CARCH}" = "x86_64" ]; then 
   md5sums[0]=6d8ea9eb3878a3f9f5891a20cb4b0ad0
  else
   md5sums[0]=5c29ec9ded5151fac67c827bf216b489
fi

### FOR TESTING PURPOSE ONLY!!! ###
#if [ "${CARCH}" = "x86_64" ]; then 
#   md5sums[0]=
#   else
#   md5sums[0]=
#fi 
###################################


md5sums[1]=94065b612df0046d9ae758943f9f6a75
md5sums[2]=50b4f5ac4129097461d246645d73a622

replaces=(j2re)
conflicts=(java-runtime j2re)
provides=(java-runtime=7 j2re)
license=(custom)

build() {
  cd ${srcdir}

  mkdir unbundle-jdk
  cd unbundle-jdk

  #some magic with the license ;]
  sed -i "s/more <<\"EOF\"/echo <<\"EOF\"/g" ../${_filename}
  yes | sh ../${_filename} --accept-license

  cd ..
  
  sh construct.sh unbundle-jdk linux-jdk linux-jre

  install -dm755 ${pkgdir}/opt/java
  mv linux-jdk/jre ${pkgdir}/opt/java

  install -D -m755 ${srcdir}/jre.profile ${pkgdir}/etc/profile.d/jre.sh

  install -dm755 ${pkgdir}/usr/lib/mozilla/plugins

  if [ "$CARCH" = "x86_64" ]; then
     ln -s /opt/java/jre/lib/amd64/libnpjp2.so ${pkgdir}/usr/lib/mozilla/plugins
  else 
     ln -s /opt/java/jre/lib/i386/libnpjp2.so ${pkgdir}/usr/lib/mozilla/plugins
  fi
  
  install -dm755 ${pkgdir}/usr/share/licenses/jre
  install -D -m644 ${pkgdir}/opt/java/jre/COPYRIGHT ${pkgdir}/usr/share/licenses/jre
  #install -D -m644 ${pkgdir}/opt/java/jre/LICENSE ${pkgdir}/usr/share/licenses/jre
  
  rm -rf ${srcdir}/unbundle-jdk
  rm -rf ${srcdir}/linux-jdk
  #revert license magic
  sed -i "s/echo <<\"EOF\"/more <<\"EOF\"/g" ${srcdir}/${_filename}
}

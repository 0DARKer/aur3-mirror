# Maintainer: GordonGR <gordongr@freemail.gr>
# Contributor: Splex

pkgname=teapotviewer
pkgver=0.2.5.0
_pngver=1.5.1
pkgrel=1
pkgdesc="An Open Source third party viewers for Second LifeÂ® (secondlife) and OpenSim (opensimulator) grids."
url="http://bitbucket.org/ArminW/teapot/"
license=('LGPL')
#install=teapot.install
arch=('i686' 'x86_64')




if [ "$CARCH" = "i686" ]; then
	depends=('apr-util' 'freealut' 'gtk2' 'libgl' 'libidn' 'libjpeg7' 'mesa' 'nss' 'sdl')
	optdepends=('libpulse: for PulseAudio support' 'alsa-lib: for ALSA support' 'nvidia-utils: for NVIDIA support')
	_arch=$CARCH
	source=("https://bitbucket.org/ArminW/teapot/downloads/Teapot-${pkgver}-Linux-${_arch}.tar.bz2" \
	"http://downloads.sourceforge.net/sourceforge/libpng/libpng-${_pngver}.tar.xz" \
	'teapot.desktop' \
	'teapot.launcher'
	'donotregister.patch')
	sha256sums=('8eac413302a2ddaa7c29c04f50893548f9f7592be36dcb69b634611d7e4d30a2'
	'd230837ad959b395bf7e2937e0136e6037208a29cda83000bf8b88a3692e8c69'
	'20ec782a76b0b74092544836cb477809d77fd1d754e60b5cb555501b84078861'
	'd69d203a06c45a7444c01aa88d27a4b4439936dded74e280c7d98c499fd93c40'
	'91fc670961fa17fd57db3011e431d253b669f3de7fe04d389518b4bd4c254ba0')

elif [ "$CARCH" = "x86_64" ]; then
	depends=('apr-util' 'freealut' 'gtk2' 'libgl' 'lib32-libidn' 'libjpeg7' 'mesa' 'nss' 'sdl' 'lib32-freealut' 'lib32-util-linux' 'lib32-zlib')
	optdepends=('lib32-libpulse: for PulseAudio support'
				'lib32-alsa-lib: for ALSA support'
				'lib32-nvidia-utils: for NVIDIA support')
	_arch=$CARCH
	source=("https://bitbucket.org/ArminW/teapot/downloads/Teapot-${pkgver}-Linux-${_arch}.tar.bz2" \
	"http://downloads.sourceforge.net/sourceforge/libpng/libpng-${_pngver}.tar.xz" \
	'teapot.desktop' \
	'teapot.launcher'
	'donotregister.patch')
	sha256sums=('94c698d346daf2e6f5d206b5b284651a387c258c38f9b2ea3626ec69f1c84058'
	'd230837ad959b395bf7e2937e0136e6037208a29cda83000bf8b88a3692e8c69'
	'20ec782a76b0b74092544836cb477809d77fd1d754e60b5cb555501b84078861'
	'd69d203a06c45a7444c01aa88d27a4b4439936dded74e280c7d98c499fd93c40'
	'91fc670961fa17fd57db3011e431d253b669f3de7fe04d389518b4bd4c254ba0')
fi



build(){
if [ "$CARCH" = "i686" ]; then
	export CC="gcc"
	export CXX="g++"
	export PKG_CONFIG_PATH="/usr/lib/pkgconfig"

elif [ "$CARCH" = "x86_64" ]; then
	export CC="gcc -m32"
	export CXX="g++ -m32"
	export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

fi

cd "${srcdir}/libpng-${_pngver}"
./configure
make
}


package() {
  cd $srcdir
  
  # Rename Data Directory
  mv Teapot-${pkgver}-Linux-$CARCH teapot
  
  # Do not register the application (saves from badly-installed desktop files and icons)
  
  patch teapot/teapot donotregister.patch
  rm teapot/etc/refresh_desktop_app_entry.sh

  # Install Desktop File
  install -D -m644 $srcdir/teapot.desktop \
    $pkgdir/usr/share/applications/teapot.desktop
  
  # Install Icon File
  install -D -m644 $srcdir/teapot/teapot_icon.png \
    $pkgdir/usr/share/pixmaps/teapot.png
  
  # Install Launcher
  install -D -m755 $srcdir/teapot.launcher \
    $pkgdir/usr/bin/teapot

  # Move Data to Destination Directory
  install -d $pkgdir/opt
  mv teapot $pkgdir/opt/

  # Install libpng we built

if [ "$CARCH" = "i686" ]; then
	install -D -m755 $srcdir/libpng-${_pngver}/.libs/libpng15.so.15.1.0 \
	$pkgdir/opt/teapot/lib
	cd $pkgdir/opt/teapot/lib
	ln -s libpng15.so.15.1.0 libpng15.so.15
	ln -s libpng15.so.15.1.0 libpng15.so

elif [ "$CARCH" = "x86_64" ]; then
	install -D -m755 $srcdir/libpng-${_pngver}/.libs/libpng15.so.15.1.0 \
	$pkgdir/opt/teapot/lib32
	cd $pkgdir/opt/teapot/lib32
	ln -s libpng15.so.15.1.0 libpng15.so.15
	ln -s libpng15.so.15.1.0 libpng15.so

fi
}

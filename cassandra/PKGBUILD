# Contributor: Thomas Dziedzic < gostrc at gmail >
# Maintainer: <helllamer@gmail.com> 

# check() function is used to verify GPG signature. check() imports 3 keys into your GPG keyring at first build.
# See http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html for reason of this step.
# If you have problems with gpg, you can remove check() function, and all will be ok.

pkgname=cassandra
pkgver=0.8.2
pkgrel=1
pkgdesc="NoSQL database (precompiled official version)"
arch=('any')
url="http://cassandra.apache.org/"
license=('APACHE')
depends=('java-runtime')
builddepends=('gnupg')
url_tgz="http://apache.mirror.anlx.net/cassandra/$pkgver/apache-$pkgname-$pkgver-bin.tar.gz"
source=($url_tgz)
md5sums=('1631fb51f70361cae67f3ebb925486fe')

## to check gpg signature
check() {
	msg "Checking GPG signature..."
	gpg --list-keys 2>/dev/null | grep 'sylvain@datastax.com' >/dev/null || {
		url_keys='https://www.apache.org/dist/cassandra/KEYS'
		msg "No maintainers' GPG keys found. Importing from $url_keys (2,7 KiB)..."
		wget --quiet -O - $url_keys | gpg --import - 2>/dev/null
	}
	# no need to add signature to package dependences
	wget --quiet -O - "$url_tgz.asc" 2>/dev/null | gpg --verify - "apache-$pkgname-$pkgver-bin.tar.gz" 2>/dev/null
	msg "Detached GPG signature is valid."
}

package() {
	cd apache-cassandra-${pkgver}

	mkdir -p ${pkgdir}/var/{lib,log}/cassandra
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/share/cassandra

	sed -i 's_`dirname $0`/.._/usr/share/cassandra_' bin/cassandra.in.sh

	chown http:http ${pkgdir}/var/{lib,log}/cassandra

	cp -a {lib,conf,interface} ${pkgdir}/usr/share/cassandra/

	cd bin

	install \
		cassandra \
		cassandra-cli \
		json2sstable \
		nodetool \
		sstable2json \
		sstablekeys \
		stop-server \
		${pkgdir}/usr/bin/

	install \
		cassandra.in.sh \
		${pkgdir}/usr/share/cassandra/
}

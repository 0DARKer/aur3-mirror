# Maintainer: Guillaume ALAUX <guillaume at alaux dot net>
# Contributor: Thomas Dziedzic < gostrc at gmail >
# Contributor: Konstantin Nikiforov <helllamer@gmail.com> 
# Thanks to Alper Kanat <alperkanat@raptiye.org> for cassandra rc.d script. 

# check() function is used to verify GPG signature. check() imports 3 keys into your GPG keyring at first build.
# See http://scarybeastsecurity.blogspot.com/2011/07/alert-vsftpd-download-backdoored.html for reason of this step.
# If you have problems with gpg, you can remove check() function, and all will be ok.

pkgname=cassandra
pkgver=1.1.6
pkgrel=2
pkgdesc="NoSQL database (precompiled official version)"
arch=('any')
url="http://cassandra.apache.org/"
license=('APACHE')
depends=('java-runtime')
makedepends=('gnupg')
_url_tgz="http://apache.mirror.anlx.net/${pkgname}/${pkgver}/apache-${pkgname}-${pkgver}-bin.tar.gz"
source=(${_url_tgz}
        cassandra.rc.d
        cassandra.service.systemd)
md5sums=('ea55f265d131cd1e0edf9503b3b9aadc'
         '6b3f990f820927defc157892d5f45944'
         'aa03bc87b3d139f8e5e747661e7588f2')

## to check gpg signature
check() {
	msg "Checking GPG signature..."
        msg2 "(To disable gpg-check: remove/rename check() function from/in PKGBUILD code.)"
	gpg --list-keys | grep 'sylvain@datastax.com' || {
		url_keys='https://www.apache.org/dist/cassandra/KEYS'
		msg "No maintainers' GPG keys found. Importing from ${_url_keys} ..."
		wget --quiet -O - ${_url_keys} | gpg --import -
	}
	# no need to add signature to package dependences
	echo "${_url_tgz}.asc"
	wget --quiet -O - "${_url_tgz}.asc" | gpg --verify - "apache-${pkgname}-${pkgver}-bin.tar.gz"
	msg2 "Detached GPG signature is valid."
}

package() {
	cd $srcdir/apache-cassandra-${pkgver}

	mkdir -p ${pkgdir}/var/{lib,log}/cassandra
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/share/cassandra

	sed -i 's_`dirname $0`/.._/usr/share/cassandra_' bin/cassandra.in.sh

	chown http:http ${pkgdir}/var/{lib,log}/cassandra

	cp -a {lib,conf,interface} ${pkgdir}/usr/share/cassandra/

	cd bin

	install \
		cassandra \
		cassandra-cli \
		json2sstable \
		nodetool \
		sstable2json \
		sstablekeys \
		stop-server \
		${pkgdir}/usr/bin/

	install \
		cassandra.in.sh \
		${pkgdir}/usr/share/cassandra/

    install -Dm755 ${srcdir}/cassandra.rc.d ${pkgdir}/etc/rc.d/cassandra
    install -Dm644 ${srcdir}/cassandra.service.systemd ${pkgdir}/lib/systemd/system/cassandra.service
}

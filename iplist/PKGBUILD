# Maintainer: Romain GALLET < romain.gallet at gmial dot com>
# Contributor: updated by pelle.k
# Contributor: mrbug <devmrbug at google's mail service dot com>
pkgname=iplist
pkgver=0.29
pkgrel=3
pkgdesc="list-based packet handler and blocker which uses the netfilter netlink-queue library (kernel 2.6.14 or later)"
arch=('i686' 'x86_64')
url="http://iplist.sourceforge.net"
license=('GPL')
depends=('libnetfilter_queue' 'gcc' 'libnfnetlink' 'zlib' 'linux')
makedepends=('patch' 'wget')
optdepends=('java-runtime: GUI support')
conflicts=('moblock')
backup=('etc/ipblock.conf' 
	'etc/ipblock.lists')
options=('docs' 'strip' 'zipman')
install=$pkgname.install

source=(http://downloads.sourceforge.net/$pkgname/$pkgname-$pkgver.tar.bz2 
	$pkgname.install rc.ipblock ipblock.patch nfq.patch)

md5sums=('e1f8186621c5ba79f82cdeffe80429d5'  
	'8493c25ec1e509c0d8ceea81549bcfd4' 
	'3fe445f3a3bed95f76565977ccd763b9' 
	'09a4d832ca261dad7f6f73add71ab2a4'
	'c9c427b71dde9c4ba32f1a3bcd0d78bf')

build() {
  mkdir -p ${pkgdir}/usr/sbin
  mkdir -p ${pkgdir}/etc/rc.d
  mkdir -p ${pkgdir}/usr/share/applications
  mkdir -p ${pkgdir}/usr/share/pixmaps
  mkdir -p ${pkgdir}/usr/share/java
  mkdir -p ${pkgdir}/usr/share/man/man8
  mkdir -p ${pkgdir}/var/cache/iplist
  mkdir -p ${pkgdir}/usr/share/doc/iplist

  install -Dm 664 ${srcdir}/$pkgname/ipblock.8 ${pkgdir}/usr/share/man/man8
  install -Dm 664 ${srcdir}/$pkgname/ipblock.conf ${pkgdir}/etc/
  install -Dm 664 ${srcdir}/$pkgname/ipblock.lists ${pkgdir}/etc/
  install -Dm 664 ${srcdir}/$pkgname/allow.p2p ${pkgdir}/var/cache/iplist/
  install -Dm 664 ${srcdir}/$pkgname/ipblock.png ${pkgdir}/usr/share/pixmaps
  install -Dm 664 ${srcdir}/$pkgname/ipblock.desktop ${pkgdir}/usr/share/applications
  install -Dm 664 ${srcdir}/$pkgname/changelog ${pkgdir}/usr/share/doc/iplist
  install -Dm 664 ${srcdir}/$pkgname/COPYING ${pkgdir}/usr/share/doc/iplist
  install -Dm 664 ${srcdir}/$pkgname/INSTALL ${pkgdir}/usr/share/doc/iplist
  install -Dm 755 ${srcdir}/rc.ipblock ${pkgdir}/etc/rc.d/ipblock
  
  cd ${srcdir}/$pkgname
  patch --no-backup-if-mismatch ${srcdir}/iplist/src/nfq.cc ${srcdir}/nfq.patch || return 1
  make || return 1
  make DESTDIR="${pkgdir}" install || return 1

  touch ${pkgdir}/var/cache/iplist/allow-perm.p2p
  touch ${pkgdir}/var/cache/iplist/allow-temp.p2p
  patch --no-backup-if-mismatch ${pkgdir}/usr/sbin/ipblock ${srcdir}/ipblock.patch || return 1
}


From b9c59602bf181953b7f916042bd2a605803b9a86 Mon Sep 17 00:00:00 2001
From: Edu Garcia <arcnorj@gmail.com>
Date: Sat, 6 Sep 2014 11:12:42 +1000
Subject: [PATCH 1/3] #16: Added proper versions on desktop & Android to main
 screen & metadata

---
 PD-classes/src/com/watabou/noosa/Game.java                 | 11 ++---------
 android/build.gradle                                       |  5 +++++
 android/src/com/watabou/pd/android/AndroidLauncher.java    | 10 +++++++++-
 build.gradle                                               |  5 +++--
 core/src/com/watabou/pixeldungeon/PixelDungeon.java        |  4 +++-
 desktop/build.gradle                                       |  2 ++
 desktop/src/com/watabou/pd/desktop/DesktopLauncher.java    |  6 +++++-
 html/src/com/watabou/pixeldungeon/client/HtmlLauncher.java |  3 ++-
 ios/src/com/watabou/pd/IOSLauncher.java                    |  3 ++-
 9 files changed, 33 insertions(+), 16 deletions(-)

diff --git a/PD-classes/src/com/watabou/noosa/Game.java b/PD-classes/src/com/watabou/noosa/Game.java
index c222fc8..fac695e 100644
--- a/PD-classes/src/com/watabou/noosa/Game.java
+++ b/PD-classes/src/com/watabou/noosa/Game.java
@@ -34,7 +34,7 @@
 import java.io.InputStream;
 import java.io.OutputStream;
 
-public class Game implements ApplicationListener {
+public abstract class Game implements ApplicationListener {
 
 	public static Game instance;
 	
@@ -71,7 +71,7 @@ public Game( Class<? extends Scene> c, String basePath ) {
 		sceneClass = c;
 		this.basePath = basePath;
 	}
-	
+
 	@Override
 	public void create() {
 		instance = this;
@@ -91,13 +91,6 @@ public void onSignal( PDInputProcessor.Key key ) {
 			}
 		} );
 
-		// FIXME
-//		try {
-//			version = getPackageManager().getPackageInfo( getPackageName(), 0 ).versionName;
-//		} catch (NameNotFoundException e) {
-			version = "???";
-//		}
-
 		// TODO: Is this right?
 		onSurfaceCreated();
 	}
diff --git a/android/build.gradle b/android/build.gradle
index 486c225..595a5aa 100644
--- a/android/build.gradle
+++ b/android/build.gradle
@@ -1,6 +1,11 @@
 android {
     buildToolsVersion "20.0.0"
     compileSdkVersion 19
+	defaultConfig {
+//		applicationId "com.watabou.pixeldungeon"
+		versionCode versionCode
+		versionName version
+	}
     sourceSets {
         main {
             manifest.srcFile 'AndroidManifest.xml'
diff --git a/android/src/com/watabou/pd/android/AndroidLauncher.java b/android/src/com/watabou/pd/android/AndroidLauncher.java
index 3ec584f..0a12b55 100644
--- a/android/src/com/watabou/pd/android/AndroidLauncher.java
+++ b/android/src/com/watabou/pd/android/AndroidLauncher.java
@@ -5,11 +5,19 @@
 import com.badlogic.gdx.backends.android.AndroidApplicationConfiguration;
 import com.watabou.pixeldungeon.PixelDungeon;
 
+import javax.naming.NameNotFoundException;
+
 public class AndroidLauncher extends AndroidApplication {
 	@Override
 	protected void onCreate (Bundle savedInstanceState) {
 		super.onCreate(savedInstanceState);
 		AndroidApplicationConfiguration config = new AndroidApplicationConfiguration();
-		initialize(new PixelDungeon(null), config);
+		String version;
+		try {
+			version = getPackageManager().getPackageInfo( getPackageName(), 0 ).versionName;
+		} catch (NameNotFoundException e) {
+			version = "???";
+		}
+		initialize(new PixelDungeon(null, version), config);
 	}
 }
diff --git a/build.gradle b/build.gradle
index 6120dc9..9c03d26 100644
--- a/build.gradle
+++ b/build.gradle
@@ -15,9 +15,10 @@ allprojects {
     apply plugin: "eclipse"
     apply plugin: "idea"
 
-    version = '1.0'
+    version = '1.7.1c'
     ext {
-        appName = 'pixel-dungeon-gdx'
+        versionCode = 59
+        appName = 'pixel-dungeon'
         gdxVersion = '1.3.1'
         roboVMVersion = '0.0.14'
     }
diff --git a/core/src/com/watabou/pixeldungeon/PixelDungeon.java b/core/src/com/watabou/pixeldungeon/PixelDungeon.java
index fd576f8..0414fe8 100644
--- a/core/src/com/watabou/pixeldungeon/PixelDungeon.java
+++ b/core/src/com/watabou/pixeldungeon/PixelDungeon.java
@@ -26,9 +26,11 @@
 
 public class PixelDungeon extends Game {
 
-	public PixelDungeon(String preferencesDirectory) {
+	public PixelDungeon(String preferencesDirectory, String version) {
 		super( TitleScene.class, preferencesDirectory );
 
+		this.version = version;
+
 		com.watabou.utils.Bundle.addAlias(
 			com.watabou.pixeldungeon.items.scrolls.ScrollOfUpgrade.class, 
 			"com.watabou.pixeldungeon.items.scrolls.ScrollOfEnhancement" );
diff --git a/desktop/build.gradle b/desktop/build.gradle
index dbf528a..7bfc792 100644
--- a/desktop/build.gradle
+++ b/desktop/build.gradle
@@ -22,6 +22,8 @@ task dist(type: Jar) {
  
     manifest {
         attributes 'Main-Class': project.mainClassName
+        attributes 'Specification-Version': version
+        attributes 'Implementation-Version': versionCode
     }
 }
 
diff --git a/desktop/src/com/watabou/pd/desktop/DesktopLauncher.java b/desktop/src/com/watabou/pd/desktop/DesktopLauncher.java
index 8061bee..f29415d 100644
--- a/desktop/src/com/watabou/pd/desktop/DesktopLauncher.java
+++ b/desktop/src/com/watabou/pd/desktop/DesktopLauncher.java
@@ -9,6 +9,10 @@
 
 public class DesktopLauncher {
 	public static void main (String[] arg) {
+		String version = DesktopLauncher.class.getPackage().getSpecificationVersion();
+		if (version == null) {
+			version = "???";
+		}
 		LwjglApplicationConfiguration config = new LwjglApplicationConfiguration();
 
 		if (SharedLibraryLoader.isMac) {
@@ -28,6 +32,6 @@ public static void main (String[] arg) {
 			config.height = prefs.getInteger(Preferences.KEY_WINDOW_HEIGHT, Preferences.DEFAULT_WINDOW_HEIGHT);
 		}
 
-		new LwjglApplication(new PixelDungeon(config.preferencesDirectory), config);
+		new LwjglApplication(new PixelDungeon(config.preferencesDirectory, version), config);
 	}
 }
diff --git a/html/src/com/watabou/pixeldungeon/client/HtmlLauncher.java b/html/src/com/watabou/pixeldungeon/client/HtmlLauncher.java
index 6719762..508da6f 100644
--- a/html/src/com/watabou/pixeldungeon/client/HtmlLauncher.java
+++ b/html/src/com/watabou/pixeldungeon/client/HtmlLauncher.java
@@ -14,6 +14,7 @@ public GwtApplicationConfiguration getConfig () {
 
         @Override
         public ApplicationListener getApplicationListener () {
-                return new PixelDungeon(null);
+	        String version = "???";
+                return new PixelDungeon(null, version);
         }
 }
\ No newline at end of file
diff --git a/ios/src/com/watabou/pd/IOSLauncher.java b/ios/src/com/watabou/pd/IOSLauncher.java
index 0fca033..7143e73 100644
--- a/ios/src/com/watabou/pd/IOSLauncher.java
+++ b/ios/src/com/watabou/pd/IOSLauncher.java
@@ -10,7 +10,8 @@
     @Override
     protected IOSApplication createApplication() {
         IOSApplicationConfiguration config = new IOSApplicationConfiguration();
-        return new IOSApplication(new PixelDungeon(null), config);
+	    String version = "???";
+        return new IOSApplication(new PixelDungeon(null, version), config);
     }
 
     public static void main(String[] argv) {

From 9c255981925be7e58945707c3c30af10e59e0dad Mon Sep 17 00:00:00 2001
From: Edu Garcia <arcnorj@gmail.com>
Date: Sat, 6 Sep 2014 11:26:25 +1000
Subject: [PATCH 2/3] #16: Added proper versions on iOS (although the version
 added to the plist is wrong right now)

---
 ios/src/com/watabou/pd/IOSLauncher.java | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/ios/src/com/watabou/pd/IOSLauncher.java b/ios/src/com/watabou/pd/IOSLauncher.java
index 7143e73..ef226b3 100644
--- a/ios/src/com/watabou/pd/IOSLauncher.java
+++ b/ios/src/com/watabou/pd/IOSLauncher.java
@@ -4,13 +4,15 @@
 import com.badlogic.gdx.backends.iosrobovm.IOSApplicationConfiguration;
 import com.watabou.pixeldungeon.PixelDungeon;
 import org.robovm.apple.foundation.NSAutoreleasePool;
+import org.robovm.apple.foundation.NSBundle;
+import org.robovm.apple.foundation.NSObject;
 import org.robovm.apple.uikit.UIApplication;
 
 public class IOSLauncher extends IOSApplication.Delegate {
     @Override
     protected IOSApplication createApplication() {
         IOSApplicationConfiguration config = new IOSApplicationConfiguration();
-	    String version = "???";
+	    final String version = NSBundle.getMainBundle().getInfoDictionaryObject("CFBundleShortVersionString").toString();
         return new IOSApplication(new PixelDungeon(null, version), config);
     }
 

From 4c4167d2ddd37bfb468f43c969c8e9ddcdcd9230 Mon Sep 17 00:00:00 2001
From: Edu Garcia <arcnorj@gmail.com>
Date: Sat, 6 Sep 2014 12:35:42 +1000
Subject: [PATCH 3/3] #16: RoboVM properties are now autogenerated from the
 Gradle ones

---
 .gitignore            |  3 +++
 android/build.gradle  |  2 +-
 build.gradle          |  2 ++
 ios/build.gradle      | 16 ++++++++++++++--
 ios/robovm.properties |  8 +++++---
 5 files changed, 25 insertions(+), 6 deletions(-)

diff --git a/.gitignore b/.gitignore
index 2668f00..f95bccf 100644
--- a/.gitignore
+++ b/.gitignore
@@ -61,3 +61,6 @@ build/
 
 ## OS Specific
 .DS_Store
+
+## RoboVM
+ios/robovm.properties
diff --git a/android/build.gradle b/android/build.gradle
index 595a5aa..88ef2c9 100644
--- a/android/build.gradle
+++ b/android/build.gradle
@@ -2,7 +2,7 @@ android {
     buildToolsVersion "20.0.0"
     compileSdkVersion 19
 	defaultConfig {
-//		applicationId "com.watabou.pixeldungeon"
+		applicationId appId
 		versionCode versionCode
 		versionName version
 	}
diff --git a/build.gradle b/build.gradle
index 9c03d26..19eb325 100644
--- a/build.gradle
+++ b/build.gradle
@@ -19,6 +19,8 @@ allprojects {
     ext {
         versionCode = 59
         appName = 'pixel-dungeon'
+	    appTitle = 'Pixel Dungeon'
+	    appId = 'com.watabou.pixeldungeon'
         gdxVersion = '1.3.1'
         roboVMVersion = '0.0.14'
     }
diff --git a/ios/build.gradle b/ios/build.gradle
index 246ec72..634fe60 100644
--- a/ios/build.gradle
+++ b/ios/build.gradle
@@ -5,6 +5,7 @@ sourceCompatibility = '1.7'
 
 ext {
 	mainClassName = "com.watabou.pd.IOSLauncher"
+	mainExecutable = "IOSLauncher"
 }
 
 // Extracts native libs (*.a) from the native-ios.jar and places them
@@ -49,9 +50,20 @@ task updateRoboVMXML << {
   printer.print(config)
 }
 
+task updateRoboVMProps << {
+	ant.propertyfile(file: 'robovm.properties') {
+		entry (key: 'app.version', value: version)
+		entry (key: 'app.build', value: versionCode)
+		entry (key: 'app.name', value: appTitle)
+		entry (key: 'app.id', value: appId)
+		entry (key: 'app.mainclass', value: mainClassName)
+		entry (key: 'app.executable', value: mainExecutable)
+	}
+}
+
 updateRoboVMXML.dependsOn copyNatives
-build.dependsOn updateRoboVMXML
-tasks.eclipse.dependsOn updateRoboVMXML
+build.dependsOn updateRoboVMXML, updateRoboVMProps
+tasks.eclipse.dependsOn updateRoboVMXML, updateRoboVMProps
 
 launchIPhoneSimulator.dependsOn build
 launchIPadSimulator.dependsOn build
diff --git a/ios/robovm.properties b/ios/robovm.properties
index c48942c..5275d10 100644
--- a/ios/robovm.properties
+++ b/ios/robovm.properties
@@ -1,6 +1,8 @@
-app.version=1.0
+#Sat, 06 Sep 2014 12:33:01 +1000
+
+app.version=1.7.1c
+app.build=59
+app.name=Pixel Dungeon
 app.id=com.watabou.pixeldungeon
 app.mainclass=com.watabou.pd.IOSLauncher
 app.executable=IOSLauncher
-app.build=1
-app.name=Pixel Dungeon

# Maintainer: Artefact2 <artefact2@gmail.com>
# Contributor: Lauri Niskanen <ape@ape3000.com>
# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Stefan Lohmaier <noneuss at gmail dot com>
# Contributor: ZipFile <lin.aaa.lin@gmail.com>

pkgname=stepmania
pkgver=5_preview4
pkgrel=2
pkgdesc="A free dance and rhythm game (was previously sm-ssc)"
url="http://www.stepmania.com/"
license="MIT"
arch=(i686 x86_64)
depends=('gtk2' 'libmad' 'mesa' 'glew' 'ffmpeg' 'libpng')
replaces=('sm-ssc')
makedepends=('pkgconfig' 'mercurial')
install='stepmania.install'
source=(stepmania.sh stepmania.install 22_all_ffmpeg_fix.patch 23_all_ffmpeg_fix2.patch cut2.patch cut.patch notify.patch)
sha512sums=(
f8be7c68e2122424246216dc43bd8c8c1313d1401c3e5fa3b294a18bac6cb83843efd5a133f027abd93cd426ee185bb094efcc90daa6a963b56538e4d9dc097a
b710a927dd3a5b96f92ba9f8c4f56e107733ec6e3cbd1b5ea37b69df416f32c48ee13ec1b0b0ecef65f1ce53e5e0175cd9b0e724e64378a2ccb0a2ae3838bbec
590ed30f2df92e932f7631344547ef0dc0cb402d6929d5dd1d26880a834b96525221cce79b5511557d99404678ecbb19fb2d90ce9a1748295fdf2b03e24937d2
22bea7bc8bbf9d9bf495b98435a9961b3f3596ed5afaa3f8e2fed02a002b961591da857ffb8a6505949cfe5323b127f108f5322880a30b1f7a50e7cf1d928767
9d8deabd51659f96a645d6aa46f7086f004de968525470fcd4a4be15d141400d640d98790e8115cd1d90f12be7e00711451ca14745c9a82aab613ec0628b401d
5d8bb5dcc404efe40d604838c3156134b8ed5ba7e2127928c5fe72b5a23559296a8781289defc987f2188482d5271a7f38b5b1e8b7a6d4a19d970efc5b83664c
ae10a78b7bdddf44fa8a7bcdef3b15100046cf5edacbb475b59d3cf58762f1f812bd96730c633177623c59f64a100bc382d39fa0008c45ee8472ed0e4d0283da
)

_mercurial_repo=https://sm-ssc.googlecode.com/hg/
_dir=sm-ssc
_realver="SM5-Preview4"

build() {
    cd $srcdir
	
	if [ -d $_dir/.hg ]; then
		msg "Updating the preexisting Mercurial repository..."
		cd $_dir
		hg pull
	else
		msg "Cloning the Mercurial repository (this may take a while)..."
		hg clone $_mercurial_repo $_dir
		cd $_dir
	fi

	hg update -C $_realver
    msg "Starting make..."

	patch -p1 < $srcdir/notify.patch || return 1
	#patch -p1 < $srcdir/archlinux.patch
	patch -p1 < $srcdir/22_all_ffmpeg_fix.patch
	patch -p1 < $srcdir/23_all_ffmpeg_fix2.patch
        patch -p1 < $srcdir/cut.patch
        patch -p1 < $srcdir/cut2.patch

    sh ./autogen.sh || return 1
#	sh ./Utils/build.sh -f || return 1
	sh ./Utils/build.sh -c  --verbose --verbose || return 1
	sed -i -e 's/ -lrt/ -lbz2 -lrt/g' _build/src/Makefile _build/Makefile
    sh ./Utils/build.sh --verbose --verbose || return 1
    mkdir -p $pkgdir/opt/$pkgname Songs RandomMovies Packages
    cp _build/src/{stepmania,GtkModule.so} $pkgdir/opt/$pkgname

    install -D -m755 $srcdir/$pkgname.sh $pkgdir/usr/bin/$pkgname
	install -D -m644 $srcdir/$_dir/Docs/Licenses.txt $pkgdir/usr/share/licenses/$pkgname/Licenses.txt

	folders=`echo {Announcers,BackgroundEffects,BackgroundTransitions,BGAnimations,Characters,Courses,Data,Docs,NoteSkins,Packages,RandomMovies,Songs,Themes}`

    cp -r $folders $pkgdir/opt/$pkgname
	touch $pkgdir/opt/$pkgname/Data/SpeedMods.txt 
	chown -R root:games $pkgdir/opt/$pkgname
	cd $pkgdir/opt/$pkgname
	chmod 2775 . $folders
}

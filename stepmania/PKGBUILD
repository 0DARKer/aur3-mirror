# Maintainer: Artefact2 <artefact2@gmail.com>
# Contributor: Lauri Niskanen <ape@ape3000.com>
# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Stefan Lohmaier <noneuss at gmail dot com>
# Contributor: ZipFile <lin.aaa.lin@gmail.com>

pkgname=stepmania
pkgver=5_alpha3
pkgrel=1
pkgdesc="A free dance and rhythm game (was previously sm-ssc)"
url="http://www.stepmania.com/"
license="MIT"
arch=(i686 x86_64)
depends=('gtk2' 'libmad' 'mesa' 'glew' 'ffmpeg' 'libpng')
replaces=('sm-ssc')
makedepends=('pkgconfig' 'mercurial')
install='stepmania.install'
source=(stepmania.sh stepmania.install)
sha512sums=('e066ac27932e795078a3a9b1073f280f10f140b2dd776f12efdc469d327d13c2fccdc87f823a32d91c9896b5ea1e98fca404cfadcf55c97ea22a179e5ca21412'
            '71ea7b4b8684edd19ebff5473e23597fc391465bc33018337ada945df5e45b53961fbf66c0b49275b256b631ac692b04b9d2152ca80066373fffc16d073cba8b')

_mercurial_repo=https://sm-ssc.googlecode.com/hg/
_dir=sm-ssc
_realver="SM5-alpha3"

build() {
    cd $srcdir
	
	if [ -d $_dir/.hg ]; then
		msg "Updating the preexisting Mercurial repository..."
		cd $_dir
		hg pull
	else
		msg "Cloning the Mercurial repository (this may take a while)..."
		hg clone $_mercurial_repo $_dir
		cd $_dir
	fi

	hg update -C $_realver

	msg "Starting make..."
	sh ./autogen.sh || return 1
	sh ./Utils/build.sh -vr || return 1

	mkdir -p $pkgdir/usr/share/ $pkgdir/opt/$pkgname Songs RandomMovies Packages
	cp _build/src/{stepmania,GtkModule.so} $pkgdir/opt/$pkgname
	cp -r icons $pkgdir/usr/share/

	install -D -m755 $srcdir/$pkgname.sh $pkgdir/usr/bin/$pkgname
	install -D -m755 $pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
	install -D -m644 $srcdir/$_dir/Docs/Licenses.txt $pkgdir/usr/share/licenses/$pkgname/Licenses.txt

	folders=`echo {Announcers,BackgroundEffects,BackgroundTransitions,BGAnimations,Characters,Courses,Data,Docs,NoteSkins,Packages,RandomMovies,Songs,Themes}`

	cp -r $folders $pkgdir/opt/$pkgname
	chown -R root:games $pkgdir/opt/$pkgname
	cd $pkgdir/opt/$pkgname
	chmod 2775 . $folders
}

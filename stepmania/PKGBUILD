# Maintainer: Artefact2 <artefact2@gmail.com>
# Contributor: Lauri Niskanen <ape@ape3000.com>
# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Stefan Lohmaier <noneuss at gmail dot com>

pkgname=stepmania
pkgver=5_preview1a
pkgrel=2
pkgdesc="A free dance and rhythm game (was previously sm-ssc)"
url="http://www.stepmania.com/"
license="MIT"
arch=(i686 x86_64)
depends=('gtk2' 'libmad' 'mesa' 'glew' 'ffmpeg' 'libpng')
replaces=('sm-ssc')
makedepends=('pkgconfig' 'mercurial')
install='stepmania.install'
source=(stepmania.sh stepmania.install archlinux.patch)
sha512sums=(
f8be7c68e2122424246216dc43bd8c8c1313d1401c3e5fa3b294a18bac6cb83843efd5a133f027abd93cd426ee185bb094efcc90daa6a963b56538e4d9dc097a
cd948b2f580d73780e069965d7806223b1902dbe387bb0c0317480c9d4a09fb8021cc04d02f29f5d5ff2b4df1e430629df262f33877af85e33fdc940a3a7c406
dd77bf1f35946ca97740473f5a0b074030076bb02aca945570b3aee4bffcef9fedcc41f8a6ac409f4ac8c6a45de80236616f099bac6127c18aabf4a54c3b7bd6
)

_mercurial_repo=https://sm-ssc.googlecode.com/hg/
_dir=sm-ssc
_realver="vSM5-Preview1a"

build() {
    cd $srcdir
	
	if [ -d $_dir/.hg ]; then
		msg "Updating the preexisting Mercurial repository..."
		cd $_dir
		hg pull
	else
		msg "Cloning the Mercurial repository (this may take a while)..."
		hg clone $_mercurial_repo $_dir
		cd $_dir
	fi

	hg update -C $_realver
    msg "Starting make..."

	patch -p1 < $srcdir/archlinux.patch

    sh ./autogen.sh || return 1
	sh ./Utils/build.sh -f || return 1
	sh ./Utils/build.sh -c || return 1
	sed -i -e 's/ -lrt/ -lbz2 -lrt/g' _build/src/Makefile _build/Makefile
    sh ./Utils/build.sh --verbose --verbose || return 1
    mkdir -p $pkgdir/opt/$pkgname Songs RandomMovies Packages
    cp _build/src/{stepmania,GtkModule.so} $pkgdir/opt/$pkgname

    install -D -m755 $srcdir/$pkgname.sh $pkgdir/usr/bin/$pkgname
	install -D -m644 $srcdir/$_dir/Docs/Licenses.txt $pkgdir/usr/share/licenses/$pkgname/Licenses.txt

	folders=`echo {Announcers,BackgroundEffects,BackgroundTransitions,BGAnimations,CDTitles,Characters,Courses,Data,Docs,NoteSkins,Packages,RandomMovies,Songs,Themes}`

    cp -r $folders $pkgdir/opt/$pkgname
	chown -R root:games $pkgdir/opt/$pkgname
	cd $pkgdir/opt/$pkgname
	chmod 2775 . $folders
}

# Contributor: Lukas Jirkovsky <l.jirkovsky@gmail.com>
# Contributor: XercesBlue (nullfied)
# Contributor: Mikael Eriksson (miffe)
# Contributor: N30N <archlinux@alunamation.com>

pkgname="blender-cycles-svn"
pkgver=37798
pkgrel=1
arch=("i686" "x86_64")
url="http://blender.org/"
depends=("desktop-file-utils" "hicolor-icon-theme" "mesa" "python" "libxi" \
	"libtiff" "libpng" "openexr" "freetype2" "ffmpeg" "fftw" "libsndfile")
makedepends=("subversion" "cmake" "sdl" "openal" "jack")
optdepends=("sdl: as your audio backend" "openal: as your audio backend" \
	"jack: as your audio backend")
provides=("blender")
conflicts=("blender")
license=("GPL2")
install="blender.install"

case "${pkgname}" in
	"blender-svn")
		pkgdesc="SVN version of Blender"
		_svnmod="trunk"
		_svntrunk="https://svn.blender.org/svnroot/bf-blender/trunk/blender"
		;;
	"blender-nurbs-svn")
		_svnmod="nurbs"
		;;
	"blender-bmesh-svn")
		_svnmod="bmesh"
		;;
	"blender-freestyle-svn")
		_svnmod="soc-2008-mxcurioni"
		;;
	"blender-cycles-svn")
		unset provides # Due to lack of blenderplayer
		depends=("${depends[@]}" "openimageio-git")
		makedepends=("${makedepends[@]}" "cuda-toolkit>=4")
		optdepends=("${optdepends[@]}" "cuda-toolkit: for GPU rendering")
		options=("!strip")
		_svnmod="cycles"
		;;
esac

if [ -z "${_svntrunk}" ]; then
	pkgdesc="${_svnmod} SVN branch of Blender"
	_svntrunk="https://svn.blender.org/svnroot/bf-blender/branches/${_svnmod}"
fi

build() {
	msg "Connecting to SVN server..."
	if [ -d "${_svnmod}/.svn" ]; then
		(cd "${_svnmod}" && svn up -r "${pkgver}")
	else
		svn co "${_svntrunk}" --config-dir ./ -r "${pkgver}" "${_svnmod}"
	fi
	msg "SVN checkout done or server timeout"

	[ -d build ] && rm -rf build
	mkdir -p build
	cd build

	if [ "${CC-gcc}" = "gcc" ]; then
		export \
			CFLAGS="${CFLAGS} -ffast-math" \
			CXXFLAGS="${CXXFLAGS} -ffast-math"
	fi

	cmake \
		-DCMAKE_VERBOSE_MAKEFILE=1 \
		-DCMAKE_INSTALL_PREFIX="/usr" \
		-DPYTHON_VERSION="$(python3 -V 2>&1 | sed -r "s/^.+\s(3\.[0-9]).*$/\1/")" \
		-DWITH_PYTHON_INSTALL=0 \
		-DWITH_INSTALL_PORTABLE=0 \
		-DWITH_PLAYER=$([ "${pkgname}" != "blender-cycles-svn" ]; echo ${?}) \
		-DWITH_CODEC_FFMPEG=1 \
		-DWITH_FFTW3=1 \
		-DWITH_JACK=1 \
		-DWITH_CODEC_SNDFILE=1 \
		-DWITH_OPENCOLLADA=0 \
		-DWITH_MEM_JEMALLOC=0 \
		-DWITH_CYCLES_CUDA=1 \
		-DCYCLES_CUDA="/usr" \
		-DCUDA_INCLUDES="/usr/include/cuda" \
		../${_svnmod}

	if [ "${pkgname}" = "blender-cycles-svn" ]; then
		mkdir -p include/cuda
		sed "80,84 d" "/usr/include/cuda/host_config.h" > include/host_config.h
		cp /usr/include/cuda/cuda_runtime.h include
		export \
			CPLUS_INCLUDE_PATH="$(pwd)/include:/usr/include/cuda" \
			C_INCLUDE_PATH="$(pwd)/include:/usr/include/cuda"

		sed -r "s|(DESTINATION \")$(pwd)|\1/usr|" \
			-i source/creator/cmake_install.cmake

		msg "Getting and applying ffmpeg fix from trunk."
		svn diff -r 37744:37745 "https://svn.blender.org/svnroot/bf-blender/trunk/blender" | \
			patch -d "${srcdir}/${_svnmod}" -N -p0 || true
	fi

	make
	make DESTDIR="${pkgdir}" install
}

# vim: set noet ff=unix:

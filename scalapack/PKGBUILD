# Maintainer: Michele Mocciola <mickele>
pkgname=scalapack
pkgver=1.8.0
pkgrel=2
pkgdesc="ScaLAPACK (or Scalable LAPACK) library includes a subset of LAPACK routines redesigned for distributed memory MIMD parallel computers."
url="http://www.netlib.org/scalapack/"
license='custom'
depends=('glibc' 'mpich2' 'blacs-mpi' 'atlas-lapack')
makedepends=('gcc' 'coreutils' 'sed' 'binutils')
provides=()
conflicts=()
replaces=()
backup=()
arch=('i686' 'x86_64')
install=${pkgname}.install
source=(http://www.netlib.org/scalapack/$pkgname.tgz http://www.netlib.org/scalapack/manpages.tgz LICENSE Makefile example1.f)

build() {
  export PATH=$PATH:/opt/mpich2/bin

  cd ${srcdir}/${pkgname}-${pkgver} || return 1
  sed -e "s|\$(HOME)/SCALAPACK|$PWD|" \
      -e "s|BLACSdir      = /usr/local/lib|BLACSdir      = /usr/lib |" \
      -e "s|SMPLIB        = /usr/local/mpich-1.2.1/lib/libmpich.a|SMPLIB        = -Wl,-rpath,/opt/mpich2/lib -L/opt/mpich2/lib -lmpich -lssl -luuid -lpthread -lrt -ldl -lnsl -lrt|" \
      -e "s|BLACSFINIT    = \$(BLACSdir)/libmpiblacsF77init-p4.a|BLACSFINIT    = -L/usr/lib -lblacsf77|" \
      -e "s|BLACSCINIT    = \$(BLACSdir)/libmpiblacsCinit-p4.a|BLACSCINIT    = -L/usr/lib -lblacsc|" \
      -e "s|BLACSLIB      = \$(BLACSdir)/libmpiblacs-p4.a|BLACSLIB      = -L/usr/lib -lblacs|" \
      -e "s|F77FLAGS      =  -O3 \$(NOOPT)|F77FLAGS =  -Wno-unused-variable $CFLAGS \$(NOOPT) -fpic|" \
      -e "s|CCFLAGS       = -O4|CCFLAGS = $CFLAGS  -Wwrite-strings -Wno-strict-aliasing -fpic|" \
      -e "s|F77LOADFLAGS  =|F77LOADFLAGS  = \$(F77FLAGS)|" \
      -e "s|CCLOADFLAGS   =|CCLOADFLAGS   = \$(CCFLAGS)|" \
      -e "s|CDEFS         = -Df77IsF2C -DNO_IEEE \$(USEMPI)|CDEFS         = -DAdd_ -DNO_IEEE \$(USEMPI)|" \
      -e "s|BLASLIB       = /usr/local/lib/libf77blas.a /usr/local/lib/libatlas.a|BLASLIB       = -lblas -latlas|" \
      -e "s|LAPACKLIB     = /usr/local/lib/liblapack.a|LAPACKLIB     = -llapack -lcblas|" \
      < SLmake.inc.example > SLmake.inc

  # Builds library, test and example
  make lib || return 1
  ld -Bshareable -o  ${srcdir}/${pkgname}-${pkgver}/lib${pkgname}.so -x -soname lib${pkgname}.so --whole-archive $startdir/src/${pkgname}-${pkgver}/lib${pkgname}.a || return 1
  make exe || return 1
  make example || return 1
}

package(){
  cd ${srcdir}/${pkgname}-${pkgver} || return 1

  # Install headers
  install -m 755 -d ${pkgdir}/usr/include || return 1
  install -m 644 -D ${srcdir}/$pkgname-$pkgver/PBLAS/SRC/*.h ${pkgdir}/usr/include || return 1

  # Install libraries
  install -m 644 -D ${srcdir}/$pkgname-$pkgver/lib$pkgname.a ${pkgdir}/usr/lib/lib$pkgname.a || return 1
  install -m 755 ${srcdir}/$pkgname-$pkgver/lib$pkgname.so ${pkgdir}/usr/lib || return 1

  # Install man pages
  install -m 755 -d ${pkgdir}/usr/share/man/manl || return 1
  install -m 644 ${srcdir}/MANPAGES/man/manl/*.l ${PREFIX} ${pkgdir}/usr/share/man/manl || return 1

  # Install test
  install -m 755 -d ${pkgdir}/usr/share/$pkgname/testing || return 1
  install -m 755 ${srcdir}/$pkgname-$pkgver/TESTING/x* ${pkgdir}/usr/share/$pkgname/testing || return 1
  install -m 644 ${srcdir}/$pkgname-$pkgver/TESTING/*.dat ${pkgdir}/usr/share/$pkgname/testing || return 1

  # Install examples
  install -m 755 -d ${pkgdir}/usr/share/$pkgname/examples || return 1
  install -m 644 ${srcdir}/Makefile ${pkgdir}/usr/share/$pkgname/examples || return 1
  install -m 644 ${srcdir}/example1.f ${pkgdir}/usr/share/$pkgname/examples || return 1

  # Install license
  install -m 644 -D ${srcdir}/LICENSE ${pkgdir}/usr/share/licenses/$pkgname/LICENSE || return 1
}
md5sums=('f4a3f3d7ef32029bd79ab8abcc026624'
         'a536ab4837ec68addff0a3ec99427a10'
         '182bf79471c020e8274fec5ef1240005'
         '0bef36150ffaf341a6228b474ed800c9'
         '4723ad431356431bb193db254b6ee0fb')

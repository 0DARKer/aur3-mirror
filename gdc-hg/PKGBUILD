# Maintainer: Kenji Takahashi <wozniakk@gmail.com>

pkgname=gdc-hg
pkgver=302
_gccver=4.4.5
pkgrel=2
pkgdesc="gdc, D frontend for gcc, reloaded. Built against D2"
arch=('x86' 'x86_64')
url="http://www.bitbucket.org/goshawk/gdc"
license=('GPL')
groups=()
depends=()
makedepends=('mercurial' 'patch' 'make')
provides=('gdc')
conflicts=('gdc')
replaces=()
backup=()
options=()
install=
source=(ftp://gcc.gnu.org/pub/gcc/releases/gcc-$_gccver/gcc-core-$_gccver.tar.bz2
        gdc.sh)
noextract=()
md5sums=('91dca20de8d312e02e2269bee24db0e2'
        '48aa8f00eb0c344cc841d5551dc065dd')

_hgroot="http://bitbucket.org/goshawk"
_hgrepo="gdc"

build() {
  cd "$srcdir"
  msg "Connecting to Mercurial server...."

  if [ -d $_hgrepo ] ; then
    cd $_hgrepo
    hg pull -u || return 1
    msg "The local files are updated."
  else
    hg clone $_hgroot $_hgrepo || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_hgrepo-build"
  cp -r "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"

  mkdir "dev"
  mv "$srcdir/gcc-$_gccver/" "dev/"
  cd "dev/gcc-$_gccver"

  ln -s "../../../d" "gcc/d"
  ./gcc/d/setup-gcc.sh -v2
  mkdir "objdir"
  cd "objdir"
  ../configure --prefix=/usr --enable-languages=d --disable-multilib --disable-shared
  make || return 1
  mkdir $pkgdir/opt
  DESTDIR=$pkgdir/opt make install
  install -Dm755 "$srcdir/gdc.sh" "$pkgdir/etc/profile.d/gdc.sh"
} 

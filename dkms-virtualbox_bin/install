post_install() {
    # Add vboxusers group, GID 108 is reserved (http://wiki.archlinux.org/index.php/UID_and_GID_list),
    getent group vboxusers >> /dev/null || groupadd -f -g 108 vboxusers

    # Load new udev rule for module vboxdrv
    udevadm control --reload-rules

    # Update mime database
    [ -x usr/bin/update-mime-database ] && update-mime-database /usr/share/mime &>/dev/null
  
    DKMS=`which dkms 2>/dev/null`
    echo ">>> DKMS Module add, build, and install "
    $DKMS add  -m vboxhost  -v 4.0.6
    $DKMS build -m vboxhost -v 4.0.6
    $DKMS install -m vboxhost -v 4.0.6
  
    # Show warnings
    /bin/cat <<EOF

==> Remember to add user the vboxusers group:
==> # gpasswd -a USERNAME vboxusers
==>
==> To load virtualbox modules automatically you can add vboxdrv in your DAEMONS
==> To start virtualbox web service automatically you can add vboxweb in your DAEMONS
EOF

}

pre_upgrade() {
    pre_remove 

    # Remove any stuff remaining from the module compilation
    rm -Rf "/opt/VirtualBox"
}

post_upgrade() {
    post_install
}

pre_remove() {

    # Stop running services
    [[ -x /etc/rc.d/vboxdrv ]] && /etc/rc.d/vboxdrv stop
    [[ -x /etc/rc.d/vboxweb ]] && /etc/rc.d/vboxweb stop

    DKMS=`which dkms 2>/dev/null`
    echo ">>> DKMS Module remove "
    for m in vboxhost vboxdrv vboxnetflt vboxnetadp
    do
      $DKMS status -m $m | while read line
      do
	      if  echo "$line" | grep -q added > /dev/null ||
	          echo "$line" | grep -q built > /dev/null ||
	          echo "$line" | grep -q installed > /dev/null; then
		        version=`echo "$line" | sed "s/$m,\([^,]*\)[,:].*/\1/;t;d"`
		    echo ">>> >> Removing old DKMS module $m version $version"
		    $DKMS remove -m $m -v $version --all
	      fi
      done
    done

    status=`$DKMS status -m vboxhost -v 4.0.6`
    if  echo $status | grep added > /dev/null ||
        echo $status | grep built > /dev/null ||
        echo $status | grep installed > /dev/null
    then
        $DKMS remove -m vboxhost -v 4.0.6 --all
    fi
}

post_remove() {
    # Remove any stuff remaining from the module compilation
    rm -Rf "/opt/VirtualBox"
  
    # Remove any run files
    rm -Rf "/var/run/VirtualBox"

    # Update mime database
    [ -x usr/bin/update-mime-database ] && update-mime-database /usr/share/mime &>/dev/null

    # remove vboxusers group
    groupdel vboxusers &>/dev/null || true
}


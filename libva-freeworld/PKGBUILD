# vim:set ts=2 sw=2 et:
pkgname=libva-freeworld
_origname=libva
_newver=1.0.1
pkgver=0.31.1
pkgrel=5
pkgdesc="Video Acceleration (VA) API for Linux (patched version for using with xpsb-glx)"
arch=('i686' 'x86_64')
url="http://www.splitted-desktop.com/~gbeauchesne/libva/"
license=('MIT')
depends=('libgl' 'libdrm' 'libxfixes')
makedepends=('mesa')
optdepends=('vdpau-video: VDPAU backend for VA API' 'xpsb-glx: VA API for GMA500')
options=('!libtool')
conflicts=('libva')
# dirty fix for conflict with ffmpeg
provides=('libva', 'libva=1.0.4')
replaces=('libva')
_fullname=${_origname}_${_newver}-3+${pkgver}
source=("http://ppa.launchpad.net/gma500/ppa/ubuntu/pool/main/libv/libva/${_fullname}-1+sds4.tar.gz")
noextract=()

build() {
  cd ${srcdir}/${_origname}-${pkgver}

  for p in debian/patches/*.patch; do patch -p1 < $p; done

  autoreconf -i
  ./configure --disable-static --prefix=/usr  \
    --enable-glx
  make
}

package() {
  cd ${srcdir}/${_origname}-${pkgver}
  make DESTDIR="${pkgdir}" install
  install -m644 -D COPYING ${pkgdir}/usr/share/licenses/${pkgname}/COPYING

  # compatibility workarounds
  echo ".text"|gcc -xassembler - -o ${pkgdir}/usr/lib/libva.so.0.29 -shared -Wl,-soname,libva.so.0 -L${pkgdir}/usr/lib -lva-compat
  echo ".text"|gcc -xassembler - -o ${pkgdir}/usr/lib/libva.so.${_newver} -shared -Wl,-soname,libva.so.1 -L${pkgdir}/usr/lib -lva-x11
  echo ".text"|gcc -xassembler - -o ${pkgdir}/usr/lib/libva-x11.so.${_newver} -shared -Wl,-soname,libva-x11.so.1 -L${pkgdir}/usr/lib -lva-x11
  echo ".text"|gcc -xassembler - -o ${pkgdir}/usr/lib/libva-glx.so.${_newver} -shared -Wl,-soname,libva-glx.so.1 -L${pkgdir}/usr/lib -lva-glx
  ldconfig -n ${pkgdir}/usr/lib
}

md5sums=('3df0dc81c76dc0231fcef860a71d4970')

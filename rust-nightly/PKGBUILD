# Contributor: Isak Karlsson <isak.karlsson@gmail.com>
# Maintainer: Stefan Husmann <stefan-husmann@t-online.de>

pkgname=rust-nightly
pkgver=1.0.0.13.0_2015.01.29
pkgrel=1
arch=('i686' 'x86_64')
pkgdesc='A safe, concurrent, practical language'
url='http://www.rust-lang.org/'
license=('MIT' 'Apache')
depends=('shared-mime-info')
makedepends=('libffi' 'perl' 'python2' 'curl' 'clang')
source=("http://static.rust-lang.org/dist/rustc-nightly-src.tar.gz")
sha256sums=('e03a2b849ba066d0e9ed7bc34f5f12602fa119dbd7c2dbae538cf3033170c46d')
install=rust.install
options=('!makeflags' 'staticlibs' '!strip')
conflicts=('rust')
provides=('rust')

build() {
  cd rustc-nightly

  ./configure --prefix=/usr --enable-docs --disable-rpath --disable-verify-install

  # avoid python makedepend (force fallback to python2)
  sed -i 's/^PYTHONVERSION.*/PYTHONVERSION := 3/' src/llvm/Makefile.rules
  make
 }

package() {
  cd rustc-nightly
  make DESTDIR="$pkgdir" install

  install -Dm644 src/etc/zsh/_rust "$pkgdir/usr/share/zsh/site-functions/_rust"
  install -Dm644 LICENSE-APACHE "$pkgdir/usr/share/licenses/$pkgname"
  install -Dm644 LICENSE-MIT "$pkgdir/usr/share/licenses/$pkgname"
  cd "$pkgdir/usr/lib"
  ln -sf rustlib/$CARCH-unknown-linux-gnu/lib/* .
}

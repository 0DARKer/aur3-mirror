# Maintainer: Tomáš Frýda (tm3da) <me@tm3da.eu>
# Highly based on rekonq-git PKGBUILD by Fedor Suchkov and Xavier Corredor

pkgname=rekonq+i18n-git
pkgver=20100616
pkgrel=3
pkgdesc="rekonq is a KDE web browser based on QtWebKit. (With localization and patches for dark themes)"
arch=('i686' 'x86_64')
url="http://rekonq.sourceforge.net/"
license=('GPL')
depends=('kdelibs>=4.4.0' 'qt>=4.6')
makedepends=('gcc' 'cmake' 'automoc4' 'git')
provides=(rekonq)
conflicts=(rekonq rekonq-git)
source=(patch_urlbar.diff patch_findbar.diff)
install=${pkgname}.install

md5sums=('95311ceff03877ec327c7a88d8ad4e73'
         'bbef61ab2bc308fe9af9bd1d552aa37a')

_gitroot="git://gitorious.org/rekonq/mainline.git"
_gitname="mainline"


build(){

  cd $srcdir

  if [[ -d $_gitname ]]; then
	(cd $_gitname && git pull origin)
  else
	git clone $_gitroot $_gitname
  fi
  
  cd $_gitname
  mkdir -p i18n
  cd i18n
  LIST="pt_BR en_GB ca zh_CN cs da nl fr gl de hu it nds pl pt ru sr es sv tr uk"
  for lang in $LIST
  do
    wget http://websvn.kde.org/*checkout*/trunk/l10n-kde4/$lang/messages/extragear-network/rekonq.po;
    mv rekonq.po rekonq_$lang.po;
  done
  # create the CMakeLists.txt file for the translations

echo '

FIND_PROGRAM(GETTEXT_MSGFMT_EXECUTABLE msgfmt)
 
IF(NOT GETTEXT_MSGFMT_EXECUTABLE)
        MESSAGE(
"------
                 NOTE: msgfmt not found. Translations will *not* be installed
------")
ELSE(NOT GETTEXT_MSGFMT_EXECUTABLE)
 
        SET(catalogname rekonq)
 
        ADD_CUSTOM_TARGET(translations ALL)
 
        FILE(GLOB PO_FILES ${catalogname}*.po)
 
        FOREACH(_poFile ${PO_FILES})
                GET_FILENAME_COMPONENT(_poFileName ${_poFile} NAME)
                STRING(REGEX REPLACE "^${catalogname}_?" "" _langCode ${_poFileName} )
                STRING(REGEX REPLACE "\\.po$" "" _langCode ${_langCode} )
 
                IF( _langCode )
                        GET_FILENAME_COMPONENT(_lang ${_poFile} NAME_WE)
                        SET(_gmoFile ${CMAKE_CURRENT_BINARY_DIR}/${_lang}.gmo)
 
                        ADD_CUSTOM_COMMAND(TARGET translations
                                COMMAND ${GETTEXT_MSGFMT_EXECUTABLE} --check -o ${_gmoFile} ${_poFile}
                                DEPENDS ${_poFile})
                        INSTALL(FILES ${_gmoFile} DESTINATION ${LOCALE_INSTALL_DIR}/${_langCode}/LC_MESSAGES/ RENAME ${catalogname}.mo)
                ENDIF( _langCode )
 
        ENDFOREACH(_poFile ${PO_FILES})
 
ENDIF(NOT GETTEXT_MSGFMT_EXECUTABLE)

' > CMakeLists.txt
  

  cd ../
  sed -i 's/#    ADD_SUBDIRECTORY( i18n )/    ADD_SUBDIRECTORY( i18n )/'  CMakeLists.txt
  
  cd src/
  patch findbar.cpp ../../../patch_findbar.diff
  cd urlbar/
  patch urlbar.cpp ../../../patch_urlbar.diff
  cd ../../



  rm -rf build
  mkdir build && cd build
    cmake -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_SKIP_RPATH=ON \
    -DCMAKE_INSTALL_PREFIX=/usr .. || return 1
  make || return 1
  make DESTDIR=${pkgdir} install
}

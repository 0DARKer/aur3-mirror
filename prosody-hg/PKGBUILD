#Maintainer: Nick Campbell <s0ma AT theangryfist DOT net>
#Contributor: Dwayne Bent <dbb.0@liqd.org>
#contributor: Gustavo Alvarez <sl1pkn07@gmail.com> 

pkgname=prosody-hg
pkgver=4273
pkgrel=1
pkgdesc="Development tip of a lightweight and extensible Jabber/XMPP server written in Lua."
arch=('i686' 'x86_64')
url="http://prosody.im"
license=('MIT')
depends=('lua>=5.1' 'luasocket' 'luaexpat' 'luasec' 'luafilesystem' 'libidn>=0.5.18' 'openssl')
optdepends=('luasec: TLS encryption support'
            'lua-zlib: compression support'
            'luaevent: Better Connection Scaling')
makedepends=('mercurial')
provides=('prosody')
conflicts=('prosody' 'prosody-devel')
backup=('etc/prosody/prosody.cfg.lua'
        'etc/logrotate.d/prosody')
source=('prosody.rcd' 'prosody.logrotated')

md5sums=('367ffff466ae63e565b350e6ce9042c1'
         '26466fdbea87963a3ca6f48f76fe4a29')

install=prosody.install

_hgroot="http://hg.prosody.im"
_hgrepo="trunk"


build() {
   cd ${srcdir}/${_hgrepo}
   hg update default
   ./configure --prefix=/usr --sysconfdir=/etc/prosody --datadir=/var/lib/prosody

   make

}

package() {
   cd ${srcdir}/${_hgrepo}
   make DESTDIR=${pkgdir} install

   rm $pkgdir/etc/prosody/certs/*

   install -d $pkgdir/etc/rc.d
   install -d $pkgdir/etc/logrotate.d
   install -d $pkgdir/var/log/prosody
   install -d $pkgdir/var/run/prosody
   install -Dm644 ${srcdir}/${_hgrepo}/prosody.cfg.lua.dist ${pkgdir}/etc/prosody/prosody.cfg.lua
   install -Dm755 ${srcdir}/prosody.rcd ${pkgdir}/etc/rc.d/prosody
   install -Dm644 ${srcdir}/prosody.logrotated ${pkgdir}/etc/logrotate.d/prosody
 
}

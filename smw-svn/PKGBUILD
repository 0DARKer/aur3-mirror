# Contributor: Evangelos Foutras <foutrelis@gmail.com>
# Contributer: Matthew Bauer <mjbauer95@gmail.com>

pkgname=smw-svn
_pkgname=smw
pkgver=6
pkgrel=1
pkgdesc="A Super Mario multiplayer game"
arch=('i686' 'x86_64')
url="http://smw.supersanctuary.net/"
license=('GPL2')
depends=('gcc-libs' 'sdl_mixer' 'sdl_image' 'desktop-file-utils')
makedepends=('bin86' 'hd2u')
install=smw.install
source=($_pkgname.desktop
	$_pkgname.png
	gcc.patch)
md5sums=('78b87b9c99c232ecc9f659a4994da12b'
	'b7f5ef181e41eb0339be746ea03ff628'
	'586cf917af0a81912d8c5c0fcfddb64b')
provides=("smw")
conflicts=("smw")

_svntrunk=https://supermariowar.googlecode.com/svn/trunk/
_svnmod=smw

build() {
	cd "$srcdir"

	if [ -d $_svnmod/.svn ]; then
		(cd $_svnmod && svn up -r $pkgver)
	else
		svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
	fi

	msg "SVN checkout done or server timeout"
	msg "Starting make..."

#	rm -rf "$srcdir/$_svnmod-build"
#	cp -r "$srcdir/$_svnmod" "$srcdir/$_svnmod-build"
	cd "$srcdir/$_svnmod"

	dos2unix -U configure
	chmod +x configure

	patch --forward -p0 -i ../gcc.patch

	./configure
	make || return 1
	make DESTDIR="$pkgdir" install

	# Set sane permissions
	find "$pkgdir/usr/share/games/$_pkgname" -type d -exec chmod 755 {} \;
	find "$pkgdir/usr/share/games/$_pkgname" -type f -exec chmod 644 {} \;

	# Install application shortcut and icon
	install -D -m644 "$srcdir/$_pkgname.desktop" "$pkgdir/usr/share/applications/$pkgname.desktop"
	install -D -m644 "$srcdir/$_pkgname.png" "$pkgdir/usr/share/pixmaps/$pkgname.png"

	mkdir -p $pkgdir/usr/bin
	ln -s /usr/games/smw $pkgdir/usr/bin
	ln -s /usr/games/smw-leveledit $pkgdir/usr/bin
	ln -s /usr/games/smw-worldedit $pkgdir/usr/bin
}

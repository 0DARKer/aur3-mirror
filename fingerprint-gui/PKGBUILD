# $Id: PKGBUILD 1521 2011-08-11 02:16:11Z ffjia $
# http://bugs.kde.org/show_bug.cgi?id=105631
# Maintainer: Feifei Jia <feifei.j at gmail dot com>

pkgname=fingerprint-gui
pkgver=1.04
pkgrel=6
pkgdesc="Application for fingerprint-based authentication, automatically support UPEK fingerprint readers with non-free library"
arch=('i686' 'x86_64')
url="http://www.n-view.net/Appliance/fingerprint/index.php"
license=('GPL')
depends=('qca-ossl' 'libfprint' 'libfakekey')
makedepends=('qt4' 'libfprint' 'libfakekey' 'polkit-qt')
optdepends=('libusb: for libbsapi')
source=(http://www.n-view.net/Appliance//fingerprint/download/${pkgname}-${pkgver}.tar.gz
        http://volker.de/wp-content/uploads/2012/12/BSAPI_4.3.291Lite_SDK_for_Linux.tar.gz
        upek.cfg
        gcc.patch
        qt.patch
        fingerprint-gui.patch
        finger-swipe-animation.tar)
install=${pkgname}.install
md5sums=('378905672b9d0ed1b7ad5f7a8ce658be'
         '28eeba025a6b3a84a4cdaaa9fcd6ad7a'
         '92cd8fff2b2c03bb881a0c4f59959785'
         'f4001af8df4360c35edde72d279d8b26'
         '8cb7fdab495053cb8b5a26eb6c223ff5'
         '6acc07ccf6691cbbca1478c04e791db7'
         'c6b70dd036ae68ed9e068146e115a622')

build() {
  cd ${srcdir}/${pkgname}-${pkgver}
  #set -x
  patch -p0 < ../qt.patch || return 1
  patch -p0 < ../gcc.patch || return 1
  # Use new animated image created by Anton Krug
  tar xf ../finger-swipe-animation.tar || return 1
  # Added for Upek 2020 support
  if [[ `lsusb -d 147e:2020` ]]
  then
    patch -p0 < ../fingerprint-gui.patch
    cp -f ../BSAPI_SDK_LITE/lib/libbsapi.so upek/lib/ || return 1
    cp -f ../BSAPI_SDK_LITE/lib64/libbsapi.so upek/lib64/ || return 1
  fi
  qmake4 PREFIX=/usr LIB=/usr/lib LIBPOLKIT_QT=LIBPOLKIT_QT_1_1 || return 1
  make || return 1
}

package() {
  cd ${srcdir}/${pkgname}-${pkgver}
  make INSTALL_ROOT=${pkgdir}/ install || return 1
  install -D -m644 ./CHANGELOG ./COPYING ${pkgdir}/usr/share/doc/${pkgname}/
  # Detect devices for available proprietary drivers
  if [[ `lsusb -d 0483:` ]] || [[ `lsusb -d 147e:` ]]
  then
    install -d ${pkgdir}/usr/lib
    # Setup NVM emulation needed for some UPEK devices
    install -d -m770 ${pkgdir}/var/upek_data
    install -d ${pkgdir}/etc
    install -m640 ${srcdir}/upek.cfg ${pkgdir}/etc/
    # Setup udev rules for UPEK devices
    install -d ${pkgdir}/etc/udev/rules.d
    install -m644 ./upek/91-fingerprint-gui-upek.rules ${pkgdir}/etc/udev/rules.d/
    if [ `uname -m` == "i686" ]
    then
        install -m755 ./upek/lib/libbsapi.so ${pkgdir}/usr/lib/
    else
        install -m755 ./upek/lib64/libbsapi.so ${pkgdir}/usr/lib/
    fi
  fi
}

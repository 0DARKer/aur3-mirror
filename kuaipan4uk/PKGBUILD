# Maintainer: Jason <jsfaint@gmail.com>
pkgname=kuaipan4uk
pkgver=1.0
pkgrel=3
pkgdesc="Kingsoft KuaiPan is one of the most popular cloud storage service in China. The aim of this project is to provide an easy-to-use KuaiPan client for UbuntuKylin and all Linux users."
arch=('i686' 'x86_64')
license=("Custom")
url="http://www.ubuntukylin.com/applications/showimg.php?lang=cn&id=21"
source=("" "http://curl.haxx.se/download/curl-7.23.1.tar.gz")
md5sums=('' '8e23151f569fb54afef093ac0695077d')

depends=('qt4' 'libpng' 'zlib' 'freetype2' 'libsm' 'libxrender' 'libxext' 'bzip2' 'icu' 'rtmpdump' 'crypto++' 'nss')

if [ "$CARCH" = "i686" ]; then
    source[0]="https://raw.github.com/jsfaint/kuaipan4uk_aur/master/${pkgname}_${pkgver}_i386.deb"
    md5sums[0]='c7cb772e683f733598eec232028371f6'
elif [ "$CARCH" = "x86_64" ]; then
    source[0]="https://raw.github.com/jsfaint/kuaipan4uk_aur/master/${pkgname}_${pkgver}_amd64.deb"
    md5sums[0]='2f7206bf33283532b8fd6b94fd848538'
fi

curl_ver="curl-7.23.1"

build()
{
    #Build libcurl
    cd ${srcdir}
    tar xf ${curl_ver}.tar.gz
    cd ${curl_ver}

    ./configure \
        --prefix=/ \
        --disable-ldap \
        --disable-ldaps \
        --enable-ipv6 \
        --enable-manual \
        --enable-versioned-symbols \
        --enable-threaded-resolver \
        --without-libidn \
        --with-random=/dev/urandom \
        --with-ca-bundle=/etc/ssl/certs/ca-certificates.crt \
        --with-ssl \
        --with-nss

    make
}

install_libcurl()
{
    local dst_dir="${pkgdir}/opt/ubuntukylin/${pkgname}"

    #install libcurl
    cd ${srcdir}/${curl_ver}
    make DESTDIR="$dst_dir" install

    #Remove curl binary
    rm ${dst_dir}/bin/curl
    rm ${dst_dir}/bin/curl-config

    #Remove man page
    rm ${dst_dir}/share -rf

    #Remove header file, we don't need it
    rm -rf ${dst_dir}/include
    rm -rf ${dst_dir}lib/libcurl.a
    rm -rf ${dst_dir}/lib/libcurl.la
    rm -rf ${dst_dir}/lib/pkgconfig

    cd $dst_dir/lib
    ln -s libcurl.so.4.2.0 libcurl-nss.so.4
}

fix_icu_library()
{
    local LD_PATH="/usr/lib/"

    local lib_list="libicuuc libicui18n libicudata"
    cd ${pkgdir}/opt/ubuntukylin/${pkgname}/lib

    for lib in $lib_list; do
        ln -s ${LD_PATH}/${lib}.so ${lib}.so.48
    done
}

package()
{
    local pkglib="${pkgdir}/opt/ubuntukylin/${pkgname}/lib"

    #Extract kuaipan4uk
    tar xf ${srcdir}/data.tar.gz -C ${pkgdir}/

    #Create symbolic link
    local libcrypto="/usr/lib/libcryptopp.so"
    if [[ -e ${libcrypto} ]]; then
        cd ${pkglib}
        ln -s ${libcrypto} libcrypto++.so.9
    fi

    #Create symbolic link for librtmp
    local librtmp="/usr/lib/librtmp.so"
    if [ -e ${librtmp} ]; then
        cd ${pkglib}
        ln -s $librtmp librtmp.so.0
    fi

    install_libcurl

    fix_icu_library
}

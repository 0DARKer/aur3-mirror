# Maintainer: Jason <jsfaint@gmail.com>
pkgname=kuaipan4uk
pkgver=1.0.1
pkgrel=2
pkgdesc="Kingsoft KuaiPan is one of the most popular cloud storage service in China. The aim of this project is to provide an easy-to-use KuaiPan client for UbuntuKylin and all Linux users."
arch=('i686' 'x86_64')
license=("Custom")
url="http://www.ubuntukylin.com/applications/showimg.php?lang=cn&id=21"
source=("" "http://curl.haxx.se/download/curl-7.23.1.tar.gz")
md5sums=('' '8e23151f569fb54afef093ac0695077d')

depends=('qt4' 'zlib' 'freetype2' 'libsm' 'libxrender' 'libxext' 'bzip2' 'icu' 'rtmpdump' 'crypto++' 'nss' 'boost-libs')

if [ "$CARCH" = "i686" ]; then
    source[0]="http://www.ubuntukylin.com/downloads/app_download.php?id=17"
    md5sums[0]='f17f2a37ae57b2ed25b7206141dfeaa8'
elif [ "$CARCH" = "x86_64" ]; then
    source[0]="http://www.ubuntukylin.com/downloads/app_download.php?id=18"
    md5sums[0]='fe899df667cf2e853f243e760e89f301 '
fi

curl_ver="curl-7.23.1"

build()
{
    #Build libcurl
    cd ${srcdir}
    tar xf ${curl_ver}.tar.gz
    cd ${curl_ver}

    ./configure \
        --prefix=/ \
        --disable-ldap \
        --disable-ldaps \
        --enable-ipv6 \
        --enable-manual \
        --enable-versioned-symbols \
        --enable-threaded-resolver \
        --without-libidn \
        --with-random=/dev/urandom \
        --with-ca-bundle=/etc/ssl/certs/ca-certificates.crt \
        --with-ssl \
        --with-nss

    make
}

install_libcurl()
{
    local dst_dir="${pkgdir}/opt/ubuntukylin/${pkgname}"

    #install libcurl
    cd ${srcdir}/${curl_ver}
    make DESTDIR="$dst_dir" install

    #Remove curl binary
    rm ${dst_dir}/bin/curl
    rm ${dst_dir}/bin/curl-config

    #Remove man page
    rm ${dst_dir}/share -rf

    #Remove header file, we don't need it
    rm -rf ${dst_dir}/include
    rm -rf ${dst_dir}lib/libcurl.a
    rm -rf ${dst_dir}/lib/libcurl.la
    rm -rf ${dst_dir}/lib/pkgconfig

    cd $dst_dir/lib
    ln -s libcurl.so.4.2.0 libcurl-nss.so.4
}

fix_boost_libs()
{
    local pkglib="${pkgdir}/opt/ubuntukylin/${pkgname}/lib"
    lib_list="libboost_filesystem.so libboost_iostreams.so libboost_regex.so libboost_system.so libboost_thread.so"

    cd ${pkglib}
    #Create symbolic links
    for i in ${lib_list}; do
        rm -f $i #Remove old symbolic link
        ln -s -f /usr/lib/${i} ${i}.1.54.0
    done
}

package()
{
    local pkglib="${pkgdir}/opt/ubuntukylin/${pkgname}/lib"

    #Extract kuaipan4uk
    tar xf ${srcdir}/data.tar.xz -C ${pkgdir}/

    #Create symbolic link
    local libcrypto="/usr/lib/libcryptopp.so"
    if [[ -e ${libcrypto} ]]; then
        cd ${pkglib}
        ln -s ${libcrypto} libcrypto++.so.9
    fi

    install_libcurl

    fix_boost_libs
}

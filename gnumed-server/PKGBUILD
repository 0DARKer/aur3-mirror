pkgname=gnumed-server
pkgver=15.5
pkgrel=1
pkgdesc="assist and improve longitudinal medical care"
arch=(i686 x86_64)
url="http://wiki.gnumed.de/bin/view/Gnumed"
license=('GPL')
# dependencies from net_install-gnumed_server.sh
# which ones are optional ?
# missing: anacron, it is in AUR repository
depends=('gnumed-client' 'postgresql' 'dcron' 'tar' 'coreutils' 'mailx' 'openssl' 'bzip2' 'gzip' 'gnupg' 'mc' 'rsync' 'python-psycopg2' 'sudo' 'wget')
optdepends=()
makedepends=()
conflicts=()
replaces=()
backup=()
install=('gnumed-server.install')
source=(http://www.gnumed.de/downloads/server/v15/$pkgname.$pkgver.tgz)
md5sums=('6ceefb68dfa0f59d13e9426c5b6e630b')


build() {
  cd "$srcdir/$pkgname.$pkgver"

  mkdir -p $pkgdir/usr/bin
  mkdir -p $pkgdir/usr/lib/gnumed/server/bootstrap
  mkdir -p $pkgdir/var/log/gnumed/server

  pushd server
    mkdir -p $pkgdir/usr/lib/gnumed/server
    cp -r * $pkgdir/usr/lib/gnumed/server

    # silent bootstrap process by setting interactive to 'no' and set 'gm-dbo' as default password
    for conffile in `find $pkgdir/usr/lib/gnumed/server/bootstrap -maxdepth 1 -type f -name \*.conf` ; do \
                sed -i 's/^\(interactive[[:space:]]*=[[:space:]]*\)yes/\1no/' "$conffile" ; \
                sed -i 's/^\(password[[:space:]]*=[[:space:]]*\)/\1 gm-dbo/' "$conffile" ; \
    done

    # copy all scripts
    cp *.sh $pkgdir/usr/bin
    cp gm-bootstrap_server $pkgdir/usr/bin

    echo "$pkgver" > $pkgdir/usr/lib/gnumed/server/version.txt
  popd
}


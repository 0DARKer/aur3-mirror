# Maintainer: Andras Biro <bbandi86@gmail.com>
pkgname=tinyos-tools-svn
pkgver=20111106
pkgrel=1
pkgdesc="Development-tools for TinyOS"
arch=('i686 x86_64')
license=('GPL')
options=(!libtool)
url="http://www.tinyos.net/"
depends=('python' 'bash' 'nesc' 'tinyos' 'jre')
provides=('tinyos-tools')
makedepends=('subversion')
_svnroot="http://tinyos-main.googlecode.com/svn/trunk/tools"
_svnmod="${pkgname}-${pkgver}/tools"

build() {

  if [ -d $_svnmod/.svn ]; then
    cd $_svnmod
    svn update
  else
    svn checkout $_svnroot $_svnmod
    cd $_svnmod
  fi
  msg "SVN checkout/update done or server timeout"

  #don't build the libraries for both architecture
  if [ "${CARCH}" = "x86_64" ]; then
    sed 's/JNIVERSIONS="-32. -64."/JNIVERSIONS="-64."/' ${srcdir}/${pkgname}-${pkgver}/tools/configure.ac > ${srcdir}/${pkgname}-${pkgver}/tools/configure.new
  else
    sed 's/JNIVERSIONS="-32. -64."/JNIVERSIONS="-32."/' ${srcdir}/${pkgname}-${pkgver}/tools/configure.ac > ${srcdir}/${pkgname}-${pkgver}/tools/configure.new
  fi
  mv -f ${srcdir}/${pkgname}-${pkgver}/tools/configure.new ${srcdir}/${pkgname}-${pkgver}/tools/configure.ac
  cd ${srcdir}/${pkgname}-${pkgver}/tools/
  ./Bootstrap
  cd ${srcdir}/${pkgname}-${pkgver}/tools/platforms/mica/uisp/
  ./bootstrap
  cd ${srcdir}/${pkgname}-${pkgver}/tools
  ./configure --prefix=/usr
  make || return 1
  make DESTDIR="${pkgdir}/" install
  
  
  jni=${pkgdir}`/${pkgdir}/usr/bin/tos-locate-jre --jni`
  if [ $? -eq 0 ]; then
    if [ "${CARCH}" = "x86_64" ]; then
      bits=64
    else
      bits=32
    fi
    echo "Installing $bits-bit Java JNI code in $jni ... "
    for lib in ${pkgdir}/usr/lib/tinyos/*.so; do 
      realname=`basename $lib | sed -e s/-$bits\.so/.so/`
      install -D $lib "$jni/$realname" || exit 1
    done
    echo "done."
  fi
}

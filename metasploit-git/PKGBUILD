# Submitter: https://github.com/jojosch/pkgbuilds
# Maintainer: Arch Linux Janitor <al.janitor [at] sdf [dot] org>

pkgname=metasploit-git
pkgver=20140819.25953.170c8b6
pkgrel=1
pkgdesc="A development platform for creating security tools and exploits."
arch=('any')
url='http://metasploit.com/'
license=('BSD')
depends=('ruby1.9' 'ruby1.9-msgpack' 'postgresql')
makedepends=('git')
provides=('metasploit')
conflicts=('metasploit')
options=('!strip')
install=$pkgname.install
optdepends=('java-runtime: msfgui' 'ruby-pg: Ruby interface to the Postgresql RDBMS')
source=('metasploit-git::git+https://github.com/rapid7/metasploit-framework.git')
sha1sums=('SKIP')

pkgver() {
  cd "$srcdir/$pkgname"
  _date=$(date +"%Y%m%d")
  echo "$_date.$(git rev-list --count master).$(git rev-parse --short master)"
}

package() {
  cd $pkgdir
  mkdir -p usr/local/{bin,src}
  cp -R $srcdir/$pkgname usr/local/src/$pkgname

  install -Dm644 usr/local/src/$pkgname/COPYING usr/share/licenses/$pkgname/COPYING
  install -Dm644 usr/local/src/$pkgname/LICENSE usr/share/licenses/$pkgname/LICENSE

  cd usr/local/bin
  for _bin in ../src/$pkgname/msf*; do
    ln -s $_bin .
  done
###
### A terrible terrible TERRIBLE hack until upstream is fixed, or else:
### /opt/ruby1.9/lib/ruby/1.9.1/rubygems/custom_require.rb:36:in `require': cannot load such file -- /usr/bin/config/boot (LoadError)
###          from /opt/ruby1.9/lib/ruby/1.9.1/rubygems/custom_require.rb:36:in `require'
###          from /usr/bin/msfconsole:23:in `<main>'
###
  cd ../src 
  ln -s ../src/metasploit-git/config ../bin/config
###
### The ruby1.9 package should be doing this, not metasploit-git...
###
  echo 'export PATH="$PATH:/opt/ruby1.9/bin"' >> ~/.bash_profile
}

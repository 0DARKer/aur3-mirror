diff --git a/configure.ac b/configure.ac
index de6da58..cba7b36 100644
--- a/configure.ac
+++ b/configure.ac
@@ -10,6 +10,8 @@ AC_CONFIG_MACRO_DIR([m4])
 AC_CONFIG_FILES([libvitamtp.pc])
 AM_INIT_AUTOMAKE
 
+m4_include(m4/acx_pthread.m4)
+
 # Checks for programs.
 AC_PROG_CC
 AC_PROG_LIBTOOL
@@ -41,13 +43,16 @@ case "$host" in
     CFLAGS="$CFLAGS -DUSE_DARWIN"
     OSFLAGS="-framework IOKit -framework CoreFoundation"
     ;;
+  *linux*) OSFLAGS="-D_XOPEN_SOURCE=600 -D__USE_XOPEN" ;;
   *) AC_MSG_RESULT([no]) ;;
 esac
 AC_SUBST(OSFLAGS)
 
+ACX_PTHREAD
+
 # Checks for libraries.
-AC_CHECK_FUNC([pthread_create], [], [AC_MSG_ERROR([pthread not found])])
 #AC_CHECK_HEADERS([pthread.h semaphore.h], [], [AC_MSG_ERROR([Cannot find pthread header])])
+PKG_CHECK_MODULES(XML, libxml-2.0)
 AC_CHECK_LIB([xml2], [xmlReadMemory], [], [AC_MSG_ERROR([libxml2 not found])])
 #AC_CHECK_HEADERS([libxml/parser.h libxml/xmlmemory.h libxml/xmlwriter.h], [], [AC_MSG_ERROR([Cannot find libxml2 header])])
 AC_CHECK_LIB([usb-1.0], [libusb_init], [], [AC_MSG_ERROR([libusb-1.0 not found])])
diff --git a/src/Makefile.am b/src/Makefile.am
index 8e9bee2..b3def8a 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -31,20 +31,20 @@ LT_CURRENT_MINUS_AGE=`expr $(CURRENT) - $(AGE)`
 # static library for linking
 noinst_LIBRARIES=libvitamtp.a
 libvitamtp_a_SOURCES=datautils.c device.c ptp.c vitamtp.c
-libvitamtp_a_CFLAGS=$(MTP_CFLAGS) -std=c99 -Os
+libvitamtp_a_CFLAGS=$(MTP_CFLAGS) $(XML_CFLAGS) -std=c99 -Os
 
 # shared library for installing
 lib_LTLIBRARIES=libvitamtp.la
 libvitamtp_la_SOURCES=datautils.c device.c ptp.c vitamtp.c
-libvitamtp_la_LIBADD=$(LIBS) $(MTP_LIBS)
-libvitamtp_la_CFLAGS=$(MTP_CFLAGS) -std=c99 -Os
+libvitamtp_la_LIBADD=$(LIBS) $(MTP_LIBS) $(XML_LIBS)
+libvitamtp_la_CFLAGS=$(MTP_CFLAGS) $(XML_CFLAGS) -std=c99 -Os
 libvitamtp_la_LDFLAGS=@OSFLAGS@ @LDFLAGS@ -no-undefined -export-symbols-regex "VitaMTP_[0-9A-Za-z_]+" -version-info $(SOVERSION)
 
 # opencma program
 bin_PROGRAMS=opencma
 opencma_SOURCES=opencma.c database.c utilities.c
-opencma_CFLAGS=$(MTP_CFLAGS) -std=c99 -Os
-opencma_LDADD=libvitamtp.a $(MTP_STATIC_LIBS) $(LIBS)
+opencma_CFLAGS=$(MTP_CFLAGS) $(OSFLAGS) -std=c99 -Os
+opencma_LDADD=libvitamtp.a $(MTP_STATIC_LIBS) $(LIBS) $(PTHREAD_LIBS)
 opencma_LDFLAGS=@OSFLAGS@ -static-libtool-libs
 
 DISTCLEANFILES = _stdint.h gphoto2-endian.h
diff --git a/src/opencma.c b/src/opencma.c
index 977a29b..56aab09 100644
--- a/src/opencma.c
+++ b/src/opencma.c
@@ -20,6 +20,7 @@
 
 #include <assert.h>
 #include <limits.h>
+#include <fcntl.h>
 #include <pthread.h>
 #include <semaphore.h>
 #include <signal.h>
diff --git a/src/utilities.c b/src/utilities.c
index 1f328c3..8f4ddb6 100644
--- a/src/utilities.c
+++ b/src/utilities.c
@@ -26,6 +26,7 @@
 #include <string.h>
 #include <sys/stat.h>
 #include <sys/statvfs.h>
+#include <sys/select.h>
 #include <unistd.h>
 
 #include "opencma.h"

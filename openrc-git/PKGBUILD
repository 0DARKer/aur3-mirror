# Contributor: Matt Parnell/ilikenwf parwok@gmail.com

pkgname="openrc-git"
pkgver=20110910
pkgrel=1
pkgdesc="EXPERIMENTAL/IN DEVELOPMENT! DO NOT USE YET - A dependency based init system that works with the system provided init program (sysvinit)."
url="https://github.com/ilikenwf/archlinux-openrc"
license=("GPL2")
arch=("i686" "x86_64")
makedepends=("git")

_gitroot="git://github.com/ilikenwf/archlinux-openrc.git"
_gitname="archlinux-openrc"

_builddir="$srcdir/build/"
_sourcedir="$srcdir/$_gitname/"

build() {
	fetch_sources
	
	export BRANDING="Arch Linux"
	export MKPKGCONFIG=no
	export MKSELINUX=no
	export MKTERMCAP=ncurses
	
	make DESTDIR="$pkgdir" install || return 1
	rm -rf "$pkgdir"/usr/lib/pkgconfig
	
}

# I'm lazy...thanks p4ddy for the nice example in zen-kernel PKGBUILD
fetch_sources() {
	if [ ! -d "$_gitname" ]; then
		cd "$srcdir"
		msg2 "Cloning initial copy of openrc..."
		
		git clone --depth 1 "$_gitroot" "$_gitname"
	fi
	
	cd "$srcdir/$_gitname"

	msg2 "Updating local tree..."
	if git fetch; then
		msg2 "Attempting to merge changes..."

		if ! git merge origin/master; then
			error "Merging failed..."

			msg2 "Fixing local repository..."
			git checkout -f "master"
			git clean -xdf
			git reset --hard "origin/master"
		fi
	else
		error "Update failed..."
	fi
}

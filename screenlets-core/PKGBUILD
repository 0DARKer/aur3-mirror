# $Id$
# Maintainer:
# Contributor: Roman Kyrylych <roman@archlinux.org>
# Contributor: javonera <javonera@gmail.com>
# Contributor: Artiom MOLCHANOV <ar.molchanov@gmail.com>

pkgname=screenlets-core
_bzr_name=screenlets
pkgver=0.1.5
pkgrel=2
_bzr_rel=712
pkgdesc="Screenlets â€” a framework for desktop widgets"
arch=('any')
url="http://screenlets.org/"
license=('GPL3')
depends=('dbus-python' 'gstreamer0.10-python' 'python-evolution' 
'python2-gconf' 'python-gnomekeyring' 'python2-gnomevfs' 'python-rsvg' 
'python-wnck' 'pyxdg' 'notification-daemon' 'xdg-utils' 
'python-beautifulsoup')
makedepends=('bzr')
optdepends=('screenlets-pack: Screenlets')
install=screenlets.install
#source=(https://code.launchpad.net/screenlets/trunk/$pkgver/+download/$pkgname-$pkgver.tar.bz2 
source=(init.patch utils.patch Screenlets.directory)
_bzrtrunk=lp:screenlets
conflicts=(screenlets)
md5sums=('1fdece77448ebe8f941cc53e6566aed5'
         'c4113ddcdce907081d258e5afbf23afe'
         'd4ccc8afaf67291a76eba0d49ba8138c')

build() {
  cd $srcdir
  msg "Connecting to the server...."
  if [ ! -d ./${_bzr_name} ]; then
    msg "Checkout"
    bzr co ${_bzrtrunk} ${_bzr_name} -r ${_bzr_rel}
  else
    msg "Updating"
    bzr up ${_bzr_name} -r ${_bzr_rel}
  fi
  msg "BZR checkout done or server timeout"
  msg "Starting make..."
  [ -d ./${_bzr_name}-build ] && rm -rf ./${_bzr_name}-build
  cp -r ./${_bzr_name} ./${_bzr_name}-build
  cd ./${_bzr_name}-build
  
#  cd "$srcdir/${pkgname}-${pkgver}"
  for _file in $( find ./src -type f ) ; do 
    sed -i 's:python\([^2]\):python2\1:g' ${_file}
    sed -i 's:python$:python2:' ${_file}
  done
  patch -p0 < $srcdir/init.patch
  patch -p0 < $srcdir/utils.patch
}

package() {
#  cd "$srcdir/${pkgname}-${pkgver}"
  cd ./${_bzr_name}-build
  mkdir -p "$pkgdir"/etc/screenlets
  echo /usr > "$pkgdir"/etc/screenlets/prefix

  python2 setup.py install --root="$pkgdir"

  install -D -m644 "$srcdir/Screenlets.directory" "$pkgdir/usr/share/desktop-directories/Screenlets.directory"
 
  install -D -m644 desktop-menu/screenlets.svg "$pkgdir/usr/share/icons/screenlets.svg"
  install -D -m644 desktop-menu/mono-dark/screenlets-tray.svg "$pkgdir/usr/share/icons/screenlets-tray.svg"

  cd desktop-menu/
  for i in $(find -name '*.desktop'); do install -D -m644 $i "$pkgdir"/usr/share/applications/$(echo $i | sed 's|./applications||') ; done
}

# See http://wiki.archlinux.org/index.php/VCS_PKGBUILD_Guidelines
# for more information on packaging from GIT sources.

# Maintainer: Leo von Klenze <leo@devel.von-klenze.de>
pkgname=cloud9-git
pkgver=20110901
pkgrel=1
pkgdesc="Cloud9 IDE - Your code anywhere, anytime. Open Source Javascript Cloud9 IDE"
arch=('i686' 'x86_64')
url="https://github.com/ajaxorg/cloud9"
license=('GPLv3')
depends=(nodejs)
makedepends=('git')
provides=(cloud9)
conflicts=(cloud9)
source=(middleware.patch)
noextract=()
md5sums=(6c6664ccb741a5152771556add84d115)
install=(cloud9.install)

_gitname="cloud9"
_gitroot="https://github.com/ajaxorg/${_gitname}"

build() {
  cd "$srcdir"
  msg "Connecting to GIT (${_gitroot})"

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files of ${_gitname} were updated."
  else
    git clone $_gitroot $_gitname
    cd $_gitname
  fi

  msg "GIT checkout done or server timeout"

  git submodule update --init --recursive

  msg "Patch middleware to avoid writing to program directory..."
  patch -p 1 < "../../middleware.patch"
}

package() {
  install -d "$pkgdir/opt/cloud9"
  install -d "$pkgdir/usr/bin"
  ln -s "/opt/cloud9/bin/cloud9.js" "$pkgdir/usr/bin/cloud9"

  cp -R $srcdir/$_gitname/* $pkgdir/opt/$_gitname

  #find . -path '*/.git*' -prune -or -type f -and -print | while read file; do 
  #  dir=$(dirname "$pkgdir/opt/$file")
  #  install -d "$dir"
  #  cp -a "$file" "$dir"
  #done
} 



# Maintainer: Pieter van der Kloet <pvdkloet@gmail.com>
pkgname=openmw-git
pkgver=20110803
pkgrel=1
pkgdesc="OpenMW is a open-source engine reimplementation for the role-playing game Morrowind."
arch=('i686' 'x86_64')
url="http://www.openmw.com"
license=('GPL3')

depends=('openal' 'ogre' 'bullet' 'ffmpeg' 'mygui' 'mpg123' 'libsndfile' 'qt')

makedepends=('git' 'cmake' 'boost')
install=$pkgname.install
conflicts=('openmw')

_gitroot="git://github.com/zinnschlag/openmw.git"
_gitname="openmw"

build() {
  msg "Connecting to GIT server...."

  if [ -d "$_gitname" ] ; then
    cd "$_gitname" && git pull origin
    git submodule update
    msg "The local files are updated."
  else
    cd "$srcdir"
    git clone "$_gitroot" "$_gitname"
    cd "$_gitname"
    git submodule update --init
    cd "$srcdir"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."
  
  if [ ! -d "$srcdir"/build ]; then
      mkdir "$srcdir"/build
  fi

  # Create Makefiles in build dir
  cd "$srcdir"/build
  cmake ../"$_gitname" \
  	 -DCMAKE_INSTALL_PREFIX=/opt
  make
  
  # Install
  sed -i 's,/usr/local/lib/OGRE,/usr/lib/OGRE,' plugins.cfg
  
  # There is currently no make install so we do this manually
  mkdir -p "$pkgdir"/opt/openmw
  cp openmw "$pkgdir"/opt/openmw
  cp esmtool "$pkgdir"/opt/openmw
  cp *.cfg "$pkgdir"/opt/openmw
  cp -r resources "$pkgdir"/opt/openmw
  chmod 0777 "$pkgdir"/opt/openmw  
}

package() {
  # For makepkg package creation 
  cd "$srcdir"/build

  mkdir -p "$pkgdir"/opt/openmw
  cp openmw "$pkgdir"/opt/openmw
  cp esmtool "$pkgdir"/opt/openmw
  cp *.cfg "$pkgdir"/opt/openmw
  cp -r resources "$pkgdir"/opt/openmw
  chmod 0777 "$pkgdir"/opt/openmw
    
}



# Maintainer: onny <onny@project-insanity.org>
# Contributor: onny <onny@project-insanity.org>

pkgname=osmocombb-git
pkgver=20120207
pkgrel=1
pkgdesc="An Free Software / Open Source GSM Baseband software implementation."
arch=('i686' 'x86_64')
url="http://bb.osmocom.org/"
license="GPL3"
makedepends=('cross-arm-elf-gcc' 'libtool' 'autoconf' 'git' 'make' 'gcc' 'pkg-config' 'patch')
depends=('shtool')
optdepends=('gpsd')
backup=()
options=('!strip')
source=(gpsd-osmocombb.patch)
md5sums=('d08727b9b851a9839bd4eeaed49ee176')
_gitroot="http://cgit.osmocom.org/cgit/osmocom-bb"
_gitname="osmocom-bb"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
    cd osmocom-bb
    git pull --rebase
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting to patch..."
  # patch gps.c to avoid compile errors
  #patch -i ../gpsd-osmocombb.patch src/host/layer23/src/common/gps.c
  msg "Starting make..."
  
  cd src
  make -i
} 
package () {
  cd "$srcdir"

  mkdir -p $pkgdir/opt/osmocombb/host/osmocon
  mkdir -p $pkgdir/opt/osmocombb/host/layer23
  mkdir -p $pkgdir/opt/osmocombb/host/rita_pll

  find . \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.am" -o -name "*.o" -o -name "Makefile" \) -print | xargs -i rm {}

  cp -r $srcdir/osmocom-bb/src/* $pkgdir/opt/osmocombb/
  cp -ar $srcdir/osmocom-bb/doc $pkgdir/opt/osmocombb/
  cp -ar $srcdir/osmocom-bb/include $pkgdir/opt/osmocombb/

  #cp $arcdir/osmocombb/host/osmocon/osmocon $pkgdir/opt/osmocombb/host/osmocon/
  #cp $arcdir/osmocombb/host/osmocon/osmoload $pkgdir/opt/osmocombb/host/osmocon/
  #cp $arcdir/osmocombb/host/layer23/src/mobile/mobile $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/mobile/libmobile.a $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/misc/bcch_scan $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/misc/cbch_sniff $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/misc/ccch_scan $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/misc/cell_log $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/misc/echo_test $pkgdir/opt/osmocombb/host/layer23/
  #cp $arcdir/osmocombb/host/layer23/src/common/liblayer23.a $pkgdir/opt/osmocombb/host/layer23/common/

  #cp -r $srcdir/osmocom-bb/src/* $pkgdir/opt/osmocombb/
  #cp -ar $srcdir/osmocom-bb/doc $pkgdir/opt/osmocombb/
  #cp -ar $srcdir/osmocom-bb/include $pkgdir/opt/osmocombb/
}


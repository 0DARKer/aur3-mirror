# Partly based on original PKGBUILD by Mikko Seppala <t-r-a-y@mbnet.fi>
# Contributor: Manuel Gaul <inkaine@hotmail.com>
_pkgsourcename=catalyst-utils-beta
pkgname=lib32-$_pkgsourcename
pkgver=8.670
pkgrel=1
pkgdesc="Proprietary AMD/ATI userspace tools and libraries for Radeon brand cards."
url="http://www.ati.amd.com"
arch=(x86_64)
license=('custom')
groups=('lib32')
depends=('lib32-libxext' 'lib32-libdrm' 'lib32-libstdc++5' 'catalyst-beta>=8.670')
conflicts=('lib32-libgl' 'lib32-nvidia-utils')
replaces=('lib32-ati-fglrx-utils' 'lib32-fglrx-utils')
provides=('lib32-libgl')
source=(http://download2-developer.amd.com/amd/Stream20Beta/ati-opencl-beta-driver-v2.0-beta4-lnx.zip lib32-catalyst.sh)
md5sums=('0b0314fd2959b48e80b0b92d2a54778b' 'd31f79782eb1042e1b45f2486c3b0d33')

build() {
  # Extract Catalyst driver installer
  /bin/sh ./fglrx-8.67/ati-driver-installer-8.67-x86.x86_64.run --extract archive_files
  
  cd ${srcdir}
  install -D -m755 lib32-catalyst.sh ${pkgdir}/etc/profile.d/lib32-catalyst.sh || return 1

  # Install lib32 libraries
  cd "${srcdir}/archive_files/arch/x86/usr" || return 1
  install -d m755 "${pkgdir}/opt/lib32/usr/lib/xorg/modules/dri" || return 1
  install -m755 X11R6/lib/*.so* "${pkgdir}/opt/lib32/usr/lib" || return 1
  install -m755 X11R6/lib/modules/dri/*.so "${pkgdir}/opt/lib32/usr/lib/xorg/modules/dri/" || return 1

  ln -sf libfglrx_dm.so.1.0 "${pkgdir}/opt/lib32/usr/lib/libfglrx_dm.so.1"
  ln -sf libfglrx_pp.so.1.0 "${pkgdir}/opt/lib32/usr/lib/libfglrx_pp.so.1"
  ln -sf libfglrx_tvout.so.1.0 "${pkgdir}/opt/lib32/usr/lib/libfglrx_tvout.so.1"
  ln -sf libfglrx_gamma.so.1.0 "${pkgdir}/opt/lib32/usr/lib/libfglrx_gamma.so.1"
  ln -sf libGL.so.1.2 "${pkgdir}/opt/lib32/usr/lib/libGL.so.1"
  ln -sf libGL.so.1.2 "${pkgdir}/opt/lib32/usr/lib/libGL.so"
}

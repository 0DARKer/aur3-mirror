# Contributor: Roman Ajsin <aysin (dot) roman [at] gmail (dot) com>

pkgname=squashfs-tools-lzma
_pkgname=squashfs-tools
pkgver=4.0
pkgrel=1
pkgdesc="Tools for squashfs, a highly compressed read-only filesystem for Linux. LZMA version."
url="http://squashfs.sourceforge.net"
license=("GPL")
arch=('i686' 'x86_64')
depends=('zlib' 'glibc')
#conflicts=('squashfs-tools')
#provides=('squashfs-tools')
source=(http://downloads.sourceforge.net/sourceforge/squashfs/squashfs$pkgver.tar.gz
        # lzma patches
        01_lzma.patch
        02_lzmasdk.patch
        03_lzmasdk_static_lib.patch
        04_lzma_fix.patch
        squashfs-lzma-setdefault.patch
        squashfs4.0-permission.patch)
md5sums=('a3c23391da4ebab0ac4a75021ddabf96'
         'b0c9c152a7215ecc40045035de3f83cc'
         'c4d273755f07d49b919acce703f3c84d'
         '9e9df893fa5607ccc6b9595b36df8728'
         '10440d729aa088bcd872796ad4fcbdf2'
         'edf679674b3d341aaf939208d5c4e7dc'
         '32c0913babba3b1e6ab9b9a46572168c')

build()
{
    cd ${srcdir}/squashfs$pkgver
    
    msg "Applying LZMA patches"
    patch -Np1 -i ${srcdir}/squashfs4.0-permission.patch || return 1
    patch -Np1 -i ${srcdir}/01_lzma.patch || return 1
    patch -Np1 -i ${srcdir}/02_lzmasdk.patch || return 1
    patch -Np1 -i ${srcdir}/03_lzmasdk_static_lib.patch || return 1
    patch -Np1 -i ${srcdir}/04_lzma_fix.patch || return 1
    # finally, set LZMA as default compression method
    patch -Np1 -i ${srcdir}/squashfs-lzma-setdefault.patch || return 1

    make -C lzmasdk/C/LzmaUtil -f makefile.gcc || return 1

    cd ${srcdir}/squashfs$pkgver/$_pkgname

    sed -i "/LZMA_CFLAGS/ s,$, -I${srcdir}/squashfs$pkgver/lzmasdk/C," Makefile || return 1

    make LZMA_LIB=${srcdir}/squashfs$pkgver/lzmasdk/C/LzmaUtil/liblzma.a USE_LZMA=1 || return 1
}

package()
{
    install -D -m755 ${srcdir}/squashfs$pkgver/$_pkgname/mksquashfs ${pkgdir}/sbin/mksquashfs.lzma
    install -D -m755 ${srcdir}/squashfs$pkgver/$_pkgname/unsquashfs ${pkgdir}/sbin/unsquashfs.lzma
}

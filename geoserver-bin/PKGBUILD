# Contributor: Thomas Dziedzic

pkgname=geoserver-bin
pkgver=2.0.1
pkgrel=2
pkgdesc="Server written in Java that allows users to share and edit geospatial data."
arch=(i686 x86_64)
url="http://geoserver.org"
license=('GPL2+')
depends=('java-runtime')
makedepends=('unzip')

pkg=geoserver-$pkgver-bin.zip
noextract=($pkg)
source=(http://downloads.sourceforge.net/project/geoserver/GeoServer/$pkgver/$pkg)
md5sums=('24ae19cfd3b806db889a8aa53684413a')

####################################################
# WARNING: GEOSERVER USES A VERY WEIRD CONFIGURATION
#          FOLDERS NEED TO BE 777 IN /OPT
####################################################

build() {
  # bsdtar will fall on its face with this file :/
  unzip $pkg

  # remove windows files
  rm "$srcdir/geoserver-$pkgver/bin/startup.bat"
  rm "$srcdir/geoserver-$pkgver/bin/shutdown.bat"

  # install
  mkdir -p "$pkgdir/opt"
  cp -r "$srcdir/geoserver-$pkgver" "$pkgdir/opt"

  # todo: selectively change file permissions
  #       or find a better way to install geoserver

  # change permissions
  chmod -R a+rwX "$pkgdir/opt/geoserver-$pkgver"

  # make custom startup/shutdown links
  mkdir -p "$pkgdir/usr/bin"
  ln -s "/opt/geoserver-$pkgver/bin/startup.sh" "$pkgdir/usr/bin/geoserver-startup"
  ln -s "/opt/geoserver-$pkgver/bin/shutdown.sh" "$pkgdir/usr/bin/geoserver-shutdown"

  # set necessary variables
  mkdir -p "$pkgdir/etc/profile.d"
  echo "export GEOSERVER_HOME=/opt/geoserver-$pkgver" > "$pkgdir/etc/profile.d/geoserver.sh"
  chmod +x "$pkgdir/etc/profile.d/geoserver.sh"
}

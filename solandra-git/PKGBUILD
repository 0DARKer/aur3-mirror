## Contributor: shahid <helllamer@gmail.com>
## Originally based on PKGBUILDS:
## - Thomas Dziedzic's cassandra 
## - Massimiliano Torromeo: solr

name=solandra
pkgname=$name-git
pkgver=20110712
pkgrel=1
pkgdesc="NoSQL database (cassandra with Apache Solr)"
arch=('any')
url="https://github.com/tjake/Solandra"
license=('Apache 2.0')
optdepends=('jetty' 'tomcat7' 'tomcat6' 'tomcat')
## testing is using junit, but junit is downloaded by ivy in compile time
#checkdepends=('junit')
makedepends=('apache-ant' 'unzip')
provides=('cassandra')
install=solandra-git.install

_gitroot='https://github.com/tjake/Solandra.git'
_gitname=$name

gitdir=$srcdir/$_gitname
builddir=$srcdir/$_gitname-build

install_to_d=usr/share/$name
etc_d=etc/$name

build() {
	cd $srcdir
	msg "Connecting to the git server..."

	if [[ -d $srcdir/$_gitname ]] ; then
		cd $_gitname
		git remote set-url origin $_gitroot
		git pull origin
		msg "The local files are updated."
	else
		git clone $_gitroot $_gitname
	fi
	msg "Git checkout done"

	msg "Starting make..."
	rm -rf $builddir
	git clone $gitdir $builddir

	## recently installed apache-ant may not be seen shell
	which ant || . /etc/profile.d/apache-ant.sh

	## making things
	cd $builddir
	ant war
}

## unit tests
check() {
	cd $builddir
	ant test
}

package() {
	## extracting war
	install -d "$pkgdir/$install_to_d"
	unzip -n "$builddir/$name.war" -d "$pkgdir/$install_to_d"
	rm -rf "$pkgdir/$install_to_d/META-INF"
	
	## moving web.xml to /etc
	install -d "$pkgdir/$etc_d"
	local web_xml=$pkgdir/$install_to_d/WEB-INF/web.xml
	chmod 0644 $web_xml
	mv $web_xml $pkgdir/$etc_d
	ln -s /$etc_d/web.xml $web_xml
}

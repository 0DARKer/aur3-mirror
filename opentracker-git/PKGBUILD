# Maintainer: TheCreeper <loxoko@gmail.com>

pkgname="opentracker-git"
pkgver=20121120
pkgrel=3
epoch=2
_libowfatver=0.29
pkgdesc="An open and free bittorrent tracker project. It aims for minimal resource usage and is intended to run on your wlan router."
arch=( "i368" "x86_64" "armv6h" )
url="http://erdgeist.org/arts/software/opentracker/"
license=( "custom" )
depends=( "zlib" "gcc-libs" )
backup=( "etc/opentracker/opentracker.conf" )
source=( "https://github.com/mateuszzawisza/opentracker/archive/master.tar.gz"

    "opentracker.service"
    "license.txt"
    "http://dl.fefe.de/libowfat-$_libowfatver.tar.bz2"
)
md5sums=( "cfc35e3888c7784a5ad9f4b8d935624c"

    "244c93a793a36c78b5862008a171a232"
    "01e8892d9985602b06ff033bffbb927a"
    "1187c6acf11429e7adb9ebe180f644bb"
)

build() {

    cd $srcdir/libowfat-$_libowfatver/

    make

    cd $srcdir/opentracker-master/

    #DWANT_V6 > Compile in IPV6 only support.

    #DWANT_ACCESSLIST_BLACK > Compile in a blacklist of disallowed torrents.
    #DWANT_ACCESSLIST_WHITE > Compile in a whitelist of allowed torrents. Only one can be used.

    #DWANT_SYNC_LIVE > Compile in support for running in clusters.
    #DWANT_IP_FROM_QUERY_STRING > ?
    #DWANT_COMPRESSION_GZIP > Allow the client to download the scrape in a gzip format.
    #DWANT_COMPRESSION_GZIP_ALWAYS > Force the client to download the scrape in a gzip format.
    #DWANT_LOG_NETWORKS > Experimental or old feature. No idea what this does.
    #DWANT_RESTRICT_STATS > ?
    #DWANT_IP_FROM_PROXY > Experimental or old feature. No idea what this does.
    #DWANT_FULLLOG_NETWORKS > Experimental or old feature. No idea what this does.
    #DWANT_LOG_NUMWANT > Experimental or old feature. No idea what this does.
    #DWANT_MODEST_FULLSCRAPES > Clients may not scrape more frequently than every 5 minutes.
    #DWANT_SPOT_WOODPECKER > Experimental or old feature. No idea what this does. 
    #DWANT_SYSLOGS > ?
    #DWANT_DEV_RANDOM > Experimental or old feature. No idea what this does.
    #DWANT_FULLSCRAPE > Compile in support for querying opentracker for all tracked torrents. Defualt. Change Makefile to compile out this support.

    #D_DEBUG_HTTPERROR > ?

    #sed -e 's|#DWANT_COMPRESSION_GZIP_ALWAYS|DWANT_COMPRESSION_GZIP_ALWAYS|' \
    #    -e 's|#DWANT_RESTRICT_STATS|DWANT_RESTRICT_STATS|'
    #    -i Makefile

    make    LIBOWFAT_HEADERS="../libowfat-$_libowfatver" \
            LIBOWFAT_LIBRARY="../libowfat-$_libowfatver" \

    sed     -e 's|# tracker.rootdir /usr/local/etc/opentracker|tracker.rootdir /etc/opentracker|' \
            -e 's|# access.stats 192.168.0.23|access.stats 127.0.0.1|' \
            -i opentracker.conf.sample
}

package() {

    cd $srcdir/

    install -d $pkgdir/usr/bin/
    install -m 755 opentracker-master/opentracker $pkgdir/usr/bin/

    install -d $pkgdir/usr/lib/systemd/system
    install -m 755 opentracker.service $pkgdir/usr/lib/systemd/system/

    install -d $pkgdir/etc/opentracker
    install -m 644 opentracker-master/opentracker.conf.sample $pkgdir/etc/opentracker/opentracker.conf

    install -d $pkgdir/usr/share/doc/opentracker/
    install -m 644 opentracker-master/opentracker.conf.sample $pkgdir/usr/share/doc/opentracker/

    install -d $pkgdir/usr/share/licenses/opentracker/
    install -m 644 license.txt $pkgdir/usr/share/licenses/opentracker/
}

pkgname=tano-git
pkgver=20120415
pkgrel=2
pkgdesc="An open-source cross-platform IP TV player based on Qt and libvlc"
arch=('i686' 'x86_64')
url="http://projects.tano.si/en/player"
license=('GPL')
depends=('vlc>=1.1' 'qt>=4.6' 'libvlc-qt-git')
makedepends=('cmake>=2.6' 'qt>=4.6' 'dbus>=1.4' 'libvlc-qt-git' 'desktop-file-utils')
provides=('tano')
conflicts=('tano')
source=('getuid.patch')
md5sums=('32cedfc861ea8ce840195c8fcdf2cd21')

_gitroot='git://github.com/ntadej/tano.git'
_gitname='tano'
_buildir=${_gitname}-build

_optimal_make_jobs() {
	local core_count=$(cat /proc/cpuinfo | grep -Fc processor)
	if [ $core_count -gt 1 ]; then
		echo -n $[$core_count-1]
	else
		echo -n 1
	fi
}

build() {
	cd ${srcdir}

	msg 'Connecting to GIT server...'
	if [ -d ${_gitname} ]; then
		cd ${_gitname} && git pull origin
		cd ..
	else
		git clone ${_gitroot}
	fi

	msg 'GIT checkout done or server timeout.'

	if [ -d ${_buildir} ]; then
		msg 'Cleaning previous build...'
		rm -rf ${_buildir}
	fi

	git clone ${_gitname} ${_buildir}
	cd ${_buildir}

	msg 'Applying patch...'
	patch -p0 -N -i ${srcdir}/getuid.patch

	msg 'Running cmake...'
	
	export LDFLAGS='-lX11'

	cmake . -DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_BUILD_TYPE=Release

	msg 'Done.'

	msg 'Starting make...'

	make -j$(_optimal_make_jobs) || return 1
	make DESTDIR="${pkgdir}" install || return 1

	rm -rf ${srcdir}/${_buildir}
}

package() {
	cd ${srcdir}/${_gitname}
	desktop-file-install -m 644 --dir ${pkgdir}/usr/share/applications/ tano-editor.desktop
	desktop-file-install -m 644 --dir ${pkgdir}/usr/share/applications/ tano.desktop
}

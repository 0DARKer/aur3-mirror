# Maintainer: Karolina Lindqvist <karolina.lindqvist@kramnet.se>

pkgname=pic30-gcc
pkgver=3.23
pkgrel=1
pkgdesc="PIC24/dsPIC30 gcc"
arch=(i686)
url="http://www.microchip.com"
depends=('pic30-binutils>=$pkgver')
makedepends=(hd2u)
license=('GPL')
source=(http://ww1.microchip.com/downloads/en/DeviceDoc/mplabc30v${pkgver/./_}.tar.gz
        makefile_in.diff t-pic30.diff
	pic30-standard-prefix.diff resource-path.diff cpp-defaults.diff
	version.diff resource.diff patches.diff docs.diff flag_definitions.diff
	configure.diff )

build() {
  cd $srcdir/gcc-4.0.2/gcc-4.0.2/
  # Convert from DOS
  find . -type f -exec dos2unix -U "{}" ';' || return 1
  find $srcdir/c30_resource/src/c30/ -type f -exec dos2unix -U "{}" ';' || return 1
  find $srcdir/c30_resource/src/generator/ -type f -exec dos2unix -U "{}" ';' || return 1

  # Apply all the hacks
#  patch -p0 -b < ../../pic30-standard-prefix.diff || return 1
  patch -p0 -b < ../../t-pic30.diff || return 1
  patch -p0 -b < ../../resource-path.diff || return 1
  patch -p0 -b < ../../makefile_in.diff || return 1
#  patch -p0 -b < ../../bug.diff || return 1
  patch -p0 -b < ../../patches.diff || return 1
  patch -p0 -b < ../../docs.diff || return 1
  patch -b -p0 < ../../version.diff || return 1
  patch -b -p0 < ../../cpp-defaults.diff || return 1
  patch -b -p0 < ../../configure.diff || return 1
  (cd $srcdir && patch -b -p0 < resource.diff || return 1)
  (cd $srcdir && patch -b -p0 < flag_definitions.diff || return 1)
  
#  autoreconf
  (cd libiberty && autoreconf)
#  aclocal -I .
#  autoconf
#  automake

  # We need to regenerate ./configure for libiberty
#  (cd libiberty && aclocal -I .. && autoconf )

  mkdir build
  cd build
  echo "#define MCHP_VERSION \"v$pkgver for Arch Linux\"" >../gcc/mchp_version.h
#  echo version_string = \"$pkgver\" > ./version-trigger
  findCPP="/usr/bin/cpp" ../configure --prefix=/usr -exec-prefix=/usr/pic30 -bindir=/usr/bin --target=pic30-elf --enable-languages=c --mandir=/usr/share/man --libexecdir=/usr/lib/ --includedir=/usr/pic30/include --program-prefix=pic30- --enable-target-optspace --without-headers --program-transform-name='s,pic30-pic30-,pic30-,' --with-cross-host=pic30 --libdir=/usr/pic30/lib --infodir=/usr/share/info|| return 1
# alt:
# --program-transform-name='s,pic30-pic30-,pic30-,'
# --with-headers=/usr/pic30/include
# --with-gnu-as --with-as=pic30-as --with-gnu-ld --with-ld=pic30-ld 
# --with-newlib
# -with-gcc-version-trigger=../version-trigger
# --enable-threads 

  sed -i '/^SUBDIRS =/s/libiberty//' Makefile

  make || return 1

#  make -C ../libiberty distclean
#  cd libiberty
#  ../../libiberty/configure --host=pic30 --libdir/usr/pic30/lib --includedir=/usr/pic30/include
#  make
#  cd ..

  make -w DESTDIR="$pkgdir/" install || return 1
#  make -C libiberty -w DESTDIR="$pkgdir/" install || return 1

  rm -fr $pkgdir/usr/share/locale $pkgdir/usr/share/man/man7/gpl.7 $pkgdir/usr/share/man/man7/gfdl.7 $pkgdir/usr/share/man/man7/fsf-funding.7
#  rm -fr $pkgdir/usr/info

  # Despite all the above, things do not end up in the right places
  # and with the right names. So we fix it up here
#  mkdir $pkgdir/usr/pic30/lib
#  rmdir $pkgdir/usr/pic30-elf/lib
#  rmdir $pkgdir/usr/pic30-elf
#  mv $pkgdir/usr/lib/libiberty.a $pkgdir/usr/pic30/lib
#  ln -t $pkgdir/usr/pic30/include $pkgdir/usr/lib/gcc/pic30-elf/include/*.h 
#  ln -t $pkgdir/usr/pic30/lib $pkgdir/usr/lib/gcc/pic30-elf/*.a
#  rm $pkgdir/usr/bin/pic30-elf-gcc-
  install -m 0755 -d $pkgdir/usr/include
  for f in float.h  iso646.h  stdarg.h  stdbool.h  stddef.h  varargs.h; do \
      mv $pkgdir/usr/pic30/lib/gcc/pic30-elf/4.0.3/include/$f $pkgdir/usr/pic30/include; \
  done
  # Pick up the gcc limits file before junk was added
  install -m644 $srcdir/gcc-4.0.2/gcc-4.0.2/gcc/glimits.h $pkgdir/usr/pic30/include/limits.h
#  rm -fr $pkgdir/usr/pic30/lib/gcc
  install -m 0755 -d $pkgdir/usr/bin
#  ln $pkgdir/usr/lib/gcc/pic30-elf/pic30-cc1 $pkgdir/usr/bin

  # Remove libiberty built for host
  rm $pkgdir/usr/pic30/pic30-elf/lib/libiberty.a
  # Remove info-files that are in gcc
  rm $pkgdir/usr/share/info/*

#  rm -fr $pkgdir/usr/pic30/lib/gcc/pic30-elf
}
md5sums=('9daf896854afa227f71070f7b6983d09'
         '478893528f6e763f1b593666c8f1fc07'
         'c30eb5a197ead2b3ec61181faf8c1a6b'
         '6f0e9458822e7c2ce0a680611de29e27'
         '6f7024857c852feb22004bfa91d6189a'
         '3d699ccc6fd7613e0f171c4791e27a53'
         '8ec322ba83c0c67968b81e989e014ee4'
         'f4315e861e6ac3cc7a768c74ebb559fa'
         '0fb9a218f2912478a7d12038db081d99'
         '1584397be4c3924153ca2e21719fc4d4'
         'd020613e7257fda69bf7dd94c2480bba'
         '327506067389f6252ad7c544fad05061')

# Maintainer: ilikenwf/Matt Parnell <parwok@gmail.com>
# Contributor: Muhammad 'MJ' Jassim <UnbreakableMJ@gmail.com>
# Contributor: Aaron 'venisonslurpee' Laursen <venisonslurpee@gmail.com>

# I hacked this to just scrape the needed versioning info so that this doesn't
# have to be edited every day you choose to rebuild

# Just a shout out to the songbird devs to go screw themselves for officially
# dropping linux support - so nightlies are the best we can do

pkgname=songbird-auto-beta
pkgver=nightly
pkgrel=1
pkgdesc="Songbird, the GPL iTunes killer. Automatically grabs latest beta build. Native for both 64 and 32 bit."
arch=('i686' 'x86_64')
url="http://www.songbirdnest.com/"
license=('GPL2')
depends=('libxrender' 'libxext' 'libx11' 'libxmu' \
         'gstreamer0.10' 'gstreamer0.10-base' 'gtk2' 'libxt' \
	 'sqlite3' 'nss' 'libidl2' 'gstreamer0.10-good-plugins')
optdepends=('gstreamer0.10-bad: support for more formats'
	    'gstreamer0.10-good: support for more formats'
	    'gstreamer0.10-ugly: support for more formats')
makedepends=('sed' 'grep' 'tar' 'wget')
provides=('songbird')
conflicts=('songbird' 'songbird-bin' 'songbird-auto-nightly' 'bin32-songbird-auto-nightly' 'songbird-svn' 'songbird-nightly' 'songbird-nightly-bin' 'songbird-stable-bin' 'songbird-nightly-latest')
install=songbird-nightly.install
source=(Songbird.desktop songbird-launcher.sh)
md5sums=('02ffd66cd34054654135b25d8f82b906'
         'afc2ad4ad4954e98af3703a1a07cd574')

build() {
 
  # Why update daily when we can just scrape the url for the latest version?
  VERSION=`wget -qO- http://wiki.songbirdnest.com/Developer/Articles/Builds/Nightly_Builds|grep -o http.*\_linux-$CARCH.tar.gz| sed 's/\".*title\=.*//'`
	
  cd ${srcdir}
  
  if [ -a `echo $VERSION|grep -o Songbird.*.tar.gz` ]
  then
	msg "File exists, no need to download."
  else
	wget $VERSION
	wget $VERSION.md5
  fi
  
  msg "Checking md5sum of Songbird archive..."
  md5sum -c `echo $VERSION|grep -o Songbird.*.tar.gz`.md5
  msg "Building."
  
  tar xf `echo $VERSION|grep -o Songbird.*.tar.gz`

  # Use the proper number for the pkgver
  pkgver=`echo $VERSION|grep -o Songbird.*.tar.gz|sed 's/Songbird\_//'|sed 's/\-.*_linux.*\.tar\.gz//'`
  
  cd Songbird
  
  # Go ahead and build
  install -d --group=users ${pkgdir}/opt/songbird
  cp -a ${srcdir}/Songbird/* \
        ${pkgdir}/opt/songbird || return 1
  chmod 755 ${pkgdir}/opt/songbird/songbird
  chmod 755 ${pkgdir}/opt/songbird/songbird-bin
  chmod 755 ${pkgdir}/opt/songbird/xulrunner/xulrunner
  chmod 755 ${pkgdir}/opt/songbird/xulrunner/xulrunner-bin
  chmod -R a+r ${pkgdir}/opt/songbird
  install -D ${srcdir}/Songbird/chrome/icons/default/default.xpm \
  	     ${pkgdir}/usr/share/pixmaps/Songbird.xpm
  install -D -m644 ${srcdir}/Songbird.desktop \
  	     	   ${pkgdir}/usr/share/applications/Songbird.desktop
  install -d ${pkgdir}/usr/bin
  
  ## fixing the problem with system-wide installs:
  find ${pkgdir}/opt/songbird -type d -exec chmod 755 {} \;
  install --directory ${pkgdir}/usr/bin
  install ${srcdir}/songbird-launcher.sh ${pkgdir}/usr/bin/songbird
}

# Maintainer: Martin F. Schumann <mfs@mfs.name>
pkgname=unvanquished-git
pkgver=20120523
pkgrel=1
pkgdesc="A unique team-based first-person shooter, which pits the aliens against the humans."
arch=('x86_64' 'i686')
url="http://www.unvanquished.net"
license=('GPL-3.0+')
groups=()
depends=('curl' 'freetype2' 'glew' 'gmp' 'libjpeg-turbo' 'ncurses' 'libogg' 'openal' 'libpng' 'sdl' 'libvorbis' 'zlib' 'nettle' 'libwebp' 'libtheora' 'speex')
makedepends=('git' 'cmake')
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
source=('unvanquished.sh' 'unvanquished-download-paks.sh' 'unvanquished.desktop')
noextract=()
md5sums=('ac17e7744e1bb0e759e7f63e6634376f'
         '40dd5f8958bee9764815f8fbd2208167'
         '9128f8aaa682de2adb6258789cf83cb1')

_gitroot="https://github.com/Unvanquished/Unvanquished.git"
_gitname="unvanquished"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  cd "$srcdir/$_gitname"

  cmake -D CMAKE_INSTALL_PREFIX="/usr" . && make
}

package() {
  # Create pkg dirs
  cd "$pkgdir"
  install -d opt/unvanquished/main var/lib/unvanquished usr/share/icons/hicolor/128x128/apps usr/share/applications
  
  # install files
  cd "$srcdir/$_gitname"
  make DESTDIR="$pkgdir/" install
  mv "$pkgdir"/usr/bin/* "$pkgdir"/opt/unvanquished/
  install -m 644 debian/unvanquished.png "$pkgdir"/usr/share/icons/hicolor/128x128/apps/
  install -m 755 download-pk3.sh "$pkgdir"/opt/unvanquished/
  cp -r main/* "$pkgdir"/opt/unvanquished/main/
  install *.so "$pkgdir"/opt/unvanquished/

  cd "$srcdir"
  install -m 755 unvanquished-download-paks.sh unvanquished.sh "$pkgdir"/usr/bin/
  install -m 644 unvanquished.desktop "$pkgdir"/usr/share/applications/

  # Download and install pk3 files
  "$_gitname"/download-pk3.sh dl/main dl/cache
  cp -r dl/main "$pkgdir"/opt/unvanquished/
  cp -r dl/cache/* "$pkgdir"/var/lib/unvanquished/

  # link arch-specific executables
  cd "$pkgdir"/opt/unvanquished
  ln -s daemon."$CARCH" unvanquished
  ln -s daemonded."$CARCH" unvanquishedded
}

# vim:set ts=2 sw=2 et:

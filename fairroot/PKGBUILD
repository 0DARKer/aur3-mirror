# Maintainer: Bastian LÃ¶her <b.loeher@gsi.de>
pkgname=fairroot
pkgver=14.11
pkgrel=1
pkgdesc="Analysis framework based on root provided by GSI/FAIR."
arch=('x86_64')
url="http://fairroot.gsi.de"
license=('LGPL3')
groups=()
makedepends=('cmake'
	'clang'
	'bison'
	'flex'
	'gcc-fortran'
	'subversion'
	'git'
	'curl')
depends=(
	'fairsoft'
	)
provides=()
conflicts=()
replaces=()
backup=()
options=('!emptydirs' 'staticlibs' 'libtool' '!strip')
install=fairroot.install
changelog=
source=("https://github.com/FairRootGroup/FairRoot/archive/v-${pkgver}.tar.gz"
	'fc1a4d96f621d3f178ec4872ad2bc740413467ed.patch'
	'fairroot.install'
	)
noextract=()
md5sums=('2248cfe049b2f05e38791b4c60fa7a97'
         '30471aa4ac5ec2d6a46ff33a6bb47e5e'
         '2906ed6b10c121b0eaca4db254b85733')

# Do not compress the package for installation
# PKGEXT='.pkg.tar'
# Compress using lightweight gzip
PKGEXT='.pkg.tar.gz'

prepare() {
	# Path to fairsoft installation
	export SIMPATH=/opt/fairsoft/current

	# Patch cmake file for Protobuf
	cd ${srcdir}/FairRoot-v-${pkgver}
	git apply ${srcdir}/../fc1a4d96f621d3f178ec4872ad2bc740413467ed.patch

	# Patch dbase/dbValidation/ValTimeStamp.cxx gcc > 4.9
	# See also https://github.com/root-mirror/root/commit/08b08412bafc24fa635b0fdb832097a3aa2fa1d2
	sed -i "s/#ifdef __USE_BSD/#if defined(__USE_BSD) || defined(__USE_MISC)/" \
	       ${srcdir}/FairRoot-v-14.11/dbase/dbValidation/ValTimeStamp.cxx

	# Execute cmake
	cd ${srcdir}
	[ -d build ] || mkdir build
	cd build
	cmake \
		-DUSE_DIFFERENT_COMPILER=TRUE \
		-DCMAKE_INSTALL_PREFIX="/opt/fairroot/current" \
		../FairRoot-v-${pkgver}
:
}

build() {
	# Path to fairsoft installation
	export SIMPATH=/opt/fairsoft/current
	cd ${srcdir}/build
	make -j$(nproc)
}

package() {
	cd ${srcdir}/build
	make DESTDIR="${pkgdir}/" install
}

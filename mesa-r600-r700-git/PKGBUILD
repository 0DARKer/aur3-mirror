# Maintainer: andrewthomas <atswartz at gmail.com>
# Contributor: endlessroad1991 <385989829@qq.com>

pkgname=mesa-r600-r700-git
pkgver=20110127
_realver=7.11
pkgrel=1
pkgdesc="Full Mesa 3D graphics library with all its components, **ONLY** for ati r6xx/r7xx video cards, built from the git master branch."
arch=(i686 x86_64)
url="http://mesa3d.org/"
license=('LGPL')
depends=('libdrm>=2.4.15' 'dri2proto>=2.1' 'glproto>=1.4.11' 'gcc-libs' 'libxmu' 'libxi' 'libxxf86vm' 'talloc' 'libxdamage' 'expat>=2.0.1')
makedepends=('git' 'pkgconfig' 'imake')
provides=("libgl=${_realver}" "mesa-full" "mesa-git" "mesa=${_realver}" "glut=${_realver}" "freeglut" "ati-dri=${_realver}")
replaces=('libgl' 'mesa-full' 'mesa-git' 'mesa' 'glut' 'freeglut' 'ati-dri')
conflicts=('libgl' 'mesa-full' 'mesa-git' 'mesa' 'glut' 'freeglut' 'ati-dri')


_gitroot="git://anongit.freedesktop.org/git/mesa/mesa"
_gitname="mesa"

build() {
	msg "Connecting to git.freedesktop.org GIT server...."

	if [ -d ${srcdir}/$_gitname ] ; then
		cd $_gitname && git fetch && git reset --hard origin/master
		msg "The local files are updated."
	else
		git clone $_gitroot
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf ${srcdir}/$_gitname-build
	cp -rH ${srcdir}/$_gitname ${srcdir}/$_gitname-build
	cd ${srcdir}/$_gitname-build	
	
	# python2 build fixes
	sed -i -e "s|#![ ]*/usr/bin/python$|#!/usr/bin/python2|" \
	-e "s|#![ ]*/usr/bin/env python$|#!/usr/bin/env python2|" $(find $srcdir -name '*.py')
	sed -i -e "s|PYTHON2 = python|PYTHON2 = python2|" "${srcdir}"/$_gitname-build/configs/{default,autoconf.in}

	./autogen.sh --prefix=/usr \
	--with-dri-driverdir=/usr/lib/xorg/modules/dri \
	--with-dri-drivers=swrast,r600 \
	--enable-glx-tls \
	--with-driver=dri \
	--enable-xcb \
	--enable-egl \
	--enable-glu \
	--enable-glut \
	--enable-glw \
	--disable-gallium || return 1
	make || return 1
	make DESTDIR="${pkgdir}" install || return 1


	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
	ln -sf libglx.xorg ${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so || return 1

	install -m755 -d "${pkgdir}/usr/bin"
}


# Maintainer: Edward Tjörnhammar <xhemi@cube2.se>
# Contributor: Edward Tjörnhammar <xhemi@cube2.se>

pkgname=gt
pkgver=4.0.8
pkgrel=1
pkgdesc="A WSRF conformant open source toolkit used for building grids."
url="http://www.globus.org/toolkit/"
license=(APL GTPL)
depends=(jre apache-ant heimdal)
makedepends=(jdk make)
arch=(x86_64)
install=(gt.install)
options=(!strip)
source=(http://www-unix.globus.org/ftppub/gt4/4.0/$pkgver/installers/bin/$pkgname$pkgver-x86_64_rhas_4-installer.tar.gz)
build() {
	_D=$startdir/pkg
	_S=$startdir/src
	_R=/opt/$pkgname/$pkgver
	_DR=$_D/$_R
	mkdir -p $_D
	pushd $_S/$pkgname$pkgver-x86_64_rhas_4-installer
	sed -i \
	-e "s|\(GLOBUS_LOCATION=\)\(@prefix@\)|\1${_DR}\2|" \
	-e "s|\(@gptlocation@\)|${_DR}\1|" \
	-e "s|\(GLOBUS_IODBC_PATH=\)\(@globus_iodbc@\)|\1${_DR}\2|" \
	Makefile.in

	./configure --prefix=$_R || return 1
	make || return 1 
	make DESTDIR=$_DR install || return 1
	popd

	mv $_DR/opt opt
	mv ./$_R/* $_DR/.
	rm -rf opt
	ln -s /usr/lib/libssl.so $_DR/lib/libssl.so.4
	ln -s /usr/lib/libcrypto.so $_DR/lib/libcrypto.so.4
	ln -s /usr/lib/libgssapi.so $_DR/lib/libgssapi_krb5.so.2
	ln -s /usr/lib/libkrb5.so $_DR/lib/libkrb5.so.3

	find $_D -exec grep -l "$_DR" {} \; | while read f;do sed -i -e "s|\(.*\)$_DR\(.*\)|\1\2|g" $f;done
	cat > $startdir/$pkgname.env <<ENVIRONMENT
export GLOBUS_LOCATION=$_R
. $_R/etc/globus-user-env.sh
ENVIRONMENT
	cat $startdir/$pkgname.{env,install.core} > $startdir/$pkgname.install
	cat > $startdir/$pkgname.conf<<CONFIG
OPTS="-nosec"
CONFIG
	mkdir -p $_D/etc/{rc,conf,profile}.d
	
	install -Dm0755 $startdir/$pkgname.env $_D/etc/profile.d/$pkgname.sh
	install -Dm0755 $startdir/$pkgname.rc $_D/etc/rc.d/$pkgname
	install -Dm0755 $startdir/$pkgname.cf $_D/etc/conf.d/$pkgname
}
md5sums=( 
	'82c20f7d6d60ec443161d860dcb29b61'
)


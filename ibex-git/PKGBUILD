# Maintainer: Christoph Haag <haagch@studi.informatik.uni-stuttgart.de>
pkgname=ibex-git
pkgver=182.2458612
pkgrel=1
pkgdesc="Ibex - 3D Virtual Reality Desktop/Compositing Manager for X11/Linux, Windows and Mac OS (for e.g. Oculus Rift)"
arch=('i686' 'x86_64')
url="https://bitbucket.org/druidsbane/ibex/overview"
license=('GPL')
depends=('mesa')
makedepends=('irrlicht' 'freeglut' 'glew' 'tinyxml')

_gitname="ibex"
_builddir="${_gitname}/build"
source=("$_gitname::git+https://bitbucket.org/druidsbane/ibex.git" 'fix_install_prefix.diff' 'ibex-startscript' )

# not in AUR I think
# optdepends=('blender-ogre-exporter: to convert models to Ogre meshes: https://code.google.com/p/blender2ogre/')

build() {
  cd ${_gitname}
  msg "Patching..."

  # it doesn't respect -DCMAKE_INSTALL_PREFIX, this patches CMakeFiles.txt to let "make install" install to $CMAKE_INSTALL_PREFIX/usr/share/
  # https://bitbucket.org/druidsbane/ibex/issue/3/take-cmake_install_prefix-into-account
  git apply ${srcdir}/fix_install_prefix.diff

  msg "Starting make..."

  mkdir -p ${srcdir}/${_builddir}
  cd ${srcdir}/${_builddir}

  # -pthread: https://bitbucket.org/druidsbane/ibex/issue/5/add-development-friendly-cflags-and
  # -lboost_system: https://bitbucket.org/druidsbane/ibex/issue/2/linker-flag-for-boost-15s-libboost_system
  cmake ../ -DCMAKE_INSTALL_PREFIX=/usr \
         -DCMAKE_CXX_FLAGS="-lboost_system" \
         -DCMAKE_BUILD_TYPE=Release \

         #-DCMAKE_CXX_FLAGS="-lboost_system -lpthread" \
  make
}

package() {
  cd ${srcdir}/${_builddir}
  make DESTDIR="$pkgdir/" install
  install -m 755 -d ${pkgdir}/usr/bin/
  install -m 755 ${srcdir}/ibex-startscript ${pkgdir}/usr/bin/ibex
}

pkgver() {
  cd ${srcdir}/${_gitname}
  echo $(git rev-list --count master).$(git rev-parse --short master)
}

md5sums=('SKIP' '49c6c0e7b3f5f6b2fcc405093248d339'
         '7b6df4c5a397928b839d978ac30ef613')


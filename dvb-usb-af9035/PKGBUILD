# Maintainer: Alessandro Pazzaglia <jackdroido at gmail dot com>

pkgname=dvb-usb-af9035
pkgver=1
pkgrel=3
pkgdesc="TerraTec Cinergy T Stick USB DVB-T kernel module"
arch=('i686' 'x86_64')
url="http://linuxtv.org/wiki/index.php/TerraTec_Cinergy_T_Stick"
license=('GPL')
makedepends=('linux-headers')
depends=('linux')
source=(
    'http://mennucc1.debian.net/terratec_af9035-a_m.tar.gz'
    'af9035-linux32.diff'
)
md5sums=(
    '472caeed389c4dc57f3f545dc9e47967'
    'f48b1838a9cd57878f1196f8eed0a76b'
)

_tardir="terratec_af9035-a_m"
_unamer=`uname -r`

build() {
    cd "$srcdir/$_tardir"

    msg "Patching Makefile for kernel $_unamer ..."

    sed -i "s,\(^KDIR =\).*,\1 /usr/src/linux-$_unamer," "Makefile"
    sed -i "s,\(^KSRC =\).*,\1 /usr/src/linux-$_unamer," "Makefile"
    sed -i "s,\(^KINSTALL =\).*,\1 $pkgdir/lib/modules/$_unamer/kernel/drivers/misc," "Makefile"
    sed -i "/^install/ a\\\tinstall -D -m 644 dvb-usb-af9035-01.fw $pkgdir/lib/firmware/dvb-usb-af9035-01.fw" "Makefile"
    sed -i '/^install/ a\\tinstall -d $(KINSTALL)' "Makefile"
    sed -i '/depmod/ d' "Makefile"

    msg "Patching frontend ..."

    patch -p 1 < "../af9035-linux32.diff"

    msg "Starting make ..."

    make
}

package() {
    cd "$srcdir/$_tardir"

    make install
}

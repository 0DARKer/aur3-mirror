# Maintiner: Kyle Keen <keenerd@gmail.com>
pkgname=fexl-git
pkgver=20120922
pkgrel=1
pkgdesc="A small and embeddable interpreter for a programming language based on functions.  Broken!"
url="http://fexl.com/code/"
arch=('i686' 'x86_64')
license="GPLv3"
depends=()
makedepends=('git' 'findutils' 'unionfs-fuse')
source=("http://kmkeen.com/tmp/trip-arch")
md5sums=('11560146ff10c42cbe23fc7f9fa7476f')

_gitroot="git@github.com:chkoreff/Fexl.git"
_gitname="Fexl"

build() {
    cd "$srcdir"
    msg "Connecting to github..."

    if [ -d "$srcdir"/${_gitname} ] ; then
        cd ${_gitname} && git pull origin
        msg "The local files are updated."
    else
        git clone --depth 1 ${_gitroot}
    fi

    msg "GIT checkout done or server timeout"
    msg "Starting build..."

    cd "$srcdir/$_gitname"
    ./build
}

package() {
    cd "$srcdir/$_gitname"

    # his custom build tool is fairly broken
    mkdir -p "$pkgdir/usr/bin/"
    mkdir -p "$pkgdir/usr/share/fexl"

    # oh, and tries to run gcc with root privileges
    #sed -i "s|\"/usr\"|\"$pkgdir/usr\"|" build
    sed -i 's|$sudo||' build
    sed -i 's|sudo ||' build
    #./build install

    # no DESTDIR support
    #_badso="$pkgdir/usr/lib/fexl/libfexl.so:0"
    #_libso="/usr/lib/fexl/libfexl.so"
    #for _i in seq ${#_libso} ${#_badso}; do
    #    _libso=${libso}\\x00
    #done
    #msg $_badso
    #msg $_libso
    #sed -i "s|$_badso|$_libso|" "$pkgdir/usr/bin/fexl"

    # contain the build
    msg "Fexl has a convoluted build process that requires writing to your /"
    msg "Trip-arch will sandbox the build, using a chroot + unionFS overlay."
    cp ../../trip-arch ./
    PKG_SIZE=10 bash trip-arch ./build install
    cp -R "pkg/usr" "$pkgdir"
}


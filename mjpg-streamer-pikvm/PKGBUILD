# Contributor: Ross Melin <rdmelin@gmail.com>
# Contributor: Tri Le <trile7@gmail.com>
# Contributor: libc <primehunter326@gmail.com>
# Contributor: Albert Nguyen <albertbmnguyen@yahoo.com>
# Contributor: Devaev Maxim <mdevaev@gmail.com>


pkgname="mjpg-streamer-pikvm"
pkgver="r63"
pkgrel="2"
pkgdesc="Stream mjpeg frames from a webcam via http (PiKVM edition)"
url="http://sourceforge.net/projects/mjpg-streamer"
license="GPL"
arch=("i686" "x86_64" "armv6h")
depends=("libjpeg" "imagemagick")
makedepends=("gcc")
provides=("mjpeg-streamer")
options=("!makeflags")
source=(
	"http://downloads.sourceforge.net/project/mjpg-streamer/mjpg-streamer/Sourcecode/mjpg-streamer-$pkgver.tar.gz"
	"uvc.patch"
	"every.patch"
)
md5sums=(
	"1c424b5441a2bf8379cdecd7dbebc935"
	"edcdd714d87411d0daba9f8a336d6b82"
	"48b4367764085db2d60d0fd7ac7b3b2b"
)


prepare() {
	cd "$srcdir"
	patch -p0 < uvc.patch
	patch -p0 < every.patch
	cd "$srcdir/mjpg-streamer-$pkgver"
	find . -type f -print0 | xargs -0 sed -i "s/\<videodev\.h\>/videodev2.h/g"
}

build() {
	cd "$srcdir/mjpg-streamer-$pkgver"
	make application input_uvc.so output_http.so || return 1
}

package() {
	cd "$srcdir/mjpg-streamer-$pkgver"
	mkdir -p $pkgdir/usr/share/mjpeg-streamer/www/
	mkdir -p $pkgdir/usr/lib
	install *.so $pkgdir/usr/lib/
	install -m 644 www/* $pkgdir/usr/share/mjpeg-streamer/www/
	install -m 755 www/functions.js $pkgdir/usr/share/mjpeg-streamer/www/
	mkdir -p $pkgdir/usr/bin
	install mjpg_streamer $pkgdir/usr/bin/
	install -m 644 CHANGELOG LICENSE README start.sh $pkgdir/usr/share/mjpeg-streamer/
}

pkgname="radare2-git"
pkgver=20131221.3425.ecec213
pkgrel=1
pkgdesc="Toolchain for reverse engineering"
arch=('i686' 'x86_64')
url="http://radare.org"
license=('GPL3')
depends=('python2' 'libewf')
makedepends=('git' 'python2')
provides=('radare2')
conflicts=('radare2')

_gitroot="git://github.com/radare/radare2.git"
_gitname="radare2"

pkgver () {
	cd "${srcdir}/${_gitname}"
	_date=`date +"%Y%m%d"`
	echo "$_date.$(git rev-list --count master).$(git rev-parse --short master)"
}

build() {
	export CFLAGS="${CFLAGS//-fPIE -pie}"
	export CXXFLAGS="${CXXFLAGS//-fPIE -pie}"
	export PKG_CONFIG_PATH="${srcdir}/${_gitname}-build/pkgcfg:$PKG_CONFIG_PATH"

	cd ${srcdir}

	if [ -d ${_gitname}-build ] ; then
		msg "Removing leftovers..."
		rm -rf ${_gitname}-build
	fi

	if [ -d ${_gitname} ]; then
		cd ${_gitname}
		git pull --rebase
	else
		git clone ${_gitroot} ${_gitname}
	fi

	cd ${srcdir}
	git clone ${_gitname} ${_gitname}-build
	cd ${_gitname}-build

	msg "Building radare2..."
	./sys/build.sh
}

package() {
	cd ${srcdir}/${_gitname}-build

	make DESTDIR=${pkgdir} install

	cd ${srcdir}
	rm -rf ${_gitname}-build
}

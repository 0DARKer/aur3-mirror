# Maintainer: Danilo Kuehn <dk at nogo-software dot de>
# Git: https://github.com/nogo/archlinux-pkgbuild

_shell=brackets-shell
_shell_commit=81e670d475303c951579d52b1218e9ab297016e9
_brackets=brackets
_brackets_commit=2cdd027afd3b84772f372834121290ccc35322ba

pkgname=brackets-git
pkgver=27
pkgrel=4
pkgdesc="Adobe Brackets - An open source code editor for the web, written in JavaScript, HTML and CSS."
arch=('i686' 'x86_64')
url="http://brackets.io"
license=('MIT')
depends=('chromium' 'nodejs')
makedepends=('git' 'p7zip' 'gtk2' 'gyp-svn' 'nss' 'nspr' 'nodejs-grunt-cli')
provides=('brackets' 'adobe-brackets')
install=${pkgname}.install
conflicts=()
source=("git://github.com/adobe/brackets-shell.git"
        "git://github.com/adobe/brackets.git")
md5sums=('SKIP'
         'SKIP')

if test "$CARCH" == i686; then
_cef=cef_binary_3.1453.1255_linux32
source+=("$_cef.7z::https://drive.google.com/uc?export=download&id=0B65Ib9j_qgvBNmpNa2ZNUWJyUms")
md5sums+=('d07e59cb4830b45de4e51b1fdc53eead')
else
_cef=cef_binary_3.1453.1255_linux64
source+=("$_cef.7z::https://drive.google.com/uc?export=download&id=0B65Ib9j_qgvBcGNrd3ZkbnNFaUU")
md5sums+=('53cd8f5cae4c2bdfc856f073b186bed0')
fi

prepare() {
  if [ ! -f /usr/lib/libnss3.so.1d ]; then
    sudo ln -s /usr/lib/libnss3.so /usr/lib/libnss3.so.1d
  fi
  if [ ! -f /usr/lib/libnssutil3.so.1d ]; then
    sudo ln -s /usr/lib/libnssutil3.so /usr/lib/libnssutil3.so.1d
  fi
  if [ ! -f /usr/lib/libnspr4.so.0d ]; then
    sudo ln -s /usr/lib/libnspr4.so /usr/lib/libnspr4.so.0d
  fi
  if [ ! -f /usr/lib/libplc4.so.0d ]; then
    sudo ln -s /usr/lib/libplc4.so /usr/lib/libplc4.so.0d
  fi
  if [ ! -f /usr/lib/libsmime3.so.1d ]; then
    sudo ln -s /usr/lib/libsmime3.so /usr/lib/libsmime3.so.1d
  fi
  if [ ! -f /usr/lib/libudev.so.0 ]; then
    sudo ln -s /usr/lib/libudev.so /usr/lib/libudev.so.0
  fi

  cd ${srcdir}/${_shell}
  git checkout ${_shell_commit}

  cd ${srcdir}/${_brackets}
  git checkout ${_brackets_commit}
  git submodule update --init --recursive
}

build() {
  pushd ${srcdir}/${_shell}

  mkdir deps
  cp -R ${srcdir}/${_cef} ${srcdir}/${_shell}/deps/cef
  ln -fs deps/cef/include/ include
  ln -fs deps/cef/libcef_dll/ libcef_dll
  ln -fs deps/cef/Release/ Release
  ln -fs deps/cef/Resources/ Resources
  cp appshell.gyp.txt appshell.gyp
  gyp --depth .
  make
  popd
  
  pushd ${srcdir}/${_shell}
  sudo npm install --no-bin-links
  grunt copy:linux copy:www copy:samples
}

package() {
  mkdir -p ${pkgdir}/usr/bin
  mkdir -p ${pkgdir}/usr/lib

  cp -R ${srcdir}/${_shell}/installer/linux/debian/usr/lib/brackets ${pkgdir}/usr/lib/brackets
  chmod 0755 ${pkgdir}/usr/lib/brackets/Brackets
  cp -R ${srcdir}/${_shell}/installer/linux/debian/usr/share ${pkgdir}/usr/share

  mkdir -p ${pkgdir}/usr/lib/brackets/dev
  cp -R ${srcdir}/${_brackets}/* ${pkgdir}/usr/lib/brackets/dev/

  ln -s /usr/lib/brackets/Brackets "$pkgdir/usr/bin/brackets"

  if [ ! -f "/usr/bin/google-chrome" ]; then
    ln -s /usr/bin/chromium "$pkgdir/usr/bin/google-chrome"
  fi
}


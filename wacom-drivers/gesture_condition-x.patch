From cf5986b7e546443f16cd86dbb46c8ba334382081 Mon Sep 17 00:00:00 2001
From: Peter Hutterer <peter.hutterer@who-t.net>
Date: Tue, 23 Aug 2011 13:38:14 +1000
Subject: [PATCH] Sanitize condition to check for complex gestures.

Signed-off-by: Peter Hutterer <peter.hutterer@who-t.net>
Acked-by: Ping Cheng <pinglinux@gmail.com>
Acked-by: Chris Bagwell <chris@cnpbagwell.com>
---
 src/wcmTouchFilter.c |   25 ++++++++++++++-----------
 1 files changed, 14 insertions(+), 11 deletions(-)

diff --git a/src/wcmTouchFilter.c b/src/wcmTouchFilter.c
index 4afede2..433e12f 100644
--- a/src/wcmTouchFilter.c
+++ b/src/wcmTouchFilter.c
@@ -290,18 +290,21 @@ void wcmGestureFilter(WacomDevicePtr priv, int channel)
 		    wcmFingerScroll(priv);
 
 	/* process complex two finger gestures */
-	else if ((2*common->wcmGestureParameters.wcmTapTime <
-	    (GetTimeInMillis() - ds[0].sample)) &&
-	    (2*common->wcmGestureParameters.wcmTapTime <
-	    (GetTimeInMillis() - ds[1].sample))
-	    && ds[0].proximity && ds[1].proximity)
-	{
-		/* scroll should be considered first since it requires
-		 * a finger distance check */
-		wcmFingerScroll(priv);
+	else {
+		CARD32 ms = GetTimeInMillis();
+		int taptime = 2 * common->wcmGestureParameters.wcmTapTime;
+
+		if (ds[0].proximity && ds[1].proximity &&
+		    (taptime < (ms - ds[0].sample)) &&
+		    (taptime < (ms - ds[1].sample)))
+		{
+			/* scroll should be considered first since it requires
+			 * a finger distance check */
+			wcmFingerScroll(priv);
 
-		if (!(common->wcmGestureMode & GESTURE_SCROLL_MODE))
-		    wcmFingerZoom(priv);
+			if (!(common->wcmGestureMode & GESTURE_SCROLL_MODE))
+				wcmFingerZoom(priv);
+		}
 	}
 ret:
 	if (!common->wcmGestureMode && !channel && !is_absolute(priv->pInfo))
-- 
1.7.4.1


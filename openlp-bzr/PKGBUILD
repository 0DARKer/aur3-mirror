# Contributor: Garrett <http://floft.net/contact>
pkgname=openlp-bzr
pkgver=1418
pkgrel=1
pkgdesc="Church presentation software (development version)."
arch=('i686' 'x86_64')
url='http://openlp.org/'
provides=('openlp')
conflicts=('openlp')
license=('GPLv2')
makedepends=('bzr')
depends=('qt' 'python2' 'python2-qt' 'python2-distribute' 'phonon' 'python2-chardet' 'python-lxml' 'python-beautifulsoup' 'python2-sqlalchemy' 'python2-sip' 'python-pysqlite-legacy' 'python2-pyenchant')
optdepends=('openoffice-base: display impress presentations'
            'libreoffice: display impress presentations')
source=(openlp.sh)
md5sums=('4a65e01ff1a2e9379b0a36b38f45af79')
_bzrtrunk=lp:openlp
_bzrmod=openlp

build() {
  cd "${srcdir}"
  
  if [ ! -d ./${_bzrmod} ]; then
    bzr co ${_bzrtrunk} ${_bzrmod}
  else
    bzr up ${_bzrmod}
  fi
  
  [ -d ./${_bzrmod}-build ] && rm -rf ./${_bzrmod}-build
  cp -r ./${_bzrmod} ./${_bzrmod}-build
  
  #build translation stuff
  tdestdir="${srcdir}/${_bzrmod}-build/openlp/i18n"
  tsrcdir="${srcdir}/${_bzrmod}-build/resources/i18n"

  [ -d "$tdestdir" ] || mkdir -p $tdestdir
  cd $tsrcdir

  for f in *.ts; do
    lconvert -i $f -o $tdestdir/${f%%tm}qm
  done

  #build it
  cd "${srcdir}/${_bzrmod}-build"
  python2 setup.py build
  python2 setup.py install --root=${pkgdir}/ --optimize=1
  
  #my little hack to get impress presentations working
  cp $srcdir/openlp.sh $pkgdir/usr/bin/openlp
  chmod +x $pkgdir/usr/bin/openlp
  
  #desktop file
  mkdir -p $pkgdir/usr/share/applications/
  cp resources/openlp.desktop $pkgdir/usr/share/applications/
}

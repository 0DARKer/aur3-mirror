# Maintainer: Nicolas Pouillard <nicolas.pouillard@gmail.com>

pkgname=ttdnsd-git
pkgver=0.8
pkgrel=2
pkgdesc="The Tor TCP DNS Daemon"
arch=('i686' 'x86_64')
# This is the URL in the README, but it is currently broken:
# url="https://www.torproject.org/ttdnsd/"
url="https://gitweb.torproject.org/ioerror/ttdnsd.git"
license=(custom:BSD3)
depends=(tor tsocks)
_gitroot='git://git.torproject.org/ioerror/ttdnsd.git'
_gitrepo='ttdnsd'

build() {
  cd $srcdir

  if [ -d $_gitrepo ]; then
    (cd $_gitrepo && git checkout HEAD && git pull .) || return 1
  else
    git clone $_gitroot $_gitrepo || return 1
  fi
  # echo git checkout "$pkgver"
  # (cd $_gitrepo && git checkout  "$pkgver") || return 1

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  [ -d $_gitrepo-build ] && rm -rf $_gitrepo-build
  cp -r $_gitrepo $_gitrepo-build
  cd $_gitrepo-build

  make || return 1
}

package() {
  cd $srcdir/$_gitrepo-build
  make DESTDIR=$pkgdir install
  cd $pkgdir
  rm -r etc/init.d
  mkdir -p etc/rc.d etc/conf.d
  cp $startdir/ttdnsd.rc etc/rc.d/ttdnsd
  cp $startdir/ttdnsd.conf etc/conf.d/ttdnsd
}

## Original contributor: Nicolas Pouillard <nicolas.pouillard@gmail.com>
## Maintainer: Nathan "Necopinus" <nathan@ecopunk.info>

pkgname=ttdnsd-git
pkgver=20110911
pkgrel=1
pkgdesc="Tor TCP DNS Daemon"
arch=('i686' 'x86_64')
# This is the URL in the README, but it is currently broken:
# url="https://www.torproject.org/ttdnsd/"
url="https://gitweb.torproject.org/ioerror/ttdnsd.git"
license=(custom:BSD3)
depends=(tor tsocks)
source=('ttdnsd.rcd')
sha256sums=('ad430e86cd4db2afee9ae51c7478109d0fe77991b9a62b0de75cd8c5e990d9f8')

            _gitroot='https://git.torproject.org/ioerror/ttdnsd.git'
_gitrepo='ttdnsd'

build() {
  cd $srcdir

  if [ -d $_gitrepo ]; then
    (cd $_gitrepo && git checkout HEAD && git pull .) || return 1
  else
    git clone $_gitroot $_gitrepo || return 1
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  [ -d $_gitrepo-build ] && rm -rf $_gitrepo-build
  cp -r $_gitrepo $_gitrepo-build
  cd $_gitrepo-build

  make || return 1
}

package() {
  cd $srcdir/$_gitrepo-build
  make DESTDIR=$pkgdir install

  mv $pkgdir/etc/default $pkgdir/etc/conf.d
  rm -r $pkgdir/etc/init.d

  sed -i -e 's#/etc/default#/etc/conf.d#g' $pkgdir/etc/conf.d/ttdnsd
  chmod 644 $pkgdir/etc/conf.d/ttdnsd

  mkdir $pkgdir/etc/rc.d
  install -Dm755 $srcdir/ttdnsd.rcd $pkgdir/etc/rc.d/ttdnsd
}

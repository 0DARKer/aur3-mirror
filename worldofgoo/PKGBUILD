# Maintainer: TryA <tryagainprod@gmail.com>
# Contributor: Todd Partridge <toddrpartridge@gmail.com>

pkgname=worldofgoo
_gamepkg="WorldOfGooSetup.1.41.tar.gz"
pkgver=1.41
pkgrel=4
pkgdesc="A physics based puzzle/construction game (requires copy of the full game)"
arch=('i686' 'x86_64')
url="http://www.2dboy.com"
license=('custom')
depends=('mesa' 'sdl_mixer' 'hicolor-icon-theme')
optdepends=('worldofgoo-gootool: for creating and installing fan levels')
install="worldofgoo.install"
source=('WorldOfGoo.desktop')
md5sums=('25080af1fe369a296e15e568f2480124')
_instmd5="f5afa40893d0fbcc37885191404f6d8c"
options=(!strip)

build() {
  cd ${srcdir}
  
  msg "You need a full copy of this game in order to install it"
  msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
  if [[ -f "../${_gamepkg}" ]]; then
    msg "Found game package, installing..."
    ln -fs "../${_gamepkg}" .
  else
    error "Game package not found, please type absolute path to ${_gamepkg}:"
    read pkgpath
    if [[ ! -f "${pkgpath}/${_gamepkg}" ]]; then
      error "Unable to find game package."
      return 1
    else
      msg "Found game package, installing..."
      ln -fs "${pkgpath}/${_gamepkg}" .
    fi
  fi
  if [[ "$(md5sum ${_gamepkg} | awk '{print $1}')" == "${_instmd5}" ]]; then
    bsdtar xf ${_gamepkg}
  else
    error "Invalid checksum, aborting..."
    return 1
  fi

  # data
  mkdir "${pkgdir}/opt"
  cp -r WorldOfGoo "${pkgdir}/opt"

  # patch and link to startup script
  sed -e 's|export LD_LIBRARY_PATH|#export LD_LIBRARY_PATH|' -i "${pkgdir}/opt/WorldOfGoo/WorldOfGoo"
  mkdir -p "${pkgdir}/usr/bin"
  ln -s /opt/WorldOfGoo/WorldOfGoo "${pkgdir}/usr/bin/worldofgoo"

  # icons and desktop launcher
  install -Dm644 ${srcdir}/WorldOfGoo.desktop ${pkgdir}/usr/share/applications/WorldOfGoo.desktop
  for i in 16x16 22x22 32x32 48x48 64x64 128x128; do
    mkdir -p "${pkgdir}/usr/share/icons/hicolor/${i}/apps"
    ln -s /opt/WorldOfGoo/icons/${i}.png "${pkgdir}/usr/share/icons/hicolor/${i}/apps/WorldOfGoo.png"
  done
  mkdir -p "${pkgdir}/usr/share/icons/hicolor/scalable/apps"
  ln -s /opt/WorldOfGoo/icons/scalable.svg "${pkgdir}/usr/share/icons/hicolor/scalable/apps/WorldOfGoo.svg"

  # license
  mkdir -p "${pkgdir}/usr/share/licenses/worldofgoo"
  ln -s /opt/WorldOfGoo/eula.txt "${pkgdir}/usr/share/licenses/worldofgoo"
}

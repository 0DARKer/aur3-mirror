# Contributor: M0Rf30
pkgname=xplico
pkgver=1.0.1
pkgrel=2
arch=(i686 x86_64)
pkgdesc="Internet Traffic Decoder. Network Forensic Analysis Tool (NFAT)"
url="http://www.xplico.org/"
license=('GPL')
depends=('libpcap' 'sqlite3' 'sox' 'lame' 'perl' 'apache' 'php' 'php-sqlite' 'php-apache' 'php-pear' 'perl' 'libnet' 'recode' 'python-httplib2' 
'libmysqlclient' 'ndpi-svn')

optdepends=('ghostpdl: reconstruct document printed with network printer'
	    'videosnarf: decode VoIP based on RTP')
source=(http://downloads.sourceforge.net/xplico/$pkgname-$pkgver.tgz
	xplico.conf
	dbo_sqlite3.php
	patch
	xplico-fedora.patch
)
install=xplico.install

build() {
    
    cd $srcdir/$pkgname-$pkgver
    patch -Np1 -i ../patch
    patch -Np1 -i ../xplico-fedora.patch
    sed -i 's/NDPI_PROTOCOL_LONG_STRING/NDPI_LAST_IMPLEMENTED_PROTOCOL/g' \
	dissectors/tcp_grbg/tcp_garbage.c dissectors/udp_grbg/udp_garbage.c 
#    msg "Updating the GeoLite City database..."
#    if [ -e GeoLiteCity.dat.gz ]; then 
#      gunzip -f GeoLiteCity.dat.gz;
#    else
#      wget -N http://geolite.maxmind.com/download/geoip/database/GeoLiteCity.dat.gz
#    fi
    make -j1
}

package() {
    cd $srcdir/$pkgname-$pkgver
    make DESTDIR=$pkgdir install    
    install -Dp $srcdir/$pkgname.conf $pkgdir/etc/httpd/conf/extra/httpd-$pkgname.conf
    cp ../dbo_sqlite3.php $pkgdir/opt/xplico/xi/app/plugins/datasources/models/datasources/dbo
    cd $pkgdir
    rm -r etc/apache2
#    rm -r opt/xplico/xi/{cake,plugins,vendors}
#    ln -s -r /srv/http/cakephp/{cake,plugins,vendors} $pkgdir/opt/xplico/xi
}

md5sums=('b95919ce650e8820272c5271c162790d'
         '5f6e539d24956574cbbc9aa34af8ff4e'
         '0c4a566ebfc704ace949a2cb06680599'
         'ab138bc09e9247fac98f49ab33865af1'
         '6caf7073063d51dfe2a205ca886ef54a')

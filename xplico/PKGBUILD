# Contributor: M0Rf30
pkgname=xplico
pkgver=1.0.1
pkgrel=3
arch=(i686 x86_64)
pkgdesc="Internet Traffic Decoder. Network Forensic Analysis Tool (NFAT)"
url="http://www.xplico.org/"
license=('GPL')
depends=('libpcap' 'sqlite3' 'sox' 'lame' 'perl' 'apache' 'php' 'php-sqlite' 'php-apache' 'php-pear' 'perl' 'libnet' 'recode' 'python-httplib2' 
'libmysqlclient' 'ndpi')

optdepends=('ghostpdl: reconstruct document printed with network printer'
	    'videosnarf: decode VoIP based on RTP')
source=(http://downloads.sourceforge.net/xplico/$pkgname-$pkgver.tgz
	xplico-1.0.1-patch-001
	xplico-1.0.1-patch-002
	session_mng.pyc
	mimedump.pyc
	httpd-xplico.conf
	dbo_sqlite3.php)
install=xplico.install

build() {
    
    cd $srcdir/$pkgname-$pkgver
    if [ -e manipulators/mwmail/__pycache__ ]; then
      rm -rf manipulators/mwmail/__pycache__
    fi
    for i in `find . | grep pyc`; do
      rm $i;
    done

    python3 -m compileall manipulators/mwmail
    cd manipulators/mwmail/__pycache__
    for i in `ls .`; do
      cp $i ../$(echo $i | sed 's/cpython-33\.//g');
    done
    cd $srcdir/$pkgname-$pkgver
    sed 's/pycmpl pth/ /g' -i manipulators/mwmail/Makefile
    patch -Np1 -i ../xplico-1.0.1-patch-001
    patch -Np1 -i ../xplico-1.0.1-patch-002
    make -j1
}

package() {
    cd $srcdir/$pkgname-$pkgver
    cp ../session_mng.pyc system/script/session_mng.pyc
    cp ../mimedump.pyc system/script/mimedump.pyc
    make DESTDIR=$pkgdir install    
    cp ../dbo_sqlite3.php $pkgdir/opt/xplico/xi/app/plugins/datasources/models/datasources/dbo
    install -Dp ../httpd-$pkgname.conf $pkgdir/etc/httpd/conf/extra/httpd-$pkgname.conf    
    cd $pkgdir
    rm -r etc/apache2
    rm -f opt/xplico/xplico.db

}

md5sums=('b95919ce650e8820272c5271c162790d'
         '1500b49f37895723e589c55cd63c4944'
         'a15ec9ab6ccc1846c369ea15335950a5'
         '06a0d8ddf8ed187593c00b61f7ca2619'
         'b83f770af99e242b602adf5b0d709b32'
         'c41cca8d497a777fcfee8f0e027b0da9'
         '0c4a566ebfc704ace949a2cb06680599')

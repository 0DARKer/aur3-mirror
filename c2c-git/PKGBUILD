
# Maintainer: Jordy van Wolferen <jordy@kluisip.nl>

pkgname=c2c-git
_pkgbase=c2c
pkgver=r521.a5c4d26
pkgrel=1
pkgdesc="C2 compiler"
arch=('i686' 'x86_64')
url="http://c2lang.org"
license=('Apache')
depends=()
makedepends=('git' 'llvm-c2')
source=("c2compiler::git+git://github.com/c2lang/c2compiler.git#branch=master")
md5sums=('SKIP')

build() {
  cd "$srcdir"/c2compiler/c2c

  # force llvm-c2, if llvm is installed
  [ -f /usr/bin/llvm-config ] && export PATH=/opt/llvm-c2/bin:$PATH

  # fix Makefile to use llvm-c2
  sed -i 's/llvm-config/\/opt\/llvm-c2\/bin\/llvm-config/g' Makefile

  cd "$srcdir"/c2compiler/tools/tester
  make

  cd "$srcdir"/c2compiler/tools/xml2dot
  make

  cd "$srcdir"/c2compiler/c2c
  make
  make test
}

package() {
  cd "$pkgdir"
  mkdir -p etc/profile.d
  echo 'export PATH=$PATH:/opt/c2c/bin' > etc/profile.d/${_pkgbase}.sh
  chmod 775 etc/profile.d/${_pkgbase}.sh

  mkdir -p opt/c2c/bin
  mkdir -p opt/c2c/doc
  mkdir -p opt/c2c/output

  chmod 777 opt/c2c/output

  cd opt/c2c/bin

  cp "$srcdir"/c2compiler/c2c/c2c .
  cp "$srcdir"/c2compiler/tools/tester/tester .
  cp "$srcdir"/c2compiler/tools/xml2dot/xml2dot dot

  cd "$pkgdir"/opt/c2c
  cp -r "$srcdir"/c2compiler/c2c/examples .
  cp "$srcdir"/c2compiler/c2c/recipe.txt .
  cp "$srcdir"/c2compiler/*.md doc
}


pkgver() {
  cd "$srcdir"/c2compiler/c2c
  echo r$(git rev-list --count master).$(git rev-parse --short master)
}

# vim:set ts=2 sw=2 et:

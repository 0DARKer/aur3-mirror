# $Id$
# Contributor: Thijs Vermeir <thijsvermeir@gmail.com>

pkgname=jhbuild-git
pkgver=20130210
pkgrel=1
pkgdesc="\
  Jhbuild is a program that can be used to pull a number of modules from CVS \
  and build them in the correct order. \
  Unlike some build scripts, jhbuild lets you specify what modules you want \
  built and it will then go and build those modules plus dependencies."
arch=("i686" "x86_64")
license=('GPL')
depends=('python2')
provides=('jhbuild')
conflicts=('jhbuild')
makedepends=('autoconf' 'automake' 'libtool' 'gettext' 'pkgconfig' 'rsync' 'subversion'
'gnome-common-git' 'git' 'intltool' 'gnome-doc-utils' 'yelp-tools' 'cvs' 'ragel' 'gperf'
'docbook-xsl' 'gypsy' 'libgphoto2')
source=('use_python2_when_building_modules.patch')
md5sums=('513d174321c3d772423502e00b3034cf')
url="http://www.jamesh.id.au/software/jhbuild/"

_gitroot="git://git.gnome.org/jhbuild"
_gitname="jhbuild"

build() {
  cd ${srcdir}

  msg "Connecting to GIT server..."
  if [[ -d ${_gitname} ]]; then
    (cd ${_gitname} && git pull origin)
  else
    git clone ${_gitroot} ${_gitname}
  fi
  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf ${_gitname}-build
  git clone ${_gitname} ${_gitname}-build

  cd ${srcdir}/${_gitname}-build

  patch -p1 < ../use_python2_when_building_modules.patch
  ./autogen.sh --prefix=/usr PYTHON=/usr/bin/python2
  make
}
package() {
  cd ${srcdir}/${_gitname}-build

  make DESTDIR="$pkgdir" install
  install -d "$pkgdir/usr/share/jhbuild"
  cp -dr modulesets "$pkgdir/usr/share/jhbuild"
  sed -ir '1 s/python/python2/' "$pkgdir/usr/bin/jhbuild"

  # prevent JHBuild from complaining that python.pc is not found
  install -d "$pkgdir/usr/lib/pkgconfig"
  ln -sr "$pkgdir/usr/lib/pkgconfig/python-2.7.pc" "$pkgdir/usr/lib/pkgconfig/python.pc"
}

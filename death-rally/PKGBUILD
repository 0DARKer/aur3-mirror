# Contributor: Jens Staal <staal1978@gmail.com>

pkgname="death-rally"
pkgver="1.0"
pkgrel=1
pkgdesc="A free windows port of the classic racing game from Abandonia, played in Wine."
url='http://www.abandonia.com/en/games/28518/Death+Rally.html'
arch=('i686' 'x86_64')
license=('custom-freeware' 'Abandonware')
install='death-rally.install'
depends=('wine' 'unionfs-fuse')
optdepends=('abandonia-menu')
source=('http://www.remedygames.com/files/DeathRallyWin_10.exe')
md5sums=('81584602e6f809817e62cbce89178727')
_pkgabbrev="deathrally"
_exe="drive_c/Program (x86)/Death Rally/dr.exe"
_icon="drive_c/Program (x86)/Death Rally/DR.ICO"

build() {
	mkdir -p -m755 "$pkgdir/opt/" 
	mkdir -p -m755 "$pkgdir/opt/abandonia" 
	mkdir -p -m755 "$pkgdir/opt/abandonia/$_pkgabbrev" 

	WINEARCH=win32 WINEPREFIX=$pkgdir/opt/abandonia/$_pkgabbrev wine $srcdir/DeathRallyWin_10.exe

	#ok, let's use a script to start the game
        #script also include union mount in order to enable multi-user playing of this game from a single install.

	mkdir -p -m755 /$pkgdir/usr/bin/ 

	printf "#!${SHELL}
		mkdir /~.$_pkgabbrev
		mkdir /~.$_pkgabbrev.tmp
		unionfs -o cow -o umask=000 ~/.$_pkgabbrev=RW:/opt/abandonia/$_pkgabbrev=RO ~/.$_pkgabbrev.tmp
		WINEARCH=win32 WINEPREFIX=~/.$_pkgabbrev.tmp wine ~/.$_pkgabbrev.tmp/$_exe
		fusermount -u ~/.$_pkgabbrev.tmp
	" >> /$pkgdir/usr/bin/$_pkgabbrev.sh 

	chmod +x /$pkgdir/usr/bin/$_pkgabbrev.sh 
	ln -s $_pkgabbrev.sh /$pkgdir/usr/bin/$_pkgabbrev 

	# Automatic generation of a .desktop file

	mkdir -p -m644 "$pkgdir/usr/share/" 
	mkdir -p -m644 "$pkgdir/usr/share/applications/" 

	printf "[Desktop Entry]
Version=$pkgver
Type=Application
Name=$pkgname
Comment=$pkgdesc
Exec=/usr/bin/$_pkgabbrev
Icon=/opt/abandonia/$_pkgabbrev/$_icon
Categories=Game;Abandonia;
Terminal=false
StartupNotify=false" >> /$pkgdir/usr/share/applications/$_pkgabbrev.desktop

} 

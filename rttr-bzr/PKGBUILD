# Maintainer: Qhor Vertoe <vertoe at qhor dot net>
# Contributor: Mineo  <themineo+aur at gmail dot com>

pkgname=rttr-bzr
pkgver=9472
pkgrel=4
pkgdesc="Return to the Roots is a remake of Blue Bytes 'The Settlers II'."
arch=('i686' 'x86_64')
url="http://rttr.info/"
license=('GPL')
depends=('curl' 'libgl' 'bzip2' 'miniupnpc' 'sdl_mixer' 'lua')
makedepends=('bzr' 'cmake')

_bzrtrunk=lp:s25rttr
_bzrmod=s25rttr
_s2files=/opt/S2/

prepare() {
  echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
  echo "Attention: This requires the original Settlers 2 game files in /opt/S2/."
  echo "    Please make sure you have them located there or modify the PKGBUILD."
  echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
}

build() {
  cd "$srcdir"
  echo "Connecting to Bazaar server...."

  if [[ -d "$_bzrmod" ]]; then
    cd "$_bzrmod" && bzr pull "$_bzrtrunk" -r "$pkgver"
    echo "The local files are updated."
  else
    bzr branch "$_bzrtrunk" "$_bzrmod" -r "$pkgver"
  fi

  # Fix CMakeLists
  sed -i '10,13d' $srcdir/$_bzrmod/s-c/src/CMakeLists.txt
  sed -i '9,12d' $srcdir/$_bzrmod/s-c/resample-1.8.1/src/CMakeLists.txt
  sed -i '57,60d' $srcdir/$_bzrmod/s25update/src/CMakeLists.txt
  sed -i '477i\IF \( NOT EXISTS \"\$\{LUA\_LIB\}\" \)' $srcdir/$_bzrmod/src/CMakeLists.txt
  sed -i '478i\  SET\(LUA_LIB \"\/usr\/lib\/liblua.so\"\)' $srcdir/$_bzrmod/src/CMakeLists.txt
  sed -i '479i\  ADD\_FLAGS\(CMAKE\_C\_FLAGS \-I\/usr\/include\/\)' $srcdir/$_bzrmod/src/CMakeLists.txt
  sed -i '480i\  ADD\_FLAGS\(CMAKE\_CXX\_FLAGS \-I\/usr\/include\/\)' $srcdir/$_bzrmod/src/CMakeLists.txt
  sed -i '481i\ENDIF \( NOT EXISTS \"\$\{LUA\_LIB\}\" \)' $srcdir/$_bzrmod/src/CMakeLists.txt

  echo "Bazaar checkout done or server timeout"
  echo "Starting build..."

  cp -rf "$srcdir/$_bzrmod" "$srcdir/$_bzrmod-build"
  cd "$srcdir/$_bzrmod-build/build"

  ./cmake.sh -DCMAKE_INSTALL_PREFIX=/usr --prefix=/usr
  make -j $(nproc)
}

package() {
  cd "$srcdir/$_bzrmod-build/build"
  make DESTDIR="$pkgdir/" install
  cp -rv "$_s2files/" "$pkgdir/usr/share/s25rttr/"

  rm -rf "$pkgdir/dbg"
  rm -f "$pkgdir/usr/lib/libminiupnpc.so*"
}

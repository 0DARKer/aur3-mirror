# Maintainer: Bruno Pagani (a.k.a. ArchangeGabriel) <bruno.n.pagani at gmail dot com>

pkgname=thunderbird-nightly-fr
pkgdesc="Standalone Mail/News reader from Mozilla - Nightly build"
url="http://www.mozilla.org/thunderbird"
#pkgver=38.0a1.20150113
pkgver=38.0a1
pkgrel=1
arch=('i686' 'x86_64')
license=('MPL' 'GPL' 'LGPL')
depends=('alsa-lib' 'dbus-glib' 'desktop-file-utils' 'gtk2' 'libxt' 'nss')
#depends=('cairo' 'fontconfig' 'freetype2' 'hicolor-icon-theme' 'hunspell' 'libevent' 'libjpeg' 'libmng' 'libpng' 'libvpx' 'mozilla-common' 'nspr' 'shared-mime-info' 'sqlite' 'startup-notification')
#optdepends=('libcanberra: for sound support')
source=('thunderbird-nightly.desktop')
sha512sums=('25f1e7a04ff5cf9615cf5c50109179676bb3643ca0c98a45bcd2169e15d8f1b1cd3327c6cba26316e46b85f45acac2153d91522fb117004bdbf78a8ec7102cef')
install=thunderbird-nightly.install
#_version=38.0a1

#pkgver(){
#  FX_SRC="thunderbird-${_version}.fr.linux-${CARCH}.txt"
#  FX_SRC_URI="http://ftp.mozilla.org/pub/mozilla.org/thunderbird/nightly/latest-comm-central/${FX_SRC}"
#  msg "Getting last nightly date..."
#  curl -ORz ${FX_SRC} ${FX_SRC_URI}
#  echo "${_version}.$(head -n1 ${FX_SRC} | cut -c -8)"
#
#}

package() {
  TB_BASE="thunderbird-${pkgver}.fr.linux-${CARCH}"
  TB_SRC="${TB_BASE}.tar.bz2"
  TB_CHECKSUM="${TB_BASE}.checksums"
  TB_GPG="${TB_BASE}.checksums.asc"
  TB_BASE_URI="https://ftp.mozilla.org/pub/mozilla.org/thunderbird/nightly/latest-comm-central-l10n/"
  TB_SRC_URI="${TB_BASE_URI}/${TB_SRC}"
  TB_CHECKSUM_URI="${TB_BASE_URI}/${TB_CHECKSUM}"
  TB_GPG_URI="${TB_BASE_URI}/${TB_GPG}"

  msg "Downloading..."
  curl -OR ${TB_SRC_URI}
  curl -OR ${TB_CHECKSUM_URI}
  curl -OR ${TB_GPG_URI}
  msg "Verifying SHA512 checksum..."
  grep ${TB_SRC} ${TB_CHECKSUM} | grep sha512 | sed 's/sha512\ [0-9]*\ //' > sha512
  sha512sum -c sha512
  # Uncomment the following lines to enable GnuPG signature verification. You’ll need Thunderbird’s GnuPG release key.
  #  msg "Verifying GnuPG signature..."
  #  gpg --verify ${FX_GPG}
  msg "Extracting..."
  bsdtar -x -f ${TB_SRC}
  msg "Packaging..."
  install -d "${pkgdir}"/{usr/bin,opt}

  cp -r thunderbird "${pkgdir}/opt/thunderbird-nightly"
  ln -s /opt/thunderbird-nightly/thunderbird "${pkgdir}/usr/bin/thunderbird-nightly"

  # Install icons
  for i in 16 22 24 32 48 256; do
      install -Dm644 thunderbird/chrome/icons/default/default${i}.png "${pkgdir}/usr/share/icons/hicolor/${i}x${i}/apps/thunderbird-nightly.png"
  done
  
  install -Dm644 thunderbird-nightly.desktop "$pkgdir/usr/share/applications/thunderbird-nightly.desktop" 

  # Use system-provided dictionaries
  rm -rf "${pkgdir}/opt/thunderbird-nightly"/{dictionaries,hyphenation}
  ln -sf /usr/share/hunspell "${pkgdir}/opt/thunderbird-nightly/dictionaries"
  ln -sf /usr/share/hyphen "${pkgdir}/opt/thunderbird-nightly/hyphenation"
}

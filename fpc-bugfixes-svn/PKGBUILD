# Maintainer: cuihao <cuihao.leo@gmail.com>
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: Valeriy Lyasotskiy <onestep@ukr.net>
# Contributor: Jan Willemson <janwil@hot.ee>
# Contributor: Hugo Ideler <hugoideler@dse.nl>
# Contributor: Kandu <1123monkey+arch@gmail.com>
# Original PKGBUILD: Andre Naumann <anaumann@SPARCed.org>
# See http://bbs.archlinux.org/viewtopic.php?t=9318&highlight=fpc

pkgbase=fpc-bugfixes-svn
pkgname=fpc-bugfixes-svn
true && pkgname=('fpc-bugfixes-svn-src' 'fpc-bugfixes-svn')
pkgver=2.5.1
pkgrel=1
pkgdesc="The Free Pascal Compiler is a Turbo Pascal 7.0 and Delphi compatible 32bit Pascal Compiler. It comes with fully TP 7.0 compatible run-time library. This is the latest version of the fixes branch. Source package included."
arch=('i686' 'x86_64')
url="http://www.freepascal.org/"
license=('GPL' 'LGPL' 'custom')
makedepends=(fpc)

_svnurl=http://svn.freepascal.org/svn/fpcbuild/branches/fixes_2_6/
_svnmod=fpcbuild

build() {
    if [ -d $srcdir/$_svnmod/.svn ]; then
        (cd $srcdir/$_svnmod && svn up)
    else
        svn co $_svnurl $srcdir/$_svnmod
    fi

    msg "SVN checkout done or server timeout"
    msg "Starting make..."
}

package_fpc-bugfixes-svn-src() {
    provides=(fpc-src=$pkgver)
    conflicts=(fpc-src)
    options=('!strip')

    cd $srcdir/$_svnmod/fpcsrc
    mkdir -p $pkgdir/usr/lib/fpc/src
    cp -R . $pkgdir/usr/lib/fpc/src
    find ${pkgdir}/usr/lib/fpc/src -type d -name .svn | xargs rm -rf
}

package_fpc-bugfixes-svn() {
    depends=(ncurses)
    provides=(fpc=$pkgver)
    conflicts=(fpc)
    backup=("etc/fpc.cfg")
    options=(zipman)

    cd $srcdir/$_svnmod
    sed -i "s/fpcmkcfg -p/fpcmkcfg/" $srcdir/$_svnmod/fpcsrc/compiler/utils/samplecfg || return 1
    sed -i "s/\[ -f \"\$FPBIN\" \]/\[ 1 -eq 0 \]/" $srcdir/$_svnmod/fpcsrc/compiler/utils/samplecfg || return 1
    make NOGDB=1 build || return 1
    make NOGDB=1 PREFIX=${pkgdir}/usr install || return 1
    
    # install package license
    install -m 755 -d $pkgdir/usr/share/licenses/$pkgbase
    install -m 644 fpcsrc/rtl/COPYING.FPC $pkgdir/usr/share/licenses/$pkgname/
    
    # create symlink for compiler
    [ "$CARCH" = "i686" ] && ln -s /usr/lib/fpc/$pkgver/ppc386 $pkgdir/usr/bin/
    [ "$CARCH" = "x86_64" ] && ln -s /usr/lib/fpc/$pkgver/ppcx64 $pkgdir/usr/bin/
    
    # install sample config file
    mkdir -p $pkgdir/etc
    $pkgdir/usr/lib/fpc/$pkgver/samplecfg /usr/lib/fpc/$pkgver $pkgdir/etc
    
    mv $pkgdir/usr/man $pkgdir/usr/share/
}



# Maintainer: Dan Serban
# Contributors: Charles Ghislain, Guillaume ALAUX, Daniel J Griffiths, Jason Chu, Geoffroy Carrier, Army, kfgz, Thomas Dziedzic

pkgname=jre
pkgver=7
pkgrel=1
pkgdesc="Java 7 Runtime Environment"
url=http://www.oracle.com/technetwork/java/javase/downloads/index.html
arch=(i686 x86_64)
license=(custom)
depends=(desktop-file-utils libxtst shared-mime-info xdg-utils)
makedepends=(lynx)
provides=('java-runtime=7')
conflicts=(java-runtime)
install=jre.install
source=('java-policy-settings.desktop'
        'jre.profile'
        'jre.profile.csh'
        'javaws-launcher')
md5sums=('6614b04176b9b7dfe26f22e9ce846801'
         '7cd3dc10e7a37468cad4053a067dcd01'
         'cc90df2df6fe80fab885a80036d420a1'
         '45c15a6b4767288f2f745598455ea2bf')
_arch=i586
[ "${CARCH}" == 'x86_64' ] && _arch=x64

build()
{
  rm jdk.tar.gz 2>/dev/null || true
  _url=$(lynx -dump http://www.oracle.com/technetwork/java/javase/downloads/index.html | grep -o http.*downloads/jdk-7u[0-9]*-download.*html | head -1)
  _url=$(wget -qO - ${_url} | grep -o http.*-linux-${_arch}.tar.gz)
  wget -O jdk.tar.gz "${_url}"
  msg "Extracting..."
  bsdtar -xf jdk.tar.gz
  msg "Packaging..."
  mkdir -p "${pkgdir}"/opt/java
  cd $(ls -1d jdk1.7.0_*/ | tail -1)
  mv jre "${pkgdir}"/opt/java/
  mkdir -p "${pkgdir}"/usr/share
  mv "${pkgdir}"/opt/java/jre/lib/desktop/icons "${pkgdir}"/usr/share/
  mv "${pkgdir}"/opt/java/jre/lib/desktop/applications "${pkgdir}"/usr/share/
  mkdir -p "${pkgdir}"/usr/share/applications
  install -Dm644 "${startdir}"/java-policy-settings.desktop "${pkgdir}"/usr/share/applications/java-policy-settings.desktop
  mv "${pkgdir}"/opt/java/jre/lib/desktop/mime "${pkgdir}"/usr/share/
  rm -r "${pkgdir}"/opt/java/jre/plugin/desktop
  rm -r "${pkgdir}"/opt/java/jre/lib/desktop
  install -Dm644 "${startdir}"/jre.profile "${pkgdir}"/etc/profile.d/jre.sh
  install -Dm644 "${startdir}"/jre.profile.csh "${pkgdir}"/etc/profile.d/jre.csh
  mkdir -p "${pkgdir}"/usr/lib/mozilla/plugins
  [ "$CARCH" == "i686" ] && ln -s /opt/java/jre/lib/i386/libnpjp2.so "${pkgdir}"/usr/lib/mozilla/plugins/libnpjp2.so
  [ "$CARCH" == "x86_64" ] && ln -s /opt/java/jre/lib/amd64/libnpjp2.so "${pkgdir}"/usr/lib/mozilla/plugins/libnpjp2.so
  mkdir -p "${pkgdir}"/usr/share/licenses/jre
  install -Dm644 "${pkgdir}"/opt/java/jre/COPYRIGHT "${pkgdir}"/usr/share/licenses/jre/COPYRIGHT
  install -Dm644 "${pkgdir}"/opt/java/jre/LICENSE "${pkgdir}"/usr/share/licenses/jre/LICENSE
  install -Dm644 "${pkgdir}"/opt/java/jre/THIRDPARTYLICENSEREADME.txt "${pkgdir}"/usr/share/licenses/jre/THIRDPARTYLICENSEREADME.txt
  install "${startdir}"/javaws-launcher "${pkgdir}"/opt/java/jre/bin/javaws-launcher
  sed -e 's/Exec=javaws/&-launcher %f/' -e '/NoDisplay=true/d' -i "${pkgdir}"/usr/share/applications/sun-javaws.desktop
  mkdir -p "${pkgdir}"/etc/.java/.systemPrefs
}


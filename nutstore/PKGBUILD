# Maintainer: Bhoppi Chaw <bhoppi hotmail com>

pkgname=nutstore
pkgver=0.2.0
pkgrel=3
pkgdesc='a cloud service that lets you sync and share files anywhere.'
arch=('i686' 'x86_64')
url='https://jianguoyun.com/'
license=('GPL')
depends=('glib2'
         'gtk2'
         'java-runtime'
         'nautilus'
         'python2')
makedepends=('wget')
options=('!libtool' '!emptydirs')
install='nutstore.install'
source=("https://jianguoyun.com/static/exe/installer/${pkgname}_linux_src_installer.tar.gz")

_arch='x86'
[ $CARCH = "x86_64" ] && _arch='x64'

build()
{
    cd $srcdir/${pkgname}_linux_src_installer
    ./configure --disable-static || return 1
    make || return 1
    
    # fetch executable
    wget --no-check-certificate --user-agent=NutstoreLinuxDownloader -O ./nutstore_linux_dist.tar.gz\
        https://jianguoyun.com/static/exe/installer/nutstore_linux_dist_$_arch.tar.gz || return 1
    mkdir -p opt/nutstore && cd opt/nutstore
    tar xvf ../../nutstore_linux_dist.tar.gz
    # polish to make it usable & global
    sed -i -e '1s/python/python2/' bin/nutstore-pydaemon.py
    cd gnome-config
    sed -i -e '/Exec=/s,~/\.nutstore/dist,/opt/nutstore,' menu/nutstore-menu.desktop autostart/nutstore-daemon.desktop
    sed -i -e '/OnlyShowIn=/d' menu/nutstore-menu.desktop autostart/nutstore-daemon.desktop
}

package()
{
    cd $srcdir/${pkgname}_linux_src_installer
    make DESTDIR=$pkgdir install
    cp opt $pkgdir -aR
    install -D -m 644 opt/nutstore/gnome-config/menu/nutstore-menu.desktop\
        $pkgdir/usr/share/applications/nutstore-menu.desktop
}
md5sums=('366077e5243632bbad3e1d1a43648526')

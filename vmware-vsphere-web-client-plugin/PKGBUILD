# Contributor: ReNoM <renom@list.ru>
pkgname=vmware-vsphere-web-client-plugin
pkgver=5.5.0
pkgrel=1
pkgdesc="Firefox and Chromium plugin, to access virtual machines console from vSphere Web Client. For make package, place VMware-ClientIntegrationPlugin-5.5.0.{your_arch}.bundle to PKGBUILD directory."
arch=('i686' 'x86_64')
url="http://www.vmware.com/"
license=('custom:vmware')
depends=(mozilla-common chromium-pepper-flash)
optdepends=(
'freshplayerplugin-git: for Mozilla Firefox support'
'chromium-npapi: for Chromium support'
)
majver=5.5
[ "$CARCH" == "i686" ] && source=(VMware-ClientIntegrationPlugin-${pkgver}.i386.bundle) && bundle_arch=i386 && larch=32
[ "$CARCH" == "x86_64" ] && source=(VMware-ClientIntegrationPlugin-${pkgver}.x86_64.bundle) && bundle_arch=x86_64 && larch=64

[ "$CARCH" == "i686" ] && md5sums=('605be0179c0151c078a13d11b3f3b3f4')
[ "$CARCH" == "x86_64" ] && md5sums=('fd1b04125ac2483554efa705d96d7a25')

build() {
  cd "$srcdir"
  sh ../VMware-ClientIntegrationPlugin-${pkgver}.${bundle_arch}.bundle -x files
}

package ()
{
	cd "$pkgdir"
	mkdir -p usr/lib/vmware-cip/${majver}/
	mkdir -p usr/lib/vmware-vmrc/${majver}/
	mkdir -p usr/lib${larch}/mozilla/plugins
	mkdir -p etc/vmware-vmrc/${majver}
	echo "libdir = \"/usr/lib/vmware-vmrc/$majver\"" > etc/vmware-vmrc/${majver}/config
	# install cip
	install ${srcdir}/files/vmware-cip-55/npVMwareClientSupportPlugin-5-5-0.so "usr/lib/vmware-cip/$majver/"
	mv "$srcdir/files/vmware-cip-55/artwork" "usr/lib/vmware-cip/$majver/"
	mv "$srcdir/files/vmware-cip-55/filetransfer" "usr/lib/vmware-cip/$majver/"
	chmod +x "usr/lib/vmware-cip/$majver/filetransfer/fileTransfer"
	mv "$srcdir/files/vmware-cip-55/ovftool" "usr/lib/vmware-cip/$majver/"
	chmod +x "usr/lib/vmware-cip/$majver/ovftool/ovftool"
	chmod +x "usr/lib/vmware-cip/$majver/ovftool/ovftool.bin"
	ln -s "/usr/lib/vmware-cip/$majver/npVMwareClientSupportPlugin-5-5-0.so" "usr/lib$larch/mozilla/plugins/npVMwareClientSupportPlugin-5-5-0.so"
	# install vmrc
	install "$srcdir/files/vmware-vmrc-$majver/np-vmware-vmrc-$pkgver-1601065-32.so" "usr/lib/vmware-vmrc/$majver/"
	install "$srcdir/files/vmware-vmrc-$majver/np-vmware-vmrc-$pkgver-1601065-64.so" "usr/lib/vmware-vmrc/$majver/"
	install "$srcdir/files/vmware-vmrc-$majver/np-vmware-vmrc.so" "usr/lib/vmware-vmrc/$majver/"
	install "$srcdir/files/vmware-vmrc-$majver/open_source_licenses.txt" "usr/lib/vmware-vmrc/$majver/"
	install "$srcdir/files/vmware-vmrc-$majver/version.txt" "usr/lib/vmware-vmrc/$majver/"
	install "$srcdir/files/vmware-vmrc-$majver/vmware-desktop-entry-creator" "usr/lib/vmware-vmrc/$majver/"
	mv "$srcdir/files/vmware-vmrc-$majver/bin" "usr/lib/vmware-vmrc/$majver/"
	chmod -R +x "usr/lib/vmware-vmrc/$majver/bin/"
	mv "$srcdir/files/vmware-vmrc-$majver/lib" "usr/lib/vmware-vmrc/$majver/"
	mv "$srcdir/files/vmware-vmrc-$majver/libconf" "usr/lib/vmware-vmrc/$majver/"
	mv "$srcdir/files/vmware-vmrc-$majver/share" "usr/lib/vmware-vmrc/$majver/"
	mv "$srcdir/files/vmware-vmrc-$majver/xkeymap" "usr/lib/vmware-vmrc/$majver/"
	ln -s /usr/lib/vmware-vmrc/${majver}/np-vmware-vmrc-${pkgver}-1601065-${larch}.so usr/lib${larch}/mozilla/plugins/np-vmware-vmrc-${pkgver}-1601065-${larch}.so
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/appLoader usr/lib/vmware-vmrc/${majver}/bin/vmware-deviceMgr
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/appLoader usr/lib/vmware-vmrc/${majver}/bin/vmware-vmrc
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/appLoader usr/lib/vmware-vmrc/${majver}/bin/vmware-vmrc-daemon
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/vmware-deviceMgr usr/lib/vmware-vmrc/${majver}/vmware-deviceMgr
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/vmware-vmrc usr/lib/vmware-vmrc/${majver}/vmware-vmrc
	ln -s /usr/lib/vmware-vmrc/${majver}/bin/vmware-vmrc-daemon usr/lib/vmware-vmrc/${majver}/vmware-vmrc-daemon
}


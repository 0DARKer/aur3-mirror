# Maintainer: Zhengyu Xu <xzy3186@gmail.com>
#options for different desktop integration
_DESKTOP=0

###################################
# 1 --> gnome-shell (nautilus)    #
# 2 --> cinnamon (nemo)           #
# 3 --> KDE (dolphin)             #
# 4 --> xfce (thunar)             #
# 5 --> mate (caja)               #
# 6 --> other1 (with nautilus)    #
# 7 --> other2 (without nautilus) #
###################################

########################################################################
# DESKTOP auto-detection for different desktop environment             #
# It will be disabled if you set _DESKTOP manually above               #
########################################################################
if [ $_DESKTOP -eq 0 ]
then
   if ps -A | grep 'gnome-shell' > /dev/null
   then
      _DESKTOP=1
   fi
   if ps -A | grep 'cinnamon' > /dev/null
   then
      _DESKTOP=2
   fi
   if ps -A | grep 'kded4' > /dev/null
   then
      _DESKTOP=3
   fi
   if ps -A | grep 'Thunar' > /dev/null
   then
      _DESKTOP=4
   fi
   if ps -A | grep 'caja' > /dev/null
   then
      _DESKTOP=5
   fi
fi
if [ $_DESKTOP -eq 0 ]
then
   if ps -A | grep 'nautilus' > /dev/null
   then
      _DESKTOP=6
   else
      _DESKTOP=7
   fi
fi
###########################################################

pkgname=insync
pkgver=0.9.38
pkgrel=1
pkgdesc="An unofficial Google Drive client that runs on Linux, with support for various desktops"
url="https://forums.insynchq.com/discussion/1762/insync-for-linux-beta-15-0-9-38"
license=('custom:insync')
options=(!strip !zipman)
arch=('i686' 'x86_64')

############ other desktop 1 ############
if [ $_DESKTOP -eq 6 ]; then
   depends=('xdotool' 'nautilus' 'python2-nautilus' 'libappindicator3')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_i386.deb")
      sha256sums=('9f67c4b04e74ca9f0044187f9ea2f9d6b4177a5bab127b49b8a9beefb3a8c31a')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_amd64.deb")
      sha256sums=('2f04e18dfe06745050d219b566c59e297909b4f129b3e610652b8f79698cdb31')
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ other desktop 2 ############
if [ $_DESKTOP -eq 7 ]; then
   depends=('xdotool' 'libappindicator3')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_i386.deb")
      sha256sums=('9f67c4b04e74ca9f0044187f9ea2f9d6b4177a5bab127b49b8a9beefb3a8c31a')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_amd64.deb")
      sha256sums=('2f04e18dfe06745050d219b566c59e297909b4f129b3e610652b8f79698cdb31')
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ gnome-shell ############
if [ $_DESKTOP -eq 1 ]; then
   depends=('xdotool' 'nautilus' 'python2-nautilus' 'gnome-shell')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
      sha256sums=('70a56a7252a2002e2073aa8d9893200d6e691dc148888f859d998a1fd1dbe133')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
      sha256sums=('a09d2645fb732e934a06e36e501837c5d035d67b7ea60c0b5742e7afc7595c21')
   fi
   source=("${source[@]}"
   "${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "cd7a7d7b17d890abc722e020baa7077ef2a0a941136fd186f43c9b4ad961f011")
   noextract=("${pkgname}-${pkgver}-common.deb" "${pkgname}-${pkgver}-gnome.deb")
fi
############ cinnamon ############
if [ $_DESKTOP -eq 2 ]; then
   depends=('xdotool' 'nemo-fm' 'nemo-python-git' 'cinnamon')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
      sha256sums=('70a56a7252a2002e2073aa8d9893200d6e691dc148888f859d998a1fd1dbe133')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
      sha256sums=('a09d2645fb732e934a06e36e501837c5d035d67b7ea60c0b5742e7afc7595c21')
   fi
   source=("${source[@]}"
   "${pkgname}-${pkgver}-cinnamon.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "644faaba8e8e83f8c3d2b94bb5797a96627311bb2ced9d19f7f4800574d985ef")
   noextract=("${pkgname}-${pkgver}-common.deb" "${pkgname}-${pkgver}-cinnamon.deb")
fi
############ KDE ############
if [ $_DESKTOP -eq 3 ]; then
   depends=("kdebindings-python2" "xdotool" "kdebase-workspace")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_i386.deb")
      sha256sums=("704b1c6e3c192b916fd0becc79095da2cdc38206b1dfd0eeb466ad3ae5d3aa06")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_amd64.deb")
      sha256sums=("70c88c94fa00c64fa7133bd6a40f3daf660fa8abc7065da2fce2368c0dd5610b")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ xfce ############
if [ $_DESKTOP -eq 4 ]; then
   depends=("xdotool" "libappindicator3" "thunarx-python" "exo")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_i386.deb")
      sha256sums=("8a45161611985c47fca716155646f651783e141ddf7895f61bdb42d9270b9f9a")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_amd64.deb")
      sha256sums=("7aaa4d684a9596b129f3f8ff0dd8ac8ae15ab2b129420fb08398315bb35457db")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ mate ############
if [ $_DESKTOP -eq 5 ]; then
   depends=("xdotool" "libappindicator3" "python-caja" "exo")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_i386.deb")
      sha256sums=("e3665bc5cd3e36c3dc81ecddd19469a4b13266e2b70e7d3c50b21384042a1907")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_amd64.deb")
      sha256sums=("31033ed62003a19186cb3db5b55c0677d8589ee90fac94803d7493edb8f686fe")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
install=$pkgname.install

package() {
   cd $srcdir
   [ -d ${pkgname}-${pkgver}-common ] && rm -r ${pkgname}-${pkgver}-common
   [ -d ${pkgname}-${pkgver}-common ] || mkdir ${pkgname}-${pkgver}-common
   mv ${pkgname}-${pkgver}-common.deb ${pkgname}-${pkgver}-common/
   cd $srcdir/${pkgname}-${pkgver}-common
   ar x ${pkgname}-${pkgver}-common.deb
   tar xvf data.tar.gz
   cp -rp usr $pkgdir

   if [ $_DESKTOP -eq 1 ]; then
      cd $srcdir
      [ -d ${pkgname}-${pkgver}-gnome ] || mkdir ${pkgname}-${pkgver}-gnome
      mv ${pkgname}-${pkgver}-gnome.deb ${pkgname}-${pkgver}-gnome/
      cd $srcdir/${pkgname}-${pkgver}-gnome
      ar x ${pkgname}-${pkgver}-gnome.deb
      tar xvf data.tar.gz
      cd $srcdir/${pkgname}-${pkgver}-gnome
      rm -r $pkgdir/usr/share/applications
      cp -rp usr $pkgdir
   fi
   if [ $_DESKTOP -eq 2 ]; then
      cd $srcdir
      [ -d ${pkgname}-${pkgver}-cinnamon ] || mkdir ${pkgname}-${pkgver}-cinnamon
      mv ${pkgname}-${pkgver}-cinnamon.deb ${pkgname}-${pkgver}-cinnamon/
      cd $srcdir/${pkgname}-${pkgver}-cinnamon
      ar x ${pkgname}-${pkgver}-cinnamon.deb
      tar xvf data.tar.gz
      cp -rp usr $pkgdir
   fi
   if [ $_DESKTOP -eq 6 ]; then
      rm -r ${pkgdir}/usr/share/kde4
   fi
   if [ $_DESKTOP -eq 7 ]; then
      rm -r ${pkgdir}/usr/share/kde4
      rm -r ${pkgdir}/usr/share/nautilus-python
   fi
   cd $pkgdir
   [ -f usr/bin/insync-kde ] && sed -i "s/^python /python2 /" usr/bin/insync-kde
   for file in $(grep -R "/usr/bin/python" . | cut -f1 -d :)
   do
      sed -i "s|usr/bin/python$|usr/bin/python2|g" $file
   done
}


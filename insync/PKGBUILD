# Maintainer: Zhengyu Xu <xzy3186@gmail.com>
#options for different desktop integration

_DESKTOP=0

###################################
# 1 --> gnome-shell (nautilus)    #
# 2 --> cinnamon (nemo)           #
# 3 --> KDE (dolphin)             #
# 4 --> xfce (thunar)             #
# 5 --> mate (caja)               #
# 6 --> other1 (with nautilus)    #
# 7 --> other2 (without nautilus) #
###################################

########################################################################
# DESKTOP auto-detection for different desktop environment             #
# It will be disabled if you set _DESKTOP manually above               #
########################################################################
if [ $_DESKTOP -eq 0 ]
then
   if ps -A | grep 'gnome-shell' > /dev/null
   then
      _DESKTOP=1
   fi
   if ps -A | grep 'cinnamon' > /dev/null
   then
      _DESKTOP=2
   fi
   if ps -A | grep 'kded4' > /dev/null
   then
      _DESKTOP=3
   fi
   if ps -A | grep 'Thunar' > /dev/null
   then
      _DESKTOP=4
   fi
   if ps -A | grep 'caja' > /dev/null
   then
      _DESKTOP=5
   fi
fi
if [ $_DESKTOP -eq 0 ]
then
   if ps -A | grep 'nautilus' > /dev/null
   then
      _DESKTOP=6
   else
      _DESKTOP=7
   fi
fi
###########################################################

pkgname=insync
pkgver=0.10.2
pkgrel=1
pkgdesc="An unofficial Google Drive client that runs on Linux, with support for various desktops"
url="https://forums.insynchq.com/discussion/1964/insync-for-linux-beta-16-0-10-0"
license=('custom:insync')
options=(!strip !zipman)
arch=('i686' 'x86_64')

############ other desktop 1 ############
if [ $_DESKTOP -eq 6 ]; then
   depends=('nautilus' 'python2-nautilus' 'xdg-utils')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_i386.deb")
      sha256sums=('05d288f0cd6ee2060d78cd8798abd87330f54c4fa16d94bbcd590a917a67b7d8')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_amd64.deb")
      sha256sums=('22cd0788dbc7b08dea16a8abe1dd6d356de49443dd51dd523cf08181222d8d9a')
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option=""
fi
############ other desktop 2 ############
if [ $_DESKTOP -eq 7 ]; then
   depends=('xdg-utils')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_i386.deb")
      sha256sums=('05d288f0cd6ee2060d78cd8798abd87330f54c4fa16d94bbcd590a917a67b7d8')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_amd64.deb")
      sha256sums=('22cd0788dbc7b08dea16a8abe1dd6d356de49443dd51dd523cf08181222d8d9a')
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option=""
fi
############ gnome-shell ############
if [ $_DESKTOP -eq 1 ]; then
   depends=('xdotool' 'nautilus' 'python2-nautilus' 'gnome-shell')
   if [ "$CARCH" = 'i686' ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_0.9.41_i386.deb")
      sha256sums=('687c3f64be3d189c5a757e6d652145615c410b5ffbe49052854559e2e55600cd')
   elif [ "$CARCH" = "x86_64" ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_0.9.41_amd64.deb")
      sha256sums=('9a8b1e9e13c8bd0b7301376d000ab3a44064c6baa88528b17ad17d225e4284bd')
   fi
   source=("${source[@]}"
   "${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_0.9.40_all.deb")
   #"${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "cf4a7e0651872964b1d7169891515d4c7e3023e61536b9b1e28609fef021e8d1")
   noextract=("${pkgname}-${pkgver}-common.deb" "${pkgname}-${pkgver}-gnome.deb")
   _option=" --gnome"
fi
############ cinnamon ############
if [ $_DESKTOP -eq 2 ]; then
   depends=('nemo' 'nemo-python-git' 'cinnamon' 'xdg-utils')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_i386.deb")
      sha256sums=('66b8953140179384a50328655226cc3e44650758b487927e6b7d08bc4a6b360c')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_amd64.deb")
      sha256sums=('cfe488be89793e4f068e0c4ea60dff26bc6f1a4f68acdeac43fdba684da71df4')
   fi
   #source=("${source[@]}"
   #"${pkgname}-${pkgver}-cinnamon.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_0.9.39_all.deb")
   ##"${pkgname}-${pkgver}-cinnamon.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_all.deb")
   #sha256sums=("${sha256sums[@]}"
   #"91fedfca136c4d900466d113c5919e7553cd9b3c78914bbabc43513c38bb9168")
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option=""
fi
############ KDE ############
if [ $_DESKTOP -eq 3 ]; then
   depends=("kdebindings-python2" "xdotool" "kdebase-workspace")
   if [ $CARCH = 'i686' ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_i386.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_0.9.41_i386.deb")
      sha256sums=("c7a431b8e2ad7eb7b537f6b21b0babe5cf4d85194167e4dfa282de0d8fc38af7")
   elif [ $CARCH = 'x86_64' ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_amd64.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_0.9.41_amd64.deb")
      sha256sums=("757ea628eabab427ab2e8a50df2215dd9b41cee6345e5b59b7b96c2d2a9dc27f")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option="-kde"
fi
############ xfce ############
if [ $_DESKTOP -eq 4 ]; then
   depends=("xdotool" "libappindicator3" "thunarx-python" "exo")
   if [ $CARCH = 'i686' ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_i386.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_0.9.41_i386.deb")
      sha256sums=("ff3945e1f36a08e792e7b643d626bf75078969d714980594c251778529793a3f")
   elif [ $CARCH = 'x86_64' ]; then
      #source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_amd64.deb")
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_0.9.41_amd64.deb")
      sha256sums=("497e29ac478615b9fa08481c3729bbe854959bef6db97be279f47ad323a98541")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option=" --xfce"
fi
############ mate ############
if [ $_DESKTOP -eq 5 ]; then
   depends=("python-caja" "xdg-utils")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_i386.deb")
      sha256sums=("677dc6a73746e958b606c1ea06e2aeb8ef1d1af2e0f713f8ec94aa178d8247f0")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_amd64.deb")
      sha256sums=("3845ad1484c6d4fa424e7c0b8589963a629f69ca35b6029ead5015d7e65886a3")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
   _option=""
fi
source=("${source[@]}"
        "insync.service")
sha256sums=("${sha256sums[@]}"
            "0e302d4f1ce95a3838381094817b542505b8b9fe024aa01cca227d6184bb1f92")
install=$pkgname.install

package() {
   cd $srcdir
   [ -d ${pkgname}-${pkgver}-common ] && rm -r ${pkgname}-${pkgver}-common
   [ -d ${pkgname}-${pkgver}-common ] || mkdir ${pkgname}-${pkgver}-common
   mv ${pkgname}-${pkgver}-common.deb ${pkgname}-${pkgver}-common/
   cd $srcdir/${pkgname}-${pkgver}-common
   ar x ${pkgname}-${pkgver}-common.deb
   tar xvf data.tar.gz
   cp -rp usr $pkgdir

   if [ $_DESKTOP -eq 1 ]; then
      cd $srcdir
      [ -d ${pkgname}-${pkgver}-gnome ] || mkdir ${pkgname}-${pkgver}-gnome
      mv ${pkgname}-${pkgver}-gnome.deb ${pkgname}-${pkgver}-gnome/
      cd $srcdir/${pkgname}-${pkgver}-gnome
      ar x ${pkgname}-${pkgver}-gnome.deb
      tar xvf data.tar.gz
      cd $srcdir/${pkgname}-${pkgver}-gnome
      rm -r $pkgdir/usr/share/applications
      cp -rp usr $pkgdir
   fi
   #if [ $_DESKTOP -eq 2 ]; then
   #   cd $srcdir
   #   [ -d ${pkgname}-${pkgver}-cinnamon ] || mkdir ${pkgname}-${pkgver}-cinnamon
   #   mv ${pkgname}-${pkgver}-cinnamon.deb ${pkgname}-${pkgver}-cinnamon/
   #   cd $srcdir/${pkgname}-${pkgver}-cinnamon
   #   ar x ${pkgname}-${pkgver}-cinnamon.deb
   #   tar xvf data.tar.gz
   #   cp -rp usr $pkgdir
   #fi
   #if [ $_DESKTOP -eq 6 ]; then
   #   rm -r ${pkgdir}/usr/share/kde4
   #fi
   #if [ $_DESKTOP -eq 7 ]; then
   #   rm -r ${pkgdir}/usr/share/kde4
   #   rm -r ${pkgdir}/usr/share/nautilus-python
   #fi
   cd $pkgdir
   [ -f usr/bin/insync-kde ] && sed -i "s/^python /python2 /" usr/bin/insync-kde
   for file in $(grep -R "/usr/bin/python" . | cut -f1 -d :)
   do
      sed -i "s|usr/bin/python$|usr/bin/python2|g" $file
   done
   mkdir -p ${pkgdir}/usr/lib/systemd/system
   sed "s/_OPTION/${_option}/g" ${srcdir}/insync.service >${pkgdir}/usr/lib/systemd/system/insync@.service
}


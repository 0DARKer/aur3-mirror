# Maintainer: Zhengyu Xu <xzy3186@gmail.com>
#option to enable gnome-shell/cinnamon or KDE support
_if_gnome_shell="n"
_if_cinnamon="n"
_if_kde="n"
###########################################################
# DE auto-detection                                       #
###########################################################
if [[ $_if_gnome_shell = 'n' && $_if_cinnamon = 'n' && $_if_kde = 'n' ]]
then
   if ps -A | grep 'gnome-shell' > /dev/null
   then
      _if_gnome_shell='y'
   fi
   if ps -A | grep 'cinnamon' > /dev/null
   then
      _if_cinnamon='y'
   fi
   if ps -A | grep 'kded4' > /dev/null
   then
      _if_kde='y'
   fi
fi
####################################################################################################################
# Note: _if_kde can not be enabled together with _if_gnome_shell/_if_cinnamon. If "_if_kde=y", packages related to #
# gnome-shell and cinnamon will not be installed, regardless of the values of _if_gnome_shell/_if_cinnamon.        #
####################################################################################################################

pkgname=insync
pkgver=0.9.25
pkgrel=3
pkgdesc="An unofficial Google Drive client that runs on Linux, with support for cinnamon, gnome and KDE"
url="https://forums.insynchq.com/discussion/1545/insync-for-linux-beta-10-0-9-25#Item_1"
license=('custom:insync')
depends=(
'xdotool'
'nautilus'
'python2-nautilus')

options=(!strip !zipman)

arch=('i686' 'x86_64')
if [ "$CARCH" = 'i686' ]; then
   source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
   sha256sums=('89e79ae4a4f6def4672d5b93d9ccb9f889f9c05bb28d28cf4353108cc2448809')
elif [ "$CARCH" = "x86_64" ]; then
   source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
   sha256sums=('d00384a4aa583a42ba5e7b57aba8137b6950a9e93de3e50525e8515ee842c02e')
fi

noextract=("${pkgname}-${pkgver}-common.deb")

if [ $_if_gnome_shell = "y" ]; then
   depends=("${depends[@]}"
   "gnome-shell")
   source=("${source[@]}"
   #"${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_${pkgver}_all.deb")
   "${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_0.9.27_all.deb")
   sha256sums=("${sha256sums[@]}"
   "66167dd2df2dfad035747b1f4417a19acb3b1df5b79708cf1b4305dbfa357289")
   noextract=("${noextract[@]}"
   "${pkgname}-${pkgver}-gnome.deb")
fi
if [ $_if_cinnamon = "y" ]; then
   depends=("${depends[@]}"
   "cinnamon")
   source=("${source[@]}"
   "${pkgname}-${pkgver}-cinnamon.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "6d26604f45c397706099e84d764e7ca391a0356cdb15748b4959fff9a3e21fad")
   noextract=("${noextract[@]}"
   "${pkgname}-${pkgver}-cinnamon.deb")
fi

if [ $_if_kde = "y" ]; then
   depends=("kdebindings-python2"
   "xdotool"
   "kdebase-workspace")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-kde.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_i386.deb")
      sha256sums=("74469678f555eb7c39657e78c3bfa8b2493deabf3ff1cadf62ec8c0e072ca9eb")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-kde.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_amd64.deb")
      sha256sums=("ac2e05254e1e8ad63aa345c63d434433155afc07b2a0347e1085842072699349")
   fi
   noextract=("${pkgname}-${pkgver}-kde.deb")
fi

if [[ $_if_gnome_shell = 'n' && $_if_cinnamon = 'n' && $_if_kde = 'n' ]]
then
   depends=("${depends[@]}" "libappindicator3")
fi


install=$pkgname.install

package() {
   cd $srcdir
   if [ $_if_kde = "y" ]; then
      [ -d ${pkgname}-${pkgver}-kde ] || mkdir ${pkgname}-${pkgver}-kde
      mv ${pkgname}-${pkgver}-kde.deb ${pkgname}-${pkgver}-kde/
      cd $srcdir/${pkgname}-${pkgver}-kde
      ar x ${pkgname}-${pkgver}-kde.deb
      tar xvf data.tar.gz
      cp -rp usr $pkgdir
      cd $pkgdir
      sed -i "s/^python /python2 /" usr/bin/insync-kde
   else
      [ -d ${pkgname}-${pkgver}-common ] || mkdir ${pkgname}-${pkgver}-common
      mv ${pkgname}-${pkgver}-common.deb ${pkgname}-${pkgver}-common/
      cd $srcdir/${pkgname}-${pkgver}-common
      ar x ${pkgname}-${pkgver}-common.deb
      tar xvf data.tar.gz
      cp -rp usr $pkgdir
      if [ $_if_gnome_shell = "y" ]; then
         cd $srcdir
         [ -d ${pkgname}-${pkgver}-gnome ] || mkdir ${pkgname}-${pkgver}-gnome
         mv ${pkgname}-${pkgver}-gnome.deb ${pkgname}-${pkgver}-gnome/
         cd $srcdir/${pkgname}-${pkgver}-gnome
         ar x ${pkgname}-${pkgver}-gnome.deb
         tar xvf data.tar.gz
         #cd usr/share/gnome-shell/extensions/brett\@insynchq.com/
         #mv insync-error-symbolic.svg insync-error.svg
         #mv insync-idle-symbolic.svg insync-idle.svg
         #mv insync-offline-symbolic.svg insync-offline.svg
         #mv insync-partial-error-symbolic.svg insync-partial-error.svg
         #mv insync-synced-symbolic.svg insync-synced.svg
         #mv insync-syncing-symbolic.svg insync-syncing.svg
         cd $srcdir/${pkgname}-${pkgver}-gnome
         #GS_VERSION=$(gnome-shell --version | sed "s/.* \([0-9].[0-9]\).*/\1/g")
         #if [ ${GS_VERSION} = '3.6' ]; then
         #   cat ${srcdir}/metadata.json.3.6 > 'usr/share/gnome-shell/extensions/brett@insynchq.com/metadata.json'
         #   cat ${srcdir}/extension.js.3.6 > 'usr/share/gnome-shell/extensions/brett@insynchq.com/extension.js'
         #fi
         cp -rp usr $pkgdir
      fi
      if [ $_if_cinnamon = "y" ]; then
         cd $srcdir
         [ -d ${pkgname}-${pkgver}-cinnamon ] || mkdir ${pkgname}-${pkgver}-cinnamon
         mv ${pkgname}-${pkgver}-cinnamon.deb ${pkgname}-${pkgver}-cinnamon/
         cd $srcdir/${pkgname}-${pkgver}-cinnamon
         ar x ${pkgname}-${pkgver}-cinnamon.deb
         tar xvf data.tar.gz
         cp -rp usr $pkgdir
      fi
   fi
   cd $pkgdir
   sed -i "s/Internet/Network/" usr/share/applications/insync.desktop
   if [[ $_if_kde = 'n' && $_if_gnome_shell = 'n' && $_if_cinnamon = 'n' ]]
   then
      sed -i "/Exec/ s/ --gnome//" usr/share/applications/insync.desktop
   fi
   for file in $(grep -R "/usr/bin/python" . | cut -f1 -d :)
   do
      sed -i "s|usr/bin/python$|usr/bin/python2|g" $file
   done
}


# Maintainer: Zhengyu Xu <xzy3186@gmail.com>
#options for different desktop integration
_DESKTOP=0

##########################
# 1 --> gnome-shell      #
# 2 --> cinnamon (nemo)  #
# 3 --> KDE              #
# 4 --> xfce (thunar)    #
# 5 --> mate (caja)      #
# 6 --> other            #
##########################

########################################################################
# DESKTOP auto-detection for gnome-shell/cinnamon and KDE              #
# If you are using xfce or mate, please set _DESKTOP to 4 or 5 by hand #
########################################################################
if [ $_DESKTOP -eq 0 ]
then
   if ps -A | grep 'gnome-shell' > /dev/null
   then
      _DESKTOP=1
   fi
   if ps -A | grep 'cinnamon' > /dev/null
   then
      _DESKTOP=2
   fi
   if ps -A | grep 'kded4' > /dev/null
   then
      _DESKTOP=3
   fi
fi
if [ $_DESKTOP -eq 0 ]
then
   _DESKTOP=6
fi
###########################################################

pkgname=insync
pkgver=0.9.34
pkgrel=1
pkgdesc="An unofficial Google Drive client that runs on Linux, with support for various desktops"
url="https://forums.insynchq.com/discussion/1665/insync-for-linux-beta14-0-9-33"
license=('custom:insync')
options=(!strip !zipman)
arch=('i686' 'x86_64')

############ other desktop ############
if [ $_DESKTOP -eq 6 ]; then
   depends=('xdotool' 'nautilus' 'python2-nautilus' 'libappindicator3')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_i386.deb")
      sha256sums=('5849aaefcad53253aa7b1214d375b426216fc520fbd4edbab35b329671130daa')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-ubuntu_${pkgver}_amd64.deb")
      sha256sums=('f354d8103509de3a1428dd25d08b177588943abd6b9967a996c32ec58752854d')
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ gnome-shell ############
if [ $_DESKTOP -eq 1 ]; then
   depends=('xdotool' 'nautilus' 'python2-nautilus' 'gnome-shell')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
      sha256sums=('ec36e392243edd50d9eb177143512a4703ccec2fe42390d57745cf3101316ed1')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
      sha256sums=('922ea3db22dc43bab1efffb533a926f34d8407f2f9af5befc89f7182089ba841')
   fi
   source=("${source[@]}"
   "${pkgname}-${pkgver}-gnome.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "ddf4daabf4cb5bd6cfe2834839b370141dd1c5d48ae4b0ada2c4521e452540e6")
   noextract=("${pkgname}-${pkgver}-common.deb" "${pkgname}-${pkgver}-gnome.deb")
fi
############ cinnamon ############
if [ $_DESKTOP -eq 2 ]; then
   depends=('xdotool' 'nemo-fm' 'nemo-python-git' 'cinnamon')
   if [ "$CARCH" = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_i386.deb")
      sha256sums=('ec36e392243edd50d9eb177143512a4703ccec2fe42390d57745cf3101316ed1')
   elif [ "$CARCH" = "x86_64" ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-gnome-cinnamon-common_${pkgver}_amd64.deb")
      sha256sums=('922ea3db22dc43bab1efffb533a926f34d8407f2f9af5befc89f7182089ba841')
   fi
   source=("${source[@]}"
   "${pkgname}-${pkgver}-cinnamon.deb::http://s.insynchq.com/builds/${pkgname}-beta-cinnamon_${pkgver}_all.deb")
   sha256sums=("${sha256sums[@]}"
   "b98ab9004fcf330cfff9c8f9110f2f7034b1c5429aa22cf479ba539e773e6a05")
   noextract=("${pkgname}-${pkgver}-common.deb" "${pkgname}-${pkgver}-cinnamon.deb")
fi
############ KDE ############
if [ $_DESKTOP -eq 3 ]; then
   depends=("kdebindings-python2" "xdotool" "kdebase-workspace")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_i386.deb")
      sha256sums=("755b363b79d3ee32d5aecdefa18a105ff844b9495709cad6a61da828671e656f")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-kde_${pkgver}_amd64.deb")
      sha256sums=("44c17b9ae1a891cd4dd6bf306d079b0f354bee0c5040af53cc4aa878f5994097")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ xfce ############
if [ $_DESKTOP -eq 4 ]; then
   depends=("xdotool" "libappindicator3" "thunarx-python")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_i386.deb")
      sha256sums=("7572f663a179ed9130a94b4ebe7e0e6954e15c3eb86ddddb2c0371b24f5a48e4")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-xfce_${pkgver}_amd64.deb")
      sha256sums=("9c2eef9fba89f657909042dd9065ac7f76d75d6d9ee19687e52b6ccefa3ad066")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
############ mate ############
if [ $_DESKTOP -eq 5 ]; then
   depends=("xdotool" "libappindicator3" "python-caja")
   if [ $CARCH = 'i686' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_i386.deb")
      sha256sums=("08b5164f2adde76c86690c8fb99e3440dc160bbd511f36a1eee32dd629e40ab2")
   elif [ $CARCH = 'x86_64' ]; then
      source=("${pkgname}-${pkgver}-common.deb::http://s.insynchq.com/builds/${pkgname}-beta-mate_${pkgver}_amd64.deb")
      sha256sums=("9aba891aa7d034c290d8bc5b49ba2910ecc49e32f6c04e3879ac85c1bfc4761e")
   fi
   noextract=("${pkgname}-${pkgver}-common.deb")
fi
install=$pkgname.install

package() {
   cd $srcdir
   [ -d ${pkgname}-${pkgver}-common ] && rm -r ${pkgname}-${pkgver}-common
   [ -d ${pkgname}-${pkgver}-common ] || mkdir ${pkgname}-${pkgver}-common
   mv ${pkgname}-${pkgver}-common.deb ${pkgname}-${pkgver}-common/
   cd $srcdir/${pkgname}-${pkgver}-common
   ar x ${pkgname}-${pkgver}-common.deb
   tar xvf data.tar.gz
   cp -rp usr $pkgdir

   if [ $_DESKTOP -eq 1 ]; then
      cd $srcdir
      [ -d ${pkgname}-${pkgver}-gnome ] || mkdir ${pkgname}-${pkgver}-gnome
      mv ${pkgname}-${pkgver}-gnome.deb ${pkgname}-${pkgver}-gnome/
      cd $srcdir/${pkgname}-${pkgver}-gnome
      ar x ${pkgname}-${pkgver}-gnome.deb
      tar xvf data.tar.gz
      cd $srcdir/${pkgname}-${pkgver}-gnome
      rm -r $pkgdir/usr/share/applications
      cp -rp usr $pkgdir
   fi
   if [ $_DESKTOP -eq 2 ]; then
      cd $srcdir
      [ -d ${pkgname}-${pkgver}-cinnamon ] || mkdir ${pkgname}-${pkgver}-cinnamon
      mv ${pkgname}-${pkgver}-cinnamon.deb ${pkgname}-${pkgver}-cinnamon/
      cd $srcdir/${pkgname}-${pkgver}-cinnamon
      ar x ${pkgname}-${pkgver}-cinnamon.deb
      tar xvf data.tar.gz
      cp -rp usr $pkgdir
   fi
   cd $pkgdir
   [ -f usr/bin/insync-kde ] && sed -i "s/^python /python2 /" usr/bin/insync-kde
   for file in $(grep -R "/usr/bin/python" . | cut -f1 -d :)
   do
      sed -i "s|usr/bin/python$|usr/bin/python2|g" $file
   done
}


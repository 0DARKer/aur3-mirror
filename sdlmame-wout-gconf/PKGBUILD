# $Id: PKGBUILD 57484 2011-10-28 15:16:39Z spupykin $
# Contributor: Sergej Pupykin <pupykin.s+arch@gmail.com>
# Contributor: robb_force <robb_force@holybuffalo.net>
# Contributor: JJDaNiMoTh <jjdanimoth@gmail.com>
# Maintainer: Gustavo Alvarez <sl1pkn07@gmail.com>
_patchlevel=0
_basever=0.144

pkgname=sdlmame-wout-gconf
_pkgname=sdlmame
pkgver=${_basever}u${_patchlevel}
pkgrel=1
pkgdesc="A port of the popular Multiple Arcade Machine Emulator using SDL with OpenGL support. WITHOUT GCONF"
url="http://mamedev.org/"
license=('custom:MAME License')
arch=('i686' 'x86_64')
provides=('sdlmame')
conflicts=('sdlmame')
depends=('sdl>=1.2.11' 'libxinerama' 'sdl_ttf' 'gtk2')
makedepends=('unzip' 'nasm' 'mesa')
DLAGENTS=('http::/usr/bin/wget -U "Mozilla/5.0 (X11; U; Linux x86_64; en-US; rv:1.9.1.2) Gecko/20090804 Shiretoko/3.5.2" -c -t 3 --waitretry=3 -O %o %u')
install=sdlmame.install

for i in `seq 1 ${_patchlevel}`; do
	_patches="${_patches} sdlmame-${_basever/./}u${i}_diff.zip::http://mamedev.org/updates/${_basever/./}u${i}_diff.zip"
done

source=("mame${_basever/./}s.zip::http://mamedev.org/downloader.php?file=releases/mame${_basever/./}s.zip"
	"sdlmame.sh"
	"extras.tar.gz"
	${_patches}
        sdlmame-wout-gconf.patch)
md5sums=('7440076e60cd5d61ea33df17fc00719a'
         '3119ccfa1e970eba4467df31208adaf0'
         '420b61240bf5ae11615ba7c6100ee00d'
         '27940ce35314cdbbaac342f418c531fc')

build() {
  cd ${srcdir}/

  if [ $NOEXTRACT -eq 0 ]; then
    unzip mame.zip
    find . -type f -not -name \*.png | xargs perl -pi -e 's/\r\n?/\n/g'
    for i in `seq 1 ${_patchlevel}`; do
      msg "Patch#$i"
      patch -p0 -E <${_basever/./}u$i.diff
    done
    sed -i 's/-Werror//' makefile
    sed -i 's/LDFLAGS = -Wl,--warn-common/LDFLAGS = -Wl,--warn-common -Wl,-zmuldefs/' makefile
  fi
  patch -p0 < sdlmame-wout-gconf.patch
  # Modify the make options based on the user's architecture
   if [ "$CARCH" == "x86_64" ]; then
    echo "Compiling for AMD64..."
    make AMD64=1 PTR64=1 NO_DEBUGGER=1 DEBUG=0
    make tools AMD64=1 PTR64=1 NO_DEBUGGER=1 DEBUG=0
  elif [ "$CARCH" == "i686" ]; then
    make I686=1 NO_DEBUGGER=1 DEBUG=0
    make tools I686=1 NO_DEBUGGER=1 DEBUG=0
  else
    echo "Compiling for i386..."
    make PM=1 NO_DEBUGGER=1 DEBUG=0
    make tools PM=1 NO_DEBUGGER=1 DEBUG=0
  fi

}
package() {
  cd ${srcdir}/
  # Install the sdlmame script
  install -Dm755 ${srcdir}/${_pkgname}.sh ${pkgdir}/usr/bin/${_pkgname}

  # Install the applications and the UI font in /usr/share
  install -Dm755 mame64d ${pkgdir}/usr/share/${_pkgname}/${_pkgname}

  install -m755 chdman ${pkgdir}/usr/share/${_pkgname}/chdman
  install -m755 jedutil ${pkgdir}/usr/share/${_pkgname}/jedutil
  install -m755 regrep ${pkgdir}/usr/share/${_pkgname}/regrep
  install -m755 romcmp ${pkgdir}/usr/share/${_pkgname}/romcmp
  install -m755 testkeys ${pkgdir}/usr/share/${_pkgname}/testkeys
  install -m755 src2html ${pkgdir}/usr/share/${_pkgname}/src2html
  install -m755 srcclean ${pkgdir}/usr/share/${_pkgname}/srcclean
  install -m755 ldverify ${pkgdir}/usr/share/${_pkgname}/ldverify
  install -m755 ldresample ${pkgdir}/usr/share/${_pkgname}/ldresample

  # Install the extra bits
  install -d ${pkgdir}/usr/share/${_pkgname}/{artwork,ctrlr,keymaps,shader}
  install -d ${pkgdir}/usr/share/man/man1
  install -m644 src/osd/sdl/shader/glsl*.*h ${pkgdir}/usr/share/${_pkgname}/shader/
  install -m644 src/osd/sdl/man/* ${pkgdir}/usr/share/man/man1/

  install -m644 ${srcdir}/artwork/* ${pkgdir}/usr/share/${_pkgname}/artwork/
  install -m644 ${srcdir}/ctrlr/* ${pkgdir}/usr/share/${_pkgname}/ctrlr/
  install -m644 src/osd/sdl/keymaps/* ${pkgdir}/usr/share/${_pkgname}/keymaps/

  # Include the license
  install -Dm644 docs/license.txt ${pkgdir}/usr/share/licenses/${_pkgname}/license.txt

  find ${pkgdir} -type f -exec strip {} \;
}

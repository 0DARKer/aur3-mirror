#Contributor: Flamelab <panosfilip@gmail.com

pkgname=gnome-shell-git
_realname=gnome-shell
pkgver=20110219
_realver=2.91.6
pkgrel=1
pkgdesc="The next generation GNOME Shell. Experimental, GNOME 3.0 version."
arch=('i686' 'x86_64')
url="http://live.gnome.org/GnomeShell"
license=('GPL2')

depends=('dbus-glib' 'dconf' 'gtk3' 'libffi' 'gnome-desktop-3.0'  'libgnomeui' 'cairo' 'librsvg' 'gnome-python' \
         'python2' 'spidermonkey' 'gnome-menus' 'gnome-control-center' 'freetype2' 'gstreamer0.10' 'clutter' \
         'mutter-git' 'gjs-dev' 'gsettings-desktop-schemas-git' 'mesa-demos' 'gnome-settings-daemon-dev')

makedepends=( 'xulrunner' 'gnome-common' 'intltool' 'libpulse' 'gnome-doc-utils>=0.12.0' 'gobject-introspection-dev')

provides=("${_realname}=${_realver}")
conflicts=("${_realname}")
options=(!libtool !emptydirs)
install=gnome-shell-git.install


_gitroot="git://git.gnome.org/gnome-shell"
_gitname="gnome-shell"

build() {

  cd ${srcdir}/

    msg "Connecting to the GNOME GIT server...."
    if [[ -d ${srcdir}/${_gitname} ]] ; then
    	cd ${_gitname}
    	git pull origin
    	msg "The local files are updated..."
    else
    	git clone ${_gitroot} ${gitname}
    fi

    msg "GIT checkout done."

    msg2 "Starting make for: ${pkgname}"

    if [[ -d ${srcdir}/${_gitname}-build ]]; then
       msg "Cleaning the previous build directory..."
       rm -rf ${srcdir}/${_gitname}-build
    fi

    git clone ${srcdir}/${_gitname} ${srcdir}/${_gitname}-build

    cd ${srcdir}/${_gitname}-build

    msg "Starting configure..."

    ./autogen.sh \
             --prefix=/usr \
	     --disable-glibtest \
	     --sysconfdir=/etc \
             --enable-compile-warnings=yes \
             --enable-dependency-tracking

    sed -i 's/\-Werror//g' configure.ac

    export LD_LIBRARY_PATH=/usr/lib/xulrunner-devel-1.9.*/lib:/usr/lib/libfakeroot

    sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
    sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g'         libtool

    make
}

package()

{
    cd ${srcdir}/${_gitname}-build
    make GCONF_DISABLE_MAKEFILE_SCHEMA_INSTALL=1 DESTDIR="${pkgdir}" install

    sed -i -e "s|/usr/bin/python|/usr/bin/python2|" ${pkgdir}/usr/bin/gnome-shell

    desktop-file-validate ${pkgdir}/usr/share/applications/gnome-shell.desktop
}


# Maintainer: Christian Hesse <mail@eworm.de>
# Contributor: Wessel Dirksen "p-we" <wdirksen at gmail dot com>
# Contributor: Juha-Matti "Suolx" Heikkala

pkgname=open-sasc-ng-dkms
pkgver=620
pkgrel=4
pkgdesc="a versatile SoftCAM which creates virtual DVB devices"
url="http://85.17.209.13:6100"
arch=('i686' 'x86_64')
license=('GPL')
depends=('linux-headers' 'dkms' 'sascng-linux3-dkms')
makedepends=('mercurial')
conflicts=('sasc-ng' 'open-sasc-ng')
provides=('sasc-ng' 'open-sasc-ng')
backup=('etc/camdir/cardclient.conf'
	'etc/conf.d/sasc-ng')
source=('2.6.38.patch'
	'cardclient.conf'
	'dkms.conf'
	'sasc-ng.rc'
	'sasc-ng.service'
	'sasc-ng.conf'
	'open-sasc-ng.lr'
	'config_dvb.pl.patch')

install=open-sasc-ng.install

_hgroot=http://85.17.209.13:6100/
_hgrepo=sc

build() {
  cd ${srcdir}

  cd "${srcdir}"
  msg "Connecting to Mercurial server ..."
  if [ -d ${_hgrepo} ]; then
    cd ${_hgrepo}
    hg pull -u -r ${pkgver}
    msg "The local files are updated."
  else
    hg clone -r ${pkgver} ${_hgroot}/${_hgrepo} ${_hgrepo}
  fi

  msg "Package update completed"

   rm -rf "${srcdir}/${_hgrepo}-build"
   cp -r "${srcdir}/${_hgrepo}" "${srcdir}/${_hgrepo}-build"
   cd "${srcdir}/${_hgrepo}-build"

   msg "Applying patches ..."
   
   if [ ${pkgver} -lt 600 ]; then
	   patch -Np1 < ${srcdir}/2.6.38.patch
   fi
   patch -p1 < ${srcdir}/config_dvb.pl.patch
 
   cd ${srcdir}

   cd "${srcdir}/${_hgrepo}-build"

   chmod a+x ${srcdir}/${_hgrepo}-build/contrib/sasc-ng/configure
   chmod a+x ${srcdir}/${_hgrepo}-build/contrib/sasc-ng/makelinks.sh
   chmod a+x ${srcdir}/${_hgrepo}-build/contrib/sasc-ng/dvbloopback/module/config_dvb.pl

   cd "${srcdir}/${_hgrepo}-build/contrib/sasc-ng"
   ./configure --compiletype=release
   make
}

package() {
   cd "${srcdir}/${_hgrepo}-build/contrib/sasc-ng"

   mkdir -p ${pkgdir}/var/lib/dkms/open-sasc-ng/${pkgver}/
   cp -r dvbloopback/module ${pkgdir}/var/lib/dkms/open-sasc-ng/${pkgver}/source
   sed "s/%%PKGVER%%/${pkgver}/" < ${srcdir}/dkms.conf > ${pkgdir}/var/lib/dkms/open-sasc-ng/${pkgver}/source/dkms.conf

   install -D -m0755 sasc-ng ${pkgdir}/usr/sbin/sasc-ng
   install -D -m0755 ${srcdir}/sasc-ng.rc ${pkgdir}/etc/rc.d/sasc-ng
   install -D -m0644 ${srcdir}/sasc-ng.service ${pkgdir}/usr/lib/systemd/system/sasc-ng.service
   install -D -m0644 ${srcdir}/sasc-ng.conf ${pkgdir}/etc/conf.d/sasc-ng
   install -D -m0644 ${srcdir}/cardclient.conf ${pkgdir}/etc/camdir/cardclient.conf
   install -D -m0644 ${srcdir}/open-sasc-ng.lr ${pkgdir}/etc/logrotate.d/open-sasc-ng.lr
}

sha256sums=('45856a48253dcf58a81244bf8216cbf7e77d30ebfd07d14735cbe94180787961'
            '7caba03e515fe55aced4aad831e72ef3c0e59a3cdcea7bcdf79f7bfff6fcec75'
            '8c5b5ce5ac3eba4cfa3f7ec21b815b34dee0c7cd7616c250764f4c0bac896c37'
            '5851dc6f9de07f1a38169a650932f710a1aac0dd3067b7817511ced2a87ecfaf'
            'f23c4b4a3941190906a11f2d00319bbf82e3382dab5ecea86b34c3a19086fb18'
            'edfef56e3be2e1d0b7b0d11588e638d54548b9f2dd06495b9b581ba5baae9314'
            '620da70c775ce055a3f04041cf90e6d2acf7f7a57b0eecd07f240456d0069cf4'
            '195f440a4de49c56c8becba0fed966b436b2260f2cf3ce9e9277d97b411be9e4')

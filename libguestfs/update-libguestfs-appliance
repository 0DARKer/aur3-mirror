#!/bin/bash
#
# update-guestfs-appliance: download and install a guestfs binary appliance
# Copyright (C) 2013 Nikos Skalkotos <skalkoto@gmail.com>
# 
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

VERSION=1.22.6
SHA512SUM="7d0c86b7d6e3207e91b5176e6734a6d7e19c86c98e14b28fa4ebca4fbc301a3568a3d54fae2c79c135f4994b70341d9bf29b4760907998e70d84ca5f25de55d4"

set -e

if [[ $EUID -ne 0 ]]; then
	echo "This script must be run as root" >&2
	exit 1
fi

echo >&2
echo "Downloading binary appliance v$VERSION for libguestfs ... " >&2
echo >&2

TMP=$(mktemp -d)
trap "rm -rf $TMP" EXIT

cd $TMP
wget http://libguestfs.org/download/binaries/appliance/appliance-${VERSION}.tar.xz

echo -n "Checking checksum ... " >&2

checksum=$(mktemp --tmpdir="$TMP")
echo "$SHA512SUM appliance-${VERSION}.tar.xz" > "$checksum"

sha512sum -c "$checksum"

echo >&2
echo "Extracting binary appliance files:" >&2
tar -xvf appliance-${VERSION}.tar.xz

echo >&2
echo "Copying appliance files to /usr/lib/guestfs: " >&2
install -v -m644 -o root -g root --backup=none "$TMP/appliance/"{kernel,initrd,root,README.fixed} /usr/lib/guestfs

echo >&2
echo "Binary appliance installation finished successfully!" >&2

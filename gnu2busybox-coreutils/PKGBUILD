#Maintainer: Jens Staal <staal1978@gmail.com>

pkgname="gnu2busybox-coreutils"
pkgver="1"
pkgrel=3
pkgdesc="Replacing the GNU coreutils with the corresponding commands from Busybox"
arch=('any')
url="http://busybox.net/"
license=('GPLv2')
depends=('busybox')
provides=('coreutils')
conflicts=('coreutils')
install=('coreutils-replace.install')
source=('coreutils.bin.ls' 'coreutils.usr.bin.ls' 'coreutils.usr.sbin.ls' \
'coreutils.gnuonly.ls' 'busybox.1.gz' 'busybox.conf')
md5sums=('8aaf17613697314627bb5297c5d68472' 'a186f0d0a11efbce079c97ef79b0cf3a' \
'466673de471fac1f97ef0cac4eb9a272' 'eaa669939df00afd5e5f242fedccf55b' \
'10741fe7dc9a4b2e0310af5f3954f027' '2acec73322685b206de44c1ca9195cc2')

_bin=($srcdir/coreutils.bin.ls)
_usrbin=($srcdir/coreutils.usr.bin.ls)
_usrsbin=($srcdir/coreutils.usr.sbin.ls)

build() {
  msg "WARNING: this is an experimental package. Do not install on production systems"
  msg "There may be corner cases where the system expect stuff specific for GNU coreutils"
  msg "A list of files not provided by busybox is saved in text format in /usr/share/info"

  msg "creating package directories"
  mkdir "$pkgdir/bin"
  mkdir "$pkgdir/usr"
  mkdir "$pkgdir/usr/bin"
  mkdir "$pkgdir/usr/sbin"
  mkdir "$pkgdir/etc"
  mkdir "$pkgdir/usr/share"
  mkdir "$pkgdir/usr/share/man"
  mkdir "$pkgdir/usr/share/man/man1"
  mkdir "$pkgdir/usr/share/info"

  msg "creating symlinks for /bin"
  cd $pkgdir/bin

    for i in $(cat $_bin)
      do
      ln -s /bin/busybox $pkgdir/bin/$i
    done

  msg "ceating symlinks for /usr/bin"
  cd $pkgdir/usr/bin

    for i in $(cat $_usrbin)
      do
      ln -s /bin/busybox $pkgdir/usr/bin/$i
    done

  msg "creating symlinks for /usr/sbin"
  cd $pkgdir/usr/sbin

    for i in $(cat $_usrsbin)
      do
      ln -s /bin/busybox $pkgdir/usr/sbin/$i
    done

  msg "adding corresponding coreutils-dependent settings files"
# Do we need to add more privilige rules in this file to get a secure system?
  cp $srcdir/busybox.conf $pkgdir/etc/busybox.conf

# /usr/lib/libstdbuf.so is not needed since busybox does not provide stdbuf
# alternative solutions welcome

# /usr/share/locale
# todo: setting up locale support for busybox. Not in stock package - can it be added?

  msg "setting up manpage entries"
#future improvement: to get the symlink to jumt to the relevant part of the busybox man
install -Dm644 $srcdir/busybox.1.gz $pkgdir/usr/share/man/man1/busybox.1.gz
cd $pkgdir/usr/share/man/man1
for i in $(cat $_bin)
  do ln -s busybox.1.gz $i.1.gz
done
for i in $(cat $_usrbin)
  do ln -s busybox.1.gz $i.1.gz
done
for i in $(cat $_usrsbin)
  do ln -s busybox.1.gz $i.1.gz
done

  msg "Warning: $(cat $srcdir/coreutils.gnuonly.ls)"
  msg "copying list of files not provided by busybox to /usr/share/info"
cp $srcdir/coreutils.gnuonly.ls $pkgdir/usr/share/info/
}
 

# Maintainer: Sebastien Duthil <duthils@free.fr>
pkgname=('dnds-git')
pkgbase=dnds-git
pkgver=20130622
pkgrel=1
epoch=
pkgdesc="Dynamic Network Directory Service - easy to use VPN"
arch=('i686' 'x86_64')
url="https://github.com/nicboul/DNDS"
license=('GPL2')
groups=()
depends=('openssl' 'libconfig')
makedepends=('git' 'cmake' 'scons')
checkdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
noextract=()
source=('tapcfg.patch')
md5sums=('5d04830ec7baa9b8d2c7fcd56a4b73f1')

_dnds_gitroot="git://github.com/nicboul/DNDS.git"
_dnds_gitname="DNDS"

_udt4_gitroot="git://github.com/nicboul/udt4.git"
_udt4_gitname="udt4"

_tapcfg_svntrunk="http://tapcfg.googlecode.com/svn/"
_tapcfg_svnmod="tapcfg-1.0.0"
_tapcfg_svnrev="382"

build() {
    cd "$srcdir"
    msg "Connecting to the git repository..."
    if [ -d "$srcdir/$_dnds_gitname" ] ; then
        cd "$_dnds_gitname" && git pull origin
        msg2 "$_dnds_gitname - The local files are updated."
    else
        git clone "$_dnds_gitroot" "$_dnds_gitname" --depth=1
    fi

    cd "$srcdir"
    if [ -d "$srcdir/$_udt4_gitname" ] ; then
        cd "$_udt4_gitname" && git pull origin
        msg2 "_udt4_gitname - The local files are updated."
    else
        git clone "$_udt4_gitroot" "$_udt4_gitname" --depth=1
    fi
    msg2 "GIT checkout done or server timeout."
    ln -sf "$srcdir/$_udt4_gitname" "$srcdir/$_dnds_gitname"
    cd "$srcdir/$_udt4_gitname"
    make

    cd "$srcdir"
    if [[ -d "$_tapcfg_svnmod/.svn" ]]; then
      (cd "$_tapcfg_svnmod" && svn up -r "$_tapcfg_svnrev")
    else
      svn co "$_tapcfg_svntrunk" --config-dir ./ -r "$_tapcfg_svnrev" "$_tapcfg_svnmod"
    fi
    ln -sf "$srcdir/$_tapcfg_svnmod/trunk" "$srcdir/$_dnds_gitname/$_tapcfg_svnmod"
    cd "$srcdir/$_tapcfg_svnmod"
    patch -p0 -N -i "$srcdir/tapcfg.patch" || true
    cd "$srcdir/$_tapcfg_svnmod/trunk"
    ./buildall.sh

    cd "$srcdir/$_dnds_gitname/"
    cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr .

    cd "$srcdir/$_dnds_gitname/libdnds"
    make

    cd "$srcdir/$_dnds_gitname/dnc"
    make
}

package() {
    cd "$srcdir/$_dnds_gitname/libdnds"
    make DESTDIR="$pkgdir/" install

    cd "$srcdir/$_dnds_gitname/dnc"
    make DESTDIR="$pkgdir/" install
}

# Maintainer: Sebastien Duthil <duthils@free.fr>
pkgname=('dnds-git')
pkgbase=dnds-git
pkgver=20130313
pkgrel=1
epoch=
pkgdesc="Dynamic Network Directory Service - easy to use VPN"
arch=('i686' 'x86_64')
url="https://github.com/nicboul/DNDS"
license=('GPL2')
groups=()
depends=('openssl')
makedepends=('git' 'cmake')
checkdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
noextract=()
md5sums=()

_dnds_gitroot="git://github.com/nicboul/DNDS.git"
_dnds_gitname="DNDS"

_udt4_gitroot="git://github.com/nicboul/udt4.git"
_udt4_gitname="udt4"

build() {
    cd "$srcdir"
    if [ -d "$srcdir/$_udt4_gitname" ] ; then
        cd "$_udt4_gitname" && git pull origin
        msg2 "UDT4 - The local files are updated."
    else
        git clone "$_udt4_gitroot" "$_udt4_gitname" --depth=1
    fi
    msg2 "GIT checkout done or server timeout."

    cd "$srcdir"
    msg "Connecting to the git repository..."
    if [ -d "$srcdir/$_dnds_gitname" ] ; then
        cd "$_dnds_gitname" && git pull origin
        msg2 "DNDS - The local files are updated."
    else
        git clone "$_dnds_gitroot" "$_dnds_gitname" --depth=1
    fi

    ln -s "$srcdir/$_udt4_gitname" "$srcdir/$_dnds_gitname"

    cd "$srcdir/$_udt4_gitname"
    make

    cd "$srcdir/$_dnds_gitname/libdnds"
    cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr .
    make

    cd "$srcdir/$_dnds_gitname/dnc"
    cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr .
    make
}

package() {
    cd "$srcdir/$_dnds_gitname/libdnds"
    make DESTDIR="$pkgdir/" install

    cd "$srcdir/$_dnds_gitname/dnc"
    make DESTDIR="$pkgdir/" install
}

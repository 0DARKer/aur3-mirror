# Maintainer: Jochen Keil <jochen dot keil at gmail dot com>
# Contributor: Mark Nikkel <mnikkel@gmail.com>
# Contributor: Michael Stephens <michaeljs@gmail.com>
pkgname=zfs-fuse
pkgver=0.6.9
pkgrel=3
pkgdesc='A port of the ZFS filesytem to the FUSE framework.'
arch=('i686' 'x86_64')
url="http://zfs-fuse.net/"
license=('CDDL')
depends=('glibc' 'fuse' 'zlib' 'libaio')
makedepends=('scons')
options=('zipman')
replaces=('zfs-fuse' 'zfs-fuse-git-critical')
backup=('etc/zfs_pool_alert' 'etc/conf.d/zfs-fuse')
source=('zfs-fuse.rcd' 'zfs-fuse.confd')
install=zfs-fuse.install
_official_src="official_src.tgz"
_official_src_url='http://gitweb.zfs-fuse.net/?p=official;a=snapshot;h=maint;sf=tgz'

md5sums=('7defbcdc3464aad5b3f8e8ceebb86adc'
         'c1282d490e1fb5af2fe8210efdcceae1')

fetch_src() {
  if [ ! -f ${_official_src} ]; then
    wget -c \
      -O ${_official_src} \
      ${_official_src_url}
  fi
}

build() {
  # unfortunately this is necessary since gitweb produces tarballs with
  # different md5 sums every time

  while ( !(gzip -t ${_official_src} 2>&1 >/dev/null)); do
    rm -f ${_official_src};
    fetch_src;
  done

  tar xzf ${_official_src} \
    || return 1

  cd ${startdir}/src/official/src

  scons || return 1
  scons install \
    install_dir=${pkgdir}/usr/sbin \
    man_dir=${pkgdir}/usr/share/man/man8 \
    cfg_dir=${pkgdir}/etc

  install -D -m755 ${startdir}/zfs-fuse.rcd ${pkgdir}/etc/rc.d/zfs-fuse
  install -D -m644 ${startdir}/zfs-fuse.confd ${pkgdir}/etc/conf.d/zfs-fuse
  install -D -m644 ${srcdir}/official/contrib/zfs_completion.bash \
    ${pkgdir}/etc/bash_completion.d/zfs_completion
}

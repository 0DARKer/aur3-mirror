# Maintainer: tobias [tobias.archlinux.org]
# Contributor: tobias [tobias.justdreams.de] Milan Knizek [knizek.volny.cz]

pkgname=cinepaint-oyranos
_pkgname=cinepaint
pkgver=0.25.1
_pkgver=0.25.0
pkgrel=6
pkgdesc="Oyranos enabled version of photo editing application (git a1c614fc2a35263c8fe664ac93c3a0c832dafa15)"
arch=('i686' 'x86_64')
license=('LGPL' 'GPL' 'MIT')
url="http://www.cinepaint.org"
depends=('gtk2' 'openexr' 'lcms' 'libxpm' 'fltk' 'ftgl' 'libxxf86vm' 'oyranos>=0.9.0')
makedepends=('python2' 'gutenprint>=5.2.9' 'git')
optdepends=('python2: for python plug-ins'
            'gutenprint: for print plug-ins'
            'ghostscript: for pdf plug-ins')
conflicts=(cinepaint)
provides=(cinepaint)
options=('!libtool')
install=cinepaint.install
source=('cinepaint-libpng15.patch'
        'cinepainttool.in.patch'
        'configure.patch'
        'configure.in.patch')
x_gitroot="git://www.oyranos.org/git/cinepaint"
x_gitname="cinepaint"

build(){
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $x_gitname ] ; then
    cd $x_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $x_gitroot
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$x_gitname-build"
  git clone "$srcdir/$x_gitname" "$srcdir/$x_gitname-build"
  cd "$srcdir/$x_gitname-build"
  git checkout -b b$pkgver a1c614fc2a35263c8fe664ac93c3a0c832dafa15

  chmod +w Makefile.am

  # Patches from Arch package repository
  patch -p1 -i ../cinepaint-libpng15.patch
  patch -p1 -i ../cinepainttool.in.patch
  patch -p1 -i ../configure.patch
  patch -p1 -i ../configure.in.patch
  find plug-ins/pygimp -type f -exec sed -i 's#env python#env python2#' {} +

  ./configure --prefix=/usr --libdir=/usr/lib --mandir=/usr/share/man \
              --enable-pygimp --with-python=/usr/bin/python2
  make -j8
}

package() {
  cd "$srcdir/$x_gitname-build"
  make DESTDIR="${pkgdir}" install
#  sed -i -e "s|-I$srcdir/$x_gitname-build||" -e "s|-I$srcdir/$x_gitname-build/lib||" -e "/libcinepaint.la/d" \
#         -e "s|$srcdir/$x_gitname-build/lib/.libs/\$dlname||" "${pkgdir}/usr/bin/cinepainttool"
  sed -i "s/cinepaint.png/cinepaint/" "${pkgdir}/usr/share/applications/cinepaint.desktop"
  install -D -m644 "COPYING" "${pkgdir}/usr/share/licenses/${_pkgname}/COPYING"
}

md5sums=('682de65ad358512d00a8b76730453664'
         'ec23e4f6e863a70b08337a7caf49aa04'
         'f4a5be4601aa528f87814e72adea4f39'
         '38e03763bc14ec7926a5ac05a9a5ea07')

# Contributor: Paul Bredbury <brebs@sent.com>
# Maintainer: Ray Kohler <ataraxia937@gmail.com>

pkgname=nspluginwrapper-ubuntu
oriver=1.2.2
uburel=6
pkgver=$oriver.$uburel
pkgrel=6
pkgdesc="Netscape pluginwrapper, to use browser plugins meant for different architectures"
arch=('x86_64')
url="http://packages.ubuntu.com/lucid/nspluginwrapper"
license=('GPL')
depends=('glib2' 'libxt' 'util-linux-ng' 'curl' 'lib32-alsa-lib' 'lib32-gcc-libs' 'lib32-libxmu' 'lib32-libxext' 'lib32-libxt' 'lib32-glibc' 'lib32-libxau' 'lib32-libice' 'lib32-libxfixes' 'lib32-libxft' 'lib32-gtk2' 'lib32-glib2' 'lib32-cairo' 'lib32-libxdamage')
makedepends=('deb2targz' 'sed')
provides=("nspluginwrapper=$oriver")
conflicts=('nspluginwrapper' 'nspluginwrapper-debian')
install=$pkgname.install
source=(http://archive.ubuntu.com/ubuntu/pool/multiverse/n/nspluginwrapper/nspluginwrapper_${oriver}-0ubuntu${uburel}_amd64.deb)
md5sums=('50c3ab38197c4c3574a3755a63ab7da9')

build() {
 cd "$srcdir"
 deb2targz nspluginwrapper_${oriver}-0ubuntu${uburel}_amd64.deb
 tar -zxf nspluginwrapper_${oriver}-0ubuntu${uburel}_amd64.tar.gz
}

package() {
 cd "$srcdir"
 # Copy files from src/ to pkg/
 find usr -type f | while read file ; do
   install -Dm644 "$file" "$pkgdir/$file"
 done
 # Return from the function, since install's return just exits the loop
 # See http://fvue.nl/wiki/Bash:_Error_handling
 [ $? -gt 0 ] && return 1
 
 # Fix exe permissions
 cd ..
 find pkg/usr/lib -type f ! -name *.so -exec chmod 755 '{}' \;

 # Link nspluginwrapper
 install -d pkg/usr/bin/
 ln -sf /usr/lib/nspluginwrapper/x86_64/linux/npconfig pkg/usr/bin/nspluginwrapper

 # Install nspluginplayer
 # fix lack of libcurl-gnutls.so.4, warning "no version ..." still exists
 ##ln -sf /usr/lib/nspluginwrapper/x86_64/linux/npplayer pkg/usr/bin/nspluginplayer
 ln -sf /usr/lib/libcurl.so pkg/usr/lib/nspluginwrapper/x86_64/linux/libcurl-gnutls.so.4
 echo -e '#!/bin/sh\n cd /usr/lib/nspluginwrapper/x86_64/linux/
 LD_LIBRARY_PATH=".:$LD_LIBRARY_PATH" exec ./npplayer "$@"\n' > nspluginplayer
 install -m755 nspluginplayer pkg/usr/bin/
  
 # Hack for 32-bit libs in Arch
 cd pkg/usr/lib/nspluginwrapper/noarch
 sed -e '/exec/i\## fix section for Arch ##\
 export GTK_PATH="/opt/lib32/usr/lib/gtk-2.0"\
 export GCONV_PATH="/opt/lib32/usr/lib/gconv"\
 export PANGO_RC_FILE="/opt/lib32/config/pango/pangorc"\
 export GDK_PIXBUF_MODULE_FILE="/opt/lib32/config/gdk/gdk-pixbuf.loaders"\
 export GTK_IM_MODULE_FILE="/opt/lib32/config/gdk/gdk.immodules"\
 export LD_LIBRARY_PATH="/opt/lib32/usr/lib:/opt/lib32/lib:$LD_LIBRARY_PATH"\
 export GDK_NATIVE_WINDOWS=1\
 unset GTK_MODULES\n\n' -i npviewer
}


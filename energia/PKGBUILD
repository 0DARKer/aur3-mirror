# Maintainer: Will Price <willprice94+arch@gmail.com>
# Contributor: Andrew67 (.desktop file, icon, 64bit compatibility)

pkgname=energia
pkgver=0009
pkgrel=3
pkgdesc="Energia is a Arduino IDE clone for use with the MSP430 launchpad"
arch=('i686' 'x86_64')
url="http://energia.nu/"
license=('GPL')
groups=()
depends=(java-runtime)
if test "$CARCH" == x86_64; then
  depends+=(lib32-libusb-compat)
else
  depends+=(libusb-compat)
fi
makedepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=(!strip)
source=('https://github.com/downloads/energia/Energia/energia-0101E0009-linux.tgz'
        'http://i.imgur.com/KKxcXiv.png')
md5sums=('b6da90a2b44687632b1ed8dd028ae8e1'
         'f46521190830e8c10ea3a23ad352d79c')

# Don't compress, takes too long
PKGEXT='.pkg.tar'

build() {
  if [[ $CARCH == "x86_64" ]]; then
    # Fixing serial support
    echo "x86_64 build is unsupported by Energia and untested by me, report bugs to AUR"
    echo "if  this energia complains when compiling code, try recompilling mspgcc."
    echo "A script for this purpose is found at /opt/energia/hardware/tools/build-mspgcc"
    echo "this will install mspgcc at /opt/mspgcc, which should be detected by energia"
    echo "your path"
    cd "$srcdir"/$pkgname-0101E$pkgver/lib/
    mv librxtxSerial64.so librxtxSerial.so
  fi
}
package() {
  mkdir -p "$pkgdir"{/opt/energia,/usr/{bin,share/applications}}

  # Copy contents of archive to targets dirs
  cd "$srcdir/$pkgname-0101E$pkgver"
  cp -R . "$pkgdir/opt/energia"
  cp "$srcdir/KKxcXiv.png" "$pkgdir/opt/energia/energia.png"

  # Install links
  ln -s /opt/energia/energia "$pkgdir/usr/bin/"

  # Add desktop file
  cat > "$pkgdir/usr/share/applications/energia.desktop" << EOF
  [Desktop Entry]
  Name=Energia
  GenericName=Energia IDE
  Comment=The open-source Arduino environment for MSP431 Launchpad
  Exec=/opt/energia/energia
  Icon=/opt/energia/energia.png
  Type=Application
  Terminal=false
  Categories=Development;IDE;Application;
EOF
}

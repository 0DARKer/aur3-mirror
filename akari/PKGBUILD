#!/bin/bash
# Maintainer: jorge_barroso <jorge.barroso.11@gmail.com>

pkgname=akari
_basever=1.0.30
_timestamp=20131225
pkgver=${_basever}.${_timestamp}
_kernver=$(uname -r)
_ccstoolsver=1.8.3.20140601
pkgrel=1
pkgdesc='TOMOYO Linux 1.8.x Module for the Linux kernel'
arch=('any')
url='http://akari.sourceforge.jp/'
license=('GPL')
depends=("linux")
makedepends=("linux-headers")
optdepends=("ccs-tools>=${_ccstoolsver}")
conflicts=("ccs-tools<${_ccstoolsver}")
install=akari.install
source=("http://sourceforge.jp/frs/redir.php?f=/akari/49272/akari-${_basever}-${_timestamp}.tar.gz")
sha512sums=('ca9ff9c3210baa71b7b06d181d0791c7c6d1fc216f60507a6b455311a358fcacc4988a0622463d62dc89e1a15c3a49c0ea8903f0edfbd3c01c0d5c4a938ea436')
noextract=("akari-${_basever}-${_timestamp}.tar.gz")

build() {
  msg "Copying headers to source directory..."
  cp -a "/usr/src/linux-${_kernver}/" "${srcdir}"

  cd "${srcdir}/linux-${_kernver}/"

  msg "Extracting akari into kernel headers..."
  tar -xf "${srcdir}/akari-${_basever}-${_timestamp}.tar.gz"

  msg "Building akari module..."
  make SUBDIRS=akari SYSSRC=/lib/modules/${_kernver}/build modules
}

package() {
  install -D -m644 "${srcdir}/linux-${_kernver}/akari/akari.ko" \
    "${pkgdir}/lib/modules/${_kernver}/kernel/extra/akari.ko"

  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" "${startdir}/akari.install"
}

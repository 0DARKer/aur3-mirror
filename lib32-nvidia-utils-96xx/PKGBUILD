# Original PKGBUILD: lib32-nvidia-utils-180.29-3 by Florian Joncour aka Diablo150
# Derived from lib32-nvidia-utils-173.14.20-1 by Christofer Bertonha (ghost-linux)
# Contributor Viktor Jackson (Xlator)

pkgname=lib32-nvidia-utils-96xx
pkgver=96.43.16
pkgrel=1
pkgdesc="Legacy (96xx) x86 NVIDIA drivers utilities and libraries for x86_64 systems."
arch=(x86_64)
pkgrel=1
url="http://www.nvidia.com/"
license=('custom')
groups=('lib32')
depends=('lib32-libxext')
conflicts=('lib32-libgl' 'lib32-ati-fglrx-utils' 'lib32-nvidia-utils' 'lib32-nvidia-utils-beta ')
provides=('lib32-libgl' 'lib32-nvidia-utils')
license=('custom')
source=(ftp://download.nvidia.com/XFree86/Linux-x86/$pkgver/NVIDIA-Linux-x86-$pkgver-pkg$pkgrel.run)

options=(docs !strip)

build()
{
  # Delete old files
  cd $startdir
  rm -rf pkg/* src/NVIDIA-Linux-x86-${pkgver}-pkg$pkgrel/* pkg_temp
  # override nvida install routine and do it the long way.
  cd $startdir/src/
  sh NVIDIA-Linux-x86-${pkgver}-pkg$pkgrel.run --extract-only
  cd NVIDIA-Linux-x86-${pkgver}-pkg$pkgrel/usr/

  mkdir -p $startdir/pkg_temp
  mkdir -p $startdir/pkg_temp/usr/{lib,bin,share/applications,share/pixmaps,man/man1}
  mkdir -p $startdir/pkg_temp/usr/lib/xorg/modules/{extensions,drivers}
  mkdir -p $startdir/pkg_temp/usr/share/licenses/nvidia/
  
  install lib/{libGLcore,libGL,libnvidia-cfg,tls/libnvidia-tls}.so.${pkgver} \
       $startdir/pkg_temp/usr/lib/ || return 1
  install -m644 share/man/man1/* $startdir/pkg_temp/usr/man/man1/ || return 1
  rm $startdir/pkg_temp/usr/man/man1/nvidia-installer.1.gz || return 1
  install X11R6/lib/libXv* $startdir/pkg_temp/usr/lib/ || return 1
  install -m644 share/applications/nvidia-settings.desktop $startdir/pkg_temp/usr/share/applications/ || return 1
  # fix nvidia .desktop file
  sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i $startdir/pkg_temp/usr/share/applications/nvidia-settings.desktop
  install -m644 share/pixmaps/nvidia-settings.png $startdir/pkg_temp/usr/share/pixmaps/ || return 1
  #install X11R6/lib/modules/libnvidia-wfb.so.$pkgver $startdir/pkg_temp/usr/lib/xorg/modules || return 1
  install X11R6/lib/modules/drivers/nvidia_drv.so $startdir/pkg_temp/usr/lib/xorg/modules/drivers || return 1
  install X11R6/lib/modules/extensions/libglx.so.$pkgver $startdir/pkg_temp/usr/lib/xorg/modules/extensions || return 1
  install -m755 bin/nvidia-{settings,xconfig,bug-report.sh} $startdir/pkg_temp/usr/bin/ || return 1
#  cd $startdir/pkg_temp/usr/lib/
#  ln -s libGL.so.$pkgver libGL.so || return 1
#  ln -s libGL.so.$pkgver libGL.so.1 || return 1
#  ln -s libGLcore.so.$pkgver libGLcore.so.1 || return 1
#  ln -s libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1 || return 1
#  ln -s libnvidia-tls.so.$pkgver libnvidia-tls.so.1 || return 1
#  ln -s libXvMCNVIDIA.so.$pkgver libXvMCNVIDIA_dynamic.so.1 || return 1
#  cd $startdir/pkg_temp/usr/lib/xorg/modules/extensions
#  ln -s libglx.so.$pkgver libglx.so || return 1

  install -m644 $startdir/src/NVIDIA-Linux-x86-${pkgver}-pkg$pkgrel/LICENSE $startdir/pkg_temp/usr/share/licenses/nvidia/ || return 1
  ln -s nvidia $startdir/pkg_temp/usr/share/licenses/nvidia-utils || return 1
  install -D -m644 $startdir/src/NVIDIA-Linux-x86-${pkgver}-pkg$pkgrel/usr/share/doc/README.txt $startdir/pkg_temp/usr/share/doc/nvidia/README || return 1
  
  find $startdir/pkg_temp/usr -type d -exec chmod 755 {} \;

cd $startdir/pkg_temp
mkdir -p $startdir/pkg/opt/lib32/usr/lib
cp -dp usr/lib/*.so* $startdir/pkg/opt/lib32/usr/lib

# fix wrong links
cd $startdir/pkg/opt/lib32/usr/lib
ln -sf libGL.so.$pkgver libGL.so
ln -sf libGL.so.$pkgver libGL.so.1
ln -sf libGLcore.so.$pkgver libGLcore.so.1
ln -sf libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1
ln -sf libnvidia-tls.so.$pkgver libnvidia-tls.so.1
cd "$startdir"

}
md5sums=('1dc343ca57fa0f0cfd33c867a4c12f0b');

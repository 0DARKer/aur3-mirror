#!/bin/sh
#
# foldingathome-gpu-wrapper: Run the Folding@Home GPU client via Wine.
#

case "$*" in
	*[![:digit:]]*)
		echo "Usage: foldingathome-gpu-wrapper gpu_slot"
		exit 1
		;;
	"")
		gpu_slot=0
		;;
	*)
		gpu_slot="$1"
		;;
esac

# Prefix for Wine and path to CUDA libs.
export WINEPREFIX="/var/lib/foldingathome-gpu/gpu$gpu_slot"
export LD_LIBRARY_PATH="/opt/foldingathome-gpu:$LD_LIBRARY_PATH"

# Create a directory for Folding@Home work if it doesn't exist.
if [ ! -d "$WINEPREFIX" ]; then
	mkdir "$WINEPREFIX" || exit 1
fi

# Create symlinks and source the conf.d file.
cd "$WINEPREFIX" && \
ln -sf /etc/foldingathome-gpu/client.cfg && \
ln -sf /opt/foldingathome-gpu/cudart.dll.so cudart32_30_14.dll && \
ln -sf /opt/foldingathome-gpu/cufft.dll.so cufft32_30_14.dll && \
. /etc/conf.d/foldingathome-gpu || exit 1

# Run Folding@Home via Wine.
/usr/bin/wine /opt/foldingathome-gpu/Folding@home-Win32-gpu.exe $FAH_GPU_FLAGS -gpu "$gpu_slot"

# Maintainer: Sven-Hendrik Haase <sh@lutzhaase.com>
pkgname=pypy-svn
_pkgver=$(wget -qO- http://codespeak.net/svn/pypy/trunk/|grep '<title>'|grep -o [0-9]*)
pkgver=76438
pkgrel=1
pkgdesc="A Python implementation written in Python, JIT enabled"
url="http://codespeak.net/pypy/"
arch=('i686' 'x86_64')
depends=('python2' 'libffi')
optdepends=('openssl: openssl module'
            'expat: pyexpat module'
            'ncurses: ncurses module'
            'zlib: zlib module'
            'bzip2: bz2 module')
#makedepends=('tk')
conflicts=('pypy')
provides=('pypy')
license=('MIT')
#install=('')
source=()
md5sums=()

_svntrunk="http://codespeak.net/svn/pypy/trunk"
_svnmod="pypy-svn"

build() {
  cd ${srcdir}

  if [ -d ${_svnmod}/.svn ]; then
    (cd ${_svnmod} && svn up && cd ${srcdir})
  else
    svn co ${_svntrunk} --config-dir ./ ${_svnmod}
  fi

  msg "SVN checkout done or server timeout."

  rm -rf ${_svnmod}-build && svn export ${_svnmod} ${_svnmod}-build
  cd ${_svnmod}-build

  #cf="`pkg-config --cflags libffi`" || return 1
  #sed "s|cflags = \[|cflags = \[\'${cf/  /}\', |g" -i pypy/translator/platform/linux.py || return 1

  msg "Starting make."
  cd pypy/translator/goal
  python2 translate.py -Ojit targetpypystandalone.py
  install -Dm755 pypy-c ${pkgdir}/opt/pypy/pypy-c
  mkdir -p ${pkgdir}/opt/pypy/{lib-python,pypy}
  cp -r ${srcdir}/${_svnmod}-build/lib-python/2.5.2 ${pkgdir}/opt/pypy/lib-python/
  cp -r ${srcdir}/${_svnmod}-build/lib-python/modified-2.5.2 ${pkgdir}/opt/pypy/lib-python/
  cp -r ${srcdir}/${_svnmod}-build/lib_pypy ${pkgdir}/opt/pypy/
  mkdir -p ${pkgdir}/usr/bin/
  ln -s /opt/pypy/pypy-c ${pkgdir}/usr/bin/pypy
}
# vim: ts=2 sw=2 et:

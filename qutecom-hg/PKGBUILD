# QuteCom-Hg: Installer: Arch
# Contributor: Chris Giles <Chris.G.27 (at) Gmail.com>

realname=qutecom
pkgname=${realname}-hg
pkgver=695
realver=2.2-RC3
pkgrel=1
pkgdesc="A free VoIP softphone, superseding WengoPhone.  This is the latest repository source code."
arch=("i686" "x86_64")
url="http://www.${realname}.org/"
license=("GPL")
depends=("libstdc++5" "qt" "openssl" "gnutls" "e2fsprogs" "libxml2" "speex" "ffmpeg" "portaudio" "alsa-lib" "libsndfile" "libsamplerate" "curl" "libosip2")
makedepends=("gcc" "cmake" "qt" "boost" "glib2" "mercurial")
conflicts=("wengophone2" "${realname}")
#replaces=("wengophone2")
options=(!emptydirs)
source=()
md5sums=()
_hgroot="http://hg.${realname}.org/"
_hgrepo="${realname}-2.2"

build() {
	#cd ${srcdir}/${realname}-${realver}/build/
	cd ${srcdir}

	# Repository
	msg "Connecting to Mercurial server...."
	# update the repo, else clone a new one
	if [ -d ${_hgrepo} ]; then
		cd ${_hgrepo}/
		hg pull -u || return 1
	else
		hg clone ${_hgroot}/${_hgrepo} || return 1
		cd ${_hgrepo}/
	fi
	msg "Mercurial checkout done or server timeout"

	msg "Cloning wokring directory"
	cd ${srcdir}
	rm -rf ${srcdir}/${_hgrepo}-build 2>/dev/null
	cp -a ${_hgrepo} ${_hgrepo}-build
	cd ${_hgrepo}-build/build/

	msg "Starting make..."

	# Patches
	#patch -Np1 < ${startdir}/extra/dtmf_mode.diff || return 1

	# Build
	cmake .. -DCMAKE_INSTALL_PREFIX=/usr -Wno-dev || return 1
	make || return 1
	make DESTDIR=${pkgdir} install || return 1
	
	rm -rf ${srcdir}/${_hgrepo}-build 2>/dev/null
} 

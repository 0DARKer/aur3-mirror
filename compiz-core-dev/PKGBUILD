pkgname=compiz-core-dev
pkgver=0.9.4
pkgrel=3
pkgdesc="Core package of the current release from the Compiz development branch."
url="http://www.compiz.org/"
license=('GPL' 'LGPL' 'MIT')
arch=('i686' 'x86_64')
depends=('startup-notification' 'librsvg' 'libgl' 'dbus'
        'mesa' 'libxslt' 'fuse' 'boost' 'libstdc++5' 'glib2' 'glibmm')
optdepends=('ccsm-dev: CompizConfig Settings Manager'
	'compiz-backend-gconf-dev: use GConf for storage of Compiz preferences'
	'compiz-plugins-main-dev: main plugin package for Compiz'
	'compiz-plugins-extra-dev: extra plugins for Compiz'
	'metacity: support for Metacity window decoration themes (requires rebuild)') 
makedepends=('intltool' 'cmake')
provides=('compiz-core')
conflicts=('compiz-core')
install=('compiz.install')
source=("http://releases.compiz.org/$pkgver/compiz-core-${pkgver}.tar.gz"
	'gnome-compiz.session'
	'gnome-compiz.desktop'
	'compiz.desktop')
sha1sums=('26171d2224c05eef3f128462f3208ad9207aa7c9'
	'cdc586948762d6ddf886ec9c2fc4060211fb8e2f'
	'4428c95d0edef93a20a0f621496f03429c6253f6'
	'6c1905bc9940618ad25c265609549a8374e9edb3')
usegtk=true

build()
{
	if [ ! "pacman -Q metacity" ]; then
		echo -e "\a\n\nIt is possible to skip compilation of the bundled GTK Window Decorator if for example, you're using Emerald instead.\n"
		read -n1 -p "Build gtk-window-decorator? (y/n) "
		[[ "$REPLY" = [yY] ]] || usegtk=false
	fi
	if [[ "pacman -Q gnome-session | grep ^'gnome-session 3'" && ! -f /usr/share/gnome-session/sessions/gnome-compiz.session ]]; then
		echo -e "\a\n\nIf you wish, GNOME session entries can be added to enable launching Compiz ontop of the GNOME 3 stack."
		read -n1 -p "Add gnome-session configuration entries? (y/n) "
		if [[ "$REPLY" = [yY] ]]; then
			install -m755 -d "$pkgdir"/usr/share/{gnome-session/sessions,xsessions,applications}/
			install -m644 ../gnome-compiz.session "$pkgdir"/usr/share/gnome-session/sessions/
			install -m644 ../gnome-compiz.desktop "$pkgdir"/usr/share/xsessions/
			install -m644 ../compiz.desktop "$pkgdir"/usr/share/applications/
		fi
	fi
	cd "core"
	[[ -d build ]] || mkdir build
	cd build
	cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DCOMPIZ_DESTDIR="${pkgdir}" -DCMAKE_CXX_FLAGS="-g -O2 -I/usr/include/glib-2.0" \
		-DCOMPIZ_DEFAULT_PLUGINS="composite,opengl,decor,resize,place,move" -DUSE_GTK="$usegtk" \
		-DCOMPIZ_DISABLE_PLUGIN_FADE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_SCREENSHOT=Off \
		-DCOMPIZ_DISABLE_PLUGIN_OBS=Off \
		-DCOMPIZ_DISABLE_PLUGIN_DECOR=Off \
		-DCOMPIZ_DISABLE_PLUGIN_SCALE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_RESIZE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_CLONE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_WATER=Off \
		-DCOMPIZ_DISABLE_PLUGIN_ANNOTATE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_COMMANDS=Off \
		-DCOMPIZ_DISABLE_PLUGIN_BLUR=Off \
		-DCOMPIZ_DISABLE_PLUGIN_CUBE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_COMPOSITE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_COPYTEX=Off \
		-DCOMPIZ_DISABLE_PLUGIN_GNOMECOMPAT=Off \
		-DCOMPIZ_DISABLE_PLUGIN_OPENGL=Off \
		-DCOMPIZ_DISABLE_PLUGIN_KDE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_REGEX=Off \
		-DCOMPIZ_DISABLE_PLUGIN_COMPIZTOOLBOX=Off \
		-DCOMPIZ_DISABLE_PLUGIN_SWITCHER=Off \
		-DCOMPIZ_DISABLE_PLUGIN_INOTIFY=Off \
		-DCOMPIZ_DISABLE_PLUGIN_ROTATE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_PLACE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_MOVE=Off \
		-DCOMPIZ_DISABLE_PLUGIN_WOBBLY=Off \
		-DCOMPIZ_DISABLE_PLUGIN_INI=Off \
		-DCOMPIZ_DISABLE_PLUGIN_ZOOM=Off \
		-DCOMPIZ_DISABLE_PLUGIN_IMGPNG=Off \
		-DCOMPIZ_DISABLE_PLUGIN_DBUS=Off \
		-DCOMPIZ_DISABLE_PLUGIN_IMGSVG=Off 
      	make
	make install
	make findcompiz_install
}


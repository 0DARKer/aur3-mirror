# Maintainer: Bhoppi Chaw <bhoppi@hotmail.com>
# Contributor: Thiago Coutinho
# Contributor: Thomas Dziedzic

pkgname=ns-3
pkgver=3.10
pkgrel=2
pkgdesc='Discrete-event network simulator to replace ns-2'
arch=('i686' 'x86_64')
url='http://www.nsnam.org/'
license=('GPL')
depends=('gsl'
         'gtk2'
         'libxml2'
         'python2'
         'sqlite3')
makedepends=('fakeroot'
             'findutils')
optdepends=('openmpi: mpi support')
source=("http://www.nsnam.org/releases/ns-allinone-$pkgver.tar.bz2")

build()
{
    # _use_mpi='--enable-mpi'
    echo '********************************'
    echo '* To compile with mpi support, you should edit this PKGBUILD file'
    echo '* and UNCOMMENT "_use_mpi" variable.'
    echo '********************************'

    _nsprofile='release'
    _pysitedir="$(python2 -c 'from distutils.sysconfig import get_python_lib;\
        print(get_python_lib())')"
    _workdir="$srcdir/ns-allinone-$pkgver/ns-$pkgver"
    _incdir="$pkgdir/usr/include"
    _pydir="$pkgdir/${_pysitedir:1}"
    _sharedir="$pkgdir/usr/share/ns3"

    mkdir -p $_incdir $_pydir $_sharedir
    
    # build nsc first
    cd "$_workdir/../nsc-0.5.2"
    python2 scons.py liblinux2.6.26.so || return 1
    
    # build ns-3
    cd $_workdir
    cp -r scratch $_sharedir
    rm -r scratch/*
    python2 waf configure --prefix=/usr -d $_nsprofile --disable-examples --enable-python-pch\
        $_use_mpi || return 1
    python2 waf build || return 1
    python2 waf --destdir=$pkgdir install || return 1
    
    # polish
    cd $_workdir
    find examples samples -name 'waf' -delete
    find examples samples -name 'wscript' -delete
    mv examples samples $_sharedir
    cd $_workdir/build/$_nsprofile
    mv ns3 $_incdir/
    chmod 644 $_incdir/ns3/*
    mv bindings/python/ns3 $_pydir
    rm $pkgdir/usr/lib/_ns3.so
}
md5sums=('3d974d46cb0ca25e1de20ee57a68be4f')

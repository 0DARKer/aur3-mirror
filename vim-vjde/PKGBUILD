# vim:set ts=2 sw=2 et ft=sh tw=100: expandtab
# Contributor: Piotr Rogo≈ºa <rogoza dot piotr at gmail dot com>
# Created: 05/12/2011

pkgname=vim-vjde
pkgver=2.6.18
_scriptid=17026
_ext=tgz
pkgrel=2
pkgdesc='Just a Development Environment for VIM'
arch=('i686' 'x86_64')
url='http://vim.org/scripts/script.php?script_id=1213'
license=('custom:vim')
groups=('vim-plugins')
depends=('vim-runtime' 'java-environment')
makedepends=()
optdepends=('ctags: to replace readtags, ')
provides=()
conflicts=()
replaces=()
backup=()
options=()
install='vimdoc.install'
source=(
  "${pkgname}-${pkgver}.${_ext}::http://www.vim.org/scripts/download_script.php?src_id=${_scriptid}"
  license.txt
)
_fix_files(){ #{{{
  local orig_file=$1
  if [ ! -w "$orig_file" -o ! -s "$orig_file" ]; then
    return
  fi
  
  # remove 'carriage return'
  sed -e 's/\r//g' -i $orig_file

  # change encoding
  iconv -c -f gbk -t utf8 $orig_file > ${orig_file}.fix && \
    mv ${orig_file}.fix ${orig_file} || return 1
} #}}}
export -f _fix_files
build() {
	cd "$srcdir"
	_vim_dir='/usr/share/vim/vimfiles'

  # compile readtags
  cd ${srcdir}/src
  gcc -o ../plugin/vjde/readtags -DREADTAGS_MAIN readtags.c
  cd -
  rm -rf ${srcdir}/src
  find ${srcdir} \( -iname '*.exe' -o -iname '*.dll' \) -exec rm -fv '{}' ';'

  # install files
  install -dm755 ${pkgdir}/${_vim_dir} || return 1
  install -dm755 ${pkgdir}/usr/bin || return 1

  tar -c ./  --exclude ${pkgname}-${pkgver}.${_ext} --exclude license.txt | tar -x -C ${pkgdir}/${_vim_dir} || return 1
  install -Dm644 license.txt ${pkgdir}/usr/share/licenses/custom/${pkgname}/license.txt || return 1
  
  mv ${pkgdir}/${_vim_dir}/plugin/vjde/readtags ${pkgdir}/usr/bin || return 1
  cd ${pkgdir}/${_vim_dir}/plugin/vjde || return 1
  ln -s /usr/bin/readtags

  # fixing files
  find ${pkgdir}/${_vim_dir} -type f -a ! -name '*.class' -a ! -name '*.jar' -exec bash -c '_fix_files {}' ';'
}

md5sums=('29fa90a0ec504ed2b5587d401455ba1e'
         'efbd5986e691ce8c876fb86e8f5961ea')

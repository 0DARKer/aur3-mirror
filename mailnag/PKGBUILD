# Maintainer: Sebastian Lenz <sebastian@archusers.de>
pkgname=mailnag
pkgver=41
pkgrel=1
pkgdesc="Mailnag is a fork of the Popper mail notifier"
arch=('i686' 'x86_64')
url="https://launchpad.net/mailnag"
license=('GPL')
depends=('pyxdg' 'python-notify' 'python-gnomekeyring'
'python-httplib2' 'pygtk' 'pygobject' 'alsa-utils' )
makedepends=('bzr')

install=('mailnag.install')

_bzrtrunk=http://bazaar.launchpad.net//~pulb/mailnag/trunk
_bzrmod=mailnag



build() {
  cd "$srcdir"
  msg "Connecting to Bazaar server...."

  if [ -d $_bzrmod ] ; then
    cd ${_bzrmod} && bzr --no-plugins pull ${_bzrtrunk} -r ${pkgver}
    msg "The local files are updated."
  else
    bzr --no-plugins branch ${_bzrtrunk} ${_bzrmod} -q -r ${pkgver}
  fi

  msg "Bazaar checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_bzrmod-build"
  cp -r "$srcdir/$_bzrmod" "$srcdir/$_bzrmod-build"
  cd "$srcdir/$_bzrmod-build"

  # python2 fix
  for file in $(find . -name '*.py' -print); do
    sed -i 's_#!.*/usr/bin/python_#!/usr/bin/python2_' $file
    sed -i 's_#!.*/usr/bin/env.*python_#!/usr/bin/env python2_' $file
  done

  for file in {mailnag,mailnag_config};do
       sed -i 's/python/python2/' $file
  done

}

package() {
  install -d -m755 "${pkgdir}"/usr/{bin,lib/${pkgname}}
  install -d -m755 ${pkgdir}/usr/{bin,lib/${pkgname}}
  cp -r $srcdir/$_bzrmod-build/* ${pkgdir}/usr/lib/${pkgname}
  ln -s ${pkgdir}/usr/lib/${pkgname}/{mailnag,mailnag_config} ${pkgdir}/usr/bin
}

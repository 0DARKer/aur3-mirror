# Maintainer: Daniele Zelante <zeldan at zeldan dot net>

_mingw_w64_ver="1.0"
_mingw_w64_date="20110805" # latest x86_64 and i686 with 1.0 stable prefix

_actual_file="mingw-w64-${_mingw_w64_ver}-bin_${CARCH}-linux_${_mingw_w64_date}.tar.bz2"
_repository="http://downloads.sourceforge.net/project/mingw-w64/Toolchains%20targetting%20Win64/Automated%20Builds/"

epoch=1
pkgname='mingw-w64-bin'
pkgver="${_mingw_w64_ver}_${_mingw_w64_date}"
pkgrel=1
pkgdesc="MinGW Toolchain fork for building Windows x86_64 executables - Automated Builds provided by mingw-w64 upstream"
url="http://mingw-w64.sourceforge.net/"
arch=('i686' 'x86_64')
license=('GPL')
depends=('bash' 'zlib')
makedepends=('bar')
options=(!strip docs zipman !emptydirs !libtool)
install=${pkgname}.install


build() {

    # hack to avoid md5sum since it is ARCH dependent
    cd ${SRCDEST}/
    wget -nc "${_repository}${_actual_file}"

    mkdir -p ${srcdir}/mingw_w64/
    cd ${srcdir}/mingw_w64
    echo "Extracting files from binary tarball : "
    bar ${SRCDEST}/${_actual_file} | tar jx

    # remove wrong permissions in downloaded tarball files
    echo "Fixating permissions on files ... "
    chmod -R a+X,a+r .
    find . -name '*.a' -exec chmod -x {} \;
}

package() {

    mkdir -p "${pkgdir}/opt/"
    
    # use hard links to be more efficient in copying
    echo "Copying to package directory ... "
    cp -lr "${srcdir}/mingw_w64" "${pkgdir}/opt/"
    
    (
        mkdir -p "${pkgdir}/usr/bin"
        cd "${pkgdir}/usr/bin"
        find "../../opt/mingw_w64/bin/" -type f -name 'x86_64-w64-mingw32-*' -exec ln -s {} \;
    )

}


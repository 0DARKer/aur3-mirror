# Maintainer: Lukas Jirkovsky <l.jirkovsky@gmail.com>

pkgname=exult-svn
pkgver=6264
pkgrel=1
pkgdesc="A recreation of the Ultima 7 engine"
arch=('i686' 'x86_64')
url="http://exult.sourceforge.net/"
license=('GPL2')
depends=('sdl_mixer' 'alsa-lib' 'gcc-libs' 'libxft')
optdepends=('libpng' 'timidity++')
makedepends=('subversion')
provides=('exult')
conflicts=('exult' 'exult-cvs')
replaces=('exult-cvs')
source=(http://downloads.sourceforge.net/project/exult/BG-data/Sound%20Packs/U7MusicOGG_1of2.zip \
        http://downloads.sourceforge.net/project/exult/BG-data/Sound%20Packs/U7MusicOGG_2of2.zip)
md5sums=('7746d1a9164fd67509107797496553bf'
         'cdae5956d7c52f35e90317913a660123')

_svntrunk="https://exult.svn.sourceforge.net/svnroot/exult/exult/trunk"
_svnmod="exult"

build() {
  cd "$srcdir"
  msg "Connecting to $_svnmod.sourceforge.net SVN server...."
  if [ -d $_svnmod/.svn ]; then
  	cd $_svnmod && svn up -r $pkgver
  else
  	svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
  fi
  msg "SVN checkout done or server timeout"
  msg "Starting make..."

  if [ -e "$srcdir"/$_svnmod-build ]; then
  	rm -rf "$srcdir"/$_svnmod-build
  fi

#  cd "$srcdir"/$_svnmod
#  patch -Np0 < "$srcdir"/include_fix.diff
#  ./autogen.sh

#  mkdir -p "$srcdir"/$_svnmod-build
  cp -r "$srcdir"/$_svnmod "$srcdir"/$_svnmod-build
  cd "$srcdir"/$_svnmod-build
  ./autogen.sh

  LIBS="-lXft -lX11" ./configure --prefix=/usr --enable-shared --disable-static \
    --with-timidity="/etc/timidity++/timidity.cfg"
  make || return 1
  make DESTDIR="$pkgdir" install || return 1

  # Install Digital Music
  install -d -m755 "$pkgdir"/usr/share/exult/music
  install "$srcdir"/*.ogg "$pkgdir"/usr/share/exult/music
}

# Maintainer: Philip 'Chais' Abernethy <chais.z3r0@gmail.com>
pkgname=hammerwatch
pkgver=1.23
pkgrel=1
epoch=
pkgdesc="A hack and slash action adventure, set in a fantasy pixel art environment"
arch=('i686' 'x86_64')
url="http://www.hammerwatch.com/"
license=('custom:commercial')
DLAGENTS+=('hib::/usr/bin/echo "Could not find %u. Manually download it to \"$(pwd)\", or set up a hib:// DLAGENT in /etc/makepkg.conf."; exit 1')
source=("hib://${pkgname}_linux${pkgver}.zip"
        "${pkgname}.png")
sha512sums=('7961fa5da9893b8300df0ec918b98cf880e3bae2a38087658ebc45e20845752b278138c7afb9d055bbb8a033ef74116ce80d4cab723db08418831b35d1f4817c'
            'da116253e3a828ee365da992be96a88acbe64f6cf32fdf77cb935fe74ed14f49e0bc33fe2fe8edf7dead7bc72d6a97b9a46e7220e92cf474e295298b017b1540')

package() {
	install -dm755 "${pkgdir}"/usr/{bin,share/applications}
	install -Dm644 "${srcdir}/${source[1]}" "${pkgdir}/usr/share/pixmaps/${source[1]}"
	echo "[Desktop Entry]
Type=Application
Version=${pkgver}
Name=${pkgname^}
GenericName=${pkgname^}
Comment=${pkgdesc}
Categories=Game;
Icon=${pkgname}
Exec=/usr/bin/${pkgname}
Path=/opt/${pkgname}" > "${pkgdir}/usr/share/applications/${pkgname}.desktop"
	pushd "${srcdir}/${pkgname^}"
	if [[ "$CARCH" == 'i686' ]]; then
		install -Dm755 "${srcdir}/${pkgname^}/${pkgname^}.bin.x86" "${pkgdir}/opt/${pkgname}/${pkgname^}.bin.x86"
		echo "#!/bin/sh
if [[ ! -d /tmp/${pkgname} ]]; then
	mkdir /tmp/${pkgname}
fi
cd /opt/${pkgname}
./${pkgname^}.bin.x86
# Comment the following line if you'd like to keep logs and errors
rm -r /tmp/${pkgname}" > "${pkgdir}/usr/bin/${pkgname}"
		chmod 755 "${pkgdir}/usr/bin/${pkgname}"
		install -dm755 "${pkgdir}/opt/${pkgname}/lib"
		find lib -type f -exec install "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	else
		install -Dm755 "${srcdir}/${pkgname^}/${pkgname^}.bin.x86_64" "${pkgdir}/opt/${pkgname}/${pkgname^}.bin.x86_64"
		echo "#!/bin/sh
if [[ ! -d /tmp/${pkgname} ]]; then
	mkdir /tmp/${pkgname}
fi
cd /opt/${pkgname}
./${pkgname^}.bin.x86_64
# Comment the following line if you'd like to keep logs and errors
rm -r /tmp/${pkgname}" > "${pkgdir}/usr/bin/${pkgname}"
		chmod 755 "${pkgdir}/usr/bin/${pkgname}"
		install -dm755 "${pkgdir}/opt/${pkgname}/lib64"
		find lib64 -type f -exec install "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	fi
	ln -s /tmp/${pkgname}/game.log "${pkgdir}/opt/${pkgname}/game.log"
	ln -s /tmp/${pkgname}/error.txt "${pkgdir}/opt/${pkgname}/error.txt"
	install -m644 "Hammerwatch.exe" -t "${pkgdir}/opt/${pkgname}/"
	install -m644 "assets.bin" -t "${pkgdir}/opt/${pkgname}/"
	find editor -type d -exec install -dm755 "${pkgdir}/opt/${pkgname}/{}" \;
	find levels -type d -exec install -dm755 "${pkgdir}/opt/${pkgname}/{}" \;
	find mono -type d -exec install -dm755 "${pkgdir}/opt/${pkgname}/{}" \;
	find mono -type f -exec install -m644 "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	find levels -type f -exec install -m644 "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	find editor -type f -name "*dll*" -exec install -m644 "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	find editor -type f -name "*exe" -exec install -m644 "{}" "${pkgdir}/opt/${pkgname}/{}" \;
	find -type f -name "*dll*" -exec install -m644 "{}" "${pkgdir}/opt/${pkgname}/{}" \;
}

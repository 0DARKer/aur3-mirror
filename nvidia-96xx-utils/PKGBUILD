# Actual maintainer: Luis Moreno <luismoreno83 at gmail dot com>
# Based on nvidia-173xx-utils 
# You'll need to get the files "nvidia.install" and "20-nvidia.conf" from nvidia-173xx-utils aur tarball

pkgname=nvidia-96xx-utils
pkgver=96.43.20
pkgrel=2
pkgdesc="NVIDIA drivers utilities and libraries, 96xx branch."
arch=('i686' 'x86_64')
[ "$CARCH" = "i686"   ] && ARCH=x86
[ "$CARCH" = "x86_64" ] && ARCH=x86_64
url="http://www.nvidia.com/"
depends=('xorg-server')
optdepends=('gtk2: nvidia-settings' 'pkgconfig: nvidia-xconfig')
conflicts=('lib32-libgl' 'lib32-ati-fglrx-utils' 'lib32-nvidia-utils' 'lib32-nvidia-utils-beta' 'libgl' 'ati-fglrx-utils' 'nvidia-utils' 'nvidia-utils-beta')
provides=('libgl' 'nvidia-96xx-utils')
license=('custom')
install=nvidia.install
options=(!strip)
backup=('etc/X11/xorg.conf.d/20-nvidia.conf')
[ "$CARCH" = "i686" ] && ARCH=x86 && NV=0
[ "$CARCH" = "x86_64" ] && ARCH=x86_64 && NV=2
license=('custom')
source=(ftp://download.nvidia.com/XFree86/Linux-$ARCH/${pkgver}/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}.run)

sha256sums=('bc778062cf745ee4916de77a702f702312d33eeb3b6f379b63e4366fa5197517')
[ "$CARCH" = "x86_64" ] && sha256sums=('562107a262e250b836966e29851628f6162ee2857d53252221c780d9b201de18')

source[1]='20-nvidia.conf'
sha256sums[1]='fc58443a47f07eb713b05f0fbe625a7a9f1fccd8e9ba0672cbeba6824adae89f'

build()
{
    cd $srcdir
	sh NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}.run --extract-only
	cd NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}/usr/

	mkdir -p $pkgdir/usr/{lib,bin,share/applications,share/pixmaps,share/man/man1}
	mkdir -p $pkgdir/usr/lib/xorg/modules/{extensions,drivers}
	mkdir -p $pkgdir/usr/share/licenses/nvidia-96xx/

	install lib/{libGLcore,libGL,libnvidia-cfg,tls/libnvidia-tls}.so.${pkgver} \
	$pkgdir/usr/lib/
	install -m644 share/man/man1/* $pkgdir/usr/share/man/man1/
	rm $pkgdir/usr/share/man/man1/nvidia-installer.1.gz
	install X11R6/lib/libXv* $pkgdir/usr/lib/
	install -m644 share/applications/nvidia-settings.desktop $pkgdir/usr/share/applications/
	# fix nvidia .desktop file
	sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i $pkgdir/usr/share/applications/nvidia-settings.desktop
	install -m644 share/pixmaps/nvidia-settings.png $pkgdir/usr/share/pixmaps/
	install X11R6/lib/modules/drivers/nvidia_drv.so $pkgdir/usr/lib/xorg/modules/drivers
	install X11R6/lib/modules/extensions/libglx.so.$pkgver $pkgdir/usr/lib/xorg/modules/extensions
	install -m755 bin/nvidia-{settings,xconfig,bug-report.sh} $pkgdir/usr/bin/
	cd $pkgdir/usr/lib/
	ln -s libGL.so.$pkgver libGL.so
	ln -s libGL.so.$pkgver libGL.so.1
	ln -s libGLcore.so.$pkgver libGLcore.so.1
	ln -s libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1
	ln -s libnvidia-tls.so.$pkgver libnvidia-tls.so.1
	ln -s libXvMCNVIDIA.so.$pkgver libXvMCNVIDIA_dynamic.so.1

	cd $pkgdir/usr/lib/xorg/modules/extensions
	ln -s libglx.so.$pkgver libglx.so

	install -m644 $srcdir/NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}/LICENSE $pkgdir/usr/share/licenses/nvidia-96xx/
	ln -s nvidia-96xx $pkgdir/usr/share/licenses/nvidia-96xx-utils

	install -D -m644 $srcdir/NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}/usr/share/doc/README.txt $pkgdir/usr/share/doc/nvidia-96xx/README

	find $pkgdir/usr -type d -exec chmod 755 {} \;

    # Install xorg.conf.d file for nvidia autodetection in xorg.conf-less configurations
	install -D -m644 $srcdir/20-nvidia.conf $pkgdir/etc/X11/xorg.conf.d/20-nvidia.conf
}

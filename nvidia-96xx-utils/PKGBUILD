# Actual maintainer: Luis Moreno <luismoreno83 at gmail dot com>
# Based on lib32-nvidia-utils-96xx

pkgname=nvidia-96xx-utils
pkgver=96.43.19
pkgrel=1
pkgdesc="NVIDIA drivers utilities, 96xx branch."
arch=('i686' 'x86_64')
_kernver=`uname -r`
[ "$CARCH" = "i686" ] && ARCH=x86 && NV=0
[ "$CARCH" = "x86_64" ] && ARCH=x86_64 && NV=2
provides=('nvidia-96xx')
url="http://www.nvidia.com/"
depends=("xorg-server<10.0.0")
conflicts=('lib32-libgl' 'lib32-ati-fglrx-utils' 'lib32-nvidia-utils' 'lib32-nvidia-utils-beta' 'libgl' 'ati-fglrx-utils' 'nvidia-utils' 'nvidia-utils-beta')
provides=('libgl' 'nvidia-96xx-utils')
license=('custom')
source=(ftp://download.nvidia.com/XFree86/Linux-$ARCH/${pkgver}/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}.run)

sha256sums=('e25810e809ea56ab33ebb3e79e885eb19784dcce2bb0102c0cb5daa372aaf1c8')
[ "$CARCH" = "x86_64" ] && sha256sums=('81939f9ee45255cc137719a10b8947bc90cf5697da9e27991cee5a7061d5de19')



options=(docs !strip)

build()
{
	# Delete old files
	cd $startdir
	rm -rf pkg/* src/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}/* pkg_temp
	# override nvidia install routine and do it the long way.
	cd $startdir/src/
	sh NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}.run --extract-only
	cd NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}/usr/

	mkdir -p $startdir/pkg_temp
	mkdir -p $startdir/pkg_temp/usr/{lib,bin,share/applications,share/pixmaps,man/man1}
	mkdir -p $startdir/pkg_temp/usr/lib/xorg/modules/{extensions,drivers}
	mkdir -p $startdir/pkg_temp/usr/share/licenses/nvidia/

	install lib/{libGLcore,libGL,libnvidia-cfg,tls/libnvidia-tls}.so.${pkgver} \
	   $startdir/pkg_temp/usr/lib/ || return 1
	install -m644 share/man/man1/* $startdir/pkg_temp/usr/man/man1/ || return 1
	rm $startdir/pkg_temp/usr/man/man1/nvidia-installer.1.gz || return 1
	install X11R6/lib/libXv* $startdir/pkg_temp/usr/lib/ || return 1
	install -m644 share/applications/nvidia-settings.desktop $startdir/pkg_temp/usr/share/applications/ || return 1
	# fix nvidia .desktop file
	sed -e 's:__UTILS_PATH__:/usr/bin:' -e 's:__PIXMAP_PATH__:/usr/share/pixmaps:' -i $startdir/pkg_temp/usr/share/applications/nvidia-settings.desktop
	install -m644 share/pixmaps/nvidia-settings.png $startdir/pkg_temp/usr/share/pixmaps/ || return 1
	#install X11R6/lib/modules/libnvidia-wfb.so.$pkgver $startdir/pkg_temp/usr/lib/xorg/modules || return 1
	install X11R6/lib/modules/drivers/nvidia_drv.so $startdir/pkg_temp/usr/lib/xorg/modules/drivers || return 1
	install X11R6/lib/modules/extensions/libglx.so.$pkgver $startdir/pkg_temp/usr/lib/xorg/modules/extensions || return 1
	install -m755 bin/nvidia-{settings,xconfig,bug-report.sh} $startdir/pkg_temp/usr/bin/ || return 1
	#  cd $startdir/pkg_temp/usr/lib/
	#  ln -s libGL.so.$pkgver libGL.so || return 1
	#  ln -s libGL.so.$pkgver libGL.so.1 || return 1
	#  ln -s libGLcore.so.$pkgver libGLcore.so.1 || return 1
	#  ln -s libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1 || return 1
	#  ln -s libnvidia-tls.so.$pkgver libnvidia-tls.so.1 || return 1
	#  ln -s libXvMCNVIDIA.so.$pkgver libXvMCNVIDIA_dynamic.so.1 || return 1
	#  cd $startdir/pkg_temp/usr/lib/xorg/modules/extensions
	#  ln -s libglx.so.$pkgver libglx.so || return 1

	install -m644 $startdir/src/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}/LICENSE $startdir/pkg_temp/usr/share/licenses/nvidia/ || return 1
	ln -s nvidia $startdir/pkg_temp/usr/share/licenses/nvidia-utils || return 1
	install -D -m644 $startdir/src/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}/usr/share/doc/README.txt $startdir/pkg_temp/usr/share/doc/nvidia/README || return 1

	find $startdir/pkg_temp/usr -type d -exec chmod 755 {} \;

	cd $startdir/pkg_temp
	mkdir -p $startdir/pkg/usr/lib
	cp -dp usr/lib/*.so* $startdir/pkg/usr/lib

	# fix wrong links
	cd $startdir/pkg/usr/lib
	ln -sf libGL.so.$pkgver libGL.so
	ln -sf libGL.so.$pkgver libGL.so.1
	ln -sf libGLcore.so.$pkgver libGLcore.so.1
	ln -sf libnvidia-cfg.so.$pkgver libnvidia-cfg.so.1
	ln -sf libnvidia-tls.so.$pkgver libnvidia-tls.so.1
	cd "$startdir"

}



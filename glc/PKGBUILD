# Maintainer: 
# Contributor: kumyco <kumyco@kh.nu>
pkgname=glc
pkgver=0.5.8
pkgrel=2
pkgdesc="An ALSA & OpenGL capture tool for Linux"
arch=("i686" "x86_64")
url="http://nullkey.ath.cx/projects/glc"
install=glc.install
source=("Copyright"
  "http://nullkey.ath.cx/glc/archive/glc-$pkgver.tar.gz"
  "http://nullkey.ath.cx/elfhacks/archive/elfhacks-0.4.1.tar.gz"
  "http://nullkey.ath.cx/packetstream/archive/packetstream-0.1.4.tar.gz")
license=("CUSTOM")
depends=("libpng" "alsa-lib" "libgl")
makedepends=("cmake" "mesa")
conflicts=("glc-git")

md5sums=('d706bd101063967583d3e4f98e0bf14a'
         '92463f64fdcf123b1dbc67fc79ff9a13'
         '1c9bfa5dd6cfaed0a514fd2cf1eb3c6c'
         '89ce1ecfd592c9419be3e2e4ea1aba28')
sha1sums=('8df4c92df2a6ddefccc5ee16d05298c7e8351094'
          '012812ad68be4ffcdcbd064023b1e4e1c2157261'
          '471ee23a9030edefe193f162a0cb8bb492231109'
          '9859fb832c34fc999ea29e755f35a903f6018f38')


build() {
	cd $srcdir
	ln -sf $srcdir/elfhacks $srcdir/glc/elfhacks
	ln -sf $srcdir/packetstream $srcdir/glc/packetstream
	
	DESTDIR=$pkgdir/usr
	if [ $CARCH == "x86_64" ]; then
		MLIBDIR="lib64"
		CFLAGS="$CFLAGS -m64"
	else
		MLIBDIR="lib"
	fi
	export CMAKE_INCLUDE_PATH="$srcdir/glc/elfhacks/src:$srcdir/glc/packetstream/src"
	export CMAKE_LIBRARY_PATH="$srcdir/glc/elfhacks/build/src:$srcdir/glc/packetstream/build/src"
	
	mods=("elfhacks" "packetstream" "glc")
	for mod in ${mods[@]}; do
		msg "Building $mod..."
		[ -d $mod/build ] || mkdir $mod/build
		cd $mod/build
		
		cmake .. \
			-DCMAKE_INSTALL_PREFIX:PATH="${DESTDIR}" \
			-DCMAKE_BUILD_TYPE:STRING="Release" \
			-DCMAKE_C_FLAGS_RELEASE_RELEASE:STRING="${CFLAGS}" > /dev/null \
			-DMLIBDIR="${MLIBDIR}" \
			|| return 1
		make || return 1
		cd ../..
	done
	
	
	for mod in ${mods[@]}; do
		msg "Installing $mod to pkgdir..."
		cd $srcdir/$mod/build
		make install || return 1
	done
	
	install -d -m755 $pkgdir/usr/share/glc/scripts
	install -m755 $srcdir/glc/scripts/capture.sh $pkgdir/usr/share/glc/scripts/capture.sh
	install -m755 $srcdir/glc/scripts/play.sh $pkgdir/usr/share/glc/scripts/play.sh
	install -m755 $srcdir/glc/scripts/encode.sh $pkgdir/usr/share/glc/scripts/encode.sh
	install -d -m755 $pkgdir/usr/share/licenses/glc
	install -m644 $srcdir/Copyright $pkgdir/usr/share/licenses/glc/Copyright
}


# Maintainer : Sauyon Lee <sauyonl@sauyon.com>

pkgname=syncthing-git
pkgver=0.8.9.r12.g04130fc
pkgrel=3
pkgdesc="Open Source Continuous Replication / Cluster Synchronization Thing"
url="http://syncthing.net/"
license=('MIT')
makedepends=('git' 'go' 'godep' 'mercurial')
conflicts=('syncthing')
provides=('syncthing')
arch=('armv6h' 'armv7h' 'i686' 'x86_64')
source=("$pkgname::git+https://github.com/calmh/syncthing.git"
        "syncthing@.service"
				"syncthing.1.gz")
sha256sums=('SKIP'
            '2b8ae688a7d60be7899b6124591804eacca7dd29e980d3eaa8a28b0f7a28ac44'
            '5b06ffab900b4f140029414b927a7dbed54f10cd52b0b40dda887ca01b96948e')
install=${pkgname}.install

pkgver() {
	cd "$srcdir/go/src/github.com/calmh/syncthing"
	git describe --long | sed -E 's/^v//;s/([^-]*-g)/r\1/;s/-/./g'
}

prepare() {
	export GOPATH="$srcdir"

	mkdir -p "$srcdir/src/github.com/calmh"
	mv "$srcdir/$pkgname" "$srcdir/src/github.com/calmh/syncthing"
}

build() {
	cd "$srcdir/src/github.com/calmh/syncthing"

	GOPATH="$srcdir" ./build.sh
}

check() {
	cd "$srcdir/src/github.com/calmh/syncthing"

	GOPATH="$srcdir" ./build.sh test
}

package() {
	cd "$srcdir"
	install -Dm644 syncthing.1.gz "${pkgdir}/usr/share/man/man1/${pkgname}.1.gz"

  cd "src/github.com/calmh/syncthing"
  install -Dm755 syncthing "$pkgdir/usr/bin/syncthing"
  install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -Dm644 "$srcdir/syncthing@.service" "$pkgdir/usr/lib/systemd/system/syncthing@.service"
}

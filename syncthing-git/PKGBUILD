# Maintainer : Sauyon Lee <sauyonl@sauyon.com>

pkgname=syncthing-git
pkgver=v0.8.7.r27.g30837a7
pkgrel=2
_pkgarch=amd64
pkgdesc="Open Source Continuous Replication / Cluster Synchronization Thing"
url="http://syncthing.net/"
license=('MIT')
makedepends=('git' 'go' 'mercurial')
conflicts=('syncthing')
provides=('syncthing')
arch=('armv6h' 'armv7h' 'i686' 'x86_64')
source=("$pkgname::git://github.com/calmh/syncthing.git"
        "syncthing@.service")
sha256sums=('SKIP'
            '2b8ae688a7d60be7899b6124591804eacca7dd29e980d3eaa8a28b0f7a28ac44')
install=${pkgname}.install

pkgver() {
	cd "$srcdir/go/src/github.com/calmh/syncthing"
	git describe --long | sed -E 's/([^-]*-g)/r\1/;s/-/./g'
}

build() {
	export GOPATH="$srcdir/go"
	export PATH="$srcdir/go/bin:$PATH"

	rm -rf "$srcdir/go"
	mkdir -p "$srcdir/go/src/github.com/calmh"
	mv "$srcdir/$pkgname" "$srcdir/go/src/github.com/calmh/syncthing"
	cd "$srcdir/go/src/github.com/calmh/syncthing"

	echo $GOPATH

	echo Installing godep...
	go get -u github.com/tools/godep

	echo Building...
	./build.sh
}

check() {
	export GOPATH="$srcdir/go"
	export PATH="$PATH:$srcdir/go/bin"
	cd "$srcdir/go/src/github.com/calmh/syncthing"

	./build.sh test
}

package() {
  cd "$srcdir/go/src/github.com/calmh/syncthing"
  install -D -m 755 syncthing "$pkgdir/usr/bin/syncthing"
  install -D -m 644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -D -m 644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
  install -D -m 644 "$srcdir/syncthing@.service" "$pkgdir/usr/lib/systemd/system/syncthing@.service"
}

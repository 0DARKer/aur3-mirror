# Maintainer: Joel Goguen <jgoguen (at-sign) jgoguen (period) ca>
pkgname=lightning-bin
pkgver=1.0b2rc3
pkgrel=1
_tb_ver=3.1 # Adjust this to the current thunderbird major/minor release
pkgdesc="A version of Mozilla Sunbird integrated with Thunderbird"
arch=('i686' 'x86_64')
url="http://www.mozilla.org/projects/calendar/lightning/"
license=('MPL' 'GPL' 'LGPL')
depends=('thunderbird' 'libnotify')
makedepends=()
options=()
provides=(lightning=${pkgver})

source=(http://releases.mozilla.org/pub/mozilla.org/calendar/lightning/releases/${pkgver}/linux-i686/lightning.xpi)
sha256sums=(a8d335121ab202f6152885313a636341beb7c1ad0171de90e2d340b85c5d7fd5)

if [ x"${CARCH}" == x"x86_64" ]; then
	source=(http://releases.mozilla.org/pub/mozilla.org/calendar/lightning/releases/${pkgver}/contrib/linux-x86_64/lightning.xpi)
	sha256sums=(76b4d06faefe23b8753cc0eb3362595c8a5a74f565d918c45d458d7f0610f548)
fi

build() {
	mkdir -p ${pkgdir}/usr/lib/thunderbird-${_tb_ver}/extensions/${pkgname}
	cd ${pkgdir}/usr/lib/thunderbird-${_tb_ver}/extensions/${pkgname}
	bsdtar -x -f ${srcdir}/lightning.xpi

	_emid=$(grep em:id install.rdf | tail -n 1 | sed 's/.*>\(.*\)<.*/\1/')
	cd ../
	mv ${pkgname} ${_emid}
	cd ${_emid}

	# Fix permissions
	find -type d -exec chmod 0755 \{\} \+ || return 1
	find -type f -exec chmod 0644 \{\} \+ || return 1
	find -name '*.so' -exec chmod 0755 \{\} \+
}

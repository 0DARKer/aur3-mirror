# Maintainer : Keshav P R <skodabenz at rocketmail dot com>
# Contributor: Alessio 'mOLOk' Bolognino <themolok@gmail.com>

_pkgname="gnu-efi"
_ver="3.0"
_pkgver="${_ver}m"

pkgname="${_pkgname}"
pkgver="${_pkgver}"

pkgrel=1
pkgdesc="Library for building UEFI Applications using GNU toolchain"
url="http://sourceforge.net/projects/gnu-efi/"
license=('GPL')
arch=('i686' 'x86_64')
makedepends=()
depends=('pciutils')
options=(!strip)

source=("http://download.sourceforge.net/gnu-efi/gnu-efi_${pkgver}.orig.tar.gz")

sha256sums=('b7fb638f5ec8faa6edebe54beb90957f01ccccf70a2a948d1b58b834c8d7f86d')

build() {
	
	cd "${srcdir}/gnu-efi-${_ver}"
	
	## Add the missing header file
	#install -D -m644 "${srcdir}/efipciio.h" "${srcdir}/gnu-efi-${_ver}/inc/efipciio.h"
	echo
	
	## Many patches from Fedora's gnu-efi package including 16-byte stack alignment one - as on 22-AUG-2011
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-machine-types.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-.S-and-.E-rules.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-ignore-gnu-stack.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-pad-all-sections.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-handle-uninitialized-gop.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-route80h.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-route80h-add-cougarpoint.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Guarantee-16-byte-stack-alignment-on-x86_64-efi_call.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-the-routines-to-make-callbacks-work.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-add-uefi-2.x-boot-services.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Fix-usage-of-INSTALLROOT-PREFIX-and-LIBDIR.patch"
	#patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-tcc.efi-to-test-our-calling-convention-shananaga.patch"
	echo
	
	CFLAGS="" make
	echo
	
	make -C apps clean all
	echo
	
}

package() {
	
	cd "${srcdir}/gnu-efi-${_ver}"
	
	make INSTALLROOT="${pkgdir}/usr/" install
	echo
	
	install -d "${pkgdir}/usr/share/gnu-efi/"
	install -D -m644 "${srcdir}/gnu-efi-${_ver}/apps"/*.efi "${pkgdir}/usr/share/gnu-efi/"
	
}

# Maintainer : Keshav P R <skodabenz at rocketmail dot com>
# Contributor: Alessio 'mOLOk' Bolognino <themolok@gmail.com>

_ver="3.0"

pkgname="gnu-efi"
pkgver="${_ver}l"
pkgrel=2
pkgdesc="Library for building UEFI Applications"
url="http://sourceforge.net/projects/gnu-efi/"
license=('GPL')
arch=('i686' 'x86_64')
makedepends=()
depends=('pciutils')
options=(!strip)

source=("http://download.sourceforge.net/gnu-efi/gnu-efi_${pkgver}.orig.tar.gz"
		'efipciio.h'
		'gnu-efi-3.0e-machine-types.patch'
		'gnu-efi-3.0e-Add-.S-and-.E-rules.patch'
		'gnu-efi-3.0e-Guarantee-16-byte-stack-alignment-on-x86_64-efi_call.patch'
		'gnu-efi-3.0e-Add-the-routines-to-make-callbacks-work.patch'
		'gnu-efi-3.0e-Add-tcc.efi-to-test-our-calling-convention-shananaga.patch')

sha256sums=('0eb6d68f250c1f439c1ee98a5a713ab8ef7ba84ee32e3945dd355f16aeef6880'
            '4db4ede136224d51a7e7e798de98e30d42c6023f4b262cfe2f0f4bb00d8d1665'
            '931403553c54e7b47c21406e840cfb610fb83b4794eed9a4d3d05816840a240c'
            '62ce0e80c3f2cecda2b959e5e1814963ce414bde77ca1b13c2670aba70198746'
            'd8d6f787607e4960513593a7ae2b8197c71caf9e954bc0abcd42e9d35e2a92db'
            '11e37222a2f74b6ebe602952a1764a22bec9250dc873d892731266ff8dbda6ca'
            '8d01e0678199b2ab97caa37cb7164dc39c74dfdb9a7ed32d139c917c0ce9e332')

build() {
	
	cd "${srcdir}/gnu-efi-${_ver}"
	
	## Add the missing header file
	install -D -m644 "${srcdir}/efipciio.h" "${srcdir}/gnu-efi-${_ver}/inc/efipciio.h"
	echo
	
	## Apply patch to correct make error for static libs
	# patch -Np1 -i "${srcdir}/gnu-efi_static_libs_make_error.patch"
	
	## Many patches form Fedora's gnu-efi package including 16-byte stack alignment one - as on 11-AUG-2011
	patch -Np1 -i "${srcdir}/gnu-efi-3.0e-machine-types.patch"
	patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-.S-and-.E-rules.patch"
	patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Guarantee-16-byte-stack-alignment-on-x86_64-efi_call.patch"
	patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-the-routines-to-make-callbacks-work.patch"
	# patch -Np1 -i "${srcdir}/gnu-efi-3.0e-Add-tcc.efi-to-test-our-calling-convention-shananaga.patch"
	
	CFLAGS="" make
	echo
	
}

package() {
	
	cd "${srcdir}/gnu-efi-${_ver}"
	
	make INSTALLROOT="${pkgdir}/usr/" install
	echo
	
}

From 164c98e792671f0b7ec4cbbf5fdf3d46a129baaa Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Vadinsk=C3=BD?= <Nicky726@google.com>
Date: Tue, 8 Feb 2011 19:47:07 +0100
Subject: [PATCH 1/4] Added support for DISTRO = arch option.

---
 README     |    6 +++---
 build.conf |    2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/README b/README
index 184c6ef..b6fe1d0 100644
--- a/README
+++ b/README
@@ -96,9 +96,9 @@ NAME			String (optional).  Sets the name of the policy; the
 
 DISTRO			String (optional).  Enable distribution-specific policy.
 			Available options are redhat, rhel4, gentoo, debian,
-			and suse.  This option controls distro_redhat,
-			distro_rhel4, distro_gentoo, distro_debian, and
-			distro_suse policy blocks.
+			arch and suse.  This option controls distro_redhat,
+			distro_rhel4, distro_gentoo, distro_debian, distro_arch
+			and distro_suse policy blocks.
 
 MONOLITHIC		Boolean.  If set, a monolithic policy is built,
 			otherwise a modular policy is built.
diff --git a/build.conf b/build.conf
index d13e236..d7f5be3 100644
--- a/build.conf
+++ b/build.conf
@@ -25,7 +25,7 @@ NAME = refpolicy
 # for programs or configurations specific to the
 # distribution.  Setting this will enable options
 # for the distribution.
-# redhat, gentoo, debian, suse, and rhel4 are current options.
+# redhat, gentoo, debian, suse, arch and rhel4 are current options.
 # Fedora users should enable redhat.
 #DISTRO = redhat
 
-- 
1.7.4

From d069ed710e01b31b859879431cd7b5da082c7ca3 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Vadinsk=C3=BD?= <Nicky726@google.com>
Date: Tue, 8 Feb 2011 20:10:14 +0100
Subject: [PATCH 2/4] Fixed path issues with /etc/rc.d/ for modules in admin.

---
 policy/modules/admin/kdump.fc     |    3 +++
 policy/modules/admin/shorewall.fc |    6 ++++++
 2 files changed, 9 insertions(+), 0 deletions(-)

diff --git a/policy/modules/admin/kdump.fc b/policy/modules/admin/kdump.fc
index c66934f..1f05c7c 100644
--- a/policy/modules/admin/kdump.fc
+++ b/policy/modules/admin/kdump.fc
@@ -1,5 +1,8 @@
 /etc/kdump\.conf	--	gen_context(system_u:object_r:kdump_etc_t,s0)
 /etc/rc\.d/init\.d/kdump --	gen_context(system_u:object_r:kdump_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/kdump 	--	gen_context(system_u:object_r:kdump_initrc_exec_t,s0)
+')
 
 /sbin/kdump		--	gen_context(system_u:object_r:kdump_exec_t,s0)
 /sbin/kexec		--	gen_context(system_u:object_r:kdump_exec_t,s0)
diff --git a/policy/modules/admin/shorewall.fc b/policy/modules/admin/shorewall.fc
index 029cb7e..1406024 100644
--- a/policy/modules/admin/shorewall.fc
+++ b/policy/modules/admin/shorewall.fc
@@ -1,5 +1,11 @@
 /etc/rc\.d/init\.d/shorewall		--	gen_context(system_u:object_r:shorewall_initrc_exec_t,s0)
 /etc/rc\.d/init\.d/shorewall-lite	--	gen_context(system_u:object_r:shorewall_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/shorewall			--	gen_context(system_u:object_r:shorewall_initrc_exec_t,s0)
+')
+ifdef(`distro_arch',`
+/etc/rc\.d/shorewall-lite		--	gen_context(system_u:object_r:shorewall_initrc_exec_t,s0)
+')
 
 /etc/shorewall(/.*)?				gen_context(system_u:object_r:shorewall_etc_t,s0)
 /etc/shorewall-lite(/.*)?			gen_context(system_u:object_r:shorewall_etc_t,s0)
-- 
1.7.4

From cff88a6abe4e33b7def3509c5624187d8e906808 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Vadinsk=C3=BD?= <Nicky726@google.com>
Date: Tue, 8 Feb 2011 20:17:15 +0100
Subject: [PATCH 3/4] Fixed path issues with /etc/rc.d/ for corecommands.

---
 policy/modules/kernel/corecommands.fc |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/policy/modules/kernel/corecommands.fc b/policy/modules/kernel/corecommands.fc
index 34c9d01..5fa25a1 100644
--- a/policy/modules/kernel/corecommands.fc
+++ b/policy/modules/kernel/corecommands.fc
@@ -94,6 +94,9 @@ ifdef(`distro_redhat',`
 /etc/racoon/scripts(/.*)?		gen_context(system_u:object_r:bin_t,s0)
 
 /etc/rc\.d/init\.d/functions	--	gen_context(system_u:object_r:bin_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/functions		--	gen_context(system_u:object_r:bin_t,s0)
+')
 
 /etc/security/namespace.init	--	gen_context(system_u:object_r:bin_t,s0)
 
-- 
1.7.4

From 0f7ac08384808872c486fb0ec47637b86448e3e0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Ond=C5=99ej=20Vadinsk=C3=BD?= <Nicky726@google.com>
Date: Tue, 8 Feb 2011 20:25:19 +0100
Subject: [PATCH 4/4] Fixed path issues with /etc/rc.d/ for modules in system.

---
 policy/modules/system/init.fc     |    4 ++++
 policy/modules/system/ipsec.fc    |    6 ++++++
 policy/modules/system/iptables.fc |    4 ++++
 policy/modules/system/logging.fc  |    6 ++++++
 policy/modules/system/setrans.fc  |    3 +++
 5 files changed, 23 insertions(+), 0 deletions(-)

diff --git a/policy/modules/system/init.fc b/policy/modules/system/init.fc
index 9775375..988ad00 100644
--- a/policy/modules/system/init.fc
+++ b/policy/modules/system/init.fc
@@ -7,6 +7,10 @@
 /etc/rc\.d/rc\.[^/]+	--	gen_context(system_u:object_r:initrc_exec_t,s0)
 
 /etc/rc\.d/init\.d/.*	--	gen_context(system_u:object_r:initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/.*		--	gen_context(system_u:object_r:initrc_exec_t,s0)
+')
+
 /etc/sysconfig/network-scripts/ifup-ipsec -- gen_context(system_u:object_r:initrc_exec_t,s0)
 
 /etc/X11/prefdm		--	gen_context(system_u:object_r:initrc_exec_t,s0)
diff --git a/policy/modules/system/ipsec.fc b/policy/modules/system/ipsec.fc
index 07eba2b..6c0ef8d 100644
--- a/policy/modules/system/ipsec.fc
+++ b/policy/modules/system/ipsec.fc
@@ -1,5 +1,11 @@
 /etc/rc\.d/init\.d/ipsec	--	gen_context(system_u:object_r:ipsec_initrc_exec_t,s0)
 /etc/rc\.d/init\.d/racoon	--	gen_context(system_u:object_r:ipsec_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/ipsec		--	gen_context(system_u:object_r:ipsec_initrc_exec_t,s0)
+')
+ifdef(`distro_arch',`
+/etc/rc\.d/racoon		--	gen_context(system_u:object_r:ipsec_initrc_exec_t,s0)
+')
 
 /etc/ipsec\.secrets		--	gen_context(system_u:object_r:ipsec_key_file_t,s0)
 /etc/ipsec\.conf		--	gen_context(system_u:object_r:ipsec_conf_file_t,s0)
diff --git a/policy/modules/system/iptables.fc b/policy/modules/system/iptables.fc
index 13f62a6..a02578a 100644
--- a/policy/modules/system/iptables.fc
+++ b/policy/modules/system/iptables.fc
@@ -1,4 +1,8 @@
 /etc/rc\.d/init\.d/ip6?tables	--	gen_context(system_u:object_r:iptables_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/ip6?tables		--	gen_context(system_u:object_r:iptables_initrc_exec_t,s0)
+')
+
 /etc/sysconfig/ip6?tables.*	--	gen_context(system_u:object_r:iptables_conf_t,s0)
 /etc/sysconfig/system-config-firewall.* -- gen_context(system_u:object_r:iptables_conf_t,s0)
 
diff --git a/policy/modules/system/logging.fc b/policy/modules/system/logging.fc
index 571599b..212dc42 100644
--- a/policy/modules/system/logging.fc
+++ b/policy/modules/system/logging.fc
@@ -5,6 +5,12 @@
 /etc/audit(/.*)?		gen_context(system_u:object_r:auditd_etc_t,mls_systemhigh)
 /etc/rc\.d/init\.d/auditd --	gen_context(system_u:object_r:auditd_initrc_exec_t,s0)
 /etc/rc\.d/init\.d/rsyslog --	gen_context(system_u:object_r:syslogd_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/auditd 	--	gen_context(system_u:object_r:auditd_initrc_exec_t,s0)
+')
+ifdef(`distro_arch',`
+/etc/rc\.d/rsyslog 	--	gen_context(system_u:object_r:syslogd_initrc_exec_t,s0)
+')
 
 /sbin/audispd		--	gen_context(system_u:object_r:audisp_exec_t,s0)
 /sbin/audisp-remote	--	gen_context(system_u:object_r:audisp_remote_exec_t,s0)
diff --git a/policy/modules/system/setrans.fc b/policy/modules/system/setrans.fc
index bea4629..3ec629f 100644
--- a/policy/modules/system/setrans.fc
+++ b/policy/modules/system/setrans.fc
@@ -1,4 +1,7 @@
 /etc/rc\.d/init\.d/mcstrans --	gen_context(system_u:object_r:setrans_initrc_exec_t,s0)
+ifdef(`distro_arch',`
+/etc/rc\.d/mcstrans 	--	gen_context(system_u:object_r:setrans_initrc_exec_t,s0)
+')
 
 /sbin/mcstransd		--	gen_context(system_u:object_r:setrans_exec_t,s0)
 
-- 
1.7.4


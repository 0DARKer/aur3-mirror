# Contributor: fs4000 <matthias_dienstbier[at]yahoo[dot]de>

pkgname=phc-k8
pkgver=0.4.3
pkgrel=1
pkgdesc="frequency driver for AMD K8 with undervolting feature"
url="http://www.linux-phc.org"
arch=('i686' 'x86_64')
license=('GPL')
makedepends=('kernel26-headers')
provides=('linux-phc')
[ "$pkgname" = "phc-k8" ] && backup=(etc/modprobe.d/phc-k8.conf)
options=(!makeflags)
install=phc-k8.install
source=(phc-k8-$pkgver.tar.gz::$url/forum/download/file.php?id=107)
md5sums=('1e0dc8218ec3850369db8d824d88a551')

build() {
	sed "s/depmod.*/depmod `uname -r`/" -i ../$install
	cd phc-k8_v$pkgver
	sed -i 's| /etc/modprobe.d/phc-k8.conf| ${DESTDIR}/etc/modprobe.d/phc-k8.conf|' Makefile
	sed -i 's|\([^=]\) /lib/modules/|\1 ${DESTDIR}/lib/modules/|' Makefile
	sed -i 's|^\tdepmod $(KERNELVERSION) -a|#\tdepmod $(KERNELVERSION) -a|' Makefile

	make
}

package() {
	cd phc-k8_v$pkgver

	install -d "$pkgdir/etc/modprobe.d"
	make DESTDIR="$pkgdir" install

	if [ "$pkgname" = "phc-k8" ]; then
	  install -d "$pkgdir/usr/share/doc/phc-k8/"
	  install -m644 {Changelog,README} "$pkgdir/usr/share/doc/phc-k8/"
	else
	  # delete the config if we build for another kernel
	  rm -r "$pkgdir/etc"
	fi
}

# Maintainer: Heiher <root@heiher.info>

pkgname=tpm-emulator
pkgver=0.7.4
pkgrel=2
pkgdesc="TPM Emulator"
arch=('i686' 'x86_64')
url="http://tpm-emulator.berlios.de"
license=('GPL2')
depends=('gmp')
makedepends=('cmake' 'linux-headers')
install=${pkgname}.install
source=(http://prdownload.berlios.de/tpm-emulator/tpm_emulator-${pkgver}.tar.gz
        tpmd.service 80-tpmd_dev.conf linux-user-group.diff)
sha256sums=('4e48ea0d83dd9441cc1af04ab18cd6c961b9fa54d5cbf2c2feee038988dea459'
            '1f4ac5fe41a283a906d6d53307a8faadca369c2c11b9150849f5e324d8df2adc'
			'59d6e213b54d9eaf7ecfc482a3aab22c176448676527adc2b475a5448e2afebc'
			'2aa99c670b9469cf6911502727e0f2d8f17458b64d7ef3bb8fc9952eb3e33002')

build() {
  cd ${srcdir}/tpm_emulator-${pkgver}
  patch -Np1 -i ${srcdir}/linux-user-group.diff
  ./build.sh
}

package() {
  cd ${srcdir}/tpm_emulator-${pkgver}/build
  make DESTDIR=${pkgdir} install
  mv ${pkgdir}/usr/local/* ${pkgdir}/usr/
  rm -rf ${pkgdir}/usr/local ${pkgdir}/usr/lib/libtddl.a
  mv ${pkgdir}/lib/modules/`uname -r`/extra ${pkgdir}/lib/modules/`uname -r`/extramodules
  install -Dm644 ${srcdir}/80-tpmd_dev.conf ${pkgdir}/etc/modules-load.d/80-tpmd_dev.conf
  install -Dm644 ${srcdir}/tpmd.service ${pkgdir}/usr/lib/systemd/system/tpmd.service
}


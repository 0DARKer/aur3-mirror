# Puppetdb: Installer: Arch
# Maintainer: Niels Abspoel <aboe76 (at) Gmail (dot) com>

# RC style, reserved for later use
##pkgname=puppetdb
#_rc=1
#_pkgver=2.0.0
#pkgver=${_pkgver}_rc${_rc}

pkgname=puppetdb
pkgver=2.0.0
pkgrel=1
pkgdesc="Puppet data warehouse; it manages storage and retrieval of all platform-generated data"
arch=("any")
url="http://puppetlabs.com/projects/puppetdb/"
license=("APACHE")
depends=("ruby" "facter" "puppet" "jdk7-openjdk" "logrotate" )
provides=("puppetdb")
install="puppetdb.install"
backup=('etc/puppetdb/conf.d/config.ini' 'etc/puppetdb/conf.d/database.ini' 'etc/puppetdb/conf.d/jetty.ini' 'etc/puppetdb/conf.d/repl.ini' )
source=("http://downloads.puppetlabs.com/puppetdb/$pkgname-${pkgver//_/-}.tar.gz"
        "puppetdb.service"
        "puppetdb-sysconfig")
md5sums=('96c2be127bbbf8a4160d8e4bb4c059c4'
         'cc44a56414dc70fc01343c5ca4089038'
         '0cab98aae5ae70dc416ae205caa3f165')

package () {
  cd "${srcdir}/${pkgname}-${pkgver//_/-}"
  unset DESTDIR
  export LANG=en_US.UTF-8
  rake package:bootstrap
  rake install PARAMS_FILE= DESTDIR=${pkgdir}

  # logrotate
  install -Dm 644 $srcdir/${pkgname}-${pkgver//_/-}/ext/files/puppetdb.logrotate $pkgdir/etc/logrotate.d/puppetdb

  # Systemd file from puppet
  #install -Dm 644 $srcdir/${pkgname}-${pkgver//_/-}/ext/files/systemd/puppetdb.service $pkgdir/usr/lib/systemd/system/puppetdb.service

  # puppetdb installs binarys in /usr/sbin/ 
  mv "$pkgdir"/usr/sbin/ "$pkgdir"/usr/bin
  install -D -m700 $srcdir/${pkgname}-${pkgver//_/-}/ext/files/puppetdb.env $pkgdir/usr/libexec/puppetdb/puppetdb.env
  cp "$pkgdir"/usr/bin/puppetdb* $pkgdir/usr/libexec/puppetdb/
  #archlinux specific systemd
  install -D -m755 "${startdir}/puppetdb.service" "${pkgdir}/usr/lib/systemd/system/puppetdb.service"
  install -D -m755 "${startdir}/puppetdb-sysconfig" "${pkgdir}/etc/sysconfig/puppetdb"

}
# vim: set ft=sh ts=2 sw=2 et:

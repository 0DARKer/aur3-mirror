From f81fad485c7111f13c15bd667d937f9e0ce0ff5e Mon Sep 17 00:00:00 2001
From: Keshav Amburay <the.ridikulus.rat@gmail.com>
Date: Tue, 22 Apr 2014 21:46:18 -0400
Subject: [PATCH] Add new config file keyword 'architecture' to specify the
 architecture of the EFI image

---
 src/efi/gummiboot.c | 27 +++++++++++++++++++++++++--
 1 file changed, 25 insertions(+), 2 deletions(-)

diff --git a/src/efi/gummiboot.c b/src/efi/gummiboot.c
index d405453..62ea490 100644
--- a/src/efi/gummiboot.c
+++ b/src/efi/gummiboot.c
@@ -554,6 +554,7 @@ static BOOLEAN menu_run(Config *config, ConfigEntry **chosen_entry, EFI_FILE *ro
         BOOLEAN exit = FALSE;
         BOOLEAN run = TRUE;
         BOOLEAN wait = FALSE;
+        CHAR16 *gummiboot_arch = NULL;
 
         graphics_mode(FALSE);
         uefi_call_wrapper(ST->ConIn->Reset, 2, ST->ConIn, FALSE);
@@ -846,8 +847,11 @@ static BOOLEAN menu_run(Config *config, ConfigEntry **chosen_entry, EFI_FILE *ro
                         break;
 
                 case KEYPRESS(0, 0, 'v'):
-                        status = PoolPrint(L"gummiboot " VERSION ", UEFI %d.%02d, %s %d.%02d",
-                                           ST->Hdr.Revision >> 16, ST->Hdr.Revision & 0xffff,
+                        gummiboot_arch = stra_to_str((CHAR8 *)MACHINE_TYPE_NAME);
+                        StrUpr(gummiboot_arch);
+
+                        status = PoolPrint(L"Gummiboot " VERSION " (%s), UEFI Specification %d.%02d, Vendor %s %d.%02d",
+                                           gummiboot_arch, ST->Hdr.Revision >> 16, ST->Hdr.Revision & 0xffff,
                                            ST->FirmwareVendor, ST->FirmwareRevision >> 16, ST->FirmwareRevision & 0xffff);
                         break;
 
@@ -893,6 +897,7 @@ static BOOLEAN menu_run(Config *config, ConfigEntry **chosen_entry, EFI_FILE *ro
                 FreePool(lines[i]);
         FreePool(lines);
         FreePool(clearline);
+        FreePool(gummiboot_arch);
 
         uefi_call_wrapper(ST->ConOut->SetAttribute, 2, ST->ConOut, EFI_WHITE|EFI_BACKGROUND_BLACK);
         uefi_call_wrapper(ST->ConOut->ClearScreen, 1, ST->ConOut);
@@ -1149,6 +1154,24 @@ static VOID config_entry_add_from_file(Config *config, EFI_HANDLE *device, CHAR1
                         continue;
                 }
 
+                if (strcmpa((CHAR8 *)"architecture", key) == 0) {
+                        CHAR16 *gummiboot_arch = NULL;
+                        CHAR16 *loader_arch = NULL;
+
+                        gummiboot_arch = stra_to_str((CHAR8 *)MACHINE_TYPE_NAME);
+                        loader_arch = stra_to_str(value);
+
+                        /* do not add an entry for an EFI image of architecture not matching with that of the gummiboot image */
+                        if (StriCmp(gummiboot_arch, loader_arch) != 0) {
+                                entry->type = LOADER_UNDEFINED;
+                                break;
+                        }
+
+                        FreePool(gummiboot_arch);
+                        FreePool(loader_arch);
+                        continue;
+                }
+
                 if (strcmpa((CHAR8 *)"initrd", key) == 0) {
                         CHAR16 *new;
 
-- 
1.9.2


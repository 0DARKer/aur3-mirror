# Maintainer: Nicolas Reynolds <fauno@kiwwwi.com.ar>
# Based on haskell-pandoc

# Run `makepkg -srp SRCBUILD` if you want to update the source tarball

pkgname=pandoc
pkgver=1.9.3
pkgrel=1
pkgdesc='Conversion between markup formats (no Haskell libs)'
url='http://johnmacfarlane.net/pandoc/'
license=('GPL')
arch=('i686' 'x86_64')
makedepends=('ghc' 'sh' 'cabal-install')
options=('strip')
source=(https://repo.parabolagnulinux.org/other/${pkgname}-${pkgver}-${pkgrel}-any.src.tar.xz{,.sig} SRCBUILD)
md5sums=('944f2b32803b0335345853cd2b1c1ad7'
         '0ee3190fd7d43bcfebdb282ff12584f2'
         'ecc040d30c6e4fb77c32d598dd03729d')
conflicts=('haskell-pandoc')

# PKGBUILD functions
build() {
    mkdir -p ${srcdir}/{build,${pkgname}-${pkgver}}
    cd ${srcdir}/${pkgname}-${pkgver}

    for _hkpkg in $(grep -v ${pkgname}-${pkgver} BUILDORDER); do
        pushd ${srcdir}/${pkgname}-${pkgver}/${_hkpkg}

        HOME=${srcdir}/${pkgname}-${pkgver} \
        cabal install --prefix=${srcdir}/build/usr

        popd
    done

    cd ${srcdir}/${pkgname}-${pkgver}/${pkgname}-${pkgver}

   HOME=${srcdir}/${pkgname}-${pkgver} \
   cabal configure --prefix=/usr --libdir=${srcdir}/build/usr/lib --flags="-library"
   HOME=${srcdir}/${pkgname}-${pkgver} \
   cabal build

}

package() {

   cd ${srcdir}/${pkgname}-${pkgver}/${pkgname}-${pkgver}

   runghc Setup.hs copy --destdir=${pkgdir}/

#   runghc Setup.hs configure --prefix=DIR --bindir=DIR --libdir=DIR \
#   --datadir=DIR --libsubdir=DIR --datasubdir=DIR --docdir=DIR \
#   --htmldir=DIR --program-prefix=PREFIX --program-suffix=SUFFIX \
#   --mandir=DIR --flags=FLAGSPEC

# Copy everything, but remove docs and haskell-libs
#   rm -r ${pkgdir}/usr/{lib,share/*}

#   cp -a ${srcdir}/build/usr/share/man ${pkgdir}/usr/share/
#   cp -a ${srcdir}/build/usr/share/doc ${pkgdir}/usr/share/
    find ${pkgdir}/usr/share -type f -exec chmod 644 {} \;
    find ${pkgdir}/usr/share -type d -exec chmod 755 {} \;
}

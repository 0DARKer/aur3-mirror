# Maintainer: Michele Mocciola <mickele>
pkgname=scotch_esmumps
pkgver=5.1.8a
pkgrel=1
pkgdesc="SCOTCH is a software package and libraries for graph, mesh and hypergraph partitioning, static mapping, and sparse matrix block ordering. This version  contains an interface for MUMPS."
url="http://www.labri.fr/perso/pelegrin/scotch/"
license="custom: CeCILL-C free/libre software license"
depends=('zlib')
makedepends=('make' 'gcc>=4.5.0' 'patch' 'coreutils' 'sed')
provides=('scotch=5.1.8a')
conflicts=('scotch')
replaces=()
backup=()
arch=('i686' 'x86_64')
install=${pkgname}.install
source=("http://gforge.inria.fr/frs/download.php/26886/scotch_${pkgver}_esmumps.tar.gz" "${pkgname}-${pkgver}.diff" "Makefile.inc")

build() {
  cd "${srcdir}/scotch_${pkgver}_esmumps" || return 1

  patch -Np1 -i ${srcdir}/${pkgname}-${pkgver}.diff || return 1

  cd "${srcdir}/scotch_${pkgver}_esmumps/src" || return 1
  sed "s|-O3|$CFLAGS|g" < ${srcdir}/Makefile.inc > Makefile.inc

  # necessary to compile with gcc-4.5
  for _FILE in `grep -R -l "restrict" *`
  do
    sed -e "s|restrict|__restrict|g" \
        -i ${_FILE}
  done

  make scotch || return 1

  mkdir -p "${pkgdir}/usr/bin" || return 1
  mkdir -p "${pkgdir}/usr/lib" || return 1
  mkdir -p "${pkgdir}/usr/include/scotch" || return 1

  cd "${srcdir}/scotch_${pkgver}_esmumps" || return 1

  mv include/*.h ${pkgdir}/usr/include/scotch || return 1
  mv lib/lib* ${pkgdir}/usr/lib || return 1

  cd "${pkgdir}/usr/lib" || return 1
  for _FILE in `ls *.so`
  do
	mv -f ${_FILE} ${_FILE}.${pkgver} || return 1
	ln -s ${_FILE}.${pkgver} ${_FILE}.${pkgver:0:1} || return 1
  done

  cd "${srcdir}/scotch_${pkgver}_esmumps" || return 1

  mv bin/* "${pkgdir}/usr/bin" || return 1
  mkdir -p "${pkgdir}/usr/share/licenses/${pkgname}" || return 1
  cp "${srcdir}/scotch_${pkgver}_esmumps/doc/CeCILL-C_V1-en.txt" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE" || return 1
}
md5sums=('2a9944350bc97cfd704186e4d6b6aa78'
         'b69fcafab209c147c6f14902cad55e15'
         '620fbb1d04c26ef135e61b147f85cfe3')

# Contributor: Gustavo Alvarez <sl1pkn07@gmail.com>

pkgname=dkms-vhba
_pkgname=vhba
_modname=vhba

pkgver=20100822
_oldpkgver=20100822

pkgrel=1
pkgdesc="DKMS controlled drivers for VHBA module for CDEMU"
arch=('i686' 'x86_64')
url="http://cdemu.sourceforge.net/"
license=('GPL2')
depends=('kernel26-headers' 'dkms' 'bash')
provides=('vhba-module')
conflicts=('vhba-module')
install="${pkgname}.install"

source=("http://downloads.sourceforge.net/cdemu/$_pkgname-module-$pkgver.tar.gz"
	vhba-kernel2.6.37.patch
	${pkgname}.install
	dkms.conf)

build() {
    cd ${srcdir}/${_pkgname}-module-${pkgver}
    git apply -p2 ../vhba-kernel2.6.37.patch
}

package() {
    cd ${srcdir}/${_pkgname}-module-${pkgver}

        
    # Copy source tree for DKMS
    mkdir -p ${pkgdir}/usr/src/${_pkgname}-${pkgver} 
    cp -a * ${pkgdir}/usr/src/${_pkgname}-${pkgver} 

    # dkms-vhba.install
    sed -i -e "s/OLD_PACKAGE_VERSION/${_oldpkgver}/" ${startdir}/${pkgname}.install
    sed -i -e "s/PACKAGE_VERSION/${pkgver}/" ${startdir}/${pkgname}.install
    sed -i -e "s/MODULE_NAME/${_pkgname}/" ${startdir}/${pkgname}.install

    # dkms.conf
    cp -a ${srcdir}/dkms.conf ${pkgdir}/usr/src/${_pkgname}-${pkgver}
    sed -i -e "s/PACKAGE_VERSION=\".*\"/PACKAGE_VERSION=\"${pkgver}\"/" ${pkgdir}/usr/src/${_pkgname}-${pkgver}/dkms.conf
    sed -i -e "s/BUILT_MODULE_NAME\[0\]=\".*\"/BUILT_MODULE_NAME\[0\]=\"${_modname}\"/" ${pkgdir}/usr/src/${_pkgname}-${pkgver}/dkms.conf

    
}  
md5sums=('1d2f06ae33c5d15b7c29e467e4658aa2'
	 'f0499fc54f6ef9b8d6ca0b9e940c5906'
	 'fb84f10238d634383e361fde8d16ec45'
	 '005449033b68763a184133a4caecf6a3')

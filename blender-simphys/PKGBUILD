# Original Contributor: Lukas Jirkovsky <l.jirkovsky@gmail.com>
# Modified by Matt Runion <mrunion@yahoo.com>
pkgname=blender-simphys
pkgver=svn
pkgrel=1
pkgdesc="SVN version of Blender for Sym Physics"
arch=('i686' 'x86_64')
url="http://blender.org/"
depends=('openexr' 'libxi' 'libjpeg' 'libpng' 'ffmpeg' 'gettext' 'python' 'desktop-file-utils')
makedepends=('scons' 'subversion' 'sed')
provides=('blender')
conflicts=('blender')
license="GPL"
install=blender.install
source=(blender.sh blender.desktop blender.png)
md5sums=('e1bd54aaeedfbd934e532b6cad8c44f0' 'aa587d90d9ed14fc3548d1a1e882d853'\
	 '2718ae258377bcc9c9942c28110ee89e')

_svnroot="https://svn.blender.org/svnroot/bf-blender/branches/sim_physics"
_svnmod="blender"

build() {
  # Get the sources
  cd $startdir/src
  msg "Connecting to blender SVN server......."
  #svn co $_svnroot $_svnmod -r $pkgver || return 1
  svn co $_svnroot $_svnmod || return 1
  msg "SVN checkout done"
  cd $startdir/src/$_svnmod

  ##########
  # tweak scons config script
  # first translate CFLAGS and CXXFLAGS for use
##MR#_CFLAGS=`echo $CFLAGS | sed -e "s/\ -O.//" -e "s/^/'/" -e "s/\ /','/g" -e "s/$/'/"`
##MR#_CXXFLAGS=`echo $CXXFLAGS | sed -e "s/\ -O.//" -e "s/^/'/" -e "s/\ /','/g" -e "s/$/'/"`
##MR#  sed "s/REL_CFLAGS\ =\ \['-O2'\]/REL_CFLAGS\ =\ \['`echo $CFLAGS | sed 's/.*\(-O[s,0-4]\).*/\1/g'`'\]/" -i config/linux2-config.py
##MR#  sed "s/REL_CCFLAGS\ =\ \['-O2'\]/REL_CCFLAGS\ =\ \['`echo $CXXFLAGS | sed 's/.*\(-O[s,0-4]\).*/\1/g'`'\]/" -i config/linux2-config.py

##MR#  sed -e "s|WITH_BF_OPENAL\ =\ 'true'|WITH_BF_OPENAL\ =\ 'false'|" \
##MR#  -e "s|WITH_BF_FFMPEG\ =\ 'false'|WITH_BF_FFMPEG\ =\ 'true'|" \
##MR#  -e "s|WITH_BF_VERSE\ =\ 'false'|WITH_BF_VERSE\ =\ 'true'|" \
##MR#  -e "s|BF_OPENGL_LIBPATH\ =\ '/usr/X11R6/lib'|BF_OPENGL_LIBPATH\ =\ '/usr/lib'|" \
##MR#  -e "s|^CCFLAGS\ =\ \[|CCFLAGS\ =\ \[$_CFLAGS,|" \
##MR#  -e "s|^CXXFLAGS\ =\ \[|CXXFLAGS\ =\ \[$_CXXFLAGS,|" -i config/linux2-config.py
##MR#unset _CFLAGS
##MR#unset _CXXFLAGS
  ##########
  scons || return 1
  ##########
  # so, now we compile some plugins
  mv -f $startdir/src/install/linux2/plugins/* \
  	$startdir/src/$_svnmod/source/blender/blenpluginapi/
  cd $startdir/src/$_svnmod/source/blender/blenpluginapi
  chmod 755 bmake
  make
  ###########
  # And...Install!!!
  cd $startdir/src/install/linux2
  install -D -m755 blender $startdir/pkg/usr/share/$_svnmod/$_svnmod
  cp -R .blender/locale $startdir/pkg/usr/share/
  install -m644 .blender/.bfont.ttf $startdir/pkg/usr/share/$_svnmod/.bfont.ttf
  install -m644 .blender/.Blanguages $startdir/pkg/usr/share/$_svnmod/.Blanguages
  cp -R .blender/scripts $startdir/pkg/usr/share/$_svnmod/
  mkdir  -p $startdir/pkg/usr/share/$_svnmod/plugins/{sequence,texture}
  cp $startdir/src/$_svnmod/source/blender/blenpluginapi/sequence/*.so \
  	$startdir/pkg/usr/share/$_svnmod/plugins/sequence/
  cp $startdir/src/$_svnmod/source/blender/blenpluginapi/texture/*.so \
  	$startdir/pkg/usr/share/$_svnmod/plugins/texture/
  install -D -m755 $startdir/src/blender.sh $startdir/pkg/usr/bin/$_svnmod
  install -D -m644 $startdir/src/$_svnmod.desktop \
  	$startdir/pkg/usr/share/applications/$_svnmod.desktop
  install -D -m644 $startdir/src/$_svnmod.png $startdir/pkg/usr/share/pixmaps/$_svnmod.png
}

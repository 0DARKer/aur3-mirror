# Maintainer: Limao Luo <luolimao+AUR@gmail.com>
# Contributor: Stefan Husmann <stefan-husmann@t-online.de>

_pkgname=imagemagick
pkgname=$_pkgname-svn
pkgver=10492
pkgrel=1
pkgdesc="An image viewing/manipulation program"
arch=(i686 x86_64)
url=https://www.$_pkgname.org/
license=(custom)
depends=(djvulibre fontconfig lcms2 liblqr libtool libwebp)
makedepends=(ghostscript openexr libwmf librsvg libxml2 jasper libpng)
optdepends=('ghostscript: for Ghostscript support'
    'openexr: for OpenEXR support'
    'libwmf: for WMF support'
    'librsvg: for SVG support'
    'libxml2: for XML support'
    'jasper: for JPEG-2000 support'
    'libjpeg-turbo: for jpeg support'
    'libpng: for PNG support'
    'imagemagick-doc: full documentation')
provides=($_pkgname=7.0.0)
conflicts=($_pkgname)
for i in coder colors delegates log magic mime policy thresholds type{,-dejavu,-ghostscript,-windows}; do
    backup+=("etc/ImageMagick/$i.xml")
done
options=(libtool !emptydirs !makeflags)
source=(libpng_mmx_patch_x86_64.patch
    perlmagick.rpath.patch
    triple.patch)
sha256sums=('4f3ab23349fd3958a88eb09a7107e08c2c6f3953287907103ec48cfa83575e87'
    'ad2a0f18bce65bd1b7cb7f2144f891074570641d7acffb89e5354cbe6b67e751'
    '64def47752d1ea1c0105a74f55446d5a3d3468ed2c26572b29ed8874f73da2a1')
sha512sums=('8537c2e38cfcd1e7b14d08358c83385792e3e0ed0b9f1210d4dcfad0d416bc3c1311355661f9b020480e641a9b47761ab483dc556d24a30ff92ea557cd8e78f9'
    'dfb7a3543ed792749a74324106ca546c233a2d062c4c8c98f434916140670a9e9ee340af3bc9213f355fe5a8686456b1a4da8bba197d94cd647616829ed4e03e'
    '5031e7319ae540a0f256e6d0a9be16262d46a30bb02a52706ba1a96ced3ad8805def67a6838e5c83735eef81174cf3ceab7d352fd177d7ddfce897d3b03f7e6a')

_svntrunk=$url/subversion/ImageMagick/trunk/
_svnmod=ImageMagick

build() {
    install -d "$srcdir"/$_pkgname/
    cd "$srcdir"/$_pkgname/

    msg "Starting SVN checkout..."
    if [[ -d $_svnmod/.svn ]]; then
        pushd $_svnmod && svn up -r $pkgver
        msg2 "The local files have been updated."
        popd
    else
        svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
    fi
    msg2 "SVN checkout done or server timeout"

    rm -rf $_svnmod-build/
    cp -r $_svnmod/ $_svnmod-build/
    cd $_svnmod-build/

    msg "Compiling..."
    [[ $CARCH == "x86_64" ]] && patch -Np1 -i ../../libpng_mmx_patch_x86_64.patch
    patch -Np1 -i ../../perlmagick.rpath.patch
    patch -Np1 -i ../../triple.patch
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --with-modules \
        --disable-static \
        --enable-openmp \
        --with-x \
        --with-wmf \
        --with-openexr \
        --with-xml \
        --with-gslib \
        --with-gs-font-dir=/usr/share/fonts/Type1 \
        --with-perl \
        --with-perl-options="INSTALLDIRS=vendor" \
        --without-gvc \
        --with-djvu \
        --without-autotrace \
        --with-jp2 \
        --with-jbig \
        --without-fpx \
        --without-dps \
        --without-fftw
    make
}

package() {
    cd "$srcdir"/$_pkgname/$_svnmod-build/
    make DESTDIR="$pkgdir" install
    install -d "$pkgdir"/usr/share/licenses/$pkgname/
    install -m644 LICENSE NOTICE "$pkgdir"/usr/share/licenses/$pkgname/
    rm -rf "$pkgdir"/usr/share/doc/
}

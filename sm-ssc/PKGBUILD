# Maintainer: Artefact2 <artefact2@gmail.com>
# Contributor: Lauri Niskanen <ape@ape3000.com>
# Contributor: Travis Nickles <ryoohki7@yahoo.com>
# Contributor: Stefan Lohmaier <noneuss at gmail dot com>

pkgname=sm-ssc
pkgver=1.2.2
pkgrel=1
pkgdesc="A themer-biased, futures oriented fork of StepMania."
url="http://code.google.com/p/sm-ssc/"
license="MIT"
arch=(i686 x86_64)
depends=('gtk2' 'libmad' 'libtheora' 'mesa' 'ffmpeg')
provides=('stepmania')
makedepends=('pkgconfig' 'mercurial')
install='sm-ssc.install'
source=(sm-ssc.sh sm-ssc.install archlinux.patch)
sha512sums=(1f947a417b081cefd6e1dfdb4b236d9355c9b0a697697b292213021c01e2759f6e4405f3c2c7e2f7354576a305604adf7d5daa95ceca8f135d0de97fcb237d2c
67d11a649801b654108f4bb20a9d395e8e63f1a1484b4a6ada06bf0607a85339bea91cf0b2f32da7903129b0f2346824ff6038bd33523d990d8e2a7f459075ff
317d7ad440c5fb205c523ba54195eabb549bf477a439ea36c587e3058c78ddc9874ad1c1b26663bebec60f1ba18df76099153d7f8020534cc067fc9f8063a886)

_mercurial_repo=https://sm-ssc.googlecode.com/hg/
_dir=sm-ssc
_realver="v$pkgver"

build() {
    cd $srcdir

    msg "Connecting to sm-ssc mercurial server...."
    hg clone $_mercurial_repo $_dir
	cd $_dir
	hg checkout $_realver
    msg "Repository cloning done or server timeout"
    msg "Starting make..."

	patch -p1 < $srcdir/archlinux.patch

    sh ./autogen.sh || return 1
	sh ./Utils/build.sh -f || return 1
	sh ./Utils/build.sh -c || return 1
	sed -i -e 's/ -lrt/ -lbz2 -lrt/g' _build/src/Makefile _build/Makefile
    sh ./Utils/build.sh --verbose --verbose || return 1
    mkdir -p $pkgdir/opt/$pkgname Songs RandomMovies Packages
    cp stepmania GtkModule.so $pkgdir/opt/$pkgname

    install -D -m755 $srcdir/$pkgname.sh $pkgdir/usr/bin/$pkgname
	install -D -m644 $srcdir/$_dir/Docs/Licenses.txt $pkgdir/usr/share/licenses/$pkgname/Licenses.txt

	folders=`echo {Announcers,BackgroundEffects,BackgroundTransitions,BGAnimations,CDTitles,Characters,Courses,Data,Docs,NoteSkins,Packages,RandomMovies,Songs,Themes}`

    cp -r $folders $pkgdir/opt/$pkgname
	chown -R root:games $pkgdir/opt/$pkgname
	cd $pkgdir/opt/$pkgname
	chmod 2775 . $folders
}

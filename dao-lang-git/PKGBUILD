# Maintainer: Jan Pacner
# Contributor: dumblob <dumblob@gmail.com>

_basename=dao
pkgname=${_basename}-lang-git
pkgver=944.87cf207
pkgrel=1
pkgdesc="A lightweight, portable, optionally typed programming language and VM written in C with blazingly fast real concurrency, OOP, JIT, LLVM bytecode, syntax customization using BNF, many modules (e.g. graphics) etc."
arch=('i686' 'x86_64')
url="http://www.daovm.net/"
license=('BSD')
source=(
  "$_basename::git+https://github.com/daokoder/dao"
  "$_basename-modules::git+https://github.com/daokoder/dao-modules"
  "$_basename-tools::git+https://github.com/daokoder/dao-tools")
sha256sums=('SKIP' 'SKIP' 'SKIP')
depends=('gcc-libs-multilib' 'mesa' 'glu' 'freeglut')
makedepends=()
optdepends=()
  #'emscripten-git: support for compilation to JavaScript')
provides=('dao')
conflicts=()

build() {
  mv "$_basename-modules/"* "${_basename}/modules"
  mv "$_basename-tools/"*   "${_basename}/tools"
  cd "$_basename"

  # TODO add DaoGraphics module (after solving the gl3.h issue) + update depends()

  # FIXME following modules/tools are currently not compilable
  rm -rf tools/clangdao/  # FIXME https://bbs.archlinux.org/viewtopic.php?id=144719
  rm -rf modules/DaoJIT/  # daoJIT.cpp:49:36: fatal error: llvm/Support/IRBuilder.h: No such file or directory

  #for f in ./modules/DaoJIT/daoJIT.cpp \
  #         ./modules/DaoJIT/daoJIT.h; do
  #  sed -i -r 's|("llvm/)Support/(IRBuilder.h")|\1\2|' "$f"
  #done

  msg "Starting make..."
  # TODO dao.config is not yet applicable?
  _opts="       --option-INSTALL-PATH '$pkgdir/usr/lib/dao/'"
  _opts="$_opts --option-BIN-PATH     '$pkgdir/usr/bin/'"
  _opts="$_opts --option-LIB-PATH     '$pkgdir/usr/lib/dao/'"
  _opts="$_opts --option-INC-PATH     '$pkgdir/usr/include/dao/'"
  _opts="$_opts --option-MOD-PATH     '$pkgdir/usr/lib/dao/modules/'"
  _opts="$_opts --option-DOC-PATH     '$pkgdir/usr/share/doc/dao/'"
  make -f Makefile.daomake linux RESET='--reset' OPTIONS="$_opts"
    #JAVASCRIPT='ON'
}

pkgver() {
  cd "$_basename"
  echo "$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}

package() {
  cd "$_basename"
  make install
  install -D -m644 license.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

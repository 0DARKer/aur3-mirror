# Maintainer: Jan Pacner
# Contributor: dumblob <dumblob@gmail.com>

_basename=dao
pkgname=${_basename}-lang-git
pkgver=20130224
pkgrel=1
pkgdesc="A lightweight, portable, optionally typed programming language and VM written in C with concurrency, OOP, JIT, LLVM bytecode, syntax customization using BNF, etc."
arch=('i686' 'x86_64')
url="http://www.daovm.net/"
license=('BSD')
depends=() #depends=('cmake' 'clang' 'llvm')
#FIXME https://bbs.archlinux.org/viewtopic.php?id=144719
makedepends=('cmake') #makedepends=('cmake' 'clang' 'llvm')
optdepends=() #'pkg_name: what does it helps you to'
provides=('dao')
conflicts=('dao-fossil')


_gitdao="$_basename"
_gitdao_modules="${_basename}-modules"
_gitdao_tools="${_basename}-tools"
_git="https://github.com/daokoder/"

# for version auto-generation
_gitroot="$_git/$_gitdao"
_gitname="$_gitdao"


build() {
  for x in "$_gitdao" "$_gitdao_modules" "$_gitdao_tools"; do
    cd "$srcdir"
    msg "Connecting to GIT server..."

    if [ -d "$x" ]; then
      cd "$x" && git pull origin
      msg "The local files are updated."
    else
      git clone --depth=1 "$_git/$x" "$x"
    fi

    msg "GIT checkout done or server timeout"
  done

  msg "Preparing build environment..."

  cd "$srcdir"
  [ -d "${_gitdao}_build" ] && rm -rf "${_gitdao}_build"
  cp -r "$_gitdao"           "${_gitdao}_build"
  cp -r "$_gitdao_modules/"* "${_gitdao}_build/modules"
  cp -r "$_gitdao_tools/"*   "${_gitdao}_build/tools"

  msg "Running Cmake..."

  mkdir "${_gitdao}_build/build"
  cd "${_gitdao}_build/build"

  # FIXME add support for dao.config in the future versions of Dao

  # allow JIT
  sed -i -r \
    -e 's/\r//' \
    -e 's|^ *# *(add_subdirectory\("\$\{PROJECT_SOURCE_DIR\}/modules/DaoJIT"\)) *$|\1|' ../CMakeLists.txt
  # JIT and Clang does not work yet (see the arch linux forum link above)
  cmake \
    -DCMAKE_INSTALL_PREFIX=/usr/ \
    -DDAO_MODULES_DAOCXX=OFF \
    -DDAO_MODULES_JIT=OFF \
    ../

  msg "Starting make..."
  make
  make DESTDIR="$pkgdir" install

  #msg "Making doc..."
  # FIXME
  #   create modules/help/CMakeLists.txt
  #   modify build/../CMakeLists.txt
  #     echo 'add_subdirectory("${PROJECT_SOURCE_DIR}/modules/help")' >> ../CMakeLists.txt
  #   cd build/../
  #   $(HAS_DIR) doc/html || $(MKDIR) doc/html
  #   $(HAS_DIR) doc/html/$(DAO_HELP_LANG) || $(MKDIR) doc/html/$(DAO_HELP_LANG)
  #   DAO_HELP_LANG=$(DAO_HELP_LANG) ./dao -e "load help; help.export('','doc/html/$(DAO_HELP_LANG)')"
  #   cp -r doc/* "$pkgdir/usr/share/doc/dao/"
}

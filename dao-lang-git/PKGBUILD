# Maintainer: Jan Pacner
# Contributor: dumblob <dumblob@gmail.com>

_basename=dao
pkgname=${_basename}-lang-git
pkgver=942.77d9b8a
pkgrel=1
pkgdesc="A lightweight, portable, optionally typed programming language and VM written in C with blazingly fast real concurrency, OOP, JIT, LLVM bytecode, syntax customization using BNF, many modules (e.g. graphics) etc."
arch=('i686' 'x86_64')
url="http://www.daovm.net/"
license=('BSD')
source=(
  "$_basename::git+https://github.com/daokoder/dao"
  "$_basename-modules::git+https://github.com/daokoder/dao-modules"
  "$_basename-tools::git+https://github.com/daokoder/dao-tools")
sha256sums=('SKIP' 'SKIP' 'SKIP')
depends=('gcc-libs-multilib' 'mesa' 'glu' 'freeglut')
makedepends=()
optdepends=()
  #'emscripten-git: support for compilation to JavaScript')
provides=('dao')
conflicts=()

build() {
  mv "$_basename-modules/"* "${_basename}/modules"
  mv "$_basename-tools/"*   "${_basename}/tools"
  cd "$_basename"

  # TODO add DaoGraphics module (after solving the gl3.h issue) + update depends()

  # FIXME following modules/tools are currently not compilable
  rm -rf tools/clangdao/  # FIXME https://bbs.archlinux.org/viewtopic.php?id=144719
  rm -rf modules/DaoJIT/  # daoJIT.cpp:49:36: fatal error: llvm/Support/IRBuilder.h: No such file or directory

  #for f in ./modules/DaoJIT/daoJIT.cpp \
  #         ./modules/DaoJIT/daoJIT.h; do
  #  sed -i -r 's|("llvm/)Support/(IRBuilder.h")|\1\2|' "$f"
  #done

  sed -i -r \
    -e 's|(daovm\.ExportPath *\( *"DOC-PATH" *, *daovm_doc_path *\) *;*)|\1\ndaovm.ExportPath("ROOT-PATH","'"$pkgdir/usr/lib/dao/"'");|' \
    -e 's|(daovm\.Install *\( *daovm.GetPath *\( *")INSTALL-PATH(" *\) *\+ *"shared/daomake/packages/" *, *"FindDao\.dao" *\) *;*)|\1ROOT-PATH\2|' \
    makefile.dao

  msg "Starting make..."
  # TODO dao.config is not yet applicable?
  make -f Makefile.daomake linux \
    INSTALL="$pkgdir/usr/" \
    RESET='--reset' \
    OPTIONS="--option-DOC-PATH '$pkgdir/usr/share/doc/dao/'"
    #JAVASCRIPT='ON'
}

pkgver() {
  cd "$_basename"
  echo "$(git rev-list --count HEAD).$(git rev-parse --short HEAD)"
}

package() {
  cd "$_basename"
  make install
  install -D -m644 license.txt "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

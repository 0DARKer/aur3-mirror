# Original Author: clowwindy
# Maintainer: JokerYu <dayushinn@gmail.com>

pkgname=shadowsocks-gui
pkgver=0.4
pkgrel=1
pkgdesc="Shadowsocks GUI client"
arch=("i686" "x86_64")
url="https://github.com/shadowsocks/shadowsocks-gui"
license=("Custom")
options=(!strip)
makedepends=("zip" "nodejs" "node-webkit")

# if you want to keep node-webkit
# please uncomment the depends line

# depends=("node-webkit")

source=(
  "https://github.com/shadowsocks/${pkgname}/archive/${pkgver}.tar.gz"
  "${pkgname}-binary.desktop"
  "${pkgname}.desktop"
  "${pkgname}.sh"
)

md5sums=('11b5d30de885cc9eac908818737ffbfa'
         '7229b632700df5c241424bd7fde9298a'
         '05e7ab9f056103278425d4bde60161dc'
         '4fd84baa88b2b831a3a2aa1626942f7f')

function _build_binary() {
  msg "preparing nw file"
  zip -r ../${pkgname}.nw *

  cd ../
  cat /usr/bin/nw ${pkgname}.nw > ${pkgname}
  msg "build done"
}

function _install_binary() {
  install -Dm 644 ${srcdir}/${pkgname}-binary.desktop ${pkgdir}/usr/share/applications/${pkgname}.desktop
  install -Dm 644 /usr/lib/node-webkit/nw.pak ${pkgdir}/opt/${pkgname}/
  install -Dm 644 ${srcdir}/${pkgname}-${pkgver}/icon.png ${pkgdir}/opt/${pkgname}/
  install -Dm 755 ${srcdir}/${pkgname} ${pkgdir}/opt/${pkgname}
  ln -s ${pkgdir}/opt/${pkgname}/${pkgname}  ${pkgdir}/usr/bin/${pkgname}
}

function _install() {
  install -Dm 644 ${srcdir}/${pkgname}.desktop ${pkgdir}/usr/share/applications/
  install -Dm 755 ${srcdir}/${pkgname}.sh  ${pkgdir}/usr/bin/${pkgname}
  cp -r ${srcdir}/${pkgname}-${pkgver}/* ${pkgdir}/opt/${pkgname}/
}

build() {
  cd ${pkgname}-${pkgver}

  msg "fixing npm install err"
  sed -i 's/0.4/0.4.0/g' package.json

  msg "installing node modules"
  npm install

  # if you want to keep node-webkit
  # please comment the next line
  _build_binary
}

package() {
  msg "copying files"
  mkdir -p ${pkgdir}/opt/${pkgname}
  mkdir -p ${pkgdir}/usr/share/applications
  mkdir -p ${pkgdir}/usr/share/licenses/${pkgname}
  mkdir -p ${pkgdir}/usr/bin

  install -Dm 644 ${srcdir}/${pkgname}-${pkgver}/LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/

  # if you want to keep node-webkit
  # please comment the next line
  _install_binary

  # otherwise comment the previous line and 
  # uncommet the following line
  # _install
}
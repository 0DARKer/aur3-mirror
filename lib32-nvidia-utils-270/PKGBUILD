# Maintainer  : Sebastian Garcia <seb.garcia@gmail.com>
# Based on lib32-nvidia-beta of Dan Vratil <vratil@progdansoft.com>

pkgname=lib32-nvidia-utils-270
pkgver=270.41.03
pkgrel=3
pkgdesc="NVIDIA drivers utilities and libraries."
arch=(x86_64)
url="http://www.nvidia.com/"
license=('custom')
groups=('lib32')
depends=('lib32-libxext')
conflicts=('lib32-libgl' 'lib32-ati-fglrx-utils' 'lib32-nvidia-utils')
provides=('lib32-libgl' "lib32-nvidia-utils=${pkgver}")
license=('custom')
source=(http://download.nvidia.com/XFree86/Linux-x86/${pkgver}/NVIDIA-Linux-x86-${pkgver}.run)

build()
{
  cd "${srcdir}"
  if [ -d NVIDIA-Linux-x86-${pkgver} ]; then 
	rm -rf NVIDIA-Linux-x86-${pkgver}; 
   fi

  # Extract sources
  sh NVIDIA-Linux-x86-${pkgver}.run --extract-only
}

package() {

  cd "${srcdir}/NVIDIA-Linux-x86-${pkgver}"

  # Create install dirs
  mkdir -p "${pkgdir}/usr/lib32/tls"
  
  # Install libraries
  install {libGL,libnvidia-compiler,libnvidia-glcore,libcuda,libnvidia-tls,libvdpau_nvidia}.so.${pkgver} "${pkgdir}/usr/lib32"
  install tls/libnvidia-tls.so.${pkgver} "${pkgdir}/usr/lib32/tls"
  install -m755 libOpenCL.so.1.0.0 "${pkgdir}/usr/lib32"
  #install {libXvMCNVIDIA.a,libXvMCNVIDIA.so.${pkgver}} "${pkgdir}/usr/lib32"
  
  # Create symlinks
  cd "${pkgdir}/usr/lib32"
  ln -s libOpenCL.so.1.0.0 libOpenCL.so.1
  ln -s libOpenCL.so.1 libOpenCL.so
  ln -s libGL.so.${pkgver} libGL.so.1
  ln -s libGL.so.${pkgver} libGL.so
  ln -s libnvidia-glcore.so.${pkgver} libnvidia-glcore.so.1
  ln -s libnvidia-glcore.so.${pkgver} libnvidia-glcore.so
  ln -s libnvidia-cfg.so.${pkgver} libnvidia-cfg.so.1
  ln -s libnvidia-cfg.so.${pkgver} libnvidia-cfg.so
  ln -s libnvidia-compiler.so.${pkgver} libnvidia-compiler.so.1
  ln -s libnvidia-compiler.so.${pkgver} libnvidia-compiler.so
  ln -s libnvidia-tls.so.${pkgver} libnvidia-tls.so.1
  ln -s libnvidia-tls.so.${pkgver} libnvidia-tls.so
  ln -s libcuda.so.${pkgver} libcuda.so.1
  ln -s libcuda.so.${pkgver} libcuda.so
  #ln -s libXvMCNVIDIA.so.${pkgver} libXvMCNVIDIA_dynamic.so.1
  ln -sf libvdpau_nvidia.so.${pkgver} "${pkgdir}/usr/lib32/libvdpau_nvidia.so.1"

  find "${pkgdir}/usr/" -type d -exec chmod 755 {} \;
  #chmod 644 ${pkgdir}/usr/lib32/libXvMCNVIDIA.a
}



md5sums=('4e3b54ee55c6cfa4437c12a8bd9a4250')

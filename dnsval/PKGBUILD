# Contributor:	Thomas Mudrunka <harvie@@email..cz>
# Maintainer: 	Thomas Mudrunka <harvie@@email..cz>
# You can also contact me on http://blog.harvie.cz/
# Patches welcome: http://github.com/harvie/archlinux-packages

pkgname=dnsval
pkgver=1.11
pkgrel=1
pkgdesc="C libraries that implement DNSSEC aware DNS resolution APIs."
url="http://www.dnssec-tools.org/"
license="Custom"
arch=('i686' 'x86_64')
depends=('dnssec-root-zone-trust-anchors' 'dnssec-tools')
source=("http://www.dnssec-tools.org/download/${pkgname}-${pkgver}.tar.gz")
md5sums=('2c02c0f0f4ed0a73eae029e39fd7ed8c')
sha1sums=('cf69fe9c0192bbf77198d22586cef776c97b8b29')
sha256sums=('31ba003a4abf4537e4b79556ab21f8fc84586681fc8e1e5a7648b05795375f66')
sha384sums=('33e3e7c2a15496631e15c02cd115db1fb382739573e1416fe359903a0482e032fee36e25159419c1b148ddab186139e9')
sha512sums=('bb65c094aaa14f5c81de4016db6497168ddd32a25fcb90abd751ba441453e4eed8add6c4f3fca2356ff8ba479726b286ed2c910954f5dd062ab52778e9d0fe92')


build() {
	#Segfaults with optimizations...
		ARCH="$(echo -ne "$CARCH" | tr _ -)"
		export CFLAGS="-march=$ARCH -mtune=generic"
		export CXXFLAGS="-march=$ARCH -mtune=generic"
	echo $ARCH > /home/max/arch.txt

	cd ${srcdir}/${pkgname}-${pkgver}/ || return 1
	msg 'Configuring...'
	./configure\
		--exec_prefix=/usr --prefix=/usr\
		--sysconfdir=/etc --mandir=/usr/share/man\
		--with-resolv-conf=/etc/dnssec-tools/resolv.conf\
		--with-root-hints=/etc/dnssec-tools/root.hints\
		--with-dnsval-conf=/etc/dnsec-tools/dnsval.conf\
		--with-ipv6\
		--with-nsec3\
		--with-dlv 

	# msg 'Fixing bugs...'
		#grep VAL_ROOT_HINTS ./validator/libval/val_policy.h	|| {
		#	msg2 'fixing missing VAL_ROOT_HINTS in ./validator/libval/val_policy.h'
		#	root_hints="$(grep '^VAL_ROOT_HINTS=' ./validator/config.log | head -n 1 | tr = ' ' | tr "'" '"' | sed -e 's/\//\\\//g')"
		#	cat ./validator/libval/val_policy.h | sed -e 's/#include "val_parse.h"/#include "val_parse.h"\n#define '"$root_hints"'/' > tmp
		#	mv tmp ./validator/libval/val_policy.h
		#}

	msg 'Building...'
		make -j1
}
package() {
	cd ${srcdir}/${pkgname}-${pkgver}/ || return 1	
	msg 'Installing files to package...'
		make -j1 install DESTDIR="${pkgdir}"
	msg 'Cleaning...'
		#have to do this because of some issues...
		rm -rf "${srcdir}/"
}

# Maintainer: Zachary A. Jones <JazzplayerL9@gmail.com>

pkgname=voxatron
pkgver=0.1.6
pkgrel=2
pkgdesc="Voxatron is an action/adventure game set in a world completely made of tiny cubes that can be blasted to smithereens"
url="http://www.lexaloffle.com/voxatron.php"
license=('custom: "commercial"')
groups=('humblevoxatronbundle' 'humblebundles')
arch=('i686' 'x86_64')
[ "${CARCH}" = "x86_64" ] && depends=('lib32-libgl' 'lib32-sdl')
[ "${CARCH}" = "i686" ] && depends=('libgl' 'sdl')
[ "${CARCH}" = "x86_64" ] && optdepends=('lib32-alsa-lib: sound support' 'lib32-libpulse: sound suport')
[ "${CARCH}" = "i686" ] && optdepends=('alsa-lib: sound support' 'libpulse: sound support')
options=(!strip)
source=("${pkgname}.desktop" "vox-exec" "voxicon.png")
md5sums=('184c021b52d3a9c8ac5f49435b4b93e0'
	 'bb84f6fcd7cdb18eb417173a6f58e00e'
	 '473215a7749bb2268bdc2b654d7e85d5')

_gamepkg="${pkgname}_${pkgver}_i386.tar.gz"

build() {
   cd "${srcdir}"
   msg "You need a full copy of this game in order to install it"
   msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
   if [[ -f "../${_gamepkg}" ]]; then
       msg "Found game package, installing..."
       ln -fs "../${_gamepkg}" .
   elif [ -n "${_humblevoxatronkey}" ]; then
	   msg "Game package not found, trying to download..."
	   rm -f index.html\?key\=${_humblevoxatronkey}*
	   wget http://www.humblebundle.com/?key=${_humblevoxatronkey}
	   wget $(cat index.html\?key\=${_humblevoxatronkey} | grep "${_gamepkg}" | cut -d "'" -f 10)
	   mv ${_gamepkg}* ${_gamepkg}
   else
	   msg "Game package not found and download failed."
	   msg "You can add \'export _humblevoxatronkey\=\<Your key here\>\' to \.bashrc if you want automated download ability."
       error "Please type absolute path to ${_gamepkg} (/home/joe):"
       read pkgpath
       if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
           msg "Found game package, installing..."
		   ln -fs "${pkgpath}/${_gamepkg}" .
	   else
	       error "Unable to find game package."
	       return 1
       fi
   fi
   tar zxvf ${_gamepkg}
   install -d "${pkgdir}/opt/${pkgname}"
   rm "${srcdir}/${pkgname}/libSDL-1.2.so.0"
   cp -R "${srcdir}"/${pkgname}/* "${pkgdir}/opt/${pkgname}/"
}

package(){
  cd "${srcdir}"
  # create Launcher
  install -d "${pkgdir}/usr/bin/"
  install -D -m755 "${srcdir}/vox-exec" "${pkgdir}/usr/bin/${pkgname}"
  # Install Desktop File and Icon
  install -D -m644 "${srcdir}/${pkgname}.desktop" \
        "${pkgdir}/usr/share/applications/${pkgname}.desktop"
  install -D -m644 "${srcdir}/voxicon.png" \
		"${pkgdir}/usr/share/icons/${pkgname}-icon.png"
  # Install license
  install -Dm 644 "${pkgdir}"/opt/${pkgname}/license.txt "${pkgdir}"/usr/share/licenses/${pkgname}/license
}

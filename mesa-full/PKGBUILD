# Maintainer: LEW21 <lew21@xtreeme.org>

pkgname=mesa-full
pkgver=20110418
_realver=7.10
pkgrel=1
pkgdesc="Full Mesa 3D graphics library with all its components, built from the git master branch. If you live in the US, you should delete --enable-texture-float \ line."
arch=(i686 x86_64)
url="http://mesa3d.org/"
license=('LGPL')
depends=('libdrm>=2.4.24' 'dri2proto>=2.3' 'glproto>=1.4.12' 'libxxf86vm' 'libxdamage' 'expat>=2.0.1')
makedepends=('pkgconfig')
optdepends=('libtxc_dxtn: S3TC support'
'mesa-demos: glxinfo and glxgears')
provides=("libgl=${_realver}" "mesa=${_realver}" "ati-dri=${_realver}" "intel-dri=${_realver}" "mach64-dri=${_realver}" "mga-dri=${_realver}" "r128-dri=${_realver}" "savage-dri=${_realver}" "tdfx-dri=${_realver}" "unichrome-dri=${_realver}")
conflicts=('libgl' 'mesa' 'glew' 'ati-dri' 'intel-dri' 'mach64-dri' 'mga-dri' 'r128-dri' 'savage-dri' 'tdfx-dri' 'unichrome-dri')

_gitroot="git://anongit.freedesktop.org/git/mesa/mesa"
_gitname="mesa"

build() {
	msg "Connecting to git.freedesktop.org GIT server...."

	if [ -d $_gitname ] ; then
		cd $_gitname && git pull origin && cd ..
		msg "The local files are updated."
	else
		git clone $_gitroot
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf $_gitname-build
	cp -rH $_gitname $_gitname-build
	cd $_gitname-build

	./autogen.sh --prefix=/usr \
	--enable-glx-tls \
	--enable-xcb \
	--enable-gles1 \
	--enable-gles2 \
	--disable-glut \
	--enable-texture-float \
	--enable-gallium-r600 \
	--with-dri-driverdir=/usr/lib/xorg/modules/dri

	make
}

package() {
	cd ${srcdir}/$_gitname-build

	make DESTDIR="${pkgdir}" install

	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
	ln -sf libglx.xorg ${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so

	rm "${pkgdir}/usr/include/GL/glut.h"
}

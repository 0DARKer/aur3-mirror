# vim:set ts=2 sw=2 et:

#Contributor: ezzetabi <ezzetabi at gawab dot com>

pkgname=generally
pkgver=1.10c
pkgrel=1
pkgdesc="GeneRally is a great, small racing game."
arch=(i686 x86_64)
url="http://gene-rally.com/"
license=('freeware')
makedepends=()
depends=(wine)
options=(!strip)
install=
source=(icons.tar.xz msvcp100.dll.tar.xz
 'generally.zip::http://gene-rally.com/download/latest/')
noextract=('icons.tar.xz' 'generally.zip')

build() {
  cd "$pkgdir"
  install -d -m 755 usr/share/generally usr/share/applications usr/bin \
    usr/share/pixmaps

  bsdtar xf "$srcdir"/icons.tar.xz
  ln -s /usr/share/icons/hicolor/48x48/apps/generally.png \
    usr/share/pixmaps/generally.png

  cd "$pkgdir"/usr/share/generally
  bsdtar xf  "$srcdir"/generally.zip
  install -m644 "$srcdir"/msvcp100.dll .

  cd "$pkgdir"
  find usr/ -type d -exec chmod 755 "{}" \;
  find usr/ -type f -exec chmod 644 "{}" \;

  #Lets create support files.
#############################################################################
  cd "$pkgdir"/usr/bin || return 1
  cat << EOF >generally
#!/bin/bash
set -e

export WINEARCH=win32
export WINEPREFIX="\$HOME"/.generally/winefs
export WINEDLLOVERRIDES="mshtml="
export XDG_DATA_HOME=/dev/null
export WINEDEBUG=-all

echo Starting...

if [ ! -d "\$HOME"/.generally ] ;then
    mkdir -p "\$HOME"/.generally/sounds

    cd "\$HOME"/.generally

    ln -s -T /usr/share/generally/lang lang
    ln -s -T /usr/share/generally/sounds/Default sounds/Default
    ln -s -T /usr/share/generally/sounds/Funny sounds/Funny
    ln -s /usr/share/generally/GeneRally.exe GeneRally.exe
    ln -s /usr/share/generally/TrackEditor.exe TrackEditor.exe
    ln -s /usr/share/generally/font.bmp font.bmp
    ln -s /usr/share/generally/readme.txt readme.txt
    ln -s /usr/share/generally/trackeditor.cur trackeditor.cur
    ln -s /usr/share/generally/version.txt version.txt
    ln -s /usr/share/generally/SDL.dll SDL.dll
    ln -s /usr/share/generally/msvcp100.dll msvcp100.dll

    cp -ra /usr/share/generally/drivers .
    cp -ra /usr/share/generally/tracks .
    cp -ra /usr/share/generally/cars .
    cp /usr/share/generally/gr.pal .
    cp /usr/share/generally/gr.ini .
fi

cd "\$HOME"/.generally
wine ./GeneRally.exe "\$@" &>/dev/null
xrefresh
echo Goodbye from GeneRally!

exit 0
EOF
  chmod 755 generally

#############################################################################
  cd "$pkgdir"/usr/share/applications
  cat <<EOF >generally.desktop
  [Desktop Entry]
  Version=1.0
  Exec=generally
  Icon=generally
  Type=Application
  Categories=Game;ActionGame;
  Name=Generally
  GenericName=Race game
  StartupNotify=true
  Terminal=false
EOF
  chmod 644 generally.desktop
#############################################################################

  return 0
}

md5sums=('8f5a1c01f8820ac45a0db57690233d00'
         'e4ecdf03883050fb65a199733ed7ef86'
         '313ea8fe0341c6b0ee31ef5d064619af')


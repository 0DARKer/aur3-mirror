# Maintainer: Robert La Spina <rkidlaspina at gmail dot com>
# Original PKGBUILD by Sean Streeter <anubis2591 at gmail dot com>
pkgname=zandronum-hg
pkgver=3409
pkgrel=1
pkgdesc="OpenGL ZDoom port with Client/Server multiplayer."
arch=('i686' 'x86_64')
url="http://zandronum.com/"
license=('custom')
makedepends=('cmake' 'mercurial' 'yasm')
depends=('sdl' 'gtk2' 'libjpeg6')
optdepends=('timidity++: midi support'
            'freedoom: free IWAD')
install=zandronum.install

_64=

case "$CARCH" in
  i686)
    source=("http://www.fmod.org/index.php/release/version/fmodapi42416linux.tar.gz")
    md5sums=('00b157e8d09d539b0a7023c48b71422a')
    ;;
  x86_64)
    source=("http://www.fmod.org/index.php/release/version/fmodapi42416linux64.tar.gz")
    depends=(${depends[@]} libpng12)
    md5sums=('70b2a6a2618ee9823ab564b4e945c885')
    _64=64
    ;;
esac

_hgroot=https://bitbucket.org/Torr_Samaho
_hgrepo=zandronum

build() {
 
cd $srcdir
msg "Connecting to Mercurial server...."

  if [[ -d "$_hgrepo" ]]; then
    cd "$_hgrepo"
    hg pull -u || true
    msg "The local files are updated."
  else
    hg clone "${_hgroot}/${_hgrepo}" "$_hgrepo" 
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_hgrepo-build"
  hg clone  "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"
 
  cp -r "$srcdir/fmodapi42416linux${_64}/" "$srcdir/$_hgrepo-build/"
  mkdir zan-bin
  cd zan-bin
  cmake .. -DCMAKE_INSTALL_PREFIX=/usr
  make
}
package(){ 
cd $srcdir/zandronum-build/zan-bin
 cat > zandronum.sh << EOF
#!/bin/sh
export LD_LIBRARY_PATH=/usr/share/zandronum/lib
exec /usr/share/zandronum/zandronum "\$@"
EOF

#cat > zandronum-server.sh << EOF
##!/bin/sh
#export LD_LIBRARY_PATH=/usr/share/zandronum/lib
#exec /usr/share/zandronum/zandronum-server "\$@"
#EOF

  
  #install -Dm644 "announcer/zandronum_98a_announcer.pk3" "$pkgdir/usr/share/zandronum/announcer/zandronum_98a_announcer.pk3"
  #for fn in skins/*; do
  #  install -Dm644 "$fn" "$pkgdir/usr/share/zandronum/$fn"
  #done
#  install -Dm644 "zandronum Version History.txt" "$pkgdir/usr/share/zandronum/zandronum Version History.txt"
#  install -Dm644 "zandronum_data.pk3" "$pkgdir/usr/share/zandronum/zandronum_data.pk3"
  install -Dm644 "zandronum.pk3" "$pkgdir/usr/share/zandronum/zandronum.pk3"
  install -Dm755 "output_sdl/liboutput_sdl.so" "$pkgdir/usr/share/zandronum/lib/liboutput_sdl.so"
  install -Dm755 "snes_spc/libsnes_spc.a" "$pkgdir/usr/share/zandronum/lib/libsnes_spc.so"
  install -Dm755 "zandronum" "$pkgdir/usr/share/zandronum/zandronum"
#  install -Dm755 "zandronum-server" "$pkgdir/usr/share/zandronum/zandronum-server"
  install -Dm755 "zandronum.sh" "$pkgdir/usr/bin/zandronum"
#  install -Dm755 "zandronum-server.sh" "$pkgdir/usr/bin/zandronum-server"

install -Dm755 "../fmodapi42416linux${_64}/api/lib/libfmodex${_64}-4.24.16.so" "$pkgdir/usr/share/zandronum/lib/libfmodex${_64}-4.24.16.so"
}

# vim:set ts=2 sw=2 et:

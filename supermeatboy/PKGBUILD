# Maintainer: zendeavor <j.s.mcgee115@gmail.com>
# Assistance from: Daniel Wallace <danielwallace at gtmanfred dot com>
# Contributor: Yochai Gal <yochaigal@gmail.com>
# Contributor: Yann Kaiser <kaiser.yann@gmail.com>

pkgname=supermeatboy
pkgver=20120607
_pkgver=06072012
pkgrel=10
pkgdesc="Super Meat Boy is a game where you play as a boy without skin whose girlfriend who is made of bandages gets kidnapped by a fetus in a tuxedo wearing a top hat and a monocle."
url="http://www.supermeatboy.com/"
license=('custom')
arch=('i686' 'x86_64')
groups=("humble-indie-bundleV" "humble-indie-bundle4" "games")
depends=('openal' 'sdl')
makedepends=('unzip' 'aria2c' 'curl')
source=("${pkgname}-linux-${_pkgver}-bin" 
        "${pkgname}.install"
        "${pkgname}.desktop"
        "${pkgname}.sh")
md5sums=("90a563ff103b4610b41af5fd2bccb21a"
        "b25345577b44fbeeba96c6cc87f11c1e"
        "be21279ec63d306d93f112d57f12abd5"
        "c59565efc66ed594b40da786c7c58609")
PKGEXT=".pkg.tar"

_humblebundle() {
  _archive="source[0]%%:*"
  for group in "${groups[@]}"; do
              
    [[ -f "${!_archive}" ]] && break

    case "${group}" in 
      "humble-indie-bundle"*) _key="_humblebundle${group:19}key" ;;
      *) continue ;;
    esac

  if [[ -z "${!_key}" ]]; then
    warning "Please export _humblebundle4key or _humblebundleVkey for downloading"
    echo "Alternatively, place the download into ${startdir} and retry"
    break
  else
    _uri="$(curl -s http://www.humblebundle.com/downloads?key="${!_key}" \
      | grep "${!_archive}")"
    echo "Choose download method."
    echo "1. Torrent with aria2c"
    echo "2. HTTP with curl"
    read -a _method

    case "${_method}" in
      1)
        _uri="${_uri##*data-bt\=\'}"
        _uri="${_uri%%\'*}" 
        echo "To resume this download later:"
        echo "Run \`aria2c ${pkgname}.torrent\`"
        [[ ! -f "${pkgname}.torrent" ]] &&
          curl -o "${pkgname}.torrent" "${_uri}"
        aria2c "${pkgname}.torrent" --seed-time=0
        ;;
      2)
        _uri="${_uri##*data-web\=\'}"
        _uri="${_uri%%\'*}" 
        curl -o "${!_archive}" "${_uri}"
        ;;
      *)
        echo "Please choose option 1 or 2."
        exit 1
        ;;
    esac

    source[0]="${!_archive}::${_uri}"
  fi

  done
}

package() {
  mkdir -p "${pkgdir}/opt/${pkgname}"
  unzip -u "${source[0]%%:*}" -d "${pkgdir}/opt/${pkgname}" || true
  find "${pkgdir}" -type f -exec chmod 644 "{}" +
  install -Dm644 "${pkgname}".desktop "${pkgdir}/usr/share/applications/${pkgname}.desktop"
  install -Dm755 "${pkgname}".sh "${pkgdir}/usr/bin/${pkgname}"
  chmod 755 "${pkgdir}/opt/${pkgname}/data/SuperMeatBoy" \
    "${pkgdir}/opt/${pkgname}/data/amd64/SuperMeatBoy-amd64" \
    "${pkgdir}/opt/${pkgname}/data/x86/SuperMeatBoy-x86"
}

_humblebundle

# vim: ft=PKGBUILD sts=2 ts=2 sw=2 et

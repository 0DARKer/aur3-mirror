# Maintainer: felix <at yandex dot com, local part is isaev, preceded by m dot p dot>
pkgbase=unifont
pkgname="$pkgbase" # ugly hack for AUR
true && pkgname=(
	ttf-unifont pcf-unifont bdf-unifont psf-unifont unifont-utils
)
pkgver=6.3.20140214
pkgrel=3
epoch=
pkgdesc="A free bitmap font with wide Unicode support (split package with accompanying utilities, TrueType, PCF and BDF versions)"
arch=(i686 x86_64)
url="http://unifoundry.com/"
license=('GPL2')
groups=()
depends=()
makedepends=('perl')
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=()
options=()
install=
changelog=
source=(
	"http://unifoundry.com/pub/unifont-$pkgver/unifont-$pkgver.tar.gz"
	"http://unifoundry.com/pub/unifont-$pkgver/unifont-$pkgver.tar.gz.sig"
	fontconfig-avoid-eye-strain.conf
	fontconfig-upper.conf
	ttf.install
)
noextract=()
sha512sums=('731576d19c1be0964eab31ad47ae3b13aaebee21e2dbab588d270487ee8957b39eac1e2a6b529551b04f95f5df4b1f93b2f52d9b9174bc1c82619589ad20221d'
            'SKIP'
            'd53a3ff71d639d5ae909c85ccac83507a4f4233a2da9304084c8cac20e35002d101ea74d1d716ec57a08a47f53938052e94ca11d8648206386d1fa86d09b77ee'
            '4eb2703bea9af264a8beac2f7605666f7a96a7a36a06dcd4357ad77c99378d99a266aeb54b79bd14a7718a3ceddd8a44b2d4d44e442c02ff4e6cb6f4035cd6a8'
            'f1756a6af6976a5a4af6f9a0aebf9740a3a6525f1e2801610c248c762f745ef73c2adb6c38260c9c036f7b8755f419ac0af55982087d64643222fd1cfeedb297')

_use_precompiled=1 # comment out to build the font from .hex files

### build instructions

_compiled="${_use_precompiled:+pre}compiled"

_wanted() {
	for _item in "${pkgname[@]}"; do
		[[ "$_item" = "$1" ]] && return 0
	done
	return 1
}

if [[ -z "$_use_precompiled" ]]; then
	_wanted pcf-unifont && makedepends+=(xorg-bdftopcf)
	_wanted ttf-unifont && makedepends+=(fontforge)
	_wanted psf-unifont && makedepends+=(bdf2psf)
fi

build() {
	cd "$srcdir/unifont-$pkgver"

	make -j1 -C src
	make -j1 clean
	
	if _wanted bdf-unifont; then
		# always building it, because the _csur variants
		# are missing in the precompiled font
		msg2 "Building the BDF version"
		make -j1 -C font bdf
	fi
	
	if [[ -z "$_use_precompiled" ]]; then
		if _wanted psf-unifont; then
			msg2 "Building the PSF version"
			make -j1 -C font psf
		fi
		if _wanted pcf-unifont; then
			msg2 "Building the PCF version"
			make -j1 -C font pcf
		fi
		if _wanted ttf-unifont; then
			msg2 "Building the TTF version" 
			make -j1 -C font ttf csurttf upperttf uppercsurttf
		fi
	fi
}

# warning: below i pretty much bypass the whole build system,
# because it's not flexible enough to handle this kind of packaging

package_ttf-unifont() {
	true && pkgdesc="A free bitmap font with wide Unicode support (TrueType version)"
	true && arch=(any)
	true && install=ttf.install
	
	_ttfdir=/usr/share/fonts/TTF

	cd "$srcdir/unifont-$pkgver/font/$_compiled"
	install -D -m0644 "unifont-${pkgver}.ttf" \
		"${pkgdir}${_ttfdir}/unifont.ttf"
	install -D -m0644 "unifont_csur-${pkgver}.ttf" \
		"${pkgdir}${_ttfdir}/unifont_csur.ttf"
	install -D -m0644 "unifont_sample-${pkgver}.ttf" \
		"${pkgdir}${_ttfdir}/unifont_sample.ttf"
	install -D -m0644 "unifont_upper-${pkgver}.ttf" \
		"${pkgdir}${_ttfdir}/unifont_upper.ttf"
	install -D -m0644 "unifont_upper_csur-${pkgver}.ttf" \
		"${pkgdir}${_ttfdir}/unifont_upper_csur.ttf"

	cd "$srcdir"
	install -D -m0644 fontconfig-avoid-eye-strain.conf \
		"$pkgdir/etc/fonts/conf.avail/20-unifont-noaa.conf"
	install -D -m0644 fontconfig-upper.conf \
		"$pkgdir/etc/fonts/conf.avail/20-unifont-upper.conf"
}

package_pcf-unifont() {
	true && pkgdesc="A free bitmap font with wide Unicode support (PCF version)"
	true && arch=(any)
	
	_pcfdir=/usr/share/fonts/misc

	cd "$srcdir/unifont-$pkgver/font/$_compiled"
	install -D -m0644 "unifont-${pkgver}.pcf.gz" \
		"${pkgdir}${_pcfdir}/unifont.pcf.gz"
	install -D -m0644 "unifont_csur-${pkgver}.pcf.gz" \
		"${pkgdir}${_pcfdir}/unifont_csur.pcf.gz"
	install -D -m0644 "unifont_sample-${pkgver}.pcf.gz" \
		"${pkgdir}${_pcfdir}/unifont_sample.pcf.gz"
}

package_bdf-unifont() {
	true && pkgdesc="A free bitmap font with wide Unicode support (BDF version)"
	true && arch=(any)

	_bdfdir=/usr/share/fonts/misc

	# always use the compiled version, see build() above
	cd "$srcdir/unifont-$pkgver/font/compiled"
	install -D -m0644 "unifont-${pkgver}.bdf.gz" \
		"${pkgdir}${_bdfdir}/unifont.bdf.gz"
	install -D -m0644 "unifont_csur-${pkgver}.bdf.gz" \
		"${pkgdir}${_bdfdir}/unifont_csur.bdf.gz"
	install -D -m0644 "unifont_sample-${pkgver}.bdf.gz" \
		"${pkgdir}${_bdfdir}/unifont_sample.bdf.gz"
}

package_psf-unifont() {
	true && pkgdesc="A free bitmap font with wide Unicode support (PSF version, for APL)"
	true && arch=(any)
	
	cd "$srcdir/unifont-$pkgver/font/$_compiled"
	install -D -m 0644 "Unifont-APL8x16-${pkgver}.psf.gz" \
		"${pkgdir}/usr/share/kbd/consolefonts/Unifont-APL8x16.psf.gz"
}

package_unifont-utils() {
	true && pkgdesc="A free bitmap font with wide Unicode support - utilities"
	true && depends=('perl')
	true && arch=(i686 x86_64)

	cd "$srcdir/unifont-$pkgver/src"
	make install PREFIX="$pkgdir/usr"
	cd "$srcdir/unifont-$pkgver/man"
	make install PREFIX="$pkgdir/usr" COMPRESS=1
}

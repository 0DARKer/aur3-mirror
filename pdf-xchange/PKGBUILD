# Maintainer: swearchnick <swearchnick[at]gmail[dot]com>
pkgname="pdf-xchange"
pkgver="5.5.308.2"
pkgrel="1"
pkgdesc="Perform simple editing of PDF files"
license=('Custom')
arch=('i686' 'x86_64')
depends=('wine' 'hicolor-icon-theme')
makedepends=('p7zip' 'imagemagick' 'gendesk')
install=pdf-xchange.install
url="http://www.tracker-software.com/product/pdf-xchange-editor"
_downloadsource="http://www.tracker-software.com/downloads"
_x86file="PDFXVE5.x86.msi"
_x64file="PDFXVE5.x64.msi"

 if [ "$CARCH" == "x86_64" ]; then
   md5sums=('a7c77d6d4af5ded01c92dca525ed1127')
   source=($_downloadsource/$_x64file)
 fi
 if [ "$CARCH" == "i686" ]; then	
   md5sums=('e7cf8276ef4e4bce8b180a7b8b43847e')
   source=($_downloadsource/$_x86file)
 fi

prepare()
{

 if [ "$CARCH" == "x86_64" ]; then
	7z x "$srcdir/$_x64file" -o"$srcdir"
	7z x "$srcdir/PDFE_x64.cab" -o"$srcdir"		
 fi
 if [ "$CARCH" == "i686" ]; then	
	7z x "$srcdir/$_x86file" -o"$srcdir"
 fi

 7z x "$srcdir/PDFE_x86.cab" -o"$srcdir"
 7z x "$srcdir/PDFE_res.cab" -o"$srcdir"
 7z x "$srcdir/PDFXE.cab" -o"$srcdir"

}

package()
{  

 mkdir -p "$pkgdir/opt/pdf-xchange"

 if [ "$CARCH" == "x86_64" ]; then
	install -Dm644 "$srcdir/FID_ViewerDLL64" "$pkgdir/opt/pdf-xchange/PDFXEditCore.x64.dll"
 fi

 if [ "$CARCH" == "i686" ]; then
	install -Dm644 "$srcdir/FID_ViewerDLL32" "$pkgdir/opt/pdf-xchange/PDFXEditCore.x86.dll"
 fi
 
 install -Dm755 "$srcdir/FID_ViewerEXE" "$pkgdir/opt/pdf-xchange/PDFXEdit.exe" 
 install -Dm644 "$srcdir/FID_Resource" "$pkgdir/opt/pdf-xchange/Resources.dat"
 install -Dm644 "$srcdir/FID_ViewerLicense" "$pkgdir/usr/share/licenses/$pkgname/PDF_VE_.pdf"

 mv "$srcdir/Icon.AppIco" "$srcdir/Icon.AppIco.ico"
 convert "$srcdir/Icon.AppIco.ico" "$srcdir/out.png"

 _num=0 
 for _size in 128 64 48 32 24 16; do
 	install -Dm644 "$srcdir/out-${_num}.png" "$pkgdir/usr/share/icons/hicolor/${_size}x${_size}/apps/${pkgname}.png"
        _num=$((_num + 1))
 done

 gendesk -n -f \
          --pkgname="${pkgname}" \
          --pkgdesc="${pkgdesk}" \
          --name="PDF-XChange" \
          --categories="Utility" \
          --comment="$pkgdesc"
 
 install -Dm644 "$srcdir/pdf-xchange.desktop" "$pkgdir/usr/share/applications/pdf-xchange.desktop"

 mkdir -p "$pkgdir/usr/bin"

 echo '#!/bin/bash' > "$pkgdir/usr/bin/$pkgname"
 echo "program=\"${pkgname}\"" >> "$pkgdir/usr/bin/$pkgname"
 echo 'if [ ! -d "$HOME/.$program/wine" ] ; then' >> "$pkgdir/usr/bin/$pkgname"
 echo '   mkdir -p "$HOME/.$program/wine"' >> "$pkgdir/usr/bin/$pkgname"
 echo 'fi' >> "$pkgdir/usr/bin/$pkgname"
 echo 'WINEPREFIX="$HOME/.$program/wine" "/usr/bin/wine" "/opt/$program/PDFXEdit.exe"' >> "$pkgdir/usr/bin/$pkgname"

 chmod 0755 "$pkgdir/usr/bin/$pkgname"

}

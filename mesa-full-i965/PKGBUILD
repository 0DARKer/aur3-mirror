# Maintainer: Cdh <chrisdhaag@googlemail.com>

pkgname=mesa-full-i965
pkgver=20110706
_realver=7.12
pkgrel=1
pkgdesc="Full Mesa 3D graphics library with all its components, built from the git master branch (mesa 7.11). Compiles mesa for i965c (classic mesa).
arch=(i686 x86_64)
url="http://mesa3d.org/"
license=('LGPL')
depends=('libdrm-git' 'dri2proto>=2.1' 'glproto>=1.4.10' 'libxxf86vm' 'libxdamage' 'expat>=2.0.1' 'libxmu' 'talloc')
makedepends=('pkgconfig' 'imake')
provides=("libgl=${_realver}" "mesa=${_realver}" "freeglut=${_realver}" "glut=${_realver}" "intel-dri=${_realver}") 
replaces=('libgl' 'mesa' 'freeglut' 'glut' 'intel-dri' )
conflicts=('libgl' 'mesa' 'freeglut' 'glut' 'intel-dri')

_gitroot="git://anongit.freedesktop.org/git/mesa/mesa"
_gitname="mesa"

build() {
	msg "Connecting to git.freedesktop.org GIT server...."

	if [ -d $startdir/src/$_gitname ] ; then
		cd $_gitname && git pull origin
		msg "The local files are updated."
	else
		git clone $_gitroot
	fi

	msg "GIT checkout done or server timeout"
	msg "Starting make..."

	rm -rf $startdir/src/$_gitname-build
	cp -rH $startdir/src/$_gitname $startdir/src/$_gitname-build
	cd ${srcdir}/${_gitname}-build

	cd "${startdir}/src/mesa-build"
	./autogen.sh --prefix=/usr \
	--with-dri-drivers=i965 \
	--with-gallium-drivers= \
	--with-dri-driverdir=/usr/lib/xorg/modules/dri \
	--enable-glx-tls \
	--enable-xcb \
	--enable-egl \
	--disable-gallium-egl \
	--enable-glu \
	--enable-gles1 \
	--enable-gles2 \
	--enable-glut \
	--enable-glw \
	--enable-xa \
	--enable-xorg \
	--enable-osmesa \
	--enable-texture-float || return 1

	make || return 1
	make DESTDIR="${pkgdir}" install || return 1

	install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
	ln -sf libglx.xorg ${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so || return 1
}

#!/bin/bash
#
# #############################################################################################################
#
# Nome: DPacman
#
# Versão: 2010.06
#
# Descrição: Uma interface simples, usando shell sript e dialog, para o pacman.
#            Gerenciador de pacotes do Archlinux. Este programa foi baseado nos 
#            códigos do "PacGUI", criado por "jorchube". Obrigado! "jorchube".
# 
# Autor: smarch < silveriomm@bol.com.br >
#
# Data: 09/06/2010
#
# #############################################################################################################
#
# Versão: 2011.04
#
# Data 07/04/2011
#
# Foram modificadas as funções instalar e remover programas, agora
# tem uma opção somente. Elas Localizam e instalam um program pelo nome ou palavra-chave.
# Bastando somente escolher os programas em uma lista.
# Também foram feitas alterações nas funçṍes de buscas, e outras melhorias diversas.

################## SOCORRO, HELP ME, SOCORRO, HELP ME ###########################################################
#
# A quem puder me ajudar, com a tradução deste programa para o inglês, (Meu inglês é muito fraquinho)
# mande me a tradução do script, que eu empacoto e coloco no site do AUR, com os devidos créditos.
#
#################################################################################################################

# ================== CRIA E DEFINE A LOCALIZAÇÃO DO DIRETÓRIO DO PROGRAMA ====================================
	
	mkdir -p $HOME/.dpacman
	
# ============================================================================================================


################ VARIÁVEIS ###################################################################################
##############################################################################################################

btitle="DPACMAN"
DIALOG=dialog

################ SOBRE ########################################################################################
###############################################################################################################

function sobre {
	
	msg="DPacman, é uma interface gráfica,
baseada em dialog, para o pacman,
gerenciador de pacotes do Archlinux.
É muito intuitiva, e fácil de usar.
É um programa totalmente livre!
Você pode usar, modificar e distribuir
como bem entender.
Porém o autor não se responsabiliza,
por qualquer dano que o programa
possa causar ao seu sistema.\n
Portanto use por sua conta e risco!\n
Espero que lhe seja útil!\n\n
silveriomm@bol.com.br\n
2010"
	
	$DIALOG                        \
	--backtitle $btitle            \
	--title "Sobre o DPacman..."   \
	--msgbox "$msg" 0 0
	menu
	
}

##################### INSTALAR PROGRAMA ######################################################################
##############################################################################################################

function instalar {	
	BUSCA=$($DIALOG                                                                              \
	--stdout                                                                                     \
	--backtitle $btitle                                                                          \
	--title "Instalar programa"                                                                   \
	--inputbox "Digite uma palavra-chave, ou nome do programa que deseja instalar" 08 70) || menu
	
	clear
	
	echo
	echo
	echo "                        Digite a sua senha SUDO"
	echo
	echo
	echo
		
	RESP_BUSCA=$(sudo pacman -Ss $BUSCA > $HOME/.dpacman/TMP.txt)
	
	cat $HOME/.dpacman/TMP.txt | cut -d " " -f1 | tr -s "/" " " | sed s/$/" off"/ | awk '{ print $2 " " $1}' > $HOME/.dpacman/TMP2.txt
	
	ORD_LISTA=$(cat $HOME/.dpacman/TMP2.txt)
	
	dialog --stdout                                                                            \
	--backtitle $btitle                                                                        \
	--title "Resultados encontrados para: $BUSCA"                                                                 \
	--separate-output                                                                          \
	--checklist "\n      Selecione os programas que deseja instalar" 0 60 0 $ORD_LISTA > $HOME/.dpacman/TMP3.txt
	
if [ $? = 1 ]
	
	then
	
		menu
	
	else 
	
	PEGA=$(cat $HOME/.dpacman/TMP3.txt)
	clear && sudo pacman -S $PEGA
	menu
	
fi
	
}

############################ INSTALAR PROGRAMA LOCAL ##########################################################################
###############################################################################################################################

function instala_local {
	
	local=$($DIALOG                                               \
	--stdout                                                      \
	--backtitle $btitle                                           \
	--title "      Escolha o arquivo que deseja instalar      "   \
	--fselect /home/$USER 8 0)
	
if [ $? = 1 ]
	then
		menu
	else
		clear && sudo pacman -U $local
		menu
fi

}

######################### REMOVER PROGRAMA #################################################################################
###########################################################################################################################

function remover {	
	BUSCA=$($DIALOG                                                                              \
	--stdout                                                                                     \
	--backtitle $btitle                                                                          \
	--title "Remover programa"                                                                   \
	--inputbox "Digite uma palavra-chave, ou nome do programa que deseja remover" 08 70) || menu
	
		clear
	
	echo
	echo
	echo "                        Digite a sua senha SUDO"
	echo
	echo
	echo
		
	RESP_BUSCA=$(sudo pacman -Ss $BUSCA > $HOME/.dpacman/TMP.txt)
	
	cat $HOME/.dpacman/TMP.txt | cut -d " " -f1 | tr -s "/" " " | sed s/$/" off"/ | awk '{ print $2 " " $1}' > $HOME/.dpacman/TMP2.txt
	
	ORD_LISTA=$(cat $HOME/.dpacman/TMP2.txt)
	
	dialog --stdout                                                                            \
	--backtitle $btitle                                                                        \
	--title "Resultados encontrados para: $BUSCA"                                                                 \
	--separate-output                                                                          \
	--checklist "\n      Selecione os programas que deseja remover" 0 60 0  $ORD_LISTA > $HOME/.dpacman/TMP3.txt
	
if [ $? = 1 ]
	
	then
	
		menu
	
	else 
	
	PEGA=$(cat $HOME/.dpacman/TMP3.txt)
	clear && sudo pacman -R $PEGA
	menu
	
fi
	
}

################### LOCALIZAR PROGRAMA ########################################################################
###############################################################################################################

function localiza {
	BUSCA=$($DIALOG                                                                        \
	--stdout                                                                               \
	--backtitle $btitle                                                                    \
	--title "Localizar programa"                                                           \
	--inputbox "Digite uma palavra-chave, ou o nome do programa que deseja localizar" 08 72)

if [ $? = 1 ]
	then
		menu
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo

		sudo pacman -Ss $BUSCA > $HOME/.dpacman/busca.txt
		
		$DIALOG                                         \
		--backtitle $btitle                             \
		--title "Resultados encontrados para: $BUSCA"	\
		--textbox $HOME/.dpacman/busca.txt 0 0
		menu
fi
}

#################### ATUALIZAR SISTEMA ########################################################################
###############################################################################################################

function menu_atualiza {
	ATUALIZA=$($DIALOG                       \
	--stdout                                 \
	--cancel-label "Voltar"                  \
	--backtitle $btitle                      \
	--title "Atualizar sistema"              \
	--menu "O que deseja fazer?" 0 0 0       \
	1 "Atualizar sistema"                    \
	2 "Atualizar somente a base de dados"    \
	3 "Atualizar base de dados forçado") || menu
	
	case $ATUALIZA in
	
1) clear && sudo pacman -Syu
	 menu ;;
	 
2) clear && sudo pacman -Sy
	 menu ;;
	 
3) clear && sudo pacman -Syy
	 menu ;;
esac
}

################### OUTRAS ATIVIDADES #########################################################################
###############################################################################################################

################# LIMPAR CACHE ################################################################################

function cache {
	CACHE=$($DIALOG                    \
--stdout                               \
--cancel-label "Voltar"                \
--backtitle $btitle                    \
--title "Limpar cache"                 \
--menu "O que deseja fazer?" 0 0 0     \
1 "Limpar pacotes antigos do cache"    \
2 "Apagar todos os pacotes do cache") || menu_outros

	case $CACHE in
	
1) clear && sudo pacman -Sc
	menu_outros ;;
2) clear && sudo pacman -Scc
	menu_outros ;;

esac
}

########################### DETALHES DOS PROGRAMAS INSTALADOS ###########################################################

function info {
	INFO=$($DIALOG                                                                      \
	--stdout                                                                            \
	--backtitle $btitle                                                                 \
	--title "Detalhes de programas instalados"                                          \
	--inputbox "Digite o nome do programa, para saber mais detalhes sobre o mesmo" 08 70)
	
if [ $? = 1 ]
	then
		menu_outros
	else
		RESP_INFO=$(pacman -Qi $INFO)
		echo "$RESP_INFO" > $HOME/.dpacman/INFO.TEMP
		$DIALOG                                      \
		--backtitle $btitle                          \
		--title "Informações do programa:  $INFO "   \
		--textbox $HOME/.dpacman/INFO.TEMP 0 0
		menu_outros	
fi
}

##################### LISTA DE PACOTES PERDIDOS #################################################################################

function lista {		
	clear
	echo
	echo
	echo "                        Digite a sua senha SUDO"
	echo
	echo
	echo

	sudo pacman -Qdt > $HOME/.dpacman/LIST.TEMP
	clear
	echo
	echo
	echo
	echo
	echo
	echo
	echo
	echo
	echo "                          AGUARDE, PROCURANDO..."
	echo
	echo
	echo
	echo
	sleep 2
	$DIALOG --title "Lista de pacotes Perdidos" --textbox $HOME/.dpacman/LIST.TEMP 0 0
	menu_outros
}

######################### EDITAR /etc/rc.conf  ##################################################################################

function rcconf {
	$DIALOG                                                                  \
	--backtitle $btitle                                                      \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                          \
	--yesno "\nTem certeza? Deseja editar o arquivo /etc/rc.conf agora?" 07 60
	
if [ $? == 1 ] 
	then
		menu_outros
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		cp /etc/rc.conf $HOME/.dpacman/rc.conf.backup
		sudo mcedit /etc/rc.conf
	    menu_outros
fi
}

##################### EDITAR /etc/pacman.conf  ##########################################################################

function pacconf {
	$DIALOG                                                                      \
	--backtitle $btitle                                                          \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                              \
	--yesno "\nTem certeza? Deseja editar o arquivo /etc/pacman.conf agora?" 07 60

if [ $? = 1 ] 
	then
		menu_outros
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		cp /etc/pacman.conf $HOME/.dpacman/pacman.conf.backup &&
		sudo mcedit /etc/pacman.conf
	    menu_outros
fi
}

####################### EDITAR /etc/pacman.d/mirrorlist  ##################################################################

function mirror {
	$DIALOG                                                                                \
	--backtitle $btitle                                                                    \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                        \
	--yesno "\nTem certeza?\n Deseja editar o arquivo /etc/pacman.d/mirrorlist agora?" 07 60

if [ $? = 1 ] 
	then
		menu_outros
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		cp /etc/pacman.d/mirrorlist $HOME/.dpacman/mirrorlist.backup &&
		sudo mcedit /etc/pacman.d/mirrorlist
	    menu_outros
fi
}

###################### Restaurar /etc/rc.conf #################################################################

function rest_rconf {
	$DIALOG                                                                     \
	--backtitle $btitle                                                         \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                             \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/rc.conf agora?" 07 60

if [ $? = 1 ]
	then
		menu_restaura
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		sudo cp $HOME/.dpacman/rc.conf.backup /etc/rc.conf
		menu_restaura 
fi
}

# ------------------------ Restaurar /etc/pacman.conf ---------------------------------------------------------

function rest_pacmanconf {
	$DIALOG                                                                         \
	--backtitle $btitle                                                             \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                 \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/pacman.conf agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_restaura
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		sudo cp $HOME/.dpacman/pacman.conf.backup /etc/pacman.conf
		menu_restaura
fi
}

# ------------------------ Restaurar /etc/pacman.d/mirrorlist -------------------------------------------------

function rest_mirror {
	$DIALOG                                                                                 \
	--backtitle $btitle                                                                     \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                         \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/pacman.d/mirrorlist agora?" 07 60

if [ $? = 1 ]
	then
		menu_restaura
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		sudo cp $HOME/.dpacman/mirrorlist.backup /etc/pacman.d/mirrorlist
		menu_restaura
fi
}

################## RESTAURAR ARQUIVOS #########################################################################

function menu_restaura {
	MENU_RESTAURA=$($DIALOG               \
	--stdout                              \
	--cancel-label "Voltar"               \
	--backtitle $btitle                   \
	--title "Restaurar arquivos"          \
	--menu "\nO que deseja fazer?" 0 0 0  \
	1 "Restaurar /etc/rc.conf"            \
	2 "Restaurar /etc/pacman.conf"        \
	3 "Restaurar /etc/pacman.d/mirrorlist") || menu_outros

case $MENU_RESTAURA in

1) rest_rconf ;;
2) rest_pacmanconf ;;	
3) rest_mirror ;;

esac
}

# -------------- Desbloquear base de dados --------------------------------------------------------------------

function destrava {
	
	$DIALOG                                                                \
	--backtitle $btitle                                                    \
	--title "Desbloquear base de dados"                                    \
	--yesno "\nTem certeza? Deseja desbloquear a base de dados agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_outros	
	else
		clear
		echo
		echo
		echo "                        Digite a sua senha SUDO"
		echo
		echo
		echo
		sudo rm /var/lib/pacman/db.lck
		$DIALOG --backtitle $btitle --msgbox "A base de dados foi desbloqueada" 08 30
		menu_outros
fi

}

################### MENU OUTRAS ATIVIDADES #########################################################################
###############################################################################################################

function menu_outros {
	MENU_OUTROS=$($DIALOG                  \
	--stdout                               \
	--cancel-label "Voltar"                \
	--backtitle $btitle                    \
	--title "Outras atividades"            \
	--menu "O que deseja fazer?" 0 0 0     \
	1 "Limpar cache"                       \
	2 "Detalhes de programas instalados"   \
	3 "Lista de pacotes perdidos"          \
	4 "Editar /etc/rc.conf"                \
	5 "Editar /etc/pacman.conf"            \
	6 "Editar /etc/pacman.d/mirrorlist"	   \
	7 "Restaurar arquivos"                 \
	8 "Desbloquear base de dados") || menu
	
	case $MENU_OUTROS in
	
1) cache ;;
2) info ;;
3) lista ;;
4) rcconf ;;
5) pacconf ;;
6) mirror ;;
7) menu_restaura ;;
8) destrava ;;

esac
}



##################### MENU PRINCIPAL ##########################################################################
###############################################################################################################

function menu {
	MENU=$($DIALOG                       \
	--stdout                             \
	--backtitle $btitle                  \
	--title "MENU PRINCIPAL"             \
	--no-cancel                          \
	--menu "\n       O que deseja fazer?" 0 0 0   \
	1 "Instalar programa"                \
	2 "Instalar programa local"          \
	3 "Remover Programa"                 \
	4 "Localizar Programa"               \
	5 "Atualizar Sistema"                \
	6 "Outras atividades"                \
	7 "Sobre este aplicativo"            \
	8 "Sair")
	
	case $MENU in
	
1) instalar ;;
2) instala_local ;;
3) remover ;;
4) localiza ;;
5) menu_atualiza ;;
6) menu_outros ;;
7) sobre ;;
8) clear && exit

esac
}

menu

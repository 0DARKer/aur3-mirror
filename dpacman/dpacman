#!/bin/bash
#
# #############################################################################################################
#
# Nome: DPacman
#
# Versão: 2010.06
#
# Descrição: Uma interface simples, usando shell sript e $DIALOG, para o pacman.
#            Gerenciador de pacotes do Archlinux. Este programa foi baseado nos 
#            códigos do "PacGUI", criado por "jorchube". Obrigado! "jorchube".
# 
# Autor: smarch < silveriomm@bol.com.br >
#
# Data: 09/06/2010
#
# #############################################################################################################
#

	mkdir -p $HOME/.dpacman

################ VARIÁVEIS ###################################################################################
##############################################################################################################

btitle="DPACMAN"
DIALOG=dialog
	
################ SOBRE ########################################################################################
###############################################################################################################

function sobre {
	msg="DPacman, é uma interface gráfica,
baseada em $DIALOG, para o pacman,
gerenciador de pacotes do Archlinux.
É muito intuitiva, e fácil de usar.
É um programa totalmente livre!
Você pode usar, modificar e distribuir
como bem entender.
Porém o autor não se responsabiliza,
por qualquer dano que o programa
possa causar ao seu sistema.\n
Portanto use por sua conta e risco!\n
Espero que lhe seja útil!\n\n
silveriomm@bol.com.br\n
2010"
	
	$DIALOG                        \
	--backtitle $btitle            \
	--title "Sobre o DPacman..."   \
	--msgbox "$msg" 0 0
	menu
}

##################### MENU PRINCIPAL ##########################################################################
###############################################################################################################

function menu {
	MENU=$($DIALOG                       \
	--stdout                             \
	--backtitle $btitle                  \
	--title "MENU PRINCIPAL"             \
	--no-cancel                          \
	--menu "O que deseja fazer?" 0 0 0   \
	1 "Instalar programa"                \
	2 "Remover Programa"                 \
	3 "Localizar Programa"               \
	4 "Atualizar Sistema"                \
	5 "Outras atividades"                \
	6 "Sobre este aplicativo"            \
	7 "Sair")
	
	case $MENU in
	
1) menu_instalar ;;
2) remover ;;
3) localiza ;;
4) menu_atualiza ;;
5) menu_outros ;;
6) sobre ;;
7) clear && exit

esac
}

##################### INSTALAR ################################################################################
###############################################################################################################

function menu_instalar {
	MENU_INSTALAR=$($DIALOG              \
	--stdout                             \
	--backtitle $btitle                  \
	--title "Instalar programa"          \
	--menu "O que deseja fazer?" 0 0 0   \
	1 "Instalar programa"                \
	2 "Instalar programa local") || menu
	
	case $MENU_INSTALAR in
	
1) instala ;;
2) instala_local ;;

esac
}

# ================= Instalar programa =========================================================================

function instala {
	INSTALA=$($DIALOG                                                            \
	--stdout                                                                     \
	--backtitle $btitle                                                          \
	--title "Instalar programa"                                                  \
	--inputbox "Digite o nome (ou nomes) dos programas que deseja instalar" 08 65)

if [ $? = 1 ]
	then
		menu_instalar
	else
		clear && sudo pacman -S $INSTALA
		menu_instalar
fi
}

# ===================== Instalar programa local ===============================================================

function instala_local {
	local=$($DIALOG                                               \
	--stdout                                                      \
	--backtitle $btitle                                           \
	--title "      Escolha o arquivo que deseja instalar      "   \
	--fselect /home/$USER 8 0)
	
if [ $? = 1 ]
	then
		menu_instalar
	else
		clear && sudo pacman -U $local
		menu_instalar
fi
}

################### REMOVER PROGRAMA ##########################################################################
###############################################################################################################

function remover {
	REMOVER=$($DIALOG                                                           \
	--stdout                                                                    \
	--backtitle $btitle                                                         \
	--title "Remover programa"                                                  \
	--inputbox "Digite o nome (ou nomes) dos programas que deseja remover" 08 61)
	
if [ $? = 1 ]
	then
		menu		
	else
		clear && sudo pacman -Rsc $REMOVER
		menu
fi	
}

################### LOCALIZAR PROGRAMA ########################################################################
###############################################################################################################

function localiza {
	LOCALIZA=$($DIALOG                                                                     \
	--stdout                                                                               \
	--backtitle $btitle                                                                    \
	--title "Localizar programa"                                                           \
	--inputbox "Digite uma palavra-chave, ou o nome do programa que deseja encontrar" 08 72)

if [ $? = 1 ]
	then
		menu
	else
	    RESP_LOCALIZA=$(sudo pacman -Ss $LOCALIZA) 
	    echo $RESP_LOCALIZA | grep / | tr -s [:blank:] "\n" | grep / | tr -s "/" " " > $HOME/.dpacman/BUSCA.TEMP
	    $DIALOG                                              \
        --title "Resultados encontrados para:  $LOCALIZA"   \
	    --textbox $HOME/.dpacman/BUSCA.TEMP 30 50
	    menu
fi
}

#################### ATUALIZAR SISTEMA ########################################################################
###############################################################################################################

function menu_atualiza {
	ATUALIZA=$($DIALOG                       \
	--stdout                                 \
	--backtitle $btitle                      \
	--title "Atualizar sistema"              \
	--menu "O que deseja fazer?" 0 0 0       \
	1 "Atualizar sistema"                    \
	2 "Atualizar somente a base de dados"    \
	3 "Atualizar base de dados forçado") || menu
	
	case $ATUALIZA in
	
1) clear && sudo pacman -Syu
	 menu ;;
	 
2) clear && sudo pacman -Sy
	 menu ;;
	 
3) clear && sudo pacman -Syy
	 menu ;;
esac
}

################### OUTRAS ATIVIDADES #########################################################################
###############################################################################################################

function menu_outros {
	MENU_OUTROS=$($DIALOG                  \
	--stdout                               \
	--backtitle $btitle                    \
	--title "Outras atividades"            \
	--menu "O que deseja fazer?" 0 0 0     \
	1 "Limpar cache"                       \
	2 "Detalhes de programas instalados"   \
	3 "Lista de pacotes perdidos"          \
	4 "Editar /etc/rc.conf"                \
	5 "Editar /etc/pacman.conf"            \
	6 "Editar /etc/pacman.d/mirrorlist"	   \
	7 "Restaurar arquivos"                 \
	8 "Desbloquear base de dados") || menu
	
	case $MENU_OUTROS in
	
1) cache ;;
2) info ;;
3) lista ;;
4) rcconf ;;
5) pacconf ;;
6) mirror ;;
7) menu_restaura ;;
8) destrava ;;

esac
}

################# LIMPAR CACHE ################################################################################
###############################################################################################################

function cache {
	CACHE=$($DIALOG                    \
--stdout                               \
--backtitle $btitle                    \
--title "Limpar cache"                 \
--menu "O que deseja fazer?" 0 0 0     \
1 "Limpar pacotes antigos do cache"    \
2 "Apagar todos os pacotes do cache") || menu_outros

	case $CACHE in
	
1) clear && sudo pacman -Sc
	menu_outros ;;
2) clear && sudo pacman -Scc
	menu_outros ;;

esac
}

# ======================== Detalhes de programas instalados ===================================================

function info {
	INFO=$($DIALOG                                                                      \
	--stdout                                                                            \
	--backtitle $btitle                                                                 \
	--title "Detalhes de programas instalados"                                          \
	--inputbox "Digite o nome do programa, para saber mais detalhes sobre o mesmo" 08 70)
	
if [ $? = 1 ]
	then
		menu_outros
	else
		RESP_INFO=$(pacman -Qi $INFO)
		echo "$RESP_INFO" > $HOME/.dpacman/INFO.TEMP
		$DIALOG                                      \
		--backtitle $btitle                          \
		--title "Informações do programa:  $INFO "   \
		--textbox $HOME/.dpacman/INFO.TEMP 0 0
		menu_outros	
fi
}

# ============= Lista de pacotes perdidos =====================================================================

function lista {
	clear && sudo pacman -Qdt > $HOME/.dpacman/LIST.TEMP
	$DIALOG --title "Lista de pacotes Perdidos" --textbox $HOME/.dpacman/LIST.TEMP 0 0
	menu_outros
}

# ------------ Editar /etc/rc.conf  --------------------------------------------------------------------------------

function rcconf {
	$DIALOG                                                                  \
	--backtitle $btitle                                                      \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                          \
	--yesno "\nTem certeza? Deseja editar o arquivo /etc/rc.conf agora?" 07 60
	
if [ $? = 1 ] 
	then
		menu_outros
	else
		cp /etc/rc.conf $HOME/.dpacman/rc.conf.backup
		sudo mcedit /etc/rc.conf
		sleep 1
        $DIALOG --backtitle $btitle --msgbox "O arquivo foi modificado com sucesso" 08 30
	    menu_outros
fi
}

# ------------ Editar /etc/pacman.conf  ----------------------------------------------------------------------------

function pacconf {
	$DIALOG                                                                      \
	--backtitle $btitle                                                          \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                              \
	--yesno "\nTem certeza? Deseja editar o arquivo /etc/pacman.conf agora?" 07 60

if [ $? = 1 ] 
	then
		menu_outros
	else
		cp /etc/pacman.conf $HOME/.dpacman/pacman.conf.backup &&
		sudo mcedit /etc/pacman.conf
		sleep 1
        $DIALOG --backtitle $btitle --msgbox "O arquivo foi modificado com sucesso" 08 30
	    menu_outros
fi
}

# ------------ Editar /etc/pacman.d/mirrorlist  ---------------------------------------------------------------

function mirror {
	$DIALOG                                                                                \
	--backtitle $btitle                                                                    \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                        \
	--yesno "\nTem certeza?\n Deseja editar o arquivo /etc/pacman.d/mirrorlist agora?" 07 60

if [ $? = 1 ] 
	then
		menu_outros
	else
		cp /etc/pacman.d/mirrorlist $HOME/.dpacman/mirrorlist.backup &&
		sudo mcedit /etc/pacman.d/mirrorlist
		sleep 1
        $DIALOG --backtitle $btitle --msgbox "O arquivo foi modificado com sucesso" 08 30
	    menu_outros
fi
}

################## RESTAURAR ARQUIVOS #########################################################################

function menu_restaura {
	MENU_RESTAURA=$($DIALOG               \
	--stdout                              \
	--backtitle $btitle                   \
	--title "Restaurar arquivos"          \
	--menu "\nO que deseja fazer?" 0 0 0  \
	1 "Restaurar /etc/rc.conf"            \
	2 "Restaurar /etc/pacman.conf"        \
	3 "Restaurar /etc/pacman.d/mirrorlist") || menu_outros

case $MENU_RESTAURA in

1) rest_rconf ;;
2) rest_pacmanconf ;;	
3) rest_mirror ;;

esac
}

###################### Restaurar /etc/rc.conf #################################################################

function rest_rconf {
	$DIALOG                                                                     \
	--backtitle $btitle                                                         \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                             \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/rc.conf agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_restaura
	else
		sudo cp $HOME/.dpacman/rc.conf.backup /etc/rc.conf
		sleep 1
		$DIALOG --backtitle $btitle --msgbox "O arquivo foi restaurado com sucesso" 08 30
		menu_restaura 
fi
}

# ------------------------ Restaurar /etc/pacman.conf ---------------------------------------------------------

function rest_pacmanconf {
	$DIALOG                                                                         \
	--backtitle $btitle                                                             \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                 \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/pacman.conf agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_restaura
	else
		sudo cp $HOME/.dpacman/pacman.conf.backup /etc/pacman.conf
		sleep 1
		$DIALOG --backtitle $btitle --msgbox "O arquivo foi restaurado com sucesso" 08 30
		menu_restaura
fi
}

# ------------------------ Restaurar /etc/pacman.d/mirrorlist -------------------------------------------------

function rest_mirror {
	$DIALOG                                                                                 \
	--backtitle $btitle                                                                     \
	--title "PERIGO, ISTO PODE DANIFICAR O SISTEMA"                                         \
	--yesno "\nTem certeza? Deseja restaurar o arquivo /etc/pacman.d/mirrorlist agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_restaura
	else
		sudo cp $HOME/.dpacman/mirrorlist.backup /etc/pacman.d/mirrorlist
		sleep 1
		$DIALOG --backtitle $btitle --msgbox "O arquivo foi restaurado com sucesso" 08 30
		menu_restaura
fi
}

# -------------- Desbloquear base de dados --------------------------------------------------------------------

function destrava {
	$DIALOG                                                                                 \
	--backtitle $btitle                                                                     \
	--title "Desbloquear base de dados"                                         \
	--yesno "\nTem certeza? Deseja desbloquear a base de dados agora?" 07 60
	
if [ $? = 1 ]
	then
		menu_outros	
	else
		clear && sudo rm /var/lib/pacman/db.lck
		sleep 1
		$DIALOG --backtitle $btitle --msgbox "A base de dados foi desbloqueada" 08 30
		menu_outros
fi
}



menu

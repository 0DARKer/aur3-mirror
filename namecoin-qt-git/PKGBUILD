## Maintainer : Bradley Pesicka <bradley.c.pesicka@gmail.com>

pkgname=namecoin-qt-git
pkgver=nc0.3.51.00.27.gc4e0e82
pkgrel=2
epoch=1
pkgdesc="Namecoin is a peer-to-peer network based digital currency."
arch=('i686' 'x86_64')
url="http://www.dot-bit.org/"
depends=('qt4>=4.6' 'libpng>=1.4' 'expat' 'gcc-libs' 'boost-libs>=1.46' 'miniupnpc>=1.5' 'openssl')
makedepends=('git' 'boost' 'gcc' 'make' 'automoc4')
conflicts=()
provides=('namecoin')
license=('MIT')
source=(
	git://github.com/namecoinq/namecoinq.git
	namecoin.desktop
	namecoin-qt.png
	)
sha512sums=(
	SKIP
	259fbe2ae19559d4465e199fce65da60b14816961e02b4b1a6a158b194f8af75d0ee481ca826756ef8e4accc63d8f14aa5bcb853d791dd7bde4c2de9b35b894d
	27d4fbdd49202384df25e6d6da60dae4e2d9c40e74d95b81b72ea2eff27059c1d35c0fa6082a093b7a6b13369f9ad9731b63c1e6f8bfc626babd56e57f9a1f85
	)

pkgver() {
	cd namecoin
	git describe | sed "s/^v//; s/-/./g"
}

## files & commands for building
qmake=qmake-qt4

prepare() {
	cd namecoinq/

	# Perform patch to get the package building
	sed -e '1099s/"TCP", 0);/"TCP", 0, "0");/' \
	    -i src/net.cpp
}

build() {
	cd namecoinq/

	# make namecoin-qt
	msg "Starting make..."
	$qmake
	make USE_UPNP=1 USE_SSL=1 $MAKEFLAGS 
}

package() {
	set -x
	cd namecoinq

	mkdir -p $pkgdir/usr/bin
	install namecoin-qt $pkgdir/usr/bin

	# Use the icon file from the git repository if it exists.  Otherwise, use the
	# version included with this package description
	mkdir -p $pkgdir/usr/share/pixmaps/
	ICON_FILE=$( find ./ -type f -name namecoin-qt.png )
	if [[ -n "${ICON_FILE}" ]]; then
		install "${ICON_FILE}" $pkgdir/usr/share/pixmaps/namecoin-qt.png
	else
		install $srcdir/namecoin-qt.png $pkgdir/usr/share/pixmaps/namecoin-qt.png
	fi

	# Use the desktop file from the git repository if it exists.  Otherwise, use the
	# version included with this package description
	mkdir -p $pkgdir/usr/share/applications
	DESKTOP_FILE=$( find ./ -type f -name namecoin.desktop )
	if [[ -n "${DESKTOP_FILE}" ]]; then
		install $DESKTOP_FILE $pkgdir/usr/share/applications/namecoin.desktop
	else
		install $srcdir/namecoin.desktop $pkgdir/usr/share/applications/namecoin.desktop
	fi
}

## convert paths from .install and other files: "debian/" -> "contrib/debian/"
deb_paths_pp() { sed -e 's@^\(debian\)@contrib/\1@'; }

## reading input in "<from> <to>"-manner and convert it
apply_deb_install() {
    while read from to ; do
		install $from $pkgdir/$to
    done
}

## guess correct /usr/share/man's subdirectory for man every file
## FIXME Uber-fat crunch. It should another, simple way...
install_man() {
    while read man; do
		local man_d="$pkgdir/usr/share/man/man${man#${man%?}}/"
		mkdir -p $man_d
		install -D $man $man_d
    done
}

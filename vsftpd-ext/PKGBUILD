pkgname=vsftpd-ext
pkgver=2.3.4+ext.2
_pkgver=${pkgver/+/-}
_dirpkgver=${_pkgver/ext./ext}
pkgrel=1
pkgdesc="An extended version of the Very Secure FTP daemon"
arch=('i686' 'x86_64')
url="http://vsftpd.devnet.ru/"
license=('GPL')
depends=('glibc' 'pam' 'tcp_wrappers>=7.6-8' 'openssl>=0.9.8j-1' 'libcap>=2.16')
provides=('vsftpd')
conflicts=('vsftpd')
install=vsftpd-ext.install
backup=(etc/vsftpd.conf etc/xinetd.d/vsftpd)
source=(http://vsftpd.devnet.ru/files/2.3.4/ext.2/vsFTPd-${_dirpkgver}.tgz
        findlibs.patch
        vsftpd.d
        vsftpd.xinetd)
md5sums=('64a540fb89a4ddebe16d81e2bf5fcb14'
         '84a393b4d381c8e0929399ed77ae64fa'
         'e46ed8e4c4a6e6a3de59f60b98e4f569'
         'b07fd4609c70063c1d6b20142910c1a6')

build() {
  cd $srcdir/vsFTPd-${_pkgver}/

  patch -p0 -i $srcdir/findlibs.patch

  # build-time config
  sed \
    -e 's|^#undef VSF_BUILD_TCPWRAPPERS$|#define VSF_BUILD_TCPWRAPPERS|' \
    -e 's|^#undef VSF_BUILD_SSL$|#define VSF_BUILD_SSL|' \
    -i builddefs.h

  make CFLAGS="${CFLAGS}"

  install -D vsftpd $pkgdir/usr/sbin/vsftpd
  install -Dm644 vsftpd.conf $pkgdir/etc/vsftpd.conf
  install -Dm644 vsftpd.8 $pkgdir/usr/man/man8/vsftpd.8
  install -Dm644 vsftpd.conf.5 $pkgdir/usr/man/man5/vsftpd.conf.5
  install -Dm644 ../vsftpd.xinetd $pkgdir/etc/xinetd.d/vsftpd 
  install -D ../vsftpd.d $pkgdir/etc/rc.d/vsftpd
  mkdir -p $pkgdir/usr/share/empty
  echo >>$pkgdir/etc/vsftpd.conf <<_EOF
#
# Use this to use vsftpd in standalone mode, otherwise it runs through (x)inetd
#listen=YES

_EOF
}

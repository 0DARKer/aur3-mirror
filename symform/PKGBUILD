# Contributor: Chionsas <symform-arch@chionsas.lt>

pkgname=symform
pkgdesc="Symform cloud backup and storage service client"
pkgver=3.13.8.0.16779
pkgrel=1
arch=('x86_64' 'i686')
url="http://www.symform.com"
license=('custom: Symform EULA')

makedepends=('patch')
options=('emptydirs')

if test "$CARCH" == x86_64; then
	source=('http://download.symform.com/control/current/linux/x64/Symform.rpm')
	md5sums=('eae862365fcb8a8f0da3794bf0f3764b')
elif test "$CARCH" == i686; then
	source=('http://download.symform.com/control/current/linux/x86/Symform.rpm')
	md5sums=('d5e78eb2f3b798eb6af3cd68a1071854')
fi

source+=('systemctl_path.patch' 'install')
md5sums+=('3be65a9689e9e0a5b8d05a3c8dbc9568' 'SKIP')

package() {
	cp -r $srcdir/{opt,usr} $pkgdir
}

prepare() {
	patch $srcdir/opt/symform/scripts/platform/platform.sh systemctl_path.patch
}

build() {

	declare -A install_actions=(
		['pre_install']="tail -n +2 ${srcdir}/opt/symform/scripts/preinst"
		['post_install']="echo /opt/symform/scripts/postinst configure && /opt/symform/scripts/platform/systemd.sh"
		['pre_upgrade']="echo /opt/symform/scripts/prerm"
		['post_upgrade']="echo /opt/symform/scripts/postrm upgrade && /opt/symform/scripts/postinst configure"
		['pre_remove']="echo /opt/symform/scripts/prerm"
		['post_remove']="tail -n +2 ${srcdir}/opt/symform/scripts/postrm"
	)

	echo "#!/bin/bash" > install
	echo >> install

	echo PURGE=1 >> install
	echo >> install

	for action in "${!install_actions[@]}"
	do
		echo "${action}() {" >> install
		${install_actions[$action]} >> install
		echo "}" >> install
		echo >> install
	done
}

install=install
# Contributor: Chionsas <symform-arch@chionsas.lt>

pkgname=symform
pkgdesc="Symform cloud backup and storage service client"
pkgver=3.12.6.0
pkgrel=r16212
arch=('x86_64' 'i686')
url="http://www.symform.com"
license=('Symform EULA')

makedepends=('rpmextract patch')
options=('emptydirs')

if test "$CARCH" == x86_64; then
	source=('http://download.symform.com/control/current/linux/x64/Symform.rpm')
	md5sums=('10689e699c5acbfbeadf7c5d29440afb')
elif test "$CARCH" == i686; then
	source=('http://download.symform.com/control/current/linux/x86/Symform.rpm')
	md5sums=('28fc0e6966b49fbd79605ee82c5b6891')
fi

source+=('systemctl_path.patch')
md5sums+=('3be65a9689e9e0a5b8d05a3c8dbc9568')

build() {

	cd "$pkgdir"
	rpmextract.sh ../Symform.rpm

	patch ./opt/symform/scripts/platform/platform.sh ../systemctl_path.patch

	cd ..

	echo "#!/bin/sh" > install

	declare -A install_actions

	install_actions=(
		['pre_install']="tail -n +2 ${srcdir}/opt/symform/scripts/preinst"
		['post_install']="echo /opt/symform/scripts/postinst configure && /opt/symform/scripts/platform/systemd.sh"
		['pre_upgrade']="echo /opt/symform/scripts/prerm"
		['post_upgrade']="echo /opt/symform/scripts/postrm upgrade && /opt/symform/scripts/postinst configure"
		['pre_remove']="echo /opt/symform/scripts/prerm"
		['post_remove']="tail -n +2 ${srcdir}/opt/symform/scripts/postrm"
	)

	echo "#!/bin/bash" > install
	echo >> install

	echo PURGE=1 >> install
	echo >> install

	for action in "${!install_actions[@]}"
	do
		echo "${action}() {" >> install
		${install_actions[$action]} >> install
		echo "}" >> install
		echo >> install
	done
}

install=install

# Contributor: Vladimir Kutyavin <vlkut@bk.ru>
pkgbase="kernel26"
pkgname=('kernel26-l7-firmware') # Build stock -ARCH kernel
#pkgname=('kernel26-l7' 'kernel26-l7-firmware' 'kernel26-l7-headers') # Build stock -ARCH kernel
# pkgname=kernel26-custom       # Build kernel with a different name
_kernelname=${pkgname#kernel26}
_basekernel=2.6.32
pkgver=${_basekernel}.10
pkgrel=1
_patchname="patch-${pkgver}-${pkgrel}-ARCH"

_l7patchsetname="netfilter-layer7"
_l7patchsetver="2.22"

_l7kernelpatchname="kernel-2.6.25-2.6.28-layer7"
_l7kernelpatchver="2.22"

arch=(i686 x86_64)
license=('GPL2')
url="http://www.kernel.org"
source=(ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$_basekernel.tar.bz2
        ftp://ftp.archlinux.org/other/kernel26/${_patchname}.bz2
        http://downloads.sourceforge.net/project/l7-filter/l7-filter%20kernel%20version/${_l7patchsetver}/${_l7patchsetname}-v${_l7patchsetver}.tar.gz
        # the main kernel config files
        config config.x86_64
        # standard config files for mkinitcpio ramdisk
        kernel26.preset)
md5sums=('260551284ac224c3a43c4adac7df4879'
         'c7f79503ea903b7d8f659c88badd00cb'
         '98dff8a3d5a31885b73341633f69501f'
         'c114c5d89622a93165bb948d62d966b5'
         '5c91374d56f115ba4324978d5b002711'
         '25584700a0a679542929c4bed31433b6')

build() {
  cd ${srcdir}/linux-$_basekernel
  # Add -ARCH patches
  # See http://projects.archlinux.org/linux-2.6-ARCH.git/
  patch -Np1 -i ${srcdir}/${_patchname} || return 1

  if [ "$CARCH" = "x86_64" ]; then
    cat ../config.x86_64 >./config
  else
    cat ../config >./config
  fi
  if [ "${_kernelname}" != "" ]; then
    sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./config
  fi

  # Add l7-filter kernel patch
  patch -Np1 -i ${srcdir}/${_l7patchsetname}-v${_l7patchsetver}/${_l7kernelpatchname}-${_l7kernelpatchver}.patch || return 1


  # get kernel version  
  make prepare
  mv config .config
  # load configuration
  # Configure the kernel. Replace the line below with one of your choice.
  #make menuconfig # CLI menu for configuration
  #make xconfig # X-based configuration
  #make oldconfig # using old config from previous kernel version
  # ... or manually edit .config
  ####################
  # stop here
  # this is useful to configure the kernel
  #msg "Stopping build"
  #return 1
  ####################
  yes "" | make config
  # build!
  make bzImage modules || return 1
  pkgdesc="The included firmware files of kernel26-l7"
  groups=('base')
  provides=('kernel26-firmware')

  cd ${srcdir}/linux-$_basekernel
  make firmware || return 1
  make INSTALL_MOD_PATH=${pkgdir} firmware_install || return 1
}


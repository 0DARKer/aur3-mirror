# Maintainer: Seb <sebcactus at gmail dot com>

pkgname=emgucv
pkgver=2.4.0
pkgrel=2
pkgdesc="Emgu CV is a cross platform .Net wrapper to the OpenCV image processing library"
arch=('x86_64')
url="http://www.emgu.com/"
license=('GPL' 'BSD')
conflicts=('opencv')
provides=('opencv=2.4.0')
depends=('mono' 'libgeotiff' 'gstreamer0.10-base' 'gtk2' 'jasper' 'libdc1394' 'openexr' 'v4l-utils' 'xine-lib')
optdepends=('eigen3' 'python2-numpy')
makedepends=('subversion' 'cmake')
source=()

_svnroot=https://emgucv.svn.sourceforge.net/svnroot/emgucv/tags
_svnmod=REL_$(echo $pkgver | sed 's|\.|_|g')
_cmakeopts=('-D CMAKE_BUILD_TYPE=Release'
						'-D CMAKE_INSTALL_PREFIX=/usr'
						'-D CMAKE_SKIP_RPATH=ON'
						'-D ENABLE_SSE3=OFF'
						'-D BUILD_PERF_TESTS=OFF'
						'-D BUILD_TESTS=OFF'
						'-D BUILD_DOCS=OFF'
						'-D WITH_TBB=ON'
						'-D WITH_CUDA=OFF'
						'-DEMGU_CV_EXAMPLE_BUILD=OFF')


build() {
  cd "$srcdir"
	[ $CARCH = x86_64 ] && \
	  _cmakeopts=${_cmakeopts[@]/ENABLE_SSE3=OFF/ENABLE_SSE3=ON}
	svn co $_svnroot/$_svnmod $pkgname-$pkgver
	cd $pkgname-$pkgver
  cmake ${_cmakeopts[@]} .
	make
}

package() {
  cd "$srcdir/$pkgname-$pkgver"
  make DESTDIR="$pkgdir" install
  # Fixes xml file
	_newpath="/usr/lib/cli/$pkgname-${pkgver:0:3}"
  for file in "${pkgdir}${_newpath}/*.xml"; do
		sed -i "s|$srcdir/$pkgname-$pkgver/bin|${_newpath}|g" $file;
  done
#	mv "$pkgdir/usr/share/"{OpenCV,opencv};
	install -Dm644 "$srcdir/$pkgname-$pkgver/opencv/doc/license.txt" \
	  "$pkgdir/usr/share/licenses/opencv/LICENSE"
}

--- mpd-van/src/decode.c	2008-08-30 14:00:38.000000000 +0400
+++ mpd-patched/src/decode.c	2008-08-30 14:37:31.000000000 +0400
@@ -473,6 +473,11 @@
 		dc->stop = 0;
 		dc->state = DECODE_STATE_STOP;
 	}
+	
+if(dc->rangems > 0 && dc->forcestop==1){
+				dc->forcestop = 0;
+				kill(getppid(), SIGUSR1);
+			}
 
 	free(path);
 }
@@ -610,7 +615,8 @@
 			       &currentChunkSent, &currentMetadataChunk);
 		if (dc->state == DECODE_STATE_STOP &&
 		    pc->queueState == PLAYER_QUEUE_FULL &&
-		    pc->queueLockState == PLAYER_QUEUE_UNLOCKED) {
+		    pc->queueLockState == PLAYER_QUEUE_UNLOCKED &&
+		    pc->elapsedTime >= pc->totalTime) {
 			next = cb->end;
 			dc->start = 1;
 			pc->queueState = PLAYER_QUEUE_DECODE;
@@ -685,13 +691,14 @@
             {
                 pc->elapsedTime -= dc->startms/1000.f;
                 pc->totalTime = pc->fileTime = dc->rangems/1000.f;
-#if 0
-                if(cb->times[cb->begin] > dc->stopms )
-                    dc->state = DECODE_STATE_STOP;
-#endif
+                //if(pc->elapsedTime + dc->startms/1000.f >= dc->stopms/1000.f)
+                if(cb->times[cb->begin] >= dc->stopms/1000.f){
+                	dc->forcestop=1;
+					stopDecode(dc);
+            	}
             }
-            if(dc->rangems > 0 && dc->stopms >= cb->times[cb->begin] )
-                ;
+                 
+            
 			pc->bitRate = cb->bitRate[cb->begin];
 			pcm_volumeChange(cb->chunks + cb->begin *
 					 CHUNK_SIZE,
--- mpd-van/src/decode.h	2008-08-30 14:00:38.000000000 +0400
+++ mpd-patched/src/decode.h	2008-08-30 14:36:19.000000000 +0400
@@ -53,6 +53,7 @@
     volatile int stopms;
     volatile int startms;
     volatile int rangems;
+    volatile int forcestop;
 	volatile mpd_sint8 start;
 	volatile mpd_uint16 error;
 	volatile mpd_sint8 seek;
--- mpd-van/src/outputBuffer.c	2008-08-30 14:00:38.000000000 +0400
+++ mpd-patched/src/outputBuffer.c	2008-08-30 14:45:59.000000000 +0400
@@ -132,10 +132,10 @@
 			cb->bitRate[currentChunk] = bitRate;
 			cb->times[currentChunk] = time;
 
-            if(dc->rangems > 0 ) {
+           /* if(dc->rangems > 0 ) {
                 if( time >= (dc->stopms/1000.f) )
                     dc->stop = 1;
-            }
+            }*/
 
 		}
 

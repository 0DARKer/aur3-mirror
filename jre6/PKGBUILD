# Maintainer: Thomas Dziedzic < gostrc at gmail >
# Contributor: Geoffroy Carrier <geoffroy.carrier@aur.archlinux.org>
# Contributor: Jason Chu <jason@archlinux.org>
# Contributor: Daniel J Griffiths <ghost1227@archlinux.us>
# Contributor: Guillaume ALAUX <Guillaume at alaux dot net>

pkgname=jre6
pkgver=6u27
pkgrel=1
pkgdesc="Sun/Oracle's implementation of tha Java 6 specification"
arch=('i686' 'x86_64')
  [ "${CARCH}" = 'i686' ]   && _arch=i586
  [ "${CARCH}" = 'x86_64' ] && _arch=x64
url='http://java.sun.com'
license=('custom')
source=("http://download.oracle.com/otn-pub/java/jdk/${pkgver}-b07/jdk-${pkgver}-linux-${_arch}.bin"
        'construct.sh::http://java.net/projects/jdk-distros/sources/svn/content/trunk/utils/construct.sh?raw=true'
        'jre.profile'
        'jre.profile.csh'
        'javaws-launcher')

[ "${CARCH}" = 'i686' ] && md5sums=('bdb5f05bd20c6aa9a4729726191bf6fd')
[ "${CARCH}" = 'x86_64' ] && md5sums=('94f93a3ff03f824a238ecd79ad90433e')
md5sums+=('94065b612df0046d9ae758943f9f6a75'
         '7cd3dc10e7a37468cad4053a067dcd01'
         'cc90df2df6fe80fab885a80036d420a1'
         '45c15a6b4767288f2f745598455ea2bf')

build() {
  mkdir unbundle-jdk
  cd unbundle-jdk
  sh ../jdk-${pkgver}-linux-$_arch.bin --accept-license
  cd ..
  sh construct.sh unbundle-jdk linux-jdk linux-jre
}

package() {
  pkgdesc="Oracle's Java Runtime Environment"
  depends=('glibc' 'libxtst')
  provides=('j2re' 'java-runtime=6')
  conflicts=('j2re' 'java-runtime' 'jre')
  replaces=('j2re')
  install='jre.install'

  # main files
  mkdir -p ${pkgdir}/opt/java
  cp -R linux-jdk/jre ${pkgdir}/opt/java

  # profiles
  install -D ${srcdir}/jre.profile \
    ${pkgdir}/etc/profile.d/jre.sh
  install -D ${srcdir}/jre.profile.csh \
    ${pkgdir}/etc/profile.d/jre.csh

  mkdir -p ${pkgdir}/usr/lib/mozilla/plugins

  if [ "$CARCH" = "i686" ]; then
    ln -s /opt/java/jre/lib/i386/libnpjp2.so ${pkgdir}/usr/lib/mozilla/plugins
  else ln -s /opt/java/jre/lib/amd64/libnpjp2.so ${pkgdir}/usr/lib/mozilla/plugins
  fi

  # licenses
  install -d ${pkgdir}/usr/share/licenses/jre
  install -m644 ${pkgdir}/opt/java/jre/COPYRIGHT \
    ${pkgdir}/usr/share/licenses/jre
  install -m644 ${pkgdir}/opt/java/jre/LICENSE \
    ${pkgdir}/usr/share/licenses/jre
  install -m644 ${pkgdir}/opt/java/jre/THIRDPARTYLICENSEREADME.txt \
    ${pkgdir}/usr/share/licenses/jre

  # Fix system prefs folder (FS#18872)
  install -d ${pkgdir}/etc/.java/.systemPrefs

  # Fix FS#22509 - [jre] Clicking a .jnlp file does not launch that file but launch javaws -viewer instead 
  install ${srcdir}/javaws-launcher \
    ${pkgdir}/opt/java/jre/bin
}

# Maintainer: Marti Raudsepp <marti@juffo.org>

pkgname=tcpcrypt-git
pkgver=20121212
pkgrel=1
pkgdesc="Transparent user space implementation for the tcpcrypt TCP extensions"
arch=(i686 x86_64)
url="http://tcpcrypt.org/"
license=('BSD')
depends=('libnetfilter_queue' 'openssl' 'iptables')
makedepends=('git')
provides=('tcpcrypt')
conflicts=('tcpcrypt')
install=tcpcrypt.install
backup=(etc/conf.d/tcpcryptd.conf)
source=('tcpcryptd.rc' 'tcpcryptd.conf' 'tcpcryptd.service' 'fix_automake.patch')
sha256sums=('1bb5c3b2192bf7b105172cb505f13c19f659c672f7148c1a015883329cbc0ea4'
            'a41bfa7b0c8f527f96c993f68e0a02265ad672fe6c2e10f41bc00b8b1f819305'
            '68a3227f971dce0056bbe8768b570fade4ee8b17aca2e354c35352f2bf0a7028'
            '86629356c9905b861fe1c8b62a75016eba5372c74e49ddbfad70772d4e90c292')

_gitroot="git://github.com/sorbo/tcpcrypt.git"
_gitname="tcpcrypt"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"

  patch -Np1 -i ../../fix_automake.patch

  install -Dm644 LICENSE $pkgdir/usr/share/licenses/$pkgname/LICENSE
  cd user

  ./configure --prefix=/usr
  make
  make DESTDIR=$pkgdir install

  install -Dm755 $srcdir/tcpcryptd.rc $pkgdir/etc/rc.d/tcpcryptd
  install -Dm644 $srcdir/tcpcryptd.conf $pkgdir/etc/conf.d/tcpcryptd.conf
  install -Dm644 $srcdir/tcpcryptd.service $pkgdir/usr/lib/systemd/system/tcpcryptd.service
}

# Maintainer: Thomas Marchsteiner <tommy[0x2e]m86[0x40]gmail[0x2e]com>
pkgname=scirius-git
_pkgname=scirius
pkgver=20150208
pkgrel=2
pkgdesc="a Django Application for Suricata IDS/IPS Rule Management"
arch=('any')
url="https://www.stamus-networks.com/"
license=('GPL3')
depends=('python2-django' 'python2-django-tables2' 'python2-django-bootstrap3' 'python2-south' 'python2-gitpython'
                'python2-pyinotify' 'python2-daemon' 'python2-pygments' 'python2-requests' 'python2-psutil'
                'python2-django-revproxy' 'python2-pytz' 'python2-lxml' )
optdepends=('elasticsearch: Display rule activity'
                        'kibana: Links Kibana Dashboards in scirius'
                        'nginx: a reversy proxy for the django app'
                        'python2-flup: fcgi support'
                         )
makedepends=('git')
install='scirius-git.install'
backup=('usr/share/webapps/scirius/db.sqlite3'
                'usr/share/webapps/scirius/scirius/settings.py')
conflicts=('scirius')
provides=('scirius')
options=(emptydirs)
source=('git+https://github.com/StamusNetworks/scirius.git' 'scirius-fcgi.service' 'scirius.service' 'nginx.example.conf' 'scirius-git.install')
md5sums=('SKIP'
                    '11004acf4ae17b950057b056ced73182'
                    'bd13da75f521e5968c0d7767c5e5f16f'
                    'c25edb72a450176f0bbd2b5122995817'
                    '2fc1ac98a3e078e2a847d34a837f16b2')
pkgver() {
  cd "$SRCDEST/libvirt"
  git describe --always | sed 's|-|.|g' | sed 's/^.//'
}

package() {
        
        cd ${srcdir}/${_pkgname}
        mkdir -p ${pkgdir}/usr/share/webapps/${_pkgname}/static
        cp -Rp ${srcdir}/${_pkgname}/* ${pkgdir}/usr/share/webapps/scirius
        cd ${pkgdir}/usr/share/webapps/${_pkgname}
        python2 manage.py syncdb --noinput
        
        sed -i "s/#\!\/usr\/bin\/python/#\!\/usr\/bin\/python2/" ${pkgdir}/usr/share/webapps/$_pkgname/suricata/scripts/suri_reloader
        sed -i "s/#\!\/usr\/bin\/env\ python/#\!\/usr\/bin\/python2/" ${pkgdir}/usr/share/webapps/$_pkgname/manage.py
        
        chmod 660 ${pkgdir}/usr/share/webapps/$_pkgname/db.sqlite3
        
        install -d ${pkgdir}/etc/suricata/rules/rules
        install -d ${pkgdir}/run/scirius
        install -d ${pkgdir}/usr/share/doc/$_pkgname
        install -d ${pkgdir}/usr/share/licenses/$_pkgname
        
        install -Dm644 ${startdir}/scirius-fcgi.service ${pkgdir}/usr/lib/systemd/system/scirius-fcgi.service
        install -Dm644 ${startdir}/scirius.service ${pkgdir}/usr/lib/systemd/system/scirius.service
        install -Dm755 ${pkgdir}/usr/share/webapps/$_pkgname/suricata/scripts/suri_reloader ${pkgdir}/usr/bin/suri_reloader      
        install -Dm644 ${pkgdir}/usr/share/webapps/$_pkgname/README.rst ${pkgdir}/usr/share/doc/$_pkgname/README.rst
        install -Dm644 ${pkgdir}/usr/share/webapps/$_pkgname/LICENSE ${pkgdir}/usr/share/licenses/$_pkgname/LICENSE
        install -Dm644 ${startdir}/nginx.example.conf ${pkgdir}/usr/share/doc${_pkgname}/nginx.example.conf
        
}

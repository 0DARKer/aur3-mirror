
# Maintainer: M0Rf30 < morf3089 at gmail dot com >

pkgname=kdeplasma-addons-applets-veromix-git
pkgver=20120606
pkgrel=1
pkgdesc="A plasmoid mixer for the Pulseaudio sound server"
url="http://code.google.com/p/veromix-plasmoid/"
license=('GPL3')
arch=('i686' 'x86_64')
depends=('kdebindings-python' 'kdebase-workspace' 'python2-qt' 'pulseaudio' 'pyxdg' 'dbus-python' 'pygi' 'python')
conflicts=('kdeplasma-addons-applets-veromix' 'kdeplasma-addons-applets-veromix-svn')
makedepends=('git' 'kdesdk-scripts')
optdepends=('pulseaudio-equalizer'
            'swh-plugins: equalizer and other effects support')
_gitroot="https://code.google.com/p/veromix-plasmoid/"
_gitname="veromix-plasmoid"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone -l "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
	make
        # For KDE
        install -dm755 ${pkgdir}/usr/share/apps/plasma/plasmoids/veromix-plasmoid || return 1
	cp -R plasma/{contents,metadata.desktop} ${pkgdir}/usr/share/apps/plasma/plasmoids/veromix-plasmoid || return 1
	install -Dm644 plasma/metadata.desktop ${pkgdir}/usr/share/kde4/services/plasma-applet-veromix-plasmoid.desktop || return 1
        # Common elements and Gnome
        install -dm755 ${pkgdir}/usr/share/veromix/ || return 1
        cp -R {common,dbus-service,gtk,data} ${pkgdir}/usr/share/veromix
	mv ${$pkgdir}/usr/share/veromix/data/dbus-1 ${$pkgdir}/usr/share/
	
	# fix for python
	sed -i -e '1 s/python/python2/' ${pkgdir}/usr/share/apps/plasma/plasmoids/veromix-plasmoid/dbus-service/VeromixServiceMain.py

	# Generating bytecode
	python3 . -m compileall
	python2 . -m compileall
}

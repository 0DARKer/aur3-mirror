# Maintainer: Brad Arrington <bradla8@yahoo.com>

pkgbase=mariadb
pkgname=('mariadb')
pkgver=5.3.1
pkgrel=1
arch=('i686' 'x86_64')
license=('GPL')
url="http://www.mariadb.org/"
makedepends=('zlib' 'perl' 'openssl' 'libtool' 'patch')
options=('!strip' '!libtool')
install=mariadb.install
conflicts=('mysql' 'libmysqlclient' 'mysql-clients')
source=("http://mirror.layerjet.com/mariadb/${pkgbase}-${pkgver}-beta/kvm-tarbake-jaunty-x86/${pkgbase}-${pkgver}-beta.tar.gz"
        'my.cnf'
        'mariadbd'
	'mariadb_install_db')

md5sums=('5b3a94de1c1fcaa193edbbc8d7f8ffe4'
         '372e35c8e655e96c43a4a6aa452efd92'
         '4c491570ec9f2db20b080082119a1714'
         '748fe56c33f26e33a6319a55e0786dbf')

build() {
#  mv ${srcdir}/mariadb ${srcdir}/mariadb-5.3.0-beta.tar.gz
  cd "${srcdir}/${pkgbase}-${pkgver}-beta"

# CFLAGS/CXXFLAGS as suggested upstream
  CFLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing" \
  CXXFLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -felide-constructors -fno-rtti" \

  mkdir -p "${pkgdir}/etc/mariadb"
  ./configure --prefix=/usr \
    --datadir=/var/lib/mariadb \
    --sysconfdir=/etc/mariadb \
    --without-docs \
    --without-readline \
    --with-ssl \
    --with-charset=utf8 \
    --with-collation=utf8_unicode_ci \
    --with-extra-charsets=complex \
    --localstatedir=/var \
    --with-unix-socket-path=/var/run/mariadb/mariadb.sock \
    --with-plugins=partition,pbxt,ibmdb2i,aria

  make 
}

package_mariadb(){
  pkgdesc="A fast SQL database server branch of MySQL - MariaDB"
  backup=('etc/mariadb/my.cnf')
  install=mariadb.install

  cd "${srcdir}/${pkgbase}-${pkgver}-beta"
  mkdir -p ${pkgdir}/usr/bin/
  make DESTDIR=${pkgdir} install

  cp -Rd ${pkgdir}/var/lib/mariadb/*  ${pkgdir}/usr/share/.
  install -Dm644 ${srcdir}/my.cnf ${pkgdir}/etc/mariadb/my.cnf
  install -Dm755 ${srcdir}/mariadbd ${pkgdir}/etc/rc.d/mariadbd

  install -m755 ${srcdir}/mariadb_install_db "${pkgdir}/usr/bin/"
}

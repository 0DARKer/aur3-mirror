# Maintainer: Brad Arrington <bradla8@yahoo.com>

pkgbase=mariadb
pkgname=('mariadb')
pkgver=5.3.0
pkgrel=1
arch=('i686' 'x86_64')
license=('GPL')
url="http://www.mariadb.org/"
makedepends=('tcp_wrappers' 'zlib' 'perl' 'openssl' 'libtool' 'patch')
options=('!strip' '!libtool')
install=mariadb.install
#source=("http://downloads.askmonty.org/f/${pkgbase}-${pkgver}-beta/kvm-tarbake-jaunty-x86/${pkgbase}-${pkgver}-beta.tar.gz"
source=("http://downloads.askmonty.org/f/${pkgbase}-${pkgver}-beta/kvm-tarbake-jaunty-x86/${pkgbase}-${pkgver}-beta.tar.gz/from/http://mirror.layerjet.com/mariadb"
        'my.cnf'
        'mariadbd'
	'mysql_install_db')

md5sums=('fc998d2aa51b1ea54ea6e7bdb9f35080'
         '372e35c8e655e96c43a4a6aa452efd92'
         '468cd51ddf86fd2d77e91604fc4ac197'
         '7b26caa1c50a37642408b68b505b73c9')

build() {
  mv ${srcdir}/mariadb ${srcdir}/mariadb-5.3.0-beta.tar.gz
  cd "${srcdir}/${pkgbase}-${pkgver}-beta"

# CFLAGS/CXXFLAGS as suggested upstream
  CFLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing" \
  CXXFLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -felide-constructors -fno-rtti" \

  mkdir -p "${pkgdir}/etc/mariadb"
  ./configure --prefix=/opt/mariadb \
    --datadir=/var/lib/mariadb \
    --sysconfdir=/etc/mariadb \
    --without-docs \
    --without-readline \
    --with-ssl \
    --with-libwrap \
    --with-charset=utf8 \
    --with-collation=utf8_general_ci \
    --with-extra-charsets=complex \
    --localstatedir=/var \
    --with-unix-socket-path=/var/run/mariadb/mariadb.sock \
    --with-plugins=partition,pbxt,ibmdb2i,aria

  make 
}

package_mariadb(){
  pkgdesc="A fast SQL database server branch of MySQL - MariaDB"
  backup=('etc/mariadb/my.cnf')
  install=mariadb.install

  cd "${srcdir}/${pkgbase}-${pkgver}-beta"
  mkdir -p ${pkgdir}/opt/mariadb/bin/
  make DESTDIR=${pkgdir} install

  cp -Rd ${pkgdir}/var/lib/mariadb/*  ${pkgdir}/opt/mariadb/share/.
  install -Dm644 ${srcdir}/my.cnf ${pkgdir}/etc/mariadb/my.cnf
  install -Dm755 ${srcdir}/mariadbd ${pkgdir}/etc/rc.d/mariadbd

  install -m755 ${srcdir}/mysql_install_db "${pkgdir}/opt/mariadb/bin/"
}

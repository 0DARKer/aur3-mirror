# Maintainer: Brad Arrington <bradla8@yahoo.com>

pkgbase=mariadb
pkgname=('mariadb')
pkgver=5.2.7
pkgrel=1
arch=('i686' 'x86_64')
license=('GPL')
url="http://www.mariadb.org/"
makedepends=('tcp_wrappers' 'zlib' 'perl' 'openssl' 'libtool' 'patch')
options=('!strip' '!libtool')
install=mariadb.install
source=("http://downloads.askmonty.org/f/mariadb-5.2.7/kvm-tarbake-jaunty-x86/mariadb-5.2.7.tar.gz/from/http://mirror.layerjet.com/mariadb"
        'my.cnf'
        'mariadbd'
	'mysql_install_db')
md5sums=('06b9b102946a3606b38348c0ebf18367'
         '372e35c8e655e96c43a4a6aa452efd92'
         '468cd51ddf86fd2d77e91604fc4ac197'
         '7b26caa1c50a37642408b68b505b73c9')

build() {
  cd "${srcdir}/${pkgbase}-${pkgver}"
  # patch -p1 < "${srcdir}/skip-mysql_install_db.patch"

# CFLAGS/CXXFLAGS as suggested upstream
  CFLAGS="-fPIC ${CFLAGS} -fno-strict-aliasing" \
  CXXFLAGS="-fPIC ${CXXFLAGS} -fno-strict-aliasing -felide-constructors -fno-rtti" \

  mkdir -p "${pkgdir}/etc/mariadb"
  ./configure --prefix=/opt/mariadb \
    --datadir=/var/lib/mariadb \
    --sysconfdir=/etc/mariadb \
    --without-docs \
    --without-readline \
    --with-ssl \
    --with-libwrap \
    --with-charset=utf8 \
    --with-collation=utf8_general_ci \
    --with-extra-charsets=complex \
    --localstatedir=/var \
    --with-unix-socket-path=/var/run/mariadb/mariadb.sock \
    --with-plugins=partition,pbxt,ibmdb2i,aria

  make 
}

package_mariadb(){
  pkgdesc="A fast SQL database server branch of MySQL - MariaDB"
  backup=('etc/mariadb/my.cnf')
  install=mariadb.install

  cd "${srcdir}/${pkgbase}-${pkgver}"
  mkdir -p ${pkgdir}/opt/mariadb/bin/
  make DESTDIR=${pkgdir} install

  cp -Rd ${pkgdir}/var/lib/mariadb/*  ${pkgdir}/opt/mariadb/share/.
  install -Dm644 ${srcdir}/my.cnf ${pkgdir}/etc/mariadb/my.cnf
  install -Dm755 ${srcdir}/mariadbd ${pkgdir}/etc/rc.d/mariadbd

  install -m755 ${srcdir}/mysql_install_db "${pkgdir}/opt/mariadb/bin/"
}

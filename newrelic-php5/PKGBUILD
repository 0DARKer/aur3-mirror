# Maintainer: Vinh Nguyen <kurei [at] axcoto.com>
pkgname=newrelic-php5
pkgver=4.4.5.35
pkgrel=5
pkgdesc="NewRelic PHP"
arch=('i686' 'x86_64')
url="http://newrelic.com/"
license=('non-free')
depends=(glibc php)
makedepends=(binutils)
checkdepends=()
optdepends=()
backup=('etc/php/conf.d/newrelic.ini.template')
install=.install

#source=("$pkgname"-"$pkgver"-"linux.tar.gz"
source=("https://download.newrelic.com/php_agent/release/$pkgname"-"$pkgver"-"linux.tar.gz"
"newrelic-daemon.service"
".install")

md5sums=('d1cf7e2b032d1e75e9928561211da2b0'
         '4fc78347663adcb32ed28eddb546619c'
         '7ab54f6d6e80ff7e670ce79a36c62c4c')
build() {
  cd "$srcdir/$pkgname-$pkgver-linux"
}

package() {
  cd "$srcdir/$pkgname-$pkgver-linux" 

  mkdir -p $pkgdir/usr/bin/ \
            $pkgdir/usr/lib/php/modules/ \
            $pkgdir/usr/share/doc/newrelic-php5/ \
            $pkgdir/usr/lib/systemd/system/ \
            $pkgdir/etc/php/conf.d/;

  if [ $CARCH == i686 ]; then
    # Binary Daemon
    install -v -Dm755 ./daemon/newrelic-daemon.x86 $pkgdir/usr/bin/newrelic-daemon
    # PHP extension
    install -v -Dm755 ./agent/x86/newrelic-20121212-zts.so $pkgdir/usr/lib/php/modules/newrelic-20121212-zts.so
    install -v -Dm755 ./agent/x86/newrelic-20121212.so $pkgdir/usr/lib/php/modules/newrelic-20121212.so
  else
    # Binary Daemon
    install -v -Dm755 ./daemon/newrelic-daemon.x64 $pkgdir/usr/bin/newrelic-daemon
    # PHP extension
    install -v -Dm755 ./agent/x64/newrelic-20121212-zts.so $pkgdir/usr/lib/php/modules/newrelic-20121212-zts.so
    install -v -Dm755 ./agent/x64/newrelic-20121212.so $pkgdir/usr/lib/php/modules/newrelic-20121212.so
  fi

  install -v -Dm644 ./README ./LICENSE $pkgdir/usr/share/doc/newrelic-php5/
  
  install -v -Dm644 ./scripts/newrelic.ini.template $pkgdir/etc/php/conf.d/newrelic.ini
  install -v -Dm644 ./scripts/newrelic.ini.template $pkgdir/etc/php/conf.d/newrelic.ini.template
  
  install -v -Dm644 ../newrelic-daemon.service $pkgdir/usr/lib/systemd/system/
}

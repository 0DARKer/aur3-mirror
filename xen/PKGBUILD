pkgname=xen
pkgver=4.1.0
pkgrel=1
pkgdesc="Xen 4 (hypervisor tools and doc)"
arch=(i686 x86_64)
url="http://xen.org/"
license="GPL"
depends=('xz-utils' 'bzip2' 'transfig'  'texlive-core' 'iproute' 'bridge-utils' 'python2' 'sdl' 'zlib' 'e2fsprogs' 
'pyxml'
'bin86' 
'pkgconfig' 
'iasl' 
'gnutls' 'glibc')
[ "$CARCH" == "x86_64" ] && depends=('xz-utils' 'bzip2' 'transfig' 'texlive-core' 'iproute' 'bridge-utils' 'python2' 'sdl' 'zlib' 'e2fsprogs' 
'pyxml'
'bin86' 
'pkgconfig' 
'iasl' 
'gnutls' 'lib32-glibc')
makedepends=('dev86')
conflicts=('xen4' 'xen3' 'xen-hv-tools' 'libxen4')
provides=('xen')
backup=('etc/xen/xend-config.sxp' 'etc/xen/xend-pci-permissive.sxp' 'etc/xen/xend-pci-quirks.sxp')
options=(!strip)
source=(http://bits.xensource.com/oss-xen/release/${pkgver}/xen-${pkgver}.tar.gz
	09_xen
	xen.patch)
md5sums=('db3e1542b7719f375593b2b32b01a177'
	 '2a337b50f11711761f9fe1aa9f82dd15'
	 '87607885d950a545f735dcf967bea569') 

build() {
  

  cd $srcdir/xen-${pkgver}
        
        patch -p1 -i ../xen.patch
  

 	
unset CFLAGS LDFLAGS

make PYTHON=python2 DESTDIR=$pkgdir  install-xen
make PYTHON=python2 DESTDIR=$pkgdir  install-tools
make PYTHON=python2 DESTDIR=$pkgdir  install-docs
  
  sed -i 's#XENDOM_CONFIG=/etc/sysconfig/xendomains#XENDOM_CONFIG=/etc/conf.d/xendomains#' $pkgdir/etc/init.d/xendomains
  sed -i "s#touch /var/lock/subsys/xend#mkdir -p /var/lock/subsys\n	touch /var/lock/subsys/xend#" $pkgdir/etc/init.d/xend

  [ -d $pkgdir/usr/lib64 ] && ( cd $pkgdir/usr && cp -R lib64/* lib/ && rm -R lib64 )
  ( cd $pkgdir/etc && mv init.d rc.d ) || return 1
  rm -f $pkgdir/usr/share/man/man1/qemu-img.1* \
       $pkgdir/usr/share/man/man1/qemu.1*
  # First experiment to generate grub2.cfg entry
  mkdir -p $pkgdir/etc/grub.d
  cp $srcdir/09_xen  $pkgdir/etc/grub.d
  
}

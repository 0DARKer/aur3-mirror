diff --git a/dlls/winedib.drv/dibdrvbitmap.c b/dlls/winedib.drv/dibdrvbitmap.c
index 1b2c959..cfe6892 100644
--- a/dlls/winedib.drv/dibdrvbitmap.c
+++ b/dlls/winedib.drv/dibdrvbitmap.c
@@ -181,6 +181,7 @@ BOOL _DIBDRVBITMAP_InitFromBMIH(DIBDRVBITMAP *dib, const BITMAPINFOHEADER *bi, c
                      const RGBQUAD *colorTable, void *bits)
 {
     MAYBE(TRACE("dib=%p, bi=%p, bit_fields=%p, colorTable=%p, bits=%p\n", dib, bi, bit_fields, colorTable, bits));
+    MAYBE(TRACE("bit_fields=(%x,%x,%x)\n", (unsigned) bit_fields[0], (unsigned) bit_fields[1], (unsigned) bit_fields[2]));
     
     /* initializes DIB dimensions and color depth */
     dib->bitCount = bi->biBitCount;
@@ -364,17 +365,23 @@ BOOL _DIBDRVBITMAP_InitFromBitmapinfo(DIBDRVBITMAP *dib, const BITMAPINFO *bmi,
     ptr = (BYTE*)bmi + bmi->bmiHeader.biSize;
     num_colors = bi->biClrUsed;
     
-    MAYBE(TRACE("dib=%p, bmi=%p\n", dib, bmi));
+    MAYBE(TRACE("dib=%p, bmi=%p, ptr=%p, bmiColors=%p\n", dib, bmi, ptr, &bmi->bmiColors));
 
     if(bi->biCompression == BI_BITFIELDS)
     {
-        masks = (DWORD *)ptr;
-        ptr += 3 * sizeof(DWORD);
+	/* See the comments at the beginning of gdi32/dib.c */
+        masks = (DWORD *)bmi->bmiColors;
+        if (masks[0] == 0 || masks[1] == 0 || masks[2] == 0) {
+            WARN("mask is zero; assuming default\n");
+            masks = NULL;
+        }
+    }
+    if (masks == NULL) {
+        if(bi->biBitCount == 32)
+            masks = bit_fields_DIB32_RGB;
+        else if(bi->biBitCount == 16)
+            masks = bit_fields_DIB16_RGB;
     }
-    else if(bi->biBitCount == 32)
-        masks = bit_fields_DIB32_RGB;
-    else if(bi->biBitCount == 16)
-        masks = bit_fields_DIB16_RGB;
 
     if(!num_colors && bi->biBitCount <= 8)
         num_colors = 1 << bi->biBitCount;
# Contributer: N30N <archlinux@alunamation.com>

pkgname=topmod-svn
pkgver=243
pkgrel=1
pkgdesc='TopMod is a topological mesh modeling system that allows users to create high genus 2-manifold meshes'
url='http://topmod3d.org'
license=('GPL')
arch=('i686' 'x86_64')
depends=('qt>=4.3' 'python')
makedepends=('subversion')
source=('topmod.sh' 'topmod.desktop' '64bit.patch')
md5sums=('c8aef06e02f0f244b6f451a703c97235' 'bffc574730f7dd3df567eb7e690277c5' '0f9a1b63815ee3efbf960617ebf8044f')

_svntrunk="http://topmod.googlecode.com/svn/trunk"
_svnmod="topmodx"

build() {
	cd ${startdir}/src

	msg "Connecting to topmod SVN server......."
	if [ -d ${_svnmod}/.svn ]; then
		(cd ${_svnmod} && svn update -r ${pkgver})
	else
		svn co ${_svntrunk}/${_svnmod} --config-dir ./ -r ${pkgver}
	fi

	if [ -e ${_svnmod}-build ]; then
		rm -rf ${_svnmod}-build
	fi
	cp -r ${_svnmod} ${_svnmod}-build
	cd ${_svnmod}-build

	if [ ${CARCH} == "x86_64" ]; then
		patch -p1 < ../64bit.patch
	fi

	# change path to videos
	sed -i "s/fromLocalFile(\"video/fromLocalFile(\"\/usr\/share\/topmod\/video/" MainWindow.cc

	# update python version
	sed -i "s/2\.5/2\.6/g" topmod.pro

	msg "Starting build process."
	cd include
	qmake && make || return 1

	cd pydlfl || return 1
	make
	python dlfl_setup.py install --root=${startdir}/pkg || return 1

	cd ../../
	lupdate topmod.pro
	lrelease topmod.pro

	# use a transparent image for the missing colour fill icon
	# cp images/{doosabin_extrude.png,color-fill.png}

	qmake && make || return 1

	install -D -m755 TopMod ${startdir}/pkg/usr/share/topmod/TopMod
	install -D -m644 images/topmod.png ${startdir}/pkg/usr/share/pixmaps/topmod.png
	install -D -m755 ${startdir}/{src/topmod.sh,pkg/usr/bin/topmod}
	install -D -m644 ${startdir}/{src/topmod.desktop,pkg/usr/share/applications/topmod.desktop}
	cp -r video ${startdir}/pkg/usr/share/topmod/video
}

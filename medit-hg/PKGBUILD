# Contributor: Alexander 'hatred' Drozdoff <adrozdoff@gmail.com>

pkgname=medit-hg
_date=$(date +%Y%m%d)
pkgver=${_date}
#pkgver=4098
pkgrel=1
pkgdesc="A GTK text editor"
arch=('i686' 'x86_64')
url="http://medit.bitbucket.org"
options=('!emptydirs')
license=('GPL')
depends=('pygtk' 'libxml2' 'pcre' 'libsm' 'python2' 'gtk2' 'gcc-libs' 'hicolor-icon-theme')
makedepends=('pkgconfig'
             'perlxml'
             'intltool'
             'gcc-objc'
             'mercurial'
             'txt2tags')
install=medit.install
source=()
conflicts=(medit)
provides=(medit)
replaces=(medit)

__hgroot="https://medit@bitbucket.org/medit/medit"
__hgrepo="medit"

build() {
  cd $srcdir

  msg "Connecting to Mercurial server...."

  if [ -d $__hgrepo ] ; then
    cd $__hgrepo
    hg pull -u || return 1
    msg "The local files are updated."
  else
    hg clone $__hgroot $__hgrepo || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$__hgrepo-build"
  cp -r "$srcdir/$__hgrepo" "$srcdir/$__hgrepo-build"
  cd "$srcdir/$__hgrepo-build"

  alias python='python2'
  find . -name '*.py' | xargs sed -i 's|python|python2|'

  # back to autotools
  export PYTHON=python2
  export PYTHON_VERSION=2.7
  export PYTHON_INCLUDES=`python2-config --includes`
  export PYTHON_LIBS=`python2-config --libs`
  
  ./autogen.sh
  ./configure --prefix=/usr --enable-dev-mode
  
  #find . -name Makefile | xargs sed -i 's/PYTHON = python/PYTHON = python2/'
  find . -name Makefile | xargs sed -i 's/-Werror//g'
  
  make
  make DESTDIR=$startdir/pkg install

  rm -rf $startdir/pkg/usr/share/mime && \
  rm -rf $startdir/pkg/usr/share/icons/hicolor/icon-theme.cache
}
md5sums=()

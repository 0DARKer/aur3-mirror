# Contributor: Alexander 'hatred' Drozdoff <adrozdoff@gmail.com>

pkgname=medit-hg
pkgver=$(date +%Y%m%d)
#pkgver=4098
pkgrel=1
pkgdesc="A GTK text editor"
arch=('i686' 'x86_64')
url="http://mooedit.sourceforge.net"
options=('!emptydirs')
license=('GPL')
depends=('pygtk' 'libxml2' 'pcre' 'libsm' 'python2' 'gtk2' 'gcc-libs' 'hicolor-icon-theme')
makedepends=('pkgconfig'
             'perlxml'
             'intltool'
             'gcc-objc'
             'mercurial')
install=medit.install
source=()
conflicts=(medit)
provides=(medit)
replaces=(medit)

__hgroot="http://bitbucket.org/muntyan/moo"
__hgrepo="moo"

build() {
  cd $srcdir

  msg "Connecting to Mercurial server...."

  if [ -d $__hgrepo ] ; then
    cd $__hgrepo
    hg pull -u || return 1
    msg "The local files are updated."
  else
    hg clone $__hgroot $__hgrepo || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$__hgrepo-build"
  cp -r "$srcdir/$__hgrepo" "$srcdir/$__hgrepo-build"
  cd "$srcdir/$__hgrepo-build"

  alias python='python2'
  find . -name '*.py' | xargs sed -i 's|python|python2|'

  # back to autotools
  ./autogen.sh
  ./configure --prefix=/usr
  
  sed -i 's/PYTHON = python/PYTHON = python2/' Makefile
  sed -i 's/PYTHON = python/PYTHON = python2/' moo/Makefile
  
  make
  make DESTDIR=$startdir/pkg install

  rm -rf $startdir/pkg/usr/share/mime && \
  rm -rf $startdir/pkg/usr/share/icons/hicolor/icon-theme.cache
}
md5sums=()

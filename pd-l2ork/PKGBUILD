# Maintainer: <fero dot kiraly at gmail.com>

pkgname=pd-l2ork
pkgver=20130123
pkgrel=1
pkgdesc="pd-l2ork version of PureData"
url="http://l2ork.music.vt.edu/main/?page_id=56"
arch=('i686' 'x86_64' )
license=('BSD')
depends=('libv4l' 'fftw' 'jack' 'tk' 'freeglut' \
  'libquicktime' 'libdv' 'gsl' 'imagemagick' \
  'ftgl' 'libgl' 'dssi' 'hicolor-icon-theme' 'git')
makedepends=('subversion' 'swig' 'automake' 'curl')
conflicts=('pd-l2ork' )
provides=( 'pd-l2ork')
replaces=(pd-l2ork)
backup=()
options=('!makeflags')
source=( )
md5sums=( )



build() {
  unset CFLAGS
  unset LDFLAGS
  unset INCLUDES
 
  #
  #downloading pd-extended----------------------------------------------------------
  #
    msg "Looking for pd2lork on git ..."
    cd $srcdir
    git clone git://github.com/pd-l2ork/pd.git $pkgname
    msg "done"

  #download Gem
    cd $pkgname
    msg "Connecting to GIT server for GEM...."
    git clone git://pd-gem.git.sourceforge.net/gitroot/pd-gem/Gem Gem
 
  #update docs
    msg "looking for docs on svn...."
    cd doc/
    svn checkout https://pure-data.svn.sourceforge.net/svnroot/pure-data/trunk/doc .
  
 
  # 64 bit archutecure----------------------------------------------------------------
    if [ "$CARCH" = "x86_64" ]; then
     FPIC_FLAG="-fPIC"
     else FPIC_FLAG=""
   fi

 	#prepare GEM
	  cd $srcdir/$pkgname/Gem/
	  aclocal
	  ./autogen.sh


  #MAKE --------------------------------------------------------------------------
    cd "$srcdir/$pkgname/packages/linux_make" || return 1
    make BUILDLAYOUT_DIR=$srcdir/$pkgname/packages GEM_EXTRA_CXXFLAGS="$FPIC_FLAG"  DESTDIR=$pkgdir  prefix=/usr/local   install || return 1
  

  msg "Building l2ork-specific externals..."
	# patch_name
	  cd $srcdir/$pkgname/l2ork_addons/patch_name
	  make clean
	  make
  # disis_wiimote
	  cd ../disis_wiimote
	  make clean
	  make
	# disis_netsend
	  cd ../disis_netsend
	  make clean
	  make
	
	# disis_netreceive
	  cd ../disis_netreceive
	  make clean
	  make
	
	# disis_phasor
	  cd ../disis_phasor
	  make clean
	  make
	
	# spectdelay
	  cd ../spectdelay/spectdelay~
	  ./linux-install.sh
	

  
}


package() {
  cd "$srcdir/$pkgname"

#lork addons
  install -d $pkgdir/usr/local/lib/pd-l2ork
  install -d $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/patch_name/patch_name.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/patch_name/patch_name-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra
  
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_wiimote/disis_wiimote.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_wiimote/disis_wiimote-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra

  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_netsend/disis_netsend.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_netsend/disis_netsend-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra

  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_netreceive/disis_netreceive.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_netreceive/disis_netreceive-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra

  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_phasor/disis_phasor~.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/disis_phasor/disis_phasor~-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra

  install -p -m0644 $srcdir/$pkgname/l2ork_addons/spectdelay/spectdelay~/spectdelay~.pd_linux  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/spectdelay/spectdelay~/spectdelay~-help.pd  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/spectdelay/spectdelay~/array2list.pd  $pkgdir/usr/local/lib/pd-l2ork/extra
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/spectdelay/spectdelay~/arrayreset.pd  $pkgdir/usr/local/lib/pd-l2ork/extra

  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/*.*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12

  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12/icons
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/icons/*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12/icons
 
  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12/icons-large
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/icons-large/*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12/icons-large

  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12/objects
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/objects/*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12/objects

  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12/sounds
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/sounds/*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12/sounds

  install -d $pkgdir/usr/local/lib/pd-l2ork/extra/K12/tests
  install -p -m0644 $srcdir/$pkgname/l2ork_addons/K12/tests/*  $pkgdir/usr/local/lib/pd-l2ork/extra/K12/tests



# Gnome menu support
  install -d $pkgdir/usr/share/icons/hicolor/128x128/apps
  install -p -m0644 packages/linux_make/pd-l2ork-k12.png  $pkgdir/usr/share/icons/hicolor/128x128/apps/

 # install -d $pkgdir/usr/share/icons/hicolor/48x48/apps
  #install -p -m0644 linux_make/pd-extended-48x48.png \
  #  $pkgdir/usr/share/icons/hicolor/48x48/apps/pd-extended.png
  install -d $pkgdir/usr/share/applications/ 
  install -p packages/linux_make/pd-l2ork-k12.desktop \
    $pkgdir/usr/share/applications/
# mime
   install -d $pkgdir/usr/share/mime/packages/ 
   install -p packages/linux_make/pd-l2ork.xml \
    $pkgdir/usr/share/mime/packages/

 
  

}

# vim:set ts=2 sw=2 et:

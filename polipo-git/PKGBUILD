# Contributor: denton <e9203.00 gmail>
pkgname=polipo-git
pkgver=20091212
pkgrel=2
pkgdesc='A small and fast caching web proxy'
arch=(any)
url=http://www.pps.jussieu.fr/~jch/software/polipo
license=(custom)
depends=(bash)
makedepends=(git)
provides=(polipo)
conflicts=(polipo)
install=$pkgname.install
source=(polipo.rc.d polipo.cron)
md5sums=(443e442f7071e31dbd53fc9d810a2c3e
         bac0e1a871964c931eb5f7a369b3243c)

_gitname=${pkgname//-git}
_gitroot=git://git.torproject.org/git/$_gitname

build() {
  msg 'Connecting to GIT server...'

  if [[ -d $_gitname ]]; then
    cd $_gitname; git pull origin; cd $srcdir
    msg 'The local files are updated.'
  else
    git clone $_gitroot
  fi

  msg 'GIT checkout done or server timeout'
  msg 'Starting make...'

  rm -rf $_gitname-build
  git clone $_gitname $_gitname-build

  cd $_gitname-build
  make all || return 1
  make PREFIX=$pkgdir/usr \
       MANDIR=$pkgdir/usr/share/man \
       INFODIR=$pkgdir/usr/share/info \
       LOCAL_ROOT=$pkgdir/usr/share/$_gitname/www install || return 1

  cd $pkgdir
  mkdir -p etc/$_gitname var/cache/$_gitname

  cd $srcdir/$_gitname
  cp {config.sample,forbidden.sample} $pkgdir/usr/share/$_gitname
  install -Dm644 COPYING              $pkgdir/usr/share/licenses/$_gitname/LICENSE
  install -D     ../$_gitname.cron    $pkgdir/usr/share/$_gitname/$_gitname.cron
  install -D     ../$_gitname.rc.d    $pkgdir/etc/rc.d/$_gitname
}

# Maintainer : Lone_Wolf lonewolf@xs4all.nl
# Contributor: Steven She <mintcoffee@gmail.com>
# Contributor: vbPadre <vbpadre@gmail.com>

pkgname=cndrvcups-common
pkgver=2.40
pkgrel=2
pkgdesc="Common printer driver modules for Canon printers"
arch=('i686' 'x86_64')
url="http://support-au.canon.com.au/contents/AU/EN/0900772408.html"
license=('GPL' 'MIT' 'custom')
_MachineType=`uname -m`
if [[ ${_MachineType} == i686 ]]; then
  echo "Package is x86_64 only for now, aborting makepkg"
  return 1
else
  depends=('libglade' 'lib32-glibc')
fi
makedepends=('automake' 'autoconf')
source=('http://gdlp01.c-wss.com/gds/4/0900007724/12/Linux_CAPT_PrinterDriver_V240_uk_EN.tar.gz')
options=('!emptydirs')
md5sums=('02af7004b9130a054ebcf8b689db3e27')
build() {
#    unset LDFLAGS
    cd $srcdir/Linux_CAPT_PrinterDriver_V240_uk_EN/Src
    tar xf ${pkgname}-${pkgver}-1.tar.gz || return 1
    cd $pkgname-$pkgver

    cd cngplp
    ./autogen.sh --prefix=/usr && \
    make && \
    make DESTDIR=${pkgdir} install

    cd ../buftool
    ./autogen.sh --prefix=/usr && \
    make && \
    make DESTDIR=${pkgdir} LIBDIR=/usr/lib install

    
    cd ../c3plmod_ipc
    make && \
    make DESTDIR=${pkgdir} LIBDIR=/usr/lib install
}
package()
{
    cd $srcdir/Linux_CAPT_PrinterDriver_V240_uk_EN/Src/$pkgname-$pkgver
    #Taken from debian install rules in package
    install -c -m 755 libs/c3pldrv    $pkgdir/usr/bin

    install -c -m 755 libs/libcaiowrap.so.1.0.0 $pkgdir/usr/lib
    install -c -m 755 libs/libcaiousb.so.1.0.0 $pkgdir/usr/lib
    install -c -m 755 libs/libc3pl.so.0.0.1 $pkgdir/usr/lib
    install -c -m 755 libs/libcaepcm.so.1.0 $pkgdir/usr/lib
    install -c -m 755 libs/libcanon_slim.so.1.0.0 $pkgdir/usr/lib
    cd $pkgdir/usr/lib/
    ln -sf libc3pl.so.0.0.1 libc3pl.so.0
    ln -sf libc3pl.so.0.0.1 libc3pl.so
    ln -sf libcaepcm.so.1.0 libcaepcm.so.1
    ln -sf libcaepcm.so.1.0 libcaepcm.so
    ln -sf libcaiowrap.so.1.0.0 libcaiowrap.so.1
    ln -sf libcaiowrap.so.1.0.0 libcaiowrap.so
    ln -sf libcaiousb.so.1.0.0 libcaiousb.so.1
    ln -sf libcaiousb.so.1.0.0 libcaiousb.so
    ln -sf libcanonc3pl.so.1.0.0 libcanonc3pl.so.1
    ln -sf libcanonc3pl.so.1.0.0 libcanonc3pl.so
    ln -sf libcanon_slim.so.1.0.0 libcanon_slim.so.1
    ln -sf libcanon_slim.so.1.0.0 libcanon_slim.so

    mkdir -p $pkgdir/usr/share/caepcm
    cd $srcdir/Linux_CAPT_PrinterDriver_V240_uk_EN/Src/$pkgname-$pkgver
    install -c -m 644 data/CA*    $pkgdir/usr/share/caepcm
    install -c -m 644 data/CNZ0*  $pkgdir/usr/share/caepcm

    install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
    install -m755 LICENSE-common-2.40* ${pkgdir}/usr/share/licenses/${pkgname}
}

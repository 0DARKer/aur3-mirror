# Contributor:  lucke <noneus att noneus dot de>
# Contributor:  Daniele Marinello <marinz att email dot it> 
# Maintainer :  crazyb0y <bjin1990 at gmail dot com>

pkgname=mplayer-coreavc-svn
pkgver=32493
pkgrel=1
pkgdesc="A movie player for linux"
license=("GPL")
arch=('i686' 'x86_64')
url="http://code.google.com/p/coreavc-for-linux/"
depends=('libxxf86dga' 'libxv' 'libmad' 'giflib' 'cdparanoia'
         'sdl' 'lame' 'libtheora' 'xvidcore' 'zlib' 'libmng' 'libxss'
         'libgl' 'aalib' 'jack' 'libcaca' 'libdca'
         'x264' 'faac' 'ttf-dejavu' 'libxvmc' 'libjpeg'
         'libxinerama' 'smbclient' 'lirc-utils' 'enca' 'libvdpau' 'dshowserver-svn')
makedepends=('subversion' 'yasm')
conflicts=("mplayer<=$pkgver")
provides=("mplayer=$pkgver")

_svntrunk=svn://svn.mplayerhq.hu/mplayer/trunk
_svnmod=mplayer

source=(dshowserver.patch codec_coreserve.conf)
md5sums=(4f524f2caff11d3f077828cc8a5af252 844d6f5198fb1965b8dcfc3bf03a4d5b)

build() {
  cd $srcdir

  if [ -d $_svnmod/.svn ]; then
    (cd $_svnmod && svn up -r $pkgver && cd ..)
  else
    svn co $_svntrunk --config-dir ./ $_svnmod
  fi
  svn revert -R $_svnmod

  msg "SVN checkout done or server timeout, updating build dir"

  cd $_svnmod

  msg "Applying dshowserver.patch"

  patch -p0 < ${srcdir}/dshowserver.patch || return 1

  msg "Starting make..."

  unset CFLAGS LDFLAGS

  ./configure --prefix=/usr --confdir=/etc/mplayer --disable-gl --language=all || return 1
  make -j3 || return 1
  cat $srcdir/codec_coreserve.conf >> etc/codecs.conf

  make -j1 DESTDIR=${pkgdir} install || return 1

  install -D -m644 etc/{codecs.conf,input.conf,example.conf} ${pkgdir}/etc/mplayer/ || return 1
  install -d -m755 ${pkgdir}/usr/share/mplayer/
  ln -s /usr/share/fonts/TTF/DejaVuSans.ttf ${pkgdir}/usr/share/mplayer/subfont.ttf || return 1
  rm -rf ${pkgdir}/usr/share/mplayer/font
}

# Maintainer: nylocx <aur (at) nyloc (dot) de>

pkgname=atticmatic-hg
_pkgver=0.0.1
pkgver=$_pkgver.r14_8520203001e9
pkgrel=1
pkgdesc="A simple Python wrapper script for the Attic backup software that initiates a backup and prunes any old backups according to a retention policy."
arch=('i686' 'x86_64')
url="http://torsion.org/hg/atticmatic/"
license=('GPLv3')
depends=('attic')
makedepends=('mercurial')
source=("$pkgname"::'hg+https://torsion.org/hg/atticmatic'
	'0001-python3-except.patch'
	'0002-python3-configparser.patch')
sha512sums=('SKIP'
            '12f63aff0dcb58b6879bd5fe414be9e8263f0687a5ba528971e0bced561557f3cbb60c7c5086f649cba95bfb91ba4faf7d7fd4672867b9b7f050579754a183ad'
            'b44dda9bde1e34d085503c108f56d3c8e77be4448f60f991964daf8efbdd6c1ff5a5f6721b871611c75da7c447f6310d579dc9ca336f948f5733d2d0e26df920')
conflicts=('atticmatic')
provides=('atticmatic')

pkgver() {
  cd "$srcdir/$pkgname"
  hg log -r tip --template '$_pkgver.r{rev}_{node|short}\n'
}

build() {
  msg2 "Patching..."
  (
    cd $pkgname
    patch -Np1 -i "${srcdir}/0001-python3-except.patch"
    patch -Np1 -i "${srcdir}/0002-python3-configparser.patch"
  )

}

package() {
  cd "$srcdir/$pkgname"
  install -D -m644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -D -m644 sample/config "$pkgdir/etc/$pkgname/config.example"
  install -D -m644 sample/excludes "$pkgdir/etc/$pkgname/excludes.example"
  install -D -m644 sample/atticmatic.cron "$pkgdir/etc/$pkgname/atticmatic.cron.example"
  python setup.py -q install --root="$pkgdir" --optimize=1
}

# Maintainer: DonVla <donvla@users.sourceforge.net>

_do_patch=1
pkgname=linux-n130
_kernelname=-N130
_basekernel=3.0
_minrev=.4
#pkgver=${_basekernel}
pkgver=${_basekernel}${_minrev}
pkgrel=4
_kernel_path="http://kernelorg.mirrors.tds.net/pub/linux/kernel"
_patchname="patch-${_basekernel}${_minrev}"
# http://users.on.net/~ckolivas/kernel/
_ck_patchver=ck1
_ck_path="http://www.kernel.org/pub/linux/kernel/people/ck/patches/${_basekernel}/${_basekernel}.0-${_ck_patchver}"
_ck_patchname="patch-${_basekernel}.0-${_ck_patchver}"
_bfq_ver="v3"
_bfq_path="http://algo.ing.unimo.it/people/paolo/disk_sched/patches/3.0.0"
pkgdesc="The Linux kernel and modules for SAMSUNG N130 - optionally with Con Kolivas' ck patchset and/or BFQ patches"
arch=('i686')
license=('GPL2')
options=(!strip)
url="http://www.kernel.org"
depends=('coreutils' 'linux-firmware' 'lzop' 'module-init-tools' 'mkinitcpio>=0.5.20')
install="linux${_kernelname}.install"
source=("${_kernel_path}/v3.0/linux-${_basekernel}.tar.bz2"
        "${_kernel_path}/v3.0/${_patchname}.bz2"
        "${_ck_path}/${_ck_patchname}.bz2"
        "fix-i915.patch" 
        "change-default-console-loglevel.patch"
        "config" "mkinitcpio-N130.conf" "linux-N130.preset"
        logo_linux_{clut224.ppm,mono.pbm,vga16.ppm}
        "0001-block-prepare-I-O-context-code-for-BFQ-${_bfq_ver}-for-${_basekernel}.patch"
        "0002-block-cgroups-kconfig-build-bits-for-BFQ-${_bfq_ver}-${_basekernel}.patch"
        "0003-block-introduce-the-BFQ-${_bfq_ver}-I-O-sched-for-${_basekernel}.patch" )
#        "${_bfq_path}/0001-block-prepare-I-O-context-code-for-BFQ-${_bfq_ver}-for-${_basekernel}.patch"
#        "${_bfq_path}/0002-block-cgroups-kconfig-build-bits-for-BFQ-${_bfq_ver}-${_basekernel}.patch"
#        "${_bfq_path}/0003-block-introduce-the-BFQ-${_bfq_ver}-I-O-sched-for-${_basekernel}.patch" )
optdepends=('crda: to set the correct wireless channels of your country')
md5sums=('398e95866794def22b12dfbc15ce89c0'
         '62ca5f3caed233617127b2b3b7a87d15'
         'bca399a46c7d83affdace85b9c633e36'
         '263725f20c0b9eb9c353040792d644e5'
         '9d3c56a4b999c8bfbd4018089a62f662'
         'a4257b324a7e3a03c5b08c00d4651378'
         'bfdcb2a4be0152282d0b2803c89644f7'
         'aa252f2de83c3d076d70e673bcc2ebfb'
         '6a5a1925501fe20fafd04fdb3cb4f6ed'
         'e8c333eaeac43f5c6a1d7b2f47af12e2'
         'c120adbd9c0daa0136237a83adeabd1e'
         'a325f43707984c93672d8f4aaf76fc2b'
         'e1064f82d5faab2119af5f6dbeae2cb1'
         '5d7307a9b6bf0271ee55cae6c6fe2610')
sha256sums=('64b0228b54ce39b0b2df086109a7b737cde58e3df4f779506ddcaccee90356a0'
            '96fcf18ca99ddd760069d03d9e7d61ff3e25b708d9cde42b82b77d4f61f86fb4'
            '34ca007d90df006e70b7de31e6db969c63d3c7f6e141463cff036b89b7d22ee0'
            '9ccadbe3eb30bb283af3eb869c3a4bdb764628854811cc616a2e02e9ef398705'
            'b9d79ca33b0b51ff4f6976b7cd6dbb0b624ebf4fbf440222217f8ffc50445de4'
            'a02ed7f68d425e8aa8f8651fe6dfe640ca239bf22b997cd022a0ca697e7da9d5'
            '8e66344ccee4b9d41435aba32414a9ac34e92ff68b2cb1faa67f75fc26a22533'
            'b83ef00783cc50e2ea14e7e838c3f9c17a9d6af53a4be7d747185fa8831708a1'
            '4274579ccf42a9acc03283edffea2dda2c4a48e3fd734bbaeada4c16dff9d156'
            '1e5bea8de1c2cc24498fb9a4fdbb313f36f38f671f2bfc46ccf7acbd7958a4b9'
            'f9c7c1275313890fc12f6bab92e2c0794b5041e223d868eb0e34cd99baee3d7a'
            '071cc4eef1672f54d64fc1065c81c83b555c315f00c293f0c4fcf6916cf8baec'
            '3d3fb4b968da6d4dd3c4514501721c4e775dfd5ab4ac1e429c9045635e5d70db'
            'da9b47adfff09267b356cc92678433f1a0b833f7d45a2e328b49c7a271bb8000')

build() {
  # change to 1 (or else) if you want to use the BF scheduler
  # http://users.on.net/~ckolivas/kernel/
  _USE_CK_PATCHSET=0
  # change to 1 (or else) if you want to use the BFQ i/o scheduler
  # http://algo.ing.unimo.it/people/paolo/disk_sched/
  _USE_BFQ_PATCHES=0
  # default resume partition -> your swap partition. eg: 
  #_RESUME_SWAP_PARTITION="/dev/sda3"
  # NO PERSISTENT NAMING! If in doubt, leave it empty
  _RESUME_SWAP_PARTITION=""

  cd "${srcdir}/linux-${_basekernel}"

  # Add revision patches
  (( _do_patch )) && [[ ! -z "${_minrev}" ]] && msg "Adding revision patches..." && (patch -Np1 < "${srcdir}/${_patchname}")

  # Add Arch Linux logo to the source
  msg "Adding Arch Linux logo..."
  install -v -m 0644 "${srcdir}/logo_linux_clut224.ppm"  drivers/video/logo/logo_linux_clut224.ppm &&
  install -v -m 0644 "${srcdir}/logo_linux_mono.pbm"     drivers/video/logo/logo_linux_mono.pbm &&
  install -v -m 0644 "${srcdir}/logo_linux_vga16.ppm"    drivers/video/logo/logo_linux_vga16.ppm

  # Copy config
  cat ../config > ./.config
  if [[ "${_RESUME_SWAP_PARTITION}" ]]; then 
    sed -e "s|CONFIG_PM_STD_PARTITION=.*|CONFIG_PM_STD_PARTITION=\""${_RESUME_SWAP_PARTITION}"\"|g" -i ./.config
  fi

  # fix #19234 i1915 display size
  (( _do_patch )) && patch -Np1 -i "${srcdir}/fix-i915.patch"

  # set DEFAULT_CONSOLE_LOGLEVEL to 4 (same value as the 'quiet' kernel param)
  # remove this when a Kconfig knob is made available by upstream
  # (relevant patch sent upstream: https://lkml.org/lkml/2011/7/26/227)
  (( _do_patch )) && patch -Np1 -i "${srcdir}/change-default-console-loglevel.patch"

  ### Additional patches 
  # Add CK's BFS patch
  if (( _do_patch && _USE_CK_PATCHSET )); then 
    msg "Adding CK patchset..." 
    patch -Np1 < "${srcdir}/${_ck_patchname}"
  fi

  if (( _do_patch && _USE_BFQ_PATCHES )); then
    msg "Adding BFQ patches..."
    local _patch
    for _patch in "${srcdir}"/000*-block-*.patch; do
        patch -Np1 < "${_patch}"
    done 
  fi

  # Remove EXTRAVERSION from Makefile. Version will remain ${_basekernel}-${_kernelname}
  sed -e "s/^EXTRAVERSION\ .*/EXTRAVERSION\ = "${_kernelname}"/g" -i Makefile
  
  # remove the sublevel from Makefile
  # this ensures our kernel version is always 3.X-ARCH
  # this way, minor kernel updates will not break external modules
  # we need to change this soon, see FS#16702
  sed -ri 's|^(SUBLEVEL =).*|\1|' Makefile

  # get kernel version
  make prepare
  ####################
  ###
  ### Configure the kernel and stop afterwards
  ### this is useful to configure the kernel
  #make oldconfig
  ###
  ### This one also moves the config file to ${startdir} for later use. 
  ### Don't forget to rebuild the checksums afterwards! 
  #make menuconfig && cp -v .config ${startdir}/config && msg "Stopping build" && return 1
  ### new nconfig
  #make nconfig && cp -v .config ${startdir}/config && msg "Stopping build" && return 1
  ####################
  yes "" | make config
  # build!
  make ${MAKEFLAGS} bzImage modules
}

package() {
  KARCH=x86

  cd "${srcdir}/linux-${_basekernel}"
  # Get kernel version  
  _kernver="$(make kernelrelease)"

  ###
  ### install kernel and modules (kernel package)
  ###
  mkdir -p ${pkgdir}/{lib/modules,boot}
  make INSTALL_MOD_PATH="${pkgdir}" modules_install
  cp arch/${KARCH}/boot/bzImage ${pkgdir}/boot/vmlinuz${_kernelname}

  # add vmlinux
  install -m644 -D vmlinux ${pkgdir}/usr/src/linux-${_kernver}/vmlinux

  # install N130 mkinitcpio.conf and preset file for kernel
  install -m644 -D ${srcdir}/mkinitcpio-N130.conf ${pkgdir}/etc/mkinitcpio-N130.conf
  install -m644 -D ${srcdir}/linux${_kernelname}.preset ${pkgdir}/etc/mkinitcpio.d/linux${_kernelname}.preset

  # set correct depmod command for install
  sed \
    -e  "s/KERNEL_NAME=.*/KERNEL_NAME=${_kernelname}/g" \
    -e  "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" \
    -i "${startdir}/linux${_kernelname}.install"

  sed \
    -e "s|ALL_kver=.*|ALL_kver=\"/boot/vmlinuz${_kernelname}\"|g" \
    -e "s|default_image=.*|default_image=\"/boot/linux${_kernelname}.img\"|g" \
    -e "s|fallback_image=.*|fallback_image=\"/boot/initramfs${_kernelname}-fallback.img\"|g" \
    -i ${pkgdir}/etc/mkinitcpio.d/linux${_kernelname}.preset

  # remove build and source links
  rm -f ${pkgdir}/lib/modules/${_kernver}/{source,build}
  # remove the firmware
  rm -rf ${pkgdir}/lib/firmware
  # gzip -9 all modules to safe 100MB of space
  find "$pkgdir" -name '*.ko' -exec gzip -9 {} \;

  ###
  ### install kernel headers (kernel headers package)
  ###
  mkdir -p "${pkgdir}/lib/modules/${_kernver}"
  cd "${pkgdir}/lib/modules/${_kernver}" && ln -sf ../../../usr/src/linux-${_kernver} build

  cd "${srcdir}/linux-${_basekernel}"
  install -D -m644 Makefile "${pkgdir}/usr/src/linux-${_kernver}/Makefile"
  install -D -m644 kernel/Makefile "${pkgdir}/usr/src/linux-${_kernver}/kernel/Makefile"
  install -D -m644 .config "${pkgdir}/usr/src/linux-${_kernver}/.config"

  mkdir -p "${pkgdir}/usr/src/linux-${_kernver}/include"
  for i in acpi asm-generic config generated drm linux math-emu media net pcmcia scsi sound trace video xen; do
    cp -a "include/$i" "${pkgdir}/usr/src/linux-${_kernver}/include/"
  done

  # copy arch includes for external modules
  mkdir -p "${pkgdir}/usr/src/linux-${_kernver}/arch/x86"
  cp -a arch/x86/include "${pkgdir}/usr/src/linux-${_kernver}/arch/x86/"

  # copy files necessary for later builds, like nvidia and vmware
  cp Module.symvers "${pkgdir}/usr/src/linux-${_kernver}"
  cp -a scripts "${pkgdir}/usr/src/linux-${_kernver}"
  # fix permissions on scripts dir
  chmod og-w -R ${pkgdir}/usr/src/linux-${_kernver}/scripts
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/.tmp_versions

  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel

  cp arch/$KARCH/Makefile ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  cp arch/$KARCH/Makefile_32.cpu ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  cp arch/$KARCH/kernel/asm-offsets.s ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel/

  # add headers for lirc package
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video
  cp drivers/media/video/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/
  for i in bt8xx cpia2 cx25840 cx88 em28xx et61x251 pwc saa7134 sn9c102; do
   mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
   cp -a drivers/media/video/$i/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
  done
  # add dm headers
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/md
  cp drivers/md/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/md
  # add inotify.h
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/linux
  cp include/linux/inotify.h ${pkgdir}/usr/src/linux-${_kernver}/include/linux/
  # add wireless headers
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  cp net/mac80211/*.h ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core
  cp drivers/media/dvb/dvb-core/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core/
  # add dvb and tuner headers for external modules in reference to: http://bugs.archlinux.org/task/11194
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/
  cp include/config/dvb/*.h ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb
  cp drivers/media/dvb/dvb-usb/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends
  cp drivers/media/dvb/frontends/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners
  cp drivers/media/common/tuners/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners/

  # add headers for virtualbox
  cp -a include/drm $pkgdir/usr/src/linux-${_kernver}/include/
  # add headers for crypto modules in reference to: http://bugs.archlinux.org/task/22081
  cp -a include/crypto ${pkgdir}/usr/src/linux-${_kernver}/include/
  # copy in Kconfig files
  for i in `find . -name "Kconfig*"`; do 
    mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/`echo $i | sed 's|/Kconfig.*||'`
    cp $i ${pkgdir}/usr/src/linux-${_kernver}/$i
  done

  chown -R root.root ${pkgdir}/usr/src/linux-${_kernver}
  find ${pkgdir}/usr/src/linux-${_kernver} -type d -exec chmod 755 {} \;
  # strip scripts directory
  find ${pkgdir}/usr/src/linux-${_kernver}/scripts  -type f -perm -u+w 2>/dev/null | while read binary ; do
    case "$(file -bi "$binary")" in
      *application/x-sharedlib*) # Libraries (.so)
        /usr/bin/strip $STRIP_SHARED "$binary";;
      *application/x-archive*) # Libraries (.a)
        /usr/bin/strip $STRIP_STATIC "$binary";;
      *application/x-executable*) # Binaries
        /usr/bin/strip $STRIP_BINARIES "$binary";;
    esac 
  done 
  # remove unneeded architectures
  rm -rf ${pkgdir}/usr/src/linux-${_kernver}/arch/{alpha,arm,arm26,avr32,blackfin,cris,frv,h8300,ia64,m32r,m68k,m68knommu,mips,microblaze,mn10300,parisc,powerpc,ppc,s390,sh,sh64,sparc,sparc64,um,v850,xtensa}
}

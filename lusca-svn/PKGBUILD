# Maintainer: Affif Mukhlashin <bluemeda@programmer.net>
pkgname=lusca-svn
pkgver=14945
pkgrel=2
pkgdesc="Lusca is a fork of the Squid-2 development tree. The Lusca project aims to fix the shortcomings in the Squid-2 codebase whilst maintaining the the Squid-2 functionality and stability."
arch=('x86_64' 'i686')
url="http://www.lusca.net"
license=('GPL')
depends=('openssl' 'pam' 'cron' 'perl' 'libltdl')
makedepends=('subversion' 'sharutils')
conflicts=('squid')
options=('emptydirs')
install=$pkgname.install
source=('svn+http://lusca-cache.googlecode.com/svn/branches/LUSCA_HEAD/'
        'new-gcc.patch'
        'squid.pam'
        'squid.cron'
        'squid.service'
        )
md5sums=('SKIP'
         '2438a69dd477f7ccec7b0c14e62bc217'
         '270977cdd9b47ef44c0c427ab9034777'
         'a71425c4951f2e5b640d19e6a5048531'
         'ceeb57c69ebb165676219222f109a24e')

pkgver() {
  cd "LUSCA_HEAD"
  svnversion | tr -d [A-z]
}

prepare() {
  cd "$srcdir/LUSCA_HEAD/"
  patch -p1 -i ../new-gcc.patch

  # fix cache_dir, cache_dir size, and effective group.
  sed '/^DEFAULT_SWAP_DIR/ s@/cache@/cache/squid@' -i src/Makefile.am
  sed '/^#cache_dir/ s/100/256/
       /^NAME: cache_effective_group/ {n;n;s/none/proxy/}' -i src/cf.data.pre


}

build() {

  msg "Starting build..."
  cd "$srcdir/LUSCA_HEAD/"
  ./bootstrap.sh

  #
  # BUILD HERE
  #
  ./configure \
  --prefix=/usr \
  --exec_prefix=/usr \
  --bindir=/usr/bin \
  --sbindir=/usr/bin \
  --libexecdir=/usr/lib/squid \
  --sysconfdir=/etc/squid \
  --localstatedir=/var/spool/squid \
  --datadir=/usr/share/squid \
  --enable-async-io=24 \
  --with-aufs-threads=24 \
  --with-pthreads \
  --enable-storeio=aufs \
  --enable-linux-netfilter \
  --enable-arp-acl \
  --enable-epoll \
  --enable-removal-policies=heap \
  --with-aio \
  --with-dl \
  --enable-snmp \
  --enable-delay-pools \
  --enable-htcp \
  --enable-cache-digests \
  --disable-unlinkd \
  --enable-large-cache-files \
  --with-large-files \
  --enable-err-languages=English \
  --enable-default-err-language=English \
  --with-maxfd=65536

  make
}

package() {
  cd "$srcdir/LUSCA_HEAD/"
  make DESTDIR="$pkgdir/" install
}

# vim:set ts=2 sw=2 et:

# Maintainer : Lone_Wolf lonewolf@xs4all.nl
# Contributor : Robert McCathie <archaur at rmcc dot com dot au>
# Contributor: Juraj Misur <juraj.misur@gmail.com>

pkgname=cndrvcups-capt
pkgver=2.40
pkgrel=1
pkgdesc="Canon CAPT Printer Driver for Linux"
arch=('x86_64')
url="http://support-au.canon.com.au/contents/AU/EN/0900772408.html"
license=('custom')
install=capt.install
_MachineType=`uname -m`
if [[ ${_MachineType} == i686 ]]; then
  echo "Package is x86_64 only for now, aborting makepkg"
  return 1
else
  depends=('libcups' 'libxml2' 'cndrvcups-common=2.40')
fi

makedepends=('automake')
optdepends=('gtk2: for gui')
source=('Linux_CAPT_PrinterDriver_V240_uk_EN.tar.gz::http://pdisp01.c-wss.com/gdl/WWUFORedirectTarget.do?id=MDkwMDAwNzcyNDEy&cmp=ABS&lang=EN'
	'ccpd'
	'how-to.txt')
md5sums=('02af7004b9130a054ebcf8b689db3e27'
         'dc4312dd8070d3b1b4231d47f4383020'
         '2cdb0e8e5d3c21b389cad3b3581a13ec')

build() {
    cd $srcdir/Linux_CAPT_PrinterDriver_V240_uk_EN/Src
    tar xf ${pkgname}-${pkgver}-1.tar.gz
    #prepare build directory
    rm -rf $pkgname-build
    cp -r "$pkgname-$pkgver" "$srcdir/$pkgname-build"
    cd "$srcdir/$pkgname-build"
    cd driver 
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin --disable-static
    cd ../backend 
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin
    cd ../pstocapt 
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin
    cd ../pstocapt2 
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin
    cd ../pstocapt3 
    ./autogen.sh --prefix=/usr --libdir=/usr/lib --enable-progpath=/usr/bin
    cd ../ppd 
    ./autogen.sh --prefix=/usr 
    cd ../statusui
    mv src/ppapdata.c src/ppapdata.c.org
    sed '26 a\#include <cups/ppd.h>' <src/ppapdata.c.org >src/ppapdata.c
    ./autogen.sh --prefix=/usr --libdir=/usr/lib 
    cd ../cngplp
    libtoolize --force --copy
    ./autogen.sh --prefix=/usr --libdir=/usr/lib
    cd files
    ./autogen.sh --prefix=/usr
    cd "$srcdir/$pkgname-build"
    make
}

package() {
    cd $srcdir/$pkgname-build
    make install DESTDIR=${pkgdir}
    install -D -m755 "$srcdir/ccpd" "$pkgdir/etc/rc.d/ccpd"
    mkdir -p "$pkgdir/var/ccpd"
    mkdir -p "$pkgdir/var/captmon"
    install -m755 -d "${pkgdir}/usr/share/licenses/${pkgname}"
    install -m644 LICENSE-capt-2.40* "$pkgdir/usr/share/licenses/$pkgname/"
}

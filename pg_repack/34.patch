From d6ce34de6c654808754b3fe74efc48054575a36f Mon Sep 17 00:00:00 2001
From: Borodin Vladimir <d0uble@yandex-team.ru>
Date: Mon, 12 Jan 2015 17:43:38 +0300
Subject: [PATCH] Ugly fix to support PostgreSQL 9.4

---
 bin/pgut/pgut.c      |  5 +++++
 lib/pg_repack.sql.in |  2 +-
 lib/pgut/pgut-spi.c  |  9 +++++++++
 lib/repack.c         | 16 ++++++++++++++++
 4 files changed, 31 insertions(+), 1 deletion(-)

diff --git a/bin/pgut/pgut.c b/bin/pgut/pgut.c
index 04b8459..7f46fc9 100644
--- a/bin/pgut/pgut.c
+++ b/bin/pgut/pgut.c
@@ -1210,6 +1210,11 @@ exit_or_abort(int exitcode)
 
 /*
  * unlike the server code, this function automatically extend the buffer.
+ *
+ * TODO: as of http://git.postgresql.org/gitweb/?p=postgresql.git;a=commit;h=3147acd6
+ * server's API of appendStringInfoVA changed. Should be done the same here
+ * or should this function be removed?
+ * 
  */
 bool
 appendStringInfoVA(StringInfo str, const char *fmt, va_list args)
diff --git a/lib/pg_repack.sql.in b/lib/pg_repack.sql.in
index 23f66dc..98f560f 100644
--- a/lib/pg_repack.sql.in
+++ b/lib/pg_repack.sql.in
@@ -172,7 +172,7 @@ CREATE VIEW repack.tables AS
   SELECT R.oid::regclass AS relname,
          R.oid AS relid,
          R.reltoastrelid AS reltoastrelid,
-         CASE WHEN R.reltoastrelid = 0 THEN 0 ELSE (SELECT reltoastidxid FROM pg_class WHERE oid = R.reltoastrelid) END AS reltoastidxid,
+         CASE WHEN R.reltoastrelid = 0 THEN 0 ELSE (SELECT indexrelid FROM pg_index WHERE indrelid = R.reltoastrelid) END AS reltoastidxid,
          N.nspname AS schemaname,
          PK.indexrelid AS pkid,
          CK.indexrelid AS ckid,
diff --git a/lib/pgut/pgut-spi.c b/lib/pgut/pgut-spi.c
index a234b84..593b6b9 100644
--- a/lib/pgut/pgut-spi.c
+++ b/lib/pgut/pgut-spi.c
@@ -29,11 +29,20 @@ termStringInfo(StringInfo str)
 static void
 appendStringInfoVA_s(StringInfo str, const char *fmt, va_list args)
 {
+#if PG_VERSION_NUM < 90400
 	while (!appendStringInfoVA(str, fmt, args))
 	{
 		/* Double the buffer size and try again. */
 		enlargeStringInfo(str, str->maxlen);
 	}
+#else
+	int needed;
+	while ((needed = appendStringInfoVA(str, fmt, args)) != 0)
+	{
+		/* Increase the buffer size and try again. */
+		enlargeStringInfo(str, needed);
+	}
+#endif
 }
 
 /* simple execute */
diff --git a/lib/repack.c b/lib/repack.c
index 0d9861b..6193f3e 100644
--- a/lib/repack.c
+++ b/lib/repack.c
@@ -747,6 +747,8 @@ getoid(HeapTuple tuple, TupleDesc desc, int column)
  *
  * repack_swap(oid, relname)
  *
+ * TODO: support for several toast indexes for PG 9.4 and higher.
+ *
  * TODO: remove useless CommandCounterIncrement().
  *
  * @param	oid		Oid of table of target.
@@ -783,6 +785,8 @@ repack_swap(PG_FUNCTION_ARGS)
 
 	/* swap relfilenode and dependencies for tables. */
 	values[0] = ObjectIdGetDatum(oid);
+
+#if PG_VERSION_NUM < 90400
 	execute_with_args(SPI_OK_SELECT,
 		"SELECT X.reltoastrelid, TX.reltoastidxid, X.relowner,"
 		"       Y.oid, Y.reltoastrelid, TY.reltoastidxid, Y.relowner"
@@ -793,6 +797,18 @@ repack_swap(PG_FUNCTION_ARGS)
 		" WHERE X.oid = $1"
 		"   AND Y.oid = ('repack.table_' || X.oid)::regclass",
 		1, argtypes, values, nulls);
+#else
+	execute_with_args(SPI_OK_SELECT,
+		"SELECT X.reltoastrelid, COALESCE(IX.indexrelid, 0), X.relowner,"
+		"	Y.oid, Y.reltoastrelid, COALESCE(IY.indexrelid, 0), Y.relowner"
+		"  FROM pg_catalog.pg_class X LEFT JOIN pg_catalog.pg_index IX"
+		"         ON X.reltoastrelid = IX.indrelid,"
+		"     pg_catalog.pg_class Y LEFT JOIN pg_catalog.pg_index IY" 
+		"         ON Y.reltoastrelid = IY.indrelid"
+		" WHERE X.oid = $1"
+		"   AND Y.oid = ('repack.table_' || X.oid)::regclass",
+		1, argtypes, values, nulls);
+#endif
 
 	tuptable = SPI_tuptable;
 	desc = tuptable->tupdesc;

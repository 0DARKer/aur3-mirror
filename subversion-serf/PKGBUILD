pkgname=subversion-serf
pkgver=1.6.17
pkgrel=1
pkgdesc="Replacement for CVS, another versioning system (svn) with serf activated"
arch=('i686' 'x86_64')
license=('apache' 'bsd')
depends=('serf' 'apr-util>=1.3.2-2')
makedepends=('krb5' 'apache' 'python2' 'perl' 'swig' 'ruby' 'java-runtime'
             'autoconf' 'db' 'e2fsprogs' 'libgnome-keyring' 'kdelibs' 'serf')
source=(http://subversion.tigris.org/downloads/subversion-$pkgver.tar.bz2
        svnserve svn svnserve.conf svnmerge.py
        subversion.rpath.fix.patch
        subversion.suppress.deprecation.warnings.patch)
conflicts=('subversion')

backup=('etc/xinetd.d/svn' 'etc/conf.d/svnserve')
url="http://subversion.tigris.org/"
provides=('svn' 'subversion')
options=('!makeflags' '!libtool')
optdepends=('gnome-keyring' 'kdeutils-kwallet' 'bash-completion: for svn bash completion')

build() {
  cd ${srcdir}/subversion-${pkgver}

  export PYTHON=/usr/bin/python2

  # apply patches
  patch -p1 -i $srcdir/subversion.suppress.deprecation.warnings.patch
  patch -p0 < $srcdir/subversion.rpath.fix.patch

  # configure
  autoreconf
  ./configure --prefix=/usr --with-apr=/usr --with-apr-util=/usr \
              --with-zlib=/usr --with-serf=/usr --with-apxs \
              --with-sqlite=/usr \
              --enable-javahl --with-gnome-keyring --with-kwallet

  # build
  (make external-all && make LT_LDFLAGS="-L$Fdestdir/usr/lib" local-all ) \

  # install
  export LD_LIBRARY_PATH=${pkgdir}/usr/lib:$LD_LIBRARY_PATH
  make DESTDIR=${pkgdir} install

  make DESTDIR=${pkgdir} swig-py
  make install-swig-py DESTDIR=${pkgdir}

  mkdir -p ${pkgdir}/usr/lib/python2.7
  mv ${pkgdir}/usr/lib/svn-python/ ${pkgdir}/usr/lib/python2.7/site-packages \

  mkdir -p ${pkgdir}/usr/share/subversion
  install -d -m 755 tools/hook-scripts ${pkgdir}/usr/share/subversion/ \

  rm -f ${pkgdir}/usr/share/subversion/hook-scripts/*.in

  make DESTDIR=${pkgdir} swig-pl
  make install-swig-pl DESTDIR=${pkgdir} INSTALLDIRS=vendor
  rm -f ${pkgdir}/usr/lib/perl5/vendor_perl/auto/SVN/_Core/.packlist \

  rm -rf ${pkgdir}/usr/lib/perl5/core_perl

  make DESTDIR=${pkgdir} swig-rb
  make install-swig-rb DESTDIR=${pkgdir} 

  make DESTDIR=${pkgdir} javahl
  make DESTDIR=${pkgdir} install-javahl

  mkdir -p ${pkgdir}/etc/rc.d
  mkdir -p ${pkgdir}/etc/xinetd.d
  mkdir -p ${pkgdir}/etc/conf.d

  install -m 755 ${srcdir}/svnserve ${pkgdir}/etc/rc.d
  install -m 644 ${srcdir}/svn ${pkgdir}/etc/xinetd.d
  install -m 644 ${srcdir}/svnserve.conf ${pkgdir}/etc/conf.d/svnserve \

  install -m 755 ${srcdir}/svnmerge.py ${pkgdir}/usr/bin/svnmerge
  install -D -m 644 ${srcdir}/subversion-$pkgver/COPYING \
              ${pkgdir}/usr/share/licenses/subversion/LICENSE

  # bash completion
  install -Dm 644 ${srcdir}/subversion-${pkgver}/tools/client-side/bash_completion \
               ${pkgdir}/etc/bash_completion.d/subversion

  mkdir -p ${pkgdir}/etc/subversion
  echo "[global]" > ${pkgdir}/etc/subversion/servers
  echo "http-library = serf" >> ${pkgdir}/etc/subversion/servers
}
md5sums=('81e5dc5beee4b3fc025ac70c0b6caa14'
         'a2b029e8385007ffb99b437b30521c90'
         'a0db6dd43af33952739b6ec089852630'
         'c459e299192552f61578f3438abf0664'
         '21bf3aa5b797ce98eba8307f30e9c070'
         '6b4340ba9d8845cd8497e013ae01be3f'
         '1166f3b7413d7e7450299b3525680bbe')

# Maintainer: naelstrof <naelstrof@gmail.com>
pkgname=projectzomboid
pkgver=RC2.9
pkgrel=1
pkgdesc="Project Zomboid is a Zombie Survival RPG. This is the x86_64 version. You need a key from projectzomboid.com in order to play."
#arch=('i686' 'x86_64' )
arch=('x86_64')
url="http://projectzomboid.com/"
license=('custom')
depends=('java-runtime')

# I was going to make it detect which Architecture the host compiling the package was running, which is dumb.
# If you want the 32 lib version, the link is there just uncomment it. You'll have to generate the MD5 sums for it though.
#_arch=`uname -m`
#if [[ "$_arch" == "x86_64" ]]; then
    source=(https://s3.amazonaws.com/alpha.projectzomboid.com/projectzomboid-amd64.tar.gz
            projectzomboid-RC2.9-linux.patch)
    md5sums=('76e5441427bde22ae23bbdc18e82edab'
             '6694fc0137824f2761b7c897569bf1c8')
#else
#    source=(https://s3.amazonaws.com/alpha.projectzomboid.com/projectzomboid-i386.tar.gz
#            projectzomboid-RC2.9-linux.patch)
#    md5sums=('aa6b0f3ec15fb04b68d6373142db1b8f'
#             '6694fc0137824f2761b7c897569bf1c8')
#fi

build() {
    # Instead of actually building anything here, we're just going to fix the package.
    cd "$srcdir/$pkgname"

    # Gotta fix some scripting errors first.
    patch -p1 -i $srcdir/projectzomboid-RC2.9-linux.patch

    # We also need to fix some case-sensitivity errors here:
    cd media/sound
    mv batswing.ogg batSwing.ogg
    mv Bathit.ogg bathit.ogg
    mv ambientOutsideDaybirds.ogg ambientOutsideDayBirds.ogg

    # That's it! Now go ahead and create the package with the fixed files.
}

package() {
    cd "$srcdir/$pkgname"

    # Install all the package files
    mkdir -p "$pkgdir/opt/$pkgname"
    cp -R * "$pkgdir/opt/$pkgname"

    # Now we have to create a proxy executable, since the script supplied by the package must be ran from the game directory.
    mkdir -p "$pkgdir/usr/bin"
    echo "#!/bin/bash
/opt/projectzomboid/projectzomboid.sh" > "$pkgdir/usr/bin/projectzomboid"
    chmod +x "$pkgdir/usr/bin/projectzomboid"

    # Now create a pretty desktop entry--
    mkdir -p "$pkgdir/usr/share/applications"
    echo "[Desktop Entry]
Version=RC2.9
Name=Project Zomboid
GenericName=Project Zomboid
Comment=Survival Zombie RPG
Exec=/usr/bin/projectzomboid
Terminal=false
Icon=projectzomboid.png
Type=Application
Categories=Game;
MimeType=;" > "$pkgdir/usr/share/applications/projectzomboid.desktop"

    # With even its own icon!
    mkdir -p "$pkgdir/usr/share/pixmaps"
    cp projectzomboid.png "$pkgdir/usr/share/pixmaps"

    # Phew! Finally a perfectly good Arch Linux acceptable application!
}

# Maintainer: Nicolas Pouillard
pkgname=darcs-bridge
pkgver=20110818
pkgrel=1
pkgdesc="Bidirectional synchronization between Darcs and Git"
url="http://darcs.net/DarcsBridgeUsage"
license=('custom:BSD3')
arch=('i686' 'x86_64')
depends=('gmp')
makedepends=('ghc' 'cabal-install' 'darcs')
options=('strip')
_darcstrunk=http://darcsden.com/owst
_darcsname=darcs-fastconvert-gsoc

build() {
  cd $srcdir

  if [[ -d $srcdir/$_darcsname/_darcs ]]
  then
    msg "Retrieving missing patches"
    cd $_darcsname
    darcs pull -a $_darcstrunk/$_darcsname
  else
    msg "Retrieving complete sources"
    darcs get --partial $_darcstrunk/$_darcsname
  fi
  cd $srcdir/$_darcsname

  ORIG_HOME="$HOME"
  ORIG_TMPDIR="$TMPDIR"
  export HOME="${srcdir}/home"
  export TMPDIR="${srcdir}/home/tmp"
  mkdir -p "$HOME" "$TMPDIR"

  cabal update
  cabal install --user

  install -D -m755 "$HOME"/.cabal/bin/darcs-fastconvert ${pkgdir}/usr/bin/$pkgname
  install -D -m644 LICENSE ${pkgdir}/usr/share/licenses/$pkgname/LICENSE

  export HOME="$ORIG_HOME"
  export TMPDIR="$ORIG_TMPDIR"
}

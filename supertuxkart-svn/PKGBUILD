pkgname=supertuxkart-svn
_realname=supertuxkart
pkgver=6112
pkgrel=1
pkgdesc="A new and improved version of TuxKart, a kart racing game featuring Tux and his friends"
url="http://supertuxkart.sourceforge.net/"
arch=('i686' 'x86_64')
license=('GPL')
depends=('sdl>=1.2' 'libvorbis' 'freealut' 'libgl' 'freeglut' 'irrlicht' 'fribidi')
makedepends=('subversion')
provides=('supertuxkart')
conflicts=('supertuxkart' 'supertuxkart-alpha')

_svnmod="supertuxkart"
_svntrunk="https://supertuxkart.svn.sourceforge.net/svnroot/supertuxkart/main/trunk"

build() {
  msg "Starting SVN checkout..."
  cd $srcdir
    if [ -d $_svnmod/.svn ]; then
      (cd $_svnmod && svn up -r $pkgver)
    else
      svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
    fi
  msg "SVN checkout done or server timeout"

  msg "Starting make..."
  #if [ -d ${srcdir}/$_svnmod-build ]; then
  #  rm -r $_svnmod-build
  #fi
  #cp -r $_svnmod $_svnmod-build
  #cd $_svnmod-build

  cd supertuxkart
  ./autogen.sh
  ./configure --prefix=/usr --datadir=/usr/share || return 1

  # Fix compilation failure: http://bugs.gentoo.org/283490
  sed -i 's/-lGL/-lGL -lGLU/' config.status

  # those configure flags really mean nothing...
  sed -i "s#/usr/local#/usr#" src/io/file_manager.cpp
  
  
  if grep -Rl "/games" * > /dev/null 2>&1
    then
      sed -i "s#/games##" $(grep -Rl "/games" *)
  fi

  make || return 1
  make DESTDIR=${pkgdir} install || return 1

  # fix executable location...
  install -dm755 ${pkgdir}/usr/bin
  mv ${pkgdir}/usr/supertuxkart ${pkgdir}/usr/bin/supertuxkart
  sed -i "s#usr/supertuxkart#usr/bin/supertuxkart#" ${pkgdir}/usr/share/applications/supertuxkart.desktop
}

# Bacula: Installer: Arch
# Contributor: Gour <gour@gour-nitai.com>
# Contributor: Chris Giles <Chris.G.27 (at) Gmail.com>
# Contributor: Calogero Lo Leggio <kalos@autistici.org>

pkgname=bacula-postgresql
_pkgname=bacula
pkgver=5.0.3
pkgrel=1
pkgdesc="A network backup tool for Linux, Unix, Mac and Windows. This is the PostgreSQL edition."
arch=("i686" "x86_64")
url="http://www.${_pkgname}.org"
license=("GPL")
depends=('postgresql-libs' 'ncurses' 'openssl' 'qt' 'qwt')
conflicts=("${_pkgname}-sqlite" "${_pkgname}-postgresql" "${_pkgname}-client")
backup=("etc/${_pkgname}/${_pkgname}-dir.conf" "etc/${_pkgname}/${_pkgname}-fd.conf" "etc/${_pkgname}/${_pkgname}-sd.conf" "etc/${_pkgname}/bconsole.conf" "etc/${_pkgname}/bat.conf" "etc/${_pkgname}/tray-monitor.conf")
install=(${pkgname}.install)

source=(http://downloads.sourceforge.net/sourceforge/${_pkgname}/${_pkgname}-${pkgver}.tar.gz)
md5sums=('9de254ae39cab0587fdb2f5d8d90b03b')

build() {
	cd ${srcdir}/${_pkgname}-${pkgver}

	# Build
	./configure --prefix=/usr \
	  --enable-build-dird --enable-build-stored --enable-smartalloc \
      --enable-bat --enable-tray-monitor \
	  --with-postgresql --without-openssl --with-tcp-wrappers \
	  --with-dir-user=${_pkgname} --with-dir-group=${_pkgname} \
	  --with-sd-user=${_pkgname} --with-sd-group=${_pkgname} \
	  --sysconfdir=/etc/${_pkgname} --with-scriptdir=/etc/${_pkgname}/scripts \
	  --with-working-dir=/var/cache/${_pkgname}/working \
	  --with-subsys-dir=/var/cache/${_pkgname}/working \
	  --with-archivedir=/var/cache/${_pkgname}/archive || return 1

	make || return 1
	make DESTDIR=${pkgdir} install || return 1

	# Permissions
	chmod a+x ${pkgdir}/etc/${_pkgname}/scripts/{update_${_pkgname}_tables,delete_catalog_backup,\
update_postgresql_tables,make_catalog_backup,bconsole}

	# Daemons
	#install -D -m755 ${startdir}/extra/${pkgname}-{dir,fd,sd} ${pkgdir}/etc/rc.d/${pkgname}-{dir,fd,sd}
	mkdir -p ${pkgdir}/etc/rc.d/
    #ln -s /usr/sbin/${pkgname} ${pkgdir}/etc/rc.d/
	cp --preserve=mode ${startdir}/extra/${_pkgname}-* ${pkgdir}/etc/rc.d/ || return 1
    cp --preserve=mode ${startdir}/src/${_pkgname}-${pkgver}/src/qt-console/bat.conf ${pkgdir}/etc/${_pkgname}/ || return 1
    cp --preserve=mode ${startdir}/src/${_pkgname}-${pkgver}/src/tray-monitor/tray-monitor.conf ${pkgdir}/etc/${_pkgname}/ || return 1
	# Logs
	install -D -m644 ${srcdir}/${_pkgname}-${pkgver}/scripts/logrotate ${pkgdir}/etc/logrotate.d/${_pkgname}
	sed -i "s|/var/cache/${pkgname}/working/log|/var/log/${pkgname}.log|g" ${pkgdir}/etc/{${_pkgname}/${_pkgname}-dir.conf,\
logrotate.d/${_pkgname}} || return 1
}

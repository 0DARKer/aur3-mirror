# Maintainer: Marat "Morion" Talipov <morion.self@gmail.com>

pkgname=keepassx2
pkgver=alpha5
pkgrel=5
pkgdesc="Crossplatform port of Windows' application  ''KeePass Password Safe''"
arch=('i686' 'x86_64')
url="https://www.keepassx.org/dev/"
license=('GPLv2, GPLv3')
depends=('libgcrypt' 'libxtst' 'qt4')
makedepends=('intltool' 'cmake')
conflicts=('keepassx' 'keepassx2-git')
install=.INSTALL
source=("https://www.keepassx.org/dev/attachments/download/56/keepassx-2.0-${pkgver}.tar.gz" 
		'keepassx2.xml'
		'0001-Fix-build-with-gcrypt-1.6.0.patch')
md5sums=('0d70aafb32504a639f536a2854236c01'
         '869806ef3a84103fb002c70afd3c39e7'
	  '4ac20bb49f40788d512ef07c8b2a680f')

_cmake_keys="-DWITH_GUI_TESTS=ON
             -DCMAKE_VERBOSE_MAKEFILE=ON
             -DCMAKE_INSTALL_PREFIX=/usr
	     -DCMAKE_BUILD_TYPE=Release"

_patch_file=0001-Fix-build-with-gcrypt-1.6.0.patch

build() {
	cd "$srcdir/keepassx-2.0-$pkgver"

	#patch
 	patch -Np1 -i "${srcdir}/$_patch_file" 
	#

	if [[ -d build ]]; then
		rm -rf build
	fi
	mkdir build && cd build
	msg "Building ..." 
	cmake $_cmake_keys ..
	make clean
	make
}

package() {
	cd "$srcdir/keepassx-2.0-$pkgver/build"	
	make DESTDIR="${pkgdir}" install
	
	#dirs
	install -dm 755 "${pkgdir}"/usr/share/applications
	install -dm 755 "${pkgdir}"/usr/share/mime/packages
	
	#files	
	install -m 644 "${srcdir}"/keepassx2.xml "${pkgdir}"/usr/share/mime/packages
		 
	msg "Removing build directory..."
	cd "$srcdir/keepassx-2.0-$pkgver"
	rm -rf build
	msg "Done"
}

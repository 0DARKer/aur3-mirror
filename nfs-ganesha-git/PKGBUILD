# Maintainer: Thomas Favre-Bulle <thomas.favre-bulle at bull dot net>
pkgname=nfs-ganesha-git
pkgver=2.1.dev_15.r0.g2de184b
pkgrel=1
pkgdesc="User space NFS server"
arch=(x86_64)
url="https://github.com/nfs-ganesha/nfs-ganesha/wiki"
license=('LGPL3')
depends=('dbus' 'git')
makedepends=('git' 'cmake' 'bison' 'flex' 'doxygen' 'krb5' 'dbus' 'xfsprogs' 'nfsidmap' 'libwbclient' 'libcap')
optdepends=('jemalloc: more scalable malloc implementation')
provides=('nfs-ganesha')
conflicts=('nfs-ganesha')
source=("$pkgname"::'git://github.com/nfs-ganesha/nfs-ganesha.git#branch=next'
        'ganesha.conf'
        'dbus.nfs-ganesha.conf'
        'nfs-ganesha.service')
md5sums=('SKIP'
         '7af77a5c3b9e00fd24b91741f8ed0f70'
         'e5590aea4cd82ff56d2236e253197158'
         'cd2c3e71ae90418fb40ea614feba81e1')

pkgver() {
  cd "$srcdir/$pkgname"
  # Use the tag of the last commit
  git describe --long | sed -r 's/^V//;s/([^-]*-g)/r\1/;s/-/./g'
}

prepare() {
  cd "$srcdir/$pkgname"
  git submodule init
  git config submodule.ntirpc.url $srcdir/src/libntirpc
  git submodule update
}

build() {
  cd "$srcdir/$pkgname/src"
  cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_CONFIG=everything -DCMAKE_INSTALL_PREFIX=/usr .
  make
}

package() {
  cd "$srcdir/$pkgname/src"
  make DESTDIR="$pkgdir/" install
  mkdir -p "$pkgdir/etc/ganesha"
  install -Dm644 "$srcdir/nfs-ganesha.service" "$pkgdir/usr/lib/systemd/system/nfs-ganesha.service"
  install -Dm644 "$srcdir/ganesha.conf" "$pkgdir/etc/ganesha/ganesha.conf"
  install -Dm644 "$srcdir/dbus.nfs-ganesha.conf" "$pkgdir/etc/dbus-1/system.d/nfs-ganesha.conf"
  install -Dm644 "$srcdir/$pkgname/src/LICENSE.txt" "$pkgdir/usr/share/licences/nfs-ganesha/LICENSE.txt"
}

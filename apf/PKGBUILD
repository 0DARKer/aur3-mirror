# Maintainer: sup3rm4n <sup3rm4n at aur dot archlinux dot org>
# last updated: 7/31/2014 (pkgrel: 5)

pkgname=('apf')
pkgdesc='Advanced Policy Firewall (APF) is an iptables(netfilter) based firewall system designed around the essential needs of todays Linux servers.'
conflicts=('apf-firewall')
replaces=('apf-firewall')
pkgver=9.7.2
pkgrel=5
_pkgver=9.7-2
backup=('etc/apf/conf.apf')
depends=('iptables' 'iproute2' 'diffutils' 'net-tools')
optdepends=('wget')
arch=('i686' 'x86_64')
license=('GPL2')
url='http://www.rfxn.com/projects/advanced-policy-firewall'
source=('apf.patch'
        'apf.init'
        'apf.service'
        'http://www.rfxn.com/downloads/apf-current.tar.gz')

sha256sums=('a5a4848865ca51cba0455d9dddbf5b5dd0a44cae9bf589eef9a72d402d10a70c'
            '317c84f00b3a54e1f0877f1e68334e4320586d72c7deb363e412c3cb114c69f8'
            '7c6bdf3e221df1c56010d75fe9f858878644700f2cf7ce9661c74c8aac75aff2'
            '793d83ca2657b86b86a23b1c3fe08ee436df8c4a83ef84c92f0f11689531a2cc')

build() {
  cd ${srcdir}/${pkgname}-${_pkgver}
  msg "Patching apf source"
  patch -p1 -i ../apf.patch
}

package() {
  install=${pkgname}.install
  install -D -m755 apf.init ${pkgdir}/etc/rc.d/apf
  install -D -m644 apf.service ${pkgdir}/etc/systemd/system/apf.service
  cd ${srcdir}/${pkgname}-${_pkgver}
  mkdir -p ${pkgdir}/etc/apf/{extras,doc,vnet}
  cp README CHANGELOG COPYING.GPL ${pkgdir}/etc/apf/doc
  cp -R files/* ${pkgdir}/etc/apf
  chmod -R 640 ${pkgdir}/etc/apf/*
  cp -p .ca.def importconf ${pkgdir}/etc/apf/extras
  chmod 750 ${pkgdir}/etc/apf/firewall ${pkgdir}/etc/apf/apf ${pkgdir}/etc/apf/vnet/vnetgen \
    ${pkgdir}/etc/apf/extras/get_ports ${pkgdir}/etc/apf/extras/dshield/install ${pkgdir}/etc/apf
  install -D -m644 logrotate.d.apf ${pkgdir}/etc/logrotate.d/apf
  #install -D -m644 cron.daily ${pkgdir}/etc/cron.daily/apf
  install -D -m644 COPYING.GPL ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
  mkdir -p ${pkgdir}/usr/local/sbin
  ln -s /etc/apf/apf ${pkgdir}/usr/local/sbin/apf
  ln -s /etc/apf/apf ${pkgdir}/usr/local/sbin/fwmgr
}

# Contributor: <kontakt.zuf@gmail.com>
pkgname=redcar-git
pkgver=20090626
pkgrel=1
pkgdesc="Redcar is an open-source programmers text editor for Gnome. It is designed to be compatible with Textmate bundles"
arch=('i686' 'x86_64')
url="http://redcareditor.com/"
license=('GPL2')
depends=('rubygems' 'ruby-gnome2' 'vala' 'libgee' 'oniguruma' 'ruby-gconf2' 'gtksourceview2' 'xulrunner' 'ruby-dbus' 'libwebkit' )
makedepends=('git' 'wget')
optdepends=(
'rake: to build this. You can use gem if you want. Run sudo gem install rake'
'oniguruma: sudo gem install oniguruma'
'activesupport: sudo gem install activesupport'
'rspec: sudo gem install rspec'
'cucumber: sudo gem install cucumber'
'hoe: sudo gem install hoe'
'open: sudo gem install open'
'zerenity: sudo gem install zerenity'
)
install=${pkgname}.install

provides=('redcar')
conflicts=('redcar' 'redcar-git')
source=()
md5sums=()

_gitroot="git://github.com/danlucraft/redcar.git"
_gitname="redcar"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d "$srcdir/$_gitname" ] ; then
    cd $_gitname
    git pull origin
    #cd redcar
    git submodule update
    msg "The local files are updated."
  else
    git clone $_gitroot
    msg "Connecting to GIT server...."
    cd redcar
    git checkout stable
    msg "Git submodule init...."
    git submodule init
    git submodule update
  fi

  msg "Git checkout done or server timeout"

  msg "Download some headers (rbgdkconversions.h, rbgtkconversions.h)"
  msg "We need to copy them to /usr/lib/ruby/1.8/x86_64-linux/ (for x86_64) or /usr/lib/ruby/1.8/i686-linux/ (for i686)"
  msg "So you may need to type sudo password."

  cd ..
  wget "redcareditor.com/stuff/missing_x64_headers/rbgdkconversions.h"
  wget "redcareditor.com/stuff/missing_x64_headers/rbgtkconversions.h"
  if [ "$CARCH" = "x86_64" ]; then
      sudo mv rbgdkconversions.h /usr/lib/ruby/1.8/x86_64-linux/      # for x86_64
      sudo mv rbgtkconversions.h /usr/lib/ruby/1.8/x86_64-linux/      # for x86_64
    else 
      sudo mv rbgdkconversions.h /usr/lib/ruby/1.8/i686-linux/   # for i686
      sudo mv rbgtkconversions.h /usr/lib/ruby/1.8/i686-linux/   # for i686
  fi

  msg "Please install additional ruby gems to build me."
  msg "Run this command: sudo gem install oniguruma activesupport rspec cucumber hoe open4 zerenity"

  msg "Starting rake..."

  rm -r "$srcdir/$_gitname-build"
  cp -r "$srcdir/$_gitname" "$startdir/src/$_gitname-build"
  cd "$srcdir/$_gitname-build"
  
  #
  # BUILD HERE
  #

  rake build

  mkdir -p  ${startdir}/pkg/usr/share/applications
  mkdir -p  ${startdir}/pkg/opt/redcar
  cp -a ./* ${startdir}/pkg/opt/redcar
  
  # Install .desktop file
  install -D -m644 ${startdir}/Redcar.desktop ${startdir}/pkg/usr/share/applications/Redcar.desktop || return 1
} 

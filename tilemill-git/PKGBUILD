# Contributor: Jonas Heinrich <onny@project-insanity.org>
# Maintainer: Jonas Heinrich <onny@project-insanity.org>

# check: try to build and start in a clean x32 environement (cause of missing deps)
# todo:
#   - fix npm-mapnik build (missing python 3 compatibility)

pkgname=tilemill-git
_pkgname=tilemill
pkgver=v0.10.1.86.g6f95518
pkgrel=1
pkgdesc="A modern map design studio"
arch=(any)
url="https://github.com/mapbox/tilemill"
license=(BSD)
depends=('nodejs' 'mapnik') # desktop-file-utils webkitgtk2)
source=('git+https://github.com/mapbox/tilemill.git'
        'tilemill.png'
        'tilemill.desktop'
        'tilemill.install')
sha1sums=('SKIP'
          '350bbce4e2a3a338123e919f050c418d317a7862'
          '9aced645fcc1407e7a0cb864a48501e3048a4c37'
          'f011df5ca2f0597ddd51c4d5f1b365caa0c7c847')

pkgver() {
  cd "$SRCDEST/${_pkgname}"
  git describe --always | sed 's|-|.|g'
}

prepare() {
  cd "$srcdir/${_pkgname}"

  # fix dependency version checks (unstable solution)
  sed -i '/npm/s/~1.1.50/~1.3.2/' package.json
}

package() {
  cd "$srcdir/${_pkgname}"

  mkdir -p "$pkgdir/usr"
  npm install -d -g --prefix "$pkgdir/usr"

  #cd $pkgdir/usr/lib/node_modules/tilemill/node_modules/tilelive-mapnik
  #npm install eio@0.2.0

  # icon and .desktop files
  install -Dm644 $srcdir/tilemill.png "$pkgdir/usr/share/pixmaps/tilemill.png"
  install -Dm644 $srcdir/tilemill.desktop "$pkgdir/usr/share/applications/tilemill.desktop"
  install -Dm644 $pkgdir/usr/lib/node_modules/tilemill/LICENSE.md "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}
# vim:set ts=2 sw=2 et:

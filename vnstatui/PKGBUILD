# Maintainer: Josh VanderLinden <arch@cloudlery.com>
pkgname=vnstatui
pkgver=r24.1565c78
pkgrel=1
pkgdesc="Basic web UI that displays traffic graphs from vnstat"
arch=('any')
url="http://bitbucket.org/instarch/vnstat-ui"
license=('BSD')
depends=('vnstat' 'python' 'python-bottle' 'python-distribute' 'gd' 'uwsgi' 'uwsgi-plugin-python')
makedepends=('git' 'python-docutils')
optdepends=(
  'nginx: fast server to proxy requests to vnstatui'
)
backup=(
  'etc/conf.d/vnstatui.conf'
  'etc/nginx/sites-available/vnstatui.conf'
)
source=(
  'vnstatui.service'
  'vnstatui.conf'
  'vnstatui.nginx'
  'vnstatui.ini'
)
md5sums=('0fc05320ba090948b060128e571588d3'
         '0ad51f94346ee21b904d60137f094c66'
         'e92c608e35b68b97f043029fc6cc72cd'
         '99bcedeb0ec10d8ef9454b9d7a9c8a1e')

_gitroot=http://bitbucket.org/instarch/vnstat-ui
_gitname=vnstatui-git

pkgver() {
  cd "${srcdir}"
  printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "${srcdir}"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]; then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
}

package() {
  cd "$srcdir/$_gitname-build"

  python3 setup.py install --optimize=1 --root="${pkgdir}/"
  install -Dm644 vnstatui/index.tpl "${pkgdir}/usr/lib/python3.3/site-packages/vnstatui/index.tpl"
  install -Dm644 ../vnstatui.ini "${pkgdir}/usr/lib/python3.3/site-packages/vnstatui/vnstatui.ini"

  msg "Copying configuration files"
  install -Dm644 vnstatui.conf "${pkgdir}/etc/conf.d/vnstatui.conf"
  install -Dm644 vnstatui.nginx "${pkgdir}/etc/nginx/sites-available/vnstatui.conf"
  install -Dm644 vnstatui.service "${pkgdir}/usr/lib/systemd/system/vnstatui.service"
  install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  msg "Creating manpage"
  rst2man README.rst | gzip > vnstatui.1.gz
  install -Dm644 vnstatui.1.gz "${pkgdir}/usr/share/man/man1/vnstatui.1.gz"

  msg "Generating HTML version of license"
  rst2html LICENSE > "${pkgdir}/usr/lib/python3.3/site-packages/vnstatui/license.html"
}

# vim:set ts=2 sw=2 et:

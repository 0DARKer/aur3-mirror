pkgname=mingw32-yaml-cpp
pkgver=0.2.6
pkgrel=1
pkgdesc="C++ API for YAML (mingw32)"
license=('MIT')
arch=('any')
url="http://code.google.com/p/yaml-cpp/"
depends=('mingw32-gcc')
makedepends=('cmake')
source=(http://yaml-cpp.googlecode.com/files/yaml-cpp-${pkgver}.tar.gz
compile-gcc46.patch)
options=(!strip)
md5sums=('ddfa5e8d409d9dafbeb6d190cd68dbcb'
         '924036c31bd8f0ca8900896c9df67f3e')
mingw32=i486-mingw32

build() {
  # mingw32 has problems with --hash-style=gnu (default value)
  unset LDFLAGS

  cd "${srcdir}/yaml-cpp"
  echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
  echo "SET(CMAKE_C_COMPILER ${mingw32}-gcc)" >> win32.cmake
  echo "SET(CMAKE_CXX_COMPILER ${mingw32}-g++)" >> win32.cmake
  echo "SET(CMAKE_RC_COMPILER ${mingw32}-windres)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH /usr/${mingw32})" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
  patch -Np1 -i "${srcdir}/compile-gcc46.patch" || return 1
  cmake . \
    -DCMAKE_TOOLCHAIN_FILE=win32.cmake \
    -DCMAKE_INSTALL_PREFIX=/usr/${mingw32}
  make || return 1
  make install DESTDIR=$pkgdir || return 1
}


# Maintainer: Maxim Andersson <thesilentboatman@gmail.com>
# Based on the mailpile-git PKGBUILD
# Contributor: cornholio <vigo.the.unholy.carpathian@gmail.com>

pkgname=mailpile
pkgver=0.1.0
pkgrel=1
pkgdesc="A modern, fast web-mail client with user-friendly encryption and privacy features."
arch=('any')
url="http://www.mailpile.is"
license=('AGPL3','Apache')
depends=('python2-pillow' 'python2-lxml' 'python2-jinja' 'spambayes')
install=${pkgname}.install
source=("https://github.com/pagekite/${pkgname}/archive/${pkgver}.tar.gz")
sha256sums=('10a33280f16ed78ed1b463d751b8598fa2b4d3f57c213c97fd455c0f17acfb7c')

prepare() {
  cd "${srcdir}/Mailpile-${pkgver}"

  # python2 fixes
  sed -i 's^bin/python^bin/python2^g' mailpile/plugins/vcard_mork.py
  sed -i 's^python ^python2 ^g' Makefile

  # Set absolute paths for static files
  sed -i "s^('static/^('/usr/share/mailpile/static/^g" mailpile/config.py
  sed -i "s^'static/^'/usr/share/mailpile/static/^g" mailpile/defaults.py
  sed -i '/os.path.dirname(              # scripts/d' mp
  sed -i 's^__file__))^"/usr/share/mailpile/mailpile")^g' mp
}

build() {
  cd "${srcdir}/Mailpile-${pkgver}"

  # Compile bytecode
  python2 -c 'import compileall; compileall.compile_dir("mailpile", force=1)'
}

package() {
  install -d "${pkgdir}/usr/share/${pkgname}"

  cp -r "${srcdir}/Mailpile-${pkgver}/static" "${pkgdir}/usr/share/${pkgname}/"
  cp -r "${srcdir}/Mailpile-${pkgver}/mailpile" "${pkgdir}/usr/share/${pkgname}/"
  cp -r "${srcdir}/Mailpile-${pkgver}/locale" "${pkgdir}/usr/share/${pkgname}/"

  find "${pkgdir}/usr/share/${pkgname}" -type f -exec chmod 644 '{}' ';'
  find "${pkgdir}/usr/share/${pkgname}" -type d -exec chmod 755 '{}' ';'

  install -D "${srcdir}/Mailpile-${pkgver}/mp" "${pkgdir}/usr/bin/mp"
}

# vim:set ts=2 sw=2 et:

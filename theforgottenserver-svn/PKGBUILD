# Contributor: zoulnix <z[o]ulnix.borke[dd]uck.c[o]m>
pkgname=theforgottenserver-svn
pkgver=80
_pkgver=0.3.6pl1
pkgrel=1
pkgdesc="Server based on OpenTibia."
arch=('i686' 'x86_64')
url="http://forgottenserver.sourceforge.net/"
license=('GPL')
depends=('boost' 'gmp' 'libxml2' 'lua' 'libmysqlclient' 'sqlite3')
makedepends=('autoconf' 'automake' 'gcc' 'make' 'pkgconfig' 'subversion')
options=('!libtool')
provides=('theforgottenserver')
conflicts=('theforgottenserver')
backup=('etc/theforgottenserver/config.lua')
source=()
md5sums=('')

_svnmod="theforgottenserver"
_svntrunk="http://svn.otland.net/public/forgottenserver/tags/${_pkgver}"

build() { 
  cd ${srcdir}
  install -d ${pkgdir}/usr/share/${_svnmod}/schemas ${pkgdir}/usr/bin \
	     ${pkgdir}/etc/${_svnmod} || return 1

  #####
  msg "Getting sources..."
  if [ -d ${_svnmod}/.svn ]; then
    (cd ${_svnmod} && svn up -r ${pkgver})
  else
    svn co ${_svntrunk} --config-dir ./ -r ${pkgver} ${_svnmod}
    cd ${_svnmod}
  fi

  msg "SVN checkout done or server timeout"
  msg "Starting make..."
  #####

  # Generating build system
  ./autogen.sh || return 1

  ./configure --prefix=/usr \
	      --sysconfdir=/etc/theforgottenserver \
	      --localstatedir=/var \
	      --disable-static \
	      --enable-server-diag \
	      --enable-homedir-conf \
	      --enable-mysql \
	      --enable-sqlite

  make || return 1

  cp -r data ${pkgdir}/usr/share/${_svnmod}/
  install -m755 ${_svnmod} ${pkgdir}/usr/bin/ || return 1
  install -m644 config.lua ${pkgdir}/etc/${_svnmod}/ || return 1
  install -m644 schemas/*.sql ${pkgdir}/usr/share/${_svnmod}/schemas/ || return 1
  install -m644 forgottenserver.s3db ${pkgdir}/usr/share/${_svnmod}/ || return 1

  # Removing unnecessary stuff
  find ${pkgdir} -type d -name ".svn" -exec rm -rf {} \;
  msg "..."
}
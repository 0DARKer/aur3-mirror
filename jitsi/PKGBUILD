# Jitsi (formerly SIP-Communicator): Installer: Arch
# Maintainer: Ananda Samaddar ananda@samaddar.co.uk
# Contributor: Xavion <Xavion (dot) 0 (at) Gmail (dot) com>
# Contributor: atommix aka Aleks Lifey <Aleks.Lifey@gmail.com>
# Contributor: Keshav P R <(skodabenz) (aatt) (rocketmail) (ddoott) (ccoomm)>

_oldname="sip-communicator"
_pkgname="jitsi"
pkgname="${_pkgname}"

_relver="1.0"
_devver="beta1"

_pseudo_buildver="3578"

## Taken from http://gitorious.org/arch-linux-greece/arch-linux-greece/blobs/master/list-of-sources/adslgr64/songbird-nightly/PKGBUILD
_build_number() {
	
	wget -qO - "http://download.jitsi.org/jitsi/src/" \
		| grep -m 1 "href=\"${_pkgname}-src-${_relver}-${_devver}-nightly.build" \
		| sed "s#.*${_pkgname}-src-${_relver}-${_devver}-nightly.build.##g" \
		| sed 's#.zip.*##g'
	
}

_buildver="$(_build_number)"

pkgver="${_relver}.${_devver}.${_pseudo_buildver}" ## For AUR interface
true && pkgver="${_relver}.${_devver}.${_buildver}" ## Actual pkgver
pkgrel=1

pkgdesc="An audio/video SIP VoIP phone and instant messenger written in Java"
arch=("i686" "x86_64")
url="http://www.jitsi.org"
license=("GPL")
provides=("${_oldname}")
conflicts=("${_oldname}-nightly" "${_oldname}-svn")
depends=("java-runtime=6")
makedepends=("wget" "java-environment=6" "apache-ant")
options=(!strip !emptydirs zipman !libtool docs)

_actual_source_file="${_pkgname}-src-${_relver}-${_devver}-nightly.build.${_buildver}.zip"
_actual_source_url="http://download.jitsi.org/jitsi/src/${_actual_source_file}"

source=("${_pkgname}.desktop"
		"${_pkgname}.sh")

sha256sums=('61e3bec3470790fa067f87d978016ec4452a6fd3dfba2c9afa5245b58d3cb19d'
			'3d95ab84527bf226301c9adb96dfd2a5792c8047e33b5ca4dadb5beaddd3a415 ')

_update_source() {
	
	cd "${srcdir}/"
	
	msg "Downloading..."
	wget -N -c "${_actual_source_url}"
	
	cd "${srcdir}/"
	
	rm -rf "${srcdir}/${_oldname}" || true
	
	msg "Extracting..."
	bsdtar -x -f "${srcdir}/${_actual_source_file}"
	
}

build() {
	
	_update_source
	
	cd "${srcdir}/${_pkgname}"
	
	# Build
	/usr/share/java/apache-ant/bin/ant rebuild
	
}

package() {
	
	cd "${srcdir}/${_pkgname}"
	
	install -d "${pkgdir}/usr/lib/${_pkgname}/lib"
	install -D "${srcdir}/${_pkgname}/lib"/*.* "${pkgdir}/usr/lib/${_pkgname}/lib/"
	install -D "${srcdir}/${_pkgname}/lib/os-specific/linux"/*.* "${pkgdir}/usr/lib/${_pkgname}/lib/"
	
	install -Dd "${srcdir}/${_pkgname}/lib/bundle" "${pkgdir}/usr/lib/${_pkgname}/lib/bundle"
	install -D "${srcdir}/${_pkgname}/lib/bundle"/*.* "${pkgdir}/usr/lib/${_pkgname}/lib/bundle/"
	
	install -Dd "${srcdir}/${_pkgname}/lib/native" "${pkgdir}/usr/lib/${_pkgname}/lib/native"
	
	if [ "${CARCH}" == 'x86_64' ]
	then
		install -D -m755 "${srcdir}/${_pkgname}/lib/native/linux-64"/*.* "${pkgdir}/usr/lib/${_pkgname}/lib/native/"
	else
		install -D -m755 "${srcdir}/${_pkgname}/lib/native/linux"/*.* "${pkgdir}/usr/lib/${_pkgname}/lib/native/"
	fi
	
	install -Dd "${srcdir}/${_pkgname}/sc-bundles" "${pkgdir}/usr/lib/${_pkgname}/sc-bundles"
	install -D "${srcdir}/${_pkgname}/sc-bundles"/*.* "${pkgdir}/usr/lib/${_pkgname}/sc-bundles/"
	install -D "${srcdir}/${_pkgname}/sc-bundles/os-specific/linux"/*.* "${pkgdir}/usr/lib/${_pkgname}/sc-bundles/"
	
	install -d "${pkgdir}/usr/share/pixmaps"
	install -D -m644 "${srcdir}/${_pkgname}/resources/install/debian/${_oldname}.svg" "${pkgdir}/usr/share/pixmaps/${_pkgname}.svg"
	install -D -m644 "${srcdir}/${_pkgname}/resources/install/debian/${_oldname}-16.xpm" "${pkgdir}/usr/share/pixmaps/${_pkgname}-16.xpm"
	install -D -m644 "${srcdir}/${_pkgname}/resources/install/debian/${_oldname}-32.xpm" "${pkgdir}/usr/share/pixmaps/${_pkgname}-32.svg"
	
	install -d "${pkgdir}/usr/share/applications"
	install -D -m644 "${srcdir}/${_pkgname}.desktop" "${pkgdir}/usr/share/applications/${_pkgname}.desktop"
	
	install -d "${pkgdir}/usr/bin"
	install -D -m755 "${srcdir}/${_pkgname}.sh" "${pkgdir}/usr/bin/${_pkgname}"
	
}

# Contributor: Connor Behan <connor.behan@gmail.com>

pkgname=instantbird
pkgver=1.3
pkgrel=1
pkgdesc="Instant messenger using libpurple and xulrunner"
arch=(i686 x86_64)
license=('MPL' 'GPL' 'LGPL')
url="http://instantbird.com"
depends=('xulrunner<17.0')
makedepends=('unzip' 'zip' 'pkg-config' 'diffutils' 'python2' 'wireless_tools' 'yasm' 'libidl2' 'mesa' 'autoconf2.13')
source=(http://instantbird.com/downloads/${pkgver}/${pkgname}-${pkgver}.src.tgz nss.patch libxul_fixes.patch mozconfig ${pkgname}.desktop)
options=('!buildflags')
_xulnum=`ls /usr/lib | grep -m1 xulrunner-devel | sed -e 's/.*-//'`

build() {
	cd "${srcdir}"/${pkgname}-${pkgver}-src

	cp "${srcdir}"/mozconfig .
	patch -Np1 -i ../nss.patch
	patch -Np1 -i ../libxul_fixes.patch
	echo "ac_add_options --with-libxul-sdk=/usr/lib/xulrunner-devel-"${_xulnum} >> mozconfig

	sed -i -e 's|-lz|-lz ../../$(DLL_PREFIX)purple$(DLL_SUFFIX)|' purple/libpurple/protocols/prpl.mk

	# May be affected by mozilla bug 559278
        CXXFLAGS="-std=gnu++0x" make -j1 -f client.mk build
}

package() {
	cd "${srcdir}"/obj-${pkgname}
	sed -i -e "s|.*mozilla/toolkit/locales.*||g" -e "s|.*mozilla/extensions/spellcheck/locales.*||g" instantbird/locales/Makefile
	make package
	cd mozilla/dist
	bsdtar -x -f ${pkgname}-${pkgver}.en-US.linux-${CARCH}.tar.bz2

	mkdir -p "${pkgdir}"/usr/bin
	mkdir -p "${pkgdir}"/usr/lib
	mkdir -p "${pkgdir}"/usr/share/pixmaps
	mkdir -p "${pkgdir}"/usr/share/applications
	cp -R ./instantbird "${pkgdir}"/usr/lib/instantbird
	cd "${pkgdir}"/usr/bin
	ln -s /usr/lib/instantbird/instantbird instantbird

	# Why does this get left out of the package?
	cp "${srcdir}"/obj-${pkgname}/purple/libpurple/libpurple.so "${pkgdir}"/usr/lib/instantbird

	# No idea why this is needed now
	cd "${pkgdir}"/usr/lib/instantbird
	ln -s /usr/lib/xulrunner-${_xulnum} xulrunner

	install -D -m 644 icons/mozicon50.xpm ../../share/pixmaps/instantbird.xmp
	install -D -m 644 "${srcdir}"/instantbird.desktop ../../share/applications/instantbird.desktop
}
md5sums=('a44f08a98ffbb3e430c8bd64e05de178' '42f95f835966fda21d15c687b72fb0e0' 'e587c55619389a79d7070067e81c8904' '10f760008d98c1a0353708d0dec4bf9d' 'eb364c644eb5a598909999b1c47260cc')

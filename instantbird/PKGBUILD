# Contributor: Connor Behan <connor.behan@gmail.com>

pkgname=instantbird
pkgver=1.1
pkgrel=2
pkgdesc="Instant messenger using libpurple and xulrunner"
arch=(i686 x86_64)
license=('MPL' 'GPL' 'LGPL')
url="http://instantbird.com"
depends=('xulrunner>=7.0')
makedepends=('unzip' 'zip' 'pkg-config' 'diffutils' 'python2' 'wireless_tools' 'yasm' 'libidl2' 'mesa' 'autoconf2.13')
source=(http://instantbird.com/downloads/${pkgver}/${pkgname}-${pkgver}.src.tgz nss.patch python2.7.patch mozconfig ${pkgname}.desktop)
options=('!buildflags')
_xulnum=`ls /usr/lib | grep -m1 xulrunner-devel | sed -e 's/.*-//'`

build() {
	cd ${srcdir}/${pkgname}-${pkgver}-src
	cp ${srcdir}/mozconfig .
	patch -Np1 -i ../nss.patch || return 1
	patch -Np1 -i ../python2.7.patch || return 1
	echo "ac_add_options --with-libxul-sdk=/usr/lib/xulrunner-devel-"${_xulnum} >> mozconfig
	sed -i -e 's|\$LIBXUL_SDK/sdk|\$LIBXUL_SDK|g' configure.in

	# May be affected by mozilla bug 559278	
        CXXFLAGS="-std=gnu++0x" make -j1 -f client.mk build MOZ_MAKE_FLAGS="$MAKEFLAGS" || return 1
}

package() {
	cd ${srcdir}/obj-${pkgname}
	sed -i -e "s|.*mozilla/toolkit/locales.*||g" -e "s|.*mozilla/extensions/spellcheck/locales.*||g" instantbird/locales/Makefile
	make package || return 1
	cd mozilla/dist
	bsdtar -x -f ${pkgname}-${pkgver}.en-US.linux-${CARCH}.tar.bz2

	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/lib
	mkdir -p ${pkgdir}/usr/share/pixmaps
	mkdir -p ${pkgdir}/usr/share/applications
	cp -R ./instantbird ${pkgdir}/usr/lib/instantbird
	cd ${pkgdir}/usr/bin
	ln -s /usr/lib/instantbird/instantbird instantbird
	cd ${pkgdir}/usr/lib/instantbird
	# No idea why this is needed now
	ln -s /usr/lib/xulrunner-${_xulnum} xulrunner
	install -D -m 644 icons/mozicon50.xpm ../../share/pixmaps/instantbird.xmp
	install -D -m 644 ${srcdir}/instantbird.desktop ../../share/applications/instantbird.desktop
}
md5sums=('dccfa45c932f3685933867e2b3f2350a' '4f7bbaf0aeb48c6a0c0611f0ee27f586' 'e208958a011621ce56614dc1213d560f' '6aaa7fbc7276a552196a7e06acb0c5e8' 'eb364c644eb5a598909999b1c47260cc')

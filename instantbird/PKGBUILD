# Contributor: Connor Behan <connor.behan@gmail.com>

pkgname=instantbird
pkgver=1.0
pkgrel=4
pkgdesc="Instant messenger using libpurple and xulrunner"
arch=(i686 x86_64)
license=('MPL' 'GPL' 'LGPL')
url="http://instantbird.com"
depends=('xulrunner>=2.0')
makedepends=('zip' 'pkg-config' 'diffutils' 'python2' 'wireless_tools' 'yasm' 'mesa' 'autoconf2.13')
source=(http://instantbird.com/downloads/${pkgver}/${pkgname}-${pkgver}.src.tgz nss.patch python2.7.patch mozconfig ${pkgname}.desktop)
_xulnum=`ls /usr/lib | grep -m1 xulrunner-devel | sed -e 's/.*-//'`

build() {
	cd ${srcdir}/${pkgname}-${pkgver}-src
	cp ${srcdir}/mozconfig .
	patch -Np1 -i ../nss.patch || return 1
	patch -Np1 -i ../python2.7.patch || return 1
	echo "ac_add_options --with-libxul-sdk=/usr/lib/xulrunner-devel-"${_xulnum} >> mozconfig
	sed -i -e 's|\$LIBXUL_SDK/sdk|\$LIBXUL_SDK|g' configure.in
	
	autoconf-2.13 || return 1
	make -j1 -f client.mk build || return 1
	cd ../obj-instantbird
	sed -i -e "s|.*mozilla/toolkit/locales.*||g" instantbird/locales/Makefile
	sed -i -e "s|.*mozilla/extensions/spellcheck/locales.*||g" instantbird/locales/Makefile
	make package || return 1
	
	cd mozilla/dist
	bsdtar -x -f ${pkgname}-${pkgver}.en-US.linux-${CARCH}.tar.bz2
	mkdir -p ${pkgdir}/usr/bin
	mkdir -p ${pkgdir}/usr/lib
	cp -R ./instantbird ${pkgdir}/usr/lib/instantbird
	cd ${pkgdir}/usr/bin
	ln -s /usr/lib/instantbird/instantbird instantbird

	mkdir -p ${pkgdir}/usr/share/pixmaps
	mkdir -p ${pkgdir}/usr/share/applications
	install -D -m 644 "${pkgdir}/usr/lib/instantbird/icons/mozicon50.xpm" "${pkgdir}/usr/share/pixmaps/instantbird.xpm"
	install -D -m 644 "${srcdir}/instantbird.desktop" "${pkgdir}/usr/share/applications/instantbird.desktop"
}
md5sums=('9017752636108dfc71e001ab274da11a' '4f7bbaf0aeb48c6a0c0611f0ee27f586' 'e208958a011621ce56614dc1213d560f' '6aaa7fbc7276a552196a7e06acb0c5e8' 'eb364c644eb5a598909999b1c47260cc')

# Maintainer: goll <adrian.goll+aur[at]gmail>

pkgname='sslyze'
pkgver=0.10
pkgrel=1
pkgdesc="Fast and full-featured SSL scanner."
arch=('i686' 'x86_64')
url=('https://github.com/nabla-c0d3/sslyze')
license=('GPLv2')
depends=('python2')
makedepends=('unzip')
noextract=('sslyze-0_10-linux64.zip'
	   'sslyze-0_10-linux32.zip')

source=("https://github.com/nabla-c0d3/sslyze/releases/download/release-${pkgver}/${pkgname}-${pkgver/./_}-linux64.zip"
        "https://github.com/nabla-c0d3/sslyze/releases/download/release-${pkgver}/${pkgname}-${pkgver/./_}-linux32.zip")

sha1sums=('5b17aee4802f3c4bbc74b8e10f131522a4dbb320'
          'd9ed490681d44c4c9d69a03ecb0bf4283c0de7c1')

prepare() {
        if test "$CARCH" == x86_64;then
		cd $srcdir && unzip -qqo ${pkgname}-${pkgver/./_}-linux64.zip && find $pkgname/ -type d -exec chmod 755 {} +
	else
		cd $srcdir && unzip -qqo ${pkgname}-${pkgver/./_}-linux32.zip && find $pkgname/ -type d -exec chmod 755 {} +
	fi
}

package() {
	# Install files in /opt
        mkdir -p "$pkgdir/opt/sslyze"
        if test "$CARCH" == x86_64;then
		cp -a $srcdir/${pkgname}/. $pkgdir/opt/sslyze
		rm -rf $srcdir/${pkgname}/
	else
		cp -a $srcdir/${pkgname}/. $pkgdir/opt/sslyze
		rm -rf $srcdir/${pkgname}/
	fi
	grep -rl "env python" $pkgdir/opt/sslyze | xargs sed -i 's/env python/env python2/g'
	# Create an indirect launcher in /usr/bin
	mkdir -p "$pkgdir/usr/bin"

	cat > "$pkgdir/usr/bin/sslyze" << EOF
#!/bin/bash
cd /opt/sslyze && python2 sslyze.py \$@
cd \$OLDPWD
EOF
	chmod 755 "$pkgdir/usr/bin/sslyze"
}

pkgname="radare2-hg"
pkgver=2041
pkgrel=1
pkgdesc="A collection of tools with the aim to create a complete, portable, multi-architecture, unix-like toolchain for reverse engineering."
arch=('i686' 'x86_64')
url="http://radare.org"
license=('GPL3')
depends=('vala' 'valabind-hg')
makedepends=('mercurial')
provides=('radare2' 'r2-bindings')
conflicts=('radare2' 'r2-bindings')

_hgroot="http://radare.org/hg"
_hgrepo="radare2"

build() {
  cd ${srcdir}

  if [ -x ${_hgrepo}-build ] ; then
    msg "Removing leftovers..."
    rm -rf ${_hgrepo}-build
  fi

  if [ -d ${_hgrepo} ]; then
    cd ${_hgrepo}
    hg pull -u || true
  else
    hg clone ${_hgrepo}
  fi

  cd ${srcdir}
  hg clone ${_hgrepo} ${_hgrepo}-build
  cd ${_hgrepo}-build

  msg "Building radare2..."
  ./configure --prefix=/usr
  export LDFLAGS="${LDFLAGS//-Wl,--as-needed}"
  export CFLAGS="${CFLAGS//-fPIE -pie}"
  make

  msg "Building language bindings..."
  cd r2-bindings
  make clean
  PKG_CONFIG_PATH="$PKG_CONFIG_PATH:${srcdir}/${_hgrepo}-build/pkgcfg" ./configure --prefix=/usr --enable-devel --enable=python
  make python2
}

package() {
  cd ${srcdir}/${_hgrepo}-build

  make DESTDIR=${pkgdir} install
  install -d "${pkgdir}/usr/share/man/man1"
  install -m644 man/* "${pkgdir}/usr/share/man/man1"

  cd r2-bindings
  make DESTDIR=${pkgdir} install-vapi
  make DESTDIR=${pkgdir} PYTHON=python2.7 install-python

  cd ${srcdir}
  rm -rf ${_hgrepo}-build
}

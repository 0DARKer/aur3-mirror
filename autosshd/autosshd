#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions
. /etc/conf.d/autosshd

ck_daemon autosshd
STATUS=$?
AUTOSSH_PIDFILE="/var/run/autosshd.pid"
PID="$(cat $AUTOSSH_PIDFILE 2>/dev/null)"
case "$1" in
  start)
    stat_busy "Starting autossh"
    [ $STATUS -eq 0 ] && sudo -u $AUTOSSH_USER env AUTOSSH_PIDFILE=/tmp/autosshd.pid /usr/bin/autossh -M $AUTOSSH_PORT -f $SSH_OPTIONS
    if [ $? -gt 0 ]; then
      stat_fail
    else
      mv /tmp/autosshd.pid $AUTOSSH_PIDFILE
      add_daemon autosshd
      stat_done
    fi
    ;;
  stop)
    stat_busy "Stopping autossh"
    [ $STATUS -eq 1 ]  && kill $(cat $AUTOSSH_PIDFILE 2>/dev/null) &> /dev/null
    if [ $? -gt 0 ]; then
      stat_fail
    else
      rm -f $AUTOSSH_PIDFILE
      rm_daemon autosshd
      stat_done
    fi
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  status)
    if [ $STATUS -eq 1 ]; then
      status_started
    else
      status_stopped
    fi		
    ;;
  *)
    echo "usage: $0 {start|stop|status|restart}"  
esac
exit 0

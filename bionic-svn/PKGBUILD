# Maintainer: Jens Staal <staal1978@gmail.com>
pkgname=bionic-svn
pkgver=11325
pkgrel=4
pkgdesc="The Android BSD-licenced lightweight Bionic libc, libm and libdl made into a stand-alone lib by the metasploit project"
arch=('i686')
url="https://www.metasploit.com/redmine/projects/framework/repository/revisions/trunk/show/external/source/meterpreter/source/bionic"
license=('custom:BSD')
depends=()
makedepends=('subversion' 'ftjam')
provides=('bionic')

_svntrunk=https://www.metasploit.com/svn/framework3/trunk/external/source/meterpreter/source/bionic/

build() {

    svn co $_svntrunk
#
# The build instructions taken from: https://bitbucket.org/jrossi/metasploit/src/7f4bdc5394ca/documentation/posix_meterpreter.txt
# compile bionic.a and libbionic.so
# This compilation requires header files from the libm directory

     cd ${startdir}/src/bionic/libc/
     ARCH=x86 TOP=${PWD} jam || return 1
     cd out/x86/
     sh make.sh

# Compile bionic libm.so
#
     cd ${startdir}/src/bionic/libm/
     make -f msfMakefile

# Install the bionic dynamic linker
     cd ${startdir}/src/bionic/libdl/
     make
  }

package() {
# create package directories
    mkdir -m755 ${startdir}/pkg/usr/
    mkdir -m755 ${startdir}/pkg/usr/lib/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libc/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libc/include/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libc/kernel/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libc/arch-x86/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libc/private/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libm/
    mkdir -m755 ${startdir}/pkg/usr/lib/bionic/libm/include/

# move package headers etc to /usr/lib/bionic directory

    cp -ar $startdir/src/bionic/libc/include/* ${startdir}/pkg/usr/lib/bionic/libc/include
    cp -ar $startdir/src/bionic/libc/kernel/* ${startdir}/pkg/usr/lib/bionic/libc/kernel    
    cp -ar $startdir/src/bionic/libc/arch-x86/* ${startdir}/pkg/usr/lib/bionic/libc/arch-x86
    cp -ar $startdir/src/bionic/libc/private/* ${startdir}/pkg/usr/lib/bionic/libc/private

    cp -ar $startdir/src/bionic/libm/include/* ${startdir}/pkg/usr/lib/bionic/libm/include/

# move bionic libc binaries to /usr/lib/bionic, adding licences to an appropriate directory
    
    install -D -m0755 ${startdir}/src/bionic/libc/out/x86/bionic.a ${startdir}/pkg/usr/lib/bionic/bionic.a
    install -D -m0755 ${startdir}/src/bionic/libc/out/x86/libbionic.so ${startdir}/pkg/usr/lib/bionic/libbionic.so
    install -D -m0644 ${startdir}/src/bionic/libc/MODULE_LICENSE_BSD ${startdir}/pkg/usr/share/licenses/bionic/libc/MODULE_LICENSE_BSD
    install -D -m0644 ${startdir}/src/bionic/libc/NOTICE ${startdir}/pkg/usr/share/licenses/bionic/libc/NOTICE

# move bionic libm.so to /usr/lib/bionic, directory chosen in order not to conflict with others

     install -D -m0755 ${startdir}/src/bionic/libm/libm.so ${startdir}/pkg/usr/lib/bionic/libm.so
     install -D -m0644 ${startdir}/src/bionic/libm/MODULE_LICENSE_BSD_LIKE ${startdir}/pkg/usr/share/licenses/bionic/libm/MODULE_LICENSE_BSD_LIKE
     install -D -m0644 ${startdir}/src/bionic/libm/NOTICE ${startdir}/pkg/usr/share/licenses/bionic/libm/NOTICE

# move bionic lidl.so to /usr/lib/bionic, directory chosen in order not to conflict with others

    install -D -m0755 ${startdir}/src/bionic/libdl/libdl.so ${startdir}/pkg/usr/lib/bionic/libdl.so
    install -D -m0644 ${startdir}/src/bionic/libdl/MODULE_LICENSE_BSD ${startdir}/pkg/usr/share/licenses/bionic/libdl/MODULE_LICENSE_BSD
    install -D -m0644 ${startdir}/src/bionic/libdl/NOTICE ${startdir}/pkg/usr/share/licenses/bionic/libdl/NOTICE
}

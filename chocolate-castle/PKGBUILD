# Maintainer: Loren <smallphrosty  gmail  com>

pkgname=chocolate-castle
pkgver=1.09_1
pkgrel=1
pkgdesc="A tricky sliding block puzzle game. You must purchase the game. (The Humble Voxatron Bundle)"
url='http://www.lexaloffle.com/choc.php'
groups=('humblevoxatronbundle' 'humblebundles')
license=('custom: "commercial"')
source=(${pkgname}.bmp 
        ${pkgname}.desktop 
        ${pkgname}.launcher)
md5sums=('ce3b8bd4ab328405c10147e6bfeccc9b'
         '22498f99411e519c2239a52d28872e61'
         'a401a711742eb8501a52b793565b74d5')
arch=('i686' 'x86_64')
[ "${CARCH}" = "x86_64" ] && depends=('lib32-libgl' 'lib32-sdl')
[ "${CARCH}" = "i686" ]  && depends=('libgl' 'sdl')

_gamepkg="${pkgname}_${pkgver//_/-}_i386.tar.gz"

build() {
   cd ${srcdir}

   msg "You need a full copy of this game in order to install it"
   msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
   if [[ -f "../${_gamepkg}" ]]; then
       msg "Found game package, installing..."
       ln -fs "../${_gamepkg}" .
   elif [ -n "${_humblevoxatronkey}" ]; then
	   msg "Game package not found, trying to download..."
	   rm -f index.html\?key\=${_humblevoxatronkey}*
	   wget http://www.humblebundle.com/?key=${_humblevoxatronkey}
	   wget $(cat index.html\?key\=${_humblevoxatronkey} | grep "${_gamepkg}" | cut -d "'" -f 10)
	   mv ${_gamepkg}* ${_gamepkg}
   else
	   msg "Game package not found and download failed."
	   msg "You can add \'export _humblevoxatronkey=<Your key here>\' to \.bashrc if you want automated download ability."
       error "Please type absolute path to ${_gamepkg} (/home/joe):"
       read pkgpath
       if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
           msg "Found game package, installing..."
		   ln -fs "${pkgpath}/${_gamepkg}" .
	   else
	       error "Unable to find game package."
	       return 1
       fi
   fi
   install -d $pkgdir/opt/${pkgname}
   bsdtar -xf $srcdir/${_gamepkg}
   cp -r $srcdir/choc/* $pkgdir/opt/${pkgname}  
   rm $pkgdir/opt/$pkgname/libSDL-1.2.so.0
}

package() {
   cd ${srcdir}
   # Install Desktop File and Icon
   install -D -m 644 $srcdir/${pkgname}.bmp \
      $pkgdir/usr/share/pixmaps/${pkgname}.bmp 
   install -D -m 644 $srcdir/${pkgname}.desktop \
      $pkgdir/usr/share/applications/${pkgname}.desktop 
   # Install Game Launcher
   install -D -m 755 $srcdir/${pkgname}.launcher \
      $pkgdir/usr/bin/choc 

   # Install license
   install -Dm 644 "${pkgdir}"/opt/${pkgname}/license.txt "${pkgdir}"/usr/share/licenses/${pkgname}/license
}
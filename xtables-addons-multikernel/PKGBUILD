# Maintainer: Lubomir Krajcovic <lubomir.krajcovic(AT)gmail(DOT)com>
# Contributor: Vladimir Kutyavin <vlkut(AT)bk(DOT)ru>
pkgname=xtables-addons-multikernel
pkgver=1.41
pkgrel=1
pkgdesc="Additional extensions for iptables, ip6tables, etc. CHAOS, TARPIT, TEE, DELUDE and other targets; condition, geoip, ipp2p and other matches. Includes ipset package. Builds for all kernels detected on system."
arch=('i686' 'x86_64')
license=('GPL2')
url="http://xtables-addons.sourceforge.net/"
depends=('iptables>=1.4.12', 'linux>=3.0.0' 'libmnl>=1.0.1' 'glibc')
makedepends=('linux-headers')
conflicts=(ipset xtables-addons)
replaces=(ipset xtables-addons)
provides=(ipset xtables-addons)
source=(http://download.sourceforge.net/project/xtables-addons/Xtables-addons/$pkgver/xtables-addons-$pkgver.tar.xz)
install=$pkgname.install
md5sums=('a8de5e5e5823aefcbab210159f122564')

build() {
	# go to builddir
	cd $srcdir/xtables-addons-$pkgver
	# disable install-exec-hook (avoids useless calling of depmod -a at 'make install' stage)
	sed -i 's/^install-exec-hook:$/disabled-install-exec-hook:/' Makefile.am
	# loop through all detected kernels
	_PACKAGES=`pacman -Qsq linux`
	_KERNELS=`pacman -Ql $PACKAGES | grep /modules.alias.bin | sed 's/.*\/lib\/modules\/\(.*\)\/modules.alias.bin/\1/g'`
	for kernver in $_KERNELS; do
		# check for kernel headers
		kheaders="/lib/modules/$kernver/build"
		echo -e "\n\n\n>>> building for kernel: $kernver\n\n\n"
		sleep 3
		if [ ! -d "$kheaders" ]; then
			echo "!!! SKIPPING build for kernel: $kernver"
			echo "!!! probably missing kernel headers for $kernver ?"
			echo "!!! could not locate directory: $kheaders"
			continue
		fi
		# for stock kernel override module install path
		# /lib/modules/xx.yy.zz-ARCH/extra ==> /lib/modules/extramodules-xx.yy-ARCH
		if [[ $kernver =~ ^([0-9]+)\.([0-9]+)\.[0-9]+\-[0-9]+\-ARCH$ ]]; then
			kmajor=${BASH_REMATCH[1]}
			kminor=${BASH_REMATCH[2]}
			modsubdir="INSTALL_MOD_DIR=../extramodules-${kmajor}.${kminor}-ARCH"
		else
			modsubdir=""
		fi
		# call config, build and install subsystems
		./configure \
			--prefix=/usr \
			--libexecdir=/usr/lib/iptables \
			--sysconfdir=/etc \
			--with-xtlibdir=/usr/lib/iptables \
			--mandir=/usr/share/man \
			--with-kbuild="$kheaders"
		make || return 1
		make -j2 DESTDIR=$pkgdir $modsubdir install || return 1
		# remove empty moduledir (in case of override)
		[ "x$modsubdir" != "x" ] && rmdir "${pkgdir}/lib/modules/${kernver}"
	done
	# gzip -9 all modules to save 100MB of space
	find "${pkgdir}/lib/modules/" -name '*.ko' -exec gzip -9 {} \;
	# remove exec from .so
	chmod a-x $pkgdir/usr/lib/iptables/*.so
}

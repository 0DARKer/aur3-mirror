# Contributor: Vojtech "kralyk" Kral

pkgname='libopencl'
pkgver=1.2
pkgrel=3
_appsdk_ver='2.9.1'

pkgdesc='OpenCL library and ICD loader'
arch=('i686' 'x86_64')
url="http://developer.amd.com/sdks/AMDAPPSDK/Pages/default.aspx"
license=("custom")
install='install'

provides=('libcl')
conflicts=('libcl' 'nvidia-utils')

#Architecture resolution
CARCH='i686'
[ "$CARCH" = 'x86_64' ] && _postdata='amd_developer_central_nonce=22f6405b48&_wp_http_referer=%2Famd-license-agreement-appsdk%2F&f=QU1ELUFQUC1TREstbGludXgtdjIuOS0xLjU5OS4zODEtR0EteDY0LnRhci5iejI%3D' \
                        || _postdata='amd_developer_central_nonce=6c0619d4da&_wp_http_referer=%2Famd-license-agreement-appsdk%2F&f=QU1ELUFQUC1TREstbGludXgtdjIuOS0xLjU5OS4zODEtR0EteDg2LnRhci5iejI%3D'

_arch="${CARCH/i6/x}"
_bits="${_arch/x86/32}"
_bits="${_bits/32_/}"

_tarball="AMD-APP-SDK-${_appsdk_ver}-${CARCH}.tar.bz2"
_sfx="AMD-APP-SDK-v2.9-1.599.381-GA-linux${_bits}.sh"
_offset=9513
_inner='inner.tar.bz2'


prepare()
{
  msg 'Downloading AMD APP SDK...'
  wget -c -t 3 --waitretry=3 \
    --post-data "${_postdata}" \
    -O "../${_tarball}" \
    'http://developer.amd.com/amd-license-agreement-appsdk/'
  ln -sf "../${_tarball}" .
  msg "Extracting ${_tarball} ..."
  bsdtar -jxf "${_tarball}"
  dd ibs="${_offset}" skip=1 if="${_sfx}" of="${_inner}" 2> /dev/null
  bsdtar -jxf "${_inner}"
}

package()
{
  #Install libOpenCL
  install -d -m 755 "${pkgdir}/usr/lib"
  install -m 755 "lib/${_arch}/libOpenCL.so.1" "${pkgdir}/usr/lib"
  ln -s 'libOpenCL.so.1' "${pkgdir}/usr/lib/libOpenCL.so"

  #Install license
  install -d -m 755 "${pkgdir}/usr/share/licenses/libopencl"
  install -m 644 'APPSDK-EULA-linux.txt' "${pkgdir}/usr/share/licenses/libopencl"
}

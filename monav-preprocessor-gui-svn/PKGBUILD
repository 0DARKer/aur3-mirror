# Creator: Micael Dias <kam1kaz3@gmail.com>

pkgname=monav-preprocessor-gui-svn
pkgver=510
pkgrel=2
pkgdesc="MoNav is a Desktop / Mobile application that offers state-of-the-art fast and exact routing with OpenStreetMap Data."
arch=('i686' 'x86_64')
url="http://code.google.com/p/monav/"
license=('GPLv3')
depends=('qt' 'mapnik' 'libxml2' 'bzip2' 'protobuf')
makedepends=('subversion' 'gcc' 'protobuf')
conflicts=('monav-preprocessor-gui')
provides=("monav-preprocessor-gui")

_svnmod="monav-preprocessor-gui"
_svntrunk=https://monav.googlecode.com/svn/trunk/

build()
{
	cd "${srcdir}"

	# get most recent data from svn
	if [ -d $_svnmod/.svn ]; then
		(cd $_svnmod && svn up -r $pkgver)
	else
		svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
	fi

	msg "SVN checkout done or server timeout"
	msg "Starting qmake..."

	# remove previous build data
	if [ -d $_svnmod-build ];then
		rm -rf $_svnmod-build
	fi

	# copy files to build dir
	cp -r $_svnmod $_svnmod-build
	cd $_svnmod-build

	# regenerate protocol files
        # (unneeded from r510 on, but keeping here just
        # in case protobuf gets updated again)
	#protoc -I="plugins/osmimporter/protobuff definitions" --cpp_out="plugins/osmimporter/protobuff definitions" "plugins/osmimporter/protobuff definitions"/fileformat.proto
	#protoc -I="plugins/osmimporter/protobuff definitions" --cpp_out="plugins/osmimporter/protobuff definitions" "plugins/osmimporter/protobuff definitions"/osmformat.proto

	# generate make files
	qmake CONFIG+=release monavpreprocessor-gui.pro || return 1

	msg "Compiling..."

	# make
	make || return 1
}

package()
{
	#cd "$srcdir"/$_svnmod-build
	#make INSTALL_ROOT="${pkgdir}" install || return 1

	# for some reason the "make install" is reporting "nothing to do", so lets do this manually
	install -d "${pkgdir}"/usr/bin
	install -m 0755 "$srcdir"/$_svnmod-build/bin/monav-preprocessor-gui "${pkgdir}"/usr/bin
}

# Maintainer: Pablo Lluch <pablo.lluch@gmail.com>

pkgname=('opencv-cuda-all')
_realname=OpenCV
pkgver=2.4.4
pkgrel=1
pkgdesc="Open Source Computer Vision Library. Built with Cuda (patched for gcc-4.7), Qt backend, samples and docs."
arch=('i686' 'x86_64')
license=('BSD')
url="http://opencv.org/"
depends=('jasper' 'gstreamer0.10-base' 'intel-tbb' 'cuda-toolkit' 'qt4'
         'xine-lib' 'libdc1394' 'openexr' 'gtkglext')
makedepends=('cmake' 'python2-numpy' 'eigen2'
             'texlive-bin' 'python2-sphinx') # for docs
optdepends=('opencl-headers: OpenCL support'
            'eigen2'
            'python2-numpy: Python 2.x interface')
conflicts=('opencv-svn' 'opencv' 'opencv-docs' 'opencv-samples')
provides=('opencv' 'opencv-docs' 'opencv-samples')
source=("http://downloads.sourceforge.net/opencvlibrary/$_realname-${pkgver}.tar.bz2"
        'pkgconfig.patch'
        'fsh.patch')
md5sums=('bb7272c102a801a9f9ee01db6e7ad8e9'
         'cb916260b5ec594fe7a0cc2e54fc569f'
         '35256e3ccace373feba8131d1540a0de')

_cmakeopts=(
            '-D WITH_OPENCL=ON'
            '-D WITH_OPENGL=ON'
            '-D WITH_TBB=ON'
            '-D WITH_XINE=ON'
            '-D ENABLE_SSE=OFF'
            '-D ENABLE_SSE2=OFF'
            '-D ENABLE_SSE3=OFF'
            '-D BUILD_DOCS=ON'
            '-D BUILD_PACKAGE=OFF'
            '-D BUILD_WITH_DEBUG_INFO=OFF'
            '-D BUILD_TESTS=OFF'
            '-D BUILD_PERF_TESTS=OFF'
            '-D BUILD_EXAMPLES=ON'
            '-D INSTALL_C_EXAMPLES=ON'
            '-D INSTALL_PYTHON_EXAMPLES=ON'
            '-D CMAKE_BUILD_TYPE=Release'
            '-D CMAKE_INSTALL_PREFIX=/usr'
            '-D CMAKE_SKIP_RPATH=ON'
            '-D WITH_QT=ON'
            '-D WITH_CUDA=ON'
            '-D QT_QMAKE_EXECUTABLE=/usr/bin/qmake-qt4'
            )

build() {

  cd "$srcdir/$_realname-$pkgver"

  # fix pkg-config mess
  # see https://bugs.archlinux.org/task/32430
  # and http://code.opencv.org/issues/1925
  patch -Np1 -i "$srcdir/pkgconfig.patch"

  # fix another upstream mess that they won't fix
  # see http://code.opencv.org/issues/2512
  patch -Np1 -i "$srcdir/fsh.patch"

  # python2 compatibility for generating docs
  sed -i 's/sphinx-build/sphinx-build2/' cmake/OpenCVDetectPython.cmake

  # GCC4.7 related fixes for CUDA compilation
  sed -i '1 i #undef _GLIBCXX_ATOMIC_BUILTINS' modules/gpu/src/nvidia/core/*.cu
  sed -i '1 i #undef _GLIBCXX_USE_INT128' modules/gpu/src/nvidia/core/*.cu

  sed -i '1 i #undef _GLIBCXX_ATOMIC_BUILTINS' modules/gpu/src/cuda/*.cu
  sed -i '1 i #undef _GLIBCXX_USE_INT128' modules/gpu/src/cuda/*.cu
  
  sed -i '1 i #undef _GLIBCXX_ATOMIC_BUILTINS' modules/gpu/src/nvidia/NPP_staging/*.cu
  sed -i '1 i #undef _GLIBCXX_USE_INT128' modules/gpu/src/nvidia/NPP_staging/*.cu
  
  sed -i '1 i #undef _GLIBCXX_ATOMIC_BUILTINS' modules/gpu/src/nvidia/*.cu
  sed -i '1 i #undef _GLIBCXX_USE_INT128' modules/gpu/src/nvidia/*.cu

  # x64, i.e "Athlon64" and upwards, can use SSE3
  [ $CARCH = x86_64 ] && \
    _cmakeopts=${_cmakeopts[@]/ENABLE_SSE3=OFF/ENABLE_SSE3=ON}

  mkdir -p build
  cd build
  cmake ${_cmakeopts[@]} ..
  make

  cd "$srcdir/$_realname-$pkgver/build"

  make DESTDIR="$pkgdir" install

  # install license file
  install -Dm644 "$srcdir/$_realname-$pkgver/doc/license.txt" \
    "$pkgdir/usr/share/licenses/opencv/LICENSE"

  cd "$pkgdir/usr/share"

  # separate docs package; also be -R friendly
  [ -d doc ] && mv doc "$srcdir/opencv-doc"

  # separate samples package
  [ -d opencv/samples ] && mv opencv/samples "$srcdir/opencv-samples"
  
  cd "$srcdir"

  # install docs
  mkdir -p "$pkgdir/usr/share/doc"
  cp -r "opencv-doc/opencv" "$pkgdir/usr/share/doc/opencv"
   
  # install samples
  mkdir -p "$pkgdir/usr/share/opencv"
  cp -r opencv-samples "$pkgdir/usr/share/opencv/samples"
}
# Maintainer: Moritz Lipp <mlq@pwmt.org>

pkgname=oclint
pkgver=0.7
pkgrel=2
pkgdesc="static code analysis tool for improving quality and reducing defects"
arch=('i686' 'x86_64')
url="http://oclint.org/"
license=('BSD')
dependencies=('clang' 'clang-analyzer' 'llvm' 'llvm-libs')
makedepends=('cmake' 'subversion' 'python2' 'libxml2')
source=(http://archives.oclint.org/releases/$pkgver/$pkgname-$pkgver-src.tar.gz
       use-system-llvm.patch)
md5sums=('8bbccef58be384f4a4cfc2ed9b72c69a'
      	 'ee2c6cb63e9cec713c9f8d8958c56f77')

prepare() {
  cd "$srcdir/$pkgname-$pkgver-src/oclint-scripts"

  # Use python2
  mkdir -p "$srcdir/python2-path"
  if [ ! -e "$srcdir/python2-path" ]; then
    ln -s /usr/bin/python2 "$srcdir/python2-path/python"
  fi
  export PATH="$srcdir/python2-path:$PATH"
}

build() {
  cd "$srcdir/$pkgname-$pkgver-src"

  msg "Patch system-llvm"
  patch -Np1 -i $srcdir/use-system-llvm.patch

  cd "oclint-scripts"

  msg "Build OCLint"
  ./buildAll.sh release

  # Cleanup python
  rm -r $srcdir/python2-path
}

package() {
	cd "$srcdir/$pkgname-$pkgver-src"

  # Fix python path
  sed -i '1 s/^.*$/#!\/usr\/bin\/env python2/' ./build/oclint-release/bin/oclint-json-compilation-database

  mkdir -p $pkgdir/usr/bin
  cp ./build/oclint-release/bin/oclint-$pkgver $pkgdir/usr/bin/oclint
  cp ./build/oclint-release/bin/oclint-json-compilation-database $pkgdir/usr/bin/oclint-json-compilation-database

  mkdir -p $pkgdir/usr/lib/oclint
  cp -r ./build/oclint-release/lib/oclint/* $pkgdir/usr/lib/oclint/
}

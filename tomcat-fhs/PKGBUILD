# Contributor: Kosenko Roman <madkite@gmail.com>
pkgname=tomcat-fhs
pkgver=6.0.29
pkgrel=1
pkgdesc='Servlet container that is used in the official Reference Implementation for the Java Servlet and JavaServer Pages technologies'
arch=('i686' 'x86_64')
url='http://tomcat.apache.org'
license=('apache')
depends=('java-runtime>=6' 'apr>=1.2.7' 'openssl>=0.9.8e' 'libtool')
makedepends=('java-environment>=6')
backup=(etc/tomcat/server.xml etc/tomcat/context.xml etc/tomcat/tomcat-users.xml etc/tomcat/web.xml etc/tomcat/catalina.policy etc/conf.d/${pkgname%-*}.conf)
install="${pkgname%-*}.install"
_commons_pool_ver=1.5.4
_commons_dbcp_ver=1.4
_tomcat_native_ver=1.1.20
_eclipse_ver=R-3.6-201006080911
source=(http://www.apache.org/dist/tomcat/tomcat-${pkgver%%.*}/v${pkgver}/src/apache-tomcat-${pkgver}-src.tar.gz \
	http://download.eclipse.org/eclipse/downloads/drops/${_eclipse_ver}/org.eclipse.jdt-$(echo ${_eclipse_ver} | sed 's/^.-\([[:digit:]\.]*\)-[[:digit:]]*$/\1/').zip \
	http://www.apache.org/dist/commons/pool/source/commons-pool-${_commons_pool_ver}-src.tar.gz \
	http://www.apache.org/dist/commons/dbcp/source/commons-dbcp-${_commons_dbcp_ver}-src.tar.gz \
	http://www.apache.org/dist/tomcat/tomcat-connectors/native/${_tomcat_native_ver}/source/tomcat-native-${_tomcat_native_ver}-src.tar.gz \
	${pkgname%-*}.sh ${pkgname%-*}.conf server.xml.diff web.xml.diff \
	commons-dbcp-jdbc3.patch build.properties.default.diff build.xml.diff openjdk7_compatibility.patch)
noextract=(tomcat-native-${_tomcat_native_ver}-src.tar.gz org.eclipse.jdt-$(echo ${_eclipse_ver} | sed 's/^.-\([[:digit:]\.]*\)-[[:digit:]]*$/\1/').zip)

build() {
	[ -z "${JAVA_HOME}" ] && source /etc/profile.d/jdk.sh

	cd ${startdir}/src || return $?

	[ -d eclipse ] || mkdir eclipse && cd eclipse && unzip -q ../org.eclipse.jdt-*.zip && cd - || return $?
	mkdir tomcat-native-${_tomcat_native_ver} && ln -s "../tomcat-native-${_tomcat_native_ver}-src.tar.gz" tomcat-native-${_tomcat_native_ver}/tomcat-native.tar.gz

	#patch -d commons-dbcp-${_commons_dbcp_ver}-src -i ../commons-dbcp-jdbc3.patch -Nlf -p0 || return $?

	cd apache-tomcat-${pkgver}-src || return $?

	#patch -i ../build.properties.default.diff -Nlf || return $?
	#patch -i ../build.xml.diff -Nlf || return $?
	sed '/<antcall target="download\w*">/,/<\/antcall>/d' -i build.xml || return $?
	sed "s#^\(base.path=\).*#\1${PWD%/*}#" -i build.properties.default
	perl -pe 's/^(compile.(source|target))=.*/\1=1.6/' -i build.properties.default
	sed "s/\(compile.debug=\).*/\1false/" -i build.properties.default
	sed '/commons-daemon/d' -i build.xml
	sed 's/\(<target name="build-tomcat-dbcp"\) unless="jdk16.present"/\1/' -i build.xml
	#sed 's/\(<javac \)/\1fork="true" memoryMaximumSize="1024m" /' -i build.xml
	export ANT_OPTS="-Xmx256m"

	sed "s/org\.eclipse\.jdt\.core_.*\.jar/$(cd ../eclipse/plugins; ls org.eclipse.jdt.core_*.jar | head -n1)/" -i build.properties.default
	sed "s/\(commons-pool.version=\).*/\1${_commons_pool_ver}/" -i build.properties.default
	sed "s/\(commons-dbcp.version=\).*/\1${_commons_dbcp_ver}/" -i build.properties.default
	sed "s/\(tomcat-native.version=\).*/\1${_tomcat_native_ver}/" -i build.properties.default

	#patch -i ../openjdk7_compatibility.patch -Nlf -p0 || return $?

	ant download || return $?

	ant || return $?

	cd output/build || return $?

	sed 's/\s*$//' -i conf/server.xml
	patch -d conf -i ${startdir}/src/server.xml.diff -Nlf || return $?
	patch -d conf -i ${startdir}/src/web.xml.diff -Nlf || return $?
	rm -f conf/*~ conf/*.orig

	cd bin
	tar xfz tomcat-native.tar.gz
	cd tomcat-native*/jni/native/
	./configure --prefix=/usr --with-apr=$(which apr-1-config) || return $?
	make || return $?
	make DESTDIR=${startdir}/pkg install || return $?
	rm -rf ${startdir}/pkg/usr/bin ${startdir}/pkg/usr/include
	cd ../../../..
	sed -i 's|protocol="HTTP/1.1"\(.*SSL.*\)|protocol="org.apache.coyote.http11.Http11NioProtocol"\1|i' conf/server.xml
	sed -i 's|protocol="HTTP/1.1"|protocol="org.apache.coyote.http11.Http11AprProtocol"|' conf/server.xml

	rm -rf LICENSE NOTICE RELEASE-NOTES RUNNING.txt \
		bin/{*.bat,*.exe,*.tar.gz,jsvc*,tomcat-native*} \
		logs temp work
	sed -i 's|${catalina.base}/logs|/var/log/tomcat|' conf/logging.properties
	#sed -i 's|appBase="webapps"|appBase="/srv/webapps"|' conf/server.xml

	mkdir -p ${startdir}/pkg/etc
	mv conf ${startdir}/pkg/etc/tomcat
	chgrp -R 66 ${startdir}/pkg/etc/tomcat
	chmod 0640 ${startdir}/pkg/etc/tomcat/*
	chmod 0660 ${startdir}/pkg/etc/tomcat/tomcat-users.xml

	mv webapps/ROOT webapps/default
	mkdir -p ${startdir}/pkg/srv
	mv webapps ${startdir}/pkg/srv
	chown -R 66:66 ${startdir}/pkg/srv/webapps
	chmod 0775 ${startdir}/pkg/srv/webapps

	rm -f lib/tomcat-i18n-*.jar

	chmod 0755 bin/*.sh
	mkdir -p ${startdir}/pkg/opt/tomcat
	mv * ${startdir}/pkg/opt/tomcat
	ln -s /var/tmp ${startdir}/pkg/opt/tomcat/work
	ln -s /etc/tomcat ${startdir}/pkg/opt/tomcat/conf

	mkdir -p ${startdir}/pkg/var/log/tomcat
	chown -R 66:66 ${startdir}/pkg/var/log/tomcat
	chmod 0775 ${startdir}/pkg/var/log/tomcat

	install -D -m0754 -o 66 -g 66 ${startdir}/src/${pkgname%-*}.sh ${startdir}/pkg/etc/rc.d/${pkgname%-*}
	install -D -m0664 -o 66 -g 66 ${startdir}/src/${pkgname%-*}.conf ${startdir}/pkg/etc/conf.d/${pkgname%-*}
}

md5sums=('260de5ae62f415b9c085c5aeed4ef24c' '1273090c43a8b948847899f3a442aab8' '4216bb6eca49e7b3db9f287d7b0c0cd8' 'e9f599c99baefeeb0e192030c5d19d5d' 'fb2b9d073cb6575c2d0020eda266ca0c' '4a63afa8a5cd18f8c763bbc68fc6cdca'
		 '8c3edfc2bc44b030761edfd9cd26a395' 'cec3165cf2d006d90202d84d0366ca76' '11ab35e7cfee65810b10575f5b6b00f6' '77bc7cbdc12df2e6b157aa76239bf938' '71eb3fb070cf594e47a9c01eb7a0b1a2' 'aef85042f2c32e153aaf1c01aebcf090' '73cc3e4c20231e1d2d1349203e1e6662')

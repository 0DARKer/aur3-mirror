# Maintainer: ian <ian at kremlin dot cc>
pkgname=bashstyle-git
pkgver=bashstyleng.8.3.r13.ga1c40ff
pkgrel=1
pkgdesc="A PyGTK client for managing bash, readline, vim, and nano settings (git version)"
arch=('any')
url="https://github.com/Nanolx/bashstyle-ng"
license=('GPL3')
groups=('system')
depends=('gawk' 'sed' 'bc' 'gettext' 'less' 'libnewt' 'python2-configobj' 'python2-gobject' 'hicolor-icon-theme')
makedepends=('git')
optdepends=("acpi: showbatteryload support" "lspci: systeminfos support" "lsusb: systeminfos support" "ps2pdf: man2pdf support" "tree: fs support" "dmidecode: dmi variables support")
install=".install"
conflicts=('bashstyle')
provides=('bashstyle')
source=("git://github.com/Nanolx/bashstyle-ng.git" "base.patch" "checks.patch" "text2morse.patch" "adjust.patch")
md5sums=('SKIP'
         'a91c940e60be16a2ea79b83daa0431c5'
         '8e28b621b11b58c4bb82370d13496c9c'
         'c509eace1c1d750bb40911749886c69f'
         '731855d8af5da63f6b23467ba8e05d3d')

pkgver() {
	cd "$srcdir/bashstyle-ng"
	git describe --long | sed -E 's/([^-]*-g)/r\1/;s/-/./g'
}

prepare() {
	cd "$srcdir/bashstyle-ng/.configure"
	patch base < "$srcdir/base.patch"
	patch checks < "$srcdir/checks.patch"
	cd "$srcdir/bashstyle-ng/rc/functions"
	patch text2morse < "$srcdir/text2morse.patch"
	cd "$srcdir/bashstyle-ng/.make"
	patch adjust < "$srcdir/adjust.patch"
}

build() {
	cd "$srcdir/bashstyle-ng"
	./configure --python=/usr/bin/python2 --no-installdocs
	make
}

package() {
	cd "$srcdir/bashstyle-ng"
	make DESTDIR="$pkgdir/" install

	# get rid of locales if already present
	if [ -f /usr/share/locale/de/LC_MESSAGES/bs-ng-wizard.mo ]; then
		rm $pkgdir/usr/share/locale/de/LC_MESSAGES/bs-ng-wizard.mo
	fi
	if [ -f /usr/share/locale/de/LC_MESSAGES/bs-ng.mo ]; then
		rm $pkgdir/usr/share/locale/de/LC_MESSAGES/bs-ng.mo
	fi
	if [ -f /usr/share/locale/de/LC_MESSAGES/nx-rc.mo ]; then
		rm $pkgdir/usr/share/locale/de/LC_MESSAGES/nx-rc.mo
	fi
	if [ -f /usr/share/locale/es/LC_MESSAGES/bs-ng.mo ]; then
		rm $pkgdir/usr/share/locale/es/LC_MESSAGES/bs-ng.mo
	fi
	if [ -f /usr/share/locale/es/LC_MESSAGES/nx-rc.mo ]; then
		rm $pkgdir/usr/share/locale/es/LC_MESSAGES/nx-rc.mo
	fi
	if [ -f /usr/share/locale/it/LC_MESSAGES/bs-ng.mo ]; then
		rm $pkgdir/usr/share/locale/it/LC_MESSAGES/bs-ng.mo
	fi
	if [ -f /usr/share/locale/ru/LC_MESSAGES/bs-ng-wizard.mo ]; then
		rm $pkgdir/usr/share/locale/ru/LC_MESSAGES/bs-ng-wizard.mo
	fi
	if [ -f /usr/share/locale/ru/LC_MESSAGES/bs-ng.mo ]; then
		rm $pkgdir/usr/share/locale/ru/LC_MESSAGES/bs-ng.mo
	fi
	if [ -f /usr/share/locale/ru/LC_MESSAGES/nx-rc.mo ]; then
		rm $pkgdir/usr/share/locale/ru/LC_MESSAGES/nx-rc.mo
	fi

	# clean up empty dirs
	if [ "$(ls -A $pkgdir/usr/share/locale/ru/LC_MESSAGES 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/locale/ru/LC_MESSAGES
		rmdir $pkgdir/usr/share/locale/ru
	fi
	if [ "$(ls -A $pkgdir/usr/share/locale/de/LC_MESSAGES 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/locale/de/LC_MESSAGES
		rmdir $pkgdir/usr/share/locale/de
	fi
	if [ "$(ls -A $pkgdir/usr/share/locale/it/LC_MESSAGES 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/locale/it/LC_MESSAGES
		rmdir $pkgdir/usr/share/locale/it
	fi
	if [ "$(ls -A $pkgdir/usr/share/locale/es/LC_MESSAGES 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/locale/es/LC_MESSAGES
		rmdir $pkgdir/usr/share/locale/es
	fi
	if [ "$(ls -A $pkgdir/usr/share/doc/bashstyle-ng/img-style 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/doc/bashstyle-ng/img-style
	fi
	if [ "$(ls -A $pkgdir/usr/share/doc/bashstyle-ng/img 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/doc/bashstyle-ng/img
	fi
	if [ "$(ls -A $pkgdir/usr/share/locale 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/locale
	fi
	if [ "$(ls -A $pkgdir/usr/share/doc/bashstyle-ng 2> /dev/null)" == "" ]; then
		rmdir $pkgdir/usr/share/doc/bashstyle-ng
		rmdir $pkgdir/usr/share/doc
	fi
}

# Maintainer: Alex Brinister <alex_brinister at yahoo dot com>
pkgname=wireshark-svn
pkgver=48383
pkgrel=1
pkgdesc="A free network protocol analyzer for Unix/Linux. SVN version"
arch=('i686' 'x86_64')
license=('GPL2')
depends=('gtk2' 'wireshark-cli' 'libpcap' 'gnutls' 'c-ares' 'e2fsprogs' 'lua' 'portaudio' 'geoip' 'libsmi' 'perl-parse-yapp' 'python2')
makedepends=('subversion')
url="http://www.wireshark.org/"
sha512sums=('6e1eab7793a97377017be9126b7d25bd9c10d2b0e06be1e83e66ac2ea64dce5c4f8f7783d483921867241d298eb0ac82ff3f9910e90c2065125bff9a3856f52e'
            'b421575dbc3d496a8c3d5485929c161c06d3403bff2fef4f1db07b1db729ca173c6e89cb648d127c02800359975d5e0880c344dc58fa9d24dde570a862bdd7d4'
            'fe9d6abf48712ac2f18b6cdd524045256c111e05a64ed6ea73d76282646b8d37017083ce67024f0a78593fcc90ad63b08e89c0e3cd617aebc4badf02656cc9a7')
replaces=('ethereal')
provides=('wireshark')
source=("wireshark.desktop"
        "wireshark.png"
		"01_patch-unicode-backslash-faqtxt.patch")
conflicts=('wireshark-gtk')

 _svnmod="wireshark"
 _svntrunk="http://anonsvn.wireshark.org/wireshark/trunk/"

build() {
	cd ${srcdir}

	if [ -d $_svnmod/.svn ]; then
		(cd $_svnmod && svn up -r $pkgver)
	else	
		svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
	fi
  
	msg "SVN checkout done or server timeout"
	msg "Starting make..."
	
	if [[ -d $srcdir/build ]] ; then
		rm -rf $srcdir/build
	fi
	
	cd $srcdir/$_svnmod
	cp $srcdir/01_patch-unicode-backslash-faqtxt.patch .
	patch -p0 < 01_patch-unicode-backslash-faqtxt.patch
	./autogen.sh
	
	mkdir $srcdir/build
	cd $srcdir/build
	
	/usr/lib/python2.7/Tools/scripts/reindent.py $srcdir/$_svnmod/tools/ncp2222.py

	$srcdir/$_svnmod/configure \
	--prefix=/usr \
	--with-ssl \
	--with-zlib=yes \
	--with-lua=/usr/include/ \
	--with-portaudio \
	--without-python \
	--enable-aircap \
	LDFLAGS="-llua" \
	CFLAGS="-Wno-error=old-style-definition -Wno-error=clobbered -Wno-error=unused-but-set-variable -fno-unit-at-a-time" \
	PYTHON=/usr/bin/python2

	make -j2 PYTHON=/usr/bin/python2
}

package() {
	cd $srcdir/build
	make -j2 DESTDIR=${pkgdir} install
	
	install -Dm644 ${srcdir}/wireshark.png ${pkgdir}/usr/share/icons/wireshark.png
	install -Dm644 ${srcdir}/wireshark.desktop ${pkgdir}/usr/share/applications/wireshark.desktop
}

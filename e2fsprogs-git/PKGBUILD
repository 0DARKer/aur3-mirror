# Contributor: ilikenwf/Matt Parnell <parwok@gmail.com>

pkgname=e2fsprogs-git
pkgver=20100106
pkgrel=1
pkgdesc="Ext2 filesystem utilities from git for ext4"
arch=('i686' 'x86_64')
license=('GPL' 'LGPL' 'MIT')
url="http://e2fsprogs.sourceforge.net"
groups=('base')
depends=('glibc')
makedepends=('bc' 'git')
provides=('e2fsprogs=1.4.1')
conflicts=('e2fsprogs')
source=(Makefile-fsck.static.patch
	mke2fs.conf)
md5sums=('ce2b0daf84e17e8c7880ba3d43020ea3'
         '4ebb30bdb5951f1fc86c1470e4d81532')

_gitroot="git://git.kernel.org/pub/scm/fs/ext2/e2fsprogs.git"
_gitname="e2fsprogs"

build() {
export CFLAGS="$CFLAGS -I/opt/mesa-xgl-cvs/include"
  cd $startdir/src
  msg "Connecting to git.freedesktop.org GIT server...."

  if [ -d $startdir/src/$_gitname ] ; then
  cd $_gitname && git pull origin
  msg "The local files are updated."
  else
  git clone $_gitroot
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  cp -r $startdir/src/$_gitname $startdir/src/$_gitname-build
  cd $startdir/src/$_gitname-build

  # Remove unnecessary init.d directory
  sed -i '/init\.d/s|^|#|' misc/Makefile.in

  ./configure --prefix=/usr --with-root-prefix="" --enable-elf-shlibs
  msg "Adding fsck.static for mkinitrd use"
  patch -Np1 -i ../Makefile-fsck.static.patch || return 1
 
  make || return 1
  make DESTDIR=${startdir}/pkg install install-libs
  make -C ${startdir}/src/$_gitname-build/misc fsck.static || return 1
  install -D -m755 ${startdir}/src/$_gitname-build/misc/fsck.static  ${startdir}/pkg/sbin/fsck.static
  sed -i -e 's/^AWK=.*/AWK=awk/' ${startdir}/pkg/usr/bin/compile_et || return 1
  install -m644 ${startdir}/src/mke2fs.conf ${startdir}/pkg/etc/ || return 1

  rm -rf $startdir/src/$_gitname-build
}

# Contributor: Bernhard Walle <bernhard.walle@gmx.de>
# Contributor: Frederic Bezies <fredbezies@gmail.com>
# Based on official Qemu-kvm PKGBUILD

pkgname=kvm-git
pkgver=20110402
pkgrel=1
pkgdesc="Qemu-KVM emulator - git version"
arch=(i686 x86_64)
url="http://www.linux-kvm.org/page/Main_Page"
license=('GPL')
depends=('libsasl' 'curl' 'sdl' 'alsa-lib' 'esound' 'gnutls>=2.4.1' 'bluez' 'vde2' 'util-linux-ng' 'brltty')
makedepends=('git' 'texi2html' 'perl')
provides=('qemu')
conflicts=('qemu')
replaces=('kvm')
backup=(etc/qemu/target-x86_64.conf)
options=(!libtool !emptydirs !strip)
install=('kvm-git.install')
source=('kvm-git.install'
        '65-kvm.rules')
noextract=()
md5sums=('6540bf1723d0571af45bc11ded95fb7e'
         'b316a066d2f1bb57d8f5b7ea1d0d1caf')
_gitroot="git://git.kernel.org/pub/scm/virt/kvm/qemu-kvm.git"
_gitname="qemu-kvm"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  cp -r "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
 
   ./configure --prefix=/usr \
                --audio-drv-list=alsa,sdl,oss,esd \
                --audio-card-list=ac97,sb16,es1370,adlib \
                --sysconfdir=/etc \
                --enable-docs --disable-spice || return 1
    make || return 1
    make DESTDIR=${pkgdir} install || return 1
    # symbolic link for backwards compatibility
    ln -s qemu-system-x86_64 ${pkgdir}/usr/bin/qemu-kvm
    # symbolic link for to qemu binary for emulator apps
    ln -s qemu-system-x86_64 ${pkgdir}/usr/bin/qemu
    # fix man page
    mv ${pkgdir}/usr/share/man/man1/qemu.1 \
                     ${pkgdir}/usr/share/man/man1/qemu-kvm.1
    # install udev rules
    install -D -m644 ${srcdir}/65-kvm.rules \
                     ${pkgdir}/lib/udev/rules.d/65-kvm.rules

}

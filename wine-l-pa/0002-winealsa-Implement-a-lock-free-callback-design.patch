--- wine-1.5.23/dlls/winealsa.drv/mmdevdrv.c.orig	2013-02-14 16:29:38.874605290 -0500
+++ wine-1.5.23/dlls/winealsa.drv/mmdevdrv.c	2013-02-14 16:51:54.959869521 -0500
@@ -92,7 +92,7 @@
     IAudioClock2 IAudioClock2_iface;
     IAudioStreamVolume IAudioStreamVolume_iface;
 
-    LONG ref;
+    LONG ref, held_frames;
 
     snd_pcm_t *pcm_handle;
     snd_pcm_uframes_t alsa_bufsize_frames, alsa_period_frames;
@@ -115,7 +115,7 @@
     BOOL initted, started;
     REFERENCE_TIME mmdev_period_rt;
     UINT64 written_frames, last_pos_frames;
-    UINT32 bufsize_frames, held_frames, tmp_buffer_frames, mmdev_period_frames;
+    UINT32 bufsize_frames, tmp_buffer_frames, mmdev_period_frames;
     snd_pcm_uframes_t remapping_buf_frames;
     UINT32 lcl_offs_frames; /* offs into local_buffer where valid data starts */
     UINT32 wri_offs_frames; /* where to write fresh data in local_buffer */
@@ -1980,6 +1980,7 @@
 {
     snd_pcm_sframes_t written, in_alsa;
     snd_pcm_uframes_t to_write, avail, write_limit, max_period;
+    UINT32 held_frames;
     int err;
     BYTE *buf =
         This->local_buffer + This->lcl_offs_frames * This->fmt->nBlockAlign;
@@ -2004,13 +2005,12 @@
     }else
         TRACE("pad: %ld\n", This->alsa_bufsize_frames - avail);
 
-    if(This->held_frames == 0)
+    to_write = held_frames = This->held_frames;
+    if(to_write == 0)
         return;
 
-    if(This->lcl_offs_frames + This->held_frames > This->bufsize_frames)
+    if(This->lcl_offs_frames + to_write > This->bufsize_frames)
         to_write = This->bufsize_frames - This->lcl_offs_frames;
-    else
-        to_write = This->held_frames;
 
     max_period = max(This->mmdev_period_frames, This->alsa_period_frames);
 
@@ -2030,8 +2030,8 @@
      * GetPosition continues to reflect the speaker position because
      * snd_pcm_delay includes buffered frames in its total delay
      * and last_pos_frames prevents moving backwards. */
-    if(!in_alsa && This->held_frames < This->hidden_frames){
-        UINT32 s_frames = This->hidden_frames - This->held_frames;
+    if(!in_alsa && held_frames < This->hidden_frames){
+        UINT32 s_frames = This->hidden_frames - held_frames;
         BYTE *silence = HeapAlloc(GetProcessHeap(), 0,
                 s_frames * This->fmt->nBlockAlign);
 
@@ -2055,17 +2055,18 @@
 
     This->lcl_offs_frames += written;
     This->lcl_offs_frames %= This->bufsize_frames;
-    This->held_frames -= written;
+    InterlockedExchangeAdd(&This->held_frames, -written);
 
     if(written < to_write){
         /* ALSA buffer probably full */
         return;
     }
 
-    if(This->held_frames && (written < write_limit)){
+    held_frames = This->held_frames;
+    if(held_frames && (written < write_limit)){
         /* wrapped and have some data back at the start to write */
         written = alsa_write_best_effort(This->pcm_handle, This->local_buffer,
-                min(This->held_frames, write_limit - written), This,
+                min(held_frames, write_limit - written), This,
                 This->session->mute);
         if(written < 0){
             WARN("Couldn't write: %ld (%s)\n", written, snd_strerror(written));
@@ -2074,7 +2075,7 @@
 
         This->lcl_offs_frames += written;
         This->lcl_offs_frames %= This->bufsize_frames;
-        This->held_frames -= written;
+        InterlockedExchangeAdd(&This->held_frames, -written);
     }
 }
 
@@ -2123,15 +2124,13 @@
 
     This->wri_offs_frames += nread;
     This->wri_offs_frames %= This->bufsize_frames;
-    This->held_frames += nread;
+    InterlockedExchangeAdd(&This->held_frames, nread);
 }
 
 static void CALLBACK alsa_push_buffer_data(void *user, BOOLEAN timer)
 {
     ACImpl *This = user;
 
-    EnterCriticalSection(&This->lock);
-
     if(This->started){
         if(This->dataflow == eRender)
             alsa_write_data(This);
@@ -2139,8 +2138,6 @@
             alsa_read_data(This);
     }
 
-    LeaveCriticalSection(&This->lock);
-
     if(This->event)
         SetEvent(This->event);
 }
@@ -2562,7 +2559,7 @@
 
     This->wri_offs_frames += written_frames;
     This->wri_offs_frames %= This->bufsize_frames;
-    This->held_frames += written_frames;
+    InterlockedExchangeAdd(&This->held_frames, written_frames);
     This->written_frames += written_frames;
     This->getbuf_last = 0;
 
@@ -2707,7 +2704,7 @@
     }
 
     This->written_frames += done;
-    This->held_frames -= done;
+    InterlockedExchangeAdd(&This->held_frames, -done);
     This->lcl_offs_frames += done;
     This->lcl_offs_frames %= This->bufsize_frames;
     This->getbuf_last = 0;

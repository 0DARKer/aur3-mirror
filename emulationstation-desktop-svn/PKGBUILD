# Maintainer: SSF <punx69 at gmx dot net>

pkgname=emulationstation-desktop-svn
pkgrel=1
pkgver=r1259.2.0.0rc1
pkgdesc="A graphical front-end for emulators with controller navigation. (a more desktop specific build)"
arch=('i686' 'x86_64')
url="https://github.com/Aloshi/EmulationStation"
license=('MIT' 'CCPL:cc-by-nc-sa-2.0')
makedepends=('subversion' 'boost' 'eigen' 'glu' 'cmake' 'mesa' 'coreutils' 'p7zip' 'make' 'gawk' 'sed')
depends=('alsa-lib' 'sdl2' 'boost-libs' 'freeimage' 'curl' 'freetype2' 'expat' 'bzip2')
conflicts=('emulationstation-git' 'emulationstation-themes' 'emulationstation-git-unstable' 'emulationstation-git-unstable-rpi')
provides=("emulationstation=$pkgver")
_svntrunk=https://github.com/Aloshi/EmulationStation/trunk
_svnmod="$pkgname"
###this is non-free
_themezip=http://www.emulationstation.org/downloads/themes/simple_latest.zip

pkgver() {
	cd "$srcdir"/"$_svnmod"  >/dev/null 2>&1
	releaseversion=$(cat es-app/src/EmulationStation.h | grep "PROGRAM_VERSION_STRING" | awk '{print $3}' | sed -e 's#"##g' -e 's#-##g')
	local ver="$(svnversion)"
	printf "r%s" "${ver//[[:alpha:]]}.$releaseversion"
}

_make() {
	read -p "Would you like to optimize your build (march=native)? [y/N] " reply
	case $(echo $reply | tr '[A-Z]' '[a-z]') in
		y|yes)
			export CFLAGS='-march=native -pipe'
			export CXXFLAGS="$CFLAGS"
			;;
		*)
			msg "using default flags"
			;;
	esac
	cmake -DCMAKE_BUILD_TYPE=Release ..
###this seems to be good for the most cpu's and keeps the desktop responsive
	make -j$(expr $(nproc) \* 2 - 1) -l$(nproc)
}

build() {
	cd "$srcdir"
	msg "Connecting to SVN server..."
	if [ -d "$_svnmod/.svn" ]; then
		(cd "$_svnmod" && svn up .)
	else
		svn co "$_svntrunk" --config-dir ./ "$_svnmod"
	fi
	msg "SVN checkout done or server timeout"
	mkdir -p "$srcdir/$_svnmod/build"
	cd "$srcdir/$_svnmod/build"
	_make
#####themes
	curl -L "$_themezip" >"$srcdir/$_svnmod/build/simple_latest.zip"
	7z x simple_latest.zip
}

package() {
	cd $_svnmod
	install -Dm755 "$srcdir/$_svnmod/emulationstation" "$pkgdir/usr/bin/emulationstation"
	install -Dm644 "$srcdir/$_svnmod/LICENSE.md" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
	install -Dm644 "$srcdir/$_svnmod/opensans_license.txt" "$pkgdir/usr/share/licenses/$pkgname/opensans.LICENSE"
	mkdir -p "$pkgdir/etc/emulationstation/themes"
	cp "$srcdir/$_svnmod/build/simple/readme.txt" "$pkgdir/usr/share/licenses/$pkgname/simpletheme.LICENSE"
	mv "$srcdir/$_svnmod/build/simple" "$pkgdir"/etc/emulationstation/themes
	chmod -R 0755 "$pkgdir"/etc/emulationstation/themes
###create a desktop file
	install -Dm644 "$srcdir/$_svnmod/data/resources/window_icon_256.png" "$pkgdir/usr/share/pixmaps/emulationstation.png"
	mkdir -p "$pkgdir/usr/share/applications"
cat <<EOF >> "$pkgdir/usr/share/applications/emulatorstation.desktop"
[Desktop Entry]
Name=EmulationStation
GenericName=Emulator front-end
Comment=A universal emulator front-end
Exec=emulationstation
Terminal=false
Type=Application
Icon=emulationstation
Categories=Application;Game;
StartupNotify=false
EOF
}

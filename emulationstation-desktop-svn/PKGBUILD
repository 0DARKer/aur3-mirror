# Contributor: Drew Liszewski <drew dot liszewski at gmail dot com>
# Contributor: Daniel Varga <varga dot daniel at gmx dot de>
# Maintainer: SSF <punx69 at gmx dot net>

pkgname=emulationstation-desktop-svn
pkgrel=1
pkgver=r1259
pkgdesc="A graphical front-end for emulators with controller navigation.(desktop build)"
arch=('i686' 'x86_64')
url="https://github.com/Aloshi/EmulationStation"
license=('MIT' 'CCPL:cc-by-nc-sa-2.0')
makedepends=('subversion' 'boost'  'eigen' 'cmake' 'mesa' 'libsm' 'coreutils' 'wget' 'unzip' 'make')
optdepends=()
depends=('alsa-lib' 'sdl2' 'boost-libs' 'freeimage' 'glu' 'curl' 'freetype2' 'expat' 'bzip2')
source=()
conflicts=('emulationstation-git' 'emulationstation-themes' 'emulationstation-git-unstable' 'emulationstation-git-unstable-rpi')
provides=('emulationstation=${pkgver}"' 'emulationstation-themes=${pkgver}"')
md5sums=()
sha384sums=()
sha512sums=()
_svntrunk=https://github.com/Aloshi/EmulationStation/trunk
_svnmod="$pkgname"

###note: this is non-free
_themezip=http://www.emulationstation.org/downloads/themes/simple_latest.zip

pkgver() {
  cd "$srcdir"/"$_svnmod"  >/dev/null 2>&1
  local ver="$(svnversion)"
  printf "r%s" "${ver//[[:alpha:]]}"
}

build() {
	cd "$srcdir"
	msg "Connecting to SVN server..."
	if [ -d "$_svnmod/.svn" ]; then
		(cd "$_svnmod" && svn up .)
	else
		svn co "$_svntrunk" --config-dir ./ "$_svnmod"
	fi
	msg "SVN checkout done or server timeout"
    mkdir -p "$srcdir/$_svnmod/build"
    cd "$srcdir/$_svnmod/build"
    cmake -DCMAKE_BUILD_TYPE=Release ..
    make -j$(nproc)
    #####themes
    wget --progress=dot --tries=5 "$_themezip" -O "$srcdir/$_svnmod/build/simple_latest.zip"  2>&1 | grep --line-buffered "%"
	unzip -o simple_latest.zip
}

package() {
    cd $_svnmod
    install -Dm755 "$srcdir/$_svnmod/emulationstation" "$pkgdir/usr/bin/emulationstation"
    install -Dm644 "$srcdir/$_svnmod/LICENSE.md" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    install -Dm644 "$srcdir/$_svnmod/opensans_license.txt" "$pkgdir/usr/share/licenses/$pkgname/opensans.LICENSE"
    mkdir -p "$pkgdir/etc/emulationstation/themes"
    cp "$srcdir/$_svnmod/build/simple/readme.txt" "$pkgdir/usr/share/licenses/$pkgname/simpletheme.LICENSE"
    mv "$srcdir/$_svnmod/build/simple" "$pkgdir"/etc/emulationstation/themes
    ###create a desktop file
	install -Dm644 "$srcdir/$_svnmod/data/resources/window_icon_256.png" "$pkgdir/usr/share/pixmaps/emulationstation.png"
    mkdir -p "$pkgdir/usr/share/applications"
cat <<EOF >> "$pkgdir/usr/share/applications/emulatorstation.desktop"
[Desktop Entry]
Name=EmulationStation
GenericName=Emulator front-end
Comment=A universal emulator front-end
Exec=emulationstation
Terminal=false
Type=Application
Icon=emulationstation
Categories=Application;Game;
StartupNotify=false
EOF
}


#actual maintiner: ilikenwf/Matt Parnell <parwok@gmail.com>
# Contributor: Bartek Piotrowski <barthalion@gmail.com>
# Contributor: Det <nimetonmaili AT gmail dot com>
# Contributor: Dan Vratil <vratil@progdansoft.com>
# Contributor: Ng Oon-Ee <n g o o n e e AT g mail dot com>
# Contributor: Amaury Couste <amaury.couste@gmail.com>
# Contributor: James Rayner <iphitus@gmail.com>
# Contributor: Thomas Baechler <thomas@archlinux.org>
# Contributor: Nuno Aniceto aka quarkup <nuno.aja@gmail.com>
# Contributor: mar77i <mysatyre at gmail dot com>
# Contributor: Peter Maatman <blackwolf12333@gmail.com>

pkgname='nvidia-zen'
true && pkgname=('nvidia-zen' 'nvidia-utils' 'nvidia-libgl')
pkgver='337.19'
pkgrel=1
_kernver=$(uname -r)
pkgdesc="NVIDIA drivers for the custom built zen-kernel"
url='http://www.nvidia.com/'
arch=('i686' 'x86_64')
license=('custom')

if [ "$CARCH" = "i686" ]; then
    _arch='x86'
    _pkg="NVIDIA-Linux-${_arch}-${pkgver}"
    source=("http://us.download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run")
    md5sums=('cf8e88e313928eb7a4d6f652ff287717')
elif [ "$CARCH" = "x86_64" ]; then
    _arch=$CARCH
    _pkg="NVIDIA-Linux-${_arch}-${pkgver}"
    source=("http://us.download.nvidia.com/XFree86/Linux-${_arch}/${pkgver}/${_pkg}.run")
    md5sums=('c23c7696ab71f3ad28f292159360b21c')
fi

_compress=y

build() {
    rm -rf "${_pkg}"
    # Extract the nvidia drivers
    sh "${_pkg}.run" --extract-only

	msg "Building module..."
	cd "${srcdir}/${_pkg}/kernel"
	make module
}

package_nvidia-utils() {
    pkgdesc='NVIDIA drivers utilities and libraries'
    depends=('xorg-server' 'libxvmc')
    optdepends=('gtk2: nvidia-settings')
    conflicts=('')
    provides=('libcl')
    install='nvidia-utils.install'

    cd "${_pkg}"
    install -D -m755 nvidia_drv.so "$pkgdir/usr/lib/xorg/modules/drivers/nvidia_drv.so"
    # VDPAU
    install -D -m755 "libvdpau_nvidia.so.$pkgver" "$pkgdir/usr/lib/vdpau/libvdpau_nvidia.so.$pkgver"
    # CUDA
    install -D -m755 "libcuda.so.$pkgver" "$pkgdir/usr/lib/libcuda.so.$pkgver"
    install -D -m755 "libnvcuvid.so.$pkgver" "$pkgdir/usr/lib/libnvcuvid.so.$pkgver"
    # nvidia-tls library
    install -D -m755 "tls/libnvidia-tls.so.$pkgver" "$pkgdir/usr/lib/libnvidia-tls.so.$pkgver"

    install -D -m755 "libnvidia-cfg.so.$pkgver" "$pkgdir/usr/lib/libnvidia-cfg.so.$pkgver"
    install -D -m755 "libnvidia-ml.so.$pkgver" "$pkgdir/usr/lib/libnvidia-ml.so.$pkgver"

    # create soname links - in an unbelievably ugly fashion.
    while read -d '' _lib; do
        _soname="$(dirname ${_lib})/$(readelf -d "$_lib" | sed -nr 's/.*Library soname: \[(.*)\].*/\1/p')"
        [[ -e "${_soname}" ]] || ln -s "$(basename ${_lib})" "${_soname}"
        [[ -e "${_soname/.[0-9]*/}" ]] || ln -s "$(basename ${_soname})" "${_soname/.[0-9]*/}"
    done < <(find "$pkgdir" -type f -name '*.so*' -print0)

    # nvidia-xconfig
    install -D -m755 nvidia-xconfig "$pkgdir/usr/bin/nvidia-xconfig"
    install -D -m644 nvidia-xconfig.1.gz "$pkgdir/usr/share/man/man1/nvidia-xconfig.1.gz"
    # nvidia-settings
    install -D -m755 nvidia-settings "$pkgdir/usr/bin/nvidia-settings"
    install -D -m644 nvidia-settings.1.gz "$pkgdir/usr/share/man/man1/nvidia-settings.1.gz"
    install -D -m644 nvidia-settings.desktop "$pkgdir/usr/share/applications/nvidia-settings.desktop"
    install -D -m644 nvidia-settings.png "$pkgdir/usr/share/pixmaps/nvidia-settings.png"
    sed -i 's:__UTILS_PATH__:/usr/bin:; s:__PIXMAP_PATH__:/usr/share/pixmaps:' \
           "$pkgdir/usr/share/applications/nvidia-settings.desktop"
    # nvidia-bug-report
    install -D -m755 nvidia-bug-report.sh "$pkgdir/usr/bin/nvidia-bug-report.sh"
    # nvidia-smi
    install -D -m755 nvidia-smi "$pkgdir/usr/bin/nvidia-smi"
    install -D -m644 nvidia-smi.1.gz "$pkgdir/usr/share/man/man1/nvidia-smi.1.gz"

    install -D -m644 LICENSE "$pkgdir/usr/share/licenses/nvidia/LICENSE"
    ln -s nvidia "$pkgdir/usr/share/licenses/nvidia-utils"
    install -D -m644 README.txt "$pkgdir/usr/share/doc/nvidia/README"
    install -D -m644 NVIDIA_Changelog "$pkgdir/usr/share/doc/nvidia/NVIDIA_Changelog"
    ln -s nvidia "$pkgdir/usr/share/doc/nvidia-utils"
}

package_nvidia-zen(){
    pkgdesc='NVIDIA drivers for the zen-kernel'
    conflicts=('nvidia-71xx' 'nvidia-96xx' 'nvidia-173xx' 'nvidia-legacy' 'nvidia' 'nvidia-ck')
    depends=("nvidia-utils")
    makedepends=('linux-headers')
    provides=('nvidia')
    install='nvidia-zen.install'
    options=(!strip)
    _modname="nvidia.ko"

	if [ $_compress = "y" ]; then
		msg2 "Compressing module with gzip..."
		gzip -9 "${srcdir}/${_pkg}/kernel/$_modname"
		_modname="nvidia.ko.gz"
	fi
	msg2 "Installing module..."
	install -D -m644 "${srcdir}/${_pkg}/kernel/$_modname" "${pkgdir}/lib/modules/${_kernver}/kernel/drivers/video/$_modname"

    # Blacklist the Nouveau driver (avoiding possible conflicts by appending the -all suffix)
    install -d -m755 "${pkgdir}/etc/modprobe.d"
    echo "blacklist nouveau" > "${pkgdir}/etc/modprobe.d/nouveau_blacklist-all.conf"
}

package_nvidia-libgl(){
    pkgdesc="NVIDIA drivers libraries symlinks"
    depends=('nvidia-utils')
    conflicts=('libgl')
    provides=('libgl')
    cd "${srcdir}/${_pkg}"

    mkdir -p "${pkgdir}/usr/lib/xorg/modules/extensions"
    ln -s "/usr/lib/nvidia/xorg/modules/extensions/libglx.so.${pkgver}" "${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so.${pkgver}"
    ln -s "libglx.so.${pkgver}" "${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so.1"
    ln -s "libglx.so.${pkgver}" "${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so"

    ln -s "/usr/lib/nvidia/libGL.so.${pkgver}" "${pkgdir}/usr/lib/libGL.so.${pkgver}"
    ln -s "libGL.so.${pkgver}" "${pkgdir}/usr/lib/libGL.so.1"
    ln -s "libGL.so.${pkgver}" "${pkgdir}/usr/lib/libGL.so"

    ln -s "/usr/lib/nvidia/libEGL.so.${pkgver}" "${pkgdir}/usr/lib/libEGL.so.${pkgver}"
    ln -s "libEGL.so.${pkgver}" "${pkgdir}/usr/lib/libEGL.so.1"
    ln -s "libEGL.so.${pkgver}" "${pkgdir}/usr/lib/libEGL.so"

    ln -s "/usr/lib/nvidia/libGLESv1_CM.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv1_CM.so.${pkgver}"
    ln -s "libGLESv1_CM.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv1_CM.so.1"
    ln -s "libGLESv1_CM.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv1_CM.so"

    ln -s "/usr/lib/nvidia/libGLESv2.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv2.so.${pkgver}"
    ln -s "libGLESv2.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv2.so.2"
    ln -s "libGLESv2.so.${pkgver}" "${pkgdir}/usr/lib/libGLESv2.so"

    mkdir -p "${pkgdir}/usr/share/licenses"
    ln -s nvidia "${pkgdir}/usr/share/licenses/nvidia-libgl"
}

#package_libegl(){
    
#}

#package_libgles(){
    
#}

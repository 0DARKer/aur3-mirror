# Contributor: Andrew Fischer <andrew_at_lightningtoads.com>

pkgname=pvfs
pkgver=2.8.2
pkgrel=2
pkgdesc="PVFS2 is a parallel file system designed for parallel applications sharing data across many clients in a coordinated manner."
arch=('i686' 'x86_64')
license=("LGPL")
makedepends=('kernel26-headers')
depends=('fuse')
optdepends=('gkt2: for the karma GUI')
url="http://www.pvfs.org/"
source=("http://mirror.anl.gov/pub/pvfs2/$pkgname-$pkgver.tar.gz")
md5sums=('bce2c601df8bd6bad9de876959e1e3f9')
install=pvfs.install

build() {
  # Setup server and client daemon scripts
  mkdir -p $pkgdir/etc/rc.d
  mkdir -p $pkgdir/etc/conf.d
  cp $startdir/pvfs2-server $pkgdir/etc/rc.d
  cp $startdir/pvfs2-client $pkgdir/etc/rc.d
  cp $startdir/pvfs2-server.conf $pkgdir/etc/conf.d
  chmod 755 $pkgdir/etc/rc.d/pvfs2-server
  chmod 755 $pkgdir/etc/rc.d/pvfs2-client

  _kernelver=$(eval 'uname -r')

  cd $srcdir/$pkgname-$pkgver || return 1

  patch -p0 < $startdir/pvfs.patch || return 1

  mkdir -p build-$_kernelver && cd build-$_kernelver || return 1

  ../configure --prefix=/usr --enable-fuse --disable-segv-backtrace || return 1

  make || return 1
  make DESTDIR=$pkgdir install || return 1
  
  chmod 644 $pkgdir/usr/lib/libpvfs2.a
}

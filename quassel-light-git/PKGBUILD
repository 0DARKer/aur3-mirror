# Contributor: Daniel Albers <daniel@lbe.rs>

######################################
# This is actually a split PKGBUILD. #
# To use it as such, set $_aur=0.    #
######################################
_aur=1

pkgbase='quassel-light-git'
pkgname=("$pkgbase")
package() {
  package_$pkgname
}

[[ $_aur -eq 1 ]] || pkgbase='quassel'
[[ $_aur -eq 1 ]] || pkgname=('quassel-git'
                  'quassel-light-git'
                  'quassel-client-git'
                  'quassel-client-light-git'
                  'quassel-core-git'
	          #TODO: quassel-common
         )

pkgver=0.10.pre
pkgrel=3
url='http://quassel-irc.org'
license=('GPL')
arch=('i686' 'x86_64')
depends=('qt4')
makedepends=('git' 'cmake')
provides=('quassel')
conflicts=('quassel')
source=(
  'git+https://github.com/quassel/quassel.git'
 #'git://git.quassel-irc.org/quassel.git'
  'quassel-core.service'
  'quassel-core.conf'
  'quassel-core.install'
)

md5sums=('SKIP'
         'e50d4cb77f91464ee5f673d14d3ea94c'
         '331f2036ae4d31930b7a71f261bda284'
         '108f7dedee6785b60ffbb981eb7d02c7')
sha1sums=('SKIP'
          '48fc05d73281ff0332ab7ca6cfb9283e0c65a831'
          '27e2e6eb3fdc0173c9739e0d23618b91aad803d1'
          '317b7630d3c0d6b49d74a5f9730ee65387981abb')
sha512sums=('SKIP'
            'd6cf55f6c624ecb48a313d29ec88609f04c9443ce9b83dab0dba29e595e01af768e42a4efa9484a7252586b9ab1dd78debce27740aabf502020a494272e8b3f4'
            'db4d26eb86775feb23c86390b0ffc64d827599445973385c8e6732fc987639630bda94d4e4c4260abc4402a48b54e8ab980d486e57ea60098c5fdef2d0e98567'
            '41b64892a48fd16d8cc7660b1de0cb871b484e4c914966552bad8475c6f60d9e0c15725677fea92952bbd4647eabb2d7d6caa9c01b979bae7db8ebb46be1c22f')

_gitdir="${startdir}/quassel"
_srcdir="${startdir}/src/quassel"
[[ $_aur -eq 1 ]] || _gitdir="${startdir}/${pkgbase}"
[[ $_aur -eq 1 ]] || _srcdir="${startdir}/src/${pkgbase}"

_builddir="${startdir}/build"
_cmakecache="CMakeCache.txt"

_debug=0
if [[ $_debug == 0 ]]; then
  exec 3> /dev/null
else
  exec 3>& 1
fi

package_quassel-git() {
  pkgdesc='KDE-based IRC client (monolithic version)'
  depends='kdelibs'
  makedepends=('automoc4' 'cmake')

  _prepare_build

  pushd "$_builddir" >& 3

  msg 'Configuring build options...'
  cmake -DWANT_MONO=ON              \
        -DWANT_CORE=OFF             \
        -DWANT_QTCLIENT=OFF         \
        -DWITH_OPENSSL=ON           \
        -DWITH_KDE=ON               \
        -DWITH_WEBKIT=ON            \
	-DCMAKE_INSTALL_PREFIX=/usr \
	"$_srcdir"

  popd >& 3
  _build
}

package_quassel-light-git() {
  pkgdesc='Qt-based IRC client (monolithic version)'

  _prepare_build

  pushd "$_builddir" >& 3

  msg 'Configuring build options...'
  cmake -DWANT_MONO=ON              \
        -DWANT_CORE=OFF             \
        -DWANT_QTCLIENT=OFF         \
        -DWITH_OPENSSL=ON           \
        -DWITH_KDE=OFF              \
        -DWITH_WEBKIT=OFF           \
	-DCMAKE_INSTALL_PREFIX=/usr \
	"$_srcdir"

  popd >& 3
  _build
}

package_quassel-client-git() {
  pkgdesc='KDE-based distributed IRC client (client only)'
  depends='kdelibs'
  makedepends=('automoc4' 'cmake')
  provides=('quassel-client')
  conflicts=('quassel-client')

  _prepare_build

  pushd "$_builddir" >& 3

  msg 'Configuring build options...'
  cmake -DWANT_MONO=OFF             \
        -DWANT_CORE=OFF             \
        -DWANT_QTCLIENT=ON          \
        -DWITH_OPENSSL=ON           \
        -DWITH_KDE=ON               \
        -DWITH_WEBKIT=ON            \
	-DCMAKE_INSTALL_PREFIX=/usr \
	"$_srcdir"

  popd >& 3
  _build
}

package_quassel-client-light-git() {
  pkgdesc='Qt-based distributed IRC client (client only)'
  provides=('quassel-client')
  conflicts=('quassel-client')

  _prepare_build

  pushd "$_builddir" >& 3

  msg 'Configuring build options...'
  cmake -DWANT_MONO=OFF             \
        -DWANT_CORE=OFF             \
        -DWANT_QTCLIENT=ON          \
        -DWITH_OPENSSL=ON           \
        -DWITH_KDE=OFF              \
        -DWITH_WEBKIT=OFF           \
	-DCMAKE_INSTALL_PREFIX=/usr \
	"$_srcdir"

  popd >& 3
  _build
}

package_quassel-core-git() {
  pkgdesc='KDE/Qt-based distributed IRC client (core only)'
  provides=('quassel-core')
  conflicts=('quassel-core')
  backup=('etc/conf.d/quassel-core.conf')

  _prepare_build

  pushd "$_builddir" >& 3

  msg 'Configuring build options...'
  cmake -DWANT_MONO=OFF             \
        -DWANT_CORE=ON              \
        -DWANT_QTCLIENT=OFF         \
        -DWITH_OPENSSL=ON           \
	-DCMAKE_INSTALL_PREFIX=/usr \
	"$_srcdir"

  popd >& 3
  _build

  install -D "${startdir}/${pkgname%-git}.service" "${pkgdir}/usr/lib/systemd/system/${pkgname%-git}.service"
  install -D "${startdir}/${pkgname%-git}.conf" "${pkgdir}/etc/conf.d/${pkgname%-git}.conf"
}

pkgver() {
  pushd "$_gitdir" >& 3
  git describe --always | sed 's/-/./g;'
  popd >& 3
}

_prepare_build() {
  msg 'Preparing build directory...'
  mkdir -p "$_builddir"
  pushd "$_builddir" >& 3
  rm -f "$_cmakecache"
  popd >& 3
}

_build() {
  pushd "$_builddir" >& 3

  msg 'Compiling...'
  make

  make DESTDIR="$pkgdir" install
}

pkgdesc='KDE/Qt-based distributed IRC client'

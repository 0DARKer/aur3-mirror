pkgname=voglperf-git
_name=voglperf
pkgver=16.b037ede
pkgrel=1
pkgdesc="Benchmarking tool for Linux OpenGL games. Spews frame information every second."
url="https://github.com/ValveSoftware/voglperf"
arch=('i686' 'x86_64')
license=('BSD') # i think
#depends=("sdl2") 
makedepends=("cmake")
#[ "$CARCH" = "x86_64" ] && depends=("lib32-sdl2" "sdl2")
options=('!libtool')
source=('git+https://github.com/ValveSoftware/voglperf.git'
"fix-appids-path.patch"
"fix-libvoglperf-path.patch"
"index.html.patch")

pkgver() {
  cd "$_name"
  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

build() {
  #  export CFLAGS="-Og -ggdb"
  #  export CXXFLAGS="-Og -ggdb"
  cd "$_name"
  #sed -i "s/libSDL2.a/SDL2/g" src/CMakeLists.txt # we don't have static sdl2 on arch
  git apply -v "$srcdir/index.html.patch"
  git apply -v "$srcdir/fix-appids-path.patch"
  git apply -v "$srcdir/fix-libvoglperf-path.patch"

  #  ./autogen.sh
  #  ./configure --prefix=/usr \

    make voglperf32 # always 32 bit
  [ "$CARCH" = "x86_64" ] &&  make voglperf64
}

#check() {
#  cd "$_name"
#  make -k check
#}

package() {
  cd "$_name"
  #  make DESTDIR="$pkgdir" install
  install -d "$pkgdir/usr/bin"
  install -d "$pkgdir/usr/lib"

  install -m 755 bin/voglperfrun* "$pkgdir/usr/bin"

  # on 64 bit, 64 bit libraries go into /usr/lib
  # and also create /usr/lib32 and put the 32 bit library there
  [ "$CARCH" = "x86_64" ] && install -d "$pkgdir/usr/lib32" || true
  [ "$CARCH" = "x86_64" ] && install -m 755 bin/libvoglperf32.so "$pkgdir/usr/lib32" || true
  [ "$CARCH" = "x86_64" ] && install -m 755 bin/libvoglperf64.so "$pkgdir/usr/lib" || true

  # on 32 bit, 32 bit libraries go into /usr/lib
  [ "$CARCH" = "i686" ] && install -m 755 bin/libvoglperf32.so "$pkgdir/usr/lib" || true

  install -d "$pkgdir/usr/share/voglperf"
  install -m 755 bin/appids.txt "$pkgdir/usr/share/voglperf"
  install -m 755 bin/index.html "$pkgdir/usr/share/voglperf/index.html"
}

md5sums=('SKIP'
         '588f17d17f5a6770cc78145ae2c4c414'
         '36235bb062d5bc4dc3ebb7a1ef45b30e'
         '499e48ec1909d7d9f6588f45dad3999c')

# Maintainer: SysGhost <sysghost[at]gmail[dot]com>
_pkgbase=asus_oled
pkgname=asus_oled-dkms
pkgver=r103
pkgrel=7
pkgdesc="Driver for small OLED displays found in some older Asus laptops. Ugly-patched for >3.14 kernels."
url="http://lapsus.berlios.de/asus_oled.html"
arch=('x86_64' 'i686')
license=('GPL2')
depends=('dkms')
makedepends=('sed')
provides=("${_pkgbase}")
conflicts=("${_pkgbase}")
install="${pkgname}.install"
source=("${pkgname}.tar.gz"
        "dkms.conf")
md5sums=('a8e75d0f2e9c3b6292d9e0974a199874'
         '58305c014ea083e3113ee4a435c18aa8')

build() {
  cd "${_pkgbase}-${pkgver}"
  make clean
  make
  rm modules.order
}

package() {
  # Prepare Makeile
  sed -i 's/depmod/\#depmod/g' "${_pkgbase}-${pkgver}"/Makefile

  # Install
  msg2 "Starting make install..."
  make -C "${_pkgbase}-${pkgver}" PREFIX="${pkgdir}/usr" DESTDIR="${pkgdir}/usr" INSTALL_MOD_PATH="/usr/lib/modules/$(uname -r)/extra" install

  # Copy dkms.conf
  install -Dm644 dkms.conf "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf

  # Set name and version
  sed -e "s/@_PKGBASE@/${_pkgbase}/" \
      -e "s/@PKGVER@/${pkgver}/" \
      -i "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf

  # Copy sources (including Makefile)
  cp -r "${_pkgbase}-${pkgver}"/* "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/
}


#package() {
#  cd "${_pkgbase}-${pkgver}"
#  ls -1 > /home/sysghost/AUR/debug.txt
#  # Disable depmod. Cannot run it during package time. It'll be handled by "dkms install" in the install script instead.
#  sed -i 's/depmod/\#depmod/g' Makefile
#
#  # Install the module inside the chroot.
#  make PREFIX="${pkgdir}/usr" DESTDIR="${pkgdir}/usr" INSTALL_MOD_PATH="/usr/lib/modules/$(uname -r)/extra" install
#
#  # Copy license and dkms.conf
#  install -Dm644 COPYING "${pkgdir}/usr/share/licenses/${_pkgbase}/COPYING"
#  install -Dm644 ../dkms.conf "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf
#
#  # Prepare "dkms.conf"
#  sed -e "s/@_PKGBASE@/${_pkgbase}/" \
#      -e "s/@PKGVER@/${pkgver}/" \
#      -i "${pkgdir}"/usr/src/${_pkgbase}-${pkgver}/dkms.conf
#
#  # Copy Sources
#  cp -r * "${pkgdir}"/usr/src/"${_pkgbase}-${pkgver}"/
#}

# vim:set ts=2 sw=2 et:

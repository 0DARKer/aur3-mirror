pkgname=icinga
pkgver=1.6.1
pkgrel=1
pkgdesc="Icinga is an open source host, service and network monitoring program."
license=('GPL')
arch=('i686' 'x86_64')
url="http://www.icinga.org"
depends=('gd' 'freetype2' 'libtool' 'libdbi')
optdepends=('nagios-plugins: plugins needed for icinga checks')
source=("http://downloads.sourceforge.net/project/icinga/icinga/$pkgver/$pkgname-$pkgver.tar.gz" 
        "rc.icinga" "icinga.install")
md5sums=('7b32e589235dd74ea020f12cbc90ec31'
         '3d08782ae1c41d1c9735510e686a0a22'
         '73f4dfb35e1e809130cb123d10821e1f')                                    
backup=('etc/httpd/conf/extra/icinga.conf')
install=('icinga.install')

build() {
  cd $startdir/src/$pkgname-$pkgver

  _instdir="usr/share/icinga"
  _bindir="usr/bin"
  _vardir="var/icinga"
  _confdir="etc/icinga"
  _httpdconfdir="etc/httpd/conf/extra"
  _checkresultdir="var/icinga/spool/checkresults"
  _icinga_user="icinga"
  _icinga_group="icinga"

  getent group $_icinga_group || _icinga_group=667 >/dev/null
  getent passwd $_icinga_user || _icinga_user=667 >/dev/null

  ./configure \
    --with-icinga-user=$_icinga_user \
    --with-icinga-group=$_icinga_user \
    --prefix="/$_instdir" \
    --bindir="/$_bindir" \
    --localstatedir="/$_vardir" \
    --sysconfdir="/$_confdir" \
    --with-httpd-conf="/$_httpdconfdir" \
    --with-checkresultdir="/$_checkresultdir" \
    --enable-idoutils \
    --enable-embedded-perl \
    --enable-ssl

  make all

  make \
    prefix=$startdir/pkg/$_instdir \
    BINDIR=$startdir/pkg/$_bindir \
    LOGDIR=$startdir/pkg/$_vardir \
    CFGDIR=$startdir/pkg/$_confdir \
    HTTPD_CONF=$startdir/pkg/$_httpdconfdir \
    CHECKRESULTDIR=$startdir/pkg/$_checkresultdir \
    install install-idoutils \
    install install-config

  install -D -m 755 daemon-init $startdir/pkg/etc/icinga/
  install -D -m 755 $startdir/src/rc.icinga $startdir/pkg/etc/rc.d/icinga
  install -D -m 644 sample-config/httpd.conf $startdir/pkg/$_httpdconfdir/icinga.conf

  mkdir $startdir/pkg/var/icinga/rw
  chown $_icinga_user:$_icinga_group $startdir/pkg/var/icinga/rw

  find $startdir/pkg/etc/icinga -name '*cfg' -exec mv "{}" "{}.sample" \; > /dev/null
}

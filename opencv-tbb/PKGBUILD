# $Id: PKGBUILD 88973 2010-08-27 12:02:00Z schiv $
# Maintainer: Ray Rashif <schiv@archlinux.org>
# Contributor: Tobias Powalowski <tpowa@archlinux.org>

pkgname=opencv-tbb
_pybin=python2
_pydir=python2.7
pkgver=2.3.1
pkgrel=2
pkgdesc="Intel(R) Open Source Computer Vision Library with Threading Building Blocks and SSE3"
arch=('i686' 'x86_64')
license=('BSD')
url="http://opencv.willowgarage.com"
depends=('jasper' 'python2' 'gstreamer0.10-base'
          'gtk2' 'xine-lib' 'libdc1394' 'v4l-utils' 'intel-tbb')
makedepends=('pkg-config' 'cmake')
options=('!libtool')
provides=('opencv')
conflicts=('opencv')
source=(http://downloads.sourceforge.net/opencvlibrary/OpenCV-$pkgver.tar.bz2)
#         libpng-1.4.patch
#         v4l-mmap.patch
# 	CMakeLists.txt.patch
# 	OpenCVFindTBB.cmake.patch)
md5sums=('827c9f8aa14384c531c73aa165f9b777' )
#          '301f9108f2ee875d889c279adadb254e'
#          'c0e2d8ecba3b56974ea2169f61e4905f'
# 	  '72e7704dbc9f2b6176afcb638369485e'
# 	  '93cffabd0b6ddda305fa78a369020e1f')
build() {
  cd "$srcdir/OpenCV-$pkgver"

  # libpng 1.4 compatibility
#   patch -Np1 -i ../libpng-1.4.patch
# 
#   # fix v4l issue
#   patch -Np0 -i ../v4l-mmap.patch
#   #patch -Np2 -i ../CMakeLists.txt.patch
#   patch -Np2 -i ../OpenCVFindTBB.cmake.patch

  # fix ffmpeg-related C++ issue
  # see http://code.google.com/p/ffmpegsource/source/detail?r=311
  export CXXFLAGS="$CXXFLAGS -D__STDC_CONSTANT_MACROS"

  cmake . -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_SKIP_RPATH=ON \
          -DWITH_XINE=ON \
          -DWITH_UNICAP=OFF \
          -DPYTHON_EXECUTABLE=/usr/bin/$_pybin \
          -DPYTHON_INCLUDE_DIR=/usr/include/$_pydir \
	  -DWITH_TBB=ON \
	  -DWITH_TBB_INCLUDE_DIR=/usr/include/ \
	  -DWITH_TBB_LIB_DIR=/usr/lib \
	  -DPYTHON_LIBRARY=/usr/lib/lib$_pydir.so \
	  -DBUILD_EXAMPLES=YES \
	  -DINSTALL_C_EXAMPLES=YES \
	  -DINSTALL_PYTHON_EXAMPLES=YES           

  make
}

package() {
  cd "$srcdir/OpenCV-$pkgver"

  make DESTDIR="$pkgdir/" install

  # install license file
  install -Dm644 "$srcdir/OpenCV-$pkgver/doc/license.txt" \
    "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

# vim:set ts=2 sw=2 et:

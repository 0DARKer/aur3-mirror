# Maintainer: Jesse Jaara <gmail.com: jesse.jaara>
# Maintainer: Tavian Barnes <tavianator@gmail.com>
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Maintainer: Andreas Radke <andyrtr@archlinux.org>
# Maintainer: Thomas Dziedzic < gostrc at gmail >
# Contributor: Antti "Tera" Oja <antti.bofh@gmail.com>


pkgbase=lib32-mesa-git
pkgname=lib32-mesa-git
#pkgname=('lib32-mesa-git' 'lib32-libgl-git' 'lib32-ati-dri-git' 'lib32-intel-dri-git'
#         'lib32-unichrome-dri-git' 'lib32-mach64-dri-git' 'lib32-mga-dri-git' 'lib32-r128-dri-git'
#         'lib32-savage-dri-git' 'lib32-sis-dri-git' 'lib32-tdfx-dri-git' 'lib32-nouveau-dri-git' 'lib32-libgles-git' 'lib32-libegl-git')
pkgver=20110109
pkgrel=1
arch=(i686 x86_64)
makedepends=('git' 'pkgconfig' 'glproto-git' 'lib32-libdrm-git' 'lib32-libxxf86vm'
             'lib32-libxdamage' 'lib32-expat' 'lib32-libx11' 'lib32-libxt' 'gcc-multilib'
	     'dri2proto' 'python2' 'lib32-libxml2' 'imake' 'lib32-talloc')
url="http://mesa3d.sourceforge.net"
license=('custom')

_gitroot='git://anongit.freedesktop.org/git/mesa/mesa'
_gitname='mesa'

build() {
  ## To use clang uncomment te folliwing 2 lines
  #export CC="clang -m32"
  #export CXX="clang++ -m32"
  #and commnet out or delete the 2 following line

  export CC="gcc -m32"
  export CXX="g++ -m32"
  export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

  msg 'Connecting to git.freedesktop.org GIT server....'
  if [ -d ${_gitname} ] ; then
    cd ${_gitname} && git pull origin
  else
    git clone ${_gitroot}
  fi
  msg 'GIT checkout done or server timeout'
  msg 'Starting make...'

  cd ${srcdir}

  # Cleanup and prepare the build dir
  [ -d build ] && rm -rf build
  cp -r ${_gitname} build
  cd build

  # python2 build fixes
  sed -i -e "s|#![ ]*/usr/bin/python$|#!/usr/bin/python2|" \
         -e "s|#![ ]*/usr/bin/env python$|#!/usr/bin/env python2|" $(find $srcdir -name '*.py')
  sed -i -e "s|PYTHON2 = python|PYTHON2 = python2|" "${srcdir}"/build/configs/{default,autoconf.in}
  sed -i -e "s|python|python2|" "${srcdir}"/build/src/gallium/auxiliary/Makefile

  ./autogen.sh --prefix=/usr \
    --with-dri-driverdir=/usr/lib32/xorg/modules/dri \
    --enable-gallium-radeon \
    --enable-gallium-r600 \
    --enable-gallium-nouveau \
    --enable-gallium-swrast \
    --enable-glx-tls \
    --with-driver=dri \
    --enable-xcb \
    --with-state-trackers=dri,glx,egl \
    --disable-glut \
    --enable-gles1 \
    --enable-gles2 \
    --enable-egl \
    --enable-shared-dricore \
    --enable-32-bit  \
    --libdir=/usr/lib32
  make
}

package_lib32-libgl-git() {
  depends=('lib32-libdrm-git' 'lib32-libxxf86vm' 'lib32-libxdamage' 'lib32-expat' 'libgl-git')
  conflicts=('lib32-libgl')
  provides=('lib32-libgl=7.10')
  pkgdesc="Mesa 3-D graphics library and DRI software rasterizer"

  cd "${srcdir}"/build
  install -m755 -d "${pkgdir}/usr/lib32"
  install -m755 -d "${pkgdir}/usr/lib32/xorg/modules/extensions"

  bin/minstall lib/libGL.so* "${pkgdir}/usr/lib32/"

  cd src/mesa/drivers/dri
  #make -C swrast DESTDIR="${pkgdir}" install
  make -C "${srcdir}"/build/src/gallium/targets/dri-swrast DESTDIR="${pkgdir}" install
  ln -s swrastg_dri.so "${pkgdir}/usr/lib32/xorg/modules/dri/swrast_dri.so"
  ln -s libglx.xorg "${pkgdir}/usr/lib32/xorg/modules/extensions/libglx.so"
}

package_lib32-libgles-git() {
  depends=('lib32-libgl-git')
  conflicts=('lib32-libgles')
  provides=("lib32-libgles=${_mesaver}")
  pkgdesc="Mesa GLES libraries and headers"

  cd "${srcdir}"/build
  install -m755 -d "${pkgdir}/usr/lib"
  bin/minstall lib/libGLESv* "${pkgdir}/usr/lib32/"
}

package_lib32-libegl-git() {
  depends=('lib32-libgl-git')
  conflicts=('lib32-libegl-git')
  provides=("lib32-libegl=${_mesaver}")
  pkgdesc="Mesa libEGL libraries and headers"

  cd "${srcdir}"/build
  install -m755 -d "${pkgdir}/usr/lib32"
  install -m755 -d "${pkgdir}/usr/lib32/egl"
  bin/minstall lib/libEGL.so* "${pkgdir}/usr/lib32/"
  bin/minstall lib/egl/* "${pkgdir}/usr/lib32/egl/"
}

package_lib32-ati-dri-git() {
  depends=('lib32-libgl-git' 'ati-dri-git')
  conflicts=('lib32-ati-dri')
  provides=('lib32-ati-dri=7.10')
  pkgdesc="Mesa DRI + Gallium3D r300 drivers for AMD/ATI Radeon"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C radeon DESTDIR="${pkgdir}" install
  make -C r200 DESTDIR="${pkgdir}" install
  make -C ${srcdir}/build/src/gallium/targets/dri-r300 DESTDIR="${pkgdir}" install
  make -C ${srcdir}/build/src/gallium/targets/dri-r600 DESTDIR="${pkgdir}" install
}

package_lib32-intel-dri-git() {
  depends=('lib32-libgl-git' 'intel-dri-git')
  conflicts=('lib32-intel-dri')
  provides=('lib32-intel-dri=7.10')
  pkgdesc="Mesa DRI drivers for Intel"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C i810 DESTDIR="${pkgdir}" install
  make -C i915 DESTDIR="${pkgdir}" install
  make -C i965 DESTDIR="${pkgdir}" install
}

package_lib32-unichrome-dri-git() {
  depends=('lib32-libgl-git' 'unichrome-dri-git')
  conflicts=('lib32-unichrome-dri')
  provides=('lib32-unichrome-dri=7.10')
  pkgdesc="Mesa DRI drivers for S3 Graphics/VIA Unichrome"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C unichrome DESTDIR="${pkgdir}" install
}

package_lib32-mach64-dri-git() {
  depends=('lib32-libgl-git' 'mach64-dri-git')
  conflicts=('lib32-mach64-dri')
  provides=('lib32-mack64-dri=7.10')
  pkgdesc="Mesa DRI drivers for ATI Mach64"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C mach64 DESTDIR="${pkgdir}" install
}

package_lib32-mga-dri-git() {
  depends=('lib32-libgl-git' 'mga-dri-git')
  conflicts=('lib32-mga-dri')
  provides=('lib32-mga-dri=7.10')
  pkgdesc="Mesa DRI drivers for Matrox"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C mga DESTDIR="${pkgdir}" install
}

package_lib32-r128-dri-git() {
  depends=('lib32-libgl-git' 'r128-dri-git')
  conflicts=('lib32-r128-dri')
  provides=('lib32-r128-dri=7.10')
  pkgdesc="Mesa DRI drivers for ATI Rage128"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C r128 DESTDIR="${pkgdir}" install
}

package_lib32-savage-dri-git() {
  depends=('lib32-libgl-git' 'savage-dri-git')
  conflicts=('lib32-savage-dri')
  provides=('lib32-savage-dri=7.10')
  pkgdesc="Mesa DRI drivers for S3 Sraphics/VIA Savage"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C savage DESTDIR="${pkgdir}" install
}

package_lib32-sis-dri-git() {
  depends=('lib32-libgl-git' 'sis-dri-git')
  conflicts=('lib32-sis-dri')
  provides=('lib32-sis-dri=7.10')
  pkgdesc="Mesa DRI drivers for SiS"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C sis DESTDIR="${pkgdir}" install
}

package_lib32-tdfx-dri-git() {
  depends=('lib32-libgl-git' 'tdfx-dri-git')
  conflicts=('lib32-tdfx-dri')
  provides=('lib32-tdfx-dri=7.10')
  pkgdesc="Mesa DRI drivers for 3dfx"

  cd "${srcdir}/build/src/mesa/drivers/dri"
  make -C tdfx DESTDIR="${pkgdir}" install
}

package_lib32-nouveau-dri-git() {
  depends=('lib32-libgl-git' 'nouveay-dri-git')
  conflicts=('lib32-nouveau-dri')
  provides=('lib32-nouveau-dri=7.10')
  pkgdesc="Mesa classic DRI + Gallium3D drivers for Nouveau"
  
  cd "${srcdir}/build/src/mesa/drivers/dri"
  # classic mesa driver for nv10 , nv20 nouveau_vieux_dri.so
  # Ugly hack to work around buildsystem bug
  make -C nouveau DESTDIR="${pkgdir}" INCLUDES="-I. -I../../../../../src/mesa/drivers/dri/common -Iserver -I../../../../../include -I../../../../../src/mapi -I../../../../../src/mesa -I../../../../../src/egl/main -I../../../../../src/egl/drivers/dri -I/usr/include/libdrm -I/usr/include/nouveau" install
  # gallium3D driver for nv30 - nv40 - nv50 nouveau_dri.so
  make -C "${srcdir}"/build/src/gallium/targets/dri-nouveau DESTDIR="${pkgdir}" install
}

package_lib32-mesa-git() {
  depends=('lib32-libgl-git' 'lib32-libx11' 'lib32-libxt' 'lib32-gcc-libs' 'dri2proto-git' 'lib32-libdrm-git' 'glproto-git' 'mesa-git')
  conflicts=('lib32-mesa')
  provides=('lib32-mesa=7.10')
  pkgdesc="Mesa 3-D graphics libraries and include files"

  cd "${srcdir}"/build
  make DESTDIR="${pkgdir}" install

  rm -f "${pkgdir}/usr/lib32/libGL.so"*
  rm -f "${pkgdir}/usr/lib32/libGLESv"*
  rm -f "${pkgdir}/usr/lib32/libEGL"*
  rm -rf "${pkgdir}/usr/lib32/egl"
  rm -f "${pkgdir}/usr/lib32/pkgconfig"
  rm -rf "${pkgdir}/usr/lib32/xorg"
  rm -f "${pkgdir}/usr/include"
}

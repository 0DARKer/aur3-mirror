## Contributor: quantax -- contact via Arch Linux forum or AUR
## Contributor: Michal Krenek <mikos@sg1.cz>
## Contributor: redden0t8 -- contact via Arch Linux forums or AUR

pkgname=pam_abl
pkgver=0.5.0
pkgrel=3
pkgdesc="Automated blacklisting on repeated failed authentication attempts"
arch=('i686' 'x86_64')
url="http://pam-abl.sourceforge.net/"
license=('GPL')
depends=(db pam)
makedepends=(asciidoc cmake)
source=(http://downloads.sourceforge.net/pam-abl/pam-abl-$pkgver.tar.gz
		BUG3564436-fix.patch)
md5sums=('cec987b2747c9b7bce75b77aa7f5fe84'
         '98a093acf3e5bdb6cfe428fa6530e6f0')
install="pam_abl.install"

build() {
	cd "$srcdir/pam-abl"
	
	# Fix a major security issue - only the first attempt to authenticate
	# in a pam session is actually checked by pam_abl. This is triggered,
	# for example, when using sshd and entering an incorrect password.
	# Patch is from official git repo, however a new release has not been
	# made.
	patch -p1 < ../../BUG3564436-fix.patch

	# fix a binary naming issue
	# (names do not agree with previous releases or manpages)
	sed -i "s/pam-abl/pam_abl/g" CMakeLists.txt

	# configure
	cmake . -DCMAKE_INSTALL_PREFIX=/usr

	# build binaries
	make || return 1

	# generate documentation
	cd doc
	sh generate.sh
	cd ..

	# install binaries
	make install DESTDIR="$pkgdir/"

	# install example configuration
	install --mode=0644 -D -- conf/pam_abl.conf \
					"$pkgdir/etc/security/pam_abl.conf.example"

	#install documentation
	install --mode=0644 -D -- doc/pam_abl.1 \
		            "$pkgdir/usr/share/man/man1/pam_abl.1"
	install --mode=0644 -D -- doc/pam_abl.8 \
		            "$pkgdir/usr/share/man/man8/pam_abl.8"
	install --mode=0644 -D -- doc/pam_abl.conf.5 \
		            "$pkgdir/usr/share/man/man5/pam_abl.conf.5"
}


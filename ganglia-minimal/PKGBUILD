_pkgbase=ganglia
pkgname=ganglia-minimal
pkgver=3.6.1
pkgrel=1
pkgdesc="A version of the ganglia package without gmetad, to reduce dependencies."
arch=('i686' 'x86_64')
url="http://ganglia.sourceforge.net/"
license=('BSD')
depends=('apr' 'confuse' 'python2' 'pcre')
conflicts=('ganglia')
options=('!libtool')
install='ganglia.install'
backup=('etc/ganglia/gmond.conf')
source=("http://downloads.sourceforge.net/ganglia/$_pkgbase-$pkgver.tar.gz"
        'gmond.service'
        'ganglia.install'
        'uid.patch')
md5sums=('1b3c508c2ec727a8e6189a62ac365e58'
         '25ebc6cf829089a9f330ad177befdd45'
         '5720885c44d8bb244674f5454753e987'
         'a0d469dd2b9ec40dbe20377c51ca904c')

prepare() {
  cd "$srcdir/$_pkgbase-$pkgver"

  for patch in $srcdir/*.patch; do
    msg2 "Applying $(basename $patch)"
    patch -Np1 -i $patch
  done

  # FIXME: Hopefully this will soon no longer be required?
  msg2 "Copying systemd units into source as workaround for bug"
  cp "$srcdir/gmond.service" "$srcdir/$_pkgbase-$pkgver/gmond/gmond.service.in"
}

build() {
  cd "$srcdir/$_pkgbase-$pkgver"

  ./configure --prefix=/usr --libdir=/usr/lib --sysconfdir=/etc/ganglia \
              --enable-gexec --enable-status \
              --with-python=/usr/bin/python2
  make
}

package() {
  cd "$srcdir/$_pkgbase-$pkgver"
  make DESTDIR="$pkgdir" install

  # Move sbin to bin
  mv "$pkgdir/usr/sbin"/* "$pkgdir/usr/bin/"
  rmdir "$pkgdir/usr/sbin"

  # Install Python modules
  cp -R gmond/python_modules "$pkgdir/usr/lib/ganglia/"
  find "$pkgdir/usr/lib/ganglia" -not -name *.py* -type f -exec rm \{\} \;
  mv "$pkgdir/usr/lib/ganglia/python_modules/conf.d"/* "$pkgdir/etc/ganglia/conf.d/"
  rmdir "$pkgdir/usr/lib/ganglia/python_modules/conf.d"
  find gmond -name *.so -exec cp \{\} "$pkgdir/usr/lib/ganglia/" \;

  msg2 "Generating default gmond.conf"
  ./gmond/gmond --default_config > "$pkgdir/etc/ganglia/gmond.conf"

  install -m 644 -D COPYING "$pkgdir/usr/share/licenses/${pkgname}/COPYING"
}

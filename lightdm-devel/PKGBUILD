# Maintainer: Morfeo <morfeo89 at hotmail dot it>
# Contributor: Alucryd <alucryd at gmail dot com>

pkgbase=lightdm-devel
pkgname=${pkgbase}
true && pkgname=('lightdm-devel' 'liblightdm-qt4-devel' 'liblightdm-qt5-devel')
pkgver=1.5.1
pkgrel=4

build() {
  cd "${srcdir}"/${pkgbase%-*}-${pkgver}

# Patch
  patch -Np1 -i ../lightdm-default-config.patch
  patch -Np1 -i ../lightdm-1.5.1-systemd_login1_power.patch
  patch -Np1 -i ../lightdm-lock-screen-before-switch.patch

# Build
   ./configure --prefix=/usr --sysconfdir=/etc --localstatedir=/var --libexecdir=/usr/lib/${pkgbase%-*} --with-greeter-user=lightdm --with-greeter-session=lightdm-gtk-greeter --disable-{static,tests}
   make
}

package_lightdm-devel() {
depends=('libgcrypt' 'libxklavier' 'pam')
optdepends=('xorg-server-xephyr: LightDM test mode'
            'accountsservice: limit visible accounts')
provides=("lightdm=${pkgver}")
conflicts=('lightdm')
backup=('etc/apparmor.d/lightdm-guest-session'
        'etc/lightdm/keys.conf'
        'etc/lightdm/lightdm.conf'
        'etc/lightdm/users.conf')
install=${pkgbase%-*}.install

  cd "${srcdir}"/${pkgbase%-*}-${pkgver}

# Install
  make DESTDIR="${pkgdir}" install
  make DESTDIR="${pkgdir}" -C liblightdm-qt uninstall
  install -m 755 ../xsession "${pkgdir}"/etc/lightdm/xsession
  rm -rf "${pkgdir}"/etc/init
  
# Persistent home
  install -dm 770 "${pkgdir}"/var/lib/lightdm
  chmod +t "${pkgdir}"/var/lib/lightdm
  echo 'GDK_CORE_DEVICE_EVENTS=true' > "${pkgdir}"/var/lib/lightdm/.pam_environment
  chmod 644 "${pkgdir}"/var/lib/lightdm/.pam_environment

# PAM
  install -m 644 ../lightdm.pam "${pkgdir}"/etc/pam.d/lightdm
  install -m 644 ../lightdm-autologin.pam "${pkgdir}"/etc/pam.d/lightdm-autologin

# PolicyKit
  install -dm 700 "${pkgdir}"/usr/share/polkit-1/rules.d
  install -m 644 ../lightdm.rules "${pkgdir}"/usr/share/polkit-1/rules.d/lightdm.rules

# Systemd
  install -dm 755 "${pkgdir}"/usr/lib/{systemd/system,tmpfiles.d}
  install -m 644 ../lightdm.service "${pkgdir}"/usr/lib/systemd/system/lightdm.service
  install -m 644 ../lightdm.tmpfiles "${pkgdir}"/usr/lib/tmpfiles.d/lightdm.conf
}

package_liblightdm-qt4-devel() {
pkgdesc=('LightDM Qt client library')
depends=('lightdm' 'qt4')
provides=("liblightdm-qt4=${pkgver}")
conflicts=('liblightdm-qt4')

  cd "${srcdir}"/${pkgbase%-*}-${pkgver}

# Install
  make DESTDIR="${pkgdir}" -C liblightdm-gobject install
  make DESTDIR="${pkgdir}" -C liblightdm-qt install
  make DESTDIR="${pkgdir}" -C liblightdm-gobject uninstall
  find "${pkgdir}" -type d -name *qt5* -exec rm -rf {} +
  find "${pkgdir}" -type f  -name *qt5* -exec rm {} +
  find "${pkgdir}" -type l  -name *qt5* -exec rm {} +
}

package_liblightdm-qt5-devel() {
pkgdesc=('LightDM Qt client library')
depends=('lightdm' 'qt5-base')
provides=("liblightdm-qt5=${pkgver}")
conflicts=('liblightdm-qt5')

  cd "${srcdir}"/${pkgbase%-*}-${pkgver}

# Install
  make DESTDIR="${pkgdir}" -C liblightdm-gobject install
  make DESTDIR="${pkgdir}" -C liblightdm-qt install
  make DESTDIR="${pkgdir}" -C liblightdm-gobject uninstall
  find "${pkgdir}" -type d -name *qt[!5]* -exec rm -rf {} +
  find "${pkgdir}" -type f  -name *qt[!5]* -exec rm {} +
  find "${pkgdir}" -type l  -name *qt[!5]* -exec rm {} +
}

pkgdesc="A lightweight display manager"
arch=('i686' 'x86_64')
url="https://launchpad.net/lightdm"
license=('GPL3' 'LGPL3')
makedepends=('gobject-introspection' 'gtk-doc' 'intltool' 'itstool' 'libxklavier' 'qt4' 'qt5-base')
options=('!emptydirs' '!libtool')
source=("https://launchpad.net/lightdm/1.6/${pkgver}/+download/${pkgbase%-*}-${pkgver}.tar.xz"
        'lightdm.service'
        'lightdm.tmpfiles'
        'lightdm.pam'
        'lightdm-autologin.pam'
        'lightdm.rules'
        'lightdm-default-config.patch'
        'lightdm-1.5.1-systemd_login1_power.patch'
        'lightdm-lock-screen-before-switch.patch'
        'xsession')

md5sums=('e1b24757fdbd498af9e4af253f112754'
         '3ed64eccb223c403e60d16bfa33faf88'
         '6b719a6032f1579983111f382a9c27b5'
         'c941ef896248bc7c03901b513490425c'
         '4b76e4ca1de2a0d9895571720583a7e5'
         '2a7326f4de1d949b8c96749b62cc5021'
         '850ae1b55a90133c678a24677b8ac0f6'
         '78c10b851ffbcb881bc8745f6038cb16'
         '43314fcf13397aaf2321a86d7ed9452c'
         '9622d365769ed248a203205210c9967a')

# Maintainer: Bjorn Neergaard (neersighted) <bjorn@neersighted.com>

pkgroot=ucsf-chimera
pkgname=ucsf-chimera
pkgver=1.9
pkgrel=3
pkgdesc='Extensible molecular modeling system'
url='https://cgl.ucsf.edu/chimera/'
license=('MIT')
install=ucsf-chimera.install
arch=('i686' 'x86_64')

case "${CARCH}" in
  (i686)
    _name="chimera-${pkgver}-linux.bin"
    _file="linux/${_name}&choice=Accept"
  ;;
  (x86_64)
    _name="chimera-${pkgver}-linux_x86_64.bin"
    _file="linux_x86_64/${_name}&choice=Accept"
  ;;
  (*)
    echo 'Unsupported architecture!'
    exit 1
  ;;
esac

prepare(){
  cd "${srcdir}"

  echo 'IMPORTANT: By downloading you accept the UCSF Chimera Non-Commercial Software License Agreement!'
  echo 'IMPORTANT: The license agreement can be found here: http://www.cgl.ucsf.edu/chimera/license.html'
  echo 'IMPORTANT: If you do not agree, please press Ctrl-C now.'

  sleep 5

  _url="$(curl -s --data file=${_file} https://www.rbvi.ucsf.edu/chimera/cgi-bin/secure/chimera-get.py | grep 'http-equiv' | grep -P -o '(?<=url=)(.*)(?=\")')"
  _url="https://www.cgl.ucsf.edu${_url}"

  echo "${_url}"
  curl "${_url}" -o "${_name}"
}

package() {
  cd "${srcdir}"

  # Prepare the directory structure.
  install -dm755 "${pkgdir}/opt"

  # Run the installer.
  chmod +x "${_name}"
  echo "${pkgdir}/opt/ucsf-chimera" | "./${_name}"
}

# vim: ft=sh ts=2 sw=2 et

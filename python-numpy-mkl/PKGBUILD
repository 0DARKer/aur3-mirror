# $Id: PKGBUILD 164237 2012-07-28 03:14:33Z stephane $
# Maintainer: Jan de Groot <jgc@archlinux.org>
# Contributor: Douglas Soares de Andrade <dsa@aur.archlinux.org>
# Contributor: Angel 'angvp' Velasquez <angvp[at]archlinux.com.ve> 
# Adapted to mkl by Simone Riva

pkgname=('python-numpy-mkl')
true && pkgname=('python2-numpy-mkl' 'python-numpy-mkl')
#pkgname=('python-numpy')
pkgver=1.6.2
pkgrel=1
pkgdesc="Scientific tools for Python compiled with intel mkl"
arch=('i686' 'x86_64')
license=('custom')
url="http://numpy.scipy.org/"
makedepends=('intel-mkl' 'python' 'python2' 'python-distribute' 'python2-distribute' 'intel-compiler-base' 'intel-fortran-compiler' 'python-nose')

source=( http://downloads.sourceforge.net/numpy/numpy-${pkgver}.tar.gz 'site64.cfg' 'site32.cfg' 'intel.py' 'intelccompiler.py' )

md5sums=('95ed6c9dcc94af1fc1642ea2a33c1bba' 
	  '469c76e7f98ed70a492f7786b1a01f38' 
	  '7679432b417d1f26d7af4c3d89d5797f' 
	  'c9e938dd0315e79f6a95afb32028f638' 
	  '6e73f726f9a40bba0ecc8476dfbae45d' )

build() {

  cd "${srcdir}"
  
  if [ "$CARCH" = "i686" ]; then
      cp ../site32.cfg ../site.cfg
  else
      cp ../site64.cfg ../site.cfg
  fi

  
  cp -a numpy-${pkgver} numpy-py2-${pkgver}

  export Atlas=None
  export LDFLAGS="$LDFLAGS -shared"

  echo "Building Python2"
  cd "${srcdir}"
  cp ../site.cfg "${srcdir}/numpy-py2-${pkgver}"
  cp ../intelccompiler.py "${srcdir}/numpy-py2-${pkgver}/numpy/distutils"
  cp ../intel.py "${srcdir}/numpy-py2-${pkgver}/numpy/distutils/fcompiler/"
  cd "${srcdir}/numpy-py2-${pkgver}"
  python2 setup.py config --compiler=intel build_clib --fcompiler=intel build_ext

  echo "Building Python3"
  cd "${srcdir}"
  cp ../site.cfg "${srcdir}/numpy-${pkgver}"
  cp ../intelccompiler.py "${srcdir}/numpy-${pkgver}/numpy/distutils"
  cp ../intel.py "${srcdir}/numpy-${pkgver}/numpy/distutils/fcompiler/"
  cd "${srcdir}/numpy-${pkgver}"
  python setup.py config --compiler=intel build_clib --fcompiler=intel build_ext
}

package_python2-numpy-mkl() {

  provides=( 'python2-numpy=${pkgver}' )
  depends=('intel-mkl' 'python2')
  optdepends=('python-nose: testsuite')

  cd "${srcdir}/numpy-py2-${pkgver}"
  python2 setup.py config_fc install --prefix=/usr --root="${pkgdir}" --optimize=1

  install -m755 -d "${pkgdir}/usr/share/licenses/python2-numpy"
  install -m644 LICENSE.txt "${pkgdir}/usr/share/licenses/python2-numpy/"

  sed -i -e "s|#![ ]*/usr/bin/python$|#!/usr/bin/python2|" \
         -e "s|#![ ]*/usr/bin/env python$|#!/usr/bin/env python2|" \
         -e "s|#![ ]*/bin/env python$|#!/usr/bin/env python2|" \
             $(find ${pkgdir} -name '*.py')
}

package_python-numpy-mkl() {

  depends=('intel-mkl' 'python2')
  provides=("python3-numpy=${pkgver}" "python-numpy=${pkgver}")
  replaces=('python3-numpy')
  conflicts=('python3-numpy')

  cd "${srcdir}/numpy-${pkgver}"
  python setup.py config_fc install --prefix=/usr --root="${pkgdir}" --optimize=1

  install -m755 -d "${pkgdir}/usr/share/licenses/python3-numpy"
  install -m644 LICENSE.txt "${pkgdir}/usr/share/licenses/python3-numpy/"
}

# Contributor: Nicolas LLOBERA <nllobera at gmail dot com>

pkgname=gartoon-redux-bzr
pkgver=38
pkgrel=3
pkgdesc="A GNOME Icon Theme based on Gartoon theme and Gnutoon/Ubuntoon"
arch=('any')
url="https://launchpad.net/gartoon-redux"
license=('GPL3')
makedepends=('bzr' 'librsvg' 'perl')
install=gartoon-redux.install
_bzrtrunk=https://launchpad.net/gartoon-redux/trunk
_bzrname=gartoon-redux

build() {
    cd "${srcdir}"

    msg "Download from the Bazaar repository ..."
    if [ ! -d $_bzrname/.bzr ]; then
        bzr co $_bzrtrunk $_bzrname
    else
        bzr up $_bzrname
    fi
    msg "Bazaar checkout done"
    
    cd $_bzrname
    
    # rsvg-convert fix
    sed "s/rsvg -x \$zoom_factor -y \$zoom_factor \$source \$target/rsvg-convert -x \$zoom_factor -y \$zoom_factor \$source > \$target/" -i configure

    # fix logo install script (this way no needed "lsb-release")
    sed "s/\`lsb_release -si\`/'arch linux'/" -i fix-logo.pl
    
    # fix the "Can't locate Switch.pm in @INC" error. Switch seems to be useless here
    sed "s/use Switch;//" -i fix-logo.pl

    # wrong size of orginal distribution-arch-linux.svg, copy right size (90x90)
    cp -f ../../distribution-arch-linux.svg src/extras/

    # copy archpkg mime icon
    cp ../../application-x-archpkg.svg src/mimetypes/
    mkdir -p mime
    cp ../../application-x-archpkg.xml mime/
    
    # copy maff mime icon
    cp ../../application-x-maff.svg src/mimetypes/
    cp ../../application-x-maff.xml mime/
    
    # copy aMule place icon
    cp ../../folder-amule.svg src/places/
    
    # copy folder-web icon
    cp ../../folder-web.svg src/places/
    
    # replace folder-image
    cp -f ../../folder-image.svg src/places/
    sed "/folder-pictures.svg                            folder-image.svg/d" -i src/0ALIAS

    # patch configure file to add mime type files installation commands
    patch -p0 < ../../configure.patch

    # configure & make
    ./configure --sizes=16,22,24,32 --prefix=$pkgdir/usr

    msg "Rendering 16,22,24,32 sized icons. Please wait ..."
    make &> make.log
}

package() {
    cd $_bzrname
    make install
}


# Maintainer: Jens Staal <staal1978@gmail.com>

pkgname=lll-git
pkgver=2.8
pkgrel=1
pkgdesc='LLL tool chain: to build Linux with LLVM/Clang'
arch=('x86_64')
license=('BSD')
depends=('coreutils' 'module-init-tools')
makedepends=('git' 'clang' 'boost')
provides=('clang' 'kernel')
url="https://github.com/brycelelbach/lll"


build() {

    git clone git://github.com/brycelelbach/lll.git lll-wc

    export CC=clang
    export CXX=clang++
    export BOOST_ROOT=/usr/include/boost

    cd $startdir/src/lll-wc/llvm
    ./configure --enable-optimized --disable-doxygen --prefix=$startdir/pkg/opt/lll-wc
    make
    make install

    export CC=$startdir/pkg/opt/lll-wc/tools/clang
    export CXX=$startdir/pkg/opt/lll-wc/tools/clang++

    cd $startdir/src/lll-wc/linux
    make oldconfig
#alternatively make menuconfig
    make
}

package() {

    cd $startdir/src/lll-wc/linux
    mkdir -p $pkgdir/{lib/modules,boot}
    make INSTALL_MOD_PATH=$pkgdir modules_install
    rm -r $pkgdir/lib/modules/$_kernver/{source,build}
    rm -rf ${pkgdir}/lib/firmware

    install -D -m644 $startdir/src/lll-wc/linux/System.map $startdir/pkg/boot/System.map-lll
    install -D -m644 $startdir/src/lll-wc/linux/arch/x86/boot/bzImage $startdir/pkg/boot/vmlinuz-lll
    install -D -m644 $startdir/src/lll-wc/linux/.config $startdir/pkg/boot/kconfig-lll
}

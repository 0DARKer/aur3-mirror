# Maintainer: Jens Staal <staal1978@gmail.com>

pkgname=lll-git
pkgver=20110304
_kernver=2.6.37-clang1
pkgrel=1
pkgdesc='LLL tool chain: to build Linux with LLVM/Clang'
arch=('x86_64')
license=('BSD')
depends=('coreutils' 'module-init-tools')
makedepends=('git' 'clang' 'boost' 'ftjam')
provides=('clang' 'kernel')
url="https://github.com/brycelelbach/lll"

_gitroot="git://github.com/brycelelbach/lll.git"
_gitname="lll-wc"
_gitllvmroot="git://github.com/brycelelbach/lll-llvm.git"
_gitlinuxroot="git://github.com/brycelelbach/lll-linux.git"

build() {

# pulling the base of the tool chain

 cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull $_gitroot
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..." 

# pulling LLVM sources

 cd "$srcdir/lll-wc"
  if [ -d llvm ] ; then
      cd llvm && git pull $_gitllvmroot
      msg "the llvm local files are updated"
  else
      git clone $_gitllvmroot llvm
  fi


    export CC=clang
    export CXX=clang++
    export BOOST_ROOT=/usr/include/boost

    cd $startdir/src/lll-wc/llvm
#    jam
#    jam install

# pulling the linux sources

 cd "$srcdir/lll-wc"
  if [ -d linux ] ; then
      cd linux && git pull $_gitlinuxroot
      msg "the linux local files are updated"
  else
      git clone $_gitlinuxroot linux
  fi

    export CC=$startdir/pkg/opt/lll-wc/tools/clang
    export CXX=$startdir/pkg/opt/lll-wc/tools/clang++

    cd $startdir/src/lll-wc/linux
    make oldconfig
#alternatively make menuconfig
    make
}

package() {

    cd $startdir/src/lll-wc/linux
    mkdir -p $pkgdir/{lib/modules,boot}
    make INSTALL_MOD_PATH=$pkgdir modules_install
    rm -r $pkgdir/lib/modules/$_kernver/{source,build}
    rm -rf ${pkgdir}/lib/firmware

    install -D -m644 $startdir/src/lll-wc/linux/System.map $startdir/pkg/boot/System.map-$_kernver
    install -D -m644 $startdir/src/lll-wc/linux/arch/x86/boot/bzImage $startdir/pkg/boot/vmlinuz-$_kernver
    install -D -m644 $startdir/src/lll-wc/linux/.config $startdir/pkg/boot/kconfig-$_kernver
}

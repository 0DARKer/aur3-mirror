# Maintainer:  Alexander Minges <alexander.minges@gmail.de>
# Contributor: Michael Schubert <mschu.dev at gmail>
# Contributor: yescalona <yescalona@ug_uchile_cl>
# Contributor: Juan Miguel Cejuela <jmcejuela@gmail.com>
# Contributor: Fabio Zanini <iosonofabio@gmail.com>

# Note: this package needs a makeover.. 
# submitting for now with added memory leak patch

pkgname=modeller
pkgver=9.12
pkgrel=1
pkgdesc="3D Structure Homology Modeller"
arch=('i686' 'x86_64')
url="http://salilab.org/modeller/"
license=('custom')
depends=('python2' 'glib2')
optdepends=('python: python3 support')
install=modeller.install
source=("http://www.salilab.org/modeller/$pkgver/modeller-$pkgver.tar.gz")

md5sums=('abb8f96167022579f1bb7edfa2a8c331')
sha1sums=('849f535e0e025513776ed89a5447b9ee0cce75b5')
sha256sums=('65051f7f1682cf7dcf77f0bc4d68f1ee5b64789f750e9aa6900e1cc92dc4e1f9')
sha384sums=('0b0662ddcc15b592cc958c6d3a574e280f7c336368fdc1e5ef1ed105a6ebb6c836e1e1653570a11d8cb78dd1d6ccbef6')
sha512sums=('5c0acaf453771347a9de3a0c7240f7ce376244803748edb28923dbaefda779041211ef4b26af5a2774bdf6bc63d7c7d7e62e1354e1550a6742c9575076864352')

package() {
    cd $srcdir/$pkgname-$pkgver
    
    #set default values:
    VER="9.12"
    VERENV="9v12"
    MOD="MODELLER ${VER}"
    PROGRAM=mod${VER}
    MODINSTALL="${pkgdir}/usr/lib/modeller"
    _MODINSTALL="/usr/lib/modeller"

    if [ "{$CARCH}" = "i686" ]; then
        # for i686
        EXECUTABLE_TYPE="i386-intel8"
    elif [ "${CARCH}" = "x86_64" ]; then
        # for x86_64
        EXECUTABLE_TYPE="x86_64-intel8"
    else
        error "MODELLER is only available for i386 and x86_64!"
    fi
    
    # Change directory permisssions
    find . -type d -exec chmod 755 {} \;
    
    # Installing Modeller files
    mkdir -p "${MODINSTALL}"
    cp -R README INSTALLATION doc examples modlib src "${MODINSTALL}"
    mkdir -p "${MODINSTALL}/bin"
    cp -R bin/*.top bin/modslave.py bin/lib bin/${PROGRAM}_${EXECUTABLE_TYPE} \
        "${MODINSTALL}/bin"
    mkdir -p "${MODINSTALL}/lib"
    cp -R lib/${EXECUTABLE_TYPE} "${MODINSTALL}/lib"

    # Creating Modeller startup scripts
    sed -e "s;EXECUTABLE_TYPE${VERENV}=xxx;EXECUTABLE_TYPE${VERENV}=$EXECUTABLE_TYPE;" \
        -e "s;MODINSTALL${VERENV}=xxx;MODINSTALL${VERENV}=\"$_MODINSTALL\";" \
        bin/modscript > "${MODINSTALL}/bin/${PROGRAM}"
    sed -e "s;@TOPDIR\@;\"$_MODINSTALL\";" \
        -e "s;@EXETYPE\@;$EXECUTABLE_TYPE;" \
        bin/modpy.sh.in > "${MODINSTALL}/bin/modpy.sh"
    chmod a+x "${MODINSTALL}/bin/${PROGRAM}" "${MODINSTALL}/bin/modpy.sh"
    sed -e "s;/usr/bin/python;/usr/bin/python2;" \
        bin/modslave.py > "${MODINSTALL}/bin/modslave.py"
    
    # Creating simbol link
    install -d ${pkgdir}/usr/bin/
    ln -sf ${_MODINSTALL}/bin/mod$pkgver  ${pkgdir}/usr/bin/mod$pkgver
    ln -sf ${_MODINSTALL}/bin/modpy.sh  ${pkgdir}/usr/bin/modpy.sh
    ln -sf ${_MODINSTALL}/bin/modslave.py  ${pkgdir}/usr/bin/modslave.py

    # Create config.py is it not exists
    if [ ! -f "${_MODINSTALL}/modlib/modeller/config.py" ]; then
        msg "Creating '${_MODINSTALL}/config.py'..."
        echo "license = 'XXXX'" > "${MODINSTALL}/modlib/modeller/config.py"
        msg "Done! Add your license code to '${_MODINSTALL}/config.py'."
    else
        msg "Found existing config.py. Please check that the license code within this file is correct!"
    fi
    
    # Add modeller libs to ld.so.conf
    msg "Adding MODELLER to ld.so.conf..."
    install -d ${pkgdir}/etc/ld.so.conf.d
    echo "/usr/lib/${pkgname}/lib/${EXECUTABLE_TYPE}" > ${pkgdir}/etc/ld.so.conf.d/${pkgname}.conf

    # Install python2 module
    msg "Installing package for python2..."
    install -d ${pkgdir}/usr/lib/python2.7/site-packages
    ln -s ${_MODINSTALL}/modlib/modeller  ${pkgdir}/usr/lib/python2.7/site-packages/modeller  
        
    ln -s ${_MODINSTALL}/lib/${EXECUTABLE_TYPE}/python2.5/_modeller.so ${pkgdir}/usr/lib/python2.7/site-packages/_modeller.so
     
     # Install python3 modules if python3 is installed
     if [ -d "/usr/lib/python3.3/site-packages" ]; then
         msg "Installing package for python3..."
         install -d ${pkgdir}/usr/lib/python3.3/site-packages
         ln -s ${_MODINSTALL}/modlib/modeller  ${pkgdir}/usr/lib/python3.3/site-packages/modeller
         ln -s ${_MODINSTALL}/lib/${EXECUTABLE_TYPE}/python3.2/_modeller.so ${pkgdir}/usr/lib/python3.3/site-packages/_modeller.so
     else
         msg "Python3 not found! If you want to use modeller within python3, do an 'pacman -S python' and reinstall MODELLER."
     fi
} 


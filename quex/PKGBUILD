# Maintainer: Kringel

pkgname=quex
pkgver=0.59.7
pkgrel=3
pkgdesc='Fast Universal Lexical Analyzer Generator'
arch=('any')
url='http://quex.sourceforge.net/'
license=('LGPL')
depends=('python2')
optdepends=('pkg-config: to get include path by calling `pkg-config quex --cflags`')
source=("http://netcologne.dl.sourceforge.net/project/quex/DOWNLOAD/quex-${pkgver}.tar.gz")
options=('!strip')
md5sums=('c3b16f1558b3751d22c6ae210f2a52d7')


package() {
	local prefix=/usr/bin
	local dst=${pkgdir}/${prefix}
	mkdir -p $dst
	cp -r $srcdir/$pkgname-$pkgver $dst
	
	# set python2 for the sha-bang line
	sed -i 's/^\#! \/usr\/bin\/env python$/\#! \/usr\/bin\/env python2/' $dst/$pkgname-$pkgver/quex-exe.py
	
	# default QUEX_PATH to the installation directory (to make the environment variable optional)
	# inside the python source
	find $pkgdir -iname "*.py" -exec sed -i "s/os.environ\[\"QUEX_PATH\"\]/os.getenv(\"QUEX_PATH\", \"\/usr\/bin\/$pkgname-$pkgver\/\")/" {} \;
	# and also inside the Makefiles
	find $pkgdir/$prefix/$pkgname-$pkgver/demo -iname "Makefile" -exec sed -i "s/\$(error The environment variable QUEX_PATH is not defined!)/QUEX_PATH=\/usr\/bin\/$pkgname-$pkgver\//" {} \;
	
	
	# link "quex" to the main script
	ln -s ./$pkgname-$pkgver/quex-exe.py $pkgdir/usr/bin/quex
	

	# create metadata file for pkg-config	
	mkdir -p $pkgdir/usr/lib/pkgconfig
	x=$pkgdir/usr/lib/pkgconfig/quex.pc
	echo "quexpath=$prefix/$pkgname-$pkgver" >> $x
	echo "Name: Quex" >> $x
	echo "Description: $pkgdesc" >> $x
	echo "Version: $pkgver" >> $x
	echo "URL: $url" >> $x
	echo "Cflags: -I\${quexpath}" >> $x
}


# Maintainer: Jens Staal <staal1978@gmail.com>
# Adopted from mingw-w64 package by: Daniel Kirchner <daniel AT ekpyron DOT org>

pkgname=open_watcom-zlib
pkgver=1.2.8
pkgrel=4
pkgdesc="A compression/decompression Library (OpenWatcom (cross-)compilation)"
arch=('any')
license=('custom:zlib')
depends=(open_watcom-v2)
makedepends=(open_watcom-v2)
url="http://www.zlib.net/"
source=("http://zlib.net/zlib-${pkgver}.tar.gz")
provides=('open_watcom-zlib-static')
conflicts=('open_watcom-zlib-static')
options=(!strip !buildflags staticlibs)
md5sums=('44d667c142d7cda120332623eab69f40')



build() {
  cd $srcdir/zlib-${pkgver}
  source /opt/watcom/owsetenv.sh
  #we want to move stuff as early as possible to the right location
  install -d $srcdir/build/opt/watcom/{lib286/dos,lib386/{linux,dos,nt},h,lh}
  
  msg "build for linux"
  CC=owcc ./configure --prefix=$WATCOM -static

  make CC=owcc RC=wrc STRIP=wstrip CFLAGS="-O3 -blinux" AR=wlib ARFLAGS="" LD=wlink RANLIB=true
  install -m644 libz.a $srcdir/build/opt/watcom/lib386/linux/zlib.lib
  #cleaning... notice that makepkg -s fails the 2nd time
  make clean
  
  msg "build for DOS.."
  #missing object files for the test-compiles
  #sed 's|example.exe minigzip.exe||g' -i watcom/*.mak
  sed 's|del|rm|g' -i watcom/*.mak
  cp test/example.c example.c
  cp test/minigzip.c minigzip.c
  msg2 "...16-bit"
  export INCLUDE=$WATCOM/h
  wmake -f watcom/watcom_l.mak CFLAGS="-zq -ml -s -bt=dos -oilrtfm -fr=nul -wx -fo=.obj"
  install -m644 zlib_l.lib $srcdir/build/opt/watcom/lib286/dos/zlib.lib
  wmake -f watcom/watcom_l.mak clean
  msg2 "...extended 32-bit"
  export INCLUDE=$WATCOM/h
  wmake -f watcom/watcom_f.mak CFLAGS="-zq -mf -3r -fp3 -s -bt=dos -oilrtfm -fr=nul -wx -fo=.obj"
  install -m644 zlib_f.lib $srcdir/build/opt/watcom/lib386/dos/zlib.lib
  wmake -f watcom/watcom_f.mak clean
  
  msg "build for Win32"
  export INCLUDE=$WATCOM/h:$WATCOM/h/nt
  C=owcc ./configure --prefix=$WATCOM -shared -static
  sed 's|(RCFLAGS) -o |(RCFLAGS) -r -fo=|g' -i win32/Makefile.gcc
  make -f win32/Makefile.gcc CC=owcc AR=wlib RC=wrc RCFLAGS="-bt=nt" STRIP=wstrip CFLAGS="-O3 -bnt" AR=wlib ARFLAGS="" LD=wlink RANLIB=true
  install -m644 libz.a $srcdir/build/opt/watcom/lib386/nt/zlib.lib
    
}

package () {
    cp -ar $srcdir/build $pkgdir
    install -m644 -t $pkgdir/opt/watcom/{h,lh}/ zlib.h zconf.h
}

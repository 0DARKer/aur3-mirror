# Maintainer: Prurigro
# Contributor: Prurigro
# Contributor: Werecat
# Contributor: Xyne

_pkgname=cjdns
pkgname=${_pkgname}-git
pkgver=0.3.1408
pkgrel=1
pkgdesc="A routing engine designed for security, scalability, speed and ease of use."
url="https://github.com/cjdelisle/${_pkgname}"
license=('GPL3')
makedepends=('git')
optdepends=('python2: required by the python cjdnsadmin utilities')
arch=('i686' 'x86_64' 'armv6h' 'armv7h')
install=${pkgname}.install
backup=("etc/default/${_pkgname}")

source=("git://github.com/cjdelisle/${_pkgname}.git#branch=master" "git://github.com/prurigro/${pkgname}-sysvinit.git#branch=master" "cmake-2.8.11-enable.patch")
sha256sums=('SKIP' 'SKIP' '5cc59141486ba2b574ce9b1bcad1f4967e8066c2bd3aa905028042cd69e1f699')

pkgver() {
    cd "${srcdir}/${_pkgname}"
    git describe --always | sed 's|-|.|g;s|[^\.]*\.||;s|\.[^\.]*$||'
}

prepare() {
    cd "${srcdir}/${_pkgname}"
    
    ## Clean previous builds and resync
    ./clean

    ## Set occurances of python to python2 due to a naming conflict between Debian and Archlinux
    find "${srcdir}/${_pkgname}"/contrib/python -type f -exec sed -i 's@/usr/bin/python\s*$@/usr/bin/python2@;s@/usr/bin/env\ python@/usr/bin/env\ python2@' {} \+

    ## Allow building with the system cmake if libnacl is installed (2.8.11 and above are normally disabled as building cnacl fails with those versions)
    if [ ! -z $(paclog-pkglist | grep -o libnacl) ]; then
        patch -p0 < ../cmake-2.8.11-enable.patch
    fi
}

build() {
    cd "${srcdir}"/${_pkgname}

    ##  Disable Arch's generic makepkg optimizations (set via /etc/makepkg.conf) in favour of those specified by cjdns
    unset CFLAGS
    unset CPPFLAGS

    ##  Build using the ./do script
    NO_DEBUG=1 ./do
}

## Package creation helper functions
_package_cjdns() {
    install -D -m755 "${srcdir}"/${_pkgname}/build/admin/angel/cjdroute2 "${pkgdir}"/usr/bin/cjdroute
    install -D -m755 "${srcdir}"/${_pkgname}/build/admin/angel/${_pkgname} "${pkgdir}"/usr/bin/${_pkgname}
    install -D -m644 "${srcdir}"/${_pkgname}/contrib/systemd/${_pkgname}.service "${pkgdir}"/usr/lib/systemd/system/${_pkgname}.service
    install -D -m755 "${srcdir}"/${_pkgname}/contrib/bash/i_am_stupid.sh "${pkgdir}"/usr/bin/cjdns-recoverconfig
}
_package_sysvinit() {
    install -D -m644 "${srcdir}"/${_pkgname}-git-sysvinit/${_pkgname}.default "${pkgdir}"/etc/default/${_pkgname}
    install -D -m755 "${srcdir}"/${_pkgname}-git-sysvinit/${_pkgname}.rc.d "${pkgdir}"/etc/rc.d/${_pkgname}
    install -D -m755 "${srcdir}"/${_pkgname}/scripts/${_pkgname}.sh "${pkgdir}"/usr/bin/${_pkgname}.sh
}
_package_pyutils() {
    install -D -m644 "${srcdir}"/${_pkgname}/contrib/python/cjdnsadmin/cjdnsadmin.py "${pkgdir}"/usr/lib/$(python2-config --libs | grep -o -E python2.*)/cjdnsadmin/cjdnsadmin.py
    install -D -m644 "${srcdir}"/${_pkgname}/contrib/python/cjdnsadmin/bencode.py "${pkgdir}"/usr/lib/$(python2-config --libs | grep -o -E python2.*)/cjdnsadmin/bencode.py
    install -D -m644 "${srcdir}"/${_pkgname}/contrib/python/cjdnsadmin/__init__.py "${pkgdir}"/usr/lib/$(python2-config --libs | grep -o -E python2.*)/cjdnsadmin/__init__.py
    install -D -m755 "${srcdir}"/${_pkgname}/contrib/python/cjdnslog "${pkgdir}"/usr/bin/cjdns-log
    install -D -m755 "${srcdir}"/${_pkgname}/contrib/python/dumptable "${pkgdir}"/usr/bin/cjdns-dumptable
    install -D -m755 "${srcdir}"/${_pkgname}/contrib/python/findnodes "${pkgdir}"/usr/bin/cjdns-findnodes
    install -D -m755 "${srcdir}"/${_pkgname}/contrib/python/pingAll.py "${pkgdir}"/usr/bin/cjdns-pingAll
}

## Package creation function: comment out a helper function to remove its associated functionality
package() {
    _package_cjdns ## Core binaries (cjdns and cjdroute), a systemd service file and a config recovery script written in bash
    _package_sysvinit ## Legacy sysvinit (rc.d) service (dependency free), the associated backend and a default config file
    _package_pyutils ## Miscellaneous python2-based cjdns admin port utility scripts and libraries
}

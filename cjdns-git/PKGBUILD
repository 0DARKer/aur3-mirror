# Contributor: Prurigro
# Maintainer: Prurigro

pkgname=cjdns-git
pkgver=121022
pkgrel=1
pkgdesc="A routing engine designed for security, scalability, speed and ease of use."
url="https://github.com/cjdelisle/cjdns"
license="GPLv3"
depends=('libevent' 'iproute2' 'net-tools' 'sqlite3')
makedepends=('git' 'cmake' 'make' 'gcc')
arch=('i686' 'x86_64' 'armv7h')
source=('cjdns.rc.d' 'cjdns.conf.d' 'cjdns.service.script' 'cjdns.service')
sha1sums=('cd7fe5eebcfabbf201867a210fbe68c858f0d7f5'
          '9921ab2b24b1a00824f60f321e837f11a4ac4b3d'
          '419d5cd0c614abd09f9a0f8219671b5f03224c68'
          '765442f233a2250b5b8fc69d91fd62be12f3cfdb')
install=${pkgname}.install
backup=(etc/conf.d/cjdns)

# Disable Arch's default compilation optimizations
CFLAGS=""
OPTIONS=""

build() {
    # DELETE 'cjdadmin-cli' IF IT ALREADY EXISTS BEFORE CLONING THE REPO
    if [ -d "$srcdir"/cjdadmin-cli ]; then rm -rf "$srcdir"/cjdadmin-cli; fi
    git clone git://github.com/prurigro/cjdadmin-cli.git

    # DELETE 'cjdns' IF IT ALREADY EXISTS BEFORE CLONING THE REPO
    if [ -d "$srcdir"/cjdns ]; then rm -rf "$srcdir"/cjdns; fi
    git clone https://github.com/cjdelisle/cjdns.git

    # BUILD CJDNS
    pushd "$srcdir"/cjdns
        ./do
    popd

    # BUILD DEBUG (UNCOMMENT THE LINES BELOW AND COMMENT OUT 'BUILD CJDNS')
    #install -d "$srcdir"/cjdns/build
    #pushd "$srcdir"/cjdns/build
    #    Log_LEVEL=DEBUG cmake ..
    #    make
    #    make test
    #popd
}

package() {
    pushd "$srcdir"
        install -D -m755 cjdns.service.script "$pkgdir"/usr/lib/systemd/scripts/cjdns
        install -D -m644 cjdns.service "$pkgdir"/usr/lib/systemd/system/cjdns.service
        install -D -m755 cjdns.rc.d "$pkgdir"/etc/rc.d/cjdns
        install -D -m644 cjdns.conf.d "$pkgdir"/etc/conf.d/cjdns
        install -D -m755 cjdadmin-cli/cjdadmin "$pkgdir"/usr/bin/cjdadmin
        install -D -m755 cjdns/cjdroute "$pkgdir"/usr/bin/cjdroute
        install -D -m755 cjdns/cjdns "$pkgdir"/usr/bin/cjdns
    popd
}

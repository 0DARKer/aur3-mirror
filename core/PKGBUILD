# Maintainer: Tom Wambold <tom5760@gmail.com>
pkgname=core
pkgver=4.1
pkgrel=4
pkgdesc="Common Open Research Emulator"
arch=('i686' 'x86_64')
url="http://cs.itd.nrl.navy.mil/work/core/"
license=('BSD')
depends=(libev ebtables iproute2 python2 bridge-utils tkimg xterm lxc)
makedepends=(dia)
optdepends=(nrl-quagga quagga)
source=(http://downloads.pf.itd.nrl.navy.mil/core/source/$pkgname-src-$pkgver.tgz
        cored
        configure-libev-4.patch
        python-Makefile-quoting.patch
        python2.patch)
md5sums=('79a30e1442836f66a29aab0c455c877f'
         'b4c0bf514fb46bb97a459e9eabcec27b'
         '67fe62fe79bcaf47fb291dcdd158f829'
         '46abc97c5b638562ae068eabb166f02c'
         '92bd1b24cc64d1654bbfc9151455d958')

build() {
  cd "$srcdir/$pkgname-$pkgver"

  patch -p1 < ../configure-libev-4.patch
  patch -p1 < ../python-Makefile-quoting.patch
  patch -p1 < ../python2.patch

  export CFLAGS="$CFLAGS -Wno-error=unused-but-set-variable -D_GNU_SOURCE"
  export CXXFLAGS="$CXXFLAGS -Wno-error=unused-but-set-variable -D_GNU_SOURCE"

  ./bootstrap.sh
  ./configure PYTHON=/usr/bin/python2 libev_CFLAGS="-D_GNU_SOURCE -DEV_COMPAT3=1 -DEV_PROTOTYPES=1" libev_LIBS= --prefix=/usr

  # I think there is a build concurrency issue, sometimes builds fail if
  # coreapi isn't build first
  cd coreapi
  make -j1
  cd ..

  make
}

package() {
  cd "$srcdir/$pkgname-$pkgver"
  make DESTDIR="$pkgdir/" install

  rm "$pkgdir/etc/init.d/core"
  rmdir "$pkgdir/etc/init.d"

  install -D "$srcdir/cored" "$pkgdir/etc/rc.d/cored"
}

# vim:set ts=2 sw=2 et:
md5sums=('79a30e1442836f66a29aab0c455c877f'
         'b4c0bf514fb46bb97a459e9eabcec27b'
         '67fe62fe79bcaf47fb291dcdd158f829'
         'e5186a8ea0c31ec5d7fa4704352cdadc'
         '46abc97c5b638562ae068eabb166f02c'
         '92bd1b24cc64d1654bbfc9151455d958')
md5sums=('79a30e1442836f66a29aab0c455c877f'
         'b4c0bf514fb46bb97a459e9eabcec27b'
         '67fe62fe79bcaf47fb291dcdd158f829'
         '6a9a16ccd1fba426611893db18e156f2'
         '46abc97c5b638562ae068eabb166f02c'
         '92bd1b24cc64d1654bbfc9151455d958')
md5sums=('79a30e1442836f66a29aab0c455c877f'
         'b4c0bf514fb46bb97a459e9eabcec27b'
         '67fe62fe79bcaf47fb291dcdd158f829'
         '46abc97c5b638562ae068eabb166f02c'
         '92bd1b24cc64d1654bbfc9151455d958')

# Contributor: Daniel Kirchner <mokaga@lavabit.com>
pkgname=mingw-w64-openctm
pkgver=1.0.3
pkgrel=2
pkgdesc="An open file format for storing compressed triangle meshes. (mingw-w64)"
url="http://openctm.sourceforge.net/"
arch=('any')
license=('custom')
depends=()
makedepends=('mingw-w64-gcc' 'make')
source=('http://downloads.sourceforge.net/openctm/OpenCTM-1.0.3-src.tar.bz2'
        'openctm.def')
options=('!strip')
md5sums=('55948e7c2ad8c5807cd1b9b48718075b'
         'df9d425067390f36bc90d0fe78acc6d3')

build() {
  cd $srcdir

  rm -rf build32 build64
  cp -r OpenCTM-$pkgver build32
  cp -r build32 build64

  cd build32

  sed -i -e 's/dllwrap/i686-w64-mingw32-dllwrap/' lib/Makefile.mingw
  sed -i -e 's/dlltool/i686-w64-mingw32-dlltool/' lib/Makefile.mingw

  install -d $pkgdir/usr/{lib,include,bin,man/man1}

  make LIBDIR=$pkgdir/usr/lib INCDIR=$pkgdir/usr/include BINDIR=$pkgdir/usr/bin MAN1DIR=$pkgdir/usr/share/man/man1 CC=i686-w64-mingw32-gcc RC=i686-w64-mingw32-windres -f Makefile.mingw openctm
  install --d -m755 ${pkgdir}/usr/i686-w64-mingw32/{include,lib,bin}
  install -m644 lib/libopenctm.a ${pkgdir}/usr/i686-w64-mingw32/lib/
  install -m644 lib/openctm.h ${pkgdir}/usr/i686-w64-mingw32/include/
  install -m644 lib/openctmpp.h ${pkgdir}/usr/i686-w64-mingw32/include/
  install -m644 lib/openctm.dll ${pkgdir}/usr/i686-w64-mingw32/bin/

  cd ..
  cd build64

  cat ../openctm.def > lib/openctm-mingw1.def
  cat ../openctm.def > lib/openctm-mingw2.def

  sed -i -e 's/dllwrap/x86_64-w64-mingw32-dllwrap/' lib/Makefile.mingw
  sed -i -e 's/dlltool/x86_64-w64-mingw32-dlltool/' lib/Makefile.mingw

  install -d $pkgdir/usr/{lib,include,bin,man/man1}

  make LIBDIR=$pkgdir/usr/lib INCDIR=$pkgdir/usr/include BINDIR=$pkgdir/usr/bin MAN1DIR=$pkgdir/usr/share/man/man1 CC=x86_64-w64-mingw32-gcc RC=x86_64-w64-mingw32-windres -f Makefile.mingw openctm
  install --d -m755 ${pkgdir}/usr/x86_64-w64-mingw32/{include,lib,bin}
  install -m644 lib/libopenctm.a ${pkgdir}/usr/x86_64-w64-mingw32/lib/
  install -m644 lib/openctm.h ${pkgdir}/usr/x86_64-w64-mingw32/include/
  install -m644 lib/openctmpp.h ${pkgdir}/usr/x86_64-w64-mingw32/include/
  install -m644 lib/openctm.dll ${pkgdir}/usr/x86_64-w64-mingw32/bin/
}

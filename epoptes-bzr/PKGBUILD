#Contributor: Sam Stuewe <halosghost at archlinux dot info>
# Edited by Angel_Caido <geussepe at gmail dot com>

_name=epoptes
pkgname="${_name}-bzr"
pkgver=0.5.7.426
pkgrel=1
pkgdesc='An opensource computer lab management and monitoring tool'
makedepends=('bzr' 'python2-distutils-extra')
#url='http://www.epoptes.org/'
url='https://code.launchpad.net/~epoptes/epoptes/trunk'
license=('GPL3')
depends=('python2-dbus' 'python2-notify' 'python2-pycha-hg' 'hicolor-icon-theme' 'python2-netifaces' 'python2-pyopenssl' 'python2-service-identity' 'python2-twisted')
arch=('any')
conflicts=("${_name}")
provides=("${_name}")
#source=("${_name}::bzr+http://bazaar.launchpad.net/~${_name}/${_name}/trunk/")
source=('bzr+lp:epoptes'
  'epoptes-server.service'
  'epoptes-client.service')
sha256sums=('SKIP'
	    'SKIP'
	    'SKIP')

install="${_name}".install
#localdir = "${PWD}"

pkgver () {
    cd "${srcdir}/${_name}"
    printf '%s.%s' "$(bzr tags --sort=time | tail -n1 | cut -d '-' -f1)" "$(bzr revno)"
}

prepare () {
    cd "${srcdir}/${_name}"
    sed -e 's/sbin/bin/g' \
        -i setup.py
    for i in 'epoptes/ui/benchmark.py' \
      'epoptes/ui/notifications.py' \
      'epoptes/daemon/uiconnection.py' \
      'epoptes/daemon/bashplex.py' \
      'epoptes/daemon/commands.py' \
      'epoptes-client/message' \
      'epoptes/core/wol.py' \
      'epoptes-client/lock-screen' \
      'epoptes/core/structs.py' \
      'epoptes/ui/about_dialog.py' \
      'epoptes/ui/execcommand.py' \
      'epoptes/common/config.py' \
      'epoptes/ui/remote_assistance.py' \
      'epoptes/ui/gui.py' \
      'epoptes/common/xdg_dirs.py' \
      'twisted/plugins/epoptesd.py' \
      'epoptes/common/ltsconf.py' \
      'epoptes/ui/sendmessage.py' \
      'epoptes-client/remote-assistance' \
      'epoptes-client/screenshot' \
      'epoptes/common/constants.py' \
      'epoptes/daemon/guiplex.py' \
      'epoptes/daemon/exchange.py' \
      'epoptes/core/lib_users.py' \
      'epoptes/ui/client_information.py'
    do 
      sed -i '1s+python+python2+' $i
    done
}

package () {
    cd "${srcdir}/${_name}"
    python2 setup.py install --root="${pkgdir}/" --optimize=1
    #mkdir "${pkgdir}/etc/epoptes"
    mkdir "${pkgdir}/usr/lib/systemd"
    mkdir "${pkgdir}/usr/lib/systemd/system"
    install -m 644 "${startdir}/epoptes-client.service" "${pkgdir}"/usr/lib/systemd/system/epoptes-client.service
    install -m 644 "${startdir}/epoptes-server.service" "${pkgdir}"/usr/lib/systemd/system/epoptes-server.service
    #install -m 644 "../epoptes-client.service" "${pkgdir}"/usr/lib/systemd/system/epoptes-client.service
    #install -m 644 "../epoptes-server.service" "${pkgdir}"/usr/lib/systemd/system/epoptes-server.service
}

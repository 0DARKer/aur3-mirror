# Maintainer: Daniel Kirchner <daniel at ekpyron dot org>

pkgname=mingw-w64-assimp
pkgver=2.0.863
pkgrel=4
pkgdesc="Portable Open Source library to import various well-known 3D model formats in an uniform manner (mingw-w64)"
arch=('i686' 'x86_64')
license=('BSD')
depends=('mingw-w64-boost')
makedepends=('cmake' 'mingw-w64-gcc')
url=('http://assimp.sourceforge.net/index.html')
source=("http://downloads.sourceforge.net/project/assimp/assimp-2.0/assimp--${pkgver}-sdk.zip?r=&ts=1311769563&use_mirror=puzzle")
options=(!strip !buildflags)
sha1sums=('eb6938c134e7110a96243570e52a8b860d15d915')

_basename=assimp
_targetarch32=i686-w64-mingw32
_targetarch64=x86_64-w64-mingw32

build() 
{
	cd ${srcdir}

	sed -i -e 's/Windows.h/windows.h/' ${_basename}--${pkgver}-sdk/code/Win32DebugLogStream.h

	# build 32-bit shared library
	rm -rf build
	mkdir build
	cd build

    echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
    echo "SET(CMAKE_C_COMPILER ${_targetarch32}-gcc)" >> win32.cmake
    echo "SET(CMAKE_CXX_COMPILER ${_targetarch32}-g++)" >> win32.cmake
    echo "SET(CMAKE_RC_COMPILER ${_targetarch32}-windres)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH /usr/${_targetarch32})" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake	
	
	cmake ../${_basename}--${pkgver}-sdk \
		-DCMAKE_TOOLCHAIN_FILE=win32.cmake \
		-DCMAKE_INSTALL_PREFIX="/usr/${_targetarch32}" \
		-DBUILD_ASSIMP_TOOLS=NO
	make 
	make DESTDIR=$pkgdir install
	
	# build 64-bit shared
	cd ..
	rm -rf build
	mkdir build
	cd build	

    echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
    echo "SET(CMAKE_C_COMPILER ${_targetarch64}-gcc)" >> win32.cmake
    echo "SET(CMAKE_CXX_COMPILER ${_targetarch64}-g++)" >> win32.cmake
    echo "SET(CMAKE_RC_COMPILER ${_targetarch64}-windres)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH /usr/${_targetarch64})" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake	
	
	cmake ../${_basename}--${pkgver}-sdk \
		-DCMAKE_TOOLCHAIN_FILE=win32.cmake \
		-DCMAKE_INSTALL_PREFIX="/usr/${_targetarch64}" \
		-DBUILD_ASSIMP_TOOLS=NO
	make 
	make DESTDIR=$pkgdir install
	
	# modify CMakeLists.txt to create static libraries
	cd ..
	sed -i -e 's/ADD_LIBRARY( assimp SHARED/ADD_LIBRARY( assimp STATIC/' ${_basename}--${pkgver}-sdk/code/CMakeLists.txt

	# build 32-bit static library
	rm -rf build
	mkdir build
	cd build

    echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
    echo "SET(CMAKE_C_COMPILER ${_targetarch32}-gcc)" >> win32.cmake
    echo "SET(CMAKE_CXX_COMPILER ${_targetarch32}-g++)" >> win32.cmake
    echo "SET(CMAKE_RC_COMPILER ${_targetarch32}-windres)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH /usr/${_targetarch32})" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake	
	
	cmake ../${_basename}--${pkgver}-sdk \
		-DCMAKE_TOOLCHAIN_FILE=win32.cmake \
		-DCMAKE_INSTALL_PREFIX="/usr/${_targetarch32}" \
		-DBUILD_ASSIMP_TOOLS=NO
	make 
	install -Dm644 code/libassimp.a ${pkgdir}/usr/${_targetarch32}/lib
	
	# build 64-bit static library
	cd ..
	rm -rf build
	mkdir build
	cd build	

    echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
    echo "SET(CMAKE_C_COMPILER ${_targetarch64}-gcc)" >> win32.cmake
    echo "SET(CMAKE_CXX_COMPILER ${_targetarch64}-g++)" >> win32.cmake
    echo "SET(CMAKE_RC_COMPILER ${_targetarch64}-windres)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH /usr/${_targetarch64})" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
    echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake	
	
	cmake ../${_basename}--${pkgver}-sdk \
		-DCMAKE_TOOLCHAIN_FILE=win32.cmake \
		-DCMAKE_INSTALL_PREFIX="/usr/${_targetarch64}" \
		-DBUILD_ASSIMP_TOOLS=NO
	make 
	install -Dm644 code/libassimp.a ${pkgdir}/usr/${_targetarch64}/lib
	
	cd ..
	install -Dm644 ${_basename}--${pkgver}-sdk/LICENSE ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE
}

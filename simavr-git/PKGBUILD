# Maintainer: Ivan Sichmann Freitas <ivansichfreitas _(at)_ gmail _(dot)_ com>

pkgname=simavr-git
pkgver=20110221
pkgrel=1
pkgdesc="A new AVR simulator for linux, or any platform that uses avr-gcc"
arch=('i686' 'x86_64')
url="http://gitorious.org/simavr"
license=('GPL3')
depends=('gcc-avr' 'binutils-avr')
makedepends=('git' 'avr-libc' 'gcc-avr' 'binutils-avr')
source=('makefile.patch')
md5sums=('00ef9cb8cdedc2818f846db2d8c06c6b')

_gitroot="git://gitorious.org/simavr/simavr.git"
_gitname="simavr"

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot $_gitname
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"

  # patching the makefile to find arch's avr root
  patch -p1 -i $startdir/makefile.patch
  unset LDFLAGS
  make
}

package() {
  # installing simavr binary
  install -m755 -D $srcdir/$_gitname-build/simavr/run_avr $pkgdir/usr/bin/simavr
  # installing tests
  install -m755 -d -D $srcdir/$_gitname-build/tests $pkgdir/usr/share/simavr/tests
  # since the package doesn't provide a make install...
  cp -a $srcdir/$_gitname-build/tests/* $pkgdir/usr/share/simavr/tests
  chmod -R 755 $pkgdir/usr/share/simavr/tests
  # installing examples
  install -m755 -d -D $srcdir/$_gitname-build/examples $pkgdir/usr/share/simavr/examples
  # ugly, but works
  cp -a $srcdir/$_gitname-build/examples/* $pkgdir/usr/share/simavr/examples
  chmod -R 755 $pkgdir/usr/share/simavr/examples
}

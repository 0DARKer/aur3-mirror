# Maintainer : Maximilien Noal <noal dot maximilien at gmail dot com>
# Contributor: Luis Moreno <luismoreno83 at gmail dot com>
# Contributor: Christos Nouskas <nous at archlinux dot us>
# Now based on nvidia-96xx by City-busz
# Previously based on nvidia-beta-all by Ng Oon-Ee <n g o o n e e AT g mail dot com>
# ...Which is based on nvidia-beta by Dan Vratil <vratil@progdansoft.com>

pkgname=nvidia-96xx-all
pkgver=96.43.23
pkgrel=3
pkgdesc="NVIDIA drivers, 96xx branch. Builds modules for all kernels detected on system."
arch=('i686' 'x86_64')
_kernver=`uname -r`
[ "$CARCH" = "i686" ] && ARCH=x86 && NV=0
[ "$CARCH" = "x86_64" ] && ARCH=x86_64 && NV=2
provides=('nvidia-96xx')
url="http://www.nvidia.com/"
depends=("nvidia-96xx-utils>=${pkgver}")
optdepends=('pangox-compat: to run nvidia-settings'
            'xorg-server1.12: latest compatible Xorg server'
            'xf86-input-evdev1.12: needed by xorg-server1.12')
conflicts=('nvidia-71xx' 'nvidia-96xx' 'nvidia-173xx' 'nvidia-legacy' 'nvidia-beta' 'nvidia')
license=('custom')
install="nvidia.install"
source=("http://download.nvidia.com/XFree86/Linux-$ARCH/${pkgver}/NVIDIA-Linux-$ARCH-${pkgver}-pkg0.run" "linux-3.7-gentoo.patch")
options=(!strip)
md5sums=('ca0bc6ae3b37cb259f3a906b4dc4670b' '4cddc386cdf2c22c81b12f9b7ffdb04b')
[ "$CARCH" = "x86_64" ] && md5sums[0]='a043fe8dd639bd00b1792eea7a195677'

build()
{
	msg "Building $pkgname..."
	# Loop through all detected kernels
	for _kernver in `file /boot/* | grep 'Linux kernel.*boot executable' | grep 'vmlinuz' | sed 's/.*version \([^ ]\+\).*/\1/'`;
	do
                msg "Making module for linux $_kernver :"
                msg "1 of 4 - Extracting nvidia drivers..."
		cd $startdir/src/
		sh NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}.run --extract-only
		cd NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}/usr/src/nv

                #Makefile for linux >=2.6
		ln -s Makefile.kbuild Makefile

		msg "2 of 4 - Applying patch for linux 3.7..."
                patch -p3 -i $srcdir/linux-3.7-gentoo.patch || exit 1

		msg "3 of 4 - Building module for $_kernver..."
		make SYSSRC=/lib/modules/${_kernver}/build module

		# Install kernel module
                msg "4 of 4 - Installing kernel module for $_kernver..."
		mkdir -p $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/video/
		install -m644 nvidia.ko $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/video/
		rm -rf $startdir/src/NVIDIA-Linux-${ARCH}-${pkgver}-pkg${NV}
	done
}

package() {
        msg "Packaging $pkgname..."
	mkdir -p $pkgdir/etc/modprobe.d
	echo "blacklist nouveau" >> $pkgdir/etc/modprobe.d/nouveau_blacklist.conf || return 1
}

# Contributor: Ryan Corder <ryanc@greengrey.org>

pkgname=palm-novacom
pkgver=1.0.56
pkgrel=3
pkgdesc="Unofficial package of Novacom service for webOS development connectivity"
url="http://developer.palm.com/index.php"
arch=('i686' 'x86_64')
license=("unknown")
depends=('java-runtime>=6')
source=(http://cdn.downloads.palm.com/sdkdownloads/1.4.5.465/sdkBinaries/${pkgname}_${pkgver}_i386.deb
        'novacomd'
        'novacomd-conf.d')
noextract=()
md5sums=('f1f9375fd6c0ab89df1f8f2fc0dd366f'
         'f4a8f875a9d9b44930112606b55b8259'
         'b99bd22ff41108b78ba3a74fa768f5ff')

# As of 1.0.55, 64-bit has a different download
if [[ "${CARCH}" = "x86_64" ]]; then
    source=(http://cdn.downloads.palm.com/sdkdownloads/1.4.5.465/sdkBinaries/${pkgname}_${pkgver}_amd64.deb
            'novacomd'
            'novacomd-conf.d')
    md5sums=('fcad577b3a315832747fd3d664b17804'
             'f4a8f875a9d9b44930112606b55b8259'
             'b99bd22ff41108b78ba3a74fa768f5ff')
fi

# Extra dependencies when running 64-bit
if [[ "${CARCH}" = "x86_64" ]]; then
    depends=(${depends[@]} 'lib32-libusb')
else
    depends=(${depends[@]} 'libusb')
fi

build() {
    cd $startdir/src

    if [[ "${CARCH}" = "x86_64" ]]; then
        ar x $startdir/palm-novacom_${pkgver}_amd64.deb || return 1
    else
        ar x $startdir/palm-novacom_${pkgver}_i386.deb || return 1
    fi

    tar zxvf $startdir/src/data.tar.gz -C $startdir/pkg || return 1

    mkdir -m 0755 -p $startdir/pkg/etc/conf.d || return 1
    mkdir -m 0755 -p $startdir/pkg/etc/rc.d || return 1
    mkdir -m 0755 -p $startdir/pkg/usr/bin || return 1

    install -m 755 $startdir/novacomd $startdir/pkg/etc/rc.d/novacomd || return 1
    install -m 644 $startdir/novacomd-conf.d $startdir/pkg/etc/conf.d/novacomd || return 1

    rm -rf $startdir/pkg/opt/Palm/novacom/scripts || return 1
    rm -rf $startdir/pkg/usr/local || return 1
    rm -rf $startdir/pkg/usr/share || return 1

    ln -s /opt/Palm/novacom/novacom $startdir/pkg/usr/bin/novacom
    ln -s /opt/Palm/novacom/novaterm $startdir/pkg/usr/bin/novaterm
}

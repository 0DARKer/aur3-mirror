#!/bin/bash
# lyrarch, a bash search tool for song lyrics
# 
# Creation-Date: 2012-07-19
# Revision-Date: 2012-07-19
# Version 0.1
#

VER=0.1
CONFIG=/usr/share/lyrarch



#### Parse html files
#### lyric.htm is the file in which there is the list of songs
#### testo.htm is the file in which there are lyrics
#### url_2.txt is the file with url of songs
clear
if [ -f $CONFIG/lyrlogo ]; then
	$CONFIG/lyrlogo
	echo -e ""
else
	echo -e "$CONFIG/lyrlogo $(gettext 'not found')!!!"
fi



funzione_1 () {
        numero_riga_1=`cat /tmp/lyric.htm | grep -n "<tr><td width=50% valign=top>" | head -1 | cut -c1,2,3`
        #numero_riga_1=`cat /tmp/lyric.htm | grep -n "<td width=\"50%\" valign=\"top\">" | head -1 | cut -c1,2,3`
        numero_riga_x=`cat /tmp/lyric.htm | grep -n "</table>" | head -3 | tail -1 | cut -c1,2,3`
        #numero_riga_x=`cat /tmp/lyric.htm | grep -n "</table>" | head -4 | tail -1 | cut -c1,2,3`
        numero_riga_2=$(( $numero_riga_x - 4 ))
        sed -e 's/<[a-zA-Z\/][^>]*>//g' /tmp/lyric.htm > /tmp/lyric.txt
        righe=$(( $numero_riga_2 - $numero_riga_1 ))
        cat /tmp/lyric.txt | head -$numero_riga_2 | tail -$righe | nl -v 0 > /tmp/canzoni.txt
	cat /tmp/canzoni.txt | grep "lyrics"
	cat /tmp/lyric.htm | head -$numero_riga_2 | tail -$righe | sed -e 's/\(.*\).$/\1/g' | sed -e 's/\&\#8226\; //g' | awk {'print$2'} | cut -c7-100 > /tmp/url_2.txt
        FILE_DATA_B=( $( /bin/cat /tmp/url_2.txt ) )

        echo "Choose"
        read scelta;

        curl http://www.lyricsmania.com${FILE_DATA_B[$scelta]} -o "/tmp/testo.htm" 2> /dev/null

	if grep --quiet "not in our archive" "/tmp/testo.htm"
	then
		echo "There are no lyrics :-("
		echo "Press ENTER to exit"
		read
		exit
	fi
        numero_riga=`cat -n /tmp/testo.htm | grep "</div>" | head -21 | tail -1 | awk '{print$1}'`
        sed -e 's/<[a-zA-Z\/][^>]*>//g' /tmp/testo.htm > /tmp/testo.txt
        sed -i "s///g" /tmp/testo.txt
        righe=$(($numero_riga - 285))
        cat /tmp/testo.txt | head -$numero_riga | tail -$righe
}

echo "LYRARCH, a bash search tool for song lyrics"
echo "-------------------------------------------"
echo
echo "Insert title/artist (or both)"
read titolo;

titolo_modificato=`echo $titolo | sed 's/ /+/g' -`

#Scarica da lyricsmania

curl -L http://www.lyricsmania.com/searchnew.php\?k\=$titolo_modificato --head -o "/tmp/header.txt" 2> /dev/null

if grep --quiet "302 Moved" "/tmp/header.txt"
then
	curl -L http://www.lyricsmania.com/searchnew.php\?k\=$titolo_modificato -o "/tmp/lyric.htm" 2> /dev/null
	funzione_1

else

	curl -L http://www.lyricsmania.com/searchnew.php\?k\=$titolo_modificato -o "/tmp/ricerca_1.htm" 2> /dev/null


	numero_riga=`cat /tmp/ricerca_1.htm -n | grep "<div></div>" | head -2 | tail -1 | awk '{print$1}'`
	sed -e 's/<[a-zA-Z\/][^>]*>//g' /tmp/ricerca_1.htm > /tmp/ricerca_1.txt

	risultati=`sed -n '294p' < /tmp/ricerca_1.txt | awk '{print$1}'`

	echo "$risultati match found:"

	righe=$(($numero_riga - 294))

	cat /tmp/ricerca_1.txt | head -$numero_riga | tail -$righe | grep -P "\t\t\t" | nl -v 0

	cat /tmp/ricerca_1.htm | head -368 | tail -74 | grep -P "\t\t\t" | awk {'print$2'} | cut -c7-100 | sed -e 's/\(.*\).$/\1/g' > /tmp/url.txt

	#read -a array < "/tmp/url.txt"

	FILE_DATA=( $( /bin/cat /tmp/url.txt ) )

	echo "Choose"
	read scelta;



	curl -L http://www.lyricsmania.com${FILE_DATA[$scelta]} -o "/tmp/lyric.htm" 2> /dev/null

	if grep --quiet "Rate this song" "/tmp/lyric.htm"
	then
		echo "esiste"
		numero_riga=`cat -n /tmp/lyric.htm | grep "</div>" | head -21 | tail -1 | awk '{print$1}'`
		sed -e 's/<[a-zA-Z\/][^>]*>//g' /tmp/lyric.htm > /tmp/lyric.txt
		righe=$(($numero_riga - 285))
		cat /tmp/lyric.txt | head -$numero_riga | tail -$righe
	else
		funzione_1
	fi
fi	

echo "Press ENTER to exit"
read

rm -rf /tmp/lyric.*
rm -rf /tmp/url*.*
rm -rf /tmp/ricerca*
rm -rf /tmp/canzoni*

# Maintainer:  Devin Cofer <ranguvar{AT]archlinux[DOT}us>
# Contributor: Tobias Powalowski <tpowa@archlinux.org>
# Maintainer: Frederic Bezies <fredbezies@gmail.com>

pkgname=qemu-git
pkgver=20130222
pkgrel=2
pkgdesc="Processor emulator and virtual machine with with expansive multi-arch support and fast operation (with an accelerator), git version."
arch=('i686' 'x86_64')
license=('GPL2' 'LGPL2')
url="http://wiki.qemu.org/Index.html"
makedepends=('git' 'texi2html' 'perl')
depends=('brltty' 'gnutls' 'libpulse' 'bluez' 'vde2' 'curl' 'sdl' 'libcap-ng' 'spice' 'gtk2' 'vte')
conflicts=('qemu' 'kvm' 'kvm-git')
provides=('qemu')

source=('65-kvm.rules'
        'qemu.install'
	'docs-Fix-generating-qemu-doc.html-with-texinfo-5.patch')
sha256sums=('c16a8dc7855880b2651f1a3ff488ecc54d4ac1036c71fffd5007021d8d18a7c5'
            '910e845f3da5c4ea38b3f548dab8c0cfbcdd62822cd38afa2175ba23ac2c31f2'
            '29df62a57855fcc5348ddc1d5b3112c564df5d22cdfc454a54faeede6569fe6f')
install='qemu.install'

_gitroot="git://git.qemu.org/qemu.git"
_gitname=qemu

options=('!strip')
build()
{
	msg2 "Performing source checkout..."
	if [ -d $_gitname ]; then
		(cd $_gitname && git pull origin)
	else
		git clone "$_gitroot"
	fi
	msg2 "Source checkout finished."
	rm -rf $_gitname-build
	git clone $_gitname $_gitname-build
	cd $_gitname-build

	# patch to build docs with texinfo 5
	# To remove when bug https://bugs.launchpad.net/qemu/+bug/1130533
	# will be closed as fixed
	patch -Np1 -i "${srcdir}/docs-Fix-generating-qemu-doc.html-with-texinfo-5.patch"
	
	./configure --prefix=/usr --sysconfdir=/etc --audio-drv-list=alsa,sdl,pa \
              --python=/usr/bin/python2 \
              --audio-card-list=ac97,sb16,es1370,hda \
              --enable-docs --enable-mixemu --libexecdir=/usr/lib/qemu --disable-werror --enable-spice --enable-gtk
	make
}
package() {
	cd "$srcdir"/$_gitname-build

        make DESTDIR="${pkgdir}" libexecdir="/usr/lib/qemu" install

 install -D -m644 "${srcdir}/65-kvm.rules" \
                   "${pkgdir}/usr/lib/udev/rules.d/65-kvm.rules"
  # bridge_helper needs suid
  # https://bugs.archlinux.org/task/32565
  chmod u+s "${pkgdir}/usr/lib/qemu/qemu-bridge-helper"
  # strip scripts directory
    find "${pkgdir}/usr/src/linux-${_kernver}/scripts"  -type f -perm -u+w 2>/dev/null | while read binary ; do
      case "$(file -bi "$binary")" in
        *application/x-executable*) # Binaries
        /usr/bin/strip $STRIP_BINARIES "$binary";;
      esac
    done
}


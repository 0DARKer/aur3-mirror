# Maintainer: Gustavo Alvarez <sl1pkn07@gmail.com>

pkgname=avxsynth-svn
pkgver=110
pkgrel=1
pkgdesc="Linux Port of AviSynth"
arch=('i686' 'x86_64')
url="http://code.google.com/p/avxsynth/"
license=("GPLv2")
depends=('qt' 'mplayer' 'log4cpp' 'ffmpegsource2-svn')


_svntrunk=http://avxsynth.googlecode.com/svn/trunk/
_svnmod=avxsynth

build() {
  cd "${srcdir}"

  msg "Connecting to SVN server...."

  if [ -d "${srcdir}"/"${_svnmod}" ] ; then
      cd "${_svnmod}" && svn update
  else
      svn co "${_svntrunk}" "${_svnmod}"
  fi
    
  [ -d "${srcdir}"/"${_svnmod}"-build ] && rm -fr "${srcdir}"/"${_svnmod}"-build
  cp -R "${srcdir}"/"${_svnmod}" "${srcdir}"/"${_svnmod}"-build

  msg "SVN checkout done or server timeout"
  msg "Starting make..."

  cd "${srcdir}"/"${_svnmod}"-build/AVXSynth
 
  # Fix Qt & general paths
  for i in $( find . -name Makefile ); do
    sed -e 's|qt4|qt|g' -e 's|qt/Q|Q|g' -e 's|moc-qt|moc|g' -i "${i}"
    sed 's|local/||g' -i "${i}"
  done

  sed -e "s|\$(HOME)/\$(AVXSYNTH_DEPLOY_REL_PATH)/|${pkgdir}/usr/lib/\$(AVXSYNTH_DEPLOY_REL_PATH)/|g" \
      -e "s|.AVXSynth|${_svnmod}|g" \
      -e "s|\$(HOME)|${pkgdir}/usr/lib|g" -i *.mk*
  
  #Fix RPATH in AVXEdit & avxSynthFrameServer
  cd apps
  for i in $( find . -name Makefile ); do
    sed -e "s|-R\$(AVXSYNTH_DEPLOY_PLUGINS)|-R/usr/lib/\$(AVXSYNTH_DEPLOY_REL_PATH)|g" \
        -e "s|-R\$(AVXSYNTH_DEPLOY_ROOT)|-R/usr/lib/\$(AVXSYNTH_DEPLOY_ROOT_REL_PATH)|g" -i "${i}"
  done
  cd "${srcdir}"/"${_svnmod}"-build/AVXSynth

  SUBLIBS+="-L/usr/lib -ldl" make
}

package() {

  cd "${srcdir}"/"${_svnmod}"-build/AVXSynth
  install -d "${pkgdir}"/usr/bin
  install -Dm775 apps/AVXEdit/AVXEdit "${pkgdir}"/usr/bin/
  install -Dm775 apps/avxframeserver/frameserverapp/avxSynthFrameServer "${pkgdir}"/usr/bin/
}
# Contributor: Jonas Heinrich <onny@project-insanity.org>
# Maintainer: Jonas Heinrich <onny@project-insanity.org>

pkgname=pykolab
pkgver=0.6.11
pkgrel=1
pkgdesc="Kolab Groupware solution meta-package"
arch=(any)
license=('GPL3')
makedepends=('intltool')
depends=('python2' 'python2-icalendar' 'python2-nose' 'python2-ldap' 'python2-augeas' 'python2-cheetah' 'python2-sqlalchemy')
url="http://kolab.org"
install=pykolab.install
source=("http://mirror.kolabsys.com/pub/releases/${pkgname}-${pkgver}.tar.gz"{,.gpg}
	"http://mirror.kolabsys.com/pub/releases/kolab-schema-3.0.tar.gz"{,.gpg}
	"http://mirror.kolabsys.com/pub/releases/kolab-webadmin-3.1.5.tar.gz"{,.gpg})
optdepends=('cyrus-imapd: Only supported IMAP backend so far',
	    'postfix: Mail Transfer Agent',
	    '389-ds-base: Prefered LDAP server',
	    'openldap: Can be used as LDAP server',
	    'roundcubemail>=0.9: Default webclient used by Kolab',
	    'roundcubemail-plugins-kolab>=3.0: Roundcube plugin for Kolab integration'
	    'mariadb: Mysql server backend')
sha512sums=('c1137736e6f564c71690b126e820207154f50d258672e046002395ecf4858a9fd324cdef277e0f2952d4b975b36ab9f9573bca83424b7110a1acad946cb47556'
	    'e772538849e0388b0356a99a4afbc49496d32738c3fc7b301f3554ee8d997a37257d3204bbf07b960cb0de755d693143617f6a2a0eb532ae15bb63a112bfd42e'
	    'e4d1dde34e9431450e5bc6e4b75564ff462275ee36c7f6f918ecef6ab271f16cba6a4a9814921f4c83227826e63d759b5d938aa158e217d90881275d223b51d3'
	    '15d1b5cec36e508f879c589813802a3f0af292e25093b38bdbe57e463e74c432b8db1c1cc584272084f7555bf620ba8c0bb04bdc29b789fce3f0dff7a7c1c7ce'
	    'd0ff7377bdd4684f5cb535208a634b15a4b13eecd9c6b53ece69f50520057217db23d23fe6a8d693b8649064c26089e306cf94a82fa5b5dd7ecce3799c7e00c0'
	    'bb8e71459a75e98b1e8d6890a8b33dd4c992f8825273cf44e8a16710d2ee1a1f9107282a2fdf32553128c9f3e86a4e176830f41a5e64d25db13903ad710b4691')

prepare(){
  cd "$srcdir/${pkgname}-${pkgver}"
  find . -name "*.py" -exec sed -i "s|usr/bin/python|usr/bin/python2|" {} \;
  sed -i 's|sysconfig/kolabd|conf.d/kolabd.conf|' kolabd/kolabd.systemd
  sed -i 's|/usr/sbin|/usr/bin|' kolabd/kolabd.systemd
  sed -i '10iPermissionsStartOnly=true\nExecStartPre=-/usr/bin/mkdir /var/run/kolabd\nExecStartPre=/usr/bin/chown -R kolab:kolab /var/run/kolabd' kolabd/kolabd.systemd
  sed -i 's|sysconfig/kolab-saslauthd|conf.d/kolab-saslauthd.conf|' saslauthd/kolab-saslauthd.systemd
  sed -i 's|/usr/sbin|/usr/bin|' saslauthd/kolab-saslauthd.systemd
  sed -i 's|sysconfig/wallace|conf.d/wallace.conf|' wallace/wallace.systemd
  sed -i 's|/usr/sbin|/usr/bin|' wallace/wallace.systemd
  sed -i '318i\    elif os.path.isfile("/usr/bin/setup-ds.pl"):\n        setup_ds_admin = "/usr/bin/setup-ds.pl"' pykolab/setup/setup_ldap.py
  sed -i '385s/\/usr\/share\/doc/\/usr\/share\/kolab/g' pykolab/setup/setup_ldap.py
  sed -i '124s/\/usr\/share\/doc/\/usr\/share\/kolab/g' pykolab/setup/setup_mysql.py
}

build() {
  cd "$srcdir/${pkgname}-${pkgver}"
  autoreconf -vi
  PYTHON=python2 ./configure \
    	--prefix=/usr \
	--sbindir=/usr/bin \
	--sysconfdir=/etc \
  	--localstatedir=/var
  make
}

package() {
  cd "$srcdir/${pkgname}-${pkgver}"
  make DESTDIR=$pkgdir/ install

  install -D "COPYING" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"

  install -Dm644 "kolabd/kolabd.systemd" "${pkgdir}/usr/lib/systemd/system/kolabd.service"
  install -Dm644 "kolabd/kolabd.tmpfiles.d.conf" "${pkgdir}/usr/lib/tmpfiles.d/kolabd.conf"
  install -Dm644 "kolabd/kolabd.sysconfig" "${pkgdir}/etc/conf.d/kolabd.conf"

  install -Dm644 "saslauthd/kolab-saslauthd.systemd" "${pkgdir}/usr/lib/systemd/system/kolab-saslauthd.service"
  install -Dm644 "saslauthd/kolab-saslauthd.sysconfig" "${pkgdir}/etc/conf.d/kolab-saslauthd.conf"

  install -Dm644 "wallace/wallace.systemd" "${pkgdir}/usr/lib/systemd/system/wallace.service"
  install -Dm644 "wallace/wallace.tmpfiles.d.conf" "${pkgdir}/usr/lib/tmpfiles.d/wallace.conf"
  install -Dm644 "wallace/wallace.sysconfig" "${pkgdir}/etc/conf.d/wallace.conf"

  install -Dm644 doc/kolab.1 "$pkgdir/usr/share/doc/kolab/kolab.1"

  cp ${srcdir}/kolab-schema-3.0/* "${pkgdir}/usr/share/kolab/"
  cp ${srcdir}/kolab-webadmin-3.1.5/doc/kolab_wap-3.1.sql "${pkgdir}/usr/share/kolab/"
}

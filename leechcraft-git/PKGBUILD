# Contributor: Aleksey Frolov (Aleks Lifey aka atommix) <aleks.lifey (at) gmail.com>
# Contributor: SolarRay <SolarRay.ru (at) gmail.com>
# Contributor: Alexander 'hatred' Drozdov <adrozdoff [dog] gmail.com >
pkgname=leechcraft-git
pkgver=20110213
pkgrel=1
pkgdesc="Opensource network client providing a full-featured web browser, BitTorrent client and much more."
arch=('i686' 'x86_64')
url="http://leechcraft.org"
license=('GPL3')
depends=('qt>=4.6' 'libtorrent-rasterbar>=0.15.0' 'phonon' 'qross' 'curl' 'qjson')
makedepends=('gcc' 'boost' 'make' 'cmake' 'git')
conflicts=(leechcraft)
provides=(leechcraft)
replaces=(leechcraft)
install=leechcraft.install

_gitname=leechcraft
_gitroot=git://github.com/0xd34df00d/leechcraft.git

_gitname_qxmpp=qxmpp-dev
_gitroot_qxmpp=git://github.com/0xd34df00d/qxmpp-dev.git

build() {
  cd ${srcdir}

  msg "Connecting to GIT server...."
  if [ -d ${_gitname} ] ; then
    cd ${_gitname} && git pull origin
    msg "The local files are updated."
    cd ${srcdir}
  else
    git clone ${_gitroot} ${_gitname}
  fi
  msg "GIT checkout done or server timeout"
  
  # Build QXMPP-DEV
#  msg "Connecting to GIT server...."
#  if [ -d ${_gitname_qxmpp} ] ; then
#    cd ${_gitname_qxmpp} && git pull origin
#    msg "The local files are updated."
#    cd ${srcdir}
#  else
#    git clone ${_gitroot_qxmpp} ${_gitname_qxmpp}
#  fi
#  msg "GIT checkout done or server timeout"

  msg "Starting make..."

#  rm -rf ${_gitname_qxmpp}-build
#  mkdir ${_gitname_qxmpp}-build
#  cd ${_gitname_qxmpp}-build
#  qmake
#  make

  cd ${srcdir}
  rm -rf ${_gitname}-build
  mkdir ${_gitname}-build
  cd ${_gitname}-build

  msg "Building ..."

  msg "Apply ArchLinux hacks for build..."
  _git_version=`(cd ${srcdir}/${_gitname} && git describe | awk '{print $1}')`

  cmake ${srcdir}/${_gitname}/src \
    -DLEECHCRAFT_VERSION="${_git_version}" \
    -DCMAKE_INSTALL_PREFIX=/usr \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DENABLE_PYLC:BOOL=False \
    -DENABLE_ANHERO=False \
    -DENABLE_QROSP=True \
    -DENABLE_LACKMAN=True \
    -DENABLE_SECMAN=True
#    -DENABLE_AZOTH=True


  make DESTDIR=$pkgdir install

  install -Dm 644 $srcdir/${_gitname}/src/resources/images/leechcraft.svg \
              $pkgdir/usr/share/pixmaps/leechcraft.svg


  install -Dm 644 $srcdir/${_gitname}/src/freedesktop/leechcraft.desktop \
              $pkgdir/usr/share/applications/leechcraft.desktop || return 1

  rm -rf ${_gitname}-build
}


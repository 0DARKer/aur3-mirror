diff -Naur xen/Config.mk xenb/Config.mk
--- xen/Config.mk	2013-03-09 10:39:52.116511945 -0700
+++ xenb/Config.mk	2013-03-09 10:53:08.509845278 -0700
@@ -7,7 +7,6 @@
 # fallback for older make
 realpath = $(wildcard $(foreach file,$(1),$(shell cd -P $(dir $(file)) && echo "$$PWD/$(notdir $(file))")))
 
--include $(XEN_ROOT)/.config
 
 # A debug build of Xen and tools?
 debug ?= y
@@ -29,7 +28,7 @@
 
 # Tools to run on system hosting the build
 HOSTCC      = gcc
-HOSTCFLAGS  = -Wall -Werror -Wstrict-prototypes -O2 -fomit-frame-pointer
+HOSTCFLAGS  = -Wstrict-prototypes -O2 -fomit-frame-pointer
 HOSTCFLAGS += -fno-strict-aliasing
 
 DISTDIR     ?= $(XEN_ROOT)/dist
@@ -68,7 +67,7 @@
 
 # See distro_mapping.txt for other options
 $(eval $(call setvar_dir,CONFIG_LEAF_DIR,,/etc/sysconfig,sysconfig,default))
-$(eval $(call setvar_dir,SUBSYS_DIR,/var/run,/subsys,/subsys,))
+$(eval $(call setvar_dir,SUBSYS_DIR,/run,/subsys,/subsys,))
 $(eval $(call setvar_dir,INITD_DIR,/etc,/rc.d/init.d,/rc.d/init.d,/init.d))
 
 ifneq ($(EXTRA_PREFIX),)
@@ -165,7 +164,7 @@
 
 CFLAGS += -std=gnu99
 
-CFLAGS += -Wall -Wstrict-prototypes
+CFLAGS += -Wstrict-prototypes
 
 # Clang complains about macros that expand to 'if ( ( foo == bar ) ) ...'
 # and is over-zealous with the printf format lint
@@ -197,7 +196,7 @@
 # near the place in the Xen Makefiles where the file is used.
 
 ifeq ($(GIT_HTTP),y)
-QEMU_REMOTE=http://xenbits.xen.org/git-http/qemu-xen-unstable.git
+QEMU_REMOTE=http://xenbits.xen.org/git-http/qemu-upstream-unstable.git
 else
 QEMU_REMOTE=git://xenbits.xen.org/qemu-xen-unstable.git
 endif
@@ -208,16 +207,16 @@
 SEABIOS_UPSTREAM_URL ?= http://xenbits.xen.org/git-http/seabios.git
 else
 OVMF_UPSTREAM_URL ?= git://xenbits.xen.org/ovmf.git
-QEMU_UPSTREAM_URL ?= git://xenbits.xen.org/qemu-upstream-unstable.git
-SEABIOS_UPSTREAM_URL ?= git://xenbits.xen.org/seabios.git
+QEMU_UPSTREAM_URL ?= git://git.qemu.org/qemu.git
+SEABIOS_UPSTREAM_URL ?= git://git.seabios.org/seabios.git
 endif
 OVMF_UPSTREAM_REVISION ?= b0855f925c6e2e0b21fbb03fab4b5fb5b6876871
 QEMU_UPSTREAM_REVISION ?= master
-SEABIOS_UPSTREAM_TAG ?= rel-1.7.1
+SEABIOS_UPSTREAM_TAG ?= master
 # Wed Aug 29 21:27:37 2012 -0400
 # Make iasl option check work with older versions of iasl.
 
-ETHERBOOT_NICS ?= rtl8139 8086100e
+ETHERBOOT_NICS ?= rtl8139 e1000_82540
 
 # Specify which qemu-dm to use. This may be `ioemu' to use the old
 # Mercurial in-tree version, or a local directory, or a git URL.
diff -Naur xen/Makefile xenb/Makefile
--- xen/Makefile	2013-03-09 10:39:52.116511945 -0700
+++ xenb/Makefile	2013-03-09 10:52:07.283178611 -0700
@@ -234,7 +234,7 @@
 	rm -f  $(D)$(CONFIG_DIR)/udev/rules.d/xend.rules
 	rm -f  $(D)$(SYSCONFIG_DIR)/xendomains
 	rm -f  $(D)$(SYSCONFIG_DIR)/xencommons
-	rm -rf $(D)/var/run/xen* $(D)/var/lib/xen*
+	rm -rf $(D)/run/xen* $(D)/var/lib/xen*
 	make -C tools uninstall
 	rm -rf $(D)/boot/tboot*
 
diff -Naur xen/config/StdGNU.mk xenb/config/StdGNU.mk
--- xen/config/StdGNU.mk	2013-03-09 10:39:52.119845277 -0700
+++ xenb/config/StdGNU.mk	2013-03-09 10:52:07.283178611 -0700
@@ -42,8 +42,8 @@
 PRIVATE_BINDIR = $(PRIVATE_PREFIX)/bin
 
 CONFIG_DIR = /etc
-XEN_LOCK_DIR = /var/lock
-XEN_RUN_DIR = /var/run/xen
+XEN_LOCK_DIR = /run/lock
+XEN_RUN_DIR = /run/xen
 XEN_PAGING_DIR = /var/lib/xen/xenpaging
 
 SYSCONFIG_DIR = $(CONFIG_DIR)/$(CONFIG_LEAF_DIR)
diff -Naur xen/configure xenb/configure
--- xen/configure	2013-03-09 10:39:52.123178611 -0700
+++ xenb/configure	2013-03-09 10:52:07.286511945 -0700
@@ -667,7 +667,7 @@
 datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
-localstatedir='${prefix}/var'
+localstatedir='${prefix}/run'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
 docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
@@ -1211,7 +1211,7 @@
   --libexecdir=DIR        program executables [EPREFIX/libexec]
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
-  --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
+  --localstatedir=DIR     modifiable single-machine data [PREFIX/run]
   --libdir=DIR            object code libraries [EPREFIX/lib]
   --includedir=DIR        C header files [PREFIX/include]
   --oldincludedir=DIR     C header files for non-gcc [/usr/include]
diff -Naur xen/extras/mini-os/lib/math.c xenb/extras/mini-os/lib/math.c
--- xen/extras/mini-os/lib/math.c	2013-03-09 10:39:52.219845278 -0700
+++ xenb/extras/mini-os/lib/math.c	2013-03-09 10:52:07.286511945 -0700
@@ -186,6 +186,7 @@
 	 * and thus
 	 *	m = 4 - n <= 2
 	 */
+	tmp.ul[H] = tmp.ul[L] = 0;
 	tmp.uq = uq;
 	u[0] = 0;
 	u[1] = HHALF(tmp.ul[H]);
diff -Naur xen/extras/mini-os/minios.mk xenb/extras/mini-os/minios.mk
--- xen/extras/mini-os/minios.mk	2013-03-09 10:39:52.223178611 -0700
+++ xenb/extras/mini-os/minios.mk	2013-03-09 10:52:07.286511945 -0700
@@ -6,7 +6,7 @@
 
 # Define some default flags.
 # NB. '-Wcast-qual' is nasty, so I omitted it.
-DEF_CFLAGS += -fno-builtin -Wall -Werror -Wredundant-decls -Wno-format -Wno-redundant-decls
+DEF_CFLAGS += -fno-builtin -Wall -Wredundant-decls -Wno-format -Wno-redundant-decls
 DEF_CFLAGS += $(call cc-option,$(CC),-fno-stack-protector,)
 DEF_CFLAGS += $(call cc-option,$(CC),-fgnu89-inline)
 DEF_CFLAGS += -Wstrict-prototypes -Wnested-externs -Wpointer-arith -Winline
diff -Naur xen/tools/Makefile xenb/tools/Makefile
--- xen/tools/Makefile	2013-03-09 10:39:52.246511944 -0700
+++ xenb/tools/Makefile	2013-03-09 10:52:07.286511945 -0700
@@ -67,7 +67,7 @@
 	$(INSTALL_DIR) $(DESTDIR)/var/xen/dump
 	$(INSTALL_DIR) $(DESTDIR)/var/log/xen
 	$(INSTALL_DIR) $(DESTDIR)/var/lib/xen
-	$(INSTALL_DIR) $(DESTDIR)/var/lock/subsys
+	$(INSTALL_DIR) $(DESTDIR)/run/lock/subsys
 
 .PHONY: uninstall
 uninstall: D=$(DESTDIR)
@@ -185,7 +185,7 @@
 		source=.; \
 	fi; \
 	cd qemu-xen-dir; \
-	$$source/configure --enable-xen --target-list=i386-softmmu \
+	$$source/configure --enable-xen --target-list=i386-softmmu,x86_64-softmmu  \
 		--source-path=$$source \
 		--extra-cflags="-I$(XEN_ROOT)/tools/include \
 		-I$(XEN_ROOT)/tools/libxc \
@@ -196,7 +196,18 @@
 		-L$(XEN_ROOT)/tools/xenstore" \
 		--bindir=$(LIBEXEC) \
 		--datadir=$(SHAREDIR)/qemu-xen \
-		--disable-kvm \
+                --disable-werror \
+                --enable-spice \
+                --enable-usb-redir \
+                --enable-guest-agent \
+		--enable-sdl \
+		--enable-linux-aio \
+		--enable-smartcard-nss \
+		--enable-libiscsi \
+                --audio-drv-list=alsa,sdl \
+		--disable-docs \
+                --enable-mixemu \
+                --audio-card-list=ac97,adlib,sb16,hda \
 		--disable-docs \
 		--python=$(PYTHON) \
 		$(IOEMU_CONFIGURE_CROSS); \
diff -Naur xen/tools/Rules.mk xenb/tools/Rules.mk
--- xen/tools/Rules.mk	2013-03-09 10:39:52.246511944 -0700
+++ xenb/tools/Rules.mk	2013-03-09 10:52:07.286511945 -0700
@@ -9,6 +9,8 @@
 export _INSTALL := $(INSTALL)
 INSTALL = $(XEN_ROOT)/tools/cross-install
 
+LDFLAGS_RPATH = -Wl,-rpath,'$${ORIGIN}$(if $(1),/$(1))'
+
 XEN_INCLUDE        = $(XEN_ROOT)/tools/include
 XEN_LIBXC          = $(XEN_ROOT)/tools/libxc
 XEN_XENLIGHT       = $(XEN_ROOT)/tools/libxl
diff -Naur xen/tools/blktap/drivers/blktapctrl.c xenb/tools/blktap/drivers/blktapctrl.c
--- xen/tools/blktap/drivers/blktapctrl.c	2013-03-09 10:39:52.246511944 -0700
+++ xenb/tools/blktap/drivers/blktapctrl.c	2013-03-09 10:52:07.286511945 -0700
@@ -61,7 +61,7 @@
 #include "list.h"
 #include "xs_api.h" /* for xs_fire_next_watch() */
 
-#define PIDFILE "/var/run/blktapctrl.pid"
+#define PIDFILE "/run/blktapctrl.pid"
 
 #define NUM_POLL_FDS 2
 #define MSG_SIZE 4096
diff -Naur xen/tools/blktap/lib/blktaplib.h xenb/tools/blktap/lib/blktaplib.h
--- xen/tools/blktap/lib/blktaplib.h	2013-03-09 10:39:52.259845278 -0700
+++ xenb/tools/blktap/lib/blktaplib.h	2013-03-09 10:52:07.286511945 -0700
@@ -83,7 +83,7 @@
 #define BLKTAP_DEV_DIR   "/dev/xen"
 #define BLKTAP_DEV_NAME  "blktap"
 #define BLKTAP_DEV_MINOR 0
-#define BLKTAP_CTRL_DIR   "/var/run/tap"
+#define BLKTAP_CTRL_DIR   "/run/tap"
 
 extern int blktap_major;
 
diff -Naur xen/tools/blktap2/drivers/Makefile xenb/tools/blktap2/drivers/Makefile
--- xen/tools/blktap2/drivers/Makefile	2013-03-09 10:39:52.263178611 -0700
+++ xenb/tools/blktap2/drivers/Makefile	2013-03-09 10:52:07.286511945 -0700
@@ -9,7 +9,7 @@
 LOCK_UTIL  = lock-util
 INST_DIR   = $(SBINDIR)
 
-CFLAGS    += -Werror -g
+CFLAGS    += -g
 CFLAGS    += -Wno-unused
 CFLAGS    += -fno-strict-aliasing
 CFLAGS    += -I$(BLKTAP_ROOT)/include -I$(BLKTAP_ROOT)/drivers
diff -Naur xen/tools/blktap2/include/blktap2.h xenb/tools/blktap2/include/blktap2.h
--- xen/tools/blktap2/include/blktap2.h	2013-03-09 10:39:52.269845277 -0700
+++ xenb/tools/blktap2/include/blktap2.h	2013-03-09 10:52:07.286511945 -0700
@@ -45,7 +45,7 @@
 
 #define BLKTAP2_SYSFS_DIR              "/sys/class/blktap2"
 #define BLKTAP2_CONTROL_NAME           "blktap-control"
-#define BLKTAP2_CONTROL_DIR            "/var/run/"BLKTAP2_CONTROL_NAME
+#define BLKTAP2_CONTROL_DIR            "/run/"BLKTAP2_CONTROL_NAME
 #define BLKTAP2_CONTROL_SOCKET         "ctl"
 #define BLKTAP2_DIRECTORY              "/dev/xen/blktap-2"
 #define BLKTAP2_CONTROL_DEVICE         BLKTAP2_DIRECTORY"/control"
diff -Naur xen/tools/blktap2/include/blktaplib.h xenb/tools/blktap2/include/blktaplib.h
--- xen/tools/blktap2/include/blktaplib.h	2013-03-09 10:39:52.269845277 -0700
+++ xenb/tools/blktap2/include/blktaplib.h	2013-03-09 10:52:07.289845277 -0700
@@ -81,7 +81,7 @@
 #define BLKTAP_DEV_NAME         "blktap"
 #define BACKDEV_NAME            "backdev"
 #define BLKTAP_DEV_MINOR        0
-#define BLKTAP_CTRL_DIR         "/var/run/tap"
+#define BLKTAP_CTRL_DIR         "/run/tap"
 
 extern int blktap_major;
 
diff -Naur xen/tools/configure xenb/tools/configure
--- xen/tools/configure	2013-03-09 10:39:52.273178611 -0700
+++ xenb/tools/configure	2013-03-09 10:52:07.289845277 -0700
@@ -801,7 +801,7 @@
 datadir='${datarootdir}'
 sysconfdir='${prefix}/etc'
 sharedstatedir='${prefix}/com'
-localstatedir='${prefix}/var'
+localstatedir='${prefix}/run'
 includedir='${prefix}/include'
 oldincludedir='/usr/include'
 docdir='${datarootdir}/doc/${PACKAGE_TARNAME}'
@@ -1345,7 +1345,7 @@
   --libexecdir=DIR        program executables [EPREFIX/libexec]
   --sysconfdir=DIR        read-only single-machine data [PREFIX/etc]
   --sharedstatedir=DIR    modifiable architecture-independent data [PREFIX/com]
-  --localstatedir=DIR     modifiable single-machine data [PREFIX/var]
+  --localstatedir=DIR     modifiable single-machine data [PREFIX/run]
   --libdir=DIR            object code libraries [EPREFIX/lib]
   --includedir=DIR        C header files [PREFIX/include]
   --oldincludedir=DIR     C header files for non-gcc [/usr/include]
diff -Naur xen/tools/console/daemon/main.c xenb/tools/console/daemon/main.c
--- xen/tools/console/daemon/main.c	2013-03-09 10:39:52.273178611 -0700
+++ xenb/tools/console/daemon/main.c	2013-03-09 10:52:07.289845277 -0700
@@ -155,7 +155,7 @@
 	setlogmask(syslog_mask);
 
 	if (!is_interactive) {
-		daemonize(pidfile ? pidfile : "/var/run/xenconsoled.pid");
+		daemonize(pidfile ? pidfile : "/run/xenconsoled.pid");
 	}
 
 	if (!xen_setup())
diff -Naur xen/tools/debugger/gdbsx/Rules.mk xenb/tools/debugger/gdbsx/Rules.mk
--- xen/tools/debugger/gdbsx/Rules.mk	2013-03-09 10:39:52.286511944 -0700
+++ xenb/tools/debugger/gdbsx/Rules.mk	2013-03-09 10:52:07.289845277 -0700
@@ -1,4 +1,4 @@
 include $(XEN_ROOT)/tools/Rules.mk
 
-CFLAGS   += -Werror -Wmissing-prototypes 
+CFLAGS   += -Wmissing-prototypes 
 # (gcc 4.3x and later)   -Wconversion -Wno-sign-conversion
diff -Naur xen/tools/debugger/gdbsx/xg/xg_main.c xenb/tools/debugger/gdbsx/xg/xg_main.c
--- xen/tools/debugger/gdbsx/xg/xg_main.c	2013-03-09 10:39:52.286511944 -0700
+++ xenb/tools/debugger/gdbsx/xg/xg_main.c	2013-03-09 10:52:07.289845277 -0700
@@ -179,7 +179,7 @@
     hypercall.op = __HYPERVISOR_domctl;
     hypercall.arg[0] = (unsigned long)&domctl;
 
-    rc = ioctl(_dom0_fd, IOCTL_PRIVCMD_HYPERCALL, (ulong)&hypercall);
+    rc = ioctl(_dom0_fd, IOCTL_PRIVCMD_HYPERCALL, (unsigned long)&hypercall);
     if (domctlarg && sz)
         munlock(domctlarg, sz);
     return rc;
@@ -219,7 +219,7 @@
     hypercall.arg[0] = (unsigned long)XENVER_capabilities;
     hypercall.arg[1] = (unsigned long)&xen_caps;
 
-    rc = ioctl(_dom0_fd, IOCTL_PRIVCMD_HYPERCALL, (ulong)&hypercall);
+    rc = ioctl(_dom0_fd, IOCTL_PRIVCMD_HYPERCALL, (unsigned long)&hypercall);
     munlock(&xen_caps, sizeof(xen_caps));
     XGTRC("XENCAPS:%s\n", xen_caps);
 
diff -Naur xen/tools/examples/xmexample.hvm xenb/tools/examples/xmexample.hvm
--- xen/tools/examples/xmexample.hvm	2013-03-09 10:39:52.289845277 -0700
+++ xenb/tools/examples/xmexample.hvm	2013-03-09 10:52:07.289845277 -0700
@@ -127,6 +127,15 @@
 # Device Model to be used
 device_model = 'qemu-dm'
 
+# the amount of memory in MiB for the guest
+#actmem=42
+
+# Optional: guest page file
+#xenpaging_file="/var/lib/xen/xenpaging/<domain_name>.<domaind_id>.paging"
+
+# Optional: extra cmdline options for xenpaging
+#xenpaging_extra=[ 'string', 'string' ]
+
 #-----------------------------------------------------------------------------
 # boot on floppy (a), hard disk (c), Network (n) or CD-ROM (d) 
 # default: hard disk, cd-rom, floppy
diff -Naur xen/tools/firmware/etherboot/Config xenb/tools/firmware/etherboot/Config
--- xen/tools/firmware/etherboot/Config	2013-03-09 10:39:52.289845277 -0700
+++ xenb/tools/firmware/etherboot/Config	2013-03-09 10:52:07.293178611 -0700
@@ -1,3 +1,4 @@
+NICS = rtl8139 8086100e eepro100 e1000 pcnet32 10ec8029
 
 CFLAGS += -UPXE_DHCP_STRICT
 CFLAGS += -DPXE_DHCP_STRICT
diff -Naur xen/tools/firmware/hvmloader/acpi/ssdt_s3.asl xenb/tools/firmware/hvmloader/acpi/ssdt_s3.asl
--- xen/tools/firmware/hvmloader/acpi/ssdt_s3.asl	2013-03-09 10:39:52.293178611 -0700
+++ xenb/tools/firmware/hvmloader/acpi/ssdt_s3.asl	2013-03-09 10:52:07.293178611 -0700
@@ -20,13 +20,9 @@
 
 DefinitionBlock ("SSDT_S3.aml", "SSDT", 2, "Xen", "HVM", 0)
 {
-    /* Must match piix emulation */
-    Name (\_S3, Package (0x04)
-    {
-        0x01,  /* PM1a_CNT.SLP_TYP */
-        0x01,  /* PM1b_CNT.SLP_TYP */
-        0x0,   /* reserved */
-        0x0    /* reserved */
-    })
+    /*
+     * Turn off support for s3 sleep state to deal with SVVP tests.
+     * This is what MSFT does on HyperV.
+     */
 }
 
diff -Naur xen/tools/firmware/hvmloader/acpi/ssdt_s4.asl xenb/tools/firmware/hvmloader/acpi/ssdt_s4.asl
--- xen/tools/firmware/hvmloader/acpi/ssdt_s4.asl	2013-03-09 10:39:52.293178611 -0700
+++ xenb/tools/firmware/hvmloader/acpi/ssdt_s4.asl	2013-03-09 10:52:07.293178611 -0700
@@ -20,13 +20,9 @@
 
 DefinitionBlock ("SSDT_S4.aml", "SSDT", 2, "Xen", "HVM", 0)
 {
-    /* Must match piix emulation */
-    Name (\_S4, Package (0x04)
-    {
-        0x00,  /* PM1a_CNT.SLP_TYP */
-        0x00,  /* PM1b_CNT.SLP_TYP */
-        0x00,  /* reserved */
-        0x00   /* reserved */
-    })
+    /*
+     * Turn off support for s4 sleep state to deal with SVVP tests.
+     * This is what MSFT does on HyperV.
+     */
 }
 
diff -Naur xen/tools/firmware/hvmloader/config.h xenb/tools/firmware/hvmloader/config.h
--- xen/tools/firmware/hvmloader/config.h	2013-03-09 10:39:52.293178611 -0700
+++ xenb/tools/firmware/hvmloader/config.h	2013-03-09 10:52:07.293178611 -0700
@@ -5,6 +5,9 @@
 
 enum virtual_vga { VGA_none, VGA_std, VGA_cirrus, VGA_pt };
 extern enum virtual_vga virtual_vga;
+//PARCHE//
+extern uint8_t gfx_bdf;
+//PARCHE_END//
 
 extern unsigned long igd_opregion_pgbase;
 #define IGD_OPREGION_PAGES 3
diff -Naur xen/tools/hotplug/Linux/init.d/sysconfig.xencommons xenb/tools/hotplug/Linux/init.d/sysconfig.xencommons
--- xen/tools/hotplug/Linux/init.d/sysconfig.xencommons	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/init.d/sysconfig.xencommons	2013-03-09 10:52:07.293178611 -0700
@@ -8,7 +8,7 @@
 #XENSTORED_TRACE=[yes|on|1]
 
 # Running xenstored on XENSTORED_ROOTDIR
-#XENSTORED_ROOTDIR=/var/lib/xenstored
+XENSTORED_ROOTDIR=/var/lib/xenstored
 
 # Running xenbackendd in debug mode
 #XENBACKENDD_DEBUG=[yes|on|1]
diff -Naur xen/tools/hotplug/Linux/init.d/xen-watchdog xenb/tools/hotplug/Linux/init.d/xen-watchdog
--- xen/tools/hotplug/Linux/init.d/xen-watchdog	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/init.d/xen-watchdog	2013-03-09 10:52:07.293178611 -0700
@@ -17,49 +17,32 @@
 ### END INIT INFO
 #
 
+. /etc/rc.conf
+. /etc/rc.d/functions
+
 DAEMON=/usr/sbin/xenwatchdogd
 base=$(basename $DAEMON)
+initname="xen-watchdog"
 
-# Source function library.
-if [ -e  /etc/init.d/functions ] ; then
-    . /etc/init.d/functions
-elif [ -e /lib/lsb/init-functions ] ; then
-    . /lib/lsb/init-functions
-    success () {
-        log_success_msg $*
-    }
-    failure () {
-        log_failure_msg $*
-    }
-else
-    success () {
-        echo $*
-    }
-    failure () {
-        echo $*
-    }
-fi
 
 start() {
 	local r
-	echo -n $"Starting domain watchdog daemon: "
+	stat_busy "Starting domain watchdog daemon"
 
 	$DAEMON 30 15
 	r=$?
-	[ "$r" -eq 0 ] && success $"$base startup" || failure $"$base startup"
-	echo
+	[ "$r" -eq 0 ] && stat_done ; add_daemon $initname || stat_fail
 
 	return $r
 }
 
 stop() {
 	local r
-	echo -n $"Stopping domain watchdog daemon: "
+	stat_busy "Stopping domain watchdog daemon"
 
 	killall -USR1 $base 2>/dev/null
 	r=$?
-	[ "$r" -eq 0 ] && success $"$base stop" || failure $"$base stop"
-	echo
+	[ "$r" -eq 0 ] && stat_done ; rm_daemon $initname || stat_fail
 
 	return $r
 }
diff -Naur xen/tools/hotplug/Linux/init.d/xencommons xenb/tools/hotplug/Linux/init.d/xencommons
--- xen/tools/hotplug/Linux/init.d/xencommons	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/init.d/xencommons	2013-03-09 10:52:07.709845277 -0700
@@ -18,6 +18,9 @@
 # Description:       Starts and stops the daemons neeeded for xl/xend
 ### END INIT INFO
 
+. /etc/rc.conf
+. /etc/rc.d/functions
+
 if [ -d /etc/sysconfig ]; then
 	xencommons_config=/etc/sysconfig
 else
@@ -26,8 +29,8 @@
 
 test -f $xencommons_config/xencommons && . $xencommons_config/xencommons
 
-XENCONSOLED_PIDFILE=/var/run/xenconsoled.pid
-QEMU_PIDFILE=/var/run/qemu-dom0.pid
+XENCONSOLED_PIDFILE=/run/xenconsoled.pid
+QEMU_PIDFILE=/run/qemu-dom0.pid
 shopt -s extglob
 
 # not running in Xen dom0 or domU
@@ -55,22 +58,27 @@
         local time=0
 	local timeout=30
 
-	modprobe xen-evtchn 2>/dev/null
-	modprobe xen-gntdev 2>/dev/null
-	modprobe xen-gntalloc 2>/dev/null
-	modprobe xen-blkback 2>/dev/null
-	modprobe xen-netback 2>/dev/null
-	modprobe xen-pciback 2>/dev/null
-	modprobe evtchn 2>/dev/null
-	modprobe gntdev 2>/dev/null
-	modprobe netbk 2>/dev/null
-	modprobe blkbk 2>/dev/null
-	modprobe xen-scsibk 2>/dev/null
-	modprobe usbbk 2>/dev/null
-	modprobe pciback 2>/dev/null
-	modprobe xen-acpi-processor 2>/dev/null
-	modprobe blktap2 2>/dev/null || modprobe blktap 2>/dev/null
-	mkdir -p /var/run/xen
+	#modprobe xen-evtchn 2>/dev/null
+	#modprobe xen-gntdev 2>/dev/null
+	#modprobe xen-gntalloc 2>/dev/null
+	#modprobe xen-blkback 2>/dev/null
+	#modprobe xen-netback 2>/dev/null
+	#modprobe xen-pciback 2>/dev/null
+	modprobe evtchn 2>/dev/null || true
+	modprobe gntdev 2>/dev/null || true
+	modprobe gntalloc 2>/dev/null || true
+	modprobe netbk 2>/dev/null || true
+	modprobe blkbk 2>/dev/null || true
+	modprobe xen-scsibk 2>/dev/null || true
+	modprobe usbbk 2>/dev/null || true
+	modprobe pciback 2>/dev/null || true
+	modprobe xen-acpi-processor 2>/dev/null || true
+	modprobe blktap2 2>/dev/null || modprobe blktap 2>/dev/null || true
+	# xenblk (frontend module) is needed in dom0, allowing it to use vbds
+	modprobe xenblk 2>/dev/null || true
+	# support xl create pv guest with qcow/qcow2 disk image
+	modprobe nbd max_part=8 2>/dev/null || true
+	mkdir -p /run/xen
 
 	if ! `xenstore-read -s / >/dev/null 2>&1`
 	then
@@ -80,13 +88,14 @@
 
 		if [ -n "$XENSTORED" ] ; then
 		    echo -n Starting $XENSTORED...
-		    $XENSTORED --pid-file /var/run/xenstored.pid $XENSTORED_ARGS
+                    mkdir -p /run/xenstored
+		    $XENSTORED --pid-file /run/xenstored.pid $XENSTORED_ARGS
 		elif [ -x /usr/sbin/oxenstored ] ; then
 		    echo -n Starting oxenstored...
-		    /usr/sbin/oxenstored --pid-file /var/run/xenstored.pid $XENSTORED_ARGS
+		    /usr/sbin/oxenstored --pid-file /run/xenstored.pid $XENSTORED_ARGS
 		elif [ -x /usr/sbin/xenstored ] ; then
 		    echo -n Starting C xenstored...
-		    /usr/sbin/xenstored --pid-file /var/run/xenstored.pid $XENSTORED_ARGS
+		    /usr/sbin/xenstored --pid-file /run/xenstored.pid $XENSTORED_ARGS
 		else
 		    echo "No xenstored found"
 		    exit 1
@@ -102,15 +111,16 @@
 
 		# Exit if we timed out
 		if ! [ $time -lt $timeout ] ; then
-		    echo Could not start xenstored
+		    stat_fail
 		    exit 1
 		fi
-
-		echo Setting domain 0 name...
+                 stat_done
+		stat_busy "Setting domain 0 name..."
 		xenstore-write "/local/domain/0/name" "Domain-0"
+                stat_done
 	fi
-
-	echo Starting xenconsoled...
+       
+	stat_busy "Starting xenconsoled"
 	test -z "$XENCONSOLED_TRACE" || XENCONSOLED_ARGS=" --log=$XENCONSOLED_TRACE"
 	xenconsoled --pid-file=$XENCONSOLED_PIDFILE $XENCONSOLED_ARGS
 	test -z "$XENBACKENDD_DEBUG" || XENBACKENDD_ARGS="-d"
diff -Naur xen/tools/hotplug/Linux/init.d/xend xenb/tools/hotplug/Linux/init.d/xend
--- xen/tools/hotplug/Linux/init.d/xend	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/init.d/xend	2013-03-09 10:52:07.749845277 -0700
@@ -1,76 +1,136 @@
 #!/bin/bash
 #
-# xend		Script to start and stop the Xen control daemon.
+# xend		Starts and stops the Xen management daemon
 #
-# Author:       Keir Fraser <keir.fraser@cl.cam.ac.uk>
+# chkconfig: 35 98 01
+# description: Starts and stops the Xen management daemon
 #
-# chkconfig: 2345 98 01
-# description: Starts and stops the Xen control daemon.
 ### BEGIN INIT INFO
 # Provides:          xend
-# Required-Start:    $syslog $remote_fs xenstored xenconsoled 
-# Should-Start:
-# Required-Stop:     $syslog $remote_fs xenstored xenconsoled 
-# Should-Stop:
-# Default-Start:     2 3 5
-# Default-Stop:      0 1 6
-# Short-Description: Start/stop xend
-# Description:       Starts and stops the Xen control daemon.
+# Required-Start:    $syslog $network $remote_fs
+# Should-Start:      iscsi $time
+# Required-Stop:     $syslog $network $remote_fs
+# Should-Stop:       iscsi $time
+# Default-Start:     3 5
+# Default-Stop:      0 1 2 6
+# Short-Description: Starts and stops the Xen management daemon
+# Description:       Starts and stops the Xen management daemon.  xend is needed
+#                    to create and manage VMs on Xen.
 ### END INIT INFO
 
-shopt -s extglob
+. /etc/rc.status
+rc_reset
 
-# Wait for Xend to be up
-function await_daemons_up
+XEND=`pidof -x /usr/sbin/xend`
+
+await_daemons_up()
 {
 	i=1
 	rets=10
 	xend status
 	while [ $? -ne 0 -a $i -lt $rets ]; do
-	    sleep 1
-	    echo -n .
-	    i=$(($i + 1))
-	    xend status
+		sleep 1
+		echo -n .
+		i=$(($i + 1))
+		xend status
 	done
 }
 
+xend_abort()
+{
+	echo -n "xend "
+	rc_failed $1
+	rc_status -v
+	rc_exit
+}
+
+cleanup()
+{
+	rm -f /var/lib/xen/tmp/* 2>/dev/null
+	rm -f /var/lib/xen/xenbl* 2>/dev/null
+}
+
+check()
+{
+	if [ "$1" == status ]; then
+		if [ ! -e /proc/xen/capabilities ]; then
+			xend_abort 3
+		fi
+	else
+		if [ `id -u` != 0 ]; then
+			xend_abort 4
+		fi
+		if [ ! -e /proc/xen/capabilities ] ||
+		     ! grep control_d /proc/xen/capabilities >/dev/null 2>&1; then
+			if [ "$1" == stop ] ||
+			   [ "$1" == try-restart ]; then
+				xend_abort 0
+			else
+				xend_abort 6
+			fi
+		fi
+	fi
+}
+
 case "$1" in
   start)
-	if [ -z "`ps -C xenconsoled -o pid=`" ]; then
-		echo "xencommons should be started first."
-		exit 1
-	fi
-	# mkdir shouldn't be needed as most distros have this already created. Default to using subsys.
-	# See docs/misc/distro_mapping.txt
-	mkdir -p /var/lock
-	if [ -d /var/lock/subsys ] ; then
-		touch /var/lock/subsys/xend
+	check $1
+	echo -n "Starting xend "
+	if [ ! -z "$XEND" ]; then
+		echo -n "(already running pid $XEND) "
 	else
-		touch /var/lock/xend
+		cleanup
 	fi
 	xend start
 	await_daemons_up
 	;;
   stop)
-	xend stop
-	rm -f /var/lock/subsys/xend /var/lock/xend
+	check $1
+	echo -n "Stopping xend "
+	if [ -z "$XEND" ]; then
+		echo -n "(not running) "
+		xend stop
+		rc_reset
+	else
+		echo -n "(pid $XEND) "
+		xend stop
+		cleanup
+		rc_reset
+	fi
 	;;
   status)
-	xend status
+	check $1
+	echo -n "Checking status of xend "
+	if [ ! -z "$XEND" ]; then
+		echo -n "(pid $XEND) "
+	fi
+	checkproc /usr/sbin/xend
 	;;
-  reload)
-        xend reload
-        ;;
-  restart|force-reload)
+  restart|reload)
+	check $1
+	echo -n "Restarting xend "
+	if [ -z "$XEND" ]; then
+		echo -n "(not running) "
+	else
+		echo -n "(old pid $XEND) "
+	fi
 	xend restart
 	await_daemons_up
 	;;
+  try-restart)
+	check $1
+	$0 status
+	if [ $? = 0 ]; then
+		$0 restart
+	else
+		rc_reset
+	fi
+	;;
   *)
-	# do not advertise unreasonable commands that there is no reason
-	# to use with this device
-	echo $"Usage: $0 {start|stop|status|restart|reload|force-reload}"
-	exit 1
+	echo "Usage: $0 {start|stop|restart|try-restart|reload|status}"
+	rc_failed 2
+	rc_exit
 esac
 
-exit $?
-
+rc_status -v
+rc_exit
diff -Naur xen/tools/hotplug/Linux/init.d/xendomains xenb/tools/hotplug/Linux/init.d/xendomains
--- xen/tools/hotplug/Linux/init.d/xendomains	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/init.d/xendomains	2013-03-09 10:52:07.753178611 -0700
@@ -1,60 +1,38 @@
 #!/bin/bash
 #
-# /etc/init.d/xendomains
-# Start / stop domains automatically when domain 0 boots / shuts down.
+# xendomains	Starts and stops Xen VMs
 #
-# chkconfig: 345 99 00
-# description: Start / stop Xen domains.
-#
-# This script offers fairly basic functionality.  It should work on Redhat
-# but also on LSB-compliant SuSE releases and on Debian with the LSB package
-# installed.  (LSB is the Linux Standard Base)
-#
-# Based on the example in the "Designing High Quality Integrated Linux
-# Applications HOWTO" by Avi Alkalay
-# <http://www.tldp.org/HOWTO/HighQuality-Apps-HOWTO/>
+# chkconfig: 35 99 00
+# description: Starts and stops Xen VMs
 #
 ### BEGIN INIT INFO
 # Provides:          xendomains
 # Required-Start:    $syslog $remote_fs xenstored xenconsoled
-# Should-Start:      xend
+# Should-Start:      xend iscsi o2cb ocfs2
 # Required-Stop:     $syslog $remote_fs xenstored xenconsoled
-# Should-Stop:       xend
-# Default-Start:     2 3 5
-# Default-Stop:      0 1 6
-# Short-Description: Start/stop secondary xen domains
-# Description:       Start / stop domains automatically when domain 0 
-#                    boots / shuts down.
+# Should-Stop:       xend iscsi
+# Default-Start:     3 5
+# Default-Stop:      0 1 2 6
+# Short-Description: Starts and stops Xen VMs
+# Description:       Starts and stops Xen VMs automatically when the
+#                    host starts and stops.
 ### END INIT INFO
 
-CMD=xm
-$CMD list &> /dev/null
-if test $? -ne 0
-then
-	CMD=xl
-fi
-
-$CMD list &> /dev/null
-if test $? -ne 0
-then
-	exit 0;
-fi
+. /etc/rc.status
+rc_reset
 
-# Correct exit code would probably be 5, but it's enough 
-# if xend complains if we're not running as privileged domain
-if ! [ -e /proc/xen/privcmd ]; then
-	exit 0
-fi
+RETCODE_FILE=/tmp/xendomains.rc.$$
+xm_cmd=echo
 
 # See docs/misc/distro_mapping.txt
-if [ -d /var/lock/subsys ]; then
-	LOCKFILE=/var/lock/subsys/xendomains
+if [ -d /run/lock/subsys ]; then
+	LOCKFILE=/run/lock/subsys/xendomains
 else
-	LOCKFILE=/var/lock/xendomains
+	LOCKFILE=/run/lock/xendomains
 fi
 
-if [ -d /etc/sysconfig ]; then
-	XENDOM_CONFIG=/etc/sysconfig/xendomains
+if [ -d /etc/conf.d ]; then
+	XENDOM_CONFIG=/etc/conf.d/xendomains
 else
 	XENDOM_CONFIG=/etc/default/xendomains
 fi
@@ -63,518 +41,470 @@
 	if [ "$1" = "stop" ]; then exit 0;
 	else exit 6; fi; }
 
-. $XENDOM_CONFIG
+. "$XENDOM_CONFIG"
+
+shopt -s dotglob nullglob
 
-# Use the SUSE rc_ init script functions;
-# emulate them on LSB, RH and other systems
-if test -e /etc/rc.status; then
-    # SUSE rc script library
-    . /etc/rc.status
-else    
-    _cmd=$1
-    declare -a _SMSG
-    if test "${_cmd}" = "status"; then
-	_SMSG=(running dead dead unused unknown)
-	_RC_UNUSED=3
-    else
-	_SMSG=(done failed failed missed failed skipped unused failed failed)
-	_RC_UNUSED=6
-    fi
-    if test -e /etc/init.d/functions; then
-	# REDHAT
-	. /etc/init.d/functions
-	echo_rc()
+smart_term=1
+if [ -z "$esc" ]; then
+	smart_term=0
+	rc_timer_on()
 	{
-	    #echo -n "  [${_SMSG[${_RC_RV}]}] "
-	    if test ${_RC_RV} = 0; then
-		success "  [${_SMSG[${_RC_RV}]}] "
-	    else
-		failure "  [${_SMSG[${_RC_RV}]}] "
-	    fi
+		(trap "exit 0" TERM; sleep $1) & _rc_timer_pid=$!
 	}
-    elif test -e /lib/lsb/init-functions; then
-	# LSB    
-    	. /lib/lsb/init-functions
-        if alias log_success_msg >/dev/null 2>/dev/null; then
-	  echo_rc()
-	  {
-	       echo "  [${_SMSG[${_RC_RV}]}] "
-	  }
-        else
-	  echo_rc()
-	  {
-	    if test ${_RC_RV} = 0; then
-		log_success_msg "  [${_SMSG[${_RC_RV}]}] "
-	    else
-		log_failure_msg "  [${_SMSG[${_RC_RV}]}] "
-	    fi
-	  }
-        fi
-    else    
-	# emulate it
-	echo_rc()
+	rc_timer_off()
 	{
-	    echo "  [${_SMSG[${_RC_RV}]}] "
+		if [ -n "$_rc_timer_pid" ]; then
+			kill -TERM $_rc_timer_pid > /dev/null 2>&1
+		fi
+		unset _rc_timer_pid
 	}
-    fi
-    rc_reset() { _RC_RV=0; }
-    rc_failed()
-    {
-	if test -z "$1"; then 
-	    _RC_RV=1;
-	elif test "$1" != "0"; then 
-	    _RC_RV=$1; 
-    	fi
-	return ${_RC_RV}
-    }
-    rc_check()
-    {
-	return rc_failed $?
-    }	
-    rc_status()
-    {
-	rc_failed $?
-	if test "$1" = "-r"; then _RC_RV=0; shift; fi
-	if test "$1" = "-s"; then rc_failed 5; echo_rc; rc_failed 3; shift; fi
-	if test "$1" = "-u"; then rc_failed ${_RC_UNUSED}; echo_rc; rc_failed 3; shift; fi
-	if test "$1" = "-v"; then echo_rc; shift; fi
-	if test "$1" = "-r"; then _RC_RV=0; shift; fi
-	return ${_RC_RV}
-    }
-    rc_exit() { exit ${_RC_RV}; }
-    rc_active() 
-    {
-	if test -z "$RUNLEVEL"; then read RUNLEVEL REST < <(/sbin/runlevel); fi
-	if test -e /etc/init.d/S[0-9][0-9]${1}; then return 0; fi
-	return 1
-    }
-fi
-
-if ! which usleep >&/dev/null
-then
-  usleep()
-  {
-    if [ -n "$1" ]
-    then
-      sleep $(( $1 / 1000000 ))
-    fi
-  }
 fi
 
-# Reset status of this service
-rc_reset
+xendomains_abort()
+{
+	echo -n "xendomains "
+	rc_failed $1
+	rc_status -v
+	rc_exit
+}
 
-##
-# Returns 0 (success) if the given parameter names a directory, and that
-# directory is not empty.
-#
-contains_something()
+check()
 {
-  if [ -d "$1" ] && [ `/bin/ls $1 | wc -l` -gt 0 ]
-  then
-    return 0
-  else
-    return 1
-  fi
-}
-
-# read name from xen config file
-rdname()
-{
-    NM=$($CMD create --quiet --dryrun --defconfig "$1" |
-         sed -n 's/^.*(name \(.*\))$/\1/p')
-}
-
-rdnames()
-{
-    NAMES=
-    if ! contains_something "$XENDOMAINS_AUTO"
-    then 
-	return
-    fi
-    for dom in $XENDOMAINS_AUTO/*; do
-	rdname $dom
-	if test -z $NAMES; then 
-	    NAMES=$NM; 
+	XEND=`pidof -x /usr/sbin/xend`
+	if [ -z "$XEND" ]; then
+		xm_cmd="xl -f"
+		XEND="xl"
+	else
+		xm_cmd="xm"
+	fi
+	if [ "$1" = status ]; then
+		if [ ! -e /proc/xen/capabilities ] || [ ! -r "$XENDOM_CONFIG" ] || [ -z "$XEND" ]; then
+			xendomains_abort 3
+		fi
 	else
-	    NAMES="$NAMES|$NM"
+		if [ `id -u` != 0 ]; then
+			xendomains_abort 4
+		fi
+		if [ ! -e /proc/xen/capabilities ] || [ -z "$XEND" ] ||
+		     ! grep control_d /proc/xen/capabilities >/dev/null 2>&1; then
+			if [ "$1" = stop ] ||
+			   [ "$1" = restart ]; then
+				xendomains_abort 0
+			else
+				xendomains_abort 6
+			fi
+		fi
+		if [ ! -r "$XENDOM_CONFIG" ]; then
+			xendomains_abort 6
+		fi
 	fi
-    done
 }
 
-LIST_GREP='((domain\|(domid\|(name\|^{$\|"name":\|"domid":'
+dir_contains_something()
+{
+        [ -d "$1" ] || return 1
+	local dirfiles=( "$1"/* )
+	[ ${#dirfiles[@]} != 0 ]
+}
+
+get_name_from_cfg()
+{
+	if grep -q "^name" "$1";then
+		NM=`grep '^name[	 ]*=' "$1" | sed -e 's/^name[	 ]*=[	 ]*['\''"]\([^'\''"]*\)['\''"].*$/\1/'`
+	elif grep -q "(name " "$1";then
+		NM=`grep '(name ' "$1" | sed -e 's/^ *//' | cut -d " " -f 2 | sed -e 's/)//'`
+	fi
+}
+
+running_auto_names()
+{
+	unset AUTONAMES[@]
+	if ! dir_contains_something "$XENDOMAINS_AUTO"; then
+		return
+	fi
+	for dom in "$XENDOMAINS_AUTO"/*; do
+		get_name_from_cfg "$dom"
+		AUTONAMES+=("$NM")
+	done
+}
+
 parseln()
 {
-    if [[ "$1" =~ '(domain' ]] || [[ "$1" = "{" ]]; then
-        name=;id=
-    elif [[ "$1" =~ '(name' ]]; then
-        name=$(echo $1 | sed -e 's/^.*(name \(.*\))$/\1/')
-    elif [[ "$1" =~ '(domid' ]]; then
-        id=$(echo $1 | sed -e 's/^.*(domid \(.*\))$/\1/')
-    elif [[ "$1" =~ '"name":' ]]; then
-        name=$(echo $1 | sed -e 's/^.*"name": "\(.*\)",$/\1/')
-    elif [[ "$1" =~ '"domid":' ]]; then
-        id=$(echo $1 | sed -e 's/^.*"domid": \(.*\),$/\1/')
-    fi
-
-    [ -n "$name" -a -n "$id" ] && return 0 || return 1
-}
-
-is_running()
-{
-    rdname $1
-    RC=1
-    name=;id=
-    while read LN; do
-	parseln "$LN" || continue
-	if test $id = 0; then continue; fi
-	case $name in 
-	    ($NM)
-		RC=0
-		;;
-	esac
-    done < <($CMD list -l | grep $LIST_GREP)
-    return $RC
-}
-
-start() 
-{
-    if [ -f $LOCKFILE ]; then 
-	echo -e "xendomains already running (lockfile exists)"
-	return; 
-    fi
-
-    saved_domains=" "
-    if [ "$XENDOMAINS_RESTORE" = "true" ] &&
-       contains_something "$XENDOMAINS_SAVE"
-    then
-	mkdir -p $(dirname "$LOCKFILE")
-	touch $LOCKFILE
-	echo -n "Restoring Xen domains:"
-	saved_domains=`ls $XENDOMAINS_SAVE`
-        for dom in $XENDOMAINS_SAVE/*; do
-            if [ -f $dom ] ; then
-                HEADER=`head -c 16 $dom | head -n 1 2> /dev/null`
-                if [ $HEADER = "LinuxGuestRecord" ]; then
-                    echo -n " ${dom##*/}"
-                    XMR=`$CMD restore $dom 2>&1 1>/dev/null`
-                    #$CMD restore $dom
-                    if [ $? -ne 0 ]; then
-                        echo -e "\nAn error occurred while restoring domain ${dom##*/}:\n$XMR"
-                        rc_failed $?
-                        echo -e '!'
-                    else
-                        # mv $dom ${dom%/*}/.${dom##*/}
-                        rm $dom
-                    fi
-                fi
-            fi
-        done
-	echo -e
-    fi
-
-    if contains_something "$XENDOMAINS_AUTO"
-    then
-	touch $LOCKFILE
-	echo -n "Starting auto Xen domains:"
-	# We expect config scripts for auto starting domains to be in
-	# XENDOMAINS_AUTO - they could just be symlinks to files elsewhere
-
-	# Create all domains with config files in XENDOMAINS_AUTO.
-	# TODO: We should record which domain name belongs 
-	# so we have the option to selectively shut down / migrate later
-	# If a domain statefile from $XENDOMAINS_SAVE matches a domain name
-	# in $XENDOMAINS_AUTO, do not try to start that domain; if it didn't 
-	# restore correctly it requires administrative attention.
-	for dom in $XENDOMAINS_AUTO/*; do
-	    echo -n " ${dom##*/}"
-	    shortdom=$(echo $dom | sed -n 's/^.*\/\(.*\)$/\1/p')
-	    echo $saved_domains | grep -w $shortdom > /dev/null
-	    if [ $? -eq 0 ] || is_running $dom; then
-		echo -n "(skip)"
-	    else
-		XMC=`$CMD create --quiet --defconfig $dom`
-		if [ $? -ne 0 ]; then
-		    echo -e "\nAn error occurred while creating domain ${dom##*/}: $XMC\n"
-		    rc_failed $?
-		    echo -e '!'
-		else
-		    usleep $XENDOMAINS_CREATE_USLEEP
+	name=${1:0:$((${#1}-36))}
+	name=${name%% *}
+	rest="${1: -36}"
+	id=${rest:0:4}
+	id=`echo $id`
+	mem=${rest:4:6}
+	mem=`echo $mem`
+	vcpu=${rest:10:6}
+	vcpu=`echo $vcpu`
+	state=${rest:16:11}
+	state=`echo $state`
+	tm=${rest:27}
+	tm=`echo $tm`
+}
+
+xm_list()
+{
+	TERM=vt100 ${xm_cmd} list | grep -v '^Name *ID'
+}
+
+is_cfg_running()
+{
+	get_name_from_cfg "$1"
+	while read LN; do
+		parseln "$LN"
+		[ "$id" = 0 ] && continue
+		if [ "$name" = "$NM" ]; then
+			[ -z "$state" ] && return 1
+			return 0
 		fi
-	    fi
-	done
-    fi
+	done < <(xm_list)
+	return 1
+}
+
+start()
+{
+	if [ -f "$LOCKFILE" ]; then
+		echo -n "xendomains already running (lockfile exists)"
+		rc_reset
+		rc_status -v
+		return 0
+	fi
+
+	local printed=0
+
+	if [ "$XENDOMAINS_RESTORE" = "true" ] &&
+	   dir_contains_something "$XENDOMAINS_SAVE"; then
+		mkdir -p $(dirname "$LOCKFILE")
+		touch "$LOCKFILE"
+		echo "Restoring saved Xen domains"
+		printed=1
+		for dom in "$XENDOMAINS_SAVE"/*; do
+			echo -n "	${dom##*/}: "
+			${xm_cmd} restore "$dom" >/dev/null 2>&1
+			if [ $? -ne 0 ]; then
+				rc_failed
+			else
+				rc_reset
+				rm -f "$dom"
+			fi
+			rc_status -v
+		done
+	fi
+
+	if dir_contains_something "$XENDOMAINS_AUTO"; then
+		touch "$LOCKFILE"
+		echo "Starting auto Xen domains"
+		printed=1
+		for dom in "$XENDOMAINS_AUTO"/*; do
+			echo -n "	${dom##*/}: "
+			if is_cfg_running "$dom"; then
+				rc_status -s
+			else
+				if grep -q "^name" "$dom";then
+					${xm_cmd} create --quiet --defconfig "$dom"
+				elif grep -q "(name .*" "$dom";then
+					${xm_cmd} create --quiet --config "$dom"
+				fi
+				if [ $? -ne 0 ]; then
+				    rc_failed
+				else
+				    usleep $XENDOMAINS_CREATE_USLEEP
+				    rc_reset
+				fi
+				rc_status -v
+			fi
+		done
+	fi
+
+	if [ $printed -eq 0 ]; then
+		echo -n "Starting xendomains"
+		rc_failed 6  # not configured
+		rc_status -v
+	fi
+}
+
+is_zombie_state()
+{
+	[ "$1" = "-b---d" ] || [ "$1" = "-----d" ]
+}
+
+any_non_zombies()
+{
+	while read LN; do
+		parseln "$LN"
+		[ "$id" = 0 ] && continue
+		[ -z "$state" ] && continue
+		is_zombie_state "$state" || return 0
+	done < <(xm_list)
+	return 1
 }
 
-all_zombies()
+migrate_with_watchdog()
 {
-    name=;id=
-    while read LN; do
-	parseln "$LN" || continue
-	if test $id = 0; then continue; fi
-	if test "$state" != "-b---d" -a "$state" != "-----d"; then
-	    return 1;
-	fi
-    done < <($CMD list -l | grep $LIST_GREP)
-    return 0
-}
-
-# Wait for max $XENDOMAINS_STOP_MAXWAIT for $CMD $1 to finish;
-# if it has not exited by that time kill it, so the init script will
-# succeed within a finite amount of time; if $2 is nonnull, it will
-# kill the command as well as soon as no domain (except for zombies)
-# are left (used for shutdown --all). Third parameter, if any, suppresses
-# output of dots per working state (formatting issues)
-watchdog_xencmd()
-{
-    if test -z "$XENDOMAINS_STOP_MAXWAIT" -o "$XENDOMAINS_STOP_MAXWAIT" = "0"; then
-	exit
-    fi
-
-    usleep 20000
-    for no in `seq 0 $XENDOMAINS_STOP_MAXWAIT`; do
-	# exit if $CMD save/migrate/shutdown is finished
-	PSAX=`ps axlw | grep "$CMD $1" | grep -v grep`
-	if test -z "$PSAX"; then exit; fi
-	if ! test -n "$3"; then echo -n '.'; fi
-	sleep 1
-	# go to kill immediately if there's only zombies left
-	if all_zombies && test -n "$2"; then break; fi
-    done
-    sleep 1
-    read PSF PSUID PSPID PSPPID < <(echo "$PSAX")
-    # kill $CMD $1
-    kill $PSPID >/dev/null 2>&1
-    
-    echo -e .
+	(${xm_cmd} migrate "$@" ; echo $? > "$RETCODE_FILE") >/dev/null 2>&1 &
+	watchdog_xm $!
+}
+
+save_with_watchdog()
+{
+	(${xm_cmd} save "$@" ; echo $? > "$RETCODE_FILE") >/dev/null 2>&1 &
+	watchdog_xm $!
+}
+
+shutdown_with_watchdog()
+{
+	(${xm_cmd} shutdown -w "$@" ; echo $? > "$RETCODE_FILE") >/dev/null 2>&1 &
+	watchdog_xm $!
+}
+
+get_return_code()
+{
+	local RC=127
+	[ -r "$RETCODE_FILE" ] && RC=`head -c10 "$RETCODE_FILE"`
+	rm -f "$RETCODE_FILE"
+	return $RC
+}
+
+#  $1:  The PID to wait on.
+watchdog_xm()
+{
+	local col=$((COLUMNS-11))
+	if [ -z "$XENDOMAINS_STOP_MAXWAIT" ] || [ "$XENDOMAINS_STOP_MAXWAIT" = "0" ]; then
+		wait $1 >/dev/null 2>&1
+		get_return_code
+		return
+	fi
+
+	rc_timer_on $XENDOMAINS_STOP_MAXWAIT $col
+	while true; do
+		# Prefer "jobs" over "ps":  faster and no false positives
+		pid=`jobs -l | grep " $1 Running"`
+		if [ -z "$pid" ]; then
+			break
+		fi
+		pid=`jobs -l | grep " $_rc_timer_pid Running"`
+		if [ -z "$pid" ]; then
+			disown $1  # To avoid the "Terminated..." message
+			kill $1 >/dev/null 2>&1
+		fi
+		sleep 1
+	done
+	rc_timer_off
+	if [ $smart_term -ne 0 ]; then
+		echo -en "\015${esc}[${col}C      "
+	fi
+	get_return_code
 }
 
 stop()
 {
-    exec 3>&2 2> /dev/null
-    
-    # Collect list of domains to shut down
-    if test "$XENDOMAINS_AUTO_ONLY" = "true"; then
-	rdnames
-    fi
-    echo -n "Shutting down Xen domains:"
-    name=;id=
-    while read LN; do
-	parseln "$LN" || continue
-	if test $id = 0; then continue; fi
-	echo -n " $name"
-	if test "$XENDOMAINS_AUTO_ONLY" = "true"; then
-	    eval "
-	    case \"\$name\" in
-		($NAMES)
-		    # nothing
-		    ;;
-		(*)
-		    echo -e '(skip)'
-		    continue
-		    ;;
-	    esac
-	    "
-	fi
-	# XENDOMAINS_SYSRQ chould be something like just "s" 
-	# or "s e i u" or even "s e s i u o"
-	# for the latter, you should set XENDOMAINS_USLEEP to 1200000 or so
-	if test -n "$XENDOMAINS_SYSRQ"; then
-	    for sysrq in $XENDOMAINS_SYSRQ; do
-		echo -n "(SR-$sysrq)"
-		XMR=`$CMD sysrq $id $sysrq 2>&1 1>/dev/null`
-		if test $? -ne 0; then
-		    echo -e "\nAn error occurred while doing sysrq on domain:\n$XMR\n"
-		    rc_failed $?
-		    echo -n '!'
-		fi
-		# usleep just ignores empty arg
-		usleep $XENDOMAINS_USLEEP
-	    done
-	fi
-	if test "$state" = "-b---d" -o "$state" = "-----d"; then
-	    echo -n "(zomb)"
-	    continue
-	fi
-	if test -n "$XENDOMAINS_MIGRATE"; then
-	    echo -n "(migr)"
-	    watchdog_xencmd migrate &
-	    WDOG_PID=$!
-	    XMR=`$CMD migrate $id $XENDOMAINS_MIGRATE 2>&1 1>/dev/null`
-	    if test $? -ne 0; then
-		echo -e "\nAn error occurred while migrating domain:\n$XMR\n"
-		rc_failed $?
-		echo -e '!'
-
-		kill $WDOG_PID >/dev/null 2>&1
-	    else
-		kill $WDOG_PID >/dev/null 2>&1
-		
-		echo -e .
-		usleep 1000
-		continue
-	    fi
-	fi
-	if test -n "$XENDOMAINS_SAVE"; then
-	    echo -n "(save)"
-	    watchdog_xencmd save &
-	    WDOG_PID=$!
-	    mkdir -p "$XENDOMAINS_SAVE"
-	    XMR=`$CMD save $id $XENDOMAINS_SAVE/$name 2>&1 1>/dev/null`
-	    if test $? -ne 0; then
-		echo -e "\nAn error occurred while saving domain:\n$XMR\n"
-		rc_failed $?
-		echo -e '!'
-		kill $WDOG_PID >/dev/null 2>&1
-	    else
-		kill $WDOG_PID >/dev/null 2>&1
-		echo -e .
-		usleep 1000
-		continue
-	    fi
-	fi
-	if test -n "$XENDOMAINS_SHUTDOWN"; then
-	    # XENDOMAINS_SHUTDOWN should be "--wait"
-	    echo -n "(shut)"
-	    watchdog_xencmd shutdown &
-	    WDOG_PID=$!
-	    XMR=`$CMD shutdown $XENDOMAINS_SHUTDOWN $id 2>&1 1>/dev/null`
-	    if test $? -ne 0; then
-		echo -e "\nAn error occurred while shutting down domain:\n$XMR\n"
-		rc_failed $?
-		echo -e '!'
-	    fi
-	    kill $WDOG_PID >/dev/null 2>&1
-	fi
-    done < <($CMD list -l | grep $LIST_GREP)
-
-    # NB. this shuts down ALL Xen domains (politely), not just the ones in
-    # AUTODIR/*
-    # This is because it's easier to do ;-) but arguably if this script is run
-    # on system shutdown then it's also the right thing to do.
-    if ! all_zombies && test -n "$XENDOMAINS_SHUTDOWN_ALL"; then
-	# XENDOMAINS_SHUTDOWN_ALL should be "--all --wait"
-	echo -n " SHUTDOWN_ALL "
-	watchdog_xencmd shutdown 1 false &
-	WDOG_PID=$!
-	XMR=`$CMD shutdown $XENDOMAINS_SHUTDOWN_ALL 2>&1 1>/dev/null`
-	if test $? -ne 0; then
-	    echo -e "\nAn error occurred while shutting down all domains: $XMR\n"
-	    rc_failed $?
-	    echo -e '!'
-	fi
-	kill $WDOG_PID >/dev/null 2>&1
-    fi
-
-    # Unconditionally delete lock file
-    rm -f $LOCKFILE
-    
-    exec 2>&3
+	echo "Shutting down Xen domains"
+	if [ "$XENDOMAINS_AUTO_ONLY" = "true" ]; then
+		running_auto_names
+	fi
+	local printed=0
+	while read LN; do
+		parseln "$LN"
+		[ "$id" = 0 ] && continue
+		[ -z "$state" ] && continue
+		printed=1
+		if [ "$XENDOMAINS_AUTO_ONLY" = "true" ]; then
+			is_auto_domain=0
+			for n in "${AUTONAMES[@]}"; do
+				if [ "$name" = "$n" ]; then
+					is_auto_domain=1
+					break
+				fi
+			done
+			if [ $is_auto_domain -eq 0 ]; then
+				echo -n "	$name: "
+				rc_status -s
+				continue
+			fi
+		fi
+		if [ -n "$XENDOMAINS_SYSRQ" ]; then
+			for sysrq in $XENDOMAINS_SYSRQ; do
+				echo -n "	$name: "
+				echo -n "sending sysrq '$sysrq'... "
+				${xm_cmd} sysrq $id $sysrq
+				if [ $? -ne 0 ]; then
+					rc_failed
+				else
+					rc_reset
+				fi
+				rc_status -v
+				# usleep just ignores empty arg
+				usleep $XENDOMAINS_USLEEP
+			done
+		fi
+		if is_zombie_state "$state"; then
+			echo -n "	$name: "
+			echo -n "destroying zombie... "
+			${xm_cmd} destroy $id
+			rc_reset
+			rc_status -v
+			continue
+		fi
+		if [ -n "$XENDOMAINS_MIGRATE" ]; then
+			echo -n "	$name: "
+			echo -n "migrating... "
+			migrate_with_watchdog $id "$XENDOMAINS_MIGRATE"
+			if [ $? -ne 0 ]; then
+				rc_failed
+				rc_status -v
+			else
+				rc_reset
+				rc_status -v
+				continue
+			fi
+		fi
+		if [ -n "$XENDOMAINS_SAVE" ]; then
+			echo -n "	$name: "
+			echo -n "saving... "
+			save_with_watchdog $id "$XENDOMAINS_SAVE/$name"
+			if [ $? -ne 0 ]; then
+				rm -f "$XENDOMAINS_SAVE/$name"
+				rc_failed
+				rc_status -v
+			else
+				rc_reset
+				rc_status -v
+				continue
+			fi
+		fi
+		if [ -n "$XENDOMAINS_SHUTDOWN" ]; then
+			echo -n "	$name: "
+			echo -n "shutting down... "
+			shutdown_with_watchdog $id $XENDOMAINS_SHUTDOWN
+			if [ $? -ne 0 ]; then
+				rc_failed
+			else
+				rc_reset
+			fi
+			rc_status -v
+		fi
+	done < <(xm_list)
+
+	if [ -n "$XENDOMAINS_SHUTDOWN_ALL" ] && any_non_zombies ; then
+		echo -n "	others: shutting down... "
+		shutdown_with_watchdog $XENDOMAINS_SHUTDOWN_ALL
+		if [ $? -ne 0 ]; then
+			rc_failed
+		else
+			rc_reset
+		fi
+		rc_status -v
+	fi
+
+	if [ $printed -eq 0 ]; then
+		echo -e "${rc_done_up}"
+	fi
+
+	# Unconditionally delete lock file
+	rm -f "$LOCKFILE"
 }
 
 check_domain_up()
 {
-    name=;id=
-    while read LN; do
-	parseln "$LN" || continue
-	if test $id = 0; then continue; fi
-	case $name in 
-	    ($1)
-		return 0
-		;;
-	esac
-    done < <($CMD list -l | grep $LIST_GREP)
-    return 1
-}
-
-check_all_auto_domains_up()
-{
-    if ! contains_something "$XENDOMAINS_AUTO"
-    then
-      return 0
-    fi
-    missing=
-    for nm in $XENDOMAINS_AUTO/*; do
-	rdname $nm
-	found=0
-	if check_domain_up "$NM"; then 
-	    echo -n " $name"
-	else 
-	    missing="$missing $NM"
-	fi
-    done
-    if test -n "$missing"; then
-	echo -n " MISS AUTO:$missing"
+	while read LN; do
+		parseln "$LN"
+		[ "$id" = 0 ] && continue
+		if [ "$name" = "$1" ]; then
+			[ -z "$state" ] && return 1
+			return 0
+		fi
+	done < <(xm_list)
 	return 1
-    fi
-    return 0
 }
 
-check_all_saved_domains_up()
+check_all_domains_up()
 {
-    if ! contains_something "$XENDOMAINS_SAVE" 
-    then
-      return 0
-    fi
-    missing=`/bin/ls $XENDOMAINS_SAVE`
-    echo -n " MISS SAVED: " $missing
-    return 1
+	any_auto=0
+	any_save=0
+	dir_contains_something "$XENDOMAINS_AUTO" && any_auto=1
+	dir_contains_something "$XENDOMAINS_SAVE" && any_save=1
+	if [ $any_auto -eq 0 ] && [ $any_save -eq 0 ]; then
+		rc_reset
+		rc_status -v
+		return
+	fi
+	echo
+	if [ $any_auto -ne 0 ]; then
+		for nm in "$XENDOMAINS_AUTO"/*; do
+			get_name_from_cfg "$nm"
+			echo -n "	$nm: "
+			if check_domain_up "$NM"; then
+				rc_reset
+			else
+				rc_failed 2
+			fi
+			rc_status -v
+		done
+	fi
+	if [ $any_save -ne 0 ]; then
+		for nm in "$XENDOMAINS_SAVE"/*; do
+			echo -n "	$nm: "
+			rc_failed 3
+			rc_status -v
+		done
+	fi
 }
 
 # This does NOT necessarily restart all running domains: instead it
 # stops all running domains and then boots all the domains specified in
 # AUTODIR.  If other domains have been started manually then they will
 # not get restarted.
-# Commented out to avoid confusion!
-
 restart()
 {
-    stop
-    start
-}
-
-reload()
-{
-    restart
+	"$0" stop
+	start
 }
 
-
 case "$1" in
-    start)
+ start)
+	check $1
 	start
-	rc_status
-	if test -f $LOCKFILE; then rc_status -v; fi
 	;;
 
-    stop)
+ stop)
+	check $1
 	stop
-	rc_status -v
 	;;
 
-    restart)
+ restart|reload)
+	check $1
 	restart
 	;;
-    reload)
-	reload
+
+ try-restart)
+	check $1
+	"$0" status
+	if [ $? = 0 ]; then
+		"$0" restart
+	else
+		rc_reset
+		rc_status -v
+	fi
 	;;
 
-    status)
-	echo -n "Checking for xendomains:" 
-	if test ! -f $LOCKFILE; then 
-	    rc_failed 3
+ status)
+	check $1
+	echo -n "Checking status of Xen domains"
+	if [ ! -f "$LOCKFILE" ]; then
+		rc_failed 3
+		rc_status -v
 	else
-	    check_all_auto_domains_up
-	    rc_status
-	    check_all_saved_domains_up
-	    rc_status
+		check_all_domains_up
 	fi
-	rc_status -v
 	;;
 
-    *)
-	echo "Usage: $0 {start|stop|restart|reload|status}"
-	rc_failed 3
-	rc_status -v
+ *)
+	echo "Usage: $0 {start|stop|restart|try-restart|reload|status}"
+	rc_failed 2
 	;;
 esac
 
diff -Naur xen/tools/hotplug/Linux/locking.sh xenb/tools/hotplug/Linux/locking.sh
--- xen/tools/hotplug/Linux/locking.sh	2013-03-09 10:39:52.316511944 -0700
+++ xenb/tools/hotplug/Linux/locking.sh	2013-03-09 10:52:07.753178611 -0700
@@ -20,7 +20,7 @@
 # Serialisation
 #
 
-LOCK_BASEDIR=/var/run/xen-hotplug
+LOCK_BASEDIR=/run/xen-hotplug
 
 _setlockfd()
 {
diff -Naur xen/tools/hotplug/Linux/xend.rules xenb/tools/hotplug/Linux/xend.rules
--- xen/tools/hotplug/Linux/xend.rules	2013-03-09 10:39:52.319845278 -0700
+++ xenb/tools/hotplug/Linux/xend.rules	2013-03-09 10:52:07.753178611 -0700
@@ -1,4 +1,4 @@
 SUBSYSTEM=="pci", RUN+="socket:/org/xen/xend/udev_event"
 SUBSYSTEM=="scsi", RUN+="socket:/org/xen/xend/udev_event"
 SUBSYSTEM=="usb", RUN+="socket:/org/xen/xend/udev_event"
-#SUBSYSTEM=="net", KERNEL!="vif[0-9]*.[0-9]*|tap[0-9]*.[0-9]*", RUN+="socket:/org/xen/xend/udev_event"
+SUBSYSTEM=="net", KERNEL!="vif[0-9]*.[0-9]*|tap[0-9]*.[0-9]*", RUN+="socket:/org/xen/xend/udev_event"
diff -Naur xen/tools/libaio/harness/Makefile xenb/tools/libaio/harness/Makefile
--- xen/tools/libaio/harness/Makefile	2013-03-09 10:39:52.333178611 -0700
+++ xenb/tools/libaio/harness/Makefile	2013-03-09 10:52:07.753178611 -0700
@@ -4,7 +4,7 @@
 HARNESS_SRCS:=main.c
 # io_queue.c
 
-CFLAGS=-Wall -Werror -g -O -laio
+CFLAGS=-Wall -g -O -laio
 #-lpthread -lrt
 
 all: $(PROGS)
diff -Naur xen/tools/libfsimage/Rules.mk xenb/tools/libfsimage/Rules.mk
--- xen/tools/libfsimage/Rules.mk	2013-03-09 10:39:52.349845277 -0700
+++ xenb/tools/libfsimage/Rules.mk	2013-03-09 10:52:07.753178611 -0700
@@ -1,7 +1,7 @@
 include $(XEN_ROOT)/tools/Rules.mk
 
 CFLAGS += -Wno-unknown-pragmas -I$(XEN_ROOT)/tools/libfsimage/common/ -DFSIMAGE_FSDIR=\"$(FSDIR)\"
-CFLAGS += -Werror -D_GNU_SOURCE
+CFLAGS += -D_GNU_SOURCE
 LDFLAGS += -L../common/
 
 PIC_OBJS := $(patsubst %.c,%.opic,$(LIB_SRCS-y))
diff -Naur xen/tools/libxc/Makefile xenb/tools/libxc/Makefile
--- xen/tools/libxc/Makefile	2013-03-09 10:39:52.366511945 -0700
+++ xenb/tools/libxc/Makefile	2013-03-09 10:52:07.753178611 -0700
@@ -72,7 +72,7 @@
 
 -include $(XEN_TARGET_ARCH)/Makefile
 
-CFLAGS   += -Werror -Wmissing-prototypes
+CFLAGS   += -Wmissing-prototypes
 CFLAGS   += -I. $(CFLAGS_xeninclude)
 
 # Needed for posix_fadvise64() in xc_linux.c
diff -Naur xen/tools/libxc/xc_suspend.c xenb/tools/libxc/xc_suspend.c
--- xen/tools/libxc/xc_suspend.c	2013-03-09 10:39:52.373178611 -0700
+++ xenb/tools/libxc/xc_suspend.c	2013-03-09 10:52:07.753178611 -0700
@@ -16,8 +16,43 @@
 
 #include "xc_private.h"
 #include "xenguest.h"
+#include <signal.h>
+#ifdef __MINIOS__
+extern int kill (__pid_t __pid, int __sig);
+#endif
 
 #define SUSPEND_LOCK_FILE "/var/lib/xen/suspend_evtchn"
+/* cleanup obsolete suspend lock file which is unlinked for any reason,
+so that current process can get lock */
+static void clean_obsolete_lock(int domid)
+{
+    int fd, pid, n;
+    char buf[128];
+    char suspend_file[256];
+
+    snprintf(suspend_file, sizeof(suspend_file), "%s_%d_lock.d",
+        SUSPEND_LOCK_FILE, domid);
+    fd = open(suspend_file, O_RDWR);
+
+    if (fd < 0)
+        return;
+
+    n = read(fd, buf, 127);
+
+    close(fd);
+
+    if (n > 0)
+    {
+        sscanf(buf, "%d", &pid);
+        /* pid does not exist, this lock file is obsolete, just delete it */
+        if ( kill(pid,0) )
+        {
+            unlink(suspend_file);
+            return;
+        }
+    }
+}
+
 static int lock_suspend_event(xc_interface *xch, int domid)
 {
     int fd, rc;
@@ -27,6 +62,7 @@
 
     snprintf(suspend_file, sizeof(suspend_file), "%s_%d_lock.d",
 	    SUSPEND_LOCK_FILE, domid);
+    clean_obsolete_lock(domid);
     mask = umask(022);
     fd = open(suspend_file, O_CREAT | O_EXCL | O_RDWR, 0666);
     if (fd < 0)
@@ -41,6 +77,9 @@
     rc = write_exact(fd, buf, strlen(buf));
     close(fd);
 
+    if(rc)
+    unlink(suspend_file);
+
     return rc;
 }
 
@@ -127,8 +166,7 @@
     return suspend_evtchn;
 
 cleanup:
-    if (suspend_evtchn != -1)
-        xc_suspend_evtchn_release(xch, xce, domid, suspend_evtchn);
+    xc_suspend_evtchn_release(xch, xce, domid, suspend_evtchn);
 
     return -1;
 }
diff -Naur xen/tools/libxen/src/xen_common.c xenb/tools/libxen/src/xen_common.c
--- xen/tools/libxen/src/xen_common.c	2013-03-09 10:39:52.379845278 -0700
+++ xenb/tools/libxen/src/xen_common.c	2013-03-09 10:52:07.753178611 -0700
@@ -904,8 +904,15 @@
             0 != strcmp((char *)value_node->children->name, "struct") ||
             value_node->children->children == NULL)
         {
+#if PERMISSIVE
+            fprintf(stderr,
+                    "Expected Map from the server, but didn't get one\n");
+            ((arbitrary_map **)value)[slot] = NULL;
+#else
+
             server_error(s,
                          "Expected Map from the server, but didn't get it");
+#endif
         }
         else
         {
diff -Naur xen/tools/libxl/Makefile xenb/tools/libxl/Makefile
--- xen/tools/libxl/Makefile	2013-03-09 10:39:52.383178611 -0700
+++ xenb/tools/libxl/Makefile	2013-03-09 10:52:07.756511944 -0700
@@ -11,7 +11,7 @@
 XLUMAJOR = 1.0
 XLUMINOR = 1
 
-CFLAGS += -Werror -Wno-format-zero-length -Wmissing-declarations \
+CFLAGS += -Wno-format-zero-length -Wmissing-declarations \
 	-Wno-declaration-after-statement -Wformat-nonliteral
 CFLAGS += -I. -fPIC
 
diff -Naur xen/tools/libxl/libxl_dm.c xenb/tools/libxl/libxl_dm.c
--- xen/tools/libxl/libxl_dm.c	2013-03-09 10:39:52.386511945 -0700
+++ xenb/tools/libxl/libxl_dm.c	2013-03-09 10:52:07.756511944 -0700
@@ -50,7 +50,7 @@
             dm = libxl__abs_path(gc, "qemu-dm", libxl__libexec_path());
             break;
         case LIBXL_DEVICE_MODEL_VERSION_QEMU_XEN:
-            dm = libxl__abs_path(gc, "qemu-system-i386", libxl__libexec_path());
+            dm = libxl__abs_path(gc, "qemu-system-x86_64", libxl__libexec_path());
             break;
         default:
             LIBXL__LOG(ctx, LIBXL__LOG_ERROR,
@@ -195,6 +195,12 @@
                                   "-usbdevice", b_info->u.hvm.usbdevice, NULL);
             }
         }
+        if (b_info->u.hvm.watchdog || b_info->u.hvm.watchdog_action) {
+            flexarray_append(dm_args, "-watchdog");
+            if (b_info->u.hvm.watchdog_action) {
+                flexarray_vappend(dm_args, "-watchdog-action", b_info->u.hvm.watchdog_action, NULL);
+            }
+        }
         if (b_info->u.hvm.soundhw) {
             flexarray_vappend(dm_args, "-soundhw", b_info->u.hvm.soundhw, NULL);
         }
@@ -465,6 +471,12 @@
                                   "-usbdevice", b_info->u.hvm.usbdevice, NULL);
             }
         }
+        if (b_info->u.hvm.watchdog || b_info->u.hvm.watchdog_action) {
+            flexarray_append(dm_args, "-watchdog");
+            if (b_info->u.hvm.watchdog_action) {
+                flexarray_vappend(dm_args, "-watchdog-action", b_info->u.hvm.watchdog_action, NULL);
+            }
+        }
         if (b_info->u.hvm.soundhw) {
             flexarray_vappend(dm_args, "-soundhw", b_info->u.hvm.soundhw, NULL);
         }
diff -Naur xen/tools/libxl/libxl_internal.h xenb/tools/libxl/libxl_internal.h
--- xen/tools/libxl/libxl_internal.h	2013-03-09 10:39:52.389845277 -0700
+++ xenb/tools/libxl/libxl_internal.h	2013-03-09 10:52:07.756511944 -0700
@@ -377,7 +377,7 @@
 #define PCI_SLOT(devfn)         (((devfn) >> 3) & 0x1f)
 #define PCI_FUNC(devfn)         ((devfn) & 0x07)
 #define AUTO_PHP_SLOT          0x100
-#define XENSTORE_PID_FILE      "/var/run/xenstored.pid"
+#define XENSTORE_PID_FILE      "/run/xenstored.pid"
 
 #define PROC_PCI_NUM_RESOURCES 7
 #define PCI_BAR_IO             0x01
diff -Naur xen/tools/libxl/libxl_types.idl xenb/tools/libxl/libxl_types.idl
--- xen/tools/libxl/libxl_types.idl	2013-03-09 10:39:52.389845277 -0700
+++ xenb/tools/libxl/libxl_types.idl	2013-03-09 10:52:07.756511944 -0700
@@ -330,6 +330,8 @@
                                        ("usbdevice",        string),
                                        ("soundhw",          string),
                                        ("xen_platform_pci", libxl_defbool),
+                                       ("watchdog",         string),
+                                       ("watchdog_action",  string),
                                        ])),
                  ("pv", Struct(None, [("kernel", string),
                                       ("slack_memkb", MemKB),
diff -Naur xen/tools/libxl/xl.c xenb/tools/libxl/xl.c
--- xen/tools/libxl/xl.c	2013-03-09 10:39:52.393178611 -0700
+++ xenb/tools/libxl/xl.c	2013-03-09 10:52:07.756511944 -0700
@@ -32,7 +32,7 @@
 #include "libxlutil.h"
 #include "xl.h"
 
-#define XEND_LOCK { "/var/lock/subsys/xend", "/var/lock/xend" }
+#define XEND_LOCK { "/run/lock/subsys/xend", "/run/lock/xend" }
 
 xentoollog_logger_stdiostream *logger;
 int dryrun_only;
diff -Naur xen/tools/libxl/xl_cmdimpl.c xenb/tools/libxl/xl_cmdimpl.c
--- xen/tools/libxl/xl_cmdimpl.c	2013-03-09 10:39:52.393178611 -0700
+++ xenb/tools/libxl/xl_cmdimpl.c	2013-03-09 10:52:07.759845278 -0700
@@ -1417,6 +1417,8 @@
                         " \"device_model_stubdomain_override\" directive"
                         " for pv guest\n");
         }
+        xlu_cfg_replace_string (config, "watchdog", &b_info->u.hvm.watchdog, 0);
+        xlu_cfg_replace_string (config, "watchdog_action", &b_info->u.hvm.watchdog_action, 0);
     }
 
 
diff -Naur xen/tools/misc/serial-split/Makefile xenb/tools/misc/serial-split/Makefile
--- xen/tools/misc/serial-split/Makefile	1969-12-31 17:00:00.000000000 -0700
+++ xenb/tools/misc/serial-split/Makefile	2013-03-09 10:52:07.759845278 -0700
@@ -0,0 +1,20 @@
+CC     ?= gcc
+CFLAGS ?= -Wall -Os
+CFILES = $(wildcard *.c)
+OBJS   = $(patsubst %.c,%.o,$(wildcard *.c))
+TARGET = serial-split
+
+all: $(TARGET)
+
+install: all
+	install -d $(DESTDIR)/usr/bin
+	install -s $(TARGET) $(DESTDIR)/usr/bin/
+
+clean:
+	rm *.o $(TARGET) *~
+
+$(TARGET): $(OBJS)
+	$(CC) $(CFLAGS) -o $@ $^
+
+%.o: %.c Makefile
+	$(CC) $(CFLAGS) -c -o $@ $<
diff -Naur xen/tools/misc/serial-split/serial-split.c xenb/tools/misc/serial-split/serial-split.c
--- xen/tools/misc/serial-split/serial-split.c	1969-12-31 17:00:00.000000000 -0700
+++ xenb/tools/misc/serial-split/serial-split.c	2013-03-09 10:52:07.759845278 -0700
@@ -0,0 +1,422 @@
+/*
+ *  serial-split.c
+ *  pdb / console splitter
+ *
+ *  Copyright 2005 Charles Coffing <ccoffing@novell.com>
+ *
+ *  This program is free software; you can redistribute it and/or
+ *  modify it under the terms of the GNU General Public License
+ *  as published by the Free Software Foundation; either version 2
+ *  of the License, or (at your option) any later version.
+ *
+ *  This program is distributed in the hope that it will be useful,
+ *  but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *  GNU General Public License for more details.
+ *
+ */
+
+/*
+ *  Typical setup:
+ *
+ *               Development box          Xen box
+ *                      ...-----+        +-----...
+ *  +---------+                 |        |
+ *  | gdb     |                 |        |
+ *  |         |\ high           |        |
+ *  +---------+ \               |        |
+ *               \+-----------+ | serial | +------------------+
+ *                |  splitter |------------| Xen              |
+ *               /+-----------+ |        | |  - pdb    (com1H)|
+ *  +---------+ /               |        | |  - printk (com1) |
+ *  | console |/ low            |        | +------------------+
+ *  | viewer  |                 |        |
+ *  +---------+                 |        |
+ *                      ...-----+        +-----...
+ */
+
+
+#include <assert.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <string.h>
+#include <unistd.h>
+#include <fcntl.h>
+#include <termios.h>
+#include <sys/signal.h>
+#include <sys/time.h>
+#include <sys/types.h>
+#include <sys/wait.h>
+#include <sys/socket.h>
+#include <sys/ioctl.h>
+#include <netinet/in.h>
+
+const unsigned int DefaultLowPort = 12010;
+const unsigned int DefaultBaud = 115200;
+const char DefaultSerialDevice[] = "/dev/ttyS0";
+
+#define DEBUG 0
+#define MAX(a,b) ((a)<(b)?(b):(a))
+
+
+static int cook_baud(int baud)
+{
+    int cooked_baud = 0;
+    switch (baud)
+    {
+    case     50: cooked_baud =     B50; break;
+    case     75: cooked_baud =     B75; break;
+    case    110: cooked_baud =    B110; break;
+    case    134: cooked_baud =    B134; break;
+    case    150: cooked_baud =    B150; break;
+    case    200: cooked_baud =    B200; break;
+    case    300: cooked_baud =    B300; break;
+    case    600: cooked_baud =    B600; break;
+    case   1200: cooked_baud =   B1200; break;
+    case   1800: cooked_baud =   B1800; break;
+    case   2400: cooked_baud =   B2400; break;
+    case   4800: cooked_baud =   B4800; break;
+    case   9600: cooked_baud =   B9600; break;
+    case  19200: cooked_baud =  B19200; break;
+    case  38400: cooked_baud =  B38400; break;
+    case  57600: cooked_baud =  B57600; break;
+    case 115200: cooked_baud = B115200; break;
+    }
+    return cooked_baud;
+}
+
+
+static int start_listener(unsigned short port)
+{
+    int fd;
+    struct sockaddr_in sin;
+    int on = 1;
+
+    if ((fd = socket (AF_INET, SOCK_STREAM, 0)) < 0)
+    {
+        perror("socket");
+        goto out1;
+    }
+
+    setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, &on, sizeof (on));
+
+    memset(&sin, 0, sizeof(sin));
+    sin.sin_family = AF_INET;
+    sin.sin_port = htons (port);
+    sin.sin_addr.s_addr = INADDR_ANY;
+    if (bind(fd, (struct sockaddr *)&sin, sizeof(sin)) < 0)
+    {
+        perror("bind");
+        goto out2;
+    }
+
+    if (listen(fd, 1) < 0)
+    {
+        perror("listen");
+        goto out2;
+    }
+
+    fprintf(stderr, "Listening on port %d\n", port);
+
+    return fd;
+
+out2:
+    close(fd);
+out1:
+    return -1;
+}
+
+
+static int accept_conn(int fd)
+{
+    int on = 1;
+    int new_fd;
+    struct sockaddr_in from;
+    socklen_t fromlen = sizeof(from);
+
+    new_fd = accept(fd, (struct sockaddr *)&from, &fromlen);
+    if (new_fd < 0)
+        perror("accept");
+    ioctl(new_fd, FIONBIO, &on);
+
+    fprintf(stderr, "Accepted connection on %d\n", new_fd);
+
+    return new_fd;
+}
+
+
+static void close_conn(int * fd)
+{
+    shutdown(*fd, 2);
+    close(*fd);
+    *fd = -1;
+}
+
+
+static int receive_data(int * fd, char * buf, ssize_t max_bytes, int * poll)
+{
+    ssize_t bytes;
+    if ((bytes = read(*fd, buf, max_bytes)) < 0)
+    {
+        perror("read");
+        *poll = 1;
+        return 0;
+    }
+    else if (bytes == 0)
+    {
+        close_conn(fd);
+        *poll = 0;
+        return 0;
+    }
+    else
+    {
+        if (bytes == max_bytes)
+            *poll = 1;
+        else
+            *poll = 0;
+#if DEBUG
+        {
+            ssize_t i;
+            fprintf(stderr, "Received %d bytes on %d:\n", bytes, *fd);
+            for (i = 0; i < bytes; ++ i)
+            {
+                if ((i & 0xf) == 0)
+                    printf("    ");
+                printf("%02x", buf[i] & 0xff);
+                if (((i+1) & 0xf) == 0 || i + 1 == bytes)
+                    printf("\n");
+                else
+                    printf(" ");
+            }
+        }
+#endif
+        return bytes;
+    }
+}
+
+
+static void set_high_bit(char * buf, size_t bytes)
+{
+    size_t i;
+    for(i = 0; i < bytes; ++ i)
+        buf[i] |= 0x80;
+}
+
+
+static void clear_high_bit(char * buf, size_t bytes)
+{
+    size_t i;
+    for(i = 0; i < bytes; ++ i)
+        buf[i] &= 0x7f;
+}
+
+
+static int open_serial(char const * serial_dev, int baud)
+{
+    struct termios newsertio;
+    int serial_fd;
+    memset(&newsertio, 0, sizeof(newsertio));
+
+    if ((serial_fd = open(serial_dev, O_RDWR | O_NOCTTY | O_NONBLOCK)) < 0)
+    {
+        perror(serial_dev);
+        return -1;
+    }
+
+    newsertio.c_cflag = baud | CS8 | CLOCAL | CREAD;
+    newsertio.c_iflag = IGNBRK | IGNPAR;    /* raw input */
+    newsertio.c_oflag = 0;                  /* raw output */
+    newsertio.c_lflag = 0;                  /* no echo, no signals */
+    newsertio.c_cc[VMIN] = 1;
+    newsertio.c_cc[VTIME] = 0;
+    tcflush(serial_fd, TCIFLUSH);
+    tcsetattr(serial_fd, TCSANOW, &newsertio);
+
+    fprintf(stderr, "Listening on %s\n", serial_dev);
+
+    return serial_fd;
+}
+
+
+static void main_loop(int serial_fd, int low_listener, int high_listener)
+{
+    fd_set rdfds;
+    int low_poll = 0, high_poll = 0, serial_poll = 0;
+    int low_fd = -1, high_fd = -1;
+
+    while(1)
+    {
+        char buf[1024];
+        ssize_t bytes;
+        int max;
+
+        FD_ZERO(&rdfds);
+        FD_SET(low_fd < 0 ? low_listener : low_fd, &rdfds);
+        FD_SET(high_fd < 0 ? high_listener : high_fd, &rdfds);
+        FD_SET(serial_fd, &rdfds);
+
+        max = MAX(low_fd, low_listener);
+        max = MAX(max, high_fd);
+        max = MAX(max, high_listener);
+        max = MAX(max, serial_fd);
+
+        if (select(max + 1, &rdfds, NULL, NULL, NULL) < 0)
+        {
+            perror("select");
+            continue;
+        }
+
+        if (FD_ISSET(low_listener, &rdfds))
+        {
+            assert(low_fd < 0);
+            low_fd = accept_conn(low_listener);
+        }
+
+        if (FD_ISSET(high_listener, &rdfds))
+        {
+            assert(high_fd < 0);
+            high_fd = accept_conn(high_listener);
+        }
+
+        if (low_poll || (low_fd >= 0 && FD_ISSET(low_fd, &rdfds)))
+        {
+            if ((bytes = receive_data(&low_fd, &buf[0], sizeof(buf),
+                                      &low_poll)) > 0)
+            {
+                clear_high_bit(&buf[0], bytes);
+                if (write(serial_fd, &buf[0], bytes) < 0)
+                    perror("write");
+            }
+        }
+
+        if (high_poll || (high_fd >= 0 && FD_ISSET(high_fd, &rdfds)))
+        {
+            if ((bytes = receive_data(&high_fd, &buf[0], sizeof(buf),
+                                      &high_poll)) > 0)
+            {
+                set_high_bit(&buf[0], bytes);
+                if (write(serial_fd, &buf[0], bytes) < 0)
+                    perror("write");
+            }
+        }
+
+        if (serial_poll || FD_ISSET(serial_fd, &rdfds))
+        {
+            if ((bytes = receive_data(&serial_fd, &buf[0], sizeof(buf),
+                                      &serial_poll)) > 0)
+            {
+                ssize_t i;
+                for (i = 0; i < bytes; ++ i)
+                {
+                    if (buf[i] & 0x80)
+                    {
+                        if (high_fd >= 0)
+                        {
+                            buf[i] &= 0x7f;
+                            if ((write(high_fd, &buf[i], 1)) < 0)
+                            {
+                                perror("write");
+                                close_conn(&high_fd);
+                                high_poll = 0;
+                            }
+                        }
+                    }
+                    else
+                    {
+                        if (low_fd >= 0)
+                        {
+                            if ((write(low_fd, &buf[i], 1)) < 0)
+                            {
+                                perror("write");
+                                close_conn(&low_fd);
+                                low_poll = 0;
+                            }
+                        }
+                    }
+                }
+            }
+        }
+    }
+}
+
+
+static void usage()
+{
+    printf(
+"Description:\n"
+"        Splits the serial port between two TCP ports.  Bytes read from the\n"
+"        serial port will be delivered to one of the two TCP ports (high or\n"
+"        low) depending on whether the high bit is set.  Bytes written to the\n"
+"        TCP ports will be forwarded to the serial port; the high bit will be\n"
+"        set or cleared to denote the source.\n"
+"Usage:\n"
+"        serial-split [-d<serial-device>] [-b<baud>]\n"
+"                     [-l<low-port>] [-h<high-port>]\n"
+"Parameters:\n"
+"        -d<serial-device>  Defaults to %s.\n"
+"        -b<baud>           Baud rate of the serial port.  Defaults to %d.\n"
+"                           Also assumes 8N1.\n"
+"        -l<low-port>       Low TCP port.  Defaults to %d, or one less than\n"
+"                           the high port.\n"
+"        -h<high-port>      High TCP port.  Defaults to %d, or one more than\n"
+"                           the low port.\n",
+DefaultSerialDevice, DefaultBaud, DefaultLowPort, DefaultLowPort + 1);
+
+    exit(1);
+}
+
+
+int main(int argc, char **argv)
+{
+    int cooked_baud = cook_baud(DefaultBaud);
+    char const * serial_dev = DefaultSerialDevice;
+    int low_port = -1, high_port = -1;
+    int serial_fd, low_listener, high_listener;
+
+    while ( --argc != 0 )
+    {
+        char *p = argv[argc];
+        if ( *(p++) != '-' )
+            usage();
+        switch (*(p++))
+        {
+        case 'b':
+            if ( (cooked_baud = cook_baud(atoi(p))) == 0 )
+            {
+                fprintf(stderr, "Bad baud rate\n");
+                exit(1);
+            }
+            break;
+        case 'd':
+            serial_dev = p;
+            break;
+        case 'l':
+            if ((low_port = atoi(p)) <= 0)
+                usage();
+            break;
+        case 'h':
+            if ((high_port = atoi(p)) <= 0)
+                usage();
+            break;
+        default:
+            usage();
+        }
+    }
+
+    if (low_port == -1 && high_port == -1)
+        low_port = DefaultLowPort;
+    if (low_port == -1)
+        low_port = high_port - 1;
+    if (high_port == -1)
+        high_port = low_port + 1;
+
+    if ((serial_fd = open_serial(serial_dev, cooked_baud)) < 0 ||
+        (low_listener = start_listener(low_port)) < 0 ||
+        (high_listener = start_listener(high_port)) < 0)
+        exit(1);
+
+    main_loop(serial_fd, low_listener, high_listener);
+
+    return 0;
+}
+
diff -Naur xen/tools/misc/xend xenb/tools/misc/xend
--- xen/tools/misc/xend	2013-03-09 10:39:52.409845277 -0700
+++ xenb/tools/misc/xend	2013-03-09 10:52:07.759845278 -0700
@@ -1,4 +1,4 @@
-#!/usr/bin/env python
+#!/usr/bin/python -Es
 #  -*- mode: python; -*-
 #============================================================================
 # Copyright (C) 2004 Mike Wray <mike.wray@hp.com>
diff -Naur xen/tools/misc/xenpvnetboot xenb/tools/misc/xenpvnetboot
--- xen/tools/misc/xenpvnetboot	2013-03-09 10:39:52.409845277 -0700
+++ xenb/tools/misc/xenpvnetboot	2013-03-09 10:52:07.759845278 -0700
@@ -194,7 +194,7 @@
                       help='Arguments pass to the kernel.')
     parser.add_option('', '--output',
                       help='Redirect output to this file instead of stdout.')
-    parser.add_option('', '--output-directory', default='/var/run/libxl',
+    parser.add_option('', '--output-directory', default='/run/libxl',
                       help='Output directory.')
     parser.add_option('', '--output-format', default='sxp',
                       help='Output format: sxp, simple or simple0.')
diff -Naur xen/tools/ocaml/libs/xs/xs.ml xenb/tools/ocaml/libs/xs/xs.ml
--- xen/tools/ocaml/libs/xs/xs.ml	2013-03-09 10:39:52.413178611 -0700
+++ xenb/tools/ocaml/libs/xs/xs.ml	2013-03-09 10:52:07.759845278 -0700
@@ -147,7 +147,7 @@
 	end;
 	unwatch ()
 
-let daemon_socket = "/var/run/xenstored/socket"
+let daemon_socket = "/run/xenstored/socket"
 
 (** Throws this rather than a miscellaneous Unix.connect failed *)
 exception Failed_to_connect
diff -Naur xen/tools/ocaml/xenstored/define.ml xenb/tools/ocaml/xenstored/define.ml
--- xen/tools/ocaml/xenstored/define.ml	2013-03-09 10:39:52.413178611 -0700
+++ xenb/tools/ocaml/xenstored/define.ml	2013-03-09 10:52:07.759845278 -0700
@@ -20,8 +20,8 @@
 let xenstored_proc_kva = "/proc/xen/xsd_kva"
 let xenstored_proc_port = "/proc/xen/xsd_port"
 
-let xs_daemon_socket = "/var/run/xenstored/socket"
-let xs_daemon_socket_ro = "/var/run/xenstored/socket_ro"
+let xs_daemon_socket = "/run/xenstored/socket"
+let xs_daemon_socket_ro = "/run/xenstored/socket_ro"
 
 let default_config_dir = "/etc/xen"
 
diff -Naur xen/tools/ocaml/xenstored/disk.ml xenb/tools/ocaml/xenstored/disk.ml
--- xen/tools/ocaml/xenstored/disk.ml	2013-03-09 10:39:52.413178611 -0700
+++ xenb/tools/ocaml/xenstored/disk.ml	2013-03-09 10:52:07.759845278 -0700
@@ -15,7 +15,7 @@
  *)
 
 let enable = ref false
-let xs_daemon_database = "/var/run/xenstored/db"
+let xs_daemon_database = "/run/xenstored/db"
 
 let error fmt = Logging.error "disk" fmt
 
diff -Naur xen/tools/ocaml/xenstored/oxenstored.conf xenb/tools/ocaml/xenstored/oxenstored.conf
--- xen/tools/ocaml/xenstored/oxenstored.conf	2013-03-09 10:39:52.413178611 -0700
+++ xenb/tools/ocaml/xenstored/oxenstored.conf	2013-03-09 10:52:07.759845278 -0700
@@ -1,7 +1,7 @@
 # default xenstored config
 
 # Where the pid file is stored
-pid-file = /var/run/xenstored.pid
+pid-file = /run/xenstored.pid
 
 # Randomly failed a transaction with EAGAIN. Used for testing Xs user
 test-eagain = false
diff -Naur xen/tools/ocaml/xenstored/xenstored.ml xenb/tools/ocaml/xenstored/xenstored.ml
--- xen/tools/ocaml/xenstored/xenstored.ml	2013-03-09 10:39:52.416511944 -0700
+++ xenb/tools/ocaml/xenstored/xenstored.ml	2013-03-09 10:52:07.759845278 -0700
@@ -58,7 +58,7 @@
 let sigusr1_handler store =
 	try
 		let channel = open_out_gen [ Open_wronly; Open_creat; Open_trunc; ]
-		                           0o600 "/var/run/xenstored/db.debug" in
+		                           0o600 "/run/daemonsxenstored/db.debug" in
 		finally (fun () -> Store.dump store channel)
 			(fun () -> close_out channel)
 	with _ ->
@@ -73,7 +73,7 @@
 	| Some name -> name
 	| None      -> Define.default_config_dir ^ "/oxenstored.conf"
 
-let default_pidfile = "/var/run/xenstored.pid"
+let default_pidfile = "/run/xenstored.pid"
 
 let parse_config filename =
 	let pidfile = ref default_pidfile in
@@ -254,7 +254,7 @@
 	let quit = ref false in
 
 	if cf.restart then (
-		DB.from_file store domains cons "/var/run/xenstored/db";
+		DB.from_file store domains cons "/run/xenstored/db";
 		Event.bind_dom_exc_virq eventchn
 	) else (
 		if !Disk.enable then (
@@ -280,7 +280,7 @@
 
 	Logging.init_xenstored_log();
 	if cf.activate_access_log then begin
-		let post_rotate () = DB.to_file store cons "/var/run/xenstored/db" in
+		let post_rotate () = DB.to_file store cons "/run/xenstored/db" in
 		Logging.init_access_log post_rotate
 	end;
 
@@ -389,5 +389,5 @@
 				raise exc
 	done;
 	info "stopping xenstored";
-	DB.to_file store cons "/var/run/xenstored/db";
+	DB.to_file store cons "/run/xenstored/db";
 	()
diff -Naur xen/tools/pygrub/Makefile xenb/tools/pygrub/Makefile
--- xen/tools/pygrub/Makefile	2013-03-09 10:39:52.416511944 -0700
+++ xenb/tools/pygrub/Makefile	2013-03-09 10:52:07.763178611 -0700
@@ -13,7 +13,7 @@
 	CC="$(CC)" CFLAGS="$(CFLAGS)" $(PYTHON) setup.py install \
 		$(PYTHON_PREFIX_ARG) --root="$(DESTDIR)" \
 		--install-scripts=$(PRIVATE_BINDIR) --force
-	$(INSTALL_DIR) $(DESTDIR)/var/run/xend/boot
+	$(INSTALL_DIR) $(DESTDIR)/run/xend/boot
 	set -e; if [ "`readlink -f $(DESTDIR)/$(BINDIR)`" != \
 	             "`readlink -f $(PRIVATE_BINDIR)`" ]; then \
 	    ln -sf $(PRIVATE_BINDIR)/pygrub $(DESTDIR)/$(BINDIR); \
diff -Naur xen/tools/pygrub/src/pygrub xenb/tools/pygrub/src/pygrub
--- xen/tools/pygrub/src/pygrub	2013-03-09 10:39:52.426511945 -0700
+++ xenb/tools/pygrub/src/pygrub	2013-03-09 10:52:07.763178611 -0700
@@ -17,7 +17,6 @@
 import copy
 import logging
 import platform
-import xen.lowlevel.xc
 
 import curses, _curses, curses.wrapper, curses.textpad, curses.ascii
 import getopt
@@ -26,6 +25,7 @@
 import grub.GrubConf
 import grub.LiloConf
 import grub.ExtLinuxConf
+import xnloader
 
 PYGRUB_VER = 0.6
 FS_READ_MAX = 1024 * 1024
@@ -119,6 +119,7 @@
     fd = os.open(file, os.O_RDONLY)
     buf = os.read(fd, 512)
     os.close(fd)
+    offzerocount = 0
     for poff in (446, 462, 478, 494): # partition offsets
 
         # MBR contains a 16 byte descriptor per partition
@@ -128,6 +129,7 @@
         
         # offset == 0 implies this partition is not enabled
         if offset == 0:
+            offzerocount += 1
             continue
 
         if type == FDISK_PART_SOLARIS or type == FDISK_PART_SOLARIS_OLD:
@@ -148,6 +150,9 @@
         else:
             part_offs.append(offset)
 
+    if offzerocount == 4:
+        # Might be a grub boot sector pretending to be an MBR
+        part_offs.append(0)
     return part_offs
 
 class GrubLineEditor(curses.textpad.Textbox):
@@ -637,51 +642,6 @@
 
     return grubcfg
 
-def supports64bitPVguest():
-    xc = xen.lowlevel.xc.xc()
-    caps = xc.xeninfo()['xen_caps'].split(" ")
-    for cap in caps:
-        if cap == "xen-3.0-x86_64":
-            return True
-    return False
-
-# If nothing has been specified, look for a Solaris domU. If found, perform the
-# necessary tweaks.
-def sniff_solaris(fs, cfg):
-    if not fs.file_exists("/platform/i86xpv/kernel/unix") and \
-       not fs.file_exists("/platform/i86xpv/kernel/amd64/unix"):
-        return cfg
-
-    if not cfg["kernel"]:
-        if supports64bitPVguest() and \
-          fs.file_exists("/platform/i86xpv/kernel/amd64/unix"):
-            cfg["kernel"] = "/platform/i86xpv/kernel/amd64/unix"
-            cfg["ramdisk"] = "/platform/i86pc/amd64/boot_archive"
-        elif fs.file_exists("/platform/i86xpv/kernel/unix"):
-            cfg["kernel"] = "/platform/i86xpv/kernel/unix"
-            cfg["ramdisk"] = "/platform/i86pc/boot_archive"
-        else:
-            return cfg
-
-    # Unpleasant. Typically we'll have 'root=foo -k' or 'root=foo /kernel -k',
-    # and we need to maintain Xen properties (root= and ip=) and the kernel
-    # before any user args.
-    
-    xenargs = ""
-    userargs = ""
-    
-    if not cfg["args"]:
-        cfg["args"] = cfg["kernel"]
-    else:
-        for arg in cfg["args"].split():
-            if re.match("^root=", arg) or re.match("^ip=", arg):
-                xenargs += arg + " "
-            elif arg != cfg["kernel"]:
-                userargs += arg + " "
-        cfg["args"] = xenargs + " " + cfg["kernel"] + " " + userargs
-
-    return cfg
- 
 def sniff_netware(fs, cfg):
     if not fs.file_exists("/nwserver/xnloader.sys"):
         return cfg
@@ -734,6 +694,8 @@
             if len(data) == 0:
                 os.close(tfd)
                 del datafile
+                if file_to_read == "/nwserver/xnloader.sys":
+                    xnloader.patch_netware_loader(ret)
                 return ret
             try:
                 os.write(tfd, data)
@@ -768,7 +730,7 @@
     debug = False
     not_really = False
     output_format = "sxp"
-    output_directory = "/var/run/xend/boot"
+    output_directory = "/run/xend/boot"
 
     # what was passed in
     incfg = { "kernel": None, "ramdisk": None, "args": "" }
@@ -846,10 +808,7 @@
         try:
             fs = fsimage.open(file, offset, bootfsoptions)
 
-            chosencfg = sniff_solaris(fs, incfg)
-
-            if not chosencfg["kernel"]:
-                chosencfg = sniff_netware(fs, incfg)
+            chosencfg = sniff_netware(fs, incfg)
 
             if not chosencfg["kernel"]:
                 chosencfg = run_grub(file, entry, fs, incfg["args"])
diff -Naur xen/tools/python/README.XendConfig xenb/tools/python/README.XendConfig
--- xen/tools/python/README.XendConfig	2013-03-09 10:39:52.426511945 -0700
+++ xenb/tools/python/README.XendConfig	2013-03-09 10:52:07.763178611 -0700
@@ -118,6 +118,9 @@
                                 image.vncdisplay
                                 image.vncunused
                                 image.hvm.device_model
+                                image.hvm.actmem
+                                image.hvm.xenpaging_file
+                                image.hvm.xenpaging_extra
                                 image.hvm.display
                                 image.hvm.xauthority
                                 image.hvm.vncconsole
diff -Naur xen/tools/python/README.sxpcfg xenb/tools/python/README.sxpcfg
--- xen/tools/python/README.sxpcfg	2013-03-09 10:39:52.426511945 -0700
+++ xenb/tools/python/README.sxpcfg	2013-03-09 10:52:07.763178611 -0700
@@ -51,6 +51,9 @@
   - vncunused
   (HVM)
   - device_model
+  - actmem
+  - xenpaging_file
+  - xenpaging_extra
   - display
   - xauthority
   - vncconsole
diff -Naur xen/tools/python/xen/util/fileuri.py xenb/tools/python/xen/util/fileuri.py
--- xen/tools/python/xen/util/fileuri.py	2013-03-09 10:39:52.449845278 -0700
+++ xenb/tools/python/xen/util/fileuri.py	2013-03-09 10:52:07.763178611 -0700
@@ -81,10 +81,10 @@
     # and a flag if this file in temporary only and must be deleted
     # after starting the VM.
     def decode(encoded_data):
-        mkdir.parents("/var/run/xend/boot/", stat.S_IRWXU)
+        mkdir.parents("/run/xend/boot/", stat.S_IRWXU)
         mediatype, encoding, data_start = scheme_data.parse(encoded_data)
         fd, filename = tempfile.mkstemp(
-            prefix="data_uri_file.", dir="/var/run/xend/boot")
+            prefix="data_uri_file.", dir="/run/xend/boot")
         # Because of python 2.3 support, there is a need to nest these
         # (see http://www.python.org/doc/2.3/ref/try.html)
         try:
diff -Naur xen/tools/python/xen/util/pci.py xenb/tools/python/xen/util/pci.py
--- xen/tools/python/xen/util/pci.py	2013-03-09 10:39:52.449845278 -0700
+++ xenb/tools/python/xen/util/pci.py	2013-03-09 10:52:07.763178611 -0700
@@ -1268,7 +1268,11 @@
             pass
 
     def get_info_from_sysfs(self):
-        self.find_capability(0x11)
+        try:
+            self.find_capability(0x11)
+        except PciDeviceParseError, err:
+            log.error("Caught '%s'" % err)
+             return False
         sysfs_mnt = find_sysfs_mnt()
         if sysfs_mnt == None:
             return False
diff -Naur xen/tools/python/xen/xend/XendAPI.py xenb/tools/python/xen/xend/XendAPI.py
--- xen/tools/python/xen/xend/XendAPI.py	2013-03-09 10:39:52.463178611 -0700
+++ xenb/tools/python/xen/xend/XendAPI.py	2013-03-09 10:52:07.763178611 -0700
@@ -1941,10 +1941,10 @@
                               bool(live), port, node, ssl, bool(chs))
         return xen_api_success_void()
 
-    def VM_save(self, _, vm_ref, dest, checkpoint):
+    def VM_save(self, _, vm_ref, dest, checkpoint, force):
         xendom = XendDomain.instance()
         xeninfo = xendom.get_vm_by_uuid(vm_ref)
-        xendom.domain_save(xeninfo.getDomid(), dest, checkpoint)
+        xendom.domain_save(xeninfo.getDomid(), dest, checkpoint, force)
         return xen_api_success_void()
 
     def VM_restore(self, _, src, paused):
diff -Naur xen/tools/python/xen/xend/XendAPIConstants.py xenb/tools/python/xen/xend/XendAPIConstants.py
--- xen/tools/python/xen/xend/XendAPIConstants.py	2013-03-09 10:39:52.463178611 -0700
+++ xenb/tools/python/xen/xend/XendAPIConstants.py	2013-03-09 10:52:07.763178611 -0700
@@ -45,8 +45,10 @@
 XEN_API_ON_CRASH_BEHAVIOUR = [
     'destroy',
     'coredump_and_destroy',
+    'coredump_destroy',
     'restart',
     'coredump_and_restart',
+    'coredump_restart',
     'preserve',
     'rename_restart'
 ]
diff -Naur xen/tools/python/xen/xend/XendCheckpoint.py xenb/tools/python/xen/xend/XendCheckpoint.py
--- xen/tools/python/xen/xend/XendCheckpoint.py	2013-03-09 10:39:52.466511944 -0700
+++ xenb/tools/python/xen/xend/XendCheckpoint.py	2013-03-09 10:52:07.766511944 -0700
@@ -172,7 +172,7 @@
             dominfo.destroy()
             dominfo.testDeviceComplete()
         try:
-            dominfo.setName(domain_name, False)
+            dominfo.setName(domain_name)
         except VmError:
             # Ignore this.  The name conflict (hopefully) arises because we
             # are doing localhost migration; if we are doing a suspend of a
diff -Naur xen/tools/python/xen/xend/XendConfig.py xenb/tools/python/xen/xend/XendConfig.py
--- xen/tools/python/xen/xend/XendConfig.py	2013-03-09 10:39:52.466511944 -0700
+++ xenb/tools/python/xen/xend/XendConfig.py	2013-03-09 10:52:07.766511944 -0700
@@ -147,6 +147,9 @@
     'apic': int,
     'boot': str,
     'device_model': str,
+    'actmem': str,
+    'xenpaging_file': str,
+    'xenpaging_extra': str,
     'loader': str,
     'display' : str,
     'fda': str,
@@ -159,6 +162,7 @@
     'nographic': int,
     'nomigrate': int,
     'pae' : int,
+    'extid': int,
     'rtc_timeoffset': int,
     'parallel': str,
     'serial': str,
@@ -192,6 +196,8 @@
     'xen_platform_pci': int,
     "gfx_passthru": int,
     'oos' : int,
+    'watchdog': str,
+    'watchdog_action': str,
 }
 
 # Xen API console 'other_config' keys.
@@ -512,8 +518,16 @@
             self['platform']['nomigrate'] = 0
 
         if self.is_hvm():
+            if 'actmem' not in self['platform']:
+                self['platform']['actmem'] = "0"
+            if 'xenpaging_file' not in self['platform']:
+                self['platform']['xenpaging_file'] = ""
+            if 'xenpaging_extra' not in self['platform']:
+                self['platform']['xenpaging_extra'] = []
             if 'timer_mode' not in self['platform']:
                 self['platform']['timer_mode'] = 1
+            if 'extid' in self['platform'] and int(self['platform']['extid']) == 1:
+                self['platform']['viridian'] = 1
             if 'viridian' not in self['platform']:
                 self['platform']['viridian'] = 0
             if 'rtc_timeoffset' not in self['platform']:
@@ -1865,7 +1879,14 @@
         ports = sxp.child(dev_sxp, 'port')
         for port in ports[1:]:
             try:
-                num, bus = port
+                # When ['port' ['1','']] is saved into sxp file, it will become (port (1 ))
+                # If using this sxp file, here variable "port" will be port=1,
+                # we should process it, otherwise, it will report error.
+                if len(port) == 1:
+                    num = port[0]
+                    bus = ""
+                else:
+                    num, bus = port
                 dev_config['port-%i' % int(num)] = str(bus)
             except TypeError:
                 pass
diff -Naur xen/tools/python/xen/xend/XendDomain.py xenb/tools/python/xen/xend/XendDomain.py
--- xen/tools/python/xen/xend/XendDomain.py	2013-03-09 10:39:52.466511944 -0700
+++ xenb/tools/python/xen/xend/XendDomain.py	2013-03-09 10:52:07.766511944 -0700
@@ -1505,7 +1505,7 @@
                     pass
                 sock.close()
 
-    def domain_save(self, domid, dst, checkpoint=False):
+    def domain_save(self, domid, dst, checkpoint=False, force=False):
         """Start saving a domain to file.
 
         @param domid: Domain ID or Name
@@ -1521,6 +1521,9 @@
             if not dominfo:
                 raise XendInvalidDomain(str(domid))
 
+            if os.access(dst, os.F_OK) and not force:
+                raise XendError("Save file:%s exist!\n" % dst)
+
             if dominfo.getDomid() == DOM0_ID:
                 raise XendError("Cannot save privileged domain %s" % str(domid))
             if dominfo._stateGet() != DOM_STATE_RUNNING:
@@ -1832,6 +1835,21 @@
             log.exception(ex)
             raise XendError(str(ex))
 
+    def domain_swaptarget_set(self, domid, mem):
+        """Set the memory limit for a domain.
+
+        @param domid: Domain ID or Name
+        @type domid: int or string.
+        @param mem: memory limit (in MiB)
+        @type mem: int
+        @raise XendError: fail to set memory
+        @rtype: 0
+        """
+        dominfo = self.domain_lookup_nr(domid)
+        if not dominfo:
+            raise XendInvalidDomain(str(domid))
+        dominfo.setSwapTarget(mem)
+
     def domain_maxmem_set(self, domid, mem):
         """Set the memory limit for a domain.
 
diff -Naur xen/tools/python/xen/xend/XendDomainInfo.py xenb/tools/python/xen/xend/XendDomainInfo.py
--- xen/tools/python/xen/xend/XendDomainInfo.py	2013-03-09 10:39:52.466511944 -0700
+++ xenb/tools/python/xen/xend/XendDomainInfo.py	2013-03-09 10:52:07.766511944 -0700
@@ -1295,8 +1295,15 @@
                 frontpath = self.getDeviceController(deviceClass).frontendPath(dev)
                 backpath = xstransact.Read(frontpath, "backend")
                 thread.start_new_thread(self.getDeviceController(deviceClass).finishDeviceCleanup, (backpath, path))
-
-            rc = self.getDeviceController(deviceClass).destroyDevice(devid, force)
+            if deviceClass =='vusb':
+                dev = self.getDeviceController(deviceClass).convertToDeviceNumber(devid)
+                state = self.getDeviceController(deviceClass).readBackend(dev, 'state')
+                if state == '1':
+                    rc = self.getDeviceController(deviceClass).destroyDevice(devid, True)
+                else:
+                    rc = self.getDeviceController(deviceClass).destroyDevice(devid, force)
+            else:
+                rc = self.getDeviceController(deviceClass).destroyDevice(devid, force)
             if not force and rm_cfg:
                 # The backend path, other than the device itself,
                 # has to be passed because its accompanied frontend
@@ -1459,6 +1466,17 @@
         pci_conf = self.info['devices'][dev_uuid][1]
         return map(pci_dict_to_bdf_str, pci_conf['devs'])
 
+    def setSwapTarget(self, target):
+        """Set the swap target of this domain.
+        @param target: In MiB.
+        """
+        log.debug("Setting swap target of domain %s (%s) to %d MiB.",
+                  self.info['name_label'], str(self.domid), target)
+
+        if self.domid > 0:
+            self.storeDom("memory/target-tot_pages", target * 1024)
+            self.info['platform']['actmem'] = str(target)
+
     def setMemoryTarget(self, target):
         """Set the memory target of this domain.
         @param target: In MiB.
@@ -2247,6 +2265,8 @@
                  self.info['name_label'], self.domid, self.info['uuid'],
                  new_name, new_uuid)
         self._unwatchVm()
+        if self.image:
+            self.image.destroyXenPaging()
         self._releaseDevices()
         # Remove existing vm node in xenstore
         self._removeVm()
@@ -2884,7 +2904,7 @@
 
             self.guest_bitsize = self.image.getBitSize()
             # Make sure there's enough RAM available for the domain
-            balloon.free(memory + shadow + vtd_mem, self)
+            balloon.free(memory + shadow + vtd_mem + 512, self)
 
             # Set up the shadow memory
             shadow_cur = xc.shadow_mem_control(self.domid, shadow / 1024)
@@ -2919,6 +2939,9 @@
 
             self._createDevices()
 
+            if self.image:
+                self.image.createXenPaging()
+
             self.image.cleanupTmpImages()
 
             self.info['start_time'] = time.time()
@@ -2943,6 +2966,8 @@
         self.refresh_shutdown_lock.acquire()
         try:
             self.unwatchShutdown()
+            if self.image:
+                self.image.destroyXenPaging()
             self._releaseDevices()
             bootloader_tidy(self)
 
@@ -3027,6 +3052,7 @@
         self.refreshShutdown()
 
         log.debug("XendDomainInfo.completeRestore done")
+            self.image.createXenPaging()
 
 
     def _endRestore(self):
@@ -3157,6 +3183,8 @@
             # could also fetch a parsed note from xenstore
             fast = self.info.get_notes().get('SUSPEND_CANCEL') and 1 or 0
             if not fast:
+                if self.image:
+                    self.image.destroyXenPaging()
                 self._releaseDevices()
                 self.testDeviceComplete()
                 self.testvifsComplete()
@@ -3172,6 +3200,8 @@
                 self._storeDomDetails()
 
                 self._createDevices()
+                if self.image:
+                    self.image.createXenPaging()
                 log.debug("XendDomainInfo.resumeDomain: devices created")
 
             xc.domain_resume(self.domid, fast)
@@ -3908,6 +3938,14 @@
             else:
                 config['mode'] = 'RW'
 
+        if dev_class == 'console':
+            if not config.has_key('protocol'):
+                con_type = config.get('type', '')
+                if con_type == 'vnc':
+                    config['protocol'] = 'rfb'
+                elif con_type == 'sdl':
+                    config['protocol'] = 'rdp'
+
         return config
 
     def get_dev_property(self, dev_class, dev_uuid, field):
diff -Naur xen/tools/python/xen/xend/image.py xenb/tools/python/xen/xend/image.py
--- xen/tools/python/xen/xend/image.py	2013-03-09 10:39:52.469845278 -0700
+++ xenb/tools/python/xen/xend/image.py	2013-03-09 10:52:07.769845277 -0700
@@ -122,6 +122,10 @@
         self.vm.permissionsVm("image/cmdline", { 'dom': self.vm.getDomid(), 'read': True } )
 
         self.device_model = vmConfig['platform'].get('device_model')
+        self.actmem = str(vmConfig['platform'].get('actmem'))
+        self.xenpaging_file = str(vmConfig['platform'].get('xenpaging_file'))
+        self.xenpaging_extra = vmConfig['platform'].get('xenpaging_extra')
+        self.xenpaging_pid = None
 
         self.display = vmConfig['platform'].get('display')
         self.xauthority = vmConfig['platform'].get('xauthority')
@@ -392,6 +396,87 @@
         sentinel_fifos_inuse[sentinel_path_fifo] = 1
         self.sentinel_path_fifo = sentinel_path_fifo
 
+    def createXenPaging(self):
+        if not self.vm.info.is_hvm():
+            return
+        if self.actmem == "0":
+            return
+        if self.xenpaging_pid:
+            return
+        xenpaging_bin = auxbin.pathTo("xenpaging")
+        args = [xenpaging_bin]
+        args = args + ([ "-f", "/var/lib/xen/xenpaging/%s.%d.paging" % (str(self.vm.info['name_label']), self.vm.getDomid())])
+        if self.xenpaging_extra:
+            args = args + (self.xenpaging_extra)
+        args = args + ([ "-d", "%d" % self.vm.getDomid()])
+        self.xenpaging_logfile = "/var/log/xen/xenpaging-%s.log" %  str(self.vm.info['name_label'])
+        logfile_mode = os.O_WRONLY|os.O_CREAT|os.O_APPEND|os.O_TRUNC
+        null = os.open("/dev/null", os.O_RDONLY)
+        try:
+            os.unlink(self.xenpaging_logfile)
+        except:
+            pass
+        logfd = os.open(self.xenpaging_logfile, logfile_mode, 0644)
+        sys.stderr.flush()
+        contract = osdep.prefork("%s:%d" % (self.vm.getName(), self.vm.getDomid()))
+        xenpaging_pid = os.fork()
+        if xenpaging_pid == 0: #child
+            try:
+                osdep.postfork(contract)
+                os.dup2(null, 0)
+                os.dup2(logfd, 1)
+                os.dup2(logfd, 2)
+                try:
+                    env = dict(os.environ)
+                    log.info("starting %s" % args)
+                    os.execve(xenpaging_bin, args, env)
+                except Exception, e:
+                    log.warn('failed to execute xenpaging: %s' % utils.exception_string(e))
+                    os._exit(126)
+            except:
+                log.warn("starting xenpaging failed")
+                os._exit(127)
+        else:
+            osdep.postfork(contract, abandon=True)
+            self.xenpaging_pid = xenpaging_pid
+            os.close(null)
+            os.close(logfd)
+        self.vm.storeDom("xenpaging/xenpaging-pid", self.xenpaging_pid)
+        self.vm.storeDom("memory/target-tot_pages", int(self.actmem) * 1024)
+
+    def destroyXenPaging(self):
+        if self.actmem == "0":
+            return
+        if self.xenpaging_pid:
+            try:
+                os.kill(self.xenpaging_pid, signal.SIGHUP)
+            except OSError, exn:
+                log.exception(exn)
+            for i in xrange(100):
+                try:
+                    (p, rv) = os.waitpid(self.xenpaging_pid, os.WNOHANG)
+                    if p == self.xenpaging_pid:
+                        break
+                except OSError:
+                    # This is expected if Xend has been restarted within
+                    # the life of this domain.  In this case, we can kill
+                    # the process, but we can't wait for it because it's
+                    # not our child. We continue this loop, and after it is
+                    # terminated make really sure the process is going away
+                    # (SIGKILL).
+                    pass
+                time.sleep(0.1)
+            else:
+                log.warning("xenpaging %d took more than 10s "
+                            "to terminate: sending SIGKILL" % self.xenpaging_pid)
+                try:
+                    os.kill(self.xenpaging_pid, signal.SIGKILL)
+                    os.waitpid(self.xenpaging_pid, 0)
+                except OSError:
+                    # This happens if the process doesn't exist.
+                    pass
+        self.xenpaging_pid = None
+
     def createDeviceModel(self, restore = False):
         if self.device_model is None:
             return
@@ -828,6 +913,7 @@
 
         self.apic = int(vmConfig['platform'].get('apic', 0))
         self.acpi = int(vmConfig['platform'].get('acpi', 0))
+        self.extid = int(vmConfig['platform'].get('extid', 0))
         self.guest_os_type = vmConfig['platform'].get('guest_os_type')
         self.memory_sharing = int(vmConfig['memory_sharing'])
         try:
@@ -855,7 +941,8 @@
 
         dmargs = [ 'boot', 'fda', 'fdb', 'soundhw',
                    'localtime', 'serial', 'stdvga', 'isa',
-                   'acpi', 'usb', 'usbdevice', 'gfx_passthru' ]
+                   'acpi', 'usb', 'usbdevice', 'gfx_passthru',
+                   'watchdog', 'watchdog_action' ]
 
         for a in dmargs:
             v = vmConfig['platform'].get(a)
@@ -863,6 +950,7 @@
             # python doesn't allow '-' in variable names
             if a == 'stdvga': a = 'std-vga'
             if a == 'keymap': a = 'k'
+            if a == 'watchdog_action': a = 'watchdog-action'
 
             # Handle booleans gracefully
             if a in ['localtime', 'std-vga', 'isa', 'usb', 'acpi']:
@@ -1036,7 +1124,7 @@
 
     def configure(self, vmConfig):
         HVMImageHandler.configure(self, vmConfig)
-        self.pae = int(vmConfig['platform'].get('pae',  0))
+        self.pae = int(vmConfig['platform'].get('pae',  1))
         self.vramsize = int(vmConfig['platform'].get('videoram',4)) * 1024
 
     def buildDomain(self):
diff -Naur xen/tools/python/xen/xm/cpupool.py xenb/tools/python/xen/xm/cpupool.py
--- xen/tools/python/xen/xm/cpupool.py	2013-03-09 10:39:52.476511944 -0700
+++ xenb/tools/python/xen/xm/cpupool.py	2013-03-09 10:52:07.769845277 -0700
@@ -157,9 +157,17 @@
             #    ["0,2","1,3"]       -> [[0,2],[1,3]]
             #    ["0-3,^1","1-4,^2"] -> [[0,2,3],[1,3,4]]
             try:
-                for c in cfg_cpus:
-                    cpus = cnv(c)
-                    cpus_list.append(cpus)
+                cpus_str = ""
+                list_len = len(cfg_cpus)
+                n = 0
+                while n < list_len:
+                    if type(cfg_cpus[n]) != str:
+                        raise SyntaxError('cpus = %s' % cfg_cpus)
+                    cpus_str += cfg_cpus[n]
+                    n += 1
+                    if n < list_len:
+                        cpus_str += ', '
+                cpus_list = cnv(cpus_str)
             except ValueError, e:
                 raise err('cpus = %s: %s' % (cfg_cpus, e))
     else:
diff -Naur xen/tools/python/xen/xm/create.py xenb/tools/python/xen/xm/create.py
--- xen/tools/python/xen/xm/create.py	2013-03-09 10:39:52.479845277 -0700
+++ xenb/tools/python/xen/xm/create.py	2013-03-09 10:52:07.769845277 -0700
@@ -36,7 +36,7 @@
 from xen.util import blkif
 from xen.util import vscsi_util
 import xen.util.xsm.xsm as security
-from xen.xm.main import serverType, SERVER_XEN_API, get_single_vm
+from xen.xm.main import serverType, SERVER_XEN_API, SERVER_LEGACY_XMLRPC, get_single_vm
 from xen.util import utils, auxbin
 from xen.util.pci import dev_dict_to_sxp, \
                          parse_pci_name_extended, PciDeviceParseError
@@ -242,6 +242,10 @@
           use="""Expose Viridian interface to x86 HVM guest?
           (Default is 0).""")
 
+gopts.var('extid', val='EXTID',
+          fn=set_int, default=0,
+          use="Specify extention ID for a HVM domain.")
+
 gopts.var('acpi', val='ACPI',
           fn=set_int, default=1,
           use="Disable or enable ACPI of HVM domain.")
@@ -473,6 +477,18 @@
           fn=set_value, default=None,
           use="Set the path of the root NFS directory.")
 
+gopts.var('actmem', val='NUM',
+          fn=set_value, default='0',
+          use="Number of pages to swap.")
+
+gopts.var('xenpaging_file', val='PATH',
+          fn=set_value, default=None,
+          use="pagefile to use (optional)")
+
+gopts.var('xenpaging_extra', val='string1,string2',
+          fn=append_value, default=[],
+          use="additional args for xenpaging (optional)")
+
 gopts.var('device_model', val='FILE',
           fn=set_value, default=None,
           use="Path to device model program.")
@@ -517,6 +533,21 @@
           fn=set_value, default='',
           use="Name of USB device to add?")
 
+gopts.var('watchdog', val='NAME',
+          fn=set_value, default='',
+          use="Watchdog device to use. May be ib700 or i6300esb")
+
+gopts.var('watchdog_action', val='reset|shutdown|poweroff|pause|none|dump',
+          fn=set_value, default="reset",
+          use="""Action when watchdog timer expires:
+          - reset:     Default, forcefully reset the guest;
+          - shutdown:  Gracefully shutdown the guest (not recommended);
+          - poweroff:  Forcefully power off the guest;
+          - pause:     Pause the guest;
+          - none:      Do nothing;
+          - dump:      Automatically dump the guest;
+          """)
+
 gopts.var('description', val='NAME',
           fn=set_value, default='',
           use="Description of a domain")
@@ -1032,6 +1063,9 @@
     args = [ 'acpi', 'apic',
              'boot',
              'cpuid', 'cpuid_check',
+             'actmem',
+             'xenpaging_file',
+             'xenpaging_extra',
              'device_model', 'display',
              'fda', 'fdb',
              'gfx_passthru', 'guest_os_type',
@@ -1047,7 +1081,7 @@
              'timer_mode',
              'usb', 'usbdevice',
              'vcpus', 'vnc', 'vncconsole', 'vncdisplay', 'vnclisten',
-             'vncunused', 'viridian', 'vpt_align',
+             'vncunused', 'vpt_align',
              'xauthority', 'xen_extended_power_mgmt', 'xen_platform_pci',
              'memory_sharing' ]
 
@@ -1056,6 +1090,10 @@
             config_image.append([a, vals.__dict__[a]])
     if vals.vncpasswd is not None:
         config_image.append(['vncpasswd', vals.vncpasswd])
+    if vals.extid and vals.extid == 1:
+        config_image.append(['viridian', vals.extid])
+    elif vals.viridian:
+        config_image.append(['viridian', vals.viridian])
 
 
 def make_config(vals):
@@ -1072,6 +1110,7 @@
         if hasattr(vals, 'vcpus'):
             vcpus = getattr(vals, 'vcpus')
 
+             'watchdog', 'watchdog_action',
         if maxvcpus and not vcpus:
             config.append(['vcpus', maxvcpus])
         if maxvcpus and vcpus:
@@ -1465,7 +1504,7 @@
             except IOError, exn:
                 raise OptionError("Cannot read file %s: %s" % (config, exn[1]))
         
-        if serverType == SERVER_XEN_API:
+        if serverType == SERVER_XEN_API or serverType == SERVER_LEGACY_XMLRPC:
             from xen.xm.xenapi_create import sxp2xml
             sxp2xml_inst = sxp2xml()
             doc = sxp2xml_inst.convert_sxp_to_xml(config, transient=True)
@@ -1473,7 +1512,7 @@
         if opts.vals.dryrun and not opts.is_xml:
             SXPPrettyPrint.prettyprint(config)
 
-        if opts.vals.xmldryrun and serverType == SERVER_XEN_API:
+        if opts.vals.xmldryrun:
             print doc.toprettyxml()
 
     if opts.vals.dryrun or opts.vals.xmldryrun:
diff -Naur xen/tools/python/xen/xm/main.py xenb/tools/python/xen/xm/main.py
--- xen/tools/python/xen/xm/main.py	2013-03-09 10:39:52.479845277 -0700
+++ xenb/tools/python/xen/xm/main.py	2013-03-09 10:52:07.769845277 -0700
@@ -114,6 +114,8 @@
                      'Set the maximum amount reservation for a domain.'),
     'mem-set'     : ('<Domain> <Mem>',
                      'Set the current memory usage for a domain.'),
+    'mem-swap-target' : ('<Domain> <Mem>',
+                     'Set the memory usage for a domain.'),
     'migrate'     : ('<Domain> <Host>',
                      'Migrate a domain to another machine.'),
     'pause'       : ('<Domain>', 'Pause execution of a domain.'),
@@ -121,7 +123,7 @@
     'reset'       : ('<Domain>', 'Reset a domain.'),
     'restore'     : ('<CheckpointFile> [-p]',
                      'Restore a domain from a saved state.'),
-    'save'        : ('[-c] <Domain> <CheckpointFile>',
+    'save'        : ('[-c|-f] <Domain> <CheckpointFile>',
                      'Save a domain state to restore later.'),
     'shutdown'    : ('<Domain> [-waRH]', 'Shutdown a domain.'),
     'top'         : ('', 'Monitor a host and the domains in real time.'),
@@ -341,6 +343,7 @@
     ),
     'save': (
        ('-c', '--checkpoint', 'Leave domain running after creating snapshot'),
+       ('-f', '--force', 'Force to overwrite exist file'),
     ),
     'restore': (
        ('-p', '--paused', 'Do not unpause domain after restoring it'),
@@ -862,18 +865,21 @@
 
 def xm_save(args):
 
-    arg_check(args, "save", 2, 3)
+    arg_check(args, "save", 2, 4)
     
     try:
-        (options, params) = getopt.gnu_getopt(args, 'c', ['checkpoint'])
+        (options, params) = getopt.gnu_getopt(args, 'cf', ['checkpoint', 'force'])
     except getopt.GetoptError, opterr:
         err(opterr)
         usage('save')
 
     checkpoint = False
+    force = False
     for (k, v) in options:
         if k in ['-c', '--checkpoint']:
             checkpoint = True
+        if k in ['-f', '--force']:
+            force = True
 
     if len(params) != 2:
         err("Wrong number of parameters")
@@ -1580,6 +1586,17 @@
         mem_target = int_unit(args[1], 'm')
         server.xend.domain.setMemoryTarget(dom, mem_target)
 
+def xm_mem_swap_target(args):
+    arg_check(args, "mem-swap-target", 2)
+
+    dom = args[0]
+
+    if serverType == SERVER_XEN_API:
+        err("xenapi not supported")
+    else:
+        swap_target = int_unit(args[1], 'm')
+        server.xend.domain.swaptarget_set(dom, swap_target)
+
 def xm_usb_add(args):
     arg_check(args, "usb-add", 2)
     server.xend.domain.usb_add(args[0],args[1])
@@ -3782,6 +3799,7 @@
     # memory commands
     "mem-max": xm_mem_max,
     "mem-set": xm_mem_set,
+    "mem-swap-target": xm_mem_swap_target,
     # cpu commands
     "vcpu-pin": xm_vcpu_pin,
     "vcpu-list": xm_vcpu_list,
diff -Naur xen/tools/python/xen/xm/xenapi_create.py xenb/tools/python/xen/xm/xenapi_create.py
--- xen/tools/python/xen/xm/xenapi_create.py	2013-03-09 10:39:52.479845277 -0700
+++ xenb/tools/python/xen/xm/xenapi_create.py	2013-03-09 10:52:07.769845277 -0700
@@ -1046,6 +1046,9 @@
             'acpi',
             'apic',
             'boot',
+            'actmem',
+            'xenpaging_file',
+            'xenpaging_extra',
             'device_model',
             'loader',
             'fda',
@@ -1074,7 +1077,9 @@
             'xen_platform_pci',
             'tsc_mode'
             'description',
-            'nomigrate'
+            'nomigrate',
+            'watchdog',
+            'watchdog_action'
         ]
 
         platform_configs = []
diff -Naur xen/tools/tests/mce-test/tools/Makefile xenb/tools/tests/mce-test/tools/Makefile
--- xen/tools/tests/mce-test/tools/Makefile	2013-03-09 10:39:52.503178611 -0700
+++ xenb/tools/tests/mce-test/tools/Makefile	2013-03-09 10:52:07.769845277 -0700
@@ -1,7 +1,7 @@
 XEN_ROOT=$(CURDIR)/../../../..
 include $(XEN_ROOT)/tools/Rules.mk
 
-CFLAGS += -Werror
+CFLAGS +=
 CFLAGS += $(CFLAGS_libxenctrl)
 CFLAGS += $(CFLAGS_libxenguest)
 CFLAGS += $(CFLAGS_libxenstore) 
diff -Naur xen/tools/tests/mem-sharing/Makefile xenb/tools/tests/mem-sharing/Makefile
--- xen/tools/tests/mem-sharing/Makefile	2013-03-09 10:39:52.506511944 -0700
+++ xenb/tools/tests/mem-sharing/Makefile	2013-03-09 10:52:07.769845277 -0700
@@ -1,7 +1,7 @@
 XEN_ROOT=$(CURDIR)/../../..
 include $(XEN_ROOT)/tools/Rules.mk
 
-CFLAGS += -Werror
+CFLAGS +=
 
 CFLAGS += $(CFLAGS_libxenctrl)
 CFLAGS += $(CFLAGS_xeninclude)
diff -Naur xen/tools/tests/xen-access/Makefile xenb/tools/tests/xen-access/Makefile
--- xen/tools/tests/xen-access/Makefile	2013-03-09 10:39:52.516511944 -0700
+++ xenb/tools/tests/xen-access/Makefile	2013-03-09 10:52:07.773178611 -0700
@@ -1,7 +1,7 @@
 XEN_ROOT=$(CURDIR)/../../..
 include $(XEN_ROOT)/tools/Rules.mk
 
-CFLAGS += -Werror
+CFLAGS +=
 
 CFLAGS += $(CFLAGS_libxenctrl)
 CFLAGS += $(CFLAGS_libxenguest)
diff -Naur xen/tools/xenbackendd/xenbackendd.c xenb/tools/xenbackendd/xenbackendd.c
--- xen/tools/xenbackendd/xenbackendd.c	2013-03-09 10:39:52.516511944 -0700
+++ xenb/tools/xenbackendd/xenbackendd.c	2013-03-09 10:52:07.773178611 -0700
@@ -48,7 +48,7 @@
 #define LOG_FILE "/var/log/xen/xenbackendd.log"
 #endif
 #ifndef PID_FILE
-#define PID_FILE "/var/run/xenbackendd.pid"
+#define PID_FILE "/run/xenbackendd.pid"
 #endif
 
 
diff -Naur xen/tools/xenballoon/xenballoon.conf xenb/tools/xenballoon/xenballoon.conf
--- xen/tools/xenballoon/xenballoon.conf	2013-03-09 10:39:52.516511944 -0700
+++ xenb/tools/xenballoon/xenballoon.conf	2013-03-09 10:52:07.773178611 -0700
@@ -61,13 +61,13 @@
 XENBALLOON_MINMEM=0
 
 ## Type: string
-## Default: "/var/run/xenballoon-maxmem"
+## Default: "/run/xenballoon-maxmem"
 #
 # Location where memory high-water mark is stored; if a guest supports
 # hot-add memory, maxmem might increase across time and the minimum
 # target heuristic is based on max memory. NOTE: Reboot after changing
 # this variable, else overballooning may occur.
-XENBALLOON_MAXMEMFILE=/var/run/xenballoon-maxmem
+XENBALLOON_MAXMEMFILE=/run/xenballoon-maxmem
 
 ## Type: integer (0 or 1)
 ## Default: 1
diff -Naur xen/tools/xenmon/xenbaked.c xenb/tools/xenmon/xenbaked.c
--- xen/tools/xenmon/xenbaked.c	2013-03-09 10:39:52.519845277 -0700
+++ xenb/tools/xenmon/xenbaked.c	2013-03-09 10:52:07.773178611 -0700
@@ -645,7 +645,7 @@
     }
 }
 
-#define SHARED_MEM_FILE "/var/run/xenq-shm"
+#define SHARED_MEM_FILE "/run/xenq-shm"
 static void alloc_qos_data(int ncpu)
 {
     int i, n, pgsize, off=0;
diff -Naur xen/tools/xenmon/xenmon.py xenb/tools/xenmon/xenmon.py
--- xen/tools/xenmon/xenmon.py	2013-03-09 10:39:52.519845277 -0700
+++ xenb/tools/xenmon/xenmon.py	2013-03-09 10:52:07.843178611 -0700
@@ -46,7 +46,7 @@
 QOS_DATA_SIZE = struct.calcsize(ST_QDATA)*NSAMPLES + struct.calcsize(ST_DOM_INFO)*NDOMAINS + struct.calcsize("4i")
 
 # location of mmaped file, hard coded right now
-SHM_FILE = "/var/run/xenq-shm"
+SHM_FILE = "/run/xenq-shm"
 
 # format strings
 TOTALS = 15*' ' + "%6.2f%%" + 35*' ' + "%6.2f%%"
diff -Naur xen/tools/xenstat/xentop/Makefile xenb/tools/xenstat/xentop/Makefile
--- xen/tools/xenstat/xentop/Makefile	2013-03-09 10:39:52.533178611 -0700
+++ xenb/tools/xenstat/xentop/Makefile	2013-03-09 10:52:07.843178611 -0700
@@ -18,7 +18,7 @@
 all install xentop:
 else
 
-CFLAGS += -DGCC_PRINTF -Wall -Werror $(CFLAGS_libxenstat)
+CFLAGS += -DGCC_PRINTF -Wall $(CFLAGS_libxenstat)
 LDLIBS += $(LDLIBS_libxenstat) $(CURSES_LIBS) $(SOCKET_LIBS)
 CFLAGS += -DHOST_$(XEN_OS)
 
diff -Naur xen/tools/xenstore/Makefile xenb/tools/xenstore/Makefile
--- xen/tools/xenstore/Makefile	2013-03-09 10:39:52.533178611 -0700
+++ xenb/tools/xenstore/Makefile	2013-03-09 10:52:07.843178611 -0700
@@ -110,7 +110,7 @@
 	$(INSTALL_DIR) $(DESTDIR)$(SBINDIR)
 	$(INSTALL_DIR) $(DESTDIR)$(INCLUDEDIR)
 	$(INSTALL_DIR) $(DESTDIR)$(INCLUDEDIR)/xenstore-compat
-	$(INSTALL_DIR) $(DESTDIR)/var/run/xenstored
+	$(INSTALL_DIR) $(DESTDIR)/run/xenstored
 	$(INSTALL_DIR) $(DESTDIR)/var/lib/xenstored
 	$(INSTALL_PROG) xenstored $(DESTDIR)$(SBINDIR)
 	$(INSTALL_PROG) xenstore-control $(DESTDIR)$(BINDIR)
diff -Naur xen/tools/xenstore/xenstore.h xenb/tools/xenstore/xenstore.h
--- xen/tools/xenstore/xenstore.h	2013-03-09 10:39:52.533178611 -0700
+++ xenb/tools/xenstore/xenstore.h	2013-03-09 10:52:07.843178611 -0700
@@ -26,6 +26,7 @@
 
 #define XS_OPEN_READONLY	1UL<<0
 #define XS_OPEN_SOCKETONLY      1UL<<1
+#define XS_OPEN_DOMAINONLY      1UL<<2
 
 /*
  * Setting XS_UNWATCH_FILTER arranges that after xs_unwatch, no
diff -Naur xen/tools/xenstore/xenstore_client.c xenb/tools/xenstore/xenstore_client.c
--- xen/tools/xenstore/xenstore_client.c	2013-03-09 10:39:52.533178611 -0700
+++ xenb/tools/xenstore/xenstore_client.c	2013-03-09 10:52:07.843178611 -0700
@@ -629,7 +629,7 @@
 	    max_width = ws.ws_col - 2;
     }
 
-    xsh = xs_open(socket ? XS_OPEN_SOCKETONLY : 0);
+    xsh = xs_open(socket ? XS_OPEN_SOCKETONLY : XS_OPEN_DOMAINONLY);
     if (xsh == NULL) err(1, "xs_open");
 
 again:
diff -Naur xen/tools/xenstore/xs.c xenb/tools/xenstore/xs.c
--- xen/tools/xenstore/xs.c	2013-03-09 10:39:52.536511944 -0700
+++ xenb/tools/xenstore/xs.c	2013-03-09 10:52:07.843178611 -0700
@@ -278,17 +278,19 @@
 
 struct xs_handle *xs_domain_open(void)
 {
-	return xs_open(0);
+	return xs_open(XS_OPEN_DOMAINONLY);
 }
 
 struct xs_handle *xs_open(unsigned long flags)
 {
 	struct xs_handle *xsh = NULL;
 
+	if (!(flags & XS_OPEN_DOMAINONLY)) {
 	if (flags & XS_OPEN_READONLY)
 		xsh = get_handle(xs_daemon_socket_ro());
 	else
 		xsh = get_handle(xs_daemon_socket());
+	}
 
 	if (!xsh && !(flags & XS_OPEN_SOCKETONLY))
 		xsh = get_handle(xs_domain_dev());
diff -Naur xen/tools/xenstore/xs_lib.c xenb/tools/xenstore/xs_lib.c
--- xen/tools/xenstore/xs_lib.c	2013-03-09 10:39:52.536511944 -0700
+++ xenb/tools/xenstore/xs_lib.c	2013-03-09 10:52:07.843178611 -0700
@@ -36,7 +36,7 @@
 const char *xs_daemon_rundir(void)
 {
 	char *s = getenv("XENSTORED_RUNDIR");
-	return (s ? s : "/var/run/xenstored");
+	return (s ? s : "/run/xenstored");
 }
 
 static const char *xs_daemon_path(void)
diff -Naur xen/unmodified_drivers/linux-2.6/Module.supported xenb/unmodified_drivers/linux-2.6/Module.supported
--- xen/unmodified_drivers/linux-2.6/Module.supported	1969-12-31 17:00:00.000000000 -0700
+++ xenb/unmodified_drivers/linux-2.6/Module.supported	2013-03-09 10:52:07.843178611 -0700
@@ -0,0 +1,6 @@
+xen-vbd
+xen-platform-pci
+xen-vnif
+xenbus
+xen-balloon
+xen-scsi
diff -Naur xen/unmodified_drivers/linux-2.6/platform-pci/evtchn.c xenb/unmodified_drivers/linux-2.6/platform-pci/evtchn.c
--- xen/unmodified_drivers/linux-2.6/platform-pci/evtchn.c	2013-03-09 10:39:52.606511944 -0700
+++ xenb/unmodified_drivers/linux-2.6/platform-pci/evtchn.c	2013-03-09 10:52:07.843178611 -0700
@@ -40,7 +40,9 @@
 #include <xen/platform-compat.h>
 #endif
 
+#ifndef shared_info_area
 void *shared_info_area;
+#endif
 
 #define is_valid_evtchn(x)	((x) != 0)
 #define evtchn_from_irq(x)	(irq_evtchn[irq].evtchn)
diff -Naur xen/unmodified_drivers/linux-2.6/platform-pci/platform-pci.c xenb/unmodified_drivers/linux-2.6/platform-pci/platform-pci.c
--- xen/unmodified_drivers/linux-2.6/platform-pci/platform-pci.c	2013-03-09 10:39:52.606511944 -0700
+++ xenb/unmodified_drivers/linux-2.6/platform-pci/platform-pci.c	2013-03-09 10:52:07.846511944 -0700
@@ -27,6 +27,7 @@
 #include <linux/pci.h>
 #include <linux/init.h>
 #include <linux/version.h>
+#include <linux/dmi.h>
 #include <linux/interrupt.h>
 #include <linux/vmalloc.h>
 #include <linux/mm.h>
@@ -76,7 +77,6 @@
 static int __devinit init_xen_info(void)
 {
 	struct xen_add_to_physmap xatp;
-	extern void *shared_info_area;
 
 #ifdef __ia64__
 	xencomm_initialize();
@@ -84,6 +84,7 @@
 
 	setup_xen_features();
 
+#ifndef shared_info_area
 	shared_info_frame = alloc_xen_mmio(PAGE_SIZE) >> PAGE_SHIFT;
 	xatp.domid = DOMID_SELF;
 	xatp.idx = 0;
@@ -96,6 +97,11 @@
 		ioremap(shared_info_frame << PAGE_SHIFT, PAGE_SIZE);
 	if (shared_info_area == NULL)
 		panic("can't map shared info\n");
+#else
+	shared_info_frame = __pa(shared_info_area) >> PAGE_SHIFT;
+	printk(KERN_INFO "Using kernel provided shared info (pfn=%lx)\n",
+	       shared_info_frame);
+#endif
 
 	return 0;
 }
@@ -469,6 +475,18 @@
 
 MODULE_DEVICE_TABLE(pci, platform_pci_tbl);
 
+static const struct dmi_system_id platform_dmi_tbl[] = {
+	{
+		.ident = "Xen PV-on-HVM",
+		.matches = {
+			DMI_MATCH(DMI_SYS_VENDOR, "Xen"),
+			DMI_MATCH(DMI_PRODUCT_NAME, "HVM domU"),
+		},
+	},
+	{ },
+};
+MODULE_DEVICE_TABLE(dmi, platform_dmi_tbl);
+
 static struct pci_driver platform_driver = {
 	name:     DRV_NAME,
 	probe:    platform_pci_init,
diff -Naur xen/unmodified_drivers/linux-2.6/platform-pci/platform-pci.h xenb/unmodified_drivers/linux-2.6/platform-pci/platform-pci.h
--- xen/unmodified_drivers/linux-2.6/platform-pci/platform-pci.h	2013-03-09 10:39:52.606511944 -0700
+++ xenb/unmodified_drivers/linux-2.6/platform-pci/platform-pci.h	2013-03-09 10:52:07.846511944 -0700
@@ -27,6 +27,11 @@
 unsigned long alloc_xen_mmio(unsigned long len);
 void platform_pci_resume(void);
 
+#ifdef CONFIG_ENLIGHTEN_SPINLOCKS
+#define shared_info_area xen_shared_info
+#endif
+extern void *shared_info_area;
+
 extern struct pci_dev *xen_platform_pdev;
 
 #endif /* _XEN_PLATFORM_PCI_H */
diff -Naur xen/xen/Makefile xenb/xen/Makefile
--- xen/xen/Makefile	2013-03-09 10:39:52.616511944 -0700
+++ xenb/xen/Makefile	2013-03-09 10:52:07.846511944 -0700
@@ -13,6 +13,8 @@
 export XEN_ROOT := $(BASEDIR)/..
 
 EFI_MOUNTPOINT ?= /boot/efi
+EFI_VENDOR=fedora
+LD_EFI ?= $(LD)
 
 .PHONY: default
 default: build
diff -Naur xen/xen/arch/arm/Rules.mk xenb/xen/arch/arm/Rules.mk
--- xen/xen/arch/arm/Rules.mk	2013-03-09 10:39:52.616511944 -0700
+++ xenb/xen/arch/arm/Rules.mk	2013-03-09 10:52:07.846511944 -0700
@@ -11,7 +11,7 @@
 HAS_ARM_HDLCD := y
 
 CFLAGS += -fno-builtin -fno-common -Wredundant-decls
-CFLAGS += -iwithprefix include -Werror -Wno-pointer-arith -pipe
+CFLAGS += -iwithprefix include -Wno-pointer-arith -pipe
 CFLAGS += -I$(BASEDIR)/include
 
 $(call cc-options-add,CFLAGS,CC,$(EMBEDDED_EXTRA_CFLAGS))
diff -Naur xen/xen/arch/arm/gic.c xenb/xen/arch/arm/gic.c
--- xen/xen/arch/arm/gic.c	2013-03-09 10:39:52.619845277 -0700
+++ xenb/xen/arch/arm/gic.c	2013-03-09 10:52:07.846511944 -0700
@@ -26,7 +26,6 @@
 #include <xen/errno.h>
 #include <xen/softirq.h>
 #include <xen/list.h>
-#include <xen/device_tree.h>
 #include <asm/p2m.h>
 #include <asm/domain.h>
 
@@ -43,7 +42,6 @@
     paddr_t dbase;       /* Address of distributor registers */
     paddr_t cbase;       /* Address of CPU interface registers */
     paddr_t hbase;       /* Address of virtual interface registers */
-    paddr_t vbase;       /* Address of virtual cpu interface registers */
     unsigned int lines;
     unsigned int cpus;
     spinlock_t lock;
@@ -334,10 +332,10 @@
          (early_info.gic.gic_vcpu_addr & ~PAGE_MASK) )
         panic("GIC interfaces not page aligned.\n");
 
-    gic.dbase = early_info.gic.gic_dist_addr;
-    gic.cbase = early_info.gic.gic_cpu_addr;
-    gic.hbase = early_info.gic.gic_hyp_addr;
-    gic.vbase = early_info.gic.gic_vcpu_addr;
+    /* XXX FIXME get this from devicetree */
+    gic.dbase = GIC_BASE_ADDRESS + GIC_DR_OFFSET;
+    gic.cbase = GIC_BASE_ADDRESS + GIC_CR_OFFSET;
+    gic.hbase = GIC_BASE_ADDRESS + GIC_HR_OFFSET;
     set_fixmap(FIXMAP_GICD, gic.dbase >> PAGE_SHIFT, DEV_SHARED);
     BUILD_BUG_ON(FIXMAP_ADDR(FIXMAP_GICC1) !=
                  FIXMAP_ADDR(FIXMAP_GICC2)-PAGE_SIZE);
@@ -612,9 +610,9 @@
 {
     /* map the gic virtual cpu interface in the gic cpu interface region of
      * the guest */
-    return map_mmio_regions(d, gic.cbase,
-                        gic.cbase + (2 * PAGE_SIZE) - 1,
-                        gic.vbase);
+    return map_mmio_regions(d, GIC_BASE_ADDRESS + GIC_CR_OFFSET,
+                        GIC_BASE_ADDRESS + GIC_CR_OFFSET + (2 * PAGE_SIZE) - 1,
+                        GIC_BASE_ADDRESS + GIC_VR_OFFSET);
 }
 
 static void maintenance_interrupt(int irq, void *dev_id, struct cpu_user_regs *regs)
diff -Naur xen/xen/arch/x86/Makefile xenb/xen/arch/x86/Makefile
--- xen/xen/arch/x86/Makefile	2013-03-09 10:39:52.623178611 -0700
+++ xenb/xen/arch/x86/Makefile	2013-03-09 10:52:07.846511944 -0700
@@ -112,7 +112,7 @@
 	    $(@D)/.$(@F).1.o -o $@
 	rm -f $(@D)/.$(@F).[0-9]*
 
-EFI_LDFLAGS = $(patsubst -m%,-mi386pep,$(LDFLAGS)) --subsystem=10
+EFI_LDFLAGS = -mi386pep $(patsubst -m%,-mi386pep,$(LDFLAGS)) --subsystem=10
 EFI_LDFLAGS += --image-base=$(1) --stack=0,0 --heap=0,0 --strip-debug
 EFI_LDFLAGS += --section-alignment=0x200000 --file-alignment=0x20
 EFI_LDFLAGS += --major-image-version=$(XEN_VERSION)
@@ -126,18 +126,18 @@
 $(TARGET).efi: guard = $(if $(shell echo efi/dis* | grep disabled),:)
 $(TARGET).efi: prelink-efi.o efi.lds efi/relocs-dummy.o $(BASEDIR)/common/symbols-dummy.o efi/mkreloc
 	$(foreach base, $(VIRT_BASE) $(ALT_BASE), \
-	          $(guard) $(LD) $(call EFI_LDFLAGS,$(base)) -T efi.lds -N $< efi/relocs-dummy.o \
+	          $(guard) $(LD_EFI) $(call EFI_LDFLAGS,$(base)) -T efi.lds -N $< efi/relocs-dummy.o \
 	                $(BASEDIR)/common/symbols-dummy.o -o $(@D)/.$(@F).$(base).0 &&) :
 	$(guard) efi/mkreloc $(foreach base,$(VIRT_BASE) $(ALT_BASE),$(@D)/.$(@F).$(base).0) >$(@D)/.$(@F).0r.S
 	$(guard) $(NM) -n $(@D)/.$(@F).$(VIRT_BASE).0 | $(guard) $(BASEDIR)/tools/symbols >$(@D)/.$(@F).0s.S
 	$(guard) $(MAKE) -f $(BASEDIR)/Rules.mk $(@D)/.$(@F).0r.o $(@D)/.$(@F).0s.o
 	$(foreach base, $(VIRT_BASE) $(ALT_BASE), \
-	          $(guard) $(LD) $(call EFI_LDFLAGS,$(base)) -T efi.lds -N $< \
+	          $(guard) $(LD_EFI) $(call EFI_LDFLAGS,$(base)) -T efi.lds -N $< \
 	                $(@D)/.$(@F).0r.o $(@D)/.$(@F).0s.o -o $(@D)/.$(@F).$(base).1 &&) :
 	$(guard) efi/mkreloc $(foreach base,$(VIRT_BASE) $(ALT_BASE),$(@D)/.$(@F).$(base).1) >$(@D)/.$(@F).1r.S
 	$(guard) $(NM) -n $(@D)/.$(@F).$(VIRT_BASE).1 | $(guard) $(BASEDIR)/tools/symbols >$(@D)/.$(@F).1s.S
 	$(guard) $(MAKE) -f $(BASEDIR)/Rules.mk $(@D)/.$(@F).1r.o $(@D)/.$(@F).1s.o
-	$(guard) $(LD) $(call EFI_LDFLAGS,$(VIRT_BASE)) -T efi.lds -N $< \
+	$(guard) $(LD_EFI) $(call EFI_LDFLAGS,$(VIRT_BASE)) -T efi.lds -N $< \
 	                $(@D)/.$(@F).1r.o $(@D)/.$(@F).1s.o -o $@
 	if $(guard) false; then rm -f $@; echo 'EFI support disabled'; fi
 	rm -f $(@D)/.$(@F).[0-9]*
diff -Naur xen/xen/arch/x86/Rules.mk xenb/xen/arch/x86/Rules.mk
--- xen/xen/arch/x86/Rules.mk	2013-03-09 10:39:52.623178611 -0700
+++ xenb/xen/arch/x86/Rules.mk	2013-03-09 10:52:07.846511944 -0700
@@ -26,7 +26,7 @@
 endif
 
 CFLAGS += -fno-builtin -fno-common -Wredundant-decls
-CFLAGS += -iwithprefix include -Werror -Wno-pointer-arith -pipe
+CFLAGS += -iwithprefix include -Wno-pointer-arith -pipe
 CFLAGS += -I$(BASEDIR)/include 
 CFLAGS += -I$(BASEDIR)/include/asm-x86/mach-generic
 CFLAGS += -I$(BASEDIR)/include/asm-x86/mach-default
diff -Naur xen/xen/arch/x86/efi/Makefile xenb/xen/arch/x86/efi/Makefile
--- xen/xen/arch/x86/efi/Makefile	2013-03-09 10:39:52.643178611 -0700
+++ xenb/xen/arch/x86/efi/Makefile	2013-03-09 10:52:07.846511944 -0700
@@ -6,7 +6,7 @@
 
 efi := $(filter y,$(x86_64)$(shell rm -f disabled))
 efi := $(if $(efi),$(shell $(CC) $(filter-out $(CFLAGS-y) .%.d,$(CFLAGS)) -c check.c 2>disabled && echo y))
-efi := $(if $(efi),$(shell $(LD) -mi386pep --subsystem=10 -o check.efi check.o 2>disabled && echo y))
+efi := $(if $(efi),$(shell $(LD_EFI) -mi386pep --subsystem=10 -o check.efi check.o 2>disabled && echo y))
 efi := $(if $(efi),$(shell rm disabled)y,$(shell $(call create,boot.init.o); $(call create,runtime.o)))
 
 extra-$(efi) += boot.init.o relocs-dummy.o runtime.o compat.o
diff -Naur xen/xen/arch/x86/hvm/stdvga.c xenb/xen/arch/x86/hvm/stdvga.c
--- xen/xen/arch/x86/hvm/stdvga.c	2013-03-09 10:39:52.646511944 -0700
+++ xenb/xen/arch/x86/hvm/stdvga.c	2013-03-09 10:52:07.846511944 -0700
@@ -135,7 +135,10 @@
 
     /* When in standard vga mode, emulate here all writes to the vram buffer
      * so we can immediately satisfy reads without waiting for qemu. */
-    s->stdvga = (s->sr[7] == 0x00);
+    s->stdvga =
+        (s->sr[7] == 0x00) &&  /* standard vga mode */
+        (s->gr[6] == 0x05);    /* misc graphics register w/ MemoryMapSelect=1
+                                * 0xa0000-0xaffff (64k region), AlphaDis=1 */
 
     if ( !prev_stdvga && s->stdvga )
     {
diff -Naur xen/xen/arch/x86/io_apic.c xenb/xen/arch/x86/io_apic.c
--- xen/xen/arch/x86/io_apic.c	2013-03-09 10:39:52.653178611 -0700
+++ xenb/xen/arch/x86/io_apic.c	2013-03-09 10:52:07.849845277 -0700
@@ -1995,7 +1995,10 @@
         io_apic_irqs = ~PIC_IRQS;
 
     printk("ENABLING IO-APIC IRQs\n");
-    printk(" -> Using %s ACK method\n", ioapic_ack_new ? "new" : "old");
+    if (!directed_eoi_enabled && !ioapic_ack_forced) {
+        ioapic_ack_new = (nr_ioapics > 1);
+        printk(" -> Using %s ACK method\n", ioapic_ack_new ? "new" : "old");
+    }
 
     if (ioapic_ack_new) {
         ioapic_level_type.ack = irq_complete_move;
diff -Naur xen/xen/arch/x86/platform_hypercall.c xenb/xen/arch/x86/platform_hypercall.c
--- xen/xen/arch/x86/platform_hypercall.c	2013-03-09 10:39:52.663178611 -0700
+++ xenb/xen/arch/x86/platform_hypercall.c	2013-03-09 10:52:07.849845277 -0700
@@ -25,7 +25,7 @@
 #include <xen/irq.h>
 #include <asm/current.h>
 #include <public/platform.h>
-#include <acpi/cpufreq/processor_perf.h>
+#include <acpi/cpufreq/cpufreq.h>
 #include <asm/edd.h>
 #include <asm/mtrr.h>
 #include <asm/io_apic.h>
@@ -597,6 +597,41 @@
     }
     break;
 
+    case XENPF_get_cpu_freq:
+    case XENPF_get_cpu_freq_min:
+    case XENPF_get_cpu_freq_max:
+    {
+        struct vcpu *v;
+        const struct cpufreq_policy *policy;
+
+        if ( op->u.get_cpu_freq.vcpu >= current->domain->max_vcpus ||
+             !(v = current->domain->vcpu[op->u.get_cpu_freq.vcpu]) )
+        {
+            ret = -EINVAL;
+            break;
+        }
+
+        policy = per_cpu(cpufreq_cpu_policy, v->processor);
+        switch ( op->cmd & -!!policy )
+        {
+        case XENPF_get_cpu_freq:
+            op->u.get_cpu_freq.freq = policy->cur;
+            break;
+        case XENPF_get_cpu_freq_min:
+            op->u.get_cpu_freq.freq = policy->min;
+            break;
+        case XENPF_get_cpu_freq_max:
+            op->u.get_cpu_freq.freq = policy->max;
+            break;
+        default:
+            op->u.get_cpu_freq.freq = 0;
+            break;
+        }
+        if ( copy_field_to_guest(u_xenpf_op, op, u.get_cpu_freq.freq) )
+            ret = -EFAULT;
+    }
+    break;
+
     default:
         ret = -ENOSYS;
         break;
diff -Naur xen/xen/arch/x86/x86_64/entry.S xenb/xen/arch/x86/x86_64/entry.S
--- xen/xen/arch/x86/x86_64/entry.S	2013-03-09 10:39:52.676511945 -0700
+++ xenb/xen/arch/x86/x86_64/entry.S	2013-03-09 10:52:07.849845277 -0700
@@ -425,22 +425,35 @@
         jz    domain_crash_synchronous
         movq  %rax,UREGS_rip+8(%rsp)
         ret
-        _ASM_EXTABLE(.Lft2,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft3,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft4,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft5,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft6,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft7,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft8,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft9,  domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft10, domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft11, domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft12, domain_crash_synchronous)
-        _ASM_EXTABLE(.Lft13, domain_crash_synchronous)
+        _ASM_EXTABLE(.Lft2,  domain_crash_page_fault_32)
+        _ASM_EXTABLE(.Lft3,  domain_crash_page_fault_24)
+        _ASM_EXTABLE(.Lft4,  domain_crash_page_fault_8)
+        _ASM_EXTABLE(.Lft5,  domain_crash_page_fault_16)
+        _ASM_EXTABLE(.Lft6,  domain_crash_page_fault)
+        _ASM_EXTABLE(.Lft7,  domain_crash_page_fault)
+        _ASM_EXTABLE(.Lft8,  domain_crash_page_fault_24)
+        _ASM_EXTABLE(.Lft9,  domain_crash_page_fault_16)
+        _ASM_EXTABLE(.Lft10, domain_crash_page_fault_8)
+        _ASM_EXTABLE(.Lft11, domain_crash_page_fault)
+        _ASM_EXTABLE(.Lft12, domain_crash_page_fault_8)
+        _ASM_EXTABLE(.Lft13, domain_crash_page_fault)
 
+.section .rodata, "a", @progbits
 domain_crash_synchronous_string:
         .asciz "domain_crash_sync called from entry.S\n"
+.previous
 
+domain_crash_page_fault_32:
+        addq  $8,%rsi
+domain_crash_page_fault_24:
+        addq  $8,%rsi
+domain_crash_page_fault_16:
+        addq  $8,%rsi
+domain_crash_page_fault_8:
+        addq  $8,%rsi
+domain_crash_page_fault:
+        movq  %rsi,%rdi
+        call  show_page_walk
 ENTRY(domain_crash_synchronous)
         # Get out of the guest-save area of the stack.
         GET_STACK_BASE(%rax)
diff -Naur xen/xen/include/Makefile xenb/xen/include/Makefile
--- xen/xen/include/Makefile	2013-03-09 10:39:52.713178611 -0700
+++ xenb/xen/include/Makefile	2013-03-09 10:52:07.849845277 -0700
@@ -78,7 +78,7 @@
 all: headers.chk
 
 headers.chk: $(filter-out public/arch-% public/%ctl.h public/xsm/% public/%hvm/save.h, $(wildcard public/*.h public/*/*.h) $(public-y)) Makefile
-	for i in $(filter %.h,$^); do $(CC) -ansi -include stdint.h -Wall -W -Werror -S -o /dev/null -xc $$i || exit 1; echo $$i; done >$@.new
+	for i in $(filter %.h,$^); do $(CC) -ansi -include stdint.h -Wall -W -S -o /dev/null -xc $$i || exit 1; echo $$i; done >$@.new
 	mv $@.new $@
 
 endif
diff -Naur xen/xen/include/public/platform.h xenb/xen/include/public/platform.h
--- xen/xen/include/public/platform.h	2013-03-09 10:39:52.759845278 -0700
+++ xenb/xen/include/public/platform.h	2013-03-09 10:52:07.849845277 -0700
@@ -526,6 +526,16 @@
 typedef struct xenpf_core_parking xenpf_core_parking_t;
 DEFINE_XEN_GUEST_HANDLE(xenpf_core_parking_t);
 
+#define XENPF_get_cpu_freq        ('N' << 24)
+#define XENPF_get_cpu_freq_min    (XENPF_get_cpu_freq + 1)
+#define XENPF_get_cpu_freq_max    (XENPF_get_cpu_freq_min + 1)
+struct xenpf_get_cpu_freq {
+    /* IN variables */
+    uint32_t vcpu;
+    /* OUT variables */
+    uint32_t freq; /* in kHz */
+};
+
 /*
  * ` enum neg_errnoval
  * ` HYPERVISOR_platform_op(const struct xen_platform_op*);
@@ -552,6 +562,7 @@
         struct xenpf_cpu_hotadd        cpu_add;
         struct xenpf_mem_hotadd        mem_add;
         struct xenpf_core_parking      core_parking;
+        struct xenpf_get_cpu_freq      get_cpu_freq;
         uint8_t                        pad[128];
     } u;
 };
diff -Naur xen/xen/include/xen/device_tree.h xenb/xen/include/xen/device_tree.h
--- xen/xen/include/xen/device_tree.h	2013-03-09 10:39:52.763178611 -0700
+++ xenb/xen/include/xen/device_tree.h	2013-03-09 10:52:07.849845277 -0700
@@ -46,9 +46,25 @@
     struct dt_mb_module module[NR_MODULES + 1];
 };
 
+struct dt_gic_info {
+    paddr_t gic_dist_addr;
+    paddr_t gic_cpu_addr;
+    paddr_t gic_hyp_addr;
+    paddr_t gic_vcpu_addr;
+};
+
+struct dt_gic_info {
+    paddr_t gic_dist_addr;
+    paddr_t gic_cpu_addr;
+    paddr_t gic_hyp_addr;
+    paddr_t gic_vcpu_addr;
+};
+
 struct dt_early_info {
     struct dt_mem_info mem;
     struct dt_gic_info gic;
+    struct dt_gic_info gic;
+    struct dt_gic_info gic;
     struct dt_module_info modules;
 };
 

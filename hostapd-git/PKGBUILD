# Contributor: Tom < reztho at archlinux dot us >
# Modified from the PKGBUILD of hostapd v0.6.9-1 
# of the community repository
pkgname=hostapd-git
pkgver=20100214
pkgrel=1
pkgdesc='Daemon for wireless software access points. Git version.'
arch=('i686' 'x86_64')
url='http://hostap.epitest.fi/hostapd/'
license=('custom')
depends=('openssl' 'libnl')
provides=('hostapd')
conflicts=('hostapd')
install=hostapd.install
backup=('etc/hostapd/hostapd.accept'
        'etc/hostapd/hostapd.conf'
        'etc/hostapd/hostapd.deny'
        'etc/hostapd/hostapd.eap_user'
        'etc/hostapd/hostapd.radius_clients'
        'etc/hostapd/hostapd.sim_db'
        'etc/hostapd/hostapd.vlan'
        'etc/hostapd/hostapd.wpa_psk'
        'etc/hostapd/wired.conf'
        'etc/hostapd/hlr_auc_gw.milenage_db')
source=('defconfig' 'hostapd')

_gitroot='git://w1.fi/srv/git/hostap.git'
_gitname='hostap'

build() {
    cd ${srcdir}
    msg "Connecting to GIT server...."
    if [ -d "${srcdir}/${_gitname}" ] ; then
        cd ${srcdir}/${_gitname} && git pull origin
        msg "The local files are updated."
    else
        git clone ${_gitroot}
    fi

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    rm -rf "${srcdir}/${_gitname}-build"
    git clone ${srcdir}/${_gitname} ${srcdir}/${_gitname}-build

    cd ${srcdir}/${_gitname}-build/hostapd
    cp ${srcdir}/defconfig ./.config || return 1
    sed -i "s@/usr/local/bin@${pkgdir}/usr/bin@" Makefile || return 1

    make || return 1
    
    mkdir -p ${pkgdir}/usr/bin || return 1
    make DESTDIR=${pkgdir} install || return 1

    install -Dm644 ${srcdir}/${_gitname}-build/hostapd/hlr_auc_gw.milenage_db \
        ${pkgdir}/etc/hostapd/hlr_auc_gw.milenage_db || return 1  
    install -m644 hostapd.accept ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.conf ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.deny ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.eap_user ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.radius_clients ${pkgdir}/etc/hostapd || return 1 
    install -m644 hostapd.sim_db ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.vlan ${pkgdir}/etc/hostapd || return 1
    install -m644 hostapd.wpa_psk ${pkgdir}/etc/hostapd || return 1
    install -m644 wired.conf ${pkgdir}/etc/hostapd || return 1
    install -Dm644 hostapd.8 ${pkgdir}/usr/share/man/man8/hostapd.8 || return 1
    install -Dm644 hostapd_cli.1 ${pkgdir}/usr/share/man/man1/hostapd_cli.1 || return 1
    install -Dm644 ${srcdir}/${_gitname}-build/COPYING ${pkgdir}/usr/share/licenses/${pkgname}/COPYING || return 1
    install -Dm755 ${srcdir}/hostapd ${pkgdir}/etc/rc.d/hostapd || return 1

    sed -i 's@/etc/@/etc/hostapd/@g' ${pkgdir}/etc/hostapd/hostapd.conf || return 1

    install -Dm644 README ${pkgdir}/usr/share/doc/${pkgname}/README || return 1
    install -m644 README-WPS ${pkgdir}/usr/share/doc/${pkgname} || return 1
    mkdir -p ${pkgdir}/usr/share/doc/${pkgname}/logwatch || return 1
    install -m644 logwatch/* ${pkgdir}/usr/share/doc/${pkgname}/logwatch || return 1
    install -m644 ${srcdir}/${_gitname}-build/FAQ ${pkgdir}/usr/share/doc/${pkgname} || return 1
}

md5sums=('91b5704fa9bed91c101d47f73ca191cf'
         'cbc54751c16a53221f2c8ab7170aad78')

# Maintainer: BxS <bxsbxs at gmail dot com>

pkgname='microchip-mplab_bin'
_pkgverb='7.12'
pkgver='10b'$_pkgverb
pkgrel=4
pkgdesc="IDE for Microchip PIC and dsPIC development a.k.a MPLAB X"
arch=('i686' 'x86_64')
url="http://www.microchip.com/en_US/family/mplabx/index.html"
license=('custom')
depends=('java-runtime=6' 'libusb' 'xdg-utils' 'hicolor-icon-theme')
[ "$CARCH" = "x86_64" ] && depends=("${depends[@]}" 'lib32-glibc')
optdepends=('microchip-mplabc18_bin: C compiler for PIC18 MCUs'
	    'microchip-mplabc30_bin: C compiler for PIC24 MCUs and dsPIC DSCs'
	    'microchip-mplabc32_bin: C Compiler for PIC32 MCUs'
	    'hitech-picc_bin: C compiler for PIC10/12/16 MCUs'
	    'hitech-picc-18_bin: C compiler for PIC18 MCUs')
provides=(mplab)
conflicts=(mplab)
options=(!strip docs libtool emptydirs !zipman)
install=microchip-mplab_bin.install
_user=$USER
_installer="mplabx-ide-beta$_pkgverb-linux-installer.run"
source=("http://ww1.microchip.com/downloads/mplab/X_Beta/$_installer"
	'z010_mchp_tools.rules'
	'mplab.desktop'
	'microchip.png'
	'LICENSE')
md5sums=('2d99c6f001d53d0a02412b80f1ead81f'
         'e5c67fd4a40f924006c26c6e7a90a761'
         '7c15d009ca818cbefec498c495b1685b'
         'b45656e8e99e213b8151bbafac0a37ac'
         '2d1c400907ba208d3f06ec1ee84eb2c0')

package() {
  cd "$pkgdir"

  mkdir -p "$pkgdir/opt/microchip/mplabx"

  echo -e "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\ny\n\ny\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\ni\n" > installer_input

  echo -e "#! /bin/sh\necho \"java version \\\"1.6\"" > java
  chmod 0755 java
  PATH=$pkgdir:$PATH

  chmod 0755 "$srcdir/$_installer"
  "$srcdir/$_installer" --mode text --installdir "$pkgdir/opt/microchip/mplabx" < installer_input &> '/dev/null' || true
  rm installer_input java

  rm "/home/$_user/Desktop/MPLAB X IDE beta$_pkgverb.desktop" &> '/dev/null' || true

  rm "$pkgdir/opt/microchip/mplabx/Uninstall MPLAB X IDE"{," beta$_pkgverb.desktop"} &> '/dev/null' || true
  rm -r "$pkgdir/opt/microchip/mplabx/rollbackBackupDirectory" &> '/dev/null' || true

  rm "$pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/libusb-1.0"*

  mkdir -p "$pkgdir/etc/.mplab_ide"

  chmod 0755 "$pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/mchplinusbdevice"
  ln -s "/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/mchplinusbdevice" "$pkgdir/etc/.mplab_ide"
  
  chmod 0644 "$pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/mchpdefport"
  ln -s "/opt/microchip/mplabx/mplab_ide/mplablibs/modules/mchpdefport" "$pkgdir/etc/.mplab_ide"
  
  chmod 0755 "$pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/libUSBAccessLink.so"
  sed 's/\x2F\x75\x73\x72\x2F\x6C\x6F\x63\x61\x6C\x2F\x6C\x69\x62\x2F\x6C\x69\x62\x6D\x63\x68\x70\x75\x73\x62\x2D\x31\x2E\x30\x2E\x73\x6F\x00/\x6C\x69\x62\x75\x73\x62\x2D\x31\x2E\x30\x2E\x73\x6F\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00/' -i "$pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/libUSBAccessLink.so"

  install -D -m 0644 "$srcdir/z010_mchp_tools.rules" "$pkgdir/etc/udev/rules.d/z010_mchp_tools.rules"

  install -D -m 0644 "$srcdir/mplab.desktop" "$pkgdir/usr/share/applications/mplab.desktop"

  install -D -m 0644 "$srcdir/microchip.png" "$pkgdir/usr/share/icons/microchip.png"

  mkdir -p "$pkgdir/usr/bin"
  ln -s "/opt/microchip/mplabx/mplab_ide/bin/mplab_ide" "$pkgdir/usr/bin/mplab_ide"

  install -D -m 0644 "$srcdir/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

# Maintainer: BxS <bxsbxs at gmail dot com>

pkgname='microchip-mplab_bin'
_pkgverb='7.02'
pkgver='10b'$_pkgverb
pkgrel=3
pkgdesc="IDE for Microchip PIC and dsPIC development"
arch=('i686' 'x86_64')
url="http://www.microchip.com/en_US/family/mplabx/index.html"
license=('custom')
depends=('java-environment' 'xdg-utils' 'hicolor-icon-theme')
[ "$CARCH" = "x86_64" ] && depends=("${depends[@]}" 'lib32-glibc')
optdepends=('microchip-mplabc18_bin: C compiler for PIC18 MCUs'
	    'microchip-mplabc30_bin: C compiler for PIC24 MCUs and dsPIC DSCs'
	    'microchip-mplabc32_bin: C Compiler for PIC32 MCUs'
	    'hitech-picc_bin: C compiler for PIC10/12/16 MCUs'
	    'hitech-picc-18_bin: C compiler for PIC18 MCUs')
provides=(mplab)
conflicts=(mplab)
options=(!strip docs libtool emptydirs !zipman)
install=microchip-mplab_bin.install
_bit='32'
[ "$CARCH" = "x86_64" ] && _bit='64'
_installer="mplabx-ide-beta$_pkgverb-linux-$_bit-bit-installer.bin"
source=("http://ww1.microchip.com/downloads/mplab/X_Beta/$_installer"
	'z010_mchp_tools.rules'
	'mplab.desktop'
	'microchip.png'
	'LICENSE')
md5sums=('53486fe0bdf0e4845de385ee70791dd6'
         '91afca405f88760eb97884dc67b52992'
         '7c15d009ca818cbefec498c495b1685b'
         'b45656e8e99e213b8151bbafac0a37ac'
         '6cf8b136a708bef630b6967d3797501f')
[ "$CARCH" = "x86_64" ] && md5sums[0]='fbe573dabb54120947bbefaa2d8003d4'

build() {
  cd $srcdir

  chmod 0755 $_installer
}

package() {
  cd $pkgdir

  mkdir -p "$pkgdir/opt/microchip/mplabx"

  env -i \
  PATH=$PATH \
  LD_PRELOAD=$LD_PRELOAD \
  LD_LIBRARY_PATH=$LD_LIBRARY_PATH \
  FAKEROOTKEY=$FAKEROOTKEY \
  FAKED_MODE=$FAKED_MODE \
  $srcdir/$_installer --mode unattended --installdir $pkgdir/opt/microchip/mplabx &> '/dev/null' || true

  rm "$pkgdir/opt/microchip/mplabx/Uninstall MPLAB X IDE"{," beta$_pkgverb.desktop"} &> '/dev/null' || true
  rm -r $pkgdir/opt/microchip/mplabx/rollbackBackupDirectory

  mkdir -p "$pkgdir/etc/.mplab_ide"
  cp $pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/mchplinusbdevice $pkgdir/etc/.mplab_ide
  chmod 0744 $pkgdir/etc/.mplab_ide/mchplinusbdevice

  cp $pkgdir/opt/microchip/mplabx/mplab_ide/mplablibs/modules/mchpdefport $pkgdir/etc/.mplab_ide
  chmod 0744 $pkgdir/etc/.mplab_ide/mchpdefport

  mkdir -p "$pkgdir/etc/udev/rules.d"
  cp $srcdir/z010_mchp_tools.rules $pkgdir/etc/udev/rules.d
  chmod 0644 $pkgdir/etc/udev/rules.d/z010_mchp_tools.rules

  mkdir -p "$pkgdir/usr/share/applications"
  cp $srcdir/mplab.desktop $pkgdir/usr/share/applications
  chmod 0644 $pkgdir/usr/share/applications/mplab.desktop

  mkdir -p "$pkgdir/usr/share/icons"
  cp $srcdir/microchip.png $pkgdir/usr/share/icons
  chmod 0644 $pkgdir/usr/share/icons/microchip.png

  mkdir -p "$pkgdir/usr/lib"
  ln -s /opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/libUSBAccessLink.so $pkgdir/usr/lib

  mkdir -p "$pkgdir/usr/local/lib"
  ln -s /opt/microchip/mplabx/mplab_ide/mplablibs/modules/lib/libusb-1.0.so.0.0.0 $pkgdir/usr/local/lib/libmchpusb-1.0.so

  mkdir -p "$pkgdir/usr/bin"
  ln -s /opt/microchip/mplabx/mplab_ide/bin/mplab_ide $pkgdir/usr/bin/mplab_ide

  mkdir -p $pkgdir/usr/share/licenses/$pkgname
  cp "$srcdir/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

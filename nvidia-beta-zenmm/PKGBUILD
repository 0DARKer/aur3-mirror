#Maintainer: Jasin <rooloo007@gmail.com>
#Contributer: Dan Vratil <progdan@progdansoft.com>

pkgname=nvidia-beta-zenmm
pkgver=177.13
_kernver=`uname -r` 
pkgrel=2
pkgdesc="NVIDIA beta drivers for kernel26zenmm." 
arch=('i686' 'x86_64') 
[ "$CARCH" = "x86" ] && ARCH=x86 && NV=0
[ "$CARCH" = "x86_64" ] && ARCH=x86_64 && NV=0 
provides=('nvidia')
url="http://www.nvidia.com/" 
depends=('nvidia-utils-beta=177.13' 'kernel26zenmm-git>=2.6.27-rc1-zenmm0') 
conflicts=('nvidia-96xx' 'nvidia-71xx' 'nvidia-legacy') 
license=('custom') 
install=nvidia.install 
source=(http://us.download.nvidia.com/XFree86/Linux-$ARCH/${pkgver}/NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}.run \
	nvidia-fixed-2.6.27-rc2-177.13-beta.patch)
	
md5sums=()        

build()
{
  echo $_kernver
  # Extract
  echo ${_kernver}
  cd $startdir/src/
  sh NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}.run --extract-only
  cd NVIDIA-Linux-$ARCH-${pkgver}-pkg${NV}
    
  # Apply patches here
  patch -Np0 -i $startdir/src/nvidia-fixed-2.6.27-rc2-177.13-beta.patch || return 1
   
  cd usr/src/nv/ 
  ln -s Makefile.kbuild Makefile
  make SYSSRC=/lib/modules/${_kernver}/build module 
  
  # install kernel module
  mkdir -p $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/video/
  install -m644 nvidia.ko $startdir/pkg/lib/modules/${_kernver}/kernel/drivers/video/

  sed -i -e "s/KERNEL_VERSION='.*'/KERNEL_VERSION='${_kernver}'/" $startdir/*.install
}

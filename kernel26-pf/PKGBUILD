# Maintainer: Christos Nouskas <nous at archlinux dot us>
# PKGBUILD assembled from kernel26, kernel26-bfs, kernel26-ck
# Credit to respective maintainers

_basekernel=2.6.37
_pkgname=kernel26-pf
_pfrel=pf6
_kernelname=-pf
_chakrapatches="http://chakra-project.org/sources/kernel26/patches/37"
_pfpatchhome="http://pf.natalenko.name/sources/${_basekernel}/"
_pfpatchname="patch-${_basekernel}-${_pfrel}.bz2"

pkgname=kernel26-pf
pkgver=${_basekernel}
pkgrel=${_pfrel}
arch=(i686 x86_64)
_pkgdesc="Linux kernel and modules with pf-kernel patch [-ck patchset (BFS included), TuxOnIce, BFQ], aufs2 and squashfs-lzma."
pkgdesc=${_pkgdesc}
license=('GPL2')
groups=('base')
url="http://pf.natalenko.name/"
backup=(etc/mkinitcpio.d/${_pkgname}.preset)
depends=('coreutils' 'module-init-tools' 'linux-firmware' 'mkinitcpio>=0.5.20')
optdepends=('crda: to set the correct wireless channels of your country'
	    'pm-utils: utilities and scripts for suspend and hibernate power management'
	    'tuxonice-userui: TuxOnIce userspace user interface'
	    'hibernate-script: set of scripts for managing TuxOnIce, hibernation and suspend to RAM'
	    'nvidia-pf: NVIDIA drivers for kernel26-pf'
	    'nvidia-beta-all: NVIDIA drivers for all installed kernels'
	    'modprobed_db: Keeps track of EVERY kernel module that has ever been probed. Useful for make localmodconfig.')
replaces=('kernel24' 'kernel24-scsi' 'kernel26-scsi'
          'alsa-driver' 'ieee80211' 'hostap-driver26'
          'pwc' 'nforce' 'squashfs' 'unionfs' 'ivtv'
          'zd1211' 'kvm-modules' 'iwlwifi' 'rt2x00-cvs'
          'gspcav1' 'atl2' 'wlan-ng26' 'aufs2' 'rt2500')
#conflicts=(kernel26-pf-core2 kernel26-pf-k8 kernel26-pf-psc kernel26-pf-atom kernel26-pf-k7 kernel26-pf-p3 kernel26-pf-pm kernel26-pf-p4)
conflicts=()
provides=(${_pkgname}=${_basekernel} 'aufs2')	# for $pkgname-optimized
# below 'provides' is for when you have no other kernel (which is a bad idea anyway)
# provides=(${_pkgname}=${_basekernel} 'kernel26-headers' 'kernel26=$pkgver' 'aufs2')
install='kernel26.install'

source=(ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-${_basekernel}.tar.bz2
	config config.x86_64		# the main kernel config files
	kernel26.preset			# standard config files for mkinitcpio ramdisk
	logo_linux_clut224.ppm.bz2
	logo_linux_mono.pbm.bz2		# the archlinux boot logos
	logo_linux_vga16.ppm.bz2
	streamline_config.pl
	b44-panicfix.patch		# fix panics caused by b44 in Dell laptops
	$_chakrapatches/aufs2.1/aufs2-base.patch
	$_chakrapatches/aufs2.1/aufs2-kbuild.patch
	$_chakrapatches/aufs2.1/aufs2-standalone.patch
	$_chakrapatches/aufs2.1/aufs2.1-2010-12-20.patch.bz2
	$_chakrapatches/squashfs-lzma/01-squashfs_revert_to_2.6.35.patch
	$_chakrapatches/squashfs-lzma/02-squashfs_add_lzma.patch
	$_chakrapatches/squashfs-lzma/03-squashfs_make_lzma_available.patch
	$_chakrapatches/squashfs-lzma/04-decompress_unlzo_fix.patch
	$_chakrapatches/squashfs-lzma/05-fix_building_squashfs_with_xattrs.patch
	${_pfpatchhome}${_pfpatchname})	# the -pf patchset

build() {
  cd ${srcdir}/linux-${_basekernel}
  # This is for me, to test the PKGBUILD
  if [[ $NOEXTRACT = "0" ]]; then
     # Arch linux logo
     msg "Replacing penguins with arches"
     bzip2 -dk ${startdir}/logo_linux_*.bz2
     mv -f ${startdir}/logo_linux_*.p?m drivers/video/logo/
     msg "Applying pf-kernel patch"
     bzip2 -dc ${srcdir}/${_pfpatchname} | patch -Np1
     msg "Applying aufs2 and squashfs-lzma patches"
     patch -Np1 < ${srcdir}/aufs2-base.patch
     patch -Np1 < ${srcdir}/aufs2-kbuild.patch
     patch -Np1 < ${srcdir}/aufs2-standalone.patch
     bzip2 -dc ${srcdir}/aufs2.1-2010-12-20.patch.bz2 | patch -Np1
     patch -Np1 < ${srcdir}/01-squashfs_revert_to_2.6.35.patch
     patch -Np1 < ${srcdir}/02-squashfs_add_lzma.patch
     patch -Np1 < ${srcdir}/03-squashfs_make_lzma_available.patch
     patch -Np1 < ${srcdir}/04-decompress_unlzo_fix.patch
     patch -Np1 < ${srcdir}/05-fix_building_squashfs_with_xattrs.patch

# patch for b44 panic
     patch -Np1 < ${srcdir}/b44-panicfix.patch

     if [ "$CARCH" = "x86_64" ]; then
	cat ${startdir}/config.x86_64 >| .config
     else
	cat ${startdir}/config >| .config
     fi
     cat ${startdir}/streamline_config.pl >| scripts/kconfig/streamline_config.pl
  fi
  sed -i "s/EXTRAVERSION = -${_pfrel}/EXTRAVERSION = ${_kernelname}/" Makefile
  _arch=$CARCH

#----------------------------------------
if [[ "$_BATCH" != "y" ]]; then		# for batch building
  echo
  echo "======================================================="
  msg "You might be prompted below for some config options"
  echo "======================================================="
  echo
  msg "Hit <Y> to use your running kernel's config"
  echo "    (needs IKCONFIG and IKCONFIG_PROC)"
  msg "Hit <L> to run make localmodconfig"
  msg "Hit <N> (or just <ENTER>) to build an all-inclusive kernel like stock -ARCH"
  echo "    (warning: it can take a looong time)"
  echo
  read answer
  shopt -s nocasematch
  if [[ "$answer" = "y" ]]; then
     msg "running 'sudo modprobe configs'"
     sudo modprobe configs
     if [[ -s /proc/config.gz ]]; then
	msg "Extracting config from /proc/config.gz..."
	zcat /proc/config.gz >| ./.config
     else
	msg "You kernel was not compiled with IKCONFIG_PROC."
	# Copied from kernel26-ck's PKGBUILD
	msg "Attempting to run /usr/bin/reload_database from modprobe_db..."
	if [ -e /usr/bin/reload_database ]; then
	   /usr/bin/reload_database
	fi
	msg "Running make localmodconfig instead..."
	chmod +x ./scripts/kconfig/streamline_config.pl
	./scripts/kconfig/streamline_config.pl >| config_strip
	mv config_strip .config
     fi
  elif [[ "$answer" = "l" ]]; then
     # Copied from kernel26-ck's PKGBUILD
     msg "Attempting to run /usr/bin/reload_database from modprobe_db..."
     if [ -e /usr/bin/reload_database ]; then
	/usr/bin/reload_database
     fi
     msg "Running the functional equivalent of make localmodconfig now..."
     chmod +x ./scripts/kconfig/streamline_config.pl
     ./scripts/kconfig/streamline_config.pl >| config_strip
     mv config_strip .config
     msg "An error about ksource in line 118 blah blah is NORMAL as is one about nvidia config too!"
  else
     msg "Using stock ARCH kernel .config (with BFS, BFQ and TuxOnIce enabled)."
  fi

  # Make some good use of MAKEFLAGS
  # MAKEFLAGS=`grep -v '#' /etc/makepkg.conf | grep MAKEFLAGS= | sed s/MAKEFLAGS=// | sed s/\"//g`
  # make prepare

  # Option for make menuconfig
  echo
  msg "Run make menuconfig before build? (y/N)"
  read answer
  if [[ "$answer" = "y" ]]; then
     make menuconfig
     cp -v .config ${startdir}/config.local
  fi
  CPU=`egrep "MK8=y|MCORE2=y|MPSC=y|MATOM=y|MPENTIUMII=y|MPENTIUMIII=y|MPENTIUMM=y|MPENTIUM4=y|MK7=y|CONFIG_GENERIC_CPU=y|M686=y" ./.config`
  CPU=`sed -e "s/CONFIG_M\(.*\)=y/\1/" <<<$CPU`
  CPU=`sed -e "s/CONFIG_GENERIC_CPU=y/GENERIC/" <<<$CPU`
  CPU=`sed -e "s/^686$/GENERIC/" <<<$CPU`
  cp -v .config ${startdir}/config.$CPU-$CARCH
fi	# batch check ends here
#----------------------------------------

  # Strip config of uneeded localversion
  if [ "${_kernelname}" != "" ]; then
     sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"\"|g" ./.config
  fi

  # load configuration
  # yes "" | make config
  # Useful for repo maintainers.

  # build!
  make bzImage modules
}

package() {
  KARCH=x86
  cd ${srcdir}/linux-${_basekernel}
  _kernver=$(make kernelrelease)

  # work around the AUR parser
  # This allows building cpu-optimized packages with according package names.
  # Useful for repo maintainers.
  CPU=`egrep "MK8=y|MCORE2=y|MPSC=y|MATOM=y|MPENTIUMII=y|MPENTIUMIII=y|MPENTIUMM=y|MPENTIUM4=y|MK7=y|CONFIG_GENERIC_CPU=y|M686=y" ./.config`
  CPU=`sed -e "s/CONFIG_M\(.*\)=y/\1/" <<<$CPU`
  case $CPU in
   CORE2)
       pkgname="${_pkgname}-core2"
       pkgdesc="${_pkgdesc} Intel Core2 optimized."
       ;;
   K8)
       pkgname="${_pkgname}-k8"
       pkgdesc="${_pkgdesc} AMD K8 optimized."
       ;;
   PSC)
       pkgname="${_pkgname}-psc"
       pkgdesc="${_pkgdesc} Intel Pentium4/D/Xeon optimized."
       ;;
   ATOM)
       pkgname="${_pkgname}-atom"
       pkgdesc="${_pkgdesc} Intel Atom optimized."
       ;;
   K7)
       pkgname="${_pkgname}-k7"
       pkgdesc="${_pkgdesc} AMD K7 optimized."
       ;;
   PENTIUMII)
       pkgname="${_pkgname}-p2"
       pkgdesc="${_pkgdesc} Intel Pentium2 optimized."
       ;;
   PENTIUMIII)
       pkgname="${_pkgname}-p3"
       pkgdesc="${_pkgdesc} Intel Pentium3 optimized."
       ;;
   PENTIUMM)
       pkgname="${_pkgname}-pm"
       pkgdesc="${_pkgdesc} Intel Pentium-M optimized."
       ;;
   PENTIUM4)
       pkgname="${_pkgname}-p4"
       pkgdesc="${_pkgdesc} Intel Pentium4 optimized."
       ;;
   default)
# Note to me: DO NOT EVER REMOVE THIS. It's for the AUR PKGBUILD parser.
       pkgname="${_pkgname}"
       pkgdesc="Linux kernel and modules with pf-kernel patch [-ck patchset (BFS included), TuxOnIce, BFQ], aufs2 and squashfs-lzma."
       conflicts=(kernel26-pf-core2 kernel26-pf-k8 kernel26-pf-psc kernel26-pf-atom kernel26-pf-k7 kernel26-pf-p3 kernel26-pf-pm kernel26-pf-p4)
       ;;
  esac

  if [[ "$pkgname" != "$_pkgname" ]]; then
     conflicts=('kernel26-pf')
  fi

  echo
  echo "======================================="
  msg  "The package will be named ${pkgname}"
  msg  "${pkgdesc}"
  echo "======================================="
  echo

  ### package_kernel26

  mkdir -p ${pkgdir}/{lib/modules,boot}
  make INSTALL_MOD_PATH=${pkgdir} modules_install

  cp System.map ${pkgdir}/boot/System.map26${_kernelname}
  cp arch/$KARCH/boot/bzImage ${pkgdir}/boot/vmlinuz26${_kernelname}

  # add vmlinux
  install -m644 -D vmlinux ${pkgdir}/usr/src/linux-${_kernver}/vmlinux

  # install fallback mkinitcpio.conf file and preset file for kernel
  # make sure ${_pkgname} is used for the mkinitcpio process
  install -m644 -D ${srcdir}/kernel26.preset ${pkgdir}/etc/mkinitcpio.d/${_pkgname}.preset

  # set correct depmod command for install
  sed \
     -e  "s/KERNEL_NAME=.*/KERNEL_NAME=${_kernelname}/g" \
     -e  "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" \
     -i ${startdir}/kernel26.install
  sed \
     -e "s|source .*|source /etc/mkinitcpio.d/kernel26${_kernelname}.kver|g" \
     -e "s|default_image=.*|default_image=\"/boot/${_pkgname}.img\"|g" \
     -e "s|fallback_image=.*|fallback_image=\"/boot/${_pkgname}-fallback.img\"|g" \
     -i ${pkgdir}/etc/mkinitcpio.d/${_pkgname}.preset

  echo -e "# DO NOT EDIT THIS FILE\nALL_kver='${_kernver}'" > ${pkgdir}/etc/mkinitcpio.d/${_pkgname}.kver

  ### package_kernel26-headers

  mkdir -p ${pkgdir}/lib/modules/${_kernver}
  cd ${pkgdir}/lib/modules/${_kernver}
  ln -sf ../../../usr/src/linux-${_kernver} build
  cd ${srcdir}/linux-$_basekernel
  install -D -m644 Makefile \
    ${pkgdir}/usr/src/linux-${_kernver}/Makefile
  install -D -m644 kernel/Makefile \
    ${pkgdir}/usr/src/linux-${_kernver}/kernel/Makefile
  install -D -m644 .config \
    ${pkgdir}/usr/src/linux-${_kernver}/.config
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include

  for i in acpi asm-generic config generated linux math-emu media net pcmcia scsi sound trace video xen; do
    cp -a include/$i ${pkgdir}/usr/src/linux-${_kernver}/include/
  done

  # copy arch includes for external modules
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/arch/x86
  cp -a arch/x86/include ${pkgdir}/usr/src/linux-${_kernver}/arch/x86/

  # copy files necessary for later builds, like nvidia and vmware
  cp Module.symvers ${pkgdir}/usr/src/linux-${_kernver}
  cp -a scripts ${pkgdir}/usr/src/linux-${_kernver}

  # fix permissions on scripts dir
  chmod og-w -R ${pkgdir}/usr/src/linux-${_kernver}/scripts
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/.tmp_versions

  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel

  cp arch/$KARCH/Makefile ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  if [ "$CARCH" = "i686" ]; then
    cp arch/$KARCH/Makefile_32.cpu ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/
  fi
  cp arch/$KARCH/kernel/asm-offsets.s ${pkgdir}/usr/src/linux-${_kernver}/arch/$KARCH/kernel/

  # add headers for lirc package
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video
  cp drivers/media/video/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/
  for i in bt8xx cpia2 cx25840 cx88 em28xx et61x251 pwc saa7134 sn9c102 usbvideo; do
    mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
    cp -a drivers/media/video/$i/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/video/$i
  done
  # add docbook makefile
  install -D -m644 Documentation/DocBook/Makefile \
    ${pkgdir}/usr/src/linux-${_kernver}/Documentation/DocBook/Makefile
  # add dm headers
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/md
  cp drivers/md/*.h  ${pkgdir}/usr/src/linux-${_kernver}/drivers/md
  # add inotify.h
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/linux
  cp include/linux/inotify.h ${pkgdir}/usr/src/linux-${_kernver}/include/linux/
  # add wireless headers
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  cp net/mac80211/*.h ${pkgdir}/usr/src/linux-${_kernver}/net/mac80211/
  # add dvb headers for external modules
  # in reference to:
  # http://bugs.archlinux.org/task/9912
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core
  cp drivers/media/dvb/dvb-core/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-core/
  # add dvb headers for external modules
  # in reference to:
  # http://bugs.archlinux.org/task/11194
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/
  [[ -e include/config/dvb/ ]] && cp include/config/dvb/*.h ${pkgdir}/usr/src/linux-${_kernver}/include/config/dvb/
  # add dvb headers for http://mcentral.de/hg/~mrec/em28xx-new
  # in reference to:
  # http://bugs.archlinux.org/task/13146
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  cp drivers/media/dvb/frontends/lgdt330x.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  cp drivers/media/video/msp3400-driver.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  # add dvb headers
  # in reference to:
  # http://bugs.archlinux.org/task/20402
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb
  cp drivers/media/dvb/dvb-usb/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/dvb-usb/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends
  cp drivers/media/dvb/frontends/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/dvb/frontends/
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners
  cp drivers/media/common/tuners/*.h ${pkgdir}/usr/src/linux-${_kernver}/drivers/media/common/tuners/
  # add xfs and shmem for aufs building
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/fs/xfs
  mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/mm
  cp fs/xfs/xfs_sb.h ${pkgdir}/usr/src/linux-${_kernver}/fs/xfs/xfs_sb.h
  # add headers for virtualbox
  # in reference to:
  # http://bugs.archlinux.org/task/14568
  cp -a include/drm $pkgdir/usr/src/linux-${_kernver}/include/
  # add headers for broadcom wl
  # in reference to:
  # http://bugs.archlinux.org/task/14568
  cp -a include/trace $pkgdir/usr/src/linux-${_kernver}/include/
  # add headers for crypto modules
  # in reference to:
  # http://bugs.archlinux.org/task/22081
  cp -a include/crypto $pkgdir/usr/src/linux-${_kernver}/include/
  # copy in Kconfig files
  for i in `find . -name "Kconfig*"`; do 
    mkdir -p ${pkgdir}/usr/src/linux-${_kernver}/`echo $i | sed 's|/Kconfig.*||'`
    cp $i ${pkgdir}/usr/src/linux-${_kernver}/$i
  done

  chown -R root.root ${pkgdir}/usr/src/linux-${_kernver}
  find ${pkgdir}/usr/src/linux-${_kernver} -type d -exec chmod 755 {} \;

  # remove unneeded architectures
  rm -rf ${pkgdir}/usr/src/linux-${_kernver}/arch/{alpha,arm,arm26,avr32,blackfin,cris,frv,h8300,ia64,m32r,m68k,m68knommu,mips,microblaze,mn10300,parisc,powerpc,ppc,s390,sh,sh64,sparc,sparc64,um,v850,xtensa}
  # make correct build and source links
  rm -f ${pkgdir}/lib/modules/${_kernver}/{source,build}
  cd ${pkgdir}/lib/modules/${_kernver} && \
    (rm -f source build; ln -sf ../../../usr/src/linux-${_kernver} build)

  # remove the firmware
  rm -rf ${pkgdir}/lib/firmware
}

# makepkg -g >>PKGBUILD

sha256sums=('edbf091805414739cf57a3bbfeba9e87f5e74f97e38f04d12060e9e0c71e383a'
            '9428bd089186b2039bfc13b6c9e15bb6ecba6a4adbdbdb70b49f97d79e5294c8'
            '6b9c7ab66566274aa4ed55040c0403af52fec4e04a409187e452ecdec7ca36be'
            '3b0aeb055c560acc804fff2eebfb71a64ebd5a535d046e53781f89b5cfba035b'
            '03ed4eb4a35d42ae6beaaa5e6fdbada4244ed6c343944bba6462defaa6fed0bf'
            '51ea665cfec42d9f9c7796af2b060b7edbdeb367e42811f8c02667ad729f6b19'
            '9e1e81d80afac6f316e53947e1b081017090081cd30e6c4c473420b77af4b52b'
            '47008d49add12a0e952065dbaa61285f654bf3c3b53d1577baef128b7c0c404b'
            '570e31870da9b423dd961591e6cf787c41da0eea0d6dfc6dbf7faa47bd966512'
            '8585e874c726bc98e52014f252f98981686149661ea0b049f4f985c6a028cfd7'
            '333827efa60c4e74981430d60a80a562563da4691a08eb5ddffe907c2473d8fc'
            '80608a9678ebb119f4a25fac8ff7338be5a6b8541d03f430cf536ba6fd5e0696'
            'f3876ae8b8420c02c853c0d9a18d3e6bb589b533d3a0787b2c6573f4a8a7d1af'
            'fe2ee5007f65e09b08b34102a4f9d626d97645682d5adb654619a243ee1ee098'
            '794994f468b0a6fe67963dac71b2156f805ebc5c8058b0f70a56677fb0666a60'
            '05d49d0bf41d28a246feea6806b8d74f5f754495f0678cca6a5d901c2c5cb2db'
            'e1dff8887829caebf1a14d1d01642c37302bb55fa567b9720b90b1185f273c4c'
            'b2327b99fec096c68748f93764910250ba1247bbef098db2606221f17e29cbb3'
            '0ba90c8f1be582a81568f2ffdfdb3f16feae8bbc446b59174f0767e873ce177a')

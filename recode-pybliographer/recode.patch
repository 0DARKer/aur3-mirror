diff -ruN recode-3.6.orig/src/hash.h recode-3.6.new/src/hash.h
--- recode-3.6.orig/src/hash.h	2000-08-03 03:21:15.000000000 +0200
+++ recode-3.6.new/src/hash.h	2008-05-02 20:20:29.000000000 +0200
@@ -21,6 +21,11 @@
 /* Make sure USE_OBSTACK is defined to 1 if you want the allocator to use
    obstacks instead of malloc, and recompile `hash.c' with same setting.  */
 
+#define hash_lookup recode_hash_lookup
+#define hash_delete recode_hash_delete
+#define hash_free   recode_hash_free
+#define hash_insert recode_hash_insert
+
 #ifndef PARAMS
 # if PROTOTYPES || __STDC__
 #  define PARAMS(Args) Args
diff -ruN recode-3.6.orig/src/libiconv.c recode-3.6.new/src/libiconv.c
--- recode-3.6.orig/src/libiconv.c	2000-07-01 19:13:25.000000000 +0200
+++ recode-3.6.new/src/libiconv.c	2008-05-02 20:20:29.000000000 +0200
@@ -1,5 +1,5 @@
 /* Conversion of files between different charsets and surfaces.
-   Copyright © 1999, 2000 Free Software Foundation, Inc.
+   Copyright © 1999, 2000, 2001 Free Software Foundation, Inc.
    Contributed by François Pinard <pinard@iro.umontreal.ca>, 1999,
    and Bruno Haible <haible@clisp.cons.org>, 2000.
 
@@ -195,12 +195,17 @@
 	 memcpy() doesn't do here, because the regions might overlap.
 	 memmove() isn't worth it, because we rarely have to move more
 	 than 12 bytes.  */
-      if (input > input_buffer && input_left > 0)
+      cursor = input_buffer;
+      if (input_left > 0)
 	{
-	  cursor = input_buffer;
-	  do
-	    *cursor++ = *input++;
-	  while (--input_left > 0);
+	  if (input > input_buffer)
+	    {
+	      do
+		*cursor++ = *input++;
+	      while (--input_left > 0);
+	    }
+	  else
+	    cursor += input_left;
 	}
     }
 
diff -ruN recode-3.6.orig/src/recodext.h recode-3.6.new/src/recodext.h
--- recode-3.6.orig/src/recodext.h	2001-01-04 15:36:54.000000000 +0100
+++ recode-3.6.new/src/recodext.h	2008-05-02 20:22:36.000000000 +0200
@@ -218,7 +218,7 @@
     enum recode_symbol_type type : 3;
 
     /* Non zero if this one should be ignored.  */
-    bool ignore : 2;
+    bool ignore : 1;
   };
 
 struct recode_surface_list
diff -ruN recode-3.6.orig/src/request.c recode-3.6.new/src/request.c
--- recode-3.6.orig/src/request.c	2000-06-28 20:40:21.000000000 +0200
+++ recode-3.6.new/src/request.c	2008-05-02 20:20:29.000000000 +0200
@@ -1073,7 +1073,7 @@
   if (task->output.cursor + 4 >= task->output.limit)
     {
       RECODE_OUTER outer = task->request->outer;
-      size_t old_size = task->output.limit - task->output.buffer;
+      size_t old_size = task->output.cursor - task->output.buffer;
       size_t new_size = task->output.cursor + 4 - task->output.buffer;
 
       /* FIXME: Rethink about how the error should be reported.  */
diff -ruN recode-3.6.orig/src/task.c recode-3.6.new/src/task.c
--- recode-3.6.orig/src/task.c	2000-07-01 19:50:43.000000000 +0200
+++ recode-3.6.new/src/task.c	2008-05-02 20:20:29.000000000 +0200
@@ -1198,6 +1198,8 @@
       else
 	success = transform_mere_copy (subtask);
 
+      task->output = subtask->output;
+       
       if (subtask->input.name && *subtask->input.name)
 	fclose (subtask->input.file);
       if (subtask->output.name && *subtask->output.name)

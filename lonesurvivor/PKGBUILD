# Maintainer: Daniel Wallace <danielwallace at gtmanfred dot com>

pkgname=lonesurvivor
pkgver=1.11d
pkgrel=4
pkgdesc="a psychological survival adventure, with art, design, and music by the one-man studio"
arch=('i686' 'x86_64')
url="http://www.superflatgames.com/"
license=('custom')
case $CARCH in 
    i686) depends=('gtk2' 'nss' 'libxft');;
    x86_64)depends=('lib32-gtk2' 'lib32-nss' 'lib32-curl' 'lib32-libxft');;
esac
makedepends=('aria2')
PKGEXT='.pkg.tar'
case $CARCH in 
    i686) _arch=i386; _md5='b205227e25ca915a7994ce4a1a4dd734';;
    x86_64) _arch=amd64; _md5='8ffe1594e81bc6288d1f0eee394118c1';;
esac
options=(!strip)


build() {
    cd $srcdir
    if [[ -f ../$pkgname-$pkgver-$_arch.tar.gz && ! -f $pkgname-$pkgver-$_arch.tar.gz ]]; then
        ln -s ../$pkgname-$pkgver-$_arch.tar.gz ./$pkgname-$pkgver-$_arch.tar.gz
        testmd5=$(md5sum $pkgname-$pkgver-$_arch.tar.gz)
    fi
    if [[ ! -f $pkgname-$pkgver-$_arch.tar.gz || ${testmd5%% *} != $_md5 ]]; then
        echo "You do not have the file required for this install"
        echo if you already have $pkgname-$pkgver-$_arch.tar.gz please place it into $PWD
        echo Otherwise, press Enter to continue
        read
        if [[ -z "${_humblebundleVkey}" ]]; then
            echo You can automate the download of the archive using the _humblebundle4key bash variable.
            echo "Just add export  '_humblebundleVkey=<Your key here>' to .bashrc"
            echo
            echo Otherwise please just place ${_sh} into $(pwd)/
            read
        else
            testfile=$(curl -s https://www.humblebundle.com/downloads\?key\=$_humblebundleVkey | grep "$pkgname-$pkgver-$_arch")
            echo "if you would like to use:"
            echo "aria2c and the torrent file, input 1"
            echo "curl and download the file directly, input 2"
            echo "default is 1, 2 costs HIB bandwidth:"
            read -a _torrent
            if [[ $_torrent -eq 2 ]];then
                testfile=${testfile#*data-web\=\'}
                curl -o $pkgname-$pkgver-$_arch.tar.gz ${testfile%%\'*}
            else
                testfile=${testfile##*data-bt\=\'}
                curl -o $pkgname.torrent ${testfile%%\'*}
                aria2c --seed-time=1 $pkgname.torrent
            fi
        fi
    fi
    _md5sum=$(md5sum $pkgname-$pkgver-$_arch.tar.gz);
    if [[ ${_md5sum%% *} == $_md5 ]];then
        bsdtar xf $pkgname-$pkgver-$_arch.tar.gz
    else
        echo "md5sum of downloaded file is invalid"
        exit
    fi
cat <<EOF > lonesurvivor.desktop
[Desktop Entry]
Categories=Game;
Name=Lone Survivor
Exec=/usr/bin/lonesurvivor
Icon=/usr/share/applications/lonesurvivor.png
Type=Application
EOF
}
package () {
    cd $srcdir/$pkgname
    install -Dm755 $srcdir/$pkgname/LoneSurvivor $pkgdir/usr/bin/$pkgname
    install -Dm644 $srcdir/$pkgname/LoneSurvivor.png $pkgdir/usr/share/applications/$pkgname.png
    install -Dm644 $srcdir/$pkgname.desktop $pkgdir/usr/share/applications/$pkgname.desktop
}

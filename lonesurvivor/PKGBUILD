# Maintainer: Daniel Wallace <danielwallace at gtmanfred dot com>

pkgname=lonesurvivor
pkgver=1.11d
_pkgver=$pkgver-1
pkgrel=5
pkgdesc="a psychological survival adventure, with art, design, and music by the one-man studio"
arch=('i686' 'x86_64')
url="http://www.superflatgames.com/"
license=('custom')
case $CARCH in 
    i686) depends=('gtk2' 'nss' 'libxft');;
    x86_64)depends=('lib32-gtk2' 'lib32-nss' 'lib32-curl' 'lib32-libxft');;
esac
makedepends=('aria2')
PKGEXT='.pkg.tar'
case $CARCH in 
    i686) _arch=i386; _md5='c267e7b6c9a20ca40ee8e795bc92a3fa';;
    x86_64) _arch=amd64; _md5='4d099e1bf1a4fdb30b8b7cff3b485d38';;
esac
options=(!strip)


build() {
    cd $srcdir
    if [[ -f ../$pkgname-$_pkgver-$_arch.tar.gz && ! -f $pkgname-$_pkgver-$_arch.tar.gz ]]; then
        ln -s ../$pkgname-$_pkgver-$_arch.tar.gz ./$pkgname-$_pkgver-$_arch.tar.gz
        testmd5=$(md5sum $pkgname-$_pkgver-$_arch.tar.gz)
    fi
    if [[ ! -f $pkgname-$_pkgver-$_arch.tar.gz || ${testmd5%% *} != $_md5 ]]; then
        echo "You do not have the file required for this install"
        echo if you already have $pkgname-$_pkgver-$_arch.tar.gz please place it into $PWD
        echo Otherwise, press Enter to continue
        read
        if [[ -z "${_humblebundleVkey}" ]]; then
            echo You can automate the download of the archive using the _humblebundleVkey bash variable.
            echo "Just add export  '_humblebundleVkey=<Your key here>' to .bashrc"
            echo
            echo Otherwise please just place ${_sh} into $(pwd)/
            read
        else
            testfile=$(curl https://www.humblebundle.com/downloads\?key\=$_humblebundleVkey | grep "$pkgname-$_pkgver-$_arch")
            echo "if you would like to use:"
            echo "aria2c and the torrent file, input 1"
            echo "curl and download the file directly, input 2"
            echo "default is 1, 2 costs HIB bandwidth:"
            read -a _torrent
            if [[ $_torrent -eq 2 ]];then
                testfile=${testfile#*data-web\=\'}
                curl -o $pkgname-$_pkgver-$_arch.tar.gz ${testfile%%\'*}
            else
                testfile=${testfile##*data-bt\=\'}
                curl -o $pkgname.torrent ${testfile%%\'*}
                aria2c --seed-time=0 $pkgname.torrent
            fi
        fi
    fi
    _md5sum=$(md5sum "$pkgname-$_pkgver-$_arch.tar.gz");
    if [[ ${_md5sum%% *} == $_md5 ]];then
        bsdtar xf "$pkgname-$_pkgver-$_arch.tar.gz"
    else
        echo "md5sum of downloaded file is invalid"
        exit
    fi
cat <<EOF > lonesurvivor.desktop
[Desktop Entry]
Categories=Game;
Name=Lone Survivor
Exec=/usr/bin/lonesurvivor
Icon=/usr/share/applications/lonesurvivor.png
Type=Application
EOF
}
package () {
    cd $srcdir/$pkgname
    install -Dm755 "$srcdir/$pkgname/LoneSurvivor" "$pkgdir/usr/bin/$pkgname"
    install -Dm644 "$srcdir/$pkgname/LoneSurvivor.png" "$pkgdir/usr/share/applications/$pkgname.png"
    install -Dm644 "$srcdir/$pkgname.desktop" "$pkgdir/usr/share/applications/$pkgname.desktop"
}

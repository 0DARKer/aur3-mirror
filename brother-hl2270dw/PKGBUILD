# Maintainer: Jason St. John <jstjohn .. purdue . edu>

pkgname=brother-hl2270dw
_cupswrappername=brhl2270dwcups_src
_lprname=hl2270dwlpr
pkgver=2.0.4.2
_cupswrapperver=2.0.4-2
_lprver=2.1.0-1
pkgrel=1
pkgdesc='Brother HL-2270DW CUPS driver'
arch=('i686' 'x86_64')
url='http://welcome.solutions.brother.com/bsc/public_s/id/linux/en/index.html'
license=('GPL')
depends=('a2ps' 'cups')
source=("http://www.brother.com/pub/bsc/linux/dlf/${_cupswrappername}-${_cupswrapperver}.tar.gz"
        "http://pub.brother.com/pub/com/bsc/linux/dlf/${_lprname}-${_lprver}.i386.rpm")
sha512sums=('fb97551d4ee5d8200a208f76608afbd91357d0f65d8ced7d74be774b95286cac5b884354174a5e7d2a2ba85c00a398ba3cc1efd305e4349ec32a483064979a2b'
            '5ae554f5e96367b7d4ba1e3d63e37f13a3e600487b09671e733b54548ae44a03cb81f8f7e6e047631a0f6c6dcbb7c4b4a17c63178a597148d41e33eeb4647835')

if [[ -z "$CARCH" ]]; then
  echo ":: PKGBUILD could not detect your architecture. Some dependencies may be missing."
elif [[ "$CARCH" == "x86_64" ]]; then
  depends=('a2ps' 'lib32-glibc')
fi

package() {
  cd "$srcdir"
  bsdtar -xf "${_lprname}-${_lprver}.i386.rpm"

  _lprpath="$srcdir/usr/local/Brother/Printer/HL2270DW/"
  pushd "$_lprpath/inf/"
  patch < "$startdir/brHL2270DWrc.patch"
  patch < "$startdir/setupPrintcap2.patch"
  popd

  pushd "$_lprpath/lpd/"
  patch < "$startdir/filterHL2270DW.patch"
  patch < "$startdir/psconvert2.patch"
  popd

  # Install the Brother LPD filter and associated files
  mkdir -p "$pkgdir/usr/share/Brother"
  cp -R "$srcdir/usr/local/Brother" "$pkgdir/usr/share"
  cp -R "$srcdir/var" "$pkgdir/var"
  # These chmod commands are in the cupswrapper installation script. I do not
  # know what their purpose is.
  chmod a+w "$pkgdir/usr/share/Brother/Printer/HL2270DW/inf/brHL2270DWrc"
  chmod a+w "$pkgdir/usr/share/Brother/Printer/HL2270DW/inf"

  # Install the Brother CUPS LPD wrapper filter and the PPD file
  pushd "$srcdir/$_cupswrappername-$_cupswrapperver"
  pushd "$srcdir/$_cupswrappername-$_cupswrapperver/brcupsconfig3/"
  patch < "$startdir/brcupsconfig.c.patch"
  popd
  # These next two lines extract the PPD file and the CUPS LPD wrapper filter
  patch < "$startdir/cupswrapperHL2270DW-2.0.4.patch"
  . cupswrapperHL2270DW-2.0.4
  install -Dm 755 "brlpdwrapperHL2270DW" "$pkgdir/usr/lib/cups/filter/brlpdwrapperHL2270DW"
  install -Dm 644 "HL2270DW.ppd" "$pkgdir/usr/share/cups/model/HL2270DW.ppd"
  popd
}

# vim:set ts=2 sw=2 et:

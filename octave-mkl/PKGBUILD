# Maintainer: jdarch <jda -dot- cloud -plus- archlinux -at- gmail -dot- com>
# Contributor: Ronald van Haren <ronald.archlinux.org>
# Contributor: shining <shiningxc.at.gmail.com>
# Contributor: cyberdune <cyberdune@gmail.com>
# Patches taken from the Debian packaging project and bug trackers

pkgname=octave-mkl
pkgver=3.8.1
pkgrel=2
pkgdesc="A high-level language, primarily intended for numerical computations. BLAS, LAPACK and FFT from Intel's MKL."
arch=('i686' 'x86_64')
url="http://www.octave.org"
license=('GPL')
provides=('octave=3.8.1')
conflicts=('octave')
depends=('intel-mkl' 'fftw' 'curl' 'graphicsmagick' 'glpk' 'hdf5' 'qhull' 'qrupdate' 'fltk' 'arpack' 'glu' 'gl2ps')
makedepends=('llvm>=3.4' 'java-environment' 'gcc-fortran' 'texlive-core' 'suitesparse' 'texinfo' 'gnuplot' 'qscintilla')
optdepends=('texinfo: for help-support in octave'
            'gnuplot: alternative plotting'
            'llvm: to allow use of the JIT'
            'qscintilla: required for the GUI'
            'java-environment: to be able to use Octave`s java interface')
options=('!emptydirs')
install=octave-mkl.install

source=(ftp://ftp.gnu.org/gnu/octave/octave-$pkgver.tar.bz2
        add_info_dir_categories.patch
        llvm-3_4.patch)
md5sums=('4c5b9bd6b82b7fa3191af9706e7204f8'
         'cbde759a77465ae874789df3b602e08f'
         '73106af74218ff81586cea26ccf8901b')
sha512sums=('673ff37692d2ef1116a10afb36448494e69cb01de609017af1a72c3258a1fe71012e9986aafc29127509f7e6664127b4e9b7f269322820b3464eb30ab4b4ef7f'
            '6f6831268a59e05cd407b4e2e1e0f78d4aee91fe2e49d42427bfe976fd4168434e97901e986785393c0d0f8e977e24061397d9b7e8cb15d059aa07c718dfaf82'
            'cf2a17cdcaa909376bafdc71317f43fd6cd42f98141590154761115b9038306e5bb6a11f607cd9afc35c2359fff10cc5cf9df607b50333e2c34680ee77c832d9')

if [ "$CARCH" == "x86_64" ]; then
    _intel_arch=intel64
    _intel_lib=mkl_gf_lp64
elif [ "$CARCH" == "i686" ]; then
    _intel_arch=ia32
    _intel_lib=mkl_gf
fi
_orgpkgname=octave

prepare() {
  # Apply selected patches, conveniently provided by Debian thanks to their diligent packagers
  # Refer to the patch files for details
  cd "${srcdir}/${_orgpkgname}-${pkgver}"

  patch -Np1 -i "${srcdir}/add_info_dir_categories.patch"
  patch -Np1 -i "${srcdir}/llvm-3_4.patch"

  autoreconf -vfi
}

build() {
  # Set environment for building octave with Intel MKL
  source /opt/intel/mkl/bin/mklvars.sh ${_intel_arch}
  _mkllibs=" -fopenmp -Wl,--no-as-needed -I${MKLROOT}/include -I${MKLROOT}/include/fftw -L${MKLROOT}/lib/intel64 -l${_intel_lib} -lmkl_core -lmkl_gnu_thread -ldl -lpthread -lm"
  export LANG=C

  cd "${srcdir}/${_orgpkgname}-${pkgver}"

  ./configure  MOC=moc-qt4 UIC=uic-qt4 \
  --prefix=/usr --libexecdir=/usr/lib \
  --enable-shared --disable-static \
  --enable-jit \
  --with-blas="${_mkllibs}" \
  --with-lapack="${_mkllibs}" \
  --with-fftw3="${_mkllibs}" \
  --with-fftw3f="${_mkllibs}"

  # Put Intel's basic math library in front of the GLIBC libm
  find ./ -name Makefile -exec sed -i "s/\(^\| \)-lm\( \|$\)/\1-limf -lm\2/g" {} \;

  make
}

check() {
  cd "${srcdir}/${_orgpkgname}-${pkgver}"

  make check
}

package() {
  cd "${srcdir}/${_orgpkgname}-${pkgver}"

  make DESTDIR="${pkgdir}" install

  # add octave library path to ld.so.conf.d
  install -d "${pkgdir}/etc/ld.so.conf.d"
  echo "/usr/lib/${_orgpkgname}/${pkgver}" > "${pkgdir}/etc/ld.so.conf.d/${_orgpkgname}.conf"
}

# Maintainer: B <gotleenucks at gmail dot com>
# Contributor: DonVla <donvla@users.sourceforge.net>
# Contributor: Ulf Winkelvos <ulf [at] winkelvos [dot] de>
# Contributor: Ralf Barth <archlinux dot org at haggy dot org>
#
# Original credits go to Edgar Hucek <gimli at dark-green dot com>
# for his xbmc-vdpau-vdr PKGBUILD at https://archvdr.svn.sourceforge.net/svnroot/archvdr/trunk/archvdr/xbmc-vdpau-vdr/PKGBUILD.
# This PKGBUILD is an adaptation of the xbmc-git PKGBUILD in the AUR; credits go to the people who contributed to that.
#
# XvBA support courtesy of Fernet Menta (https://github.com/FernetMenta)
# Thanks to Stephan Raue from the OpenELEC project for integrating the XvBA code into the main Xbmc tree

pkgname=xbmc-xvba
pkgver=11.0_beta1
_pkgver=11.0-Eden_beta1
pkgrel=6
pkgdesc="XBMC Media Center with XvBA support"
provides=('xbmc')
conflicts=('xbmc' 'xbmc-pulse' 'xbmc-svn' 'xbmc-git' 'xbmc-git-xvba')
arch=('i686' 'x86_64')
url="http://www.xbmc.org"
license=('GPL' 'LGPL')
depends=('faac' 'faad2' 'glew' 'hicolor-icon-theme' 'jasper' 'libass' 'libcdio' 'libmad' 'libmodplug' 'libmpeg2' 'libmicrohttpd'
	 'libplist' 'libmysqlclient' 'libsamplerate' 'libxtst' 'libxrandr' 'lzo2' 'python2' 'samba' 'sdl_image>=1.2.10'
	 'sdl_mixer' 'sqlite3' 'wavpack' 'yajl' 'xvba-sdk')
makedepends=('boost' 'cmake' 'git' 'gperf' 'nasm' 'zip' 'unzip')
optdepends=('avahi: to use zerconf features (remote, etc...)' 
            'gdb: for meaningful backtraces in case of trouble - STRONGLY RECOMMENDED' 
            'libcrystalhd: Broadcom CrystalHD kernel module'
            'libssh: support for sshfs'
            'libvdpau: accelerated video playback for nvidia cards' 
            'libva: accelerated video playback for nvidia, ati/amd and some intel cards'
            'lirc: remote controller support' 
            'pulseaudio: pulseaudio support'
            'udisks: automount external drives' 
            'upower: used to trigger suspend functionality' 
            'python-simplejson: weather service functionality'
            'unrar: access compressed files without unpacking them')
options=('makeflags')
changelog="$pkgname.changelog"
install="${pkgname%-xvba}.install"
source=(http://mirrors.xbmc.org/releases/source/${pkgname%-xvba}-$_pkgver.tar.gz
	https://raw.github.com/OpenELEC/OpenELEC.tv/master/packages/mediacenter/xbmc/patches/xbmc-22ad8e4-901.01-ee1a1e2c428b5923da9c39f5a78bc9208e4f2047.patch
	https://raw.github.com/OpenELEC/OpenELEC.tv/master/packages/mediacenter/xbmc/patches/xbmc-22ad8e4-901.02-2f91d0ca3735ab9b1abbfe6e3c6613e56951b7d2.patch
	https://raw.github.com/OpenELEC/OpenELEC.tv/master/packages/mediacenter/xbmc/patches/xbmc-22ad8e4-901.03-32df6ef9fc30cd2215e2a0886ceb5dab368ee31a.patch
	https://raw.github.com/OpenELEC/OpenELEC.tv/master/packages/mediacenter/xbmc/patches/xbmc-22ad8e4-902.01-xvba_support-5d594445f1f63f73a1feeebc96cadcf197372dc1.patch)

build() {

    cd "${srcdir}/xbmc-$_pkgver"

    # Uncomment when building offline. Xbmc's build process is happy when the tarballs are present in
    # their respective directories and will not try to download them - a welcome relief. Either way,
    # pulling in source code halfway through the build process is messy, and annoying.
    #cp ${srcdir}/Imaging-${_imagingver}.tar.gz ${srcdir}/$pkgname-$pkgver/lib/addons/script.module.pil
    #cp ${srcdir}/pysqlite-${_pysqlitever}.tar.gz ${srcdir}/$pkgname-$pkgver/lib/addons/script.module.pysqlite
    

    # Configure XBMC
    #
    # Note on external-libs:
    #   - We cannot use external python because Arch's python was built with
    #     UCS2 unicode support, whereas xbmc expects UCS4 support
    #   - We cannot use Arch's libass because it's incompatible with XBMC's subtitle rendering
    #   - According to an xbmc dev using external/system ffmpeg with xbmc is "pure stupid" :D
    
    # Arch Linux has a funky LDFLAGS default setup.  Lets drop it to fix
    # possible linking issues later on. --as-needed is the linker flag
    # causing trouble.
    unset LDFLAGS; LDFLAGS="-Wl,--hash-style=gnu"


    # If you feel adventurous, you can play with the CFLAGS
    #unset {CFLAGS,CXXFLAGS}
    #export CFLAGS="-march=pentium-m -O2 -pipe" 		# -fomit-frame-pointer would interfere with debugging
    #export CXXFLAGS="$CFLAGS"

    # Fix lsb_release dependency
    sed -i -e 's|lsb_release -d|echo Arch Linux|' xbmc/utils/SystemInfo.cpp
        
    # Take out the gtk-update-icon-cache command
    sed -i '/gtk-update-icon-cache/d' Makefile.in

    # XvBA support (experimental!)
    msg "Patching in XvBA support"
    # Makepkg doesn't seem to strip HTTPS URLs
    patch -Np1 -i $srcdir/${source[1]##*/}
    patch -Np1 -i $srcdir/${source[2]##*/}
    patch -Np1 -i $srcdir/${source[3]##*/}
    patch -Np1 -i $srcdir/${source[4]##*/}
    
    msg "Bootstrapping XBMC" 
    ./bootstrap

    msg "Configuring XBMC" 
    export PYTHON_VERSION=2  # external python v2
    ./configure --prefix="/usr" \
                --enable-external-libraries \
                --disable-external-ffmpeg \
		--enable-xvba \
                --enable-debug 

    # Now (finally) build
    msg "Running make" 
    make

}

package() {

    cd "${srcdir}/${pkgname%-xvba}-$_pkgver"
    msg "Running make install" 
    make prefix=${pkgdir}/usr/ install

    # lsb_release fix
    sed -i -e 's/which lsb_release &> \/dev\/null/\[ -f \/etc\/arch-release ]/g' "${pkgdir}/usr/bin/xbmc"
    sed -i -e "s/lsb_release -a 2> \/dev\/null | sed -e 's\/\^\/    \/'/cat \/etc\/arch-release/g" "${pkgdir}/usr/bin/xbmc"

    # .desktop files
    install -D -m 0644 "${srcdir}/${pkgname%-xvba}-$_pkgver/tools/Linux/xbmc.desktop" "${pkgdir}/usr/share/applications/xbmc.desktop"
    install -D -m 0644 "${srcdir}/${pkgname%-xvba}-$_pkgver/tools/Linux/xbmc-48x48.png" "${pkgdir}/usr/share/pixmaps/xbmc.png"


    # Tools
    install -Dm755 ${srcdir}/${pkgname%-xvba}-$_pkgver/xbmc-xrandr ${pkgdir}/usr/share/xbmc/xbmc-xrandr
    install -Dm755 ${srcdir}/${pkgname%-xvba}-$_pkgver/tools/TexturePacker/TexturePacker ${pkgdir}/usr/share/xbmc/

    # Licenses
    install -dm755 ${pkgdir}/usr/share/licenses/${pkgname}
    for licensef in LICENSE.GPL copying.txt; do
        mv ${pkgdir}/usr/share/doc/xbmc/${licensef} ${pkgdir}/usr/share/licenses/${pkgname}
    done

    # Docs 
    install -d -m 0755 "${pkgdir}/usr/share/doc/${pkgname}" 
    for docsf in keymapping.txt README.linux; do 
        mv "${pkgdir}/usr/share/doc/xbmc/${docsf}" "${pkgdir}/usr/share/doc/${pkgname}" 
     done

    # Clean up some stuff
    msg "Cleanup unneeded files"
    rm -rf ${pkgdir}/usr/share/xsessions
    rm -f ${pkgdir}/usr/share/icons/hicolor/icon-theme.cache

    # Strip
    msg "Stripping binaries"
    find $pkgdir -type f -exec strip {} \; >/dev/null 2>/dev/null

}

sha1sums=('9b7950f1717cea162a4f2502be3d54c6a2388054'
          '49c16997a946d2598f02426ca425f4c6ffda8a8c'
          '78a8d496a076bf517436b96f924c7082389a406a'
          '9b41077c8ef5a2f8893ac2d0f089ad8018c3af0c'
          '5a6411aa556a3347a6823350a78524aee47d6747')

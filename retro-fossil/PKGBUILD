pkgname=retro-fossil
pkgver=11
pkgrel=3
pkgdesc="Retro is a portable, stack-based language with roots in Forth."
arch=('i686' 'x86_64')
url="http://retroforth.com"
license=('Public Domain')
makedepends=('fossil' 'docutils')
provides=('retro')
install=
changelog=$pkgname.changelog
source=()
md5sums=()

_fossil_repo="http://rx-core.org/rx.fossil"
_fossil_name="rx"

build() {
  
  [ -e "$startdir/$_fossil_name"  ] || ( cd $startdir; fossil clone $_fossil_repo $_fossil_name )
  [ -e "$srcdir/$_fossil_name"    ] || ( cd $srcdir; ln -s $startdir/$_fossil_name $_fossil_name )
  [ -e "$srcdir/$pkgname-$pkgver" ] || ( mkdir $srcdir/$pkgname-$pkgver; )

  cd $srcdir/$pkgname-$pkgver

  if [ -e "_FOSSIL_" ] ; then
    fossil pull
  else
    fossil open $srcdir/$_fossil_name
  fi

  sed '/define GLOBAL/ s#/local##' -i vm/retro.c vm/experimental/retro64/retro64.c

  msg "creating docs"
  make docs
  msg "creating vm"
  make retro
  msg "creating image"
  make image

  if [[ "$CARCH" == "x86_64" ]]; then
    msg "creating 64-bit vm"
    (cd vm/experimental/retro64; make )
  fi

}

package() {
  cd "$srcdir/$pkgname-$pkgver"
  mkdir -p $pkgdir/usr/{bin,share/{man/man1,retro,{doc,licenses}/retro}}
  
  gzip -c9 doc/retro.1 > $pkgdir/usr/share/man/man1/retro.1.gz
  xz -c9 LICENSE > $pkgdir/usr/share/licenses/retro/LICENSE.xz
  xz -c9 core.rx > $pkgdir/usr/share/retro/core.rx.xz
  install -m755 retro $pkgdir/usr/bin/retro
  install -m644 retroImage $pkgdir/usr/share/retro
  if [[ "$CARCH" == "x86_64" ]]; then
    install -m755 vm/experimental/retro64/retro64 $pkgdir/usr/bin/retro64
    install -m644 vm/experimental/retro64/retroImage64 $pkgdir/usr/share/retro
  fi
  cp doc/*.html $pkgdir/usr/share/doc/retro

}

# vim:set ts=2 sw=2 et:

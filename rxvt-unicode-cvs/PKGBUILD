# Contributor: Kosenko Roman <madkite@gmail.com>
pkgname=rxvt-unicode-cvs
pkgver=20100816
pkgrel=1
pkgdesc='A clone of the well known terminal emulator rxvt, development version'
url='http://software.schmorp.de/pkg/rxvt-unicode.html'
license=('GPL2')
arch=('i686' 'x86_64')
depends=('gcc-libs' 'libxft' 'libxpm')
makedepends=('ncurses' 'perl' 'pkgconfig' 'cvs')
optdepends=('perl: plugins' 'xsel-svn: clipboard support')
_patch_dir="ftp.debian.org/debian/pool/main/${pkgname::1}/${pkgname%-*}"
_patch_file=$(curl -s "http://${_patch_dir}/?C=M;O=D" | perl -ne 'print "$1\n" if /[="]([^"]+\.diff\.gz)/' | head -n1)
source=(ftp://${_patch_dir}/${_patch_file} \
		urxvtcd.sh tabbed.pl remote-clipboard.pl pagescroll.pl x-defaults \
		noinc.patch popup-menu-hang.patch default-daemon-options.patch)
provides=('rxvt-unicode')
conflicts=('rxvt-unicode')

_cvsroot=":pserver:anonymous:@cvs.schmorp.de/schmorpforge"
_cvsmod="rxvt-unicode"

build() {
	cd ${startdir}/src
	msg "Connecting to ${_cvsmod} CVS server...."
	if [ -d ${_cvsmod}/CVS ]; then
		cd ${_cvsmod}
		cvs -z3 update -d
	else
		cvs -z3 -d ${_cvsroot} co -D ${pkgver} -f ${_cvsmod}
		cd ${_cvsmod}
	fi
	rm -rf ../${_cvsmod}-new
	mkdir ../${_cvsmod}-new
	cp -r . ../${_cvsmod}-new
	cd ../${_cvsmod}-new

	msg "Patching..."
	patch -fi ../${_patch_file%.gz} -p1 || true
	#for i in debian/patches/{select-quoted,tabbed-deskprop}.patch; do patch -i ${i} -p1; done
	#for i in src/{command,misc}.C; do sed -r 's/str(r?)chr\s*\(str,/str\1chr ((char *)str,/g' -i "$i"; done
	#sed 's|\.\(/podtbl \)|$(srcdir)\1|' -i doc/Makefile.in || true
	mv -f doc/Makefile.in.orig doc/Makefile.in || true
	patch -p1 -i ../noinc.patch || return $?
	patch -p0 -i ../popup-menu-hang.patch || return $?
	patch -p0 -i ../default-daemon-options.patch || return $?
	#patch -p0 -i ../font-width-fix.patch || return $?

	msg "Starting make..."
	rm -rf ../${_cvsmod}-build
	mkdir ../${_cvsmod}-build
	cd ../${_cvsmod}-build
	../${_cvsmod}-new/configure --prefix=/usr --with-terminfo=/usr/share/terminfo --mandir=/usr/man \
		--enable-xft \
		--enable-font-styles \
		--disable-xim \
		--disable-unicode3 \
		--disable-combining \
		--disable-fallback \
		--disable-utmp \
		--disable-wtmp \
		--disable-lastlog \
		--disable-afterimage \
		--disable-transparency \
		--enable-fading \
		--disable-rxvt-scroll \
		--disable-next-scroll \
		--disable-xterm-scroll \
		--enable-frills \
		--disable-iso14755 \
		--disable-keepscrolling \
		--enable-selectionscrolling \
		--enable-mousewheel \
		--enable-slipwheeling \
		--enable-smart-resize \
		--enable-perl \
		--enable-256-color \
		--with-term=rxvt \
		|| return $?
	make || return $?
	mkdir -p ${startdir}/pkg/usr/share/terminfo
	TERMINFO=${startdir}/pkg/usr/share/terminfo make DESTDIR=${startdir}/pkg install || return $?
	install -m755 ../urxvtcd.sh ${startdir}/pkg/usr/bin/urxvtcd
	install -m644 -D ../${_cvsmod}-new/debian/urxvtcd.1 ${startdir}/pkg/usr/man/man1/urxvtcd.1 || true
	install -m644 -D ../x-defaults ${startdir}/pkg/etc/X11/app-defaults/URxvt
	cd ..
	for i in *.pl; do install -m644 -D ${i} ${startdir}/pkg/usr/lib/urxvt/perl/${i%.pl}; done
}

md5sums=('7d6910c910fcf24004adc2633310d3ed'
         'bb73d416b4b1bf7708c422ae514e3fab'
         'de9f9c9516e9255a5edd4056e1d021e5'
         '8eea30c5aa019160f5b8bf6172b4cc77'
         '451e64febc1d55411f8ad4ca57875800'
         'e178258e4bee1d38e317769106347f2c'
         '656aacc2a220ccb6115afd7718eb9c6d'
         'aead33ba3b08eeb251fb0c1427a4a024'
         '21fd950ef65d6c00ca4b8c669a0ca552')

# Maintainer: Lauri Niskanen <ape@ape3000.com>
# Contributor: schlaefer <schlaefer[at]gamez-planet.org>

pkgname=mumble-git
pkgver=20100704
pkgrel=1
pkgdesc="A voice chat application similar to TeamSpeak"
arch=('i686' 'x86_64')
url="http://mumble.sourceforge.net/"
license=('GPL')
depends=('alsa-lib' 'qt>=4.4.0' 'speex>=1.2rc1' 'celt>=0.7.0' 'lsb-release')
makedepends=('git' 'protobuf' 'boost' 'avahi' 'libxi' 'mesa')
optdepends=('pulseaudio: for using mumble with pulseaudio')
provides=('mumble')
conflicts=('mumble')
options=('!libtool')
install=mumble.install
source=(mumble11x.desktop)
md5sums=('b85a15a46a8d0e9a28e87ff6678bb36a')

_gitroot="git://mumble.git.sourceforge.net/gitroot/mumble/mumble"
_gitname="mumble"

build() {
cd "$srcdir"
msg "Connecting to GIT server...."

if [ -d $_gitname ] ; then
cd $_gitname && git pull origin
msg "The local files are updated."
else
git clone $_gitroot
fi

msg "GIT checkout done or server timeout"
msg "Starting make..."

rm -rf "$srcdir/$_gitname-build"
git clone --depth 1 "$srcdir/$_gitname" "$srcdir/$_gitname-build"
cd "$srcdir/$_gitname-build"

# BUILD

qmake main.pro \
CONFIG+="no-bundled-speex no-bundled-celt no-speechd no-g15 no-xevie \
no-server no-embed-qt-translations packaged" \
DEFINES+="PLUGIN_PATH=/usr/lib/mumble/plugins" || return 1
make || return 1

# INSTALL

install -m755 -D $srcdir/$_gitname-build/release/mumble $pkgdir/usr/bin/mumble
install -m755 -D $srcdir/$_gitname-build/release/mumble11x $pkgdir/usr/bin/mumble11x
install -m755 -D $srcdir/$_gitname-build/scripts/mumble-overlay $pkgdir/usr/bin/mumble-overlay
install -m755 -d $pkgdir/usr/lib/mumble/plugins
install -m755 -D $srcdir/$_gitname-build/release/libmumble.so.1.2.3 $pkgdir/usr/lib/mumble/
ln -s libmumble.so.1.2.3 $pkgdir/usr/lib/mumble/libmumble.so
ln -s libmumble.so.1.2.3 $pkgdir/usr/lib/mumble/libmumble.so.1
ln -s libmumble.so.1.2.3 $pkgdir/usr/lib/mumble/libmumble.so.1.2
install -m755 -D $srcdir/$_gitname-build/release/mumble $pkgdir/usr/bin/mumble
install -m755 -D $srcdir/$_gitname-build/release/plugins/liblink.so $pkgdir/usr/lib/mumble/plugins/
install -m755 -d $pkgdir/usr/share/applications
install -m644 -D $srcdir/$_gitname-build/scripts/mumble.desktop $pkgdir/usr/share/applications/mumble.desktop
install -m644 -D $srcdir/mumble11x.desktop $pkgdir/usr/share/applications/mumble11x.desktop
install -m755 -d $pkgdir/usr/share/man/man1
install -m644 -D $srcdir/$_gitname-build/man/mum* $pkgdir/usr/share/man/man1/
install -m644 -D $srcdir/$_gitname-build/icons/mumble.svg $pkgdir/usr/share/icons/hicolor/scalable/apps/mumble.svg

}

# Maintainer: Felix Yan <felixonmars@gmail.com>
# Contributor: cuihao <cuihao dot leo at gmail dot com>
# Contributor: Guten <ywzhaifei@gmail.com> 

pkgname=goagent
pkgver=1.8.6
pkgrel=1
pkgdesc="A gae proxy forked from gappproxy/wallproxy"
arch=("i686" "x86_64")
url="http://goagent.googlecode.com"
license=("GPL2")
depends=('python2' 'python2-pyopenssl')
optdepends=(
    'python26: (AUR) upload GAE code using /opt/server/uploader.zip'
    'systemd-goagent-units: (AUR) systemd service'
)
source=(
  "daemon.goagent"
  "https://github.com/phus/goagent/tarball/v$pkgver"
)
md5sums=('94e66bb9673157bc7fcfc2e7d01be389'
         '00482d668ec2b9976a71e43a97067abc')
backup=('etc/goagent')
install='goagent.install'

build() {
  cd $srcdir
  tar xzvf $srcdir/v$pkgver

  mv phus-goagent-* $pkgname
}

package() {
    cd "$srcdir/$pkgname"

    # python2 fix
    sed -i -re "1s/python2?/python2/" local/*.py
    chmod +x local/proxy.py

    mkdir -p "$pkgdir/opt/goagent"
    cp -r local server "$pkgdir/opt/goagent"
  
    # remove windows-only files
    rm -f "$pkgdir/opt/goagent/"*/*.{vbs,dll,exe,manifest,bat}

    # config file
    mkdir -p "$pkgdir/etc/rc.d"
    mv "$pkgdir/opt/goagent/local/proxy.ini" "$pkgdir/etc/goagent"
    ln -s "$pkg/etc/goagent" "$pkgdir/opt/goagent/local/proxy.ini"

    # rc.d daemon
    cp "$srcdir/daemon.goagent" "$pkgdir/etc/rc.d/goagent"
}

# vim:set ts=2 sw=2 et:

# Maintainer:  Christian Brassat, crshd at mail dot com

pkgname=rtorrent-pyro
pkgver=0.8.9
pkgrel=1
pkgdesc="rTorrent with Pyroscope patches"
url="http://libtorrent.rakshasa.no"
arch=any
license=('GPLv2')
depends=('libtorrent' 'xmlrpc-c')
conflicts=('rtorrent')
replaces=('rtorrent')
source=("http://libtorrent.rakshasa.no/downloads/${pkgname%-pyro}-${pkgver}.tar.gz"
		  "pyroscope-patches-0.8.9.tar.bz2"
        "ui_pyroscope_unicode.patch"
        "kb_vi_akston.patch")
md5sums=('629247636cb1210663b52dadbd040a6c'
         'fef35d7b16e6d15aac09a1301779233c'
         '3261c8c8009831d38678fd14487caa06'
         'b512babd89e65a94c949088da0745446')

build() {
	patch -uRp0 -i ${srcdir}/ui_pyroscope_unicode.patch
	cd ${srcdir}/${pkgname%-pyro}-${pkgver}

	patch -uNp1 -i ${srcdir}/kb_vi_akston.patch
	
	# Apply pyroscrope patches
	# I tried to clean it up a bit, those guys created a fucked up mess
	for corepatch in ${srcdir}/ps-*_${pkgver}.patch; do
		patch -uNp1 -i ${corepatch}
	done

	for backport in ${srcdir}/backport_${pkgver}_*.patch; do
		patch -uNp0 -i ${backport}
	done

	patch -uNp1 -i ${srcdir}/pyroscope.patch
	for i in ${srcdir}/*.{cc,h}; do
		ln -nfs ${i} srcdir
	done

	patch -uNp1 -i ${srcdir}/ui_pyroscope.patch

	sed -i -e 's/rTorrent \" VERSION/rTorrent-PatchedToHell " VERSION/' src/ui/download_list.cc
	# End pyroscope patches

	./configure \
		--prefix=/usr \
		--mandir=/usr/man \
		--with-xmlrpc-c
	make
}

package() {
	cd ${srcdir}/${pkgname%-pyro}-${pkgver}
	make install DESTDIR=${pkgdir}
	install -m 644 -D doc/rtorrent.1 ${pkgdir}/usr/man/man1/rtorrent.1
}

# Maintainer: Clément Junca <cju.arch -- gmail -- com>
# Contributor: Philip Müller <mail at philip.in-aachen dot net>
pkgname=opa-bin
pkgver=1.1.0
pkgrel=1
pkgdesc="Rapid + Secure Web Development"
arch=(i686 x86_64)
url="http://opalang.org"
license=(MIT AGPL)
depends=('openssl>=0.9.8' 'nodejs<=0.8.18' 'zlib>=1.2.3.4')
optdepends=('mongodb: database backend')
provides=(opa)
conflicts=(opa-git)
replaces=()
backup=()
options=(!strip)
install=
md5sums=(503a712992dc22e20c29adc21954d4e5)

_suffix="x86"
[[ "${CARCH}" = "x86_64" ]] && _suffix='x64' && md5sums=(25c12040a8876d56c75fcf48fa8ea933)

_source_script_name=(opa-${pkgver}.${_suffix}.run)
source=(https://github.com/downloads/MLstate/opalang/${_source_script_name})
noextract=(opa-${pkgver}.${_suffix}.run)

build() {
  cd $srcdir
  chmod +x $_source_script_name
  ./$_source_script_name --target $srcdir/opa --noexec --keep --nox11
}

package() {
  cd $pkgdir

  cp -a $srcdir/opa usr
  usr/share/opa/install.sh --dir usr --prefix /usr

  chmod 755 $pkgdir/usr

  rm usr/install.sh
  rm usr/share/opa/uninstall.sh
  rm usr/share/opa/install.sh

  install -d usr/share/licenses/opa-bin usr/share/vim/vimfiles/{ftdetect,syntax}

  ln -s -T /usr/share/doc/opa/copyright "usr/share/licenses/${pkgname}/COPYRIGHT"
  ln -s -T /usr/share/doc/opa/other_licenses "usr/share/licenses/${pkgname}/OTHER_LICENSES"
  ln -s /usr/share/opa/vim/ftdetect/opa.vim usr/share/vim/vimfiles/ftdetect
  ln -s /usr/share/opa/vim/syntax/opa.vim usr/share/vim/vimfiles/syntax
}

# Contributor: Joerg Hansen (joerg dot hansen at gmx dot net)

pkgname=osm2pgsql-svn
pkgver=21135
pkgrel=1
pkgdesc="Utility program that converts OpenStreetMap (.OSM) data into a format that can be loaded into PostgreSQL."
url="http://wiki.openstreetmap.org/wiki/Osm2pgsql"
arch=(i686 x86_64)
license=('LGPL')
depends=('postgis' 'libxml2' 'bzip2' 'zlib')
makedepends=('subversion')
source=()
md5sums=()

_svntrunk=http://svn.openstreetmap.org/applications/utils/export/osm2pgsql
_svnmod=osm2pgsql

build() {
    cd ${srcdir}

    if [ -d $_svnmod/.svn ]; then
        (cd $_svnmod && svn up -r $pkgver)
    else
        svn co $_svntrunk --config-dir ./ -r $pkgver $_svnmod
    fi

    msg "SVN checkout done or server timeout"
    msg "Starting make..."

    cp -r $_svnmod $_svnmod-build
    cd $_svnmod-build

    # Remove debug info
    sed -i -e "/CFLAGS += /s/-g -O2/-O2 -fomit-frame-pointer/" Makefile.in
    sed -i -e "/LDFLAGS += /s/-g //" Makefile.in

    # Build and install
    autoconf
    ./configure --prefix=/usr
    make || return 1
    make DESTDIR="$pkgdir" install || return 1

    # Install additional files
    mkdir -p ${pkgdir}/usr/share/doc/osm2pgsql
    install -m644 README.txt ${pkgdir}/usr/share/doc/osm2pgsql
    install -m644 900913.sql ${pkgdir}/usr/share/osm2pgsql

    rm -rf ${srcdir}/$_svnmod-build
}

# Contributor: Luca Bennati <lucak3 AT gmail DOT com>
# Maintainer: Glaucous <glakke1 at gmail dot com>

pkgname=apitrace
pkgver=3.0
pkgrel=1
pkgdesc="Graphics API Tracing"
arch=('x86_64' 'i686')
url="https://github.com/apitrace/apitrace"
license=('BSD')
groups=()
depends=('python2' 'libgl')
makedepends=('cmake>=2.8' 'git' 'mesa')
optdepends=('qt: GUI support' 'qjson: GUI support')
provides=('apitrace')
conflicts=('apitrace-git')
replaces=()
backup=()
options=()
install=
changelog=
source=('LICENSE')
noextract=()
md5sums=('85536f1e169f24a548762a3cbbcd227c')

# Renamed so that makepkg doesn't think this is a -git package.
_thegitroot='git://github.com/apitrace/apitrace.git'
_thegitname='apitrace'
_tag='3.0'

build() {
  cd "${srcdir}"
  msg "Connecting to GIT server...."

  if [[ -d "${_thegitname}" ]]; then
    cd "${_thegitname}"
	git checkout master
	git pull origin
    msg "The local files are updated."
  else
    git clone "${_thegitroot}" "${_thegitname}"
	cd "${_thegitname}"
  fi

  git checkout $_tag
  msg "GIT checkout done or server timeout"
  msg "Starting build..."


  cd "${srcdir}"
#unset LDFLAGS
  cmake -H"${_thegitname}" -Bbuild -DCMAKE_INSTALL_PREFIX=/usr -DPYTHON_EXECUTABLE='/usr/bin/python2.7'
  make -C build
}

package() {
  cd "${srcdir}/build"
  make DESTDIR="${pkgdir}/" install

  mkdir -p "${pkgdir}"/usr/share/licenses/apitrace
  msg "Moving LICENSE to /usr/share/licenses"
  mv "${pkgdir}"/usr/share/{doc,licenses}/apitrace/LICENSE
}

# Maintainer: Glaucous <glakke1 at gmail dot com>
pkgname=apitrace
pkgver=1.0
pkgrel=3
pkgdesc="Graphics API Tracing"
arch=('x86_64' 'i686')
url="https://github.com/apitrace/apitrace"
license=('BSD')
groups=()
depends=('python>=2.6' 'libgl')
makedepends=('cmake>=2.8' 'git')
optdepends=('qt: GUI support' 'qjson: GUI support')
provides=('apitrace')
conflicts=('apitrace-git')
replaces=()
backup=()
options=()
install=
changelog=
source=('LICENSE')
noextract=()
md5sums=('85536f1e169f24a548762a3cbbcd227c')

_gitroot='git://github.com/apitrace/apitrace.git'
_gitname='apitrace'
_branch='1.0'

build() {
	unset LDFLAGS

	cd ${srcdir}

    msg "Connecting to the GIT server.."
    if [[ -d ${srcdir}/${_gitname} ]] ; then
        cd ${_gitname}
        git pull origin
        msg "The local files are updated."
    else
        git clone ${_gitroot}
    fi
    
    msg "GIT checkout done."
    
    if [[ -d ${srcdir}/${_gitname}-build ]]; then
       msg "Cleaning the previous build directory.." 
       rm -rf ${srcdir}/${_gitname}-build
    fi

	msg "Cloning git.."

    git clone ${srcdir}/${_gitname} ${srcdir}/${_gitname}-build
	msg "Checking out branch ${_branch}.."
	cd ${srcdir}/${_gitname}-build
	git checkout ${_branch}

	msg "Running cmake and make.."
	cd ${srcdir}/${_gitname}-build
	cmake -H. -Bbuild
	make -C build

	install -D "${srcdir}/${_gitname}-build/build/glretrace" "${pkgdir}/usr/bin/glretrace"
	install -D "${srcdir}/${_gitname}-build/build/qapitrace" "${pkgdir}/usr/bin/qapitrace"
	install -D "${srcdir}/${_gitname}-build/build/tracedump" "${pkgdir}/usr/bin/tracedump"

	install -D "${srcdir}/${_gitname}-build/build/glxtrace.so" "${pkgdir}/usr/lib/glxtrace.so"

	install -D -m644 "${srcdir}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

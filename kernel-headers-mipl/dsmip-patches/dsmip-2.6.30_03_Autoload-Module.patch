Index: linux-2.6.30/net/ipv4/xfrm4_udp_encap.c
===================================================================
--- linux-2.6.30.orig/net/ipv4/xfrm4_udp_encap.c
+++ linux-2.6.30/net/ipv4/xfrm4_udp_encap.c
@@ -12,6 +12,7 @@
 #include <net/inet_ecn.h>
 #include <linux/netfilter.h>
 #include <linux/netfilter_ipv4.h>
+#include <linux/in.h>
 
 /* TLV as defined in draft-ietf-mext-nemo-v4traversal-01 */
 struct tlvhdr {
@@ -326,16 +327,19 @@ static struct net_protocol udp_encap_pro
 
 static int __init udp_encap_init(void)
 {
-  printk(KERN_INFO "registering udp_encap type and protocol handler\n");
+	printk(KERN_INFO "registering udp_encap type and protocol handler\n");
+
 	if (xfrm_register_type(&udp_encap_type, AF_INET) < 0) {
 		printk(KERN_INFO "ip udp_encap init: can't add xfrm type\n");
 		return -EAGAIN;
 	}
- 	if (inet_add_protocol(&udp_encap_protocol, IPPROTO_UDP_ENCAPSULATION) < 0) {
+
+	if (inet_add_protocol(&udp_encap_protocol, IPPROTO_UDP_ENCAPSULATION) < 0) {
  		printk(KERN_INFO "ip udp_encap init: can't add protocol\n");
  		xfrm_unregister_type(&udp_encap_type, AF_INET);
  		return -EAGAIN;
  	}
+
 	return 0;
 }
 
@@ -350,3 +354,4 @@ static void __exit udp_encap_fini(void)
 module_init(udp_encap_init);
 module_exit(udp_encap_fini);
 MODULE_LICENSE("GPL");
+MODULE_ALIAS_XFRM_TYPE(AF_INET, XFRM_PROTO_UDP_ENCAPS);
Index: linux-2.6.30/include/net/xfrm.h
===================================================================
--- linux-2.6.30.orig/include/net/xfrm.h
+++ linux-2.6.30/include/net/xfrm.h
@@ -30,6 +30,7 @@
 #define XFRM_PROTO_IPV6		41
 #define XFRM_PROTO_ROUTING	IPPROTO_ROUTING
 #define XFRM_PROTO_DSTOPTS	IPPROTO_DSTOPTS
+#define XFRM_PROTO_UDP_ENCAPS	IPPROTO_UDP_ENCAPSULATION
 
 #define XFRM_ALIGN8(len)	(((len) + 7) & ~7)
 #define MODULE_ALIAS_XFRM_MODE(family, encap) \
Index: linux-2.6.30/include/linux/in.h
===================================================================
--- linux-2.6.30.orig/include/linux/in.h
+++ linux-2.6.30/include/linux/in.h
@@ -47,7 +47,7 @@ enum {
   IPPROTO_SCTP   = 132,		/* Stream Control Transport Protocol	*/
   IPPROTO_UDPLITE = 136,	/* UDP-Lite (RFC 3828)			*/
 
-  IPPROTO_UDP_ENCAPSULATION = 166,/* IPv6 in UDP pseudo protocol for DSMIP */
+#define  IPPROTO_UDP_ENCAPSULATION	166 /* IPv6 in UDP pseudo protocol for DSMIP */
 
   IPPROTO_RAW	 = 255,		/* Raw IP packets			*/
   IPPROTO_MAX

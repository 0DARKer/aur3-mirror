# Maintainer: Glaucous <glakke1 at gmail dot com>
pkgname=apitrace-git
pkgver=20110503
pkgrel=1
pkgdesc="Graphics API Tracing"
arch=('x86_64' 'i686')
url="https://github.com/apitrace/apitrace"
license=('BSD')
groups=()
depends=('python>=2.6' 'libgl')
makedepends=('cmake>=2.8' 'git')
optdepends=('qt: GUI support' 'qjson: GUI support')
provides=('apitrace')
conflicts=('apitrace')
replaces=()
backup=()
options=()
install=
changelog=
source=('LICENSE')
noextract=()
md5sums=('85536f1e169f24a548762a3cbbcd227c')

_gitroot='git://github.com/apitrace/apitrace.git'
_gitname='apitrace'

build() {
	unset LDFLAGS

	cd ${srcdir}

	msg "Connecting to the GIT server.."
	if [[ -d ${srcdir}/${_gitname} ]] ; then
		cd ${_gitname}
		git pull origin
		msg "The local files are updated."
	else
		git clone ${_gitroot}
	fi

	msg "GIT checkout done."

	if [[ -d ${srcdir}/${_gitname}-build ]]; then
		msg "Cleaning the previous build directory.." 
		rm -rf ${srcdir}/${_gitname}-build
	fi

	msg "Cloning git.."

	git clone ${srcdir}/${_gitname} ${srcdir}/${_gitname}-build

	msg "Running cmake and make.."
	cd ${srcdir}/${_gitname}-build
	cmake -H. -Bbuild
	make -C build

	install -D "${srcdir}/${_gitname}-build/build/glretrace" "${pkgdir}/usr/bin/glretrace"
	install -D "${srcdir}/${_gitname}-build/build/tracedump" "${pkgdir}/usr/bin/tracedump"

	if [[ -f "${srcdir}/${_gitname}-build/build/qapitrace" ]]; then
		msg "Installing GUI.."
		install -D "${srcdir}/${_gitname}-build/build/qapitrace" "${pkgdir}/usr/bin/qapitrace"
	else
		msg "Optional GUI wasn't built."
	fi

	install -D "${srcdir}/${_gitname}-build/build/glxtrace.so" "${pkgdir}/usr/lib/glxtrace.so"

	install -D -m644 "${srcdir}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

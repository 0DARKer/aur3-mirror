# Contributor: Jens Staal <staal1978@gmail.com>

pkgname=gnu2ucb-coreutils
pkgver=1
pkgrel=1
arch=('i686' 'x86_64')
pkgdesc="A replacement of GNU Coreutils with binaries derived from original UNIX utilities, provided by the Heirloom project"
url="http://heirloom.sourceforge.net/tools.html"
license=('custom:"opensolaris"' 'custom:"lucent"')
depends=('busybox')
makedepends=('cvs' 'bc' 'heirloom-sh-cvs' 'heirloom-devtools-cvs')
install=('coreutils-replace.install')
provides=('coreutils' 'gnu2heirloom-coreutils')
conflicts=('coreutils' 'gnu2busybox-coreutils')

source=('000-config.diff' '001-staticdep.diff' '002-nowhat.diff' '5bin.ls' 'posix.ls' 'posix2001.ls' 'ucb.ls' 's42.ls' \
'busybox.ls' 'coreutils.gnuonly.ls' 'coreutils.bin.ls' 'coreutils.usr.bin.ls' 'coreutils.usr.sbin.ls' 'su' \
'busybox.1.gz' 'makefile.patch')

md5sums=('f9be8f1cc57f87425b39414a7db06543' '115355b6058592f9ba16a1c011f27ecd' '7394fc957b4fe5a58e4f43d7e283e96b' \
'266fba792c9f90435aa4fafa9d83c51a' '2836f9927cf1bd812945337795f0f06a' '5cf925de354b85d9dd2c8cdaca32cd76' 'a517184ec0260b7d6291c4b8dfd3d9b4' '897d20936f0e11c59c627f41655332c5' \
'530e88e6c9a9636a37da6ef7d65c302f' '24f23c4e05c6df0d6e6040c3c479496c' '8aaf17613697314627bb5297c5d68472' 'a186f0d0a11efbce079c97ef79b0cf3a' \
'466673de471fac1f97ef0cac4eb9a272' '46c076a8dba98a68bf4cc2f56f079732' '10741fe7dc9a4b2e0310af5f3954f027' 
'9112b52fddffa66cd464eeecd0109a21')

#Heirloom-variant dependent files below this line. Busybox covers unimplemented functions.
_5bin=($srcdir/5bin.ls)
_posix=($srcdir/posix.ls)
_posix2001=($srcdir/posix2001.ls)
_ucb=($srcdir/ucb.ls)
_s42=($srcdir/s42.ls)

#package-specific file list variables below this line
_busybox=($srcdir/busybox.ls)
_gnuonly=($srcdir/coreutils.gnuonly.ls)
_core_bin=($srcdir/coreutils.bin.ls)
_core_usrbin=($srcdir/coreutils.usr.bin.ls)
_core_usrsbin=($srcdir/coreutils.usr.sbin.ls)

_hmake() {
	env PATH="/usr/heirloom/bin:$PATH" MAKEFLAGS="" make "$@"
}

build() {
  cvs -d:pserver:anonymous:@heirloom.cvs.sourceforge.net:/cvsroot/heirloom login
	
  cvs -d:pserver:anonymous:@heirloom.cvs.sourceforge.net:/cvsroot/heirloom co -P heirloom

  rm -rf $srcdir/build # start fresh
  cp -ar $srcdir/heirloom $srcdir/build

  cd $srcdir/build
  patch -p1 < ../000-config.diff
  patch -p1 < ../001-staticdep.diff
  patch -p1 < ../002-nowhat.diff
  patch makefile -i $srcdir/makefile.patch

  _hmake 

  msg "ugly hack to an intermediary build of the heirloom toolchest"
  rm -rf $srcdir/tmp
  mkdir $srcdir/tmp #start fresh

  _hmake install ROOT="$srcdir/tmp"

  mkdir $srcdir/tmp/bin
  msg "Fill up missing binaries for Coreutils using symlinks to Busybox"
    for i in $(cat $_busybox)
      do
      ln -s /bin/busybox $srcdir/tmp/bin/$i
    done

  msg "move binaries corresponding to a specific Heirloom variant [sysV, posix, posix2001, s42 or ucb]"
  msg "to a single intermediate directory: $srcdir/tmp/bin"

# the build function will be common for all gnu2heirloom packages of a given type


   for i in $(cat $_5bin)
      do
      mv $srcdir/tmp/usr/heirloom/bin/$i $srcdir/tmp/bin/$i
    done
  
   for i in $(cat $_posix)
      do
      mv $srcdir/tmp/usr/heirloom/bin/posix/$i $srcdir/tmp/bin/$i
    done

   for i in $(cat $_s42)
      do
      mv $srcdir/tmp/usr/heirloom/bin/posix/$i $srcdir/tmp/bin/$i
    done

   for i in $(cat $_posix2001)
      do
      mv $srcdir/tmp/usr/heirloom/bin/posix2001/$i $srcdir/tmp/bin/$i
    done

   for i in $(cat $_ucb)
      do
      mv $srcdir/tmp/usr/heirloom/bin/ucb/$i $srcdir/tmp/bin/$i
    done

}

# The package function is the only thing changing for different packages [coreutils, findutils ...].
package() {
  mkdir $pkgdir/bin
  mkdir $pkgdir/usr
  mkdir $pkgdir/usr/bin
  mkdir $pkgdir/usr/sbin

  msg "moving binaries into a Coreutils tree structure"

    for i in $(cat $_core_bin)
      do
      mv $srcdir/tmp/bin/$i $pkgdir/bin/$i
    done

    for i in $(cat $_core_usrbin)
      do
      mv $srcdir/tmp/bin/$i $pkgdir/usr/bin/$i
    done

    for i in $(cat $_core_usrsbin)
      do
      mv $srcdir/tmp/bin/$i $pkgdir/usr/sbin/$i
    done

  msg "adding corresponding man pages"
  mkdir $pkgdir/usr/share
  mkdir $pkgdir/usr/share/man
  mkdir $pkgdir/usr/share/man/man1
  mkdir $srcdir/tmp/man
# Moving manpages into a common directory
   cp $srcdir/busybox.1 $srcdir/tmp/man/busybox.1
   mv $srcdir/tmp/usr/heirloom/share/man/man8/catman.8 $srcdir/tmp/usr/heirloom/share/man/man1/catman.1
   mv $srcdir/tmp/usr/heirloom/share/man/man5/fspec.5  $srcdir/tmp/usr/heirloom/share/man/man1/fspec.1
   mv $srcdir/tmp/usr/heirloom/share/man/man1m/mknod.1m $srcdir/tmp/usr/heirloom/share/man/man1/mknod.1
   mv $srcdir/tmp/usr/heirloom/share/man/man1m/sync.1m $srcdir/tmp/usr/heirloom/share/man/man1/sync.1

   for i in $(cat $_ucb)
      do
      mv $srcdir/tmp/usr/heirloom/share/man/man1b/$i.1b $srcdir/tmp/man/$i.1
    done

   for i in $(cat $_5bin)
      do
      mv $srcdir/tmp/usr/heirloom/share/man/man1/$i.1 $srcdir/tmp/man/$i.1
    done
  
   for i in $(cat $_posix)
      do
      mv $srcdir/tmp/usr/heirloom/share/man/man1/$i.1 $srcdir/tmp/man/$i.1
    done

   for i in $(cat $_posix2001)
      do
      mv $srcdir/tmp/usr/heirloom/share/man/man1/$i.1 $srcdir/tmp/man/$i.1
    done

  cd $srcdir/tmp/man/
  for i in $(cat $_busybox)
      do
      ln -s busybox.1 $i.1
    done

# Moving the relevant manpages to the package directory
install -m0644 $srcdir/tmp/man/busybox.1 $pkgdir/usr/share/man/man1/busybox.1
   
  for i in $(cat $_core_bin)
      do
	mv $srcdir/tmp/man/$i.1 $pkgdir/usr/share/man/man1/$i.1
      done

  for i in $(cat $_core_usrbin)
      do
	mv $srcdir/tmp/man/$i.1 $pkgdir/usr/share/man/man1/$i.1
      done

  for i in $(cat $_core_usrsbin)
      do
	mv $srcdir/tmp/man/$i.1 $pkgdir/usr/share/man/man1/$i.1
      done

  msg "adding system configuration files"
  mkdir $pkgdir/etc
  mkdir $pkgdir/etc/pam.d
  install -m0644 $srcdir/su $pkgdir/etc/pam.d/su

# locales and the libstdbuf are lacking in both Heirloom and Busybox

  msg "The following coreutils binaries are not covered by Heirloom or Busybox"
  cat $_gnuonly
  msg "A list of missing functionality is saved in /usr/share/info"
  mkdir $pkgdir/usr/share/info
  cp $srcdir/coreutils.gnuonly.ls $pkgdir/usr/share/info/

  msg "installing Heirloom-specific licence information"
  install -D -m0644 $srcdir/heirloom/LICENSE/LICENSE $pkgdir/usr/share/licenses/${pkgname}/LICENSE
  install -D -m0644 $srcdir/heirloom/LICENSE/OPENSOLARIS.LICENSE $pkgdir/usr/share/licenses/${pkgname}/OPENSOLARIS.LICENSE
  install -D -m0644 $srcdir/heirloom/LICENSE/LUCENT $pkgdir/usr/share/licenses/${pkgname}/LUCENT

  msg "WARNING: this package changes fundamental components in your system. DO NOT install on a production system (unless you know what you are doing)"
}


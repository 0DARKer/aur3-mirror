# Maintainer: jdarch <jda -dot- cloud -plus- archlinux -at- gmail -dot- com>
# Contributor: Alexander RÃ¸dseth <rodseth@gmail.com>
# Contributor: William Rea <sillywilly@gmail.com>
# Contributor: Stefan Husmann <stefan-husmann@t-online.de>

pkgname=arpack-mkl
_pkgrealname=arpack
pkgver=3.1.4
pkgrel=2
arch=('x86_64' 'i686')
pkgdesc='Fortran77 subroutines designed to solve large scale eigenvalue problems, BLAS&LAPACK from Intel MKL'
url='http://forge.scilab.org/index.php/p/arpack-ng/'
license=('BSD')
depends=('intel-mkl' 'openmpi')
provides=('arpack-ng')
provides=('arpack')
conflicts=('arpack')
options=('libtool' 'staticlibs')

source=("http://forge.scilab.org/index.php/p/arpack-ng/downloads/get/${_pkgrealname}-ng_${pkgver}.tar.gz")
md5sums=('af0c56f3aeb7e6e57ae46acdcb8b104b')
sha512sums=('35bb56a1f4a761223a16acb716cb8759573027b0a0e399cd50e050bcdee20ee46760cedecdf5c0a088f6c32806bbcc16e52a165b747bdfe030250e8ad15c4154')

if [ "$CARCH" == "x86_64" ]; then
    _intel_arch=intel64
    _intel_lib=mkl_gf_lp64
elif [ "$CARCH" == "i686" ]; then
    _intel_arch=ia32
    _intel_lib=mkl_gf
fi

build() {
  # Set up the environment for MKL
  source /opt/intel/mkl/bin/mklvars.sh ${_intel_arch}
  _mkllibs=" -fopenmp -Wl,--no-as-needed -L${MKLROOT}/lib/intel64 -l${_intel_lib} -lmkl_core -lmkl_sequential -lpthread -lm"

  cd "$srcdir/${_pkgrealname}-ng-${pkgver}"

  ./configure --prefix=/usr --enable-mpi \
  --with-blas="${_mkllibs}" \
  --with-lapack="${_mkllibs}"

  make \
    F77="mpif77" \
    CFLAGS+=" `pkg-config --cflags ompi` " \
    LIBS+=" `pkg-config --libs ompi` "
}

package() {
  cd "$srcdir/${_pkgrealname}-ng-${pkgver}"

  make DESTDIR="${pkgdir}/" install
  install -Dm644 COPYING "${pkgdir}/usr/share/licenses/${pkgname}/COPYING"
}

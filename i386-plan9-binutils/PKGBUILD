#Mantainer Jens Staal <staal1978@gmail.com>

pkgname=i386-plan9-binutils
pkgver=2.11.2
#the aim is to get the plan9 target support up-to-date
#the original target port (version 2.11.2) was made by David Gordon Hogan
#My own changes are free for FSF to  integrate in the official binutils with implicit copyright transfer
#For the original changes, next-of-kin of David need to be contacted.
#The original port can be found at:
#http://plan9.bell-labs.com/sources/extra/gcc/gnusrc.tgz
pkgrel=2
_xprefix=/opt/cross-i386-plan9
pkgdesc="A set of programs to assemble and manipulate binary and object files -modified for i386-plan9 target"
arch=(i686 x86_64)
license=(GPL)
options=('!libtool' '!distcc' '!ccache')
url="http://sources.redhat.com/binutils"
depends=('glibc' 'zlib')
source=(http://ports2plan9.googlecode.com/files/plan9-binutils-${pkgver}.tar.gz)
#sources will be updated whenever the changes are successfully integrated in an up-to-date binutils.

md5sums=('4f960c6f078ef23b10bda6d18bb499be')

build() {
  cd $srcdir/binutils-${pkgver}

  msg "making pristine build directory"
  rm -rf tmpbuild
  mkdir -p tmpbuild
  cd tmpbuild
  
  [ $NOEXTRACT -eq 1 ] || ../src/configure --prefix=${pkgdir}/${_xprefix} \
  --exec-prefix=${pkgdir}/${_xprefix} --bindir=${pkgdir}/${_xprefix}/bin \
  --includedir=${pkgdir}/${_xprefix}/include --target-alias=i386-lucent-plan9 \
  --disable-shared --disable-multilib --disable-nls --host=${CHOST} \
  --build=${CHOST}

  make tooldir=$pkgdir/${_xprefix}
}

package() {
  cd $srcdir/binutils-${pkgver}/tmpbuild
  #this old makefile does not support DESTDIR or similar... Because of this, configure need to include pkgdir
  # some annoying errors during packaging...
  sed -i 's|rm -f $(TOOLBIN)/as$(EXEEXT);||g' gas/Makefile
  # for some strange reason, make install works as root, but not in makepkg -s
  # cheating a bit...
  make tooldir=$pkgdir/${_xprefix}/bin install || return 0

    install -m644 libiberty.a $pkgdir/${_xprefix}/lib/
    install -m644 $srcdir/binutils-${pkgver}/src/include/libiberty.h $pkgdir/${_xprefix}/include/
    install -m644 $srcdir/binutils-${pkgver}/src/include/demangle.h $pkgdir/${_xprefix}/include/
    
    rm -f ${pkgdir}/usr/lib/libiberty.a

    for bin in ar as nm objcopy objdump ranlib strip ; do
        rm -f ${pkgdir}/usr/bin/${bin}
    done

    for info in as bfd binutils configure gprof ld standards; do
        mv ${pkgdir}/usr/share/info/${info}.info ${pkgdir}/${_xprefix}/info/i386-lucent-plan9-${info}.info
    done
} 

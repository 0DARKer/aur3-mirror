#Mantainer Jens Staal <staal1978@gmail.com>

pkgname=i386-plan9-binutils
pkgver=2.11.2
#the aim is to get the plan9 target support up-to-date
#the original target port (version 2.11.2) was made by David Gordon Hogan
#My own changes are free for FSF to  integrate in the official binutils with implicit copyright transfer
#For the original changes, next-of-kin of David need to be contacted.
#The original port can be found at:
#http://plan9.bell-labs.com/sources/extra/gcc/gnusrc.tgz
pkgrel=3
_prefix=i386-lucent-plan9
_xpath=/opt/cross-i386-plan9
pkgdesc="A set of programs to assemble and manipulate binary and object files -modified for i386-plan9 target"
arch=(i686 x86_64)
license=(GPL)
options=('!libtool' '!distcc' '!ccache')
url="http://sources.redhat.com/binutils"
depends=('glibc' 'zlib')
source=(http://ports2plan9.googlecode.com/files/plan9-binutils-${pkgver}.tar.gz)
#sources will be updated whenever the changes are successfully integrated in an up-to-date binutils.

md5sums=('4f960c6f078ef23b10bda6d18bb499be')

build() {
  cd $srcdir/binutils-${pkgver}

  msg "making pristine build directory"
  rm -rf tmpbuild
  mkdir -p tmpbuild
  cd tmpbuild
  
  [ $NOEXTRACT -eq 1 ] || ../src/configure --prefix=${_xpath} \
  --exec-prefix=${_xpath} --bindir=${_xpath}/bin \
  --includedir=${_xpath}/include --target-alias=i386-lucent-plan9 \
  --disable-shared --disable-multilib --disable-nls --host=${CHOST} \
  --build=${CHOST}

  make
}

package() {
  cd $srcdir/binutils-${pkgver}/tmpbuild
  #this old makefile does not support DESTDIR or similar... Because of this, configure need to include pkgdir
  #in order to do make install
  # some annoying errors during packaging...
#  sed -i 's|rm -f $(TOOLBIN)/as$(EXEEXT);||g' gas/Makefile
  # for some strange reason, make install works as root, but not in makepkg -s
  # cheating a bit...
#  make tooldir=$pkgdir/${_xpath}/bin install || return 0
#make install choked on an error under makepkg -s so I switched to manual install
#a positive side effect is that the configuration can be with the proper path
#if that somehow would be hard-coded in the utilities.
    msg "manually installing the built libraries and utilities + man pages"
    msg2 "setting up destination directories"
    mkdir -p $pkgdir/${_xpath}/{bin,include,lib,man/man1}
    msg2 "libbfd + headers"
    install -m644 bfd/libbfd.a $pkgdir/${_xpath}/lib/
    install -m644 bfd/bfd.h $pkgdir/${_xpath}/include/
    install -m644 $srcdir/binutils-${pkgver}/src/include/bfdlink.h $pkgdir/${_xpath}/include/
    install -m644 $srcdir/binutils-${pkgver}/src/include/ansidecl.h $pkgdir/${_xpath}/include/
    
    msg2 "libopcodes"
    install -m644 opcodes/libopcodes.a $pkgdir/${_xpath}/lib/
    
    msg2 "binutils"
    
    install -m755 binutils/addr2line $pkgdir/${_xpath}/bin/${_prefix}-addr2line
    install -m755 binutils/ar $pkgdir/${_xpath}/bin/${_prefix}-ar
    install -m755 binutils/cxxfilt $pkgdir/${_xpath}/bin/${_prefix}-c++filt
    install -m755 binutils/nm-new $pkgdir/${_xpath}/bin/${_prefix}-nm
    install -m755 binutils/objcopy $pkgdir/${_xpath}/bin/${_prefix}-objcopy
    install -m755 binutils/objdump $pkgdir/${_xpath}/bin/${_prefix}-objdump
    install -m755 binutils/ranlib $pkgdir/${_xpath}/bin/${_prefix}-ranlib
    install -m755 binutils/readelf $pkgdir/${_xpath}/bin/${_prefix}-readelf
    install -m755 binutils/size $pkgdir/${_xpath}/bin/${_prefix}-size
    install -m755 binutils/strings $pkgdir/${_xpath}/bin/${_prefix}-strings    
    install -m755 binutils/strip-new $pkgdir/${_xpath}/bin/${_prefix}-strip
    
    msg2 "gas"
    install -m755 gas/as-new $pkgdir/${_xpath}/bin/${_prefix}-as
    install -m755 gas/gasp-new $pkgdir/${_xpath}/bin/${_prefix}-gasp
    
    msg2 "ld"
    install -m755 ld/ld-new $pkgdir/${_xpath}/bin/${_prefix}-ld
    
    msg2 "libiberty + headers"
    install -m644 libiberty/libiberty.a $pkgdir/${_xpath}/lib/
    install -m644 $srcdir/binutils-${pkgver}/src/include/libiberty.h $pkgdir/${_xpath}/include/
    install -m644 $srcdir/binutils-${pkgver}/src/include/demangle.h $pkgdir/${_xpath}/include/

    msg2 "manpages"
    # I should find where they are located and add them I suppose...
    
    msg "Done! (hopefully)"

} 

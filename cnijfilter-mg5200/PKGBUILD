# Original Contributor: Fortunato Ventre (voRia) <vorione AT gmail DOT com>
# Maintainer: Custom Processing Unlimited (CPUnltd) <cpunltd AT gmail DOT com>
# Other Contributors:	xConStruct (from AUR)
#			fledge (from AUR)
#			dewyatt (from AUR)
#
# NOTE:
# I (CPUnltd) take little credit for this PKGBUILD.  I am taking the hard work
# of voRia and contributions of xConStruct, fledge, and dewyatt and combining
# them into a viable Arch Linux driver solution for the Canon MG5200 AIO Printer.
pkgname=cnijfilter-mg5200
pkgver=3.40
pkgrel=5
_pkgver=3.40-1
pkgdesc="Canon IJ Printer Driver (for mg5200 series)"
url="http://support-au.canon.com.au/contents/AU/EN/0100302002.html"
arch=('i686' 'x86_64')
license=('custom')
depends=('libpng' 'libtiff' 'gtk2')
source=(http://gdlp01.c-wss.com/gds/0/0100003020/01/cnijfilter-source-${_pkgver}.tar.gz
	fix_ppd.patch
	fix_includes.patch
	fix_png.patch)
md5sums=('609975a05d6050fcca88f312d3f35c6a'
         'dd51ed81963669cd34cbef741d1a9724'
         '5c92d9bec6eb153200d1b4474c0939fb'
         '5f665042df2175da3629667aaf258782')

build() {
  if [ "$CARCH" == "x86_64" ]; then  
    libdir=libs_bin64
  else
    libdir=libs_bin32
  fi

  ## Apply patches
  cd ${srcdir}/cnijfilter-source-${_pkgver}
  patch -p1 -i ${srcdir}/fix_ppd.patch
  patch -p1 -i ${srcdir}/fix_includes.patch
  patch -p1 -i ${srcdir}/fix_png.patch

  ## Compile and install mg5200 stuff
  # ppd file
  cd ${srcdir}/cnijfilter-source-${_pkgver}/ppd
  ./autogen.sh --prefix=/usr --enable-ppdpath=/usr/share/cups/model --program-suffix=mg5200
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # cnijfilter
  cd ${srcdir}/cnijfilter-source-${_pkgver}/cnijfilter
  ./autogen.sh --prefix=/usr --enable-libpath=/usr/lib/bjlib --enable-binpath=/usr/bin --program-suffix=mg5200
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # printui
  cd ${srcdir}/cnijfilter-source-${_pkgver}/printui
  ./autogen.sh --prefix=/usr --datadir=/usr/share --program-suffix=mg5200
  make || true # Needed to avoid errors while building locales
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # lgmon
  cd ${srcdir}/cnijfilter-source-${_pkgver}/lgmon
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin --program-suffix=mg5200
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # cngpijmon
  cd ${srcdir}/cnijfilter-source-${_pkgver}/cngpijmon
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin --datadir=/usr/share --program-suffix=mg5200
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  
  ## Compile and install common stuff
  # libs
  cd ${srcdir}/cnijfilter-source-${_pkgver}/libs
  ./autogen.sh --prefix=/usr
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # cngpij
  cd ${srcdir}/cnijfilter-source-${_pkgver}/cngpij
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # pstocanonij
  cd ${srcdir}/cnijfilter-source-${_pkgver}/pstocanonij
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # backend
  cd ${srcdir}/cnijfilter-source-${_pkgver}/backend
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # backendnet
  cd ${srcdir}/cnijfilter-source-${_pkgver}/backendnet
  ./autogen.sh --prefix=/usr --enable-progpath=/usr/bin LDFLAGS="-L../../com/${libdir}"
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1
  # sm sub process
  cd ${srcdir}/cnijfilter-source-${_pkgver}/cngpijmon/cnijnpr
  ./autogen.sh --prefix=/usr LIBS=-ldl
  make clean || return 1
  make || return 1
  make install DESTDIR=${pkgdir} || return 1

  # Install mg5200 libraries
  install -d ${pkgdir}/usr/lib/
  install -m 755 ${srcdir}/cnijfilter-source-${_pkgver}/374/${libdir}/*so.* ${pkgdir}/usr/lib/
  install -d ${pkgdir}/usr/lib/bjlib/
  install -m 644 ${srcdir}/cnijfilter-source-${_pkgver}/374/database/* ${pkgdir}/usr/lib/bjlib/
  # Install common libraries
  install -m 755 ${srcdir}/cnijfilter-source-${_pkgver}/com/${libdir}/*so.* ${pkgdir}/usr/lib/
  install -m 666 ${srcdir}/cnijfilter-source-${_pkgver}/com/ini/* ${pkgdir}/usr/lib/bjlib/
  # Make symbolic links for libraries
  cd ${pkgdir}/usr/lib/
  ln -s libcnnet.so.1.2.0 libcnnet.so
  ln -s libcnbpcmcm374.so.8.0.1 libcnbpcmcm374.so
  ln -s libcnbpcnclapi374.so.3.5.0 libcnbpcnclapi374.so
  ln -s libcnbpcnclbjcmd374.so.3.3.0 libcnbpcnclbjcmd374.so
  ln -s libcnbpcnclui374.so.3.6.0 libcnbpcnclui374.so
  ln -s libcnbpess374.so.3.3.3 libcnbpess374.so
  ln -s libcnbpess374.so.3.3.3 libcnbpo374.so

  # Install license file
  cd ${srcdir}/cnijfilter-source-${_pkgver}
  install -D LICENSE-cnijfilter-${pkgver}EN.txt ${pkgdir}/usr/share/licenses/${pkgname}/LICENSE-cnijfilter-${pkgver}EN.txt
}

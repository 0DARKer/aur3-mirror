diff -urN wine-1.5.12.orig/dlls/winex11.drv/keyboard.c wine-1.5.12/dlls/winex11.drv/keyboard.c
--- wine-1.5.12.orig/dlls/winex11.drv/keyboard.c	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/dlls/winex11.drv/keyboard.c	2012-09-13 22:29:38.136362345 +0300
@@ -1190,31 +1190,6 @@
 }
 
 /***********************************************************************
- *           set_async_key_state
- */
-static void set_async_key_state( const BYTE state[256] )
-{
-    SERVER_START_REQ( set_key_state )
-    {
-        req->tid = GetCurrentThreadId();
-        req->async = 1;
-        wine_server_add_data( req, state, 256 );
-        wine_server_call( req );
-    }
-    SERVER_END_REQ;
-}
-
-static void update_key_state( BYTE *keystate, BYTE key, int down )
-{
-    if (down)
-    {
-        if (!(keystate[key] & 0x80)) keystate[key] ^= 0x01;
-        keystate[key] |= 0x80;
-    }
-    else keystate[key] &= ~0x80;
-}
-
-/***********************************************************************
  *           X11DRV_KeymapNotify
  *
  * Update modifiers state (Ctrl, Alt, Shift) when window is activated.
@@ -1226,11 +1201,12 @@
 void X11DRV_KeymapNotify( HWND hwnd, XEvent *event )
 {
     int i, j;
+    DWORD time = GetCurrentTime();
     BYTE keystate[256];
     WORD vkey;
-    BOOL changed = FALSE;
     struct {
         WORD vkey;
+        WORD scan;
         BOOL pressed;
     } modifiers[6]; /* VK_LSHIFT through VK_RMENU are contiguous */
 
@@ -1260,9 +1236,15 @@
             case VK_LSHIFT:
             case VK_RSHIFT:
                 m = (vkey & 0xff) - VK_LSHIFT;
-                /* Take the vkey from the first keycode we encounter for this modifier */
-                if (!modifiers[m].vkey) modifiers[m].vkey = vkey;
-                if (event->xkeymap.key_vector[i] & (1<<j)) modifiers[m].pressed = TRUE;
+                /* Take the vkey and scan from the first keycode we encounter
+                   for this modifier. */
+                if (!modifiers[m].vkey)
+                {
+                    modifiers[m].vkey = vkey;
+                    modifiers[m].scan = keyc2scan[(i * 8) + j];
+                }
+                if (event->xkeymap.key_vector[i] & (1<<j))
+                    modifiers[m].pressed = TRUE;
                 break;
             }
         }
@@ -1273,21 +1255,19 @@
         int m = vkey - VK_LSHIFT;
         if (modifiers[m].vkey && !(keystate[vkey] & 0x80) != !modifiers[m].pressed)
         {
+            DWORD flags = modifiers[m].vkey & 0x100 ? KEYEVENTF_EXTENDEDKEY : 0;
+            if (!modifiers[m].pressed) flags |= KEYEVENTF_KEYUP;
+
             TRACE( "Adjusting state for vkey %#.2x. State before %#.2x\n",
                    modifiers[m].vkey, keystate[vkey]);
 
-            update_key_state( keystate, vkey, modifiers[m].pressed );
-            changed = TRUE;
+            /* Fake key being pressed inside wine */
+            X11DRV_send_keyboard_input( hwnd, vkey, modifiers[m].scan & 0xff, flags, time );
+
         }
     }
 
     LeaveCriticalSection( &kbd_section );
-    if (!changed) return;
-
-    update_key_state( keystate, VK_CONTROL, (keystate[VK_LCONTROL] | keystate[VK_RCONTROL]) & 0x80 );
-    update_key_state( keystate, VK_MENU, (keystate[VK_LMENU] | keystate[VK_RMENU]) & 0x80 );
-    update_key_state( keystate, VK_SHIFT, (keystate[VK_LSHIFT] | keystate[VK_RSHIFT]) & 0x80 );
-    set_async_key_state( keystate );
 }
 
 static void update_lock_state( HWND hwnd, WORD vkey, UINT state, DWORD time )
diff -urN wine-1.5.12.orig/include/wine/server_protocol.h wine-1.5.12/include/wine/server_protocol.h
--- wine-1.5.12.orig/include/wine/server_protocol.h	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/include/wine/server_protocol.h	2012-09-13 22:30:52.659291952 +0300
@@ -3840,9 +3840,7 @@
 {
     struct request_header __header;
     thread_id_t    tid;
-    int            async;
     /* VARARG(keystate,bytes); */
-    char __pad_20[4];
 };
 struct set_key_state_reply
 {
diff -urN wine-1.5.12.orig/server/protocol.def wine-1.5.12/server/protocol.def
--- wine-1.5.12.orig/server/protocol.def	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/server/protocol.def	2012-09-13 22:31:33.005740042 +0300
@@ -2707,7 +2707,6 @@
 /* Set queue keyboard state for a given thread */
 @REQ(set_key_state)
     thread_id_t    tid;           /* id of thread */
-    int            async;         /* whether to change the async state too */
     VARARG(keystate,bytes);       /* state array for all the keys */
 @END
 
diff -urN wine-1.5.12.orig/server/queue.c wine-1.5.12/server/queue.c
--- wine-1.5.12.orig/server/queue.c	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/server/queue.c	2012-09-13 22:32:06.798890303 +0300
@@ -2724,11 +2724,6 @@
     {
         if (!(thread = get_thread_from_id( req->tid ))) return;
         if (thread->queue) memcpy( thread->queue->input->keystate, get_req_data(), size );
-        if (req->async && (desktop = get_thread_desktop( thread, 0 )))
-        {
-            memcpy( desktop->keystate, get_req_data(), size );
-            release_object( desktop );
-        }
         release_object( thread );
     }
 }
diff -urN wine-1.5.12.orig/server/request.h wine-1.5.12/server/request.h
--- wine-1.5.12.orig/server/request.h	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/server/request.h	2012-09-13 22:32:41.252036986 +0300
@@ -1757,8 +1757,7 @@
 C_ASSERT( FIELD_OFFSET(struct get_key_state_reply, state) == 8 );
 C_ASSERT( sizeof(struct get_key_state_reply) == 16 );
 C_ASSERT( FIELD_OFFSET(struct set_key_state_request, tid) == 12 );
-C_ASSERT( FIELD_OFFSET(struct set_key_state_request, async) == 16 );
-C_ASSERT( sizeof(struct set_key_state_request) == 24 );
+C_ASSERT( sizeof(struct set_key_state_request) == 16 );
 C_ASSERT( FIELD_OFFSET(struct set_foreground_window_request, handle) == 12 );
 C_ASSERT( sizeof(struct set_foreground_window_request) == 16 );
 C_ASSERT( FIELD_OFFSET(struct set_foreground_window_reply, previous) == 8 );
diff -urN wine-1.5.12.orig/server/trace.c wine-1.5.12/server/trace.c
--- wine-1.5.12.orig/server/trace.c	2012-08-31 20:43:48.000000000 +0300
+++ wine-1.5.12/server/trace.c	2012-09-13 22:33:05.441905940 +0300
@@ -3163,7 +3163,6 @@
 static void dump_set_key_state_request( const struct set_key_state_request *req )
 {
     fprintf( stderr, " tid=%04x", req->tid );
-    fprintf( stderr, ", async=%d", req->async );
     dump_varargs_bytes( ", keystate=", cur_size );
 }
 

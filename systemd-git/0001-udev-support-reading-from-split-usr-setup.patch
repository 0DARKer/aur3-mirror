From 3f47a7775f4cbcc204a8a5977eea33a81319027c Mon Sep 17 00:00:00 2001
From: Kevin Murphy <kemurphy@andrew.cmu.edu>
Date: Sun, 8 Apr 2012 11:46:40 -0400
Subject: [PATCH 1/2] udev: support reading from split usr setup

---
 src/libudev/libudev.c |   22 ++++++++++++++--------
 1 file changed, 14 insertions(+), 8 deletions(-)

diff --git a/src/libudev/libudev.c b/src/libudev/libudev.c
index 74b53cb..0e01b85 100644
--- a/src/libudev/libudev.c
+++ b/src/libudev/libudev.c
@@ -43,8 +43,8 @@ struct udev {
         void *userdata;
         char *sys_path;
         char *dev_path;
-        char *rules_path[4];
-        unsigned long long rules_path_ts[4];
+        char *rules_path[5];
+        unsigned long long rules_path_ts[5];
         int rules_path_count;
         char *run_path;
         struct udev_list properties_list;
@@ -255,21 +255,26 @@ _public_ struct udev *udev_new(void)
                         goto err;
 
         if (udev->rules_path[0] == NULL) {
-                /* /usr/lib/udev -- system rules */
-                udev->rules_path[0] = strdup(UDEVLIBEXECDIR "/rules.d");
+                /* /lib/udev -- compat for system rules */
+                udev->rules_path[0] = strdup("/lib/udev/rules.d");
                 if (!udev->rules_path[0])
                         goto err;
 
+                /* /usr/lib/udev -- system rules */
+                udev->rules_path[1] = strdup(UDEVLIBEXECDIR "/rules.d");
+                if (!udev->rules_path[1])
+                        goto err;
+
                 /* /run/udev -- runtime rules */
-                if (asprintf(&udev->rules_path[1], "%s/rules.d", udev->run_path) < 0)
+                if (asprintf(&udev->rules_path[2], "%s/rules.d", udev->run_path) < 0)
                         goto err;
 
                 /* /etc/udev -- local administration rules */
-                udev->rules_path[2] = strdup(SYSCONFDIR "/udev/rules.d");
-                if (!udev->rules_path[2])
+                udev->rules_path[3] = strdup(SYSCONFDIR "/udev/rules.d");
+                if (!udev->rules_path[3])
                         goto err;
 
-                udev->rules_path_count = 3;
+                udev->rules_path_count = 4;
         }
 
         free(config_file);
@@ -318,6 +323,7 @@ _public_ void udev_unref(struct udev *udev)
         free(udev->rules_path[0]);
         free(udev->rules_path[1]);
         free(udev->rules_path[2]);
+        free(udev->rules_path[3]);
         free(udev->run_path);
         free(udev);
 }
-- 
1.7.10


# Maintainer: DavidK <david_king at softhome dot net>
# Contributor: Alexej Magura <agm2819*gmail*>
# Contributor: revel <revelΘmuub·net>
# Contributor: joyfulgirl <joyfulgirl (at) archlinux.us>

pkgname=cl-asdf
_realname=asdf
pkgver=3.0.3
pkgrel=1
pkgdesc="Common Lisp's Another System Definition Facility (pre-installed in some implementations)"
arch=('any')
url="http://common-lisp.net/project/asdf"
license=('MIT')
depends=('common-lisp') # requires common-lisp for it to be at all useful, but doesn't need it to build.
makedepends=('texinfo')
provides=('asdf=3.0.3')
install=asdf.install
source=("http://common-lisp.net/project/$_realname/archives/$_realname-${pkgver}.tar.gz"
	"asdf.lisp_patch")
md5sums=('cccce613f8c47718b4e5e9d4c4391a04'
         '273c481e7ba10807c9f1f2189c752dde')

prepare() {

    cd "$srcdir"
    
    if [[ -d "$pkgname-$pkgver" ]]; then
	rm -rf "$pkgname-$pkgver";
    fi

    mkdir -p $pkgname-$pkgver

    for dirs in $(ls -a1 $srcdir | sed -r "s:^(\\.\\.|\\.).*$:: ; s:^makefile$:: ; s:^$_realname-$pkgver\\.tar\\.gz$:: ; s:^$pkgname-$pkgver$:: ; s:^.*_patch$:: ; /^$/d")
    do
	mv $dirs $pkgname-$pkgver 
    done

    cd $pkgname-$pkgver 

    rm -rf build

}

build() {
    
    # build asdf.lisp
    cd "$srcdir"/$pkgname-$pkgver

    make

    # patch asdf.lisp 

    patch build/asdf.lisp "$srcdir"/asdf.lisp_patch
    
#    cd bin
#    ln -s ../build/asdf.lisp

    # install asdf.lisp with all available implementations of lisp

#    cp "$srcdir"/prelude.lisp_patch ./prelude.lisp

# the following commented code could be used to load asdf into the central-registry for every implementation of list
# installed on the user's system, or at least... that's what it should more or less do in theory.  
    
#    case $(pyhaslisps -n 0) in
#	    'clisp') clisp -norc prelude.lisp;;
#	    'sbcl') sbcl --script prelude.lisp;;
#	    'ecl') ecl -shell prelude.lisp;;
#	    'mkcl') mkcl -shell prelude.lisp;;
#	    'cmucl') cmucl -noinit -nositeinit -load prelude.lisp;;
#	    'abcl') abcl --noinit --nosystem --load prelude.lisp;;
#	    'ccl') ccl -n -l prelude.lisp;;
#	    'ccl64') ccl64 -n -l prelude.lisp;;
#	    'xcl') xcl --no-siteinit --no-userinit --load prelude.lisp ;;
#	    '') false ;; # no implementations of common-lisp are installed, and you shall not pass, et cetera et cetera.  
#	esac
    #for items in $(pyhaslisps | tr " " "\\n")
    #do
#	case ${items} in
#	    'clisp') clisp -norc prelude.lisp;;
#	    'sbcl') sbcl --script prelude.lisp;;
#	    'ecl') ecl -shell prelude.lisp;;
#	    'mkcl') mkcl -shell prelude.lisp;;
#	    'cmucl') cmucl -noinit -nositeinit -load prelude.lisp;;
#	    'abcl') abcl --noinit --nosystem --load prelude.lisp;;
#	    'ccl') ccl -n -l prelude.lisp;;
#	    'ccl64') ccl64 -n -l prelude.lisp;;
	    #'xcl') xcl --no-siteinit --no-userinit --load prelude.lisp ; true;;
#	esac
    
#    done

#    rm -f asdf.lisp

    # build asdf-${pkgver}.info 
    
    cd "$srcdir"/$pkgname-$pkgver/doc

    make asdf.info
    mv asdf.info asdf-${pkgver}.info

    cd ..

    # extract the copyright portion of the debian/copyright file; save it to doc/copyright

    cd "$srcdir"/$pkgname-$pkgver/debian

    cat copyright | sed -e :a -e '$q;N;25,$D;ba' > ../doc/copyright

    cd ..

}

package() {
    # What a user needs is nothing other than asdf.lisp.
    # All of the rest of the files are really for developing and debugging ASDF,
    # which require write access to the source directory.
    install -d "${pkgdir}"/usr/share/common-lisp/source/${_realname}
    install -d "${pkgdir}"/usr/share/common-lisp/source/${_realname}/build
    install -d "${pkgdir}"/usr/share/common-lisp/source/${_realname}/uiop
    install -d "${pkgdir}"/usr/share/info
    install -d "${pkgdir}"/usr/share/licenses/${pkgname}

    cd "$srcdir"/$pkgname-$pkgver
    
    cp build/asdf.lisp ./asdf.lisp
    install -m 644 -t "${pkgdir}"/usr/share/common-lisp/source/${_realname} *.lisp *.asd version.*
    install -m 644 -t "${pkgdir}"/usr/share/common-lisp/source/${_realname}/build build/asdf.lisp
    install -m 644 -t "${pkgdir}"/usr/share/common-lisp/source/${_realname}/uiop uiop/*.lisp uiop/*.asd uiop/version.*
    install -m 644 doc/${_realname}-${pkgver}.info "${pkgdir}"/usr/share/info/${_realname}-${pkgver}.info
    install -m 644 doc/copyright "${pkgdir}"/usr/share/licenses/${pkgname}/LICENSE
}

    

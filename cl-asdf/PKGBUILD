# Maintainer: Alexej Magura <agm2819*gmail*>
#
# Contributor: revel <revelΘmuub·net>
# Contributor: joyfulgirl <joyfulgirl (at) archlinux.us>

pkgname=cl-asdf
_realname=asdf
pkgver=2.33
pkgrel=6
pkgdesc="Common Lisp's Another System Definition Facility (pre-installed in SBCL)"
arch=('any')
url="http://common-lisp.net/project/asdf"
license=('MIT')
depends=('common-lisp') # requires common-lisp for it to be at all useful, but doesn't need it to build.
makedepends=('texinfo-legacy' 'texlive-bin' 'pyhaslisps>=1.06_7')
provides=('asdf=2.33')
install=asdf.install
source=("http://common-lisp.net/project/$_realname/archives/$_realname-${pkgver}.tar.gz"
	"makefile"
	"doc-makefile_patch"
	"asdf.lisp_patch"
	"prelude.lisp_patch")
md5sums=(a28d111a9b2b8431ff38df5855ab25b3
	 878be88de8d20689630f6a1b17034b0a
	 05dd29d2041fb9a02707ec8a7a4538f6
	 81d875aac802d570000ce2f0c9a45511
	 80736238320786b16c03b7f45e9b3801)

prepare() {


    cd $srcdir
    
    if [[ -d "$pkgname-$pkgver" ]]; then
	rm -rf "$pkgname-$pkgver";
    fi

    mkdir -p $pkgname-$pkgver

    for dirs in $(ls -a1 $srcdir | sed -r "s:^(\\.\\.|\\.).*$:: ; s:^makefile$:: ; s:^$_realname-$pkgver\\.tar\\.gz$:: ; s:^$pkgname-$pkgver$:: ; s:^.*_patch$:: ; /^$/d")
    do
	mv $dirs $pkgname-$pkgver 
    done

    cd $pkgname-$pkgver 

    rm -rf build

}

build() {
    
    # build asdf.lisp
    cd $srcdir/$pkgname-$pkgver

    make

    # patch prelude.lisp
    
    patch bin/prelude.lisp $srcdir/prelude.lisp_patch

    # patch asdf.lisp 

    patch build/asdf.lisp $srcdir/asdf.lisp_patch
    
    make -C $srcdir/$pkgname-$pkgver/bin/ -f $srcdir/makefile ready

    # install asdf.lisp with all available implementations of lisp

    cd bin 
# the following commented code could be used to load asdf into the central-registry for every implementation of list
# installed on the user's system, or at least... that's what it should more or less do in theory.  
    
    case $(pyhaslisps 0) in
	    'clisp') clisp -norc prelude.lisp;;
	    'sbcl') sbcl --script prelude.lisp;;
	    'ecl') ecl -shell prelude.lisp;;
	    'mkcl') mkcl -shell prelude.lisp;;
	    'cmucl') cmucl -noinit -nositeinit -load prelude.lisp;;
	    'abcl') abcl --noinit --nosystem --load prelude.lisp;;
	    'ccl') ccl -n -l prelude.lisp;;
	    'ccl64') ccl64 -n -l prelude.lisp;;
	    'xcl') xcl --no-siteinit --no-userinit --load prelude.lisp ;;
	    '') false ;; # no implementations of common-lisp are installed, and you shall not pass, et cetera et cetera.  
	esac
    #for items in $(pyhaslisps | tr " " "\\n")
    #do
#	case ${items} in
#	    'clisp') clisp -norc prelude.lisp;;
#	    'sbcl') sbcl --script prelude.lisp;;
#	    'ecl') ecl -shell prelude.lisp;;
#	    'mkcl') mkcl -shell prelude.lisp;;
#	    'cmucl') cmucl -noinit -nositeinit -load prelude.lisp;;
#	    'abcl') abcl --noinit --nosystem --load prelude.lisp;;
#	    'ccl') ccl -n -l prelude.lisp;;
#	    'ccl64') ccl64 -n -l prelude.lisp;;
	    #'xcl') xcl --no-siteinit --no-userinit --load prelude.lisp ; true;;
#	esac
    
#    done

    cd ..

    make -C $srcdir/$pkgname-$pkgver/bin/ -f $srcdir/makefile clean



    
    

    # build asdf-2.33.info 
    
    cd $srcdir/$pkgname-$pkgver/doc

    patch Makefile $srcdir/doc-makefile_patch

    make PKGVER=$pkgver asdf.info

    cd ..

    # extract the copyright portion of the debian/copyright file; save it to doc/copyright

    cd $srcdir/$pkgname-$pkgver/debian

    cat copyright | sed -e :a -e '$q;N;25,$D;ba' > ../doc/copyright

    cd ..

}

package() {
    cd $srcdir/$pkgname-$pkgver

    make -f $srcdir/makefile \
	PKGNAME=$pkgname \
	PKGVER=$pkgver \
	REALNAME=$_realname \
	DESTDIR=$pkgdir install

}

    

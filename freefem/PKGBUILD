#Contributor: Andrea 'dedalus' Turconi <andy.dedalus@gmail.com>

pkgname=freefem
pkgver=2.24
pkgrel=3
pkgdesc="A PDE oriented language using Finite Element Method" 
url="http://www.freefem.org/ff++/index.htm"
license=('LGPL')
arch=('i686' 'x86_64')
makedepends=('imagemagick' 'bison')
depends=('gcc' 'blas' 'fltk' 'lapack' 'arpack' 'umfpack' 'libxext' 'libxpm' 'libx11')

source=("ide_commands.patch" "ide_highlight.patch"  "ide_socket.patch" \
		"ide_spawn.patch" "ide_testhighlight.patch" "Makefile.example++-load" \
		"Makefile.example-bamg")

md5sums=('ef19a8479159a0275143cec2ccd91421'
         '3c3f3f777c0e6aba4fa72cf756909fc2'
         'bb6be5389ba4e7d94a5cadb862f1f88e'
         '8706db067083804734efa2be41b91666'
         '5ab2d91d2803bb54b56495db72f0cd6c'
         '9005b9de48d6ad88bea01735e3f18302'
         '185b5220d03e4cbbb673bb0d7abac36f')

build() {
USECOLOR="yes"
. /etc/rc.d/functions
cd $srcdir
printf " _____________________________________________________________\n"
printf "/                                                             \\ \n"
printf "|   WARNING: you have to type the CVS password to continue!   |\n"
printf "|   The password for the anonymous CVS repository is:         |\n"
printf "|                                                             |\n"
printf "|                         freefem++                           |\n"
printf "\\_____________________________________________________________/\n"
printf "\n"
cvs -d :pserver:anonymous@idared.ann.jussieu.fr:/Users/pubcvs/cvs login
cvs -d :pserver:anonymous@idared.ann.jussieu.fr:/Users/pubcvs/cvs co freefem++

printf "\n"
stat_busy "Patching some headers to get them work with g++-4.3"
patch $srcdir/freefem++/src/ide/commands.cpp $srcdir/ide_commands.patch
patch $srcdir/freefem++/src/ide/highlight.cpp $srcdir/ide_highlight.patch
patch $srcdir/freefem++/src/ide/spawn.cpp $srcdir/ide_spawn.patch
patch $srcdir/freefem++/src/ide/socket.cpp $srcdir/ide_socket.patch
patch $srcdir/freefem++/src/ide/testhighlight.cpp $srcdir/ide_testhighlight.patch
stat_done

cd $srcdir/freefem++

./configure\
	LDFLAGS="-lXext -lXpm -lX11"\
	--enable-optim\
	--prefix=/usr\
	--with-ImageMagick="-lMagick++ -lMagick -lWand"\
	--with-arpack="-larpack"\
	--with-blas="-lblas -llapack"\
	--disable-pdf\
	--with-umfpack="-lumfpack"\
	--with-amd="-lamd"\
	--with-x\
	--x-libraries="/usr/lib"\
	--x-includes="/usr/include/X11"\
	--with-xfltk\
	--with-mpi\
	|| return 1

stat_busy "Copying the empty Makefile for not to compile broken examples"
rm -f $srcdir/freefem++/examples++-load/Makefile
cp -f $srcdir/Makefile.example++-load $srcdir/freefem++/examples++-load/Makefile
rm -f $srcdir/freefem++/examples-bamg/Makefile
cp -f $srcdir/Makefile.example-bamg $srcdir/freefem++/examples-bamg/Makefile
stat_done

make || return 1
make DESTDIR=$pkgdir install
}

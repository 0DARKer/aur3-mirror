# Maintainer: skydrome <irc.freenode.net>
# Contributor: smallcms <smallcms at mail dot ru>

pkgname=rutorrent-svn
pkgver=1958
pkgrel=1
pkgdesc="Yet another web front-end for rTorrent"
arch=('any')
url="http://code.google.com/p/rutorrent"
license=('GPL')
depends=('rtorrent' 'php>=5.3.0')
makedepends=('subversion')
optdepends=()
provides=('rutorrent')
conflicts=('rutorrent')
backup=()
options=(!strip emptydirs)
install=
source=()
md5sums=()

_svntrunk="http://rutorrent.googlecode.com/svn/trunk/"
_svnmod="rutorrent"

build() {
cd "$srcdir"
msg "Connecting to SVN server...."

    if [[ -d "$_svnmod/.svn" ]]; then
        svn up -r "$pkgver" "$_svnmod"
    else
        svn co ${_svntrunk}/${_svnmod} --config-dir ./ -r "$pkgver" "$_svnmod"
        # This is the secure way of dealing with rtorrent communication! Use it!
        svn co ${_svntrunk}/plugins/httprpc ${_svnmod}/plugins/httprpc
    fi

msg "SVN checkout done or server timeout"
msg "Starting build..."

    rm -r ${_svnmod}/plugins/.svn
    sed -i ${_svnmod}/conf/config.php \
		-e "s:\$topDirectory .*:\$topDirectory = '/home';:" \
		-e "s:\$XMLRPCMountPoint .*:\$XMLRPCMountPoint = \"/rutorrent/RPC1\";:"
    mkdir -p ${pkgdir}/srv/http
    cp -r "$_svnmod" ${pkgdir}/srv/http
    chmod -R 755 ${pkgdir}/srv/http/${_svnmod}
}

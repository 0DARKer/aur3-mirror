# Maintainer: N30N <archlinux@alunamation.com>
# Contributer: Alex Combas <blenderwell@gmail.com>

pkgname="mitsuba-hg"
pkgver=1415
pkgrel=1
pkgdesc="A physically based renderer."
url="http://mitsuba-renderer.org/"
license=("GPL3")
arch=("i686" "x86_64")
depends=("xerces-c" "glew" "openexr" "qt" "collada-dom" "libxxf86vm" "boost-libs")
makedepends=("mercurial" "cmake" "boost" "python" "eigen3")
optdepends=("python: for the bindings")
provides=("mitsuba")
source=("mitsuba.install")
sha1sums=("253e9e45e414bbf0ca2b26aad3d1b5f90fdaa3c9")
install="mitsuba.install"

MAKEFLAGS="-j1"

_hgroot="https://mitsuba-renderer.org/hg"
_hgrepo="mitsuba"

build() {
	_python_ver="$(python3 -V 2>&1 | grep -o "3\.[0-9]")"

	[ -d build ] && rm -rf build
	mkdir build
	cd build
	cmake \
		-DPYTHON_LIBRARY="/usr/lib/libpython${_python_ver}m.so" \
		-DPYTHON_INCLUDE_DIR="/usr/include/python${_python_ver}m" \
		-DBoost_PYTHON_LIBRARY="/usr/lib/libboost_python3.so" \
		"${srcdir}/${_hgrepo}"
	make

	msg "Starting to package..."
	install -d \
		"${pkgdir}/usr/bin" \
		"${pkgdir}/usr/lib" \
		"${pkgdir}/usr/share/mitsuba/plugins"

	cd binaries
	install -m755 mitsuba mtsgui mtsimport mtssrv mtsutil "${pkgdir}/usr/bin"
	install -m755 *.so "${pkgdir}/usr/lib"
	install -m755 plugins/* "${pkgdir}/usr/share/mitsuba/plugins"
	install -Dm755 python/mitsuba.so \
		"${pkgdir}/usr/lib/python${_python_ver}/lib-dynload/mitsuba.so"
	find data -type f -exec \
		install -Dm644 "{}" "${pkgdir}/usr/share/mitsuba/{}" \;

	cd "${srcdir}/${_hgrepo}"
	find include -type f -exec \
		install -Dm644 "{}" "${pkgdir}/usr/{}" \;
	install -Dm644 data/linux/mitsuba.desktop \
		${pkgdir}/usr/share/applications/mitsuba.desktop
	install -Dm644 src/mtsgui/resources/mitsuba48.png \
		"${pkgdir}/usr/share/pixmaps/mitsuba48.png"
}

# vim: set noet ff=unix:

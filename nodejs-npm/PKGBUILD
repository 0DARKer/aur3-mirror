# Maintainer:   Guan 'kuno' Qing <neokuno at gmail dot com>
# Contributor:  tomxtobin <tomxtobin@tomxtobin.com>
# Contributor:  Marcus Carlsson <carlsson.marcus@gmail.com> 

pkgname=nodejs-npm
_realname=npm
pkgver=0.2.18
_realver=0.2.18
pkgrel=2
pkgdesc="The de facto package manager for nodejs."
arch=('any')
url="http://npmjs.org/"
license=('MIT')
groups=()
depends=('nodejs>=0.4.0')
makedepends=()
optdepends=('bash-completion: for command line completion'
            'zsh: npm now supports zsh completion')
provides=()
conflicts=('nodejs-npm-git')
replaces=()
backup=('etc/npmrc')
options=()
install=$pkgname.install
source=(http://registry.npmjs.org/npm/-/$_realname-$_realver.tgz
$pkgname.install
npm.sh
npmrc
_npm)
noextract=()

build() {
  mkdir -p $pkgdir/etc/{profile.d,bash_completion.d} || return 1
  mkdir -p $pkgdir/usr/local/{bin,lib/node,share/man} || return 1 
  mkdir -p $pkgdir/usr/share/{doc,licenses/npm,zsh/site-functions} || return 1

  export npm_config_userconfig=/tmp/npmrc || return 1
  # Set ownership to current user
  chown -R $USER $pkgdir/usr/local || return 1
  node $srcdir/package/cli.js config set root $pkgdir/usr/local/lib/node --flags &> /dev/null || return 1
  node $srcdir/package/cli.js config set binroot $pkgdir/usr/local/bin --flags &> /dev/null || return 1
  node $srcdir/package/cli.js config set manroot $pkgdir/usr/local/share/man --flags &> /dev/null || return 1

  # Installation
  node $srcdir/package/cli.js install ./$_realname-$_realver.tgz || return 1
}

package() {
  # Set global npm config file to /etc/npmrc
  install -m644 npmrc $pkgdir/etc/npmrc || return 1

  # Tell shell set npm global config file to /etc/npmrc
  install -m644 npm.sh $pkgdir/etc/profile.d/npm.sh || return 1

  # Install bash completion script
  install -m644 $srcdir/package/npm-completion.sh $pkgdir/etc/bash_completion.d/npm || return 1

  # Install zsh completion script
  install -m644 $srcdir/_npm $pkgdir/usr/share/zsh/site-functions/_npm || return 1

  # Insall html document
  cp -r $srcdir/package/html $pkgdir/usr/share/doc/npm || return 1

  # Insall licens
  install -m644 $srcdir/package/LICENSE $pkgdir/usr/share/licenses/npm || return 1
}
md5sums=('b85e99b1e284504f8235a21ec375e371'
         '63d6492ee224dc385884cf4e5fc56705'
         '0155ebd59a2639c0cf2a6f417d4cd91a'
         '33c4c40f21aff767da067d5c1fdaa246'
         '83447440661010e838d8e3d325cf435a')

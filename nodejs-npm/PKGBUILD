# Maintainer:   Guan 'kuno' Qing <neokuno at gmail dot com>
# Contributor:  tomxtobin <tomxtobin@tomxtobin.com>
# Contributor:  Marcus Carlsson <carlsson.marcus@gmail.com> 

pkgname=nodejs-npm
_realname=npm
pkgver=0.3.12
_realver=0.3.12
pkgrel=1
pkgdesc="The de facto package manager for nodejs."
arch=('any')
url="http://npmjs.org/"
license=('MIT')
groups=()
depends=('nodejs>=0.4.0')
makedepends=()
optdepends=('bash-completion: for command line completion'
            'zsh: npm now supports zsh completion')
provides=()
conflicts=('nodejs-npm-git')
replaces=()
backup=('etc/npmrc')
options=()
install=$pkgname.install
source=(http://registry.npmjs.org/npm/-/$_realname-$_realver.tgz
$pkgname.install
npm.sh
npmrc
_npm)
noextract=()

build() {
  mkdir -p $pkgdir/etc/{profile.d,bash_completion.d} || return 1
  mkdir -p $pkgdir/usr/{bin,lib/node,share/man} || return 1 
  mkdir -p $pkgdir/usr/share/{doc,licenses/npm,zsh/site-functions} || return 1

  export npm_config_userconfig=/tmp/npmrc || return 1

  # Set ownership to current user
  node $srcdir/package/cli.js config set unsafe-perm true || return 1
  node $srcdir/package/cli.js config set root $pkgdir/usr/lib/node --flags &> /dev/null || return 1
  node $srcdir/package/cli.js config set binroot $pkgdir/usr/bin --flags &> /dev/null || return 1
  node $srcdir/package/cli.js config set manroot $pkgdir/usr/share/man --flags &> /dev/null || return 1

  # Installation
  node $srcdir/package/cli.js install ./$_realname-$_realver.tgz || return 1

  # Trun off unsafe-perm
  node $srcdir/package/cli.js config set unsafe-perm false || return 1
}

package() {
  # Set global npm config file to /etc/npmrc
  install -m644 $srcdir/npmrc $pkgdir/etc/npmrc || return 1

  # Tell shell set npm global config file to /etc/npmrc
  install -m644 $srcdir/npm.sh $pkgdir/etc/profile.d/npm.sh || return 1

  # Install bash completion script
  install -m644 $srcdir/package/npm-completion.sh $pkgdir/etc/bash_completion.d/npm || return 1

  # Install zsh completion script
  install -m644 $srcdir/_npm $pkgdir/usr/share/zsh/site-functions/_npm || return 1

  # Install html document
  cp -r $srcdir/package/html $pkgdir/usr/share/doc/npm || return 1

  # Install license
  install -m644 $srcdir/package/LICENSE $pkgdir/usr/share/licenses/npm || return 1
}
md5sums=('ac580b901ff2a795ea0ef31823c7c0a5'
         'c0c8a2a4fc1c03f77f671421c964d18a'
         'da6fba1dabe7eec8d196efd2932bccba'
         'aed0d68ef55007541e25246daff46232'
         '83447440661010e838d8e3d325cf435a')

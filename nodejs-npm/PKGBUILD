# Maintainer:   Guan 'kuno' Qing <neokuno at gmail dot com>
# Contributor:  tomxtobin <tomxtobin@tomxtobin.com>
# Contributor:  Marcus Carlsson <carlsson.marcus@gmail.com> 

pkgname=nodejs-npm
_realname=npm
pkgver=0.2.17
_realver=0.2.17
pkgrel=3
pkgdesc="The de facto package manager for nodejs."
arch=('any')
url="http://npmjs.org/"
license=('MIT')
groups=()
depends=('nodejs>=0.2.3')
makedepends=()
optdepends=('bash-completion: for command line completion')
provides=('npm')
conflicts=('npm')
replaces=()
backup=()
options=()
install=$pkgname.install
source=(http://registry.npmjs.org/npm/-/$_realname-$_realver.tgz
$pkgname.install
npm.sh
npmrc)
noextract=()

build() {
    mkdir -p $pkgdir/etc/{profile.d,bash_completion.d} || return 1
    mkdir -p $pkgdir/usr/share/{doc,licenses/npm} || return 1
    mkdir -p $pkgdir/usr/local/{bin,lib/node,share/man} || return 1

    export npm_config_userconfig=/tmp/npmrc || return 1
    # Set ownership to current user
    chown -R $USER $pkgdir/usr/local || return 1
    node $srcdir/package/cli.js config set root $pkgdir/usr/local/lib/node --flags &> /dev/null || return 1
    node $srcdir/package/cli.js config set binroot $pkgdir/usr/local/bin --flags &> /dev/null || return 1
    node $srcdir/package/cli.js config set manroot $pkgdir/usr/local/share/man --flags &> /dev/null || return 1

    # Installation
    node $srcdir/package/cli.js install ./$_realname-$_realver.tgz || return 1
  }

package() {
    # Set global npm config file to /etc/npmrc
    install -m644 npmrc $pkgdir/etc/npmrc || return 1

    # Tell shell set npm global config file to /etc/npmrc
    install -m644 npm.sh $pkgdir/etc/profile.d/npm.sh || return 1

    # Install npm completion bash script
    install -m644 $srcdir/package/npm-completion.sh $pkgdir/etc/bash_completion.d/npm || return 1

    # Insall html document
    cp -r $srcdir/package/html $pkgdir/usr/share/doc/npm || return 1

    # Insall licens
    install -m644 $srcdir/package/LICENSE $pkgdir/usr/share/licenses/npm || return 1
}
md5sums=('3f2135f22441fee3c238905b5478ec1c'
         '817b81c9c7fddb68100598a8e3c8e813'
         '0155ebd59a2639c0cf2a6f417d4cd91a'
         '33c4c40f21aff767da067d5c1fdaa246')

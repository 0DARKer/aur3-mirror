# Maintainer:   Guan 'kuno' Qing <neokuno at gmail dot com>
# Contributor:  tomxtobin <tomxtobin@tomxtobin.com>
# Contributor:  Marcus Carlsson <carlsson.marcus@gmail.com>
# Contributor:  jagoterr <jagoterr@gmail.com>

pkgname=nodejs-npm
_realname=npm
pkgver=1.0.17
_realver="${pkgver}"
pkgrel=1
pkgdesc="The de facto package manager for nodejs."
arch=('any')
url="http://npmjs.org/"
license=('MIT')
groups=()
depends=('nodejs>=0.4.0')
makedepends=()
optdepends=('bash-completion: for command line completion'
            'zsh: npm now supports zsh completion')
provides=()
conflicts=('nodejs-npm-git')
replaces=()
backup=('etc/npmrc')
options=(strip)
install=$pkgname.install
source=(http://registry.npmjs.org/npm/-/$_realname-$_realver.tgz
$pkgname.install
npm.sh
npmrc)
noextract=()

build() {
  mkdir -p $pkgdir/etc/profile.d || return 1
  mkdir -p $pkgdir/usr/share/{doc,licenses/npm} || return 1

  export npm_config_userconfig=/tmp/npmrc || return 1
  export npm_config_globalconfig=/tmp/npmrc || return 1

  # Trun on temporary config for installation
  node $srcdir/package/cli.js config set unsafe-perm true || return 1
  node $srcdir/package/cli.js config set prefix $pkgdir/usr || return 1

  # Installation
  node $srcdir/package/cli.js install -g ./$_realname-$_realver.tgz || return 1

  # Trun off temporary config
  node $srcdir/package/cli.js config set prefix /usr || return 1
  node $srcdir/package/cli.js config set unsafe-perm false || return 1
}

package() {
  # Set global npm config file to /etc/npmrc
  install -m644 $srcdir/npmrc $pkgdir/etc/npmrc || return 1

  # Tell shell set npm global config file to /etc/npmrc
  install -m644 $srcdir/npm.sh $pkgdir/etc/profile.d/npm.sh || return 1

  # Output shell completion function
  node $srcdir/package/cli.js completion >> $pkgdir/etc/profile.d/npm.sh || return 1

  # Install html document
  cp -r $srcdir/package/html $pkgdir/usr/share/doc/npm || return 1

  # Install license
  install -m644 $srcdir/package/LICENSE $pkgdir/usr/share/licenses/npm || return 1
}
md5sums=('7000c33e08091f514e38b308d01392b2'
         'd2aa8d7dc0aecc10307dc400409f5f21'
         'c45eb4d2904c6adaef66647ad152aa3b'
         'f23089c429100dafa0c8a610429088ca')

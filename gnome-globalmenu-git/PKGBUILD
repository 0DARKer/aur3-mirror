# Contributor: Adam Eberlin <adam.eberlin@intellitechdesign.com>
# Contributor: lh <jarryson@gmail.com>

pkgname=gnome-globalmenu-git
pkgver=20101010
pkgrel=1
pkgdesc="Global Menu Bar for GNOME and XFCE"
url="http://code.google.com/p/gnome2-globalmenu/"
arch=('i686' 'x86_64')
license=('GPL')
depends=('libwnck')
makedepends=('git' "vala=0.8.1" 'libnotify' 'gnome-common' 'gnome-doc-utils' 'intltool' 'gtk-doc')
optdepends=()
options=('!libtool')
conflicts=('gtk2-aqd' 'gtk2-globalmenu' 'gnome-globalmenu-svn')
provides=('gnome-globalmenu')
replaces=()
install=gnome-globalmenu.install
source=(shut-debug.patch)
md5sums=(7f0b1733e2c8598c30f3cdd676d718c4)

_gitroot=git://github.com/gnome-globalmenu/gnome-globalmenu.git
_gitname=gnome-globalmenu

build() {
unset MAKEFLAGS
unset LDFLAGS
#  MAKEFLAGS="-j1"
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [ -d $_gitname ] ; then
    cd $_gitname && git pull origin
    msg "The local files are updated."
  else
    git clone $_gitroot
  fi

  msg "GIT checkout done or server timeout"

  msg "Starting make..."

  rm -rf "$srcdir/$_gitname-build"
  cp -rf "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
  
  patch -Np1 -i $srcdir/shut-debug.patch || return 1
  
  ./autogen.sh --prefix=/usr --sysconfdir=/etc --libexecdir=/usr/lib \
               --without-gnome-panel --without-xfce4-panel

  make || return 1
  make DESTDIR=${pkgdir} GCONF_DISABLE_MAKEFILE_SCHEMA_INSTALL=1 install || return 1

  install -d -m755 "${pkgdir}/usr/share/gconf/schemas"
  gconf-merge-schema "${pkgdir}/usr/share/gconf/schemas/${pkgname%-git}.schemas" ${pkgdir}/etc/gconf/schemas/*.schemas || return 1
  rm -rf ${pkgdir}/etc/gconf/schemas/
  
  rm -rf ${srcdir}/$_svnmod-build
}
# vim:syntax=sh

# Maintainer: Steven Cook <visage@deadhexagon.com>
pkgname=anope
pkgver=2.0.1
pkgrel=1
pkgdesc="A set of IRC Services designed for flexibility and ease of use"
arch=('i686' 'x86_64')
url="http://www.anope.org/"
license=('GPL')
depends=()
makedepends=('cmake')
source=(
    "http://downloads.sourceforge.net/project/${pkgname}/${pkgname}-stable/Anope%20${pkgver}/${pkgname}-${pkgver}-source.tar.gz"
    "anope.install"
    "anope.service"
    "anope.tmpfiles"
)
sha1sums=(
    'edbeebe53253a96dcca302ed0dd7bd7bb6284558'
    '45e50a02624f09825df114fc51e417e3ed01a3dd'
    '7c0dd7cb4b31bd843801ef36691097e933b1d616'
    '7d38218fef729433ca32b81514264beea9981cf8'
)
install="anope.install"

build() {
    cd "${pkgname}-${pkgver}-source"

    # Create a non-interactive config
    cat << EOF > config.cache
        INSTDIR="${srcdir}/install"
        RUNGROUP="anope"
        UMASK=077
        DEBUG="no"
        USE_RUN_CC_PL="no"
        USE_PCH="no"
        EXTRA_INCLUDE_DIRS=""
        EXTRA_LIB_DIRS=""
        EXTRA_CONFIG_ARGS=""
EOF

    ./Config -nointro -quick
    cd build
    make
}

package() {
    cd "${pkgname}-${pkgver}-source/build"

    make install

    cd "${srcdir}/install"

    # Directories
    install -Dd "$pkgdir"{/var/log,/var/lib,/etc,/usr/lib}/anope
    install -Dd "$pkgdir/var/lib/anope/runtime"
    install -Dd "$pkgdir/usr/bin"
    install -Dd "$pkgdir/usr/lib/anope"/{modules,locale}
    install -Dd "$pkgdir/etc/tmpfiles.d"

    # Copy files

    # We don't install anoperc, because systemd does all that now.
    # we don't copy example.chk (the crontab script) because it makes no sense

    install -Dm755 bin/{anopesmtp,services} "$pkgdir/usr/bin"
    install -Dm644 conf/*.conf "$pkgdir/etc/anope"
    install -Dm644 lib/modules/* "$pkgdir/usr/lib/anope/modules"
    install -Dm644 "$srcdir/anope.service" "$pkgdir/usr/lib/systemd/system/anope.service"
    install -Tm644 "$srcdir/anope.tmpfiles" "$pkgdir/etc/tmpfiles.d/anope.conf"

    cp -r data "${pkgdir}/var/lib/anope"
    cp -r locale/* "${pkgdir}/usr/lib/anope/locale"

    # Create empty directories
    #install -dm755 "${pkgdir}"{/var/log,/var/lib,/etc,/usr/lib}/anope
    #install -dm755 "${pkgdir}/var/lib/anope/runtime"
    #install -dm755 "${pkgdir}/usr/bin"
    #install -dm755 "${pkgdir}/usr/lib/anope"/{modules,locale}
    #install -dm755 "${pkgdir}/usr/lib/systemd/system"
    #install -dm755 "${pkgdir}/etc/tmpfiles.d"

    #install -Dm755 bin/{anopesmtp,services} "${pkgdir}/usr/bin"

    #install -Dm644 conf/*.conf "${pkgdir}/etc/anope"
    #cp -R data "${pkgdir}/var/lib/anope"
    #chown -R 142:142 "${pkgdir}/var/lib/anope"
    #install -Dm644 lib/modules/* "${pkgdir}/usr/lib/anope/modules"
    #cp -R locale/* "${pkgdir}/usr/lib/anope/locale"
    #chown -R 142:142 "${pkgdir}/usr/lib/anope/locale"
    #install -Dm644 "${srcdir}/anope.service" "${pkgdir}/usr/lib/systemd/system"
    #install -Tm644 "${srcdir}/anope.tmpfiles" "${pkgdir}/etc/tmpfiles.d/anope.conf"
}


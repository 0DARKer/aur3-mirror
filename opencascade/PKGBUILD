# Maintainer: Omar Lakhdar <omar_lakhdar@hotmail.com>
# Contributor: Brice MÃ©alier <mealier_brice@yahoo.fr>
# Contributor: Giuseppe Borzi <gborzi>
# Contributor : Michele Mocciola <mickele>
# Contributor : FoolEcho


pkgname=opencascade
pkgver=6.5.0
pkgrel=1
pkgdesc="Software development platform including components for 3D surface and solid modeling, visualization, data exchange and rapid application development."
url="http://www.opencascade.org"
license="custom"
depends=('tk' 'mesa' 'java-runtime' 'libxmu' 'ftgl')
makedepends=('java-environment')
arch=('i686' 'x86_64')
install=(opencascade.install)
source=(
   'http://files.opencascade.com/OCCT/OCC_6.5_release/OpenCASCADE650.tar.gz'
   'env.sh'
     'opencascade.sh'
   'opencascade.conf')
md5sums=(
        'a885f4f4e08776718c8736a363f5a2ee'
        'acf8ad1e470cd7d1c2033954c1b0f03a'
        'd9368b8d348ced3ec4462012977552d2'
        '2924ecf57c95d25888f51071fdc72ad0')

# Installation dir
_installdir=/opt/opencascade

build() {
   cd "${srcdir}"    || return 1      

   _svnmod="ftgl"
   _svntrunk="https://ftgl.svn.sourceforge.net/svnroot/ftgl/trunk"

  #some headers are not in the official package... o_O
  msg "Getting headers for ftgl..."
   if [ -d ${_svnmod}/.svn ]; then
    cd ${_svnmod} && svn up
   else
    svn co ${_svntrunk} --config-dir ./ ${_svnmod}
  fi

   cd "${srcdir}/ros" || return 1

  # Set variables necessary to compile th package
  #it seems "configure --with-ftgl=/usr" doesn't work... CSF_FTGL_INCLUDES and CSF_FTGL_LIB are never set in the Makefile... so we must be sure to have the headers... o_O
  export CXXFLAGS=$CXXFLAGS" -ffriend-injection -fpermissive -I${srcdir}/${_svnmod}/src -I${srcdir}/${_svnmod}/src/FTFont -I${srcdir}/${_svnmod}/src/FTGL -I${srcdir}/${_svnmod}/src/FTGlyph -I${srcdir}/${_svnmod}/src/FTLayout "`pkg-config --cflags freetype2`

  export CASROOT="\"${srcdir}/${pkgname}-${pkgver}/ros\""

  rm env.sh env.csh || return 1
  source "${srcdir}/env.sh"

  # Adjusts reference to X11 libraries and headers
  for _FILE in `grep -R -l "/usr/X11R6/lib" src/*`
  do
    sed -e "s|/usr/X11R6/lib|/usr/lib/X11|g" -i $_FILE
  done
#useless yet, it seems
#  for _FILE in `grep -R -l "/usr/X11R6/include" src/*`
# do
#  sed -e "s|/usr/X11R6/include|/usr/include/X11|g" -i $_FILE
# done

  # Adjusts DESTDIR prefix in Makefile.am and reconfigures files
  sed -e "s| \$(prefix)| \$(DESTDIR)\$(prefix)|g" -i Makefile.am

  autoreconf -f -i

  # And now we can build our libraries...
  ./configure --with-ftgl=/usr --with-tcl=/usr/lib --with-tk=/usr/lib --disable-debug --enable-production --with-java-include=${JAVA_HOME}/include --prefix=${_installdir} || return 1

  make || return 1
}

package(){
   cd "${srcdir}/ros" || return 1

  make install DESTDIR="${pkgdir}" || return 1

  # I prefer having a link to a more standard dir
  ln -s ./inc "${pkgdir}${_installdir}/include" || return 1

  # Install a file containing instruction necessary to link against these libraries
  install -D -m644 "${srcdir}/opencascade.conf" "${pkgdir}/etc/ld.so.conf.d/opencascade.conf" || return 1

  # Copy the profile file
  install -D -m 755 "${srcdir}/opencascade.sh" "${pkgdir}/etc/profile.d/opencascade.sh" || return 1
  install -m 755 "${srcdir}/env.sh" "${pkgdir}${_installdir}" || return 1
  rm -f "${pkgdir}${_installdir}/env_DRAW.sh" || return 1

  # Copy the license files
   install -D -m 644 "${srcdir}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE" || return 1
}

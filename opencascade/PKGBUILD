# Maintainer: Michele Mocciola <mickele>
# Contributor: Brice Méalier <mealier_brice@yahoo.fr>
# Contributor: Giuseppe Borzi <gborzi>

pkgname=opencascade
pkgver=6.3.0
pkgrel=11
pkgdesc="Software development platform including components for 3D surface and solid modeling, visualization, data exchange and rapid application development."
url="http://www.opencascade.org"
license="custom"
depends=('tk' 'mesa' 'java-runtime' 'libxmu')
makedepends=('autoconf' 'patch' 'coreutils' 'sed' 'make' 'gcc' 'java-environment')
provides=()
conflicts=()
options=()
replaces=()
arch=('i686' 'x86_64')
backup=()
install=(opencascade.install)
source=('http://files.opencascade.com/OCC_6.3_release/OpenCASCADE_src.tgz' 'env.sh' 'opencascade-6.3.0sp9.diff' 'lib-release.patch' 'opencascade.sh' 'opencascade.conf')

# Installation dir
_installdir=/opt/opencascade

build() {
  cd "${srcdir}/OpenCASCADE${pkgver}" || return 1

  # Apply patch available on www.salome-platform.org for Service Pack 9
  # applying this patch we should obtain something symilar to version 6.3.1
  patch -Np1 -i "${srcdir}/opencascade-6.3.0sp9.diff" || return 1
  
  # Apply a patch taken from debian site (thanks to debian maintainers)
  # lib-release.patch - without this patch release number of the libraries is 0.0.0
  patch -Np1 -i "${srcdir}/lib-release.patch" || return 1

  cd "${srcdir}/OpenCASCADE${pkgver}/ros" || return 1

  # Set variables necessary to compile th package
  export CXXFLAGS=$CXXFLAGS" -ffriend-injection -fpermissive"
  export CASROOT="\"${srcdir}/${pkgname}-${pkgver}/ros\""
  rm env.csh env.ksh || return 1
  source "${srcdir}/env.sh"

  # Adjusts reference to X11 libraries and headers
  for _FILE in `grep -R -l "/usr/X11R6/lib" src/*`
  do
    sed -e "s|/usr/X11R6/lib|/usr/lib/X11|g" -i $_FILE
  done
  for _FILE in `grep -R -l "/usr/X11R6/include" src/*`
  do
    sed -e "s|/usr/X11R6/include|/usr/include/X11|g" -i $_FILE
  done

  # Adjusts DESTDIR prefix in Makefile.am and reconfigures files
  sed -e "s| \$(prefix)| \$(DESTDIR)\$(prefix)|g" -i Makefile.am
  autoreconf -f -i

  # And now we can build our libraries...
  ./configure --with-tcl=/usr/lib --with-tk=/usr/lib --disable-debug --enable-production --with-java-include=${JAVA_HOME}/include --prefix=${_installdir} || return 1
  make || return 1
}

package(){
  cd "${srcdir}/OpenCASCADE${pkgver}/ros" || return 1

  make install DESTDIR="${pkgdir}" || return 1

  # I prefer having a link to a more standard dir
  ln -s ./inc "${pkgdir}${_installdir}/include" || return 1

  # Install a file containing instruction necessary to link againt these libraries
  install -D -m644 "${srcdir}/opencascade.conf" "${pkgdir}/etc/ld.so.conf.d/opencascade.conf" || return 1

  # Copy the profile file
  install -D -m 755 "${srcdir}/opencascade.sh" "${pkgdir}/etc/profile.d/opencascade.sh" || return 1
  install -m 755 "${srcdir}/env.sh" "${pkgdir}${_installdir}" || return 1
  rm -f "${pkgdir}${_installdir}/env_DRAW.sh" || return 1

  # Copy the license files
  install -D -m 644 "${srcdir}/OpenCASCADE${pkgver}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE" || return 1
}
md5sums=('52778127974cb3141c2827f9d40d1f11'
         'acf8ad1e470cd7d1c2033954c1b0f03a'
         'e1b34679e2b0d892e7f182545ccab92a'
         '32268a33ba39912b54cf3f654011da90'
         'd9368b8d348ced3ec4462012977552d2'
         '2924ecf57c95d25888f51071fdc72ad0')

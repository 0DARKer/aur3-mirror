# Maintainer: josephgbr <rafael.f.f1@gmail.com>

pkgname=bin32-jre
_major=8
_minor=25
_build=b17
pkgver=${_major}u$_minor
pkgrel=1
pkgdesc="Java Runtime Environment (32-bit)"
arch=('x86_64')
url=http://www.oracle.com/technetwork/java/javase/downloads/index.html
license=('custom')
depends=('lib32-libxrender' 'lib32-libxtst' 'lib32-gtk2') #  'shared-mime-info' 'xdg-utils' 'desktop-file-utils' 'hicolor-icon-theme'
optdepends=('lib32-alsa-lib: sound'
            'ttf-dejavu: fonts')
provides=("java-runtime-32=$_major" "java-runtime-headless-32=$_major" "java-web-start-32=$_major")
conflicts=("${provides[@]}" "${provides[@]/$_major/7}")
#install=jre.install
source=("http://download.oracle.com/otn-pub/java/jdk/$pkgver-$_build/jre-$pkgver-linux-i586.tar.gz")
md5sums=(`curl -sL ${url/te*}/webfolder/s/digest/${pkgver}checksum.html | grep -Po ">${source##*/}</td><td>\K[^<]*"`)
## Alternative mirrors, if your local one is throttled:
#source[0]="http://ftp.wsisiz.edu.pl/pub/pc/pozyteczne%20oprogramowanie/java/jre-$pkgver-linux-i586.tar.gz"
#source[0]="http://uni-smr.ac.ru/archive/dev/java/JRE/$_major/JRE-$_major.$_minor/jre-$pkgver-linux-i586.tar.gz"

DLAGENTS=('http::/usr/bin/curl -LC - -b oraclelicense=a -O')

package() {
  msg2 "Creating required dirs"
  cd jre1.$_major.0_$_minor
  mkdir -p "$pkgdir"/{opt/java32/jre,usr/{lib32/mozilla/plugins,share/licenses/$pkgname}}

  msg2 "Removing undesired stuff" # desktop file, icons, man pages
  rm -r plugin/ man/ lib/desktop/*

  msg2 "Moving stuff in place"
  mv COPYRIGHT LICENSE *.txt "$pkgdir"/usr/share/licenses/$pkgname/
  mv * "$pkgdir"/opt/java32/jre/

  msg2 "Symlinking plugin"
  ln -s /opt/java32/jre/lib/i386/libnpjp2.so "$pkgdir"/usr/lib32/mozilla/plugins/

  # Copy/paste from system clipboard to unsigned Java applets has been disabled since 6u24:
  # - https://blogs.oracle.com/kyle/entry/copy_and_paste_in_java
  # - http://slightlyrandombrokenthoughts.blogspot.com/2011/03/oracle-java-applet-clipboard-injection.html
  msg2 "Enabling copy+paste to unsigned applets"
  _line=$(awk '/permission/{a=NR}; END{print a}' "$pkgdir"/opt/java32/jre/lib/security/java.policy)
  sed "$_line a\\\\n \
        // (AUR) Allow unsigned applets to read system clipboard, see:\n \
        // - https://blogs.oracle.com/kyle/entry/copy_and_paste_in_java\n \
        // - http://slightlyrandombrokenthoughts.blogspot.com/2011/03/oracle-java-applet-clipboard-injection.html\n \
        permission java.awt.AWTPermission \"accessClipboard\";" \
     -i "$pkgdir"/opt/java32/jre/lib/security/java.policy     
}

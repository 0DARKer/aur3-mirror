# Maintainer: Thomas Jost <schnouki@schnouki.net>
# Contributor: Carson Reynolds <carson@k2.t.u-tokyo.ac.jp>
#
# WARNING: this is a package for a beta version of the CUDA SDK, which is only
# available to NVIDIA registered developers who signed a NDA. As a consequence,
# this package does NOT include source URLs: you must download the corresponding
# files yourself from https://nvdeveloper.nvidia.com/, put them in the same
# folder as this PKGBUILD, and run makepkg. This package will NOT be available
# in my custom repository neither, for the very same reason.

pkgname=cuda-sdk-beta
_pkgname=cuda-sdk
pkgver=4.1.15
pkgrel=1
pkgdesc="NVIDIA's CUDA architecture can be programmed in the only C language environment that unlocks the processing power of GPUs to solve the most complex compute-intensive challenges."
arch=('i686' 'x86_64')
[ "$CARCH" = "i686"   ] && ARCH=x86
[ "$CARCH" = "x86_64" ] && ARCH=x86_64
url="http://www.nvidia.com/object/cuda_home.html"
license=('custom')
depends=("cuda-toolkit-beta>=${pkgver}"
         'nvidia>=285.05'
	 'freeglut')
makedepends=('perl')
provides=("cuda-sdk=${pkgver}")
conflicts=("cuda-sdk")
source=(gpucomputingsdk_${pkgver}_linux.run)
md5sums=('43b112614f7e211309c0bc525b97fd4a')
sha256sums=('f228f6d2a3042800dbf310e10f0fc32ff9012c8017ed5bc66da881a5ea6602c6')

# This is ugly, but saves a lot of time: don't compress the package with xz.
PKGEXT=".pkg.tar"

build() {
  cd "$srcdir"

  # Extract the SDK
  msg2 "Uncompressing the CUDA SDK..."  
  sh gpucomputingsdk_${pkgver}_linux.run --noexec --keep --nox11 >/dev/null
  cd pkg
  
  # Inspection hook
  #echo "Inspect srcdir"
  #read 

  msg2 "Patching Makefiles..."
  # Support parallel builds
  find . -name 'Makefile*' -exec sed -i 's/^\tmake /\t$(MAKE) /g; s/^\t@make /\t@$(MAKE) /g' "{}" +

  msg2 "Preparing the build environment"
  install -dm755 "$pkgdir/usr/cuda/sdk"
  ./install-sdk-linux.pl --prefix="$pkgdir/usr/cuda/sdk" --cudaprefix="/usr/cuda" >/dev/null

  msg2 "Building all examples..."
  cd "$pkgdir/usr/cuda/sdk"
  make CUDA_INSTALL_PATH=/usr/cuda NO_MPI=1
  # simpleMPI sometimes causes segfaults when building...
}

# Everything is done in build(), so no need for a package() function.

# NOTE: demos such as bandwidthTest, dxtc and simpleTexture may pass tests 
#       when run as root since the data directory is not writable by default.
# NOTE: when building your own programs with nvcc, use the following flags:
#       --compiler-bindir=/opt/gcc-4.4

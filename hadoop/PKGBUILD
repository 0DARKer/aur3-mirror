# Maintainer: Tianjiao Yin <ytj000@gmail.com>
pkgname=hadoop
pkgver=1.0.3
pkgrel=1
pkgdesc="Hadoop - MapReduce implementation and distributed filesystem"
arch=('i686' 'x86_64')
url="http://hadoop.apache.org"
license=('apache')
depends=('java-runtime' 'openssh')
install=hadoop.install
source=(
"http://www.eng.lsu.edu/mirrors/apache/hadoop/common/hadoop-1.0.3/hadoop-1.0.3-bin.tar.gz"
"hadoop.profile"
"OLDPKGBUILD"
"conf.diff"
"hadoop-all"
)
backup=(
etc/profile.d/hadoop.sh
etc/hadoop/capacity-scheduler.xml
etc/hadoop/configuration.xsl
etc/hadoop/core-site.xml
etc/hadoop/fair-scheduler.xml
etc/hadoop/hadoop-env.sh
etc/hadoop/hadoop-metrics2.properties
etc/hadoop/hadoop-policy.xml
etc/hadoop/hdfs-site.xml
etc/hadoop/log4j.properties
etc/hadoop/mapred-queue-acls.xml
etc/hadoop/mapred-site.xml
etc/hadoop/masters
etc/hadoop/slaves
etc/hadoop/ssl-client.xml.example
etc/hadoop/ssl-server.xml.example
etc/hadoop/taskcontroller.cfg
)

_usr_lib=$pkgdir/usr/lib/
_hadoop_real_home=$_usr_lib/$pkgname-$pkgver
_hadoop_link_home=$_usr_lib/$pkgname

if [ "$CARCH" = "i686" ]; then
    options=(!strip)
fi

package() {
  mkdir -p $_usr_lib
  cp -r $srcdir/$pkgname-$pkgver $_usr_lib

  install -Dm755 ${srcdir}/hadoop-all ${pkgdir}/etc/rc.d/hadoop-all
  install -Dm755 ${srcdir}/hadoop.profile ${pkgdir}/etc/profile.d/hadoop.sh

  # we do not use soft link because we need put configures in backup array,
  # in order to preserve the conf when upgrade package.
  cp $_hadoop_real_home/conf $pkgdir/etc/hadoop -r
  mv $_hadoop_real_home/conf $_hadoop_real_home/orig_conf

  cd $pkgdir/etc/hadoop
  patch -p 1 < $srcdir/conf.diff

  mkdir -p $pkgdir/usr/bin
  echo -e '#!/bin/sh\n\n/usr/lib/hadoop/bin/hadoop "$@"' > $pkgdir/usr/bin/hadoop
  chmod 755 $pkgdir/usr/bin/hadoop

  cd $_usr_lib
  ln -s $pkgname-$pkgver $pkgname
}
md5sums=('f0697f0e679817d5384559c072b314cd'
         '1e853002b2c9c024af17f3011ad26404'
         '557e3834455bc836db5c273b24e916ee'
         '432741c08295505cecc791db8ac7ba76'
         'e1ae93c018a95649c83278c3233ee39b')
md5sums=('f0697f0e679817d5384559c072b314cd'
         '1e853002b2c9c024af17f3011ad26404'
         '557e3834455bc836db5c273b24e916ee'
         '432741c08295505cecc791db8ac7ba76'
         'e1ae93c018a95649c83278c3233ee39b')
md5sums=('f0697f0e679817d5384559c072b314cd'
         '1e853002b2c9c024af17f3011ad26404'
         '557e3834455bc836db5c273b24e916ee'
         '432741c08295505cecc791db8ac7ba76'
         'e1ae93c018a95649c83278c3233ee39b')
md5sums=('f0697f0e679817d5384559c072b314cd'
         '1e853002b2c9c024af17f3011ad26404'
         '557e3834455bc836db5c273b24e916ee'
         '432741c08295505cecc791db8ac7ba76'
         'e1ae93c018a95649c83278c3233ee39b')

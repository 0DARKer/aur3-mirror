# Maintainer: jdarch <jda -dot- cloud -plus- archlinux -at- gmail -dot- com>
# Contributor: monson <holymonson@gmail.com>
# Contributor: giniu <gginiu@gmail.com>

pkgname=intel-mkl
pkgver=11.1.1
pkgrel=1
pkgdesc="Intel Math Kernel Library, for non-commercial use."
arch=('i686' 'x86_64')
url="http://software.intel.com/en-us/intel-mkl/"
license=('custom')
depends=('bash' 'gcc-libs')
makedepends=('libarchive')
options=('staticlibs' 'libtool')

_build=106
_urlnumber=3604

_year=2013_sp1
_v_a=1
_v_b=106

_composerxedir=composer_xe_${_year}.${_v_a}.${_v_b}
_shortcomposerxedir=composer_xe_${_year}

if [ "$CARCH" == "x86_64" ]; then
    _rpmlist=rpms-intel64.list
    _intel_arch=intel64
    _not_arch=ia32
elif [ "$CARCH" == "i686" ]; then
    _rpmlist=rpms-ia32.list
    _intel_arch=ia32
    _not_arch=intel64
fi

_archive=l_mkl_${pkgver}.${_build}
_rpms=l_mkl_${pkgver}.${_build}_${_intel_arch}/rpms
echo "http://registrationcenter-download.intel.com/irc_nas/${_urlnumber}/${_archive}.tgz"
source=("http://registrationcenter-download.intel.com/irc_nas/${_urlnumber}/${_archive}.tgz"
        'intel-mkl.sh'
        'intel-mkl.install'
        'intel-mkl-th.conf'
        'intel-mkl.conf'
        'rpms-ia32.list'
        'rpms-intel64.list')
md5sums=('d499c371ad16045f7f726084095a9a65'
         'ff341d1fd9a3ace52d515870669c4ad8'
         'edd22493dbaf7dc345de1083f126cdd9'
         '7d1d9f233841dbed1220e41b41fe5e03'
         '5dd513834d8a47786953e52e8b60fc86'
         'a96a3c8e71e1f91969cf23d9ec782194'
         'fcd4a956e8b06a99fd8d84a29266633c')
sha512sums=('42c9c99735037dcf15c7589105c14fc7a3fcff29c24987e71f04e9338dd38b9f95a8630b308eaf89fe6821e1cd5789dc7e7c69b4fb241ffd77f639b838e55c17'
            '4b929c04e9288cc69e1d8d2c2c5036c11e29abc40d6e820357d309bb38994e61cd77a4f9a9baf7cc8d3f60c5de80b1269295125878748030c3e62b2da6d3c1b4'
            '78b8715d7dcb5b563ee7ba10e1b703b632673fadaf0270799b264268d6a4749662995eda99c1918c6c3d80d8485bd4003198351a0b3f7c4a3d6d05302de132c4'
            '1eaf9c37a38ac529a5395f826f5b700300d553f09d6f756242ea1c3ff080cf5b8c55736a2ea50d9abb3b43b36ce328bfdea5bb80c6a9f4f53faf5d440bc8e5b9'
            '8273d0fb7c741600a7cbc92b5913f2c2824a14a5580f4813a36bb48e5f690d5e24422460236cd6b7305519188c69e098b5f412e5b648f09c348bfacfe047212c'
            '3a22c6e9190db26249c23f8a0119742fa3da467280d165410c9879bdb8722e4a0d20a917aef90dd4bac0b91d89271be7e49b4e5fb52815a9f26436b313c15f4b'
            'eef85097054c8b4500512e0aeddf8229fa35ca3e3d739725eafdc6f086627746bb3df5005849a3da8c546812d7ab257c3722fa0379d785bb32a890cd2aadacb6')

prepare () {
# Check for license file
if ! ( [ -f "${srcdir}"/*.lic ] ); then
 msg "ERROR: NO license file be found.

 ** http://software.intel.com/en-us/articles/non-commercial-software-development/
 ** Before re-building, visit the website above to ask for a non-commercial license,
 ** and place the .lic file in "${srcdir}"/ .
    "
        return 1
fi

# Create the repository of relevant RPM files for the architecture
mkdir "${srcdir}"/rpmrepo
cd "${srcdir}"/${_archive}/rpm
ln -s -r -t "${srcdir}"/rpmrepo/ $(<"${srcdir}"/${_rpmlist})
}

package () {
# Extract RPM files
cd "${pkgdir}"
for rpm_file in "${srcdir}"/rpmrepo/*.rpm ; do
    bsdtar -xf ${rpm_file}
done

# Create directories and links
cd "${pkgdir}"/opt/intel
mkdir bin
mkdir -p ${_shortcomposerxedir}/bin
ln -s ${_shortcomposerxedir} composerxe
ln -s composerxe/lib lib
ln -s composerxe/mkl mkl
ln -s -t ${_shortcomposerxedir} ../${_composerxedir}/{Documentation,Samples,compiler/lib,mkl,pkg_bin}
ln -s -t bin ../composerxe/bin/compilervars.{sh,csh}

# Adapt scripts and put them in place
find "${pkgdir}"/opt/intel/${_composerxedir}/mkl/bin -name *.*sh -exec sed -s -i "s/<INSTALLDIR>/\/opt\/intel\/${_composerxedir}/g" {} \;
sed -s -i "s/<INSTALLDIR>/\/opt\/intel\/${_shortcomposerxedir}/g"  "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars_global."{csh,sh}
sed -s -i "s/<INSTALLDIR>/\/opt\/intel\/${_composerxedir}/g"  "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars"{.csh,.sh,_arch.{csh,sh}}
cp "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars_global.csh" "${pkgdir}/opt/intel/composerxe/bin/compilervars.csh"
cp "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars_global.sh" "${pkgdir}/opt/intel/composerxe/bin/compilervars.sh"
cp "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars_global.csh" "${pkgdir}/opt/intel/${_shortcomposerxedir}/bin/compilervars.csh"
cp "${pkgdir}/opt/intel/${_composerxedir}/bin/compilervars_global.sh" "${pkgdir}/opt/intel/${_shortcomposerxedir}/bin/compilervars.sh"

# Adapt files and copy them to /etc
mkdir -p "${pkgdir}"/etc/profile.d
cp "${srcdir}"/intel-mkl.sh "${pkgdir}"/etc/profile.d
chmod a+x "${pkgdir}"/etc/profile.d/intel-mkl.sh
mkdir -p "${pkgdir}"/etc/ld.so.conf.d
sed "s/<composerxedir>/${_composerxedir}/;s/<arch>/${_intel_arch}/" < "${srcdir}"/intel-mkl.conf > "${pkgdir}"/etc/ld.so.conf.d/intel-mkl.conf
cp "${srcdir}"/intel-mkl-th.conf "${pkgdir}"/etc/

# Copy the license text
mkdir -p "${pkgdir}"/usr/share/licenses/${pkgname}
cp "${srcdir}"/${_archive}/license "${pkgdir}"/usr/share/licenses/${pkgname}

# Copy license file to package directory
mkdir -p "${pkgdir}"/opt/intel/licenses
cp "${srcdir}"/*.lic "${pkgdir}"/opt/intel/licenses
}

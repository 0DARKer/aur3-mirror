# Maintainer: jdarch <jda.cloud plus archlinux at gmail.com>
# Contributor: monson <holymonson@gmail.com>
# Contributor: giniu <gginiu@gmail.com>

pkgname=intel-mkl
pkgver=11.0.5
pkgrel=1
pkgdesc="Intel Math Kernel Library, for non-commercial use."
arch=('i686' 'x86_64')
url="http://software.intel.com/en-us/intel-mkl/"
license=('custom')
depends=('bash' 'gcc-libs')
makedepends=('libarchive')

_build=192
_urlnumber=3233

_year='2013'
_v_a='5'
_v_b='192'

_composerxedir=composer_xe_${_year}.${_v_a}.${_v_b}

if [ "$CARCH" == "x86_64" ]; then
    _intel_arch=intel64
    _not_arch=ia32
    _archive_md5='6293b90e0f68c8a641f0fd784c1028c6'
elif [ "$CARCH" == "i686" ]; then
    _intel_arch=ia32
    _not_arch=intel64
    _archive_md5='b9bb50e34dbf95575635d0ea7433e35b'
fi

_archive=l_mkl_${pkgver}.${_build}_${_intel_arch}
_install_prefix=/opt/intel/composerxe
_rpms=l_mkl_${pkgver}.${_build}_${_intel_arch}/rpms


source=("http://registrationcenter-download.intel.com/irc_nas/${_urlnumber}/${_archive}.tgz"
        'intel-mkl.sh'
        'intel-mkl.install'
        'intel-mkl-th.conf'
        'intel-mkl.conf'
)
md5sums=(${_archive_md5}
         'fe2beb1b6c008a9384d9aaf53efd5092'
         'edd22493dbaf7dc345de1083f126cdd9'
         'ad12ce9a9d24ba19a492019fdeff401a'
         'd966c71035a05fac58523c7be1ea1a09')

package () {

# Check for license file
if ! ( [ -f ${srcdir}/../*.lic ] ); then
 msg "ERROR: NO license file be found.

 ** http://software.intel.com/en-us/articles/non-commercial-software-development/
 ** Before re-building, visit the website above to ask for a non-commercial license,
 ** and place the .lic file in ${srcdir}/.. .
    "
        return 1
fi

# Copy license file
mkdir -p ${pkgdir}/opt/intel/licenses
cp ${srcdir}/../*.lic ${pkgdir}/opt/intel/licenses


# Extract RPM files
cd ${pkgdir}
for rpm_file in ${srcdir}/${_rpms}/intel-*.rpm ; do
    bsdtar -xf ${rpm_file}
done

# Copy files to /etc
mkdir -p ${pkgdir}/etc/profile.d
cp ${srcdir}/intel-mkl.sh ${pkgdir}/etc/profile.d
chmod a+x ${pkgdir}/etc/profile.d/intel-mkl.sh

mkdir -p ${pkgdir}/etc/ld.so.conf.d

if [ "$CARCH" = "i686" ]; then
    sed "s/<composerxedir>/${_composerxedir}/;s/<arch>/ia32/" < ${srcdir}/intel-mkl.conf > ${pkgdir}/etc/ld.so.conf.d/intel-mkl.conf
  else
    sed "s/<composerxedir>/${_composerxedir}/;s/<arch>/intel64/" < ${srcdir}/intel-mkl.conf > ${pkgdir}/etc/ld.so.conf.d/intel-mkl.conf
fi

cp ${srcdir}/intel-mkl-th.conf ${pkgdir}/etc/

# Edit and remove Intel scripts
cd ${pkgdir}/opt/intel/${_composerxedir}/bin
rm *.csh
for sh_file in compilervars*.sh ; do
  sed -i "s/<INSTALLDIR>/\/opt\/intel\/${_composerxedir}/g" ${sh_file}
done


cd ${pkgdir}/opt/intel/${_composerxedir}/mkl/bin
rm mklvars.csh
sed -i "s/<INSTALLDIR>/\/opt\/intel\/${_composerxedir}/g" mklvars.sh
rm -rf ./${_not_arch}
cd ${_intel_arch}
rm mklvars_${_intel_arch}.csh
sed -i "s/<INSTALLDIR>/\/opt\/intel\/${_composerxedir}/g" mklvars_${_intel_arch}.sh
}

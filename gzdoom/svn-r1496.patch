Index: wadsrc/static/shaders/glsl/main.fp
===================================================================
--- wadsrc/static/shaders/glsl/main.fp	(revision 1495)
+++ wadsrc/static/shaders/glsl/main.fp	(revision 1496)
@@ -51,7 +51,7 @@
 	float min_L = clamp(36.0/31.0 - L, 0.0, 1.0);
 
 	float scale = 1.0 / dist;
-	float index = (59.0/31.0 - L) - (scale * 192.0/31.0 - 192.0/31.0);
+	float index = (59.0/31.0 - L) - (scale * 232.0/31.0 - 232.0/31.0);
 
 	/* result is colormap index (0 bright .. 31 dark) */
 	return clamp(index, min_L, 1.0);
Index: src/gl/shaders/gl_shader.cpp
===================================================================
--- src/gl/shaders/gl_shader.cpp	(revision 1495)
+++ src/gl/shaders/gl_shader.cpp	(revision 1496)
@@ -299,12 +299,25 @@
 			try
 			{
 				FString str;
-				if (i>3)
+				if ((i&4) != 0)
 				{
+					if (gl.maxuniforms < 1024 || gl.shadermodel != 4)
+					{
+						shader[i] = NULL;
+						continue;
+					}
 					// this can't be in the shader code due to ATI strangeness.
 					str = "#version 120\n#extension GL_EXT_gpu_shader4 : enable\n";
 					if (gl.MaxLights() == 128) str += "#define MAXLIGHTS128\n";
 				}
+				if ((i&8) == 0)
+				{
+					if (gl.shadermodel != 4)
+					{
+						shader[i] = NULL;
+						continue;
+					}
+				}
 				str += shaderdefines[i];
 				shader[i] = new FShader;
 				if (!shader[i]->Load(name, "shaders/glsl/main.vp", "shaders/glsl/main.fp", ShaderPath, str.GetChars()))
@@ -318,11 +331,6 @@
 				shader[i] = NULL;
 				I_Error("Unable to load shader %s:\n%s\n", name.GetChars(), err.GetMessage());
 			}
-			if (i==3 && gl.maxuniforms < 1024)
-			{
-				shader[4] = shader[5] = shader[6] = shader[7] = 0;
-				break;
-			}
 		}
 	}
 	else memset(shader, 0, sizeof(shader));

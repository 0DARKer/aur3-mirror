# Maintainer: Buck 'apitofme' Rodgers <gbuck2550 at gmail dot moc>
# Contributor: Bart≈Çomiej Piotrowski <bpiotrowski at archlinux dot org>

# ---- Note: ----
# Until I have arranged suitable contact details please report any issues
# in the comments section for this package's AUR page!
# -- Thanks --

pkgname=openh264-git
pkgver=1.3
pkgrel=1
pkgdesc="A free, open-source codec library for H.264 encoding and decoding"
arch=('i686' 'x86_64')
url="http://www.openh264.org/"
license=('BSD')
depends=('gcc-libs-multilib')
makedepends=('git' 'yasm')
# Note: official src dep is 'nasm', however 'yasm' provides this also!
provides=("$_pkgname")
source=('https://github.com/cisco/openh264.git')
sha256sums=('2d1e4387e694f545637115c7f10561b8b0d0e6237e4b66617d4a9986c15d27d0')

_name=openh264
_release=1.3
_branch="${_name}v$_release"

pkgver() {
  cd "$srcdir/$_branch"

  printf "$(grep -i -m1 'version' Makefile | cut -d "=" -f2).r%s.%s" \
    "$(git rev-list --count HEAD)" \
    "$(git rev-parse --short HEAD)"
}

prepare() {
  cd "$srcdir"

  if [ -d "$_branch" ]; then
    msg 'Updating source from GitHub...'
    cd "$_branch" && git pull origin
    cd ..
  else
    msg 'Downloading source from GitHub...'
    git clone -b "$_branch" --depth 1 "$source" "$_branch"
  fi

  if [ ! -d "$_branch" ]; then
    error 'Checkout failed or server timeout!'
    exit 1
  fi

  # TODO -- check if a clean is required first!
}

build() {
  cd "$srcdir/$_branch"

  msg 'Starting make...'
  if [ "x86_64" == "$CARCH" ]; then
    msg 'Building for 64bit architecture...'
    make all ENABLE64BIT=Yes
  else
    msg 'Building for 32bit architecture...'
    make all
  fi

# TODO -- figure out how to build the docs! (doxygen?)

  msg 'Build finished!'
}

check() {
  msg 'Not yet implemented!'
# TODO -- run the built in tests from the source
#  cd "${srcdir}/${_branch}/autotest"
#  bash ./perfomanceTest/run_perfTest.sh
#  bash ./unitTest/run_unitTest.sh
# FIXME -- tried the above but got an error!
}

package() {
  cd "${srcdir}/${_branch}"

  install -Dm755 h264dec "$pkgdir"/usr/bin/h264dec
  install -Dm755 h264enc "$pkgdir"/usr/bin/h264enc
  install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE

  make DESTDIR="${pkgdir}" install

  mv -v "${pkgdir}/usr/local/lib" "${pkgdir}/usr/"
  mv -v "${pkgdir}/usr/local/include" "${pkgdir}/usr/"
  rm -rv "${pkgdir}/usr/local"
}

# Submitter:   Wessel Dirksen "p-we" <wdirksen at gmail dot com>

pkgname=digital-devices-dvb-drivers
pkgver=hg
pkgrel=2
pkgdesc="Digital Devices proprietary DVB drivers + firmware"
url="http://www.digitaldevices.de"
arch=('i686' 'x86_64')
license=('GPLv2')
makedepends=('linux-headers' 'mercurial' 'patchutils' 'perl-proc-processtable' 'wget')
conflicts=('ffdecsawrapper' 'digital-devices-dvb-drivers')
provides=('digital-devices-dvb-drivers')
install='digital-devices-dvb-drivers.install'

source=(hg+http://linuxtv.org/hg/~endriss/media_build_experimental \
	digital-devices-dvb-drivers.install dd-dvb-drivers.patch)

sha256sums=('SKIP'
            '5216f5896540bd71c1e757b9fbb6adace682121271cda9530a663dad2a1ed1c6'
            '299261a4fc15702a54304480c8ac9abedd403ec700e48511ce81ccfddcf35b7a')

pkgver() {

	cd "$srcdir/media_build_experimental"
	_ddver=`printf "0.r%s.%s" "$(hg identify -n)"`
	_kernel=`uname -r | sed -r 's/-/_/g'`
	echo $_ddver$_kernel
}

prepare() {

	cd "$srcdir/media_build_experimental"
	make download
	make untar
	sed -i 's/system ("make") == 0 or die "build failed";/#system ("make") == 0 or die "build failed";/' build
	./build

	msg "Applying patches..."
	patch -p1 < $srcdir/dd-dvb-drivers.patch
	echo ""
	msg "Here's a few seconds to confirm the patch have been applied sucessfully..."
	echo ""
	sleep 4
	make	
}

package() {
	
	mkdir -p $pkgdir/usr/lib/modules/`uname -r`/updates/v4l-digital-devices
	mkdir -p $pkgdir/usr/lib/firmware/updates/v4l-digital-devices
	find "$srcdir/media_build_experimental" -name '*.ko' -exec cp {} $pkgdir/usr/lib/modules/`uname -r`/updates/v4l-digital-devices \;
	find "$srcdir/media_build_experimental/v4l/firmware" -name '*.fw' -exec cp {} $pkgdir/usr/lib/firmware/updates/v4l-digital-devices \;
	find "$srcdir/media_build_experimental/v4l/firmware" -name '*.bin' -exec cp {} $pkgdir/usr/lib/firmware/updates/v4l-digital-devices \;

	echo ""
	msg  "Compressing modules, this will take awhile..."
	echo ""
	find "$pkgdir" -name '*.ko' -exec gzip -9 {} \;

	chmod 644 -R $pkgdir/usr/lib/modules/`uname -r`/updates
	chmod 644 -R $pkgdir/usr/lib/firmware/updates
}

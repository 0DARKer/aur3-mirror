# Contributor: Alexander Drozdov <adrozdoff@gmail.com>

pkgname=qtcreator-cpphelper-plugin-git
pkgver=20100228
pkgrel=1
pkgdesc="Collection of actions to improve productivity while writing code"
arch=('i686' 'x86_64')
url="http://gitorious.org/creator-plugins"
license=('LGPL')
depends=('qt>=4.6' 'qtcreator-git')
makedepends=('git')
source=(paths.patch)

_gitroot="git://gitorious.org/creator-plugins/creator-plugins.git"
_gitname="creator-plugins"
_gitroot_creator="git://gitorious.org/qt-creator/qt-creator.git"
_gitname_creator="qt-creator"

build() {

    #
    # Build Qt Creator
    #
    cd ${startdir}/src
    msg "Connecting to GIT server for fetch qt-creator"
    if [ -d ${srcdir}/$_gitname_creator ] ; then
        cd ${srcdir}/$_gitname_creator && git pull origin || return 1
        msg "The local files are updated."
    else
        git clone $_gitroot_creator $_gitname_creator || return 1
    fi
    msg "GIT checkout done or server timeout"

    msg "Patching"

    cd "${srcdir}/${_gitname_creator}" || return 1

    patch -Np0 -i ${srcdir}/paths.patch

    msg "Starting make in quiet mode"

    if [ ! -d ${srcdir}/build ]; then
        mkdir ${srcdir}/build
    fi
    cd ${srcdir}/build
    mkdir -p share/doc/qtcreator
    touch share/doc/qtcreator/qtcreator.qch

    qmake ${srcdir}/${_gitname_creator}/qtcreator.pro || return 1
    make --quiet || return 1


    #
    # Build CppHelper Plugin
    #
    cd ${startdir}/src
    msg "Connecting to GIT server for fetch plugins"
    if [ -d ${srcdir}/$_gitname ] ; then
        cd ${srcdir}/$_gitname && git pull origin || return 1
        msg "The local files are updated."
    else
        git clone $_gitroot $_gitname || return 1
    fi
    msg "GIT checkout done or server timeout"

    if [ -d ${srcdir}/$_gitname-build ]; then
        rm -rf ${srcdir}/$_gitname-build
    fi
    cp -a ${srcdir}/$_gitname ${srcdir}/$_gitname-build
    cd ${srcdir}/$_gitname-build/cpphelper

    export QTC_BUILD_DIR=${srcdir}/build/
    export QTC_SOURCE_DIR=${srcdir}/${_gitname_creator}/

    qmake || return 1
    make  || return 1

    PLUGINS_DIR=/lib/qtcreator/plugins/CreatorPlugins
    install -m 755 -d ${pkgdir}/usr/${PLUGINS_DIR}
    install -m 644 $QTC_BUILD_DIR/${PLUGINS_DIR}/CppHelper.pluginspec ${pkgdir}/usr/${PLUGINS_DIR}/
    install -m 755 $QTC_BUILD_DIR/${PLUGINS_DIR}/libCppHelper.so      ${pkgdir}/usr/${PLUGINS_DIR}/
}


md5sums=('f23299e5df75ff3b310e6b59e6edaa77')

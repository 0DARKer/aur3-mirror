# Maintainer: Daniel Kirchner <daniel at ekpyron dot org>
pkgname=mingw32-yaml-cpp-experimental-hg
pkgver=442
pkgrel=2
pkgdesc="YAML parser and emitter in C++, written around the YAML 1.2 spec, experimental API (mingw32)"
license=('MIT')
arch=('i686' 'x86_64')
url="http://code.google.com/p/yaml-cpp/"
depends=('mingw32-runtime' 'mingw32-boost')
makedepends=('cmake' 'mingw32-gcc')
conflicts=('mingw32-yaml-cpp')
_hgroot="https://code.google.com/p"
_hgrepo="yaml-cpp"
options=(!strip !buildflags)

mingw32=i486-mingw32

build() {
  # mingw32 has problems with --hash-style=gnu (default value)
  unset LDFLAGS

  cd "${srcdir}/$_hgrepo"
  
  msg "Updating to new API..."
  hg up new-api || return 1
  
  msg "Starting make..."
  
  rm -rf "$srcdir/$_hgrepo-build"
  mkdir "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"
  
  echo "SET(CMAKE_SYSTEM_NAME Windows)" > win32.cmake
  echo "SET(CMAKE_C_COMPILER ${mingw32}-gcc)" >> win32.cmake
  echo "SET(CMAKE_CXX_COMPILER ${mingw32}-g++)" >> win32.cmake
  echo "SET(CMAKE_RC_COMPILER ${mingw32}-windres)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH /usr/${mingw32})" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
  echo "SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> win32.cmake
  cmake ../$_hgrepo \
    -DCMAKE_TOOLCHAIN_FILE=win32.cmake \
    -DCMAKE_INSTALL_PREFIX="/usr/${mingw32}"
  make
}

package() {
  cd "${srcdir}/$_hgrepo-build"
  make install DESTDIR="${pkgdir}"
}

# Maintainer: icoz <icoz.vt at gmail dot com>
pkgname=fieldrunners-humblebundle
pkgver=1.0.0
pkgrel=1
pkgdesc="Tower defense game, HumbleBundle version"
arch=('i686' 'x86_64')
url="http://www.humblebundle.com/"
license=('custom')
groups=('humblebundle')
depends=(freeglut)
source=('fieldrunners.desktop' 'icon.png')
md5sums=('2bea20f92f12f43c53fd88f92e64bdf4' 'a2f66ce5267c7a579c80ea1c5311a0b4')

if [ "${CARCH}" = "x86_64" ]; then
	_carch="64bit"
	_archive_md5="4419a2b51030cc1215cd56616547d0c5"
else
	_carch="32bit"
	_archive_md5="c83bde89c19a53f05d32fb353c8cd5f4"
fi

_realname="fieldrunners"
_pkgrel="1345663134"
_packagename="${_realname}-${pkgver}-${_carch}-${_pkgrel}.tar.gz"
_archive="${srcdir}/${_packagename}"

build() {
    #download archive if key is available
    if [ ! -f ${_archive} ] && [ -n "${_humblebundleandroid3key}" ]; then
        rm -f index.html\?key\=${_humblebundleandroid3key}*
        wget http://www.humblebundle.com/?key=${_humblebundleandroid3key}
        wget $(cat index.html\?key\=${_humblebundleandroid3key} | grep "${_packagename}" | cut -d "'" -f 10)
        mv ${_packagename}* ${_archive}
    fi

	#check game files
	if [ ! -f ${_archive} ]; then
		echo "
To install this you must own a copy of this game from ${url}."
		echo "Place ${_packagename} into ${srcdir}.
"
        echo "Alternatively you can add 'export _humblebundleandroid3key=<Your key here>' to ~/.bashrc if you want automated download ability. (You must restart your terminal for this to take effect)
"
		echo "Press ENTER to continue."
		read -a _unused
	fi
	if [ ! -f ${_archive} ]; then
		echo "${_archive} not found, exiting..."
		return 1
	fi
	if ! echo "${_archive_md5} ${_archive}" | md5sum -c --quiet; then
		echo "Invalid checksum for ${_archive}, exiting..."
		return 1
	fi

	#install all game files to /opt
	install -d ${pkgdir}/opt
	tar xvf ${_archive} -C ${pkgdir}/opt
	#move to tmp-dir
	mv ${pkgdir}/opt/fieldrunners ${pkgdir}/opt/fieldrunners2
	#move from tmp-dir needed dir
	mv ${pkgdir}/opt/fieldrunners2/fieldrunners ${pkgdir}/opt/fieldrunners
	#remove unneeded
	rm -rf ${pkgdir}/opt/fieldrunners2

	#install game icon
	install -D -m644 ${srcdir}/icon.png ${pkgdir}/opt/fieldrunners/

	#install application shortcut
	install -d ${pkgdir}/usr/share/applications
	install -D -m644 ${srcdir}/fieldrunners.desktop ${pkgdir}/usr/share/applications/


	#remove unneeded files
	if [ "${CARCH}" = "x86_64" ]; then
		rm -rf ${pkgdir}/opt/defcon/lib64
	else
		rm -rf ${pkgdir}/opt/defcon/lib32
	fi
}

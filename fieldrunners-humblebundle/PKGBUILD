# Maintainer: icoz <icoz.vt at gmail dot com>
pkgname=fieldrunners-humblebundle
pkgver=1.0.0
pkgrel=5
pkgdesc="Tower defense game, HumbleBundle version"
arch=('i686' 'x86_64')
url="http://www.humblebundle.com/"
license=('custom')
groups=('humblebundle')
depends=(freeglut)
source=('fieldrunners.desktop'
		'icon.png'
		'frfix-2012-08-25.tar.bz2::http://subatomicstudios.com/forum/download/file.php?id=983&sid=f303eb90d321727d0451a7cd82310f32'
		'frfix-2012-09-05.tar.bz2::http://subatomicstudios.com/forum/download/file.php?id=991&sid=8d5ea67c86c97e703bcc37e4aa42a049')
noextract=('frfix-2012-08-25.tar.bz2' 'frfix-2012-09-05.tar.bz2')
md5sums=('2bea20f92f12f43c53fd88f92e64bdf4'
         'a2f66ce5267c7a579c80ea1c5311a0b4'
         'b46dca10800a7ffd6907d8f47fdfc035'
         '4e5537f635e32f6585ad9dd30a1dc50f')

#use_patch = 0 (default) - none of patches is used
#use_patch = 1 - first patch is used (disables PulseAudio)
#use_patch = 2 - second patch is used (latest)
_use_patch=0

_realname="fieldrunners"
if [ "${CARCH}" == "x86_64" ]; then
	_packagename="${_realname}-linux-${pkgver}-64bit-1346776333.tar.gz"
	_archive_md5="db2de07444fab347e4d757ec6e7dd08a"
else
	_packagename="${_realname}-${pkgver}-32bit-1346296515.tar.gz"
	_archive_md5="691f3ee0c441412e9a9a95cdb1bfb6f0"
fi
_archive="${srcdir}/${_packagename}"

build() {
    #download archive if key is available
    if [ ! -f ${_archive} ] && [ -n "${_humblebundleandroid3key}" ]; then
        rm -f index.html\?key\=${_humblebundleandroid3key}*
        wget http://www.humblebundle.com/?key=${_humblebundleandroid3key}
        wget $(cat index.html\?key\=${_humblebundleandroid3key} | grep "${_packagename}" | cut -d "'" -f 10)
        mv ${_packagename}* ${_archive}
    fi

	#check game files
	if [ ! -f ${_archive} ]; then
		echo "
To install this you must own a copy of this game from ${url}."
		echo "Place ${_packagename} into ${srcdir}.
"
        echo "Alternatively you can add 'export _humblebundleandroid3key=<Your key here>' to ~/.bashrc if you want automated download ability. (You must restart your terminal for this to take effect)
"
		echo "Press ENTER to continue."
		read -a _unused
	fi
	if [ ! -f ${_archive} ]; then
		echo "${_archive} not found, exiting..."
		return 1
	fi
	if ! echo "${_archive_md5} ${_archive}" | md5sum -c --quiet; then
		echo "Invalid checksum for ${_archive}, exiting..."
		return 1
	fi

	#install all game files to /opt
	install -d ${pkgdir}/opt
	tar xvf ${_archive} -C ${pkgdir}/opt
	#move to tmp-dir
	mv ${pkgdir}/opt/fieldrunners ${pkgdir}/opt/fieldrunners2
	#move from tmp-dir needed dir
	mv ${pkgdir}/opt/fieldrunners2/fieldrunners ${pkgdir}/opt/fieldrunners
	#remove unneeded
	rm -rf ${pkgdir}/opt/fieldrunners2

	#install game icon
	install -D -m644 ${srcdir}/icon.png ${pkgdir}/opt/fieldrunners/

	#install application shortcut
	install -d ${pkgdir}/usr/share/applications
	install -D -m644 ${srcdir}/fieldrunners.desktop ${pkgdir}/usr/share/applications/

	#install patch
	mkdir -p ${srcdir}/tmp
	if [ "${_use_patch}" == "1" ]; then
		tar jxf ${srcdir}/frfix-2012-08-25.tar.bz2 -C ${srcdir}/tmp/
		install -D -m644 ${srcdir}/tmp/alsa.conf ${pkgdir}/opt/fieldrunners/
	fi
	if [ "${_use_patch}" == "2" ]; then
		tar jxf ${srcdir}/frfix-2012-09-05.tar.bz2 -C ${srcdir}/tmp/
	fi
	if [ "${_use_patch}" != "0" ]; then
		install -D -m644 ${srcdir}/tmp/frfix-32.so.prebuilt ${pkgdir}/opt/fieldrunners/
		install -D -m644 ${srcdir}/tmp/frfix-64.so.prebuilt ${pkgdir}/opt/fieldrunners/
		install -D -m644 ${srcdir}/tmp/frfix.c ${pkgdir}/opt/fieldrunners/
		install -D -m755 ${srcdir}/tmp/build.sh ${pkgdir}/opt/fieldrunners/
		install -D -m755 ${srcdir}/tmp/launch.sh ${pkgdir}/opt/fieldrunners/
		cd ${pkgdir}/opt/fieldrunners/
		source build.sh
		cd -
		rm -rf ${pkgdir}/opt/fieldrunners/frfix-32.so.prebuilt
		rm -rf ${pkgdir}/opt/fieldrunners/frfix-64.so.prebuilt
		rm -rf ${pkgdir}/opt/fieldrunners/frfix.c
		rm -rf ${pkgdir}/opt/fieldrunners/build.sh
	fi
	rm -rf ${srcdir}/tmp
}

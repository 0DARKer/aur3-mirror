# Contributor: David Spicer <azleifel at googlemail dot com>

pkgname=vdr-streamdev-cvs
_pluginname=streamdev
pkgver=20100606
pkgrel=1
arch=('i686' 'x86_64')
pkgdesc="A VDR plugin that implements the VTP (Video Transfer Protocol)"
url="http://streamdev.vdr-developer.org/"
license=('GPL2')
depends=('vdr' 'gcc-libs')
makedepends=('cvs')
provides=('vdr-streamdev')
conflicts=('vdr-streamdev')
backup=('etc/vdr/plugins/streamdev/streamdevhosts.conf')
install=${pkgname}.install

_cvsroot=":pserver:anoncvs@vdr-developer.org:/var/cvsroot"
_cvsmod=${_pluginname}

build() {
  cd ${srcdir}
  msg "Connecting to $_cvsmod.sourceforge.net CVS server...."
  if [ -d $_cvsmod/CVS ]; then
    cd $_cvsmod
    cvs -z3 update -d
  else
    cvs -z3 -d $_cvsroot co -D $pkgver -f $_cvsmod
    cd $_cvsmod
  fi

  msg "CVS checkout done or server timeout"
  msg "Starting make..."

  rm -rf ${srcdir}/${_cvsmod}-build
  cp -r ${srcdir}/${_cvsmod} ${srcdir}/${_cvsmod}-build
  cd ${srcdir}/${_cvsmod}-build

  # Assumed VDR directory environment (VDRDIR/Make.config):
  # MANDIR       = /usr/share/man
  # BINDIR       = /usr/bin
  # LOCDIR       = /usr/share/locale
  # PLUGINLIBDIR = /usr/lib/vdr
  # VIDEODIR     = /var/spool/video
  # CONFDIR      = /etc/vdr
  
  install -d -m755 ${pkgdir}/etc/vdr/plugins/${_pluginname} || return 1
  install -d -m755 ${pkgdir}/usr/lib/vdr || return 1
  install -d -m755 ${pkgdir}/usr/share/doc/${pkgname} || return 1
  install -d -m755 ${pkgdir}/usr/share/locale || return 1
  
  make VDRDIR=/usr/include/vdr \
       LIBDIR=${pkgdir}/usr/lib/vdr \
       LOCALEDIR=${pkgdir}/usr/share/locale || return 1

  # Install configuration etc. files
  install -m755 streamdev/externremux.sh ${pkgdir}/etc/vdr/plugins/${_pluginname} || return 1
  install -m644 streamdev/streamdevhosts.conf ${pkgdir}/etc/vdr/plugins/${_pluginname} || return 1
  
  # Install documents
  for _file in CONTRIBUTORS HISTORY PROTOCOL README; do
    install -m644 ${_file} ${pkgdir}/usr/share/doc/${pkgname}/${_file} || return 1
  done
}

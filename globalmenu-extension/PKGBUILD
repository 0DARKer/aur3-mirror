# Contributor: Tom Kuther <gimepl@sonnenkinder.org>

pkgbase=globalmenu-extension
pkgname=globalmenu-extension
true && pkgname=(globalmenu-extension-firefox globalmenu-extension-thunderbird)
pkgver=20120110
pkgrel=1
url="https://launchpad.net/globalmenu-extension"
arch=('i686' 'x86_64')
license=('LGPL')
makedepends=('bzr' 'xulrunner' 'autoconf2.13' 'yasm' 'zip' 'unzip')
optdepends=()
options=()
conflicts=()
replaces=()
install=
source=()
md5sums=()

_bzrroot=lp:globalmenu-extension/2.0
_bzrname=globalmenu-extension

build() {
	cd "$srcdir"
	msg "Connecting to BZR server...."

	if [ -d $_bzrname ] ; then
		cd $_bzrname && bzr update
		msg "The local files are updated."
	else
		bzr branch $_bzrroot $_bzrname
	fi
	msg "BZR checkout done"

	msg "Starting make..."
	rm -rf "$srcdir/${_bzrname}-build"
	cp -r "$srcdir/${_bzrname}" "$srcdir/${_bzrname}-build"
	cd "$srcdir/${_bzrname}-build"

	autoconf-2.13
	sed -i 's/^ \t/\t/g' config/rules.mk
	sed -i '/^XPIDL_COMPILE[[:space:]]*=/s@\$(LIBXUL_DIST)/@&sdk/@' config/config.mk

	./configure --with-libxul-sdk=`pkg-config --variable=sdkdir libxul` \
		--with-system-libxul \
		--with-system-nspr \
		--with-system-nss \
		--enable-application=extensions \
		--enable-extensions=globalmenu \
		--disable-tests \
		--disable-necko-wifi
	make || return 1
}

package_globalmenu-extension-firefox() {
	pkgdesc="Firefox extension that exports the standard menu bar via libdbusmenu"
	depends=('appmenu-gtk2' 'firefox')
	
	cd "$srcdir/${_bzrname}-build"
	emid=$(sed -n '/.*<em:id>\(.*\)<\/em:id>.*/{s//\1/p;q}' extensions/globalmenu/install.rdf)
	install -d ${pkgdir}/usr/lib/firefox/extensions/${emid}
	unzip -d ${pkgdir}/usr/lib/firefox/extensions/${emid} dist/xpi-stage/globalmenu.xpi
}

package_globalmenu-extension-thunderbird() {
	pkgdesc="Thunderbird extension that exports the standard menu bar via libdbusmenu"
	depends=('appmenu-gtk2' 'thunderbird')
	
	cd "$srcdir/${_bzrname}-build"
	emid=$(sed -n '/.*<em:id>\(.*\)<\/em:id>.*/{s//\1/p;q}' extensions/globalmenu/install.rdf)
	install -d ${pkgdir}/usr/lib/thunderbird/extensions/${emid}
	unzip -d ${pkgdir}/usr/lib/thunderbird/extensions/${emid} dist/xpi-stage/globalmenu.xpi
}

pkgdesc="global appmenu extension for Firefox and Thunderbird"
depends=('appmenu-gtk' 'firefox' 'thunderbird')
true && depends=()
# vim:syntax=sh

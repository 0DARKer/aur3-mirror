# Contributor: Roman Ajsin <aysin (dot) roman [at] gmail (dot) com>

pkgname=kernel26-squashfs-lzma-modules
_kernelname=${pkgname#kernel26}
_basekernel=2.6.31
_kernver="2.6.31-ARCH"
pkgver=${_basekernel}.5
pkgrel=1
_patchname="patch-${pkgver}-${pkgrel}-ARCH"
pkgdesc="Squashfs with LZMA support modules for Linux Kernel."
arch=('i686' 'x86_64')
license=('GPL2')
url="http://www.kernel.org"
depends=('coreutils' 'kernel26>=2.6.31.5' 'module-init-tools')
optdepends=('squashfs-tools-lzma: to build squashfs image with lzma compression')
install=kernel26.install
source=(ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$_basekernel.tar.bz2
        ftp://ftp.archlinux.org/other/kernel26/${_patchname}.bz2
        # LZMA patches
        https://dev.openwrt.org/export/18255/trunk/target/linux/generic-2.6/patches-2.6.31/051-squashfs_pcomp.patch
        https://dev.openwrt.org/export/18255/trunk/target/linux/generic-2.6/patches-2.6.31/052-pcomp_lzma_support.patch
        https://dev.openwrt.org/export/18255/trunk/target/linux/generic-2.6/patches-2.6.31/053-squashfs_lzma.patch
	# the main kernel config files
        config config.x86_64)
md5sums=('84c077a37684e4cbfa67b18154390d8a'
         'ad74a0005058dfe5459bbe3319317297'
         'bd8431ac94cb695c423bc2d7a49285b6'
         '5fb7a91faa326f6ee2be33ccae49b550'
         'dd83c6224ef22352de83990e45da1d00'
         'dae9c0939f91f317cf7d716951a5ec26'
         'd92d93d774b131dabb49e40474e7a319')

build() {
  KARCH=x86

  cd ${srcdir}/linux-$_basekernel
  # Add -ARCH patches
  # See http://projects.archlinux.org/linux-2.6-ARCH.git/
  patch -Np1 -i ${srcdir}/${_patchname} || return 1

  # applying LZMA for SQUASHFS patches
  msg "Applying LZMA patches for SQUASHFS"
  patch -Np1 -i ${srcdir}/051-squashfs_pcomp.patch || return 1
  patch -Np1 -i ${srcdir}/052-pcomp_lzma_support.patch || return 1
  patch -Np1 -i ${srcdir}/053-squashfs_lzma.patch || return 1

  if [ "$CARCH" = "x86_64" ]; then
    cat ../config.x86_64 >./.config
  else
    cat ../config >./.config
  fi
  if [ "${_kernelname}" != "" ]; then
    sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"-ARCH\"|g" ./.config
  fi

  make prepare || return 1

  # build tools
  make modules_prepare || return 1

  # build UNLZMA module
  make modules SUBDIRS=crypto || return 1

  # build SQUASHFS with LZMA support module
  make modules SUBDIRS=fs/squashfs || return 1

  mkdir -p ${pkgdir}/lib/modules/${_kernver}/misc
  cp ${srcdir}/linux-$_basekernel/crypto/unlzma.ko \
    ${pkgdir}/lib/modules/${_kernver}/misc
  cp ${srcdir}/linux-$_basekernel/fs/squashfs/squashfs.ko \
    ${pkgdir}/lib/modules/${_kernver}/misc/squashfs_lzma.ko
}

pkgname=monogame-git
pkgver=20121023
pkgrel=1
pkgdesc="XNA Implementation for Mono based platforms (git)"
arch=(any)
license=("Microsoft Public License")
depends=(mono opentk-svn)
makedepends=(mono nant git)
options=(!strip)
url="http://monogame.codeplex.com/"
_gitroot="https://github.com/mono/MonoGame.git"
_gitname=MonoGame

build() {
  cd "$srcdir"
  msg "Connecting to GIT server...."

  if [[ -d "$_gitname" ]]
  then
    cd "$_gitname" && git pull origin
    msg "The local files are updated."
  else
    git clone "$_gitroot" "$_gitname"
  fi

  msg "GIT checkout done or server timeout"
  msg "Starting build..."
  rm -rf "$srcdir/$_gitname-build"
  cp -r "$srcdir/$_gitname" "$srcdir/$_gitname-build"
  cd "$srcdir/$_gitname-build"
  
  nant buildlinux
  nant buildwindows
  sn -k 1024 "$srcdir/MonoGame.snk"
  cd "MonoGame.Framework/bin/Release"
  rm Lidgren.Network.Windows.{dll,dll.mdb}
  rm MonoGame.Framework.Windows.dll
  find . -name 'Lidgren.Network*.dll' -o -name 'MonoGame.Framework.*.dll' |
    xargs -rtl1 -I {} monodis {} --output={}.il
  for file in *.dll.il; do
    mv $file ${file%.dll.il}.il
  done
  find . -name '*.il' | xargs -rtl1 -I {} ilasm /dll /key:$srcdir/MonoGame.snk {}
  
  cd "$srcdir/$_gitname-build/MonoGame.Framework.Content.Pipeline/bin/Release"
  rm Tao.Sdl.dll
  find . -name 'Lidgren.Network*.dll' -o -name 'MonoGame.Framework.*.dll' |
    xargs -rtl1 -I {} monodis {} --output={}.il
  for file in *.dll.il; do
    mv $file ${file%.dll.il}.il
  done
  find . -name '*.il' | xargs -rtl1 -I {} ilasm /dll /key:$srcdir/MonoGame.snk {}
}

package() {
  cd "$srcdir/$_gitname-build/MonoGame.Framework/bin/Release"
  find . -name '*.dll' -o -name '*.mdb' -o -name '.*mgfxo' -o -name '*.config' |
    xargs -rtl1 -I {} install -Dm644 {} "$pkgdir/usr/lib/monogame/"{}
  cd "$srcdir/$_gitname-build/MonoGame.Framework.Content.Pipeline/bin/Release"
  find . -name '*.dll' -o -name '*.mdb' | xargs -rtl1 -I {} install -m644 {} "$pkgdir/usr/lib/monogame/"{}
  find "$pkgdir/usr/lib/monogame" -name '*.dll' | xargs -rtl1 -I {} gacutil -i {} -root "$pkgdir/usr/lib"
  install -Dm644 "$srcdir/$_gitname-build/LICENSE.txt" "$pkgdir/usr/share/licenses/$pkgname/LICENSE.txt"
}

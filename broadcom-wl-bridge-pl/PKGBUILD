# Maintainer: Piotr Gorski <sir_lucjan@openlinux.pl>
# Contributor: Austin ( doorknob60 [at] gmail [dot] com )
# Contributor: Gaetan Bisson <bisson@archlinux.org>
# Contributor : Mark Lee <mark@markelee.com>

pkgname=broadcom-wl-bridge-pl
pkgver=6.30.223.141
pkgrel=2
pkgdesc='Broadcom 802.11abgn hybrid Linux networking device driver'
url='http://www.broadcom.com/support/802.11/linux_sta.php'
arch=('i686' 'x86_64')
license=('custom')
depends=('linux-bridge-pl')
makedepends=('linux-bridge-pl-headers')

if [ "$CARCH" = "x86_64" ]; then
   source=("http://www.broadcom.com/docs/linux_sta/hybrid-v35_64-nodebug-pcoem-${pkgver//./_}.tar.gz");
   sha256sums+=('5f37b2b879e29b220dc64ce2e93d922dc231d4241da03bcbab15ced10e649b4a');
 else
   source=("http://www.broadcom.com/docs/linux_sta/hybrid-v35-nodebug-pcoem-${pkgver//./_}.tar.gz");
   sha256sums+=('57c33f6bf4ebe68cac67ffe39c2260b8990bb0f07413dfd021dd4db845199a7');
fi

source+=('modprobe.d'
        'license.patch'
        'linux-recent.patch'
        'gcc.patch')
sha256sums+=('b4aca51ac5ed20cb79057437be7baf3650563b7a9d5efc515f0b9b34fbb9dc32'
             '24d02018e4e5b90516ba3e98bd957ad91e758944c8a21e22d56a516f2361c6f9'
             'a20091e9bae625ee34aecb3900a402506229781bb709124208322ef9601edb4f')

backup=('etc/modprobe.d/broadcom-wl.conf')
install=install

_kernver=($(pacman -Q linux-bridge-pl)); ## grab pacman output for linux package
_kernver="${_kernver[1]}-bridge-pl"; ## output only the version of the linux package
_extramodules="extramodules-${_kernver:0:3}-bridge-pl"; ## get the extra modules directory

prepare() {
  patch -p1 -i linux-recent.patch
  patch -p1 -i license.patch
  patch -p1 -i gcc.patch
}

build() {
	cd "${srcdir}"
        make -C /usr/lib/modules/"${_kernver}"/build M=`pwd`
}

package() {
	cd "${srcdir}"

	install -D -m 755 wl.ko "${pkgdir}/usr/lib/modules/${_extramodules}/wl-bridge-pl.ko"
	gzip "${pkgdir}/usr/lib/modules/${_extramodules}/wl-bridge-pl.ko"

	install -D -m 644 lib/LICENSE.txt "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
	install -D -m 644 modprobe.d "${pkgdir}"/etc/modprobe.d/broadcom-wl-bridge-pl.conf
}
sha256sums=('d57c33f6bf4ebe68cac67ffe39c2260b8990bb0f07413dfd021dd4db845199a7'
            'b4aca51ac5ed20cb79057437be7baf3650563b7a9d5efc515f0b9b34fbb9dc32'
            '24d02018e4e5b90516ba3e98bd957ad91e758944c8a21e22d56a516f2361c6f9'
            'a20091e9bae625ee34aecb3900a402506229781bb709124208322ef9601edb4f'
            'fac1bdde7b837aaf96a46feb28a16ae8f5744ed0c6270ed959a26089d8bda963')

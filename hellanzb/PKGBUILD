# Maintainer: Roland Kammerer <dev.rck@gmail.com>

pkgname=hellanzb
pkgver=0.13
pkgrel=8
pkgdesc="nzb downloader and post processor"
url="http://www.hellanzb.com"
depends=('python' 'twisted-web2' 'par2cmdline' 'unrar')
optdepends=('pyopenssl: for SSL')
source=("http://distfiles.macports.org/python/$pkgname-$pkgver.tar.gz" \
"hellanzb.rc" "hellanzb.conf.d" "whitespace-fix.diff" "python_26_fixes.diff" "877271.diff" "877271-2.diff" "877281.diff")
arch=('i686' 'x86_64')
license='BSD'
install=hellanzb.install
backup=('etc/conf.d/hellanzb')
md5sums=('d3510c6b1b2c7b935332a469fdc8e7e2'
         '85a0e75581781a4854bdc4903118773b'
         '0bda37be41e3d0662bd8cdb0fdff6a20'
         'be7ccbed81e98c43c59a10ab64992f7c'
         '86888247312f7b95df9c914e920e04b4'
         'e02e555616f9ffd748f3aedaaf17d143'
         '93160251bb66d63cbc55e79765b3b1db'
         'c0da3f5b87a84abe2d5cb7c3d87769df')

build() {
	cd $startdir/src/$pkgname-$pkgver

	# change the configuration directories searched from /usr/etc to /etc and
	# from ./etc to ~/.config
	sed -i \
		-e "\|confDirs = |s|sys.prefix|'/'|" \
		-e "\|confDirs\.append|s|join(os.getcwd(), *'etc|expanduser('~/.config|" \
		Hellanzb/Core.py || return 1

	# fix the problem with whitespace in the group name
	patch -p1 < ../whitespace-fix.diff || return 1
	patch -p0 < ../python_26_fixes.diff || return 1

	python ./setup.py install --root=$startdir/pkg || return 1
	patch < ../877271.diff $startdir/pkg/usr/lib/python2.6/site-packages/Hellanzb/HellaXMLRPC/xmlrpc.py || return 1  
      	patch < ../877271-2.diff $startdir/pkg/usr/lib/python2.6/site-packages/Hellanzb/HellaXMLRPC/HtPasswdAuth.py || return 1
	patch < ../877281.diff $startdir/pkg/usr/lib/python2.6/site-packages/Hellanzb/HellaReactor.py || return 1


	# move /usr/etc to /etc
	mv $startdir/pkg/usr/etc $startdir/pkg/

	install -D -m644 LICENSE $startdir/pkg/usr/share/licenses/$pkgname/LICENSE

	# install the rc scripts
	cd $startdir
	mkdir -p $startdir/pkg/etc/{rc.d,conf.d}
	install -D -m755 hellanzb.rc $startdir/pkg/etc/rc.d/hellanzb
	install -D -m644 hellanzb.conf.d $startdir/pkg/etc/conf.d/hellanzb

#        patch -p0 < ../877271.diff || return 1
 #       patch -p1 < ../877271-2.diff || return 1
  #      patch -p0 < ../877281.diff || return 1

}

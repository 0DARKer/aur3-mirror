--- pacman-cage.orig	2007-09-09 22:56:46.000000000 +0200
+++ pacman-cage	2010-02-12 10:22:11.000000000 +0100
@@ -24,6 +24,7 @@
 myver='2.9.8.2' 
 dbroot="/var/lib/pacman" 
 pacmandb="/var/lib/pacman.db" 
+pacmanlog=$(pacman -v | grep "Log File" | cut -d ":" -f2)
 
 usage() { 
         echo "pacman-cage $myver" 
@@ -77,6 +78,9 @@
 # don't let pacman run while we do this 
 touch /tmp/pacman.lck 
   
+# write to pacman.log
+echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Starting and preparing pacman database caging process ..." >> ${pacmanlog}
+
 # step 1: sum the old db 
 echo "==> md5sum'ing the old database..." 
 find $dbroot -type f | sort | xargs md5sum >/tmp/pacsums.old 
@@ -103,9 +107,10 @@
 rmdir /mnt/tmp-pacman 
         
 echo "==> moving old /var/lib/pacman to /var/lib/pacman.bak..." 
+[[ -d /var/lib/pacman.bak ]] && rm -fr /var/lib/pacman.bak
 mv /var/lib/pacman /var/lib/pacman.bak 
         
-echo "==> createing new pacman db mount point @ $dbroot..." 
+echo "==> creating new pacman db mount point @ $dbroot..." 
 mkdir $dbroot 
 
 echo "==> Mounting new pacman db..." 
@@ -121,6 +126,7 @@
         umount $dbroot 
         rm $pacmandb 
         mv $dbroot.bak $dbroot 
+        echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Something went wrong. Old database was restored." >> ${pacmanlog}
         die_r "integrity check FAILED, reverting to old database" 
 fi 
 
@@ -130,6 +136,7 @@
   
 rm -f /tmp/pacman.lck /tmp/pacsums.old /tmp/pacsums.new 
   
+echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Pacman database has been caged." >> ${pacmanlog}
 echo 
 echo "Finished.  Your pacman database has been caged!.  May the speedy pacman be with you." 
 echo 
--- pacman-uncage.orig	2007-09-09 22:56:46.000000000 +0200
+++ pacman-uncage	2010-02-12 10:22:45.000000000 +0100
@@ -25,6 +25,7 @@
 dbroot="/var/lib/pacman" 
 tmproot="/var/lib/pacman.new" 
 pacmandb="/var/lib/pacman.db" 
+pacmanlog=$(pacman -v | grep "Log File" | cut -d ":" -f2)
 
 usage() { 
         echo "pacman-uncage $myver" 
@@ -73,6 +74,9 @@
 # don't let pacman run while we do this 
 touch /tmp/pacman.lck 
 
+# write to pacman.log
+echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Starting and preparing pacmandb uncaging process ..." >> ${pacmanlog}
+
 # step 1: sum the old db 
 echo "==> md5sum'ing the old database..." 
 find $dbroot -type f | sort | xargs md5sum >/tmp/pacsums.old 
@@ -95,7 +99,8 @@
         # failed, move the old one back into place 
         rm -rf $dbroot 
         mkdir $dbroot 
-        mount $pacmandb $dbroot 
+        mount -o loop $pacmandb $dbroot 
+        echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Something went wrong. $pacmandb remounted to $dbroot." >> ${pacmanlog}
         die_r "integrity check FAILED, reverting to old database" 
 fi 
 
@@ -104,6 +109,7 @@
 
 rm -f /tmp/pacman.lck /tmp/pacsums.old /tmp/pacsums.new 
             
+echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [cmd] >> Pacman database has been uncaged." >> ${pacmanlog}
 echo 
 echo "Finished.  Your pacman database has been uncaged!. Welcome home." 
 #echo "You will need to remove the old mount line from your /etc/fstab" 
--- pacmandb.rc.orig	2007-09-09 22:56:46.000000000 +0200
+++ pacmandb.rc	2010-02-12 10:21:13.000000000 +0100
@@ -3,47 +3,62 @@
 . /etc/rc.conf
 . /etc/rc.d/functions
 
+pacmanlog=$(pacman -v | grep "Log File" | cut -d ":" -f2)
+
 case "$1" in
-start)
-# Check and mount pacman database 
-stat_busy "Mounting the pacman database"
-/sbin/e2fsck -p /var/lib/pacman.db >/dev/null
-if [ $? -gt 1 ]; then
-   stat_fail
-   echo 
-   echo "WARNING: PACMAN DATABASE FILESYSTEM CHECK FAILED, NOT MOUNTED" 
-   echo 
-else
-   mount -o loop -t ext2 /var/lib/pacman.db /var/lib/pacman
-   if [ $? -gt 0 ]; then
-      stat_fail
-      echo 
-      echo "WARNING: MOUNTING PACMAN DATABASE FAILED" 
-      echo 
-   else
-      stat_done
-      add_daemon pacmandb
-   fi
-fi
-;;
+    start)
+    # Check and mount pacman database 
+    stat_busy "Mounting the pacman database"
+    # write to pacman.log
+    echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> Mounting the pacmans database" >> ${pacmanlog}
+    /sbin/e2fsck -p /var/lib/pacman.db >/dev/null
+    if [ $? -gt 1 ]; then
+        stat_fail
+        echo 
+        echo "WARNING: PACMAN DATABASE FILESYSTEM CHECK FAILED, NOT MOUNTED" 
+        echo 
+        # write to pacman.log
+        echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> WARNING: Pacman database filesystem check failed, not mounted!" >> ${pacmanlog}
+    else
+        mount -o loop -t ext2 /var/lib/pacman.db /var/lib/pacman
+        if [ $? -gt 0 ]; then
+            stat_fail
+            echo 
+            echo "WARNING: MOUNTING PACMAN DATABASE FAILED" 
+            echo 
+            # write to pacman.log
+            echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> WARNING: Mounting of the pacman database failed!" >> ${pacmanlog}
+        else
+            stat_done
+            add_daemon pacmandb
+            # write to pacman.log
+            echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> Pacman database successfully mounted." >> ${pacmanlog}
+        fi
+    fi
+    ;;
 
-stop)
-stat_busy "Unmounting the pacman database"
-umount /var/lib/pacman >/dev/null 2>&1
-if [ $? -ne 0 ]; then
- stat_fail
-else
- stat_done
- rm_daemon pacmandb
-fi
-;;
+    stop)
+    stat_busy "Unmounting the pacman database"
+    umount /var/lib/pacman >/dev/null 2>&1
+    if [ $? -ne 0 ]; then
+        # write to pacman.log
+        echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> WARNING: Umounting of the pacman database failed!" >> ${pacmanlog}
+        stat_fail
+    else
+        stat_done
+        rm_daemon pacmandb
+        # write to pacman.log
+        echo "[ $(date "+%Y-%m-%d %H:%M ")] Pacman-cage [rc] >> Pacman database successfully unmounted." >> ${pacmanlog}
+    fi
+    ;;
 
-restart)
-$0 stop
-sleep 2
-$0 start
-;;
+    restart)
+    $0 stop
+    sleep 2
+    $0 start
+    ;;
 
-*)
-echo "usage: $0 {start|stop|restart}"  
+    *)
+    echo "usage: $0 {start|stop|restart}"  
+    ;;
 esac

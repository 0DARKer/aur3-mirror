# Maintainer: Michael Schubert <mschu.dev at gmail>

pkgname=mgltools
pkgver=1.5.4
pkgrel=1
pkgdesc="MGLTools is used for visualization and analysis of molecular structures; it includes AutodockTools, Vision and PythonMoleculeViewer"
arch=('i686' 'x86_64')
url="http://mgltools.scripps.edu/"
license=('custom')
depends=('python2' 'swig' 'tk' 'python-imaging' 'python-pmw' 'glut' 'zsi')
provides=('python2-autodock')
conflicts=('python2-autodock')
source=("http://mgltools.scripps.edu/downloads/tars/releases/REL${pkgver}/${pkgname}_source_${pkgver}.tar.gz")
md5sums=('2c25ebf392a9b1457dc098a7fb6323f2')

build() {
  pydir=`python2 -c "from distutils.sysconfig import get_python_lib; print get_python_lib()"`
  mkdir -p ${pkgdir}$pydir
  cd $srcdir/${pkgname}_source_$pkgver
  sed -i "1s:python2.5:python2:" InstTools/install

  # replace path by os.path where needed
  sed -i "s:path.exists:os.path.exists:" InstTools/install
  sed -i "s:os.os.path.exists:os.path.exists:" InstTools/install
  sed -i "s:path.join:os.path.join:" InstTools/install
  sed -i "s:os.os.path.join:os.path.join:" InstTools/install

  # do not install pmw since it is dependecy already
  sed -i 's:getYesNo(msg, "Do you wish to install Pmw to %s" % shareLoc):False:' InstTools/install
  # fix include for strcmp in geomutils
  sed -i "239i\    if (pkgname == \"geomutils\"): os.popen(\"sed -i '3i#include <string.h>' src/geomAlgorithms/objfile.cpp\")" InstTools/install
  # fix opengltk to work with tcl/tk 8.5
  sed -i "240i\    if (pkgname == \"opengltk\"): os.popen(\"sed -i 's/stub8.4/stub8.5/g' setup.py\")" InstTools/install

  ./startInstallation --quiet --instDir=${pkgdir}$pydir

  # link to bin directory
  mkdir -p $pkgdir/usr/bin
  ln -s $pydir/runAdt $pkgdir/usr/bin/adt
  ln -s $pydir/runPmv $pkgdir/usr/bin/pmv
  ln -s $pydir/runVision $pkgdir/usr/bin/vision

  # let python know about the new modules
  echo "$pydir/MGLToolsPckgs" > ${pkgdir}$pydir/mgltools.pth

  # fix some python 2.7 issues in the package
  sed -i "/self.__debug__ = 0/d" ${pkgdir}$pydir/MGLToolsPckgs/ViewerFramework/VF.py
}

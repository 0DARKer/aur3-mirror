# Maintainer: Cl√©ment Mairet <clement.mairet@tigris.fr>
pkgname=spyrit-hg
pkgver=574
pkgrel=1
pkgdesc="A modern client for MUSH, MUCK, MOO and MUD textual roleplaying games, development version."
arch=("any")
url="http://spyrit.ierne.eu.org/"
license=("GPL")
depends=("python2-pyqt" "mercurial")
optdepends=("python-pygame: for sound notifications")
conflicts=("spyrit")
source=()
md5sums=()

_hgroot="https://bitbucket.org/balinares"
_hgrepo="spyrit"

build() {
  cd "$srcdir"
  msg "Connecting to Mercurial server...."

  if [ -d $_hgrepo ] ; then
    cd $_hgrepo
    hg pull -u || return 1
    msg "The local files are updated."
  else
    hg clone $_hgroot $_hgrepo || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_hgrepo-build"
  cp -r "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"

  #
  # BUILD HERE
  #

  # Change python to python2 to be compatible with Arch
  sed -i "1s/python/python2/" src/resources/*.py
  sed -i "s/python/python2/" spyrit.sh
  sed -i "s/python/python2/" dist/build.py

  # Generate resources
  python2 src/resources/mkresources.py

  # Build standalone script
  python2 dist/build.py src/spyrit.py > ${pkgname}-${pkgver}.py
}

package() {
  install -D -m755 $srcdir/$_hgrepo-build/${pkgname}-${pkgver}.py $pkgdir/usr/bin/$_hgrepo
}

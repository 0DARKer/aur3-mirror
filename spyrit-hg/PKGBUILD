# Maintainer: Cl√©ment Mairet <clement.mairet@tigris.fr>
pkgname=spyrit-hg
pkgver=574
pkgrel=2
pkgdesc="A modern client for MUSH, MUCK, MOO and MUD textual roleplaying games, development version."
arch=("any")
url="http://spyrit.ierne.eu.org/"
license=("GPL")
depends=("python2-pyqt" "mercurial")
optdepends=("python-pygame: for sound notifications")
conflicts=("spyrit")
source=('001-archlinux-compat.patch'
        '002-connect_line-setting.patch')
md5sums=('63c93460217455b32e5feba2815054e6'
         '558fcf17f80d1448aee1862587536af4')

_hgroot="https://bitbucket.org/balinares"
_hgrepo="spyrit"

build() {
  cd "$srcdir"
  msg "Connecting to Mercurial server...."

  if [ -d $_hgrepo ] ; then
    cd $_hgrepo
    hg pull -u >/dev/null 2>&1 || return 1
    msg "The local files are updated."
  else
    hg clone $_hgroot $_hgrepo || return 1
  fi

  msg "Mercurial checkout done or server timeout"
  msg "Starting build..."

  rm -rf "$srcdir/$_hgrepo-build"
  cp -r "$srcdir/$_hgrepo" "$srcdir/$_hgrepo-build"
  cd "$srcdir/$_hgrepo-build"

  #
  # BUILD HERE
  #

  # Apply Arch patch to make Spyrit python2-aware
  msg2 "Applying Arch Linux compatibility patch..."
  patch -uNp1 -i ../001-archlinux-compat.patch >/dev/null 2>&1 || return 1

  msg2 "Applying connect_line patch..."
  # Apply connect_line patch to allow sending autoconnect text
  patch -uNp1 -i ../002-connect_line-setting.patch >/dev/null 2>&1 || return 1

  # Generate resources
  msg2 "Generating resources..."
  python2 src/resources/mkresources.py

  # Build standalone script
  msg2 "Bundling standalone script..."
  python2 dist/build.py src/spyrit.py > ${pkgname}-${pkgver}.py
}

package() {
  install -D -m755 $srcdir/$_hgrepo-build/${pkgname}-${pkgver}.py $pkgdir/usr/bin/$_hgrepo
}

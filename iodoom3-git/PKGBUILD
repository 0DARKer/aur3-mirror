# Contributor: Slash <demodevil5 [at] yahoo [dot] com>
# Contributor: Andrew Simmons <andrew.simmons@gmail.com>
# Contributor: teddy_beer_maniac <teddy_beer_maniac@wp.pl>
# Contributor: Babets
# Contributor: Paolo Bolzoni
# Maintainer: Behem0th <grantipak at gmail dot com>

pkgname=iodoom3-git
pkgver=20120128
pkgrel=1
pkgdesc="A fork of the Doom 3 source code as released by id software under the GPLv3 on November 22, 2011. You need the retail .pk4 files to play."
arch=(i686 x86_64)
url="http://www.iodoom3.org/"
license=('GPL')
groups=(games)
[ "$CARCH" = "i686"   ] && depends=('libxext' 'libgl' 'alsa-lib>=1.0.6')
[ "$CARCH" = "x86_64" ] && depends=('lib32-gcc-libs' 'lib32-libxdamage' 'lib32-libxext' 'lib32-libgl' 'lib32-alsa-lib>=1.0.6' 'lib32-libstdc++5' 'lib32-openal')
makedepends=('git' 'scons' 'gcc')
provides=("iodoom3")
install=iodoom3.install
source=('iodoom3.launcher' 'iodoom3.desktop' 'iodoom3.launcher64' 'iodoom3.png' 'iodoom3.install')
_gitroot="git://git.iodoom.org/iodoom3/iodoom3.git"
_gitname="iodoom3"
md5sums=('ccd29ade9415bc659520315df1f2aa77'
         'fbc743347b77a53c05beb010dbb7e31a'
         'f45bb0c36a4f23a1286d7b790318d98a'
         'f99eb141eecc4b9dd188d6819d741546'
         '8a2697e2f350541d6bc58e80bf0b4bf0')
build() {
  msg "Connecting to git.freedesktop.org GIT server...."

  if [ -d $startdir/src/$_gitname ] ; then
    cd $_gitname && git pull origin master
    msg "The local files are updated."
  else
    git clone $_gitroot
  fi

  msg "GIT checkout done or server timeout"

  msg "Creating build directory"
  cd "$srcdir"
  cp -rH $_gitname $_gitname-build

 msg "Starting configure & make..."
  cd $_gitname-build/neo
  scons NOCURL=1 BUILD=release BUILD_GAMEPAK=1
}

package() {
  install -m 755 -d "$pkgdir"/opt/iodoom3/{base,d3xp}
  install -m 644 "$srcdir"/iodoom3-build/neo/game01-base.pk4 "$pkgdir"/opt/iodoom3/base/game01.pk4
  install -m 644 "$srcdir"/iodoom3-build/neo/game01-d3xp.pk4 "$pkgdir"/opt/iodoom3/d3xp/game01.pk4

  if [ "$CARCH" == "i686" ]; then
    install -D -m 755 $srcdir/iodoom3.launcher \
    $pkgdir/usr/bin/iodoom3
  else
    install -D -m 755 $srcdir/iodoom3.launcher64 $pkgdir/usr/bin/iodoom3
  fi

  install -m 755 "$srcdir"/iodoom3-build/neo/doom.x86 "$pkgdir"/opt/iodoom3
  install -D -m 644 "$srcdir"/iodoom3.png "$pkgdir"/usr/share/pixmaps/iodoom3.png
  install -D -m 644 "$srcdir"/iodoom3.desktop "$pkgdir"/usr/share/applications/iodoom3.desktop
}

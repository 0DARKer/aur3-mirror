From e6488e236bf9c8a10d28defc4403733163646c05 Mon Sep 17 00:00:00 2001
From: Matthias Dietrich <matze_holz@web.de>
Date: Thu, 25 Jul 2013 21:30:45 +0200
Subject: [PATCH 1/2] spaceAPI

---
 xmobar-0.18/src/Config.hs                 |  3 ++-
 xmobar-0.18/src/Plugins/SpaceApiWriter.hs | 45 +++++++++++++++++++++++++++++++
 2 files changed, 47 insertions(+), 1 deletion(-)
 create mode 100644 xmobar-0.18/src/Plugins/SpaceApiWriter.hs

diff --git a/xmobar-0.18/src/Config.hs b/xmobar-0.18/src/Config.hs
index 4f03d93..59720b7 100644
--- a/xmobar-0.18/src/Config.hs
+++ b/xmobar-0.18/src/Config.hs
@@ -36,6 +36,7 @@ import Plugins.XMonadLog
 import Plugins.EWMH
 import Plugins.Kbd
 import Plugins.Locks
+import Plugins.SpaceApiWriter
 
 #ifdef INOTIFY
 import Plugins.Mail
@@ -134,7 +135,7 @@ infixr :*:
 -- the 'Runnable.Runnable' Read instance. To install a plugin just add
 -- the plugin's type to the list of types (separated by ':*:') appearing in
 -- this function's type signature.
-runnableTypes :: Command :*: Monitors :*: Date :*: PipeReader :*: BufferedPipeReader :*: CommandReader :*: StdinReader :*: XMonadLog :*: EWMH :*: Kbd :*: Locks :*:
+runnableTypes :: Command :*: Monitors :*: Date :*: PipeReader :*: BufferedPipeReader :*: CommandReader :*: StdinReader :*: XMonadLog :*: EWMH :*: Kbd :*: Locks :*: SpaceApiWriter :*:
 #ifdef INOTIFY
                  Mail :*: MBox :*:
 #endif
diff --git a/xmobar-0.18/src/Plugins/SpaceApiWriter.hs b/xmobar-0.18/src/Plugins/SpaceApiWriter.hs
new file mode 100644
index 0000000..91a697d
--- /dev/null
+++ b/xmobar-0.18/src/Plugins/SpaceApiWriter.hs
@@ -0,0 +1,45 @@
+{-# LANGUAGE OverloadedStrings #-}
+-----------------------------------------------------------------------------
+-- |
+-- Module      :  Plugins.SpaceAPIWriter
+-- Copyright   :  (c) Matthias Dietrich
+-- License     :  GPLv3
+--
+-- Maintainer  :  Matthias Dietrich <matthias.dietrich@wood-it.de>
+-- Stability   :  unstable
+-- Portability :  unportable
+--
+-- A DBus-Service, which writes the state of Hackspaces to XMobar
+--
+-----------------------------------------------------------------------------
+
+module Plugins.SpaceApiWriter where
+
+import Plugins
+import DBus
+import DBus.Client
+
+data SpaceApiWriter = SpaceApiWriter String Int
+    deriving (Read, Show)
+
+instance Exec SpaceApiWriter where
+    alias (SpaceApiWriter a _) = a
+    rate  (SpaceApiWriter _ r) = r
+    run   (SpaceApiWriter _ _) = do
+        client <- connectSession
+
+        -- Request a list of connected clients from the bus
+        reply <- call_ client (methodCall "/org/woodIT/spaceAPI" "org.woodIT.spaceAPIDaemon.viewer" "getApiStringColor")
+            { methodCallDestination = Just "org.woodIT.spaceAPI"
+            }
+
+        return (unwrapFirst reply)
+  
+-- Gives the first return value of a function called over DBus
+unwrapFirst :: IsVariant a => MethodReturn -> a
+unwrapFirst ret = unwrapped
+  where Just unwrapped = fromVariant $ head $ methodReturnBody ret
+        
+                        
+
+        
-- 
1.8.3.4


From 62a10ab1b734389910efd1851aeddb2ef3bc337a Mon Sep 17 00:00:00 2001
From: Matthias Dietrich <matze_holz@web.de>
Date: Sat, 27 Jul 2013 20:01:52 +0200
Subject: [PATCH 2/2] spaceAPI

---
 xmobar-0.18/src/Plugins/SpaceApiWriter.hs | 1 +
 1 file changed, 1 insertion(+)

diff --git a/xmobar-0.18/src/Plugins/SpaceApiWriter.hs b/xmobar-0.18/src/Plugins/SpaceApiWriter.hs
index 91a697d..a140450 100644
--- a/xmobar-0.18/src/Plugins/SpaceApiWriter.hs
+++ b/xmobar-0.18/src/Plugins/SpaceApiWriter.hs
@@ -32,6 +32,7 @@ instance Exec SpaceApiWriter where
         reply <- call_ client (methodCall "/org/woodIT/spaceAPI" "org.woodIT.spaceAPIDaemon.viewer" "getApiStringColor")
             { methodCallDestination = Just "org.woodIT.spaceAPI"
             }
+	disconnect client
 
         return (unwrapFirst reply)
   
-- 
1.8.3.4


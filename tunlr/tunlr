#!/bin/bash

# tunlr 0.1.9 - watch netflix, mtu, cbs, hulu & more outside the u.s.
# for more information about tunlr please visit <http://tunlr.net/>
#
# Copyright: (C) 2012 edloaa <edloaa at googlemail dot com>
# License: GPL-3 <http://www.gnu.org/licenses/gpl-3.0.txt>

RSLV=/etc/resolv.conf
NLL=/dev/null
QUERY='http://tunlr.net/tunapi.php?action=getdns&version=1&format=json'
IPV4='\<[[:digit:]]{1,3}(\.[[:digit:]]{1,3}){3}\>'

if [ $UID != 0 ] && [[ "$1" =~ start|stop ]]
then
	echo "you must be root to run 'tunlr $1'" 1>&2
	exit 1
fi

err() { echo "failed"; exit 1; }

case "$1" in

	start)	echo -n "activating tunlr service... "

		# DNS IP query
		L1=$(wget -q -O - "$QUERY" | grep -Eo "$IPV4")

		if [ -z "$L1" ]
		then
			echo -e "failed\nDNS address query failed - no IP address received"
			exit 1
		else
			L2=$(echo "$L1" | sed 's/ /\n/g' | sed 's/^/nameserver /g')
			L3=$(echo $L1 | sed -e 's/ / and /g')
		fi

		if [ -f $RSLV.bak ]
		then
			echo -e "failed\n$RSLV.bak does already exist - nothing will be changed"
			exit 1
		else
			cp $RSLV $RSLV.bak 2>$NLL || err
		fi

		echo -e "#TUNLR DNS\n$L2" >$RSLV 2>$NLL
		cat $RSLV.bak >>$RSLV
		echo -e "ok\n$L3 have been added to $RSLV\nrestart your web browser to apply the changes"
		;;

	stop)	echo -n "deactivating tunlr service... "

		if [ -f $RSLV.bak ]
		then
			cp $RSLV.bak $RSLV 2>$NLL || err
			rm $RSLV.bak 2>$NLL || err
			echo -e "ok\nrestart your web browser to apply the changes"
		else
			echo -e "failed\n$RSLV.bak does not exist - unable to restore DNS config"
			exit 1
		fi
		;;

	*)	echo "usage: $0 {start|stop}" ;;

esac

exit 0

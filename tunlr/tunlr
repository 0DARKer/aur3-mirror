#!/bin/bash

# tunlr - watch netflix, mtv, cbs, hulu and more outside the u.s.
# for more information please visit <http://tunlr.net/>
#
# copyright: (c) 2012 edloaa <edloaa at googlemail dot com>
# license: gpl-3 <http://www.gnu.org/licenses/gpl-3.0.txt>

if [ $UID != 0 ]; then
	echo "you must be root to run tunlr"
	exit 1
fi

case "$1" in
	start)
		echo "starting tunlr"
		if [ ! -f /etc/resolv.conf.bak ]; then
			cp /etc/resolv.conf /etc/resolv.conf.bak
		fi
		cat /etc/tunlr/tunlr_dns > /etc/resolv.conf
		cat /etc/resolv.conf.bak >> /etc/resolv.conf
		echo "restart your web browser to apply the changes"
		;;

	stop)
		echo "stopping tunlr"
		if [ ! -f /etc/resolv.conf.bak ]; then
			echo "/etc/resolv.conf.bak does not exsist. unable to restore DNS config"
			exit 1
		fi
		cp /etc/resolv.conf.bak /etc/resolv.conf
		rm /etc/resolv.conf.bak
		echo "restart your web browser to apply the changes"
		;;

	update)
		echo "updating tunlr dns server"
		if [ $(ping -q -c 1 tunlr.net &>/dev/null; echo $?) -ne 0 ]; then
			echo "tunlr.net seems to be down. please try again later"
			exit 1
		fi
		rm /etc/tunlr/tunlr_dns
		for srv in $(wget http://tunlr.net/get-started/ -q -O - | grep -Eo '\<[[:digit:]]{1,3}(\.[[:digit:]]{1,3}){3}\>'); do
			echo "adding $srv"
			echo "nameserver $srv" >> /etc/tunlr/tunlr_dns
		done
		;;

	*)
		echo "usage: $0 {start|stop|update}"
		;;
esac
exit 0

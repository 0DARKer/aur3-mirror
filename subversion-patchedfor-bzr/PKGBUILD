# $Id: PKGBUILD,v 1.81 2007/09/29 15:45:22 andyrtr Exp $
# Contributer: Jason Chu <jason@archlinux.org>
# Maintainer: Jason Chu <jason@archlinux.org>
pkgname=subversion-patchedfor-bzr
pkgver=1.4.5
pkgrel=2
pkgdesc="Replacement for CVS, another versioning system (svn)"
arch=(i686 x86_64)
license=('custom')
depends=('neon>=0.27.0-2' 'apr-util>=1.2.7-2')
makedepends=('heimdal>=1.0.1' 'db>=4.6' 'apache' 'python>=2.5'
             'perl>=5.8.8-1' 'swig=1.3.27' 'jdk' 'jre' 'ruby'
             'autoconf')
source=(http://svn.collab.net/tarballs/subversion-${pkgver}.tar.gz
        svnserve svn svnserve.conf subversion-neon.patch
        http://samba.org/~metze/subversion-1.4.0-metze-python-bindings.patch)
backup=('etc/xinetd.d/svn' 'etc/conf.d/svnserve')
url="http://subversion.tigris.org/"
provides=('svn' 'subversion')
conflicts=('subversion')
#options=('!makeflags')
md5sums=('3caf1d93e13ed09d76c42eff0f52dfaf'
         '22d452e0de5168d56c438d99c7ad72fa'
         'a0db6dd43af33952739b6ec089852630'
         'c0001ceb13418a065915e27dfdf592c0'
         'e9579f8b1f88ce91d9f5f5df542339bc'
         'ae02cb1b6083a5e7c51a7e18aa5b5f7c')

build() {
   local pkgname=subversion
   cd $startdir/src/${pkgname}-${pkgver}

   [ -z "${J2REDIR}" ] && . /etc/profile.d/jre.sh
   [ -z "${J2SDKDIR}" ] && . /etc/profile.d/jdk.sh

#   export LDFLAGS="-L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_client/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_delta/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_fs/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_fs_base/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_fs_fs/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_repos/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_ra_svn/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_ra/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_ra_dav/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_ra_local/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_subr/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_diff/.libs \
#        -L$startdir/src/${pkgname}-${pkgver}/${pkgname}/libsvn_wc/.libs"

   patch -Np1 -i $startdir/src/subversion-neon.patch || return 1
   patch -p1 -i $startdir/src/subversion-1.4.0-metze-python-bindings.patch || return 1
   aclocal -I build/ac-macros
   autoconf
   #sed -r -i~ 's/make -f autogen-standalone.mk autogen-swig/make -B -f autogen-standalone.mk autogen-swig/' autogen.sh
   ./autogen.sh --release || return 1
   ./configure --prefix=/usr --with-apr=/usr --with-apr-util=/usr --with-zlib --with-neon=/usr --with-apxs --enable-javahl --with-jdk=/opt/java
   #sed -i 's|-ldb-4.2|-ldb-4.4|' Makefile
   #make DESTDIR=$startdir/pkg || return 1
   msg "make"
   make DESTDIR=$startdir/pkg ||Â return 1
   (make external-all && make LT_LDFLAGS="-L$Fdestdir/usr/lib" local-all ) || return 1
   msg "make check-swig-py"
   make DESTDIR=$startdir/pkg check-swig-py || return 1

   msg "make install"
   export LD_LIBRARY_PATH=$startdir/pkg/usr/lib:$LD_LIBRARY_PATH
   make DESTDIR=$startdir/pkg install || return 1

   msg "make swig-py"
   make DESTDIR=$startdir/pkg swig-py || return 1
   msg "make DESTDIR=$startdir/pkg install-swig-py"
   make DESTDIR=$startdir/pkg install-swig-py || return 1

   mkdir -p $startdir/pkg/usr/lib/python2.5
   mv $startdir/pkg/usr/lib/svn-python/ $startdir/pkg/usr/lib/python2.5/site-packages


   mkdir -p $startdir/pkg/usr/share/subversion
   install -d -m 755 tools/hook-scripts $startdir/pkg/usr/share/subversion/
   rm -f $startdir/pkg/usr/share/subversion/hook-scripts/*.in

   make DESTDIR=$startdir/pkg swig-pl || return 1
   make install-swig-pl DESTDIR=$startdir/pkg || return 1
   
# TODO: FIXME: is it necessary to move site_perl/5.7.8 to current, pacman complaint
# for me if I didn't
   /bin/rm -r $startdir/pkg/usr/lib/perl5/?.?.?
   /bin/mv $startdir/pkg/usr/lib/perl5/site_perl/?.?.? $startdir/pkg/usr/lib/perl5/site_perl/current

   make DESTDIR=$startdir/pkg swig-rb || return 1
   make install-swig-rb DESTDIR=$startdir/pkg  || return 1

   make DESTDIR=$startdir/pkg javahl || return 1
   make DESTDIR=$startdir/pkg install-javahl || return 1

   mkdir -p $startdir/pkg/etc/rc.d
   mkdir -p $startdir/pkg/etc/xinetd.d
   mkdir -p $startdir/pkg/etc/conf.d

   install -m 755 $startdir/src/svnserve $startdir/pkg/etc/rc.d
   install -m 644 $startdir/src/svn $startdir/pkg/etc/xinetd.d
   install -m 644 $startdir/src/svnserve.conf $startdir/pkg/etc/conf.d/svnserve
   install -m 755 $startdir/src/subversion-$pkgver/contrib/client-side/svnmerge.py $startdir/pkg/usr/bin/svnmerge
#libtoolslay not all because of kdesdk
   find ${startdir}/pkg/usr/lib/apache -name '*.la' -exec rm {} \;
   find ${startdir}/pkg/usr/lib/ruby -name '*.la' -exec rm {} \;
   find ${startdir}/pkg/usr/lib/python2.5 -name '*.la' -exec rm {} \;
}

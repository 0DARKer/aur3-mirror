# Maintainer: Mihail Strashun <m.strashun@gmail.com> aka Volfram
pkgname=dmd2-complete
pkgver=2.052
pkgrel=1
pkgdesc="The Digital Mars D compiler & Standard Library (D2 version)"
arch=('i686' 'x86_64')
url="http://www.digitalmars.com/d/2.0/"
source=(http://ftp.digitalmars.com/dmd.$pkgver.zip dmd.conf)
md5sums=('133e80a929eaeddc9fe8964bbfa4cc4f' '6a4c1a3deac6f0f20a564dcf5a42f1ae')
provides=('d-compiler='$pkgver 'dmd2='$pkgver 'libphobos2='$pkgver)
license=('custom')
options=('!strip' 'docs')
conflicts=('libtango' 'dmd2' 'dmd2-bin')

if [ $CARCH = 'x86_64' ]
then
	depends=('gcc-multilib')
	archstr="64"
fi

if [ $CARCH = 'i686' ]
then 
	depends=('libstdc++5')
	archstr="32"
fi

build() {
   # Build and install dmd binary
   cd $srcdir/dmd2/src/dmd || return 1
   make -f linux.mak || return 1
   install -Dm755 ./dmd $pkgdir/usr/bin/dmd || return 

   oldpath=$PATH
   export PATH=$PATH:`pwd`

   # Copy additional tools
   install -Dm755 $srcdir/dmd2/linux/bin/dumpobj $pkgdir/usr/bin/dumpobj || return 1
   install -Dm755 $srcdir/dmd2/linux/bin/obj2asm $pkgdir/usr/bin/obj2asm || return 1
   install -Dm755 $srcdir/dmd2/linux/bin/rdmd $pkgdir/usr/bin/rdmd || return 1
   install -Dm644 $startdir/dmd.conf $pkgdir/etc/dmd.conf || return 1

   # Copy the license
   install -Dm644 $srcdir/dmd2/license.txt $pkgdir/usr/share/licenses/dmd/COPYING || return 1

   # Copy man files   
   for x in $srcdir/dmd2/man/man1/*.1; do
       install -Dm644 $x "$pkgdir/usr/man/man1/$(basename $x)"
   done

   for x in $srcdir/dmd2/man/man1/*.5; do
       install -Dm644 $x "$pkgdir/usr/man/man5/$(basename $x)"
   done

   # Copy documentation
   mkdir -p $pkgdir/usr/share/doc/d/phobos
   docs="$srcdir/dmd2/html/d"
   for x in $(find $docs/*.html $docs/*.gif $docs/*.ico $docs/*.jpg $docs/*.css); do
       install -Dm644 $x "$pkgdir/usr/share/doc/d/$(basename $x)"
   done

   for x in $(find $docs/phobos/*.html $docs/phobos/*.gif $docs/phobos/*.css); do
       install -Dm644 $x "$pkgdir/usr/share/doc/d/phobos/$(basename $x)"
   done

   # Standard library and runtime

# Build and install druntime
	cd $srcdir/dmd2/src/druntime || return 1
	make -f posix.mak || return 1
	install -Dm644 ./lib/libdruntime.a $pkgdir/usr/lib/libdruntime.a || return 1

# Build and install standard library binary
	cd $srcdir/dmd2/src/phobos || return 1
	make -f posix.mak || return 1
	install ./generated/linux/release/$archstr/libphobos2.a $pkgdir/usr/lib/libphobos2.a || return 1

# Install standard library *.d modules
	mkdir -p $pkgdir/usr/include/d
	cd $srcdir/dmd2/src/phobos
	cp -Rf std $pkgdir/usr/include/d || return 1
	cp -Rf etc $pkgdir/usr/include/d || return 1
	cp -f {crc32,phobos,unittest}.d $pkgdir/usr/include/d || return 1

# Install druntime *.d modules
	mkdir -p $pkgdir/usr/include/d/druntime
	cd $srcdir/dmd2/src/druntime/
	cp -Rf import $pkgdir/usr/include/d/druntime || return 1

# Copy license
	install -Dm644 $srcdir/dmd2/src/phobos/phoboslicense.txt $pkgdir/usr/share/licenses/$pkgname/LICENSE || return 1

	export PATH=$oldpath
}

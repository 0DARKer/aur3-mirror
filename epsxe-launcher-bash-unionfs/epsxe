#!/bin/bash

OLD_DIR=${PWD}
RO_DIR='/opt/epsxe'
RW_DIR=${HOME}/.epsxe
TMP_DIR=$(mktemp -d)

echo 'Checking existence of .epsxe directory..'
if [[ ! -d "${RW_DIR}" ]]; then
    mkdir -v "${RW_DIR}"
fi

echo 'Creating unionfs mount..'
unionfs -o uid=$(id -u) -o cow "${RW_DIR}"=RW:"${RO_DIR}"=RO "${TMP_DIR}"

echo 'Starting ePSXe..'
cd "${TMP_DIR}"
./epsxe

echo 'Cleaning up..'
cd "${OLD_DIR}"
while [[ -e "${TMP_DIR}" ]]; do
    fusermount -u "${TMP_DIR}"
    rmdir -v "${TMP_DIR}"
    sleep 1;
done

echo 'Done.'

# Maintainer: Yann Kaiser <kaiser.yann@gmail.com>
pkgname=nightsky-game
pkgver=20111207
_pkgver=120720110
pkgrel=1
pkgdesc="A 2D platformer in which you control a ball"
arch=('i686' 'x86_64')
url="http://www.nicalis.com/nightsky/"
license=('custom')
depends=('libgl' 'libvorbis' 'mesa' 'zlib')
if test "$CARCH" == x86_64; then
  depends=('lib32-libgl' 'lib32-gcc-libs' 'lib32-glibc'
           'lib32-libvorbis' 'lib32-mesa' 'lib32-zlib')
fi
makedepends=()
source=('nightsky-game.sh' 'nightsky-game.desktop')
md5sums=('6dc6459dbed8d42396320b4560c3605d'
         'a2abc9a74a21b99574bf51ad5f8b6f1b')
_archive_name="NightSkyHD_Linux"
_archive_md5="d0ba44f4f6f21d7d6e02e0de176b66ef"
_archive="${_archive_name}.zip"

build() {
  cd ${srcdir}

  if [ ! -f ${_nightskyarchivelocation}${_archive} ]; then
	  if [ ! -f ${_archive} ] && [ -n "${_humblebundle4key}" ]; then
		rm -f ${_archive}* index.html\?key\=${_humblebundle4key}*
		wget http://www.humblebundle.com/?key=${_humblebundle4key}
		wget $(cat index.html\?key\=${_humblebundle4key} | grep "${_archive}" | cut -d "'" -f 10)
		mv ${_archive}* ${_archive}
	  elif [ -z "${_humblebundle4key}" ]; then
		echo You can automate the download of the archive using the _humblebundle4key bash variable.
		echo Just add \'export _humblebundle4key\=\<Your key here\>\' to \.bashrc
		echo
		echo Otherwise please just place ${_archive} into $(pwd)/
		echo Press Enter to continue
		read -a _unused
	  fi
  fi

  if [ ! -f ${_nightskyarchivelocation}${_archive} ]; then
    echo "${_nightskyarchivelocation}${_archive} not found!"
    return 1
  fi

  if ! echo "${_archive_md5}  ${_nightskyarchivelocation}${_archive}" | md5sum -c --quiet; then
    echo "Invalid checksum for ${_nightskyarchivelocation}${_archive}"
    return 1
  fi

  bsdtar -xf ${_nightskyarchivelocation}${_archive}

  # Today's learn2package!
  rm -R __MACOSX
  chmod -R go-w ${_archive_name}
  find ${_archive_name} ! -type d -exec chmod a-x {} \;
  find ${_archive_name} -name '.DS_Store' -delete;
  chmod -R a+x ${_archive_name}/NightSkyHD ${_archive_name}/lib/

  rm ${srcdir}/${_archive_name}/lib/lib{vorbis,vorbisfile,ogg}.so*
  cp ${srcdir}/${pkgname}.sh ${srcdir}/${_archive_name}/

  mkdir -p ${pkgdir}/opt/ ${pkgdir}/usr/bin/ \
    ${pkgdir}/usr/share/applications
  cp -r ${srcdir}/${_archive_name} ${pkgdir}/opt/NightSkyHD
  cp ${srcdir}/${pkgname}.desktop ${pkgdir}/usr/share/applications/
  ln -s /opt/NightSkyHD/${pkgname}.sh \
    ${pkgdir}/usr/bin/${pkgname}
  chmod a+r ${pkgdir}/usr/share/applications/${pkgname}.desktop
  chmod a+x ${pkgdir}/opt/NightSkyHD/${pkgname}.sh
}

# vim: et ts=2 sw=2 sts=2


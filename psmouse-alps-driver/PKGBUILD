# Mantainer: Ivan de Jesús Pompa García <ivan.pompa@gmx.com>
# Contributor: Paolo Stivanin <admin@polslinux.it>
#              Tai Chi Minh Ralph Eastwood <tcmreastwood@gmail.com>
#              Hexchain Tong <i@hexchain.org>
#			 	figue ???


pkgname=('psmouse-alps-driver')
_patchver=1.1
_dkmsname='psmouse-alps-dst'
pkgver=${_patchver}
pkgrel=4
epoch=2
pkgdesc='psmouse kernel module with support for alpsv1-alpsv6 touchpad'
arch=('i686' 'x86_64')
url='http://www.dahetral.com/'
license=('GPL2')
depends=('dkms')
makedepends=('linux-headers')
conflicts=('psmouse-alps')
provides=('psmouse-alps')
options=('!strip')
install=psmouse.install
source=(
    'http://www.dahetral.com/public-download/psmouse-alps-dst-${_patchver}.tbz/at_download/file'
)

md5sums=(
    '229a765efd5e74e5b3053b4f970bc754'
)

build() {
	if [ "`uname -r | cut -d . -f 2`" = "7" ]; then
		echo "Patching for a 3.7 kernel..."
		# Many thanks to figue for the quick patch ;)
		sed -e 's/input_mt_init_slots(dev, 2);/input_mt_init_slots(dev, 2, 0);/g' \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/synaptics.c \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/alps.c \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/elantech.c \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/sentelic.c
		sed -e 's/input_mt_init_slots(dev1, 2);/input_mt_init_slots(dev1, 2, 0);/g' \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/synaptics.c \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/alps.c
		sed -e 's/input_mt_init_slots(dev, ETP_MAX_FINGERS);/input_mt_init_slots(dev, ETP_MAX_FINGERS, 0);/g' \
		  -i ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/elantech.c
	fi

    mkdir -p ${pkgdir}/usr/src/${_dkmsname}-${_patchver}/src
    cp -RL ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/src/* ${pkgdir}/usr/src/${_dkmsname}-${_patchver}/src
    cp -RL ${srcdir}/usr/src/psmouse-alps-dst-${_patchver}/dkms.conf ${pkgdir}/usr/src/${_dkmsname}-${_patchver}
}

# Mantainer: Ivan de Jesús Pompa García <ivan.pompa@gmx.com>
# Contributor: Paolo Stivanin <admin@polslinux.it>
#              Tai Chi Minh Ralph Eastwood <tcmreastwood@gmail.com>
#              Hexchain Tong <i@hexchain.org>

pkgname=('psmouse-alps-driver')
_patchver='1.3'
_dkmsname='psmouse-alps'
pkgver=${_patchver}
pkgrel=1
epoch=2
pkgdesc='psmouse kernel module with support for alpsv1-alpsv6 touchpad'
arch=('i686' 'x86_64')
url='http://www.dahetral.com/'
license=('GPL2')
depends=('dkms')
makedepends=('linux-headers')
conflicts=('psmouse-alps')
provides=('psmouse-alps')
options=('!strip')
install=psmouse.install
source=(
    'http://www.dahetral.com/public-download/psmouse-alps-${_patchver}.tbz/at_download/file'
)

md5sums=(
    '0edd7e6b3816303b95a65ef28e3cee4d'
)

build() {
	_K30=`uname -r | grep 3.0 || true`
	_K37=`uname -r | grep 3.7 || true`

	sed -e 's/{ { 0x73, 0x03, 0x50 }, 0x0d, ALPS_PROTO_V5, 0xc8, 0xc8, 0 },/ \
                        { { 0x73, 0x03, 0x50 }, 0x0d, ALPS_PROTO_V5, 0xc8, 0xc8, 0 }, \
                        { { 0x73, 0x03, 0x50 }, 0x02, ALPS_PROTO_V5, 0xc8, 0xc8, 0 },/g' \
                 -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/alps.c

	if [ "${_K30}" != "" ]; then
		echo "Patching for a 3.0 LTS kernel..."
		sed -e 's/BTN_TOOL_QUINTTAP/0x148/g' \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/synaptics.c
	fi

	if [ "${_K37}" != "" ]; then
		echo "Patching for a 3.7 kernel..."
		# Many thanks to figue for the quick patch ;)
		sed -e 's/input_mt_init_slots(dev, 2);/input_mt_init_slots(dev, 2, 0);/g' \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/synaptics.c \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/alps.c \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/elantech.c \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/sentelic.c
		sed -e 's/input_mt_init_slots(dev1, 2);/input_mt_init_slots(dev1, 2, 0);/g' \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/synaptics.c \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/alps.c
		sed -e 's/input_mt_init_slots(dev, ETP_MAX_FINGERS);/input_mt_init_slots(dev, ETP_MAX_FINGERS, 0);/g' \
		  -i ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/elantech.c
	fi

    mkdir -p ${pkgdir}/usr/src/${_dkmsname}-${_patchver}/src
    cp -RL ${srcdir}/usr/src/${_dkmsname}-${_patchver}/src/* ${pkgdir}/usr/src/${_dkmsname}-${_patchver}/src
    cp -RL ${srcdir}/usr/src/${_dkmsname}-${_patchver}/dkms.conf ${pkgdir}/usr/src/${_dkmsname}-${_patchver}
}

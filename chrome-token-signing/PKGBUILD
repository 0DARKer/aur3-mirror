# Maintainer: Your Name <youremail@domain.com>
pkgname=chrome-token-signing
pkgver=3.9.0.27
pkgrel=1
pkgdesc="Estonian ID Card signing for Chrome. Chrome extension and native messaging client."
arch=('x86_64' 'i686')
url="http://www.id.ee/"
license=('LGPL2.1')
depends=('gtkmm3' 'pcsclite' 'ccid')
source=("http://ftp.id.eesti.ee/pub/id/beeta-draiverid/${pkgname}_${pkgver}-ubuntu-14-04.tar.gz")
sha256sums=('21454d330e01eb420c0e5d7c616f0d6ad53a440217f950285f3a543aa865ed76')

build() {
	cd "$srcdir/$pkgname-$pkgver"
	rm json/jsonxx.o
	make
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	install -Dm755 out/$pkgname "$pkgdir/usr/bin/$pkgname"
	install -Dm644 ee.ria.esteid.json "$pkgdir/usr/share/chrome-token-signing/native-messaging-hosts/ee.ria.esteid.json"
	install -Dm644 esteid_policy.json "$pkgdir/usr/share/chrome-token-signing/policies/managed/esteid_policy.json"
	install -Dm644 chrome-token-signing.crx "$pkgdir/usr/share/chrome-token-signing/chrome-token-signing.crx"
	install -Dm644 update.xml "$pkgdir/usr/share/chrome-token-signing/update.xml"
	mkdir -p $pkgdir/etc/{chrome,chromium,chromium-browser}/native-messaging-hosts
	mkdir -p $pkgdir/etc/{chrome,chromium,chromium-browser}/policies/managed
	ln -sf "/usr/share/chrome-token-signing/native-messaging-hosts/ee.ria.esteid.json" "$pkgdir/etc/chrome/native-messaging-hosts/ee.ria.esteid.json" 
	ln -sf "/usr/share/chrome-token-signing/policies/managed/esteid_policy.json" "$pkgdir/etc/chrome/policies/managed/esteid_policy.json"
	ln -sf "/usr/share/chrome-token-signing/native-messaging-hosts/ee.ria.esteid.json" "$pkgdir/etc/chromium/native-messaging-hosts/ee.ria.esteid.json" 
	ln -sf "/usr/share/chrome-token-signing/policies/managed/esteid_policy.json" "$pkgdir/etc/chromium/policies/managed/esteid_policy.json"
	ln -sf "/usr/share/chrome-token-signing/native-messaging-hosts/ee.ria.esteid.json" "$pkgdir/etc/chromium-browser/native-messaging-hosts/ee.ria.esteid.json" 
	ln -sf "/usr/share/chrome-token-signing/policies/managed/esteid_policy.json" "$pkgdir/etc/chromium-browser/policies/managed/esteid_policy.json"
}
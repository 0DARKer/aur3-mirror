# $Id$
# Maintainer: LM Wang <xia0er@gmail.com>
# Contributor: Jan de Groot <jgc@archlinux.org>
# Contributor: Douglas Soares de Andrade <dsa@aur.archlinux.org>
# Contributor: Angel 'angvp' Velasquez <angvp[at]archlinux.com.ve> 

#pkgbase=python-numpy-openblas
#pkgname=('python2-numpy-openblas' 'python-numpy-openblas')
pkgname=python2-numpy-openblas
pkgver=1.7.1
pkgrel=4
pkgdesc="Scientific tools for Python - built with openblas"
arch=('i686' 'x86_64')
license=('custom')
url="http://numpy.scipy.org/"
source=(blas_opt.patch
        site.cfg
        http://downloads.sourceforge.net/numpy/numpy-${pkgver}.tar.gz) 

build() {

  #patch to make numpy utilize optimized matrix dot
  #credit sftrytry: https://aur.archlinux.org/packages/openblas/
  patch -p1 < ${startdir}/blas_opt.patch || return 1

  cd "${srcdir}"

  #make sure _dotblas.so gets built, ref:
  #https://github.com/jtriley/StarCluster/issues/11#issuecomment-8285517
  sed -i -e '/NO_ATLAS_INFO/,+1d' numpy-${pkgver}/numpy/core/setup.py
}

package() {
  package_python2-numpy-openblas
}

package_python2-numpy-openblas() {
  depends=('lapack' 'python2' 'openblas')
  makedepends=('python2-distribute' 'gcc-fortran' 'python2-nose')
  optdepends=('python2-nose: testsuite')
  provides=('python2-numpy=${pkgver}')
  replaces=('python2-numpy')
  conflicts=('python2-numpy')

  export Atlas=None
  export LDFLAGS="$LDFLAGS -shared"

  cd "${srcdir}"
  cp -a numpy-${pkgver} numpy-py2-${pkgver}

  echo "Building Python2"
  cd "${srcdir}/numpy-py2-${pkgver}"

  python2 setup.py config_fc --fcompiler=gnu95 config
  python2 setup.py config_fc --fcompiler=gnu95 build

  python2 setup.py config_fc --fcompiler=gnu95 install --prefix=/usr --root="${pkgdir}" --optimize=1

  install -m755 -d "${pkgdir}/usr/share/licenses/python2-numpy"
  #install -m644 LICENSE.txt "${pkgdir}/usr/share/licenses/python2-numpy/"

  sed -i -e "s|#![ ]*/usr/bin/python$|#!/usr/bin/python2|" \
         -e "s|#![ ]*/usr/bin/env python$|#!/usr/bin/env python2|" \
         -e "s|#![ ]*/bin/env python$|#!/usr/bin/env python2|" \
             $(find ${pkgdir} -name '*.py')
}

package_python-numpy-openblas() {
  depends=('lapack' 'python' 'openblas')
  makedepends=('python-distribute' 'gcc-fortran' 'python-nose')
  optdepends=('python-nose: testsuite')
  provides=('python3-numpy=${pkgver}' 'python-numpy=${pkgver}')
  replaces=('python3-numpy' 'python-numpy')
  conflicts=('python3-numpy' 'python-numpy')

  export Atlas=None
  export LDFLAGS="$LDFLAGS -shared"

  echo "Building Python3"
  cd "${srcdir}/numpy-${pkgver}"
  #python setup.py config_fc --fcompiler=gnu95 build

  python setup.py config_fc --fcompiler=gnu95 install --prefix=/usr --root="${pkgdir}" --optimize=1

  install -m755 -d "${pkgdir}/usr/share/licenses/python3-numpy"
  #install -m644 LICENSE.txt "${pkgdir}/usr/share/licenses/python3-numpy/"
}

md5sums=('7ea2a88f025d0cad137a5c782182471b'
         'ff76d6e4a1be23b866395773a0230ce6'
         '0ab72b3b83528a7ae79c6df9042d61c6')

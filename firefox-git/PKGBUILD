pkgname=firefox-git
pkgver=20120217
pkgrel=1
pkgdesc="Standalone web browser from mozilla.org, latest development version"
url="http://www.mozilla.org/projects/firefox/"
arch=('i686' 'x86_64')
license=('MPL' 'GPL' 'LGPL')
depends=('gtk2' 'gcc-libs' 'mozilla-common' 'nss>=3.12.10' 'libxt' 'libxrender'
         'hunspell' 'startup-notification' 'mime-types' 'dbus-glib' 'alsa-lib'
         'libevent' 'sqlite3>=3.7.4' 'libnotify' 'desktop-file-utils' 'libvpx'
         'lcms' 'libevent' 'libpng' 'cairo')
makedepends=(unzip zip pkg-config diffutils python2 wireless_tools yasm mesa autoconf2.13 gconf xorg-server-xvfb git)
source=(mozconfig
        firefox-git.desktop
        mozilla-firefox-1.0-lang.patch)

#install=firefox.install
_ffver="13.0a1"
#provides=("firefox=$_ffver")

_gitroot=https://github.com/doublec/mozilla-central.git
_gitname=mozilla-central

build(){
  cd $srcdir
  if [[ -d "$_gitname" ]]; then
    cd "$_gitname"
    git reset --hard
    git clean -dxf
    git pull 
  else
    git clone "$_gitroot" "$_gitname"
    cd "$_gitname"
  fi

  cp "$srcdir/mozconfig" .mozconfig
  patch -Np1 -i "$srcdir/mozilla-firefox-1.0-lang.patch"

  # Kill @PRE_RELEASE_SUFFIX@ from browser.xul because it
  # gets set to \177 for an unknown reason
  sed -i 's/@PRE_RELEASE_SUFFIX@//g' browser/base/content/browser.xul

  export LDFLAGS="-Wl,-rpath,/usr/lib/firefox-git -Wl,-Os,--sort-common,--hash-style=gnu,--as-needed"
  export PYTHON="/usr/bin/python2"
  make -j1 -f client.mk MOZ_MAKE_FLAGS="$MAKEFLAGS"
}
package(){
  cd "$srcdir/$_gitname"
  make -j1 -f client.mk DESTDIR="$pkgdir" install
  mv "$pkgdir/usr/bin/firefox" "$pkgdir/usr/bin/firefox-git"
  rm -r "$pkgdir"/usr/{include,lib/firefox-devel-$_ffver,share/idl}
  #for i in 16x16 32x32 48x48; do
  #  install -Dm644 browser/branding/nightly/default${i/x*/}.png "$pkgdir/usr/share/icons/hicolor/$i/apps/firefox-git.png"
  #done
  #install -Dm644 browser/branding/nightly/content/icon64.png "$pkgdir/usr/share/icons/hicolor/64x64/apps/firefox-git.png"
  #install -Dm644 browser/branding/nightly/mozicon128.png "$pkgdir/usr/share/icons/hicolor/128x128/apps/firefox-git.png"
  install -Dm644 "$srcdir/firefox-git.desktop" "$pkgdir/usr/share/applications/firefox-git.desktop"
}

md5sums=('5e844651b6c11f45370fdce9ba0e2599'
         '5b16c87eed1658d84b3e03ffd7a3b48d'
         'bd5db57c23c72a02a489592644f18995')

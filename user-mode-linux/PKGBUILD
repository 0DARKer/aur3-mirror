pkgname=user-mode-linux
_kernelname=-uml
pkgver=2.6.38.3
pkgrel=1
pkgdesc="Run multiple virtual Linux systems as applications within a normal Linux system"
arch=('i686' 'x86_64')
license=('GPL2')
source=(ftp://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$pkgver.tar.bz2 config)
md5sums=('d3071407a33a7bd2ffb47181f200f22c' 'c8e8a7717bddb8ec151b84f26abcc911')
depends=('glibc' 'uml_utilities')
makedepends=('libpcap')
url="http://user-mode-linux.sourceforge.net/"

build() {
  cd $srcdir/linux-$pkgver
  cp $srcdir/config ./.config

  if [ "${_kernelname}" != "" ]; then
    sed -i "s|CONFIG_LOCALVERSION=.*|CONFIG_LOCALVERSION=\"${_kernelname}\"|g" ./.config
  fi

  mkdir -p $pkgdir/lib/modules
  mkdir -p $pkgdir/usr/lib/uml

  LDFLAGS="" make -j1 oldconfig ARCH=um || return 1
  LDFLAGS="" make -j1 vmlinux modules ARCH=um || return 1
  make INSTALL_MOD_PATH=$pkgdir modules_install ARCH=um || return 1

  mv $pkgdir/lib/modules $pkgdir/usr/lib/uml/
  rm -rf $pkgdir/lib/

  mkdir -p $pkgdir/usr/bin
  cp vmlinux $pkgdir/usr/bin
}

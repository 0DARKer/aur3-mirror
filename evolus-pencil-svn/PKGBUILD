# Maintainer: Trương Xuân Tính <xuantinh@gmail.com>
pkgname=evolus-pencil-svn
pkgver=161
pkgrel=1
pkgdesc="Sketching and GUI prototyping tool"
arch=('i686' 'x86_64')
license=('GPL2')
url="http://code.google.com/p/evoluspencil/"
source=('evolus-pencil.desktop' 'evolus-pencil.sh')
md5sums=('cb8e722bfd76818c15b5cba4c2a7f002' '81e3b0102d9bedad5881628d5ccfa544')
depends=('xulrunner')
makedepends=(subversion)
provides=(evolus-pencil)
conflicts=(evolus-pencil)

_svntrunk=http://evoluspencil.googlecode.com/svn/trunk/
_svnmod=evolus-pencil

NAME="Pencil"
VERSION="1.1"
BUILD="0"
AUTHOR="Duong Thanh An (an.duong@evolus.vn) and Contributors"
XPINAME="Pencil-'$VERSION'-'$BUILD'-fx.xpi"
FXMINVER="3.0b3"
FXMAXVER="3.6.*"
XRMINVER="1.9"
XRMAXVER="1.9.2.*"

build() {
    cd "$srcdir"
    if [ -d $_svnmod/.svn ]; then
        (cd $_svnmod && svn up -r $pkgver)
    else
        svn co $_svntrunk -r $pkgver $_svnmod
    fi
    mkdir -p "$pkgdir/usr/lib/$pkgname/chrome/content"
    mkdir -p "$pkgdir/usr/lib/$pkgname/chrome/icons/default/"
    mkdir -p "$pkgdir/usr/share/pixmaps"
    install -Dm755 $srcdir/evolus-pencil.sh "$pkgdir/usr/lib/$pkgname/evolus-pencil.sh"
    install -Dm755 $_svnmod/Source/Icons/48.png "$pkgdir/usr/share/pixmaps/evolus-pencil.png"
    install -Dm755 $srcdir/evolus-pencil.desktop "$pkgdir/usr/share/applications/evolus-pencil.desktop"
    cp -R $srcdir/$_svnmod/Source/* "$pkgdir/usr/lib/$pkgname/chrome/content"
    cp $srcdir/$_svnmod/Source/Icons/pencil.ico "$pkgdir/usr/lib/$pkgname/chrome/icons/default/pencilMainWindow.ico"
    cp $srcdir/$_svnmod/Source/Icons/pencil.xpm "$pkgdir/usr/lib/$pkgname/chrome/icons/default/pencilMainWindow.xpm"
    cp -R $srcdir/$_svnmod/Build/XULRunner/* "$pkgdir/usr/lib/$pkgname/"
    find "$pkgdir/usr/lib/$pkgname" -name .svn | xargs -i rm -Rf {}

    WindowXUL="$pkgdir/usr/lib/$pkgname/chrome/content/UI/Window.xul"
    echo "Processing $WindowXUL..."
    sed "s/%version%/$VERSION/g;s/%author%/$AUTHOR/g;s/%name%/$NAME/g;s/%build%/$BUILD/g;s/%xpiname%/$XPINAME/g;s/%fxminver%/$FXMINVER/g;s/%fxmaxver%/$FXMAXVER/g;s/%xrminver%/$XRMINVER/g;s/%xrmaxver%/$XRMAXVER/g;s/%xpihash%/$XPIHASH/g" < $WindowXUL > temp
    mv -f temp "$WindowXUL"

    AboutDialogXUL="$pkgdir/usr/lib/$pkgname/chrome/content/UI/AboutDialog.xul"
    echo "Processing $WindowXUL..."
    sed "s/%version%/$VERSION/g;s/%author%/$AUTHOR/g;s/%name%/$NAME/g;s/%build%/$BUILD/g;s/%xpiname%/$XPINAME/g;s/%fxminver%/$FXMINVER/g;s/%fxmaxver%/$FXMAXVER/g;s/%xrminver%/$XRMINVER/g;s/%xrmaxver%/$XRMAXVER/g;s/%xpihash%/$XPIHASH/g" < $AboutDialogXUL > temp
    mv -f temp "$AboutDialogXUL"

    PencilJS="$pkgdir/usr/lib/$pkgname/chrome/content/Common/Pencil.js"
    echo "Processing $PencilJS..."
    sed "s/%version%/$VERSION/g;s/%author%/$AUTHOR/g;s/%name%/$NAME/g;s/%build%/$BUILD/g;s/%xpiname%/$XPINAME/g;s/%fxminver%/$FXMINVER/g;s/%fxmaxver%/$FXMAXVER/g;s/%xrminver%/$XRMINVER/g;s/%xrmaxver%/$XRMAXVER/g;s/%xpihash%/$XPIHASH/g" < $PencilJS > temp
    mv -f temp "$PencilJS"

    AppIni="$pkgdir/usr/lib/$pkgname/application.ini"
    echo "Processing $AppIni..."
    sed "s/%version%/$VERSION/g;s/%author%/$AUTHOR/g;s/%name%/$NAME/g;s/%build%/$BUILD/g;s/%xpiname%/$XPINAME/g;s/%fxminver%/$FXMINVER/g;s/%fxmaxver%/$FXMAXVER/g;s/%xrminver%/$XRMINVER/g;s/%xrmaxver%/$XRMAXVER/g;s/%xpihash%/$XPIHASH/g" < $AppIni > temp
    mv -f temp "$AppIni"
}

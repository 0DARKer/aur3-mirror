# Maintainer: Cdh <chrisdhaag@googlemail.com>

pkgname=mesa-full-i915g
pkgver=20110730
_realver=7.12
pkgrel=1
pkgdesc="Full Mesa 3D graphics library with all its components, built from the git master branch (mesa 7.11). Compiles mesa for i915g (gallium). For classic mesa see mesa-full-i915"
arch=(i686 x86_64)
url="http://mesa3d.org/"
license=('LGPL')
depends=('libdrm-git' 'dri2proto-git' 'glproto-git' 'libxxf86vm' 'libxdamage' 'expat>=2.0.1' 'libxmu' 'talloc' 'llvm')
makedepends=('pkgconfig' 'imake' 'xorg-server-devel')
optdepends=('llvm: "configure" tests for its presence and compiles with some additional "-D" macros if found')
provides=("libgl=${_realver}" "mesa=${_realver}" "freeglut=${_realver}" "glut=${_realver}" "intel-dri=${_realver}")
replaces=('libgl' 'mesa' 'freeglut' 'glut' 'intel-dri')
conflicts=('libgl' 'mesa' 'freeglut' 'glut' 'intel-dri' 'mesa-full-i915')

_gitroot="git://anongit.freedesktop.org/git/mesa/mesa"
_gitname="mesa"

build() {
   msg "Connecting to git.freedesktop.org GIT server...."

   if [ -d $startdir/src/$_gitname ] ; then
      cd $_gitname && git pull origin
      msg "The local files are updated."
   else
      git clone $_gitroot
   fi

   msg "GIT checkout done or server timeout"
   msg "Starting make..."

   rm -rf $startdir/src/$_gitname-build
   cp -rH $startdir/src/$_gitname $startdir/src/$_gitname-build
   cd ${srcdir}/${_gitname}-build

   cd "${startdir}/src/mesa-build"
   ./autogen.sh --prefix=/usr \
   --with-dri-drivers=i915 \
   --with-gallium-drivers=i915 \
   --with-dri-driverdir=/usr/lib/xorg/modules/dri \
   --enable-texture-float \
   --enable-gles1 \
   --enable-gles2 \
   --enable-openvg \
   --enable-osmesa \
   --enable-egl \
   --enable-xorg \
   --enable-xa \
   --enable-xvmc \
   --enable-vdpau \
   --enable-gallium-egl \
   --enable-xcb \
   --enable-glx-tls \
   --enable-glu \
   --enable-glw \
   --enable-motif \
   --enable-gallium-llvm \
   --enable-shared-glapi \
   --enable-gbm \
   --enable-gallium-gbm || return 1

# if you encounter problems try disabling these three options
# (--enable-shared-glapi is marked as EXPERIMENTAL)
#   --enable-shared-glapi \
#   --enable-gbm \
#   --enable-gallium-gbm \

   make || return 1
   make DESTDIR="${pkgdir}" install || return 1

   install -m755 -d "${pkgdir}/usr/lib/xorg/modules/extensions"
   ln -sf libglx.xorg ${pkgdir}/usr/lib/xorg/modules/extensions/libglx.so || return 1
}

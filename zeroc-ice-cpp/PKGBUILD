# Maintainer: Otto Allmendinger <otto.allmendinger@googlemail.com>

pkgname="zeroc-ice-cpp"
pkgver=3.4.2
pkgrel=1
pkgdesc="An object-oriented middleware that provides object-oriented Remote \
Procedure Call functionality. C++ only."
arch=("i686" "x86_64")
url="http://www.zeroc.com"
license=("GPL" "custom: ICE license")
makedepends=("apache-ant")
depends=('db' 'openssl' 'expat' 'mcpp')

source=(
    "http://www.zeroc.com/download/Ice/3.4/Ice-$pkgver.tar.gz" 
    "http://www.elpauer.org/stuff/FindZeroCIce.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceBox.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceCore.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceExecutables.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceGrid.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIcePatch2.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceSSL.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceStorm.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceUtil.cmake"
    "http://www.elpauer.org/stuff/FindZeroCIceXML.cmake"
    "ice.pth" 
    "ice.ini"
    "bdb5.patch"
    "python27.patch" 
    "gcc46.patch")

_makedir="${srcdir}/Ice-$pkgver"
_builddir="${srcdir}/Ice-$pkgver-build"
_datadir="${pkgdir}/usr/share/Ice-$pkgver"

if [ $CARCH = "i686" ]; then
    _libdir=${_builddir}/lib
else
    _libdir=${_builddir}/lib64
fi


_build_common() {
    cd ${_makedir}/cpp/src
    make OPTIMIZE=yes embedded_runpath_prefix=""
}

_package_cpp() {
    cd ${_makedir}/cpp
    make prefix=${_builddir} embedded_runpath_prefix="" install

    install -dm755 ${pkgdir}/usr/bin
    cp ${_builddir}/bin/* ${pkgdir}/usr/bin/

    install -dm755 ${pkgdir}/usr/lib
    cp ${_libdir}/* ${pkgdir}/usr/lib/

    install -dm755 ${pkgdir}/usr/include
    cp ${_builddir}/include/* ${pkgdir}/usr/include/

    mkdir -p ${pkgdir}/usr/share/cmake-2.8/Modules/
    cp ${srcdir}/*.cmake ${pkgdir}/usr/share/cmake-2.8/Modules/
}


_package_slice() {
    cp -r ${_builddir}/slice ${_datadir}/slice
    cp ${_builddir}/lib/ImportKey.class ${_datadir}
}



build() {
    patch "${_makedir}/cpp/include/Ice/Config.h" < "${startdir}/gcc46.patch"
    patch "${_makedir}/cpp/src/Freeze/MapI.cpp" < "${startdir}/bdb5.patch"
    patch "${_makedir}/py/config/Make.rules" < "${startdir}/python27.patch"

    _build_common
}

package() {
    rm -rf ${_builddir}
    mkdir ${_builddir}
    mkdir ${_libdir} -p
    mkdir ${_builddir}/bin
    mkdir -p ${_datadir}

    _package_cpp
    _package_slice

    install -Dm644 ${_makedir}/ICE_LICENSE \
                ${pkgdir}/usr/share/licenses/zeroc-ice/ICE_LICENSE
}
md5sums=('e97672eb4a63c6b8dd202d0773e19dc7'
         'daadc3f7d5f7530c9a4e295646734e4e'
         '7e9b2a07fb4452b44383adf5320d76bc'
         '858db28d735255f25b184cb153f98b46'
         'b259e9758462cb152583e44de2dc0b2c'
         '98b8250c34a9cb445b5126da349c8e99'
         '2b99b8c117567ba53d71144274ed7d73'
         '8cedb428bdcdd60f0227cdb9a34b2415'
         '8edf4ce47e81aa8ae34781aedb4a5d25'
         'ec803e9f6d6df0fa798b0040c3eed7c3'
         '2a978eef6e05f7ef7f4f59859d6c5a33'
         '5e1e1befd5cbd5262ec47770f591bd14'
         'e8092ad772cb0e68c75353fd7c8b09e6'
         '44f0ea80b2fffcad7db20dc32cc5b89b'
         '11d0f1074153e1d785b92671046385cf'
         'f81604764d02eda29ae471f6f48ffc21')

# Maintainer: ZDragon

pkgname=blocks-that-matter
pkgver=1.0.0.6
pkgrel=2
pkgdesc="Platformer with puzzle elements that form a mix of Tetris and Minecraft."
url="http://www.swingswingsubmarine.com/games/blocks-that-matter/"
license=('custom: "commercial"')
groups=('humblevoxatronbundle' 'humblebundles')
arch=('i686' 'x86_64')
[ "${CARCH}" = "x86_64" ] && depends=('lib32-libgl')
[ "${CARCH}" = "i686" ] && depends=('libgl')
[ "${CARCH}" = "x86_64" ] && optdepends=('lib32-alsa-lib: sound support' 'lib32-openal: sound support')
[ "${CARCH}" = "i686" ] && optdepends=('alsa-lib: sound support' 'openal: sound support')
options=(!strip)
source=("${pkgname}.desktop" "btm-exec" "blocks-matter-icon.png")
md5sums=('cf3f83f57176d28c230bad537d730d00'
     '211b9ca2c6773f22702af724987d0b57'
     '278f06f7d43f704818b3a3ac8bcb3e9c')
_gamepkg="blocks-matter_${pkgver}_all.tar.gz"

build() {
   cd "${srcdir}"
   msg "You need a full copy of this game in order to install it"
   msg "Searching for ${_gamepkg} in dir: $(readlink -f `pwd`/..)"
   if [[ -f "../${_gamepkg}" ]]; then
       msg "Found game package, installing..."
       ln -fs "../${_gamepkg}" .
   elif [ -n "${_humblevoxatronkey}" ]; then
       msg "Game package not found, trying to download..."
       rm -f index.html\?key\=${_humblevoxatronkey}*
       wget http://www.humblebundle.com/?key=${_humblevoxatronkey}
       wget $(cat index.html\?key\=${_humblevoxatronkey} | grep "${_gamepkg}" | cut -d "'" -f 10)
       mv ${_gamepkg}* ${_gamepkg}
   else
       msg "Game package not found and download failed."
       msg "You can add \'export _humblevoxatronkey\=\<Your key here\>\' to \.bashrc if you want automated download ability."
       error "Please type absolute path to ${_gamepkg} (/home/joe):"
       read pkgpath
       if [[ -f "${pkgpath}/${_gamepkg}" ]]; then
           msg "Found game package, installing..."
           ln -fs "${pkgpath}/${_gamepkg}" .
       else
           error "Unable to find game package."
           return 1
       fi
   fi
   tar zxvf ${_gamepkg}
   install -d "${pkgdir}/opt/${pkgname}"
   cp -R "${srcdir}"/BlocksThatMatter.Full.Linux.${pkgver}/* "${pkgdir}/opt/${pkgname}/"
   #Use system-wide OpenAL library instead of the provided lib versions
   rm "${pkgdir}/opt/${pkgname}/libopenal64.so"
   rm "${pkgdir}/opt/${pkgname}/libopenal.so"
   chmod -R +x "${pkgdir}/opt/${pkgname}/BTM_lib"
}

package(){
  cd "${srcdir}"
  # create Launcher
  install -d "${pkgdir}/usr/bin/"
  install -D -m755 "${srcdir}/btm-exec" "${pkgdir}/usr/bin/${pkgname}"
  # Install Desktop File and Icon
  install -D -m644 "${srcdir}/${pkgname}.desktop" \
        "${pkgdir}/usr/share/applications/${pkgname}.desktop"
  install -D -m644 "${srcdir}/blocks-matter-icon.png" \
        "${pkgdir}/usr/share/icons/${pkgname}-icon.png"
}


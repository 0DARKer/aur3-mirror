#Maintainer: Alex Brinister (alex_brinister@yahoo.com)
pkgname=gcc-powerpc-wrs-vxworks
pkgver=4.8.0
pkgrel=3
pkgdesc="GCC modded for VxWorks 6.3"
arch=('i686' 'x86_64')
url="http://firstforge.wpi.edu/sf/projects/c--11_toochain"
license=('GPL')
provides=('gcc-powerpc-wrs-vxworks')
conflicts=('vxworks-gcc-toolchain-bin')
depends=('wrs-vxworks-headers' 'binutils-powerpc-wrs-vxworks')
options=('!strip' '!libtool' '!zipman' '!buildflags' '!makeflags')
source=('http://ftp.gnu.org/gnu/gcc/gcc-4.8.0/gcc-4.8.0.tar.bz2'
		'patch-vxworks-mkdir-for-libgcov.patch')
sha512sums=('8a59f1a67e557eb719961a217bdb6a05b4b3abfc792f4bddee536c46fc3cc8472126e0f7531fa473acfce525a59bbd581ade97d068caf7308dfb2296f8861826'
            'b9fb647e6b1ffca0e409a47c9fa525d28a9f55ee76358277fde777f666e16bfbdceca1d74201407dc3ac5f589f66194a6ad470ead14d43c230b22398400d411a')
_gcc_name="gcc-$pkgver"

build() {
	cd $srcdir
	mv patch-vxworks-mkdir-for-libgcov.patch $_gcc_name
	cd $_gcc_name
	patch -Np0 < patch-vxworks-mkdir-for-libgcov.patch
	rm -r patch-vxworks-mkdir-for-libgcov.patch
	
	cd $srcdir
	$_gcc_name/contrib/download_prerequisites
	mkdir build && cd build
	../$_gcc_name/configure \
		--prefix=/usr \
		--target=powerpc-wrs-vxworks \
		--with-gnu-as \
		--with-gnu-ld \
		--with-headers \
		--disable-shared \
		--disable-libssp \
		--disable-multilib \
		--with-float=hard \
		--enable-languages=c,c++ \
		--enable-libstdcxx \
		--enable-threads=vxworks \
		--without-gconv \
		--disable-libgomp \
		--disable-nls \
		--with-cpu-PPC603 \
		--disable-libmudflap \
		--disable-symvers
	make -j$(nproc) || return 1
}
package(){
  cd "$srcdir/build"
  make -j$(nproc) DESTDIR=$pkgdir install || return 1
  mkdir -p $pkgdir/etc/profile.d
  touch $pkgdir/etc/profile.d/wind_base.sh
  echo 'export WIND_BASE=/usr/powerpc-wrs-vxworks/wind_base' >> $pkgdir/etc/profile.d/wind_base.sh

  rm -r $pkgdir/usr/share/{info,man/man7}
  rm -r $pkgdir/usr/share/gcc-4.8.0
  rm $pkgdir/usr/lib/libiberty.a
}

# vim:set ts=2 sw=2

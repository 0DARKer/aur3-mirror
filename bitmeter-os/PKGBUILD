# Maintainer: Kent Fredric <kentfredric@gmail.com>
pkgname=bitmeter-os
pkgver=0.8.0.20120311
pkgrel=1
pkgdesc="A cross-platform bandwidth monitor"
arch=('i686' 'x86_64')
url="http://codebox.org.uk/pages/bitmeteros"
license=('GPL')
groups=()
depends=(
  'libpcap'
  'sqlite3'
  'glibc'
)
makedepends=()
checkdepends=()
optdepends=()
provides=()
conflicts=()
replaces=()
backup=('var/lib/bitmeter/bitmeter.db');
options=(!makeflags)
install=
changelog=
_git_proj=bitmeteros
_git_commit=51f2b1f6fc8da85ce48d22ce1284fe2a08dda6a7
_git_src_dir="${srcdir}/${_git_proj}-${_git_commit}"
source=(
  'pthread.patch'
  'bitmeter-capture.service'
  'bitmeter-web.service'
  'bitmeter.target'
  "https://github.com/codebox/${_git_proj}/archive/${_git_commit}.tar.gz"
)
noextract=()
sha1sums=('a9bb2aca6653cf54336fed37ea767e8802779e75'
          '5e41bbd9f22042bb26b89781b5ef630f97b09697'
          '1ec8caa847c9da724359af5e78bc70bfa208e883'
          'a7bbe7f68843ae24c6a08326421e34fbc15ee7de'
          'efda54495495d0de4f11aeebd4ebe2a24068e544')

_platform=build/linux

build() {
  cd "$srcdir"
  patch -ui "${srcdir}/pthread.patch" "${_git_src_dir}/build/linux/makefile"
  cd "$_git_src_dir/$_platform"
  make
}

package() {
  cd $_git_src_dir;

  install -dm0755 -o nobody -g nobody "${pkgdir}/var/run/bitmeter"
  install -dm0755 -o nobody -g nobody "${pkgdir}/var/www/bitmeter"
  install -dm0755 -o nobody -g nobody "${pkgdir}/var/log/bitmeter"

  for i in bmclient bmdb bmsync bmcapture bmws; do
    install -D -v "$_git_src_dir/build/linux/$i"  "$pkgdir/usr/bin/$i";
  done

  install -D -v "$_git_src_dir/build/bitmeter.db" "$pkgdir/var/lib/bitmeter/bitmeter.db"

  install -D -d -v "$pkgdir/var/www/" 
 
  cp -rv "$_git_src_dir/webserver/web/"* "$pkgdir/var/www/bitmeter/"
  
  install -v -Dm0644 "${srcdir}/bitmeter-capture.service" "${pkgdir}/usr/lib/systemd/system/bitmeter-capture.service"
  install -v -Dm0644 "${srcdir}/bitmeter-web.service"     "${pkgdir}/usr/lib/systemd/system/bitmeter-web.service"
  install -v -Dm0644 "${srcdir}/bitmeter.target"          "${pkgdir}/usr/lib/systemd/system/bitmeter.target"

}


# vim:set ts=2 sw=2 et:

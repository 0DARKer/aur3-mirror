# Maintainer: Xu Fasheng <fasheng.xu@gmail.com>

pkgname=deepin-terminal
pkgver=git20131125000403~c6c474d431
pkgrel=1
pkgdesc='Awesome terminal for Linux Deepin'
arch=('i686' 'x86_64')
depends=('deepin-ui' 'deepin-vte-plus' 'python2-dbus')
makedepends=('w3m')
license=('GPL3')
provides=('deepin-terminal')
conflicts=('deepin-terminal-git')
url="http://www.linuxdeepin.com/"
_pkgsite="http://packages.linuxdeepin.com"
# _pkgsite="http://mirrors.ustc.edu.cn"
_parent_url="${_pkgsite}/deepin/pool/main/d/deepin-terminal"
_file="deepin-terminal_${pkgrel}+${pkgver}_all.deb"
_file_reg="deepin-terminal_+.*?_all.deb"
md5sums=('1e306ca69968d301f457c2a963d761d5')

package() {
    tar xzvf ${srcdir}/data.tar.gz -C ${pkgdir}/

    cd ${pkgdir}/usr/share/deepin-terminal/src/
    sed -i 's_#! /usr/bin/env python$_#! /usr/bin/env python2_' *.py
    sed -i 's_#! /usr/bin/python$_#! /usr/bin/python2_' *.py

    # there is no 'XHei' font on archinux, so replace it
    sed -i 's/XHei Mono.Ubuntu/Monospace/' main.py
}

# Get latest file in source site.
# arguments:
#   $1, the parent path of url
#   $2, desired file name
#   $3, regexp of file name, used to get the last file name
get_latest_file() {
    # get arguments
    local parent_url=$1
    local file=$2
    local file_reg=$3
    
    # check if w3m installed
    command -v w3m >/dev/null 2>&1 || {
        echo ${file}
        return
    }
    
    # get the latest file, and for some source site, need convert character "%2b" to "+"
    matched_files=`w3m -dump_source ${parent_url} | sed "s/%2b/+/" | grep -o -P ${file_reg}`
    latest_file=`echo "${matched_files}" | sort -n | tail -1`
    if [[ -z ${latest_file} ]]; then
        # get latest file failed
        echo ${file}
        return
    fi
    
    # return the latest file
    echo ${latest_file}
}

# fix url, and then set 'source' variable
echo "==> Check and fix package url if out of date."
_file="`get_latest_file ${_parent_url} ${_file} ${_file_reg}`"
echo "==> Lastest package name is: ${_file}"
echo "==> For yaourt user, if following steps failed, please run 'makepkg -is --skipchecksums' manually in directory '/tmp/yaourt-tmp-fsh/aur-${pkgname}'."

source=("${_parent_url}/${_file}")

# Contributor: funkyou
# Maintainer:  Tristero <tristero@online.de>

pkgname=retroshare
_pkgver=0.5.1
pkgver=${_pkgver}d
pkgrel=1
pkgdesc="Serverless encrypted instant messenger with filesharing, chatgroups, e-mail."
arch=('i686' 'x86_64')
url="http://retroshare.sourceforge.net/"
license=('LGPL' 'GPL')
depends=('qt' 'openssl' 'libupnp' 'gpgme' 'libgnome-keyring' 'mesa' 'libxss')
install="${pkgname}.install"

source=(http://sourceforge.net/projects/retroshare/files/RetroShare/${pkgver}/RetroShare-v${pkgver}.tar.gz/download \
	retroshare-${_pkgver}-upnp.patch \
        ${pkgname}.desktop)

build() {

  # NOTE Setting this to TRUE activates the compilation and packaging
  # of the plugins which are not yet officially released.
  local _USE_PLUGINS=FALSE

  # NOTE Setting this to TRUE activates the compilation and packaging
  # of retroshare-nogui
  local _USE_NOGUI=FALSE

  cd ${srcdir}
  patch -N -p0 -i ${startdir}/retroshare-${_pkgver}-upnp.patch

  msg "Compile libbitdht"
  cd ${srcdir}/trunk/libbitdht/src
  qmake
  make

  msg "Compile libretroshare"
  cd ${srcdir}/trunk/libretroshare/src
  qmake
  make

  if [ "x$_USE_PLUGINS" == "xTRUE" ] ; then

    msg "Compile retroshare plugins"
    cd ${srcdir}/trunk/plugins
    qmake
    make
    cd ${srcdir}/trunk/plugins/ColorCode_plugin
    qmake
    make
    cd ${srcdir}/trunk/plugins/i2pmessenger_plugin
    qmake
    make
    cd ${srcdir}/trunk/plugins/patience_plugin/Patience
    qmake
    make
    cd ${srcdir}/trunk/plugins/qsolocards_plugin
    qmake
    make
    cd ${srcdir}/trunk/plugins/smplayer_plugin
    qmake
    make
    cd ${srcdir}/trunk/plugins/stegosaurus_plugin
    qmake
    make
  fi

  msg "Compile retroshare-gui"
  cd ${srcdir}/trunk/retroshare-gui/src
  qmake
  make

  if [ "x$_USE_NOGUI" == "xTRUE" ] ; then

    msg "Compile retroshare-nogui"
    cd ${srcdir}/trunk/retroshare-nogui/src
    qmake
    make
  fi

  # --- Install Files ---

  msg "Install files to fakeroot-environment"

  # - Binaries
  install -D -m 644 \
    "${srcdir}/trunk/libbitdht/src/lib/libbitdht.a" \
    "${pkgdir}/usr/lib/libbitdht.a"
  install -D -m 644 \
    "${srcdir}/trunk/libretroshare/src/lib/libretroshare.a" \
    "${pkgdir}/usr/lib/libretroshare.a"
  install -D -m 755 \
    "${srcdir}/trunk/retroshare-gui/src/RetroShare" \
    "${pkgdir}/usr/bin/${pkgname}"

  if [ "x$_USE_NOGUI" == "xTRUE" ] ; then
    install -D -m 755 \
	"${srcdir}/trunk/retroshare-nogui/src/retroshare-nogui" \
        "${pkgdir}/usr/bin/${pkgname}-nogui"
  fi

  # plugins

  if [ "x$_USE_PLUGINS" == "xTRUE" ] ; then

    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libcalendar_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libcalendar_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libcolorcode_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libcolorcode_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libi2pmessenger_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libi2pmessenger_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libpatience_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libpatience_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libpuzzle_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libpuzzle_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libqcheckers_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libqcheckers_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libqdiagram_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libqdiagram_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libqsolocards_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libqsolocards_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libsmplayer_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libsmplayer_plugin.so"
    install -D -m 755 \
	"${srcdir}/trunk/plugins/bin/libstegosaurus_plugin.so" \
	"${pkgdir}/usr/lib/retroshare/plugins/libstegosaurus_plugin.so"
  fi

  # - Icons
  install -D -m 644 \
    "${srcdir}/trunk/retroshare-gui/src/gui/images/retrosharelogo1.png" \
    "${pkgdir}/usr/share/pixmaps/retroshare_blue.png"
  install -D -m 644 \
    "${srcdir}/trunk/retroshare-gui/src/gui/images/retrosharelogo2.png" \
    "${pkgdir}/usr/share/pixmaps/retroshare.png"

  # - Desktop File
  install -D -m 644 \
    "${srcdir}/${pkgname}.desktop" \
    "${pkgdir}/usr/share/applications/${pkgname}.desktop"
}

md5sums=('be1745d9d8027f6417bdb5f5082b17ea'
         'b27363efd73ebb672a0a965b51886258'
         'f6dc374d95c775bc587ef13841abdab2')

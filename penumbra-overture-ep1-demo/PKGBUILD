# Contributor: gyo <nucleogeek_at_gmail_dot_com>
_name='PenumbraOvertureDemo'
pkgname=penumbra-overture-ep1-demo
pkgver=1.0.1
pkgrel=2
pkgdesc='First person dark adventure game'
arch=(i686 x86_64)
url='http://penumbra-overture.com/'
license=('custom')
depends=(xorg)
makedepends=(aria2 imagemagick)
install="$pkgname.install"
source=(http://www.gameupdates.org/download.php/1102/$_name-$pkgver.torrent $pkgname.sh $pkgname.desktop)
md5sums=('41226389540dbdece258ee021764d83b' 'e18e0b75a1a248bbb7361d1e3d0240b2' 'cec56019df7b2a45f1d6d51c82573ede')


build() {
  cd $startdir/src/

  if [ -e $_name-$pkgver.sh -a -e $_name-$pkgver.sh.aria2 -o ! -e $_name-$pkgver.sh ]; then
    echo "* Downloading archive with aria2"
    aria2c -T $_name-$pkgver.torrent --seed-time=0 --allow-overwrite=true
  fi
  
  mkdir $pkgname
    
  case $CARCH in
    i686) rm bin/linux/x86_64 -fr; _arch=x86;;
    x86_64) rm bin/linux/x86 -fr; _arch=x86_64;;
  esac

  echo "* Extracting archive"
  sh $_name-$pkgver.sh --tar xf -C $pkgname ./bin/linux/$_arch/libc.so.6/lzma-decode ./instarchive_all ./config/license
  cd $pkgname
  bin/linux/$_arch/libc.so.6/lzma-decode instarchive_all pack.tar
  echo "...Done."

  mkdir -p $startdir/pkg/opt/$pkgname/
  tar xvf pack.tar -C $startdir/pkg/opt/$pkgname

  cd $startdir/pkg/opt/$pkgname
  convert penumbra.ico penumbra.png
  rm penumbra.ico

  echo "* Changing owner"
  chown root.root -R .
  echo "...Done"

  mkdir -p $startdir/pkg/etc/profile.d/
  mkdir -p $startdir/pkg/usr/share/licenses/$pkgname/
  mkdir -p $startdir/pkg/usr/share/applications/
  install -m755 $startdir/src/$pkgname.sh $startdir/pkg/etc/profile.d/
  install -m644 $startdir/src/$pkgname/config/license $startdir/pkg/usr/share/licenses/$pkgname/
  install -m644 $startdir/src/$pkgname.desktop $startdir/pkg/usr/share/applications/
}
